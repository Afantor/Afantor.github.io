<!DOCTYPE html>
<!-- saved from url=(0074)https://learn.adafruit.com/bluefruit-nrf52-feather-learning-guide?view=all -->
<html lang="en-US" class="js-ready"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<link rel="icon" type="image/png" href="./img/icons/Logo.png">
<title>Bluefruit nRF52 Learning Guide</title>
<meta name="csrf-param" content="authenticity_token">
<meta name="csrf-token" content="MG6cGkmU+pfvEzwdHIeUBGk79jx0DAPSZw/dsE1GG/KBof8SsEhXjWYmR41qIv+Up6IUS5i+PExi1u+OKsd9sg==">
<link rel="alternate" type="application/atom+xml" title="ATOM" href="https://learn.adafruit.com/feed">
<link rel="alternate" type="application/rss+xml" title="RSS" href="https://learn.adafruit.com/feed.rss">
<link rel="stylesheet" media="screen" href="./nRF52_bluefruit_Learning_Guide/application-7cb8e750656ddc53ea272da45d60924a17b676628af035604ddc1a8621b2f5f7.css" data-turbolinks-track="reload">
<script type="text/javascript" async="" src="./nRF52_bluefruit_Learning_Guide/ec.js"></script><script type="text/javascript" async="" src="./nRF52_bluefruit_Learning_Guide/analytics.js"></script><script src="./nRF52_bluefruit_Learning_Guide/js"></script>
<script type="text/javascript">
    window.dataLayer = window.dataLayer || [];

    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
  </script>
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">
<meta name="turbolinks-cache-control" content="no-cache">
<meta name="guide-title" content="Bluefruit nRF52 Feather Learning Guide">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@adafruit">
<meta name="twitter:title" content="Bluefruit nRF52 Feather Learning Guide">
<meta name="twitter:description" content="Get started now with our most powerful Bluefruit board yet!">
<meta name="twitter:image:src" content="https://cdn-learn.adafruit.com/guides/images/000/001/567/medium800/nRF52Feather1000px.png">
<meta name="twitter:domain" content="https://learn.adafruit.com">
<link rel="canonical" href="https://learn.adafruit.com/bluefruit-nrf52-feather-learning-guide/introduction">
<meta http-equiv="X-UA-Compatible" content="IE=Edge">
<script type="text/javascript">window.NREUM||(NREUM={});NREUM.info={"beacon":"bam.nr-data.net","errorBeacon":"bam.nr-data.net","licenseKey":"308175db61","applicationID":"54271218","transactionName":"cVZXRUFeWghRShtEVlVcSh5AWVkT","queueTime":0,"applicationTime":62,"agent":""}</script>
<script type="text/javascript">window.NREUM||(NREUM={}),__nr_require=function(e,n,t){function r(t){if(!n[t]){var o=n[t]={exports:{}};e[t][0].call(o.exports,function(n){var o=e[t][1][n];return r(o||n)},o,o.exports)}return n[t].exports}if("function"==typeof __nr_require)return __nr_require;for(var o=0;o<t.length;o++)r(t[o]);return r}({1:[function(e,n,t){function r(){}function o(e,n,t){return function(){return i(e,[c.now()].concat(u(arguments)),n?null:this,t),n?void 0:this}}var i=e("handle"),a=e(3),u=e(4),f=e("ee").get("tracer"),c=e("loader"),s=NREUM;"undefined"==typeof window.newrelic&&(newrelic=s);var p=["setPageViewName","setCustomAttribute","setErrorHandler","finished","addToTrace","inlineHit","addRelease"],d="api-",l=d+"ixn-";a(p,function(e,n){s[n]=o(d+n,!0,"api")}),s.addPageAction=o(d+"addPageAction",!0),s.setCurrentRouteName=o(d+"routeName",!0),n.exports=newrelic,s.interaction=function(){return(new r).get()};var m=r.prototype={createTracer:function(e,n){var t={},r=this,o="function"==typeof n;return i(l+"tracer",[c.now(),e,t],r),function(){if(f.emit((o?"":"no-")+"fn-start",[c.now(),r,o],t),o)try{return n.apply(this,arguments)}catch(e){throw f.emit("fn-err",[arguments,this,e],t),e}finally{f.emit("fn-end",[c.now()],t)}}}};a("actionText,setName,setAttribute,save,ignore,onEnd,getContext,end,get".split(","),function(e,n){m[n]=o(l+n)}),newrelic.noticeError=function(e,n){"string"==typeof e&&(e=new Error(e)),i("err",[e,c.now(),!1,n])}},{}],2:[function(e,n,t){function r(e,n){if(!o)return!1;if(e!==o)return!1;if(!n)return!0;if(!i)return!1;for(var t=i.split("."),r=n.split("."),a=0;a<r.length;a++)if(r[a]!==t[a])return!1;return!0}var o=null,i=null,a=/Version\/(\S+)\s+Safari/;if(navigator.userAgent){var u=navigator.userAgent,f=u.match(a);f&&u.indexOf("Chrome")===-1&&u.indexOf("Chromium")===-1&&(o="Safari",i=f[1])}n.exports={agent:o,version:i,match:r}},{}],3:[function(e,n,t){function r(e,n){var t=[],r="",i=0;for(r in e)o.call(e,r)&&(t[i]=n(r,e[r]),i+=1);return t}var o=Object.prototype.hasOwnProperty;n.exports=r},{}],4:[function(e,n,t){function r(e,n,t){n||(n=0),"undefined"==typeof t&&(t=e?e.length:0);for(var r=-1,o=t-n||0,i=Array(o<0?0:o);++r<o;)i[r]=e[n+r];return i}n.exports=r},{}],5:[function(e,n,t){n.exports={exists:"undefined"!=typeof window.performance&&window.performance.timing&&"undefined"!=typeof window.performance.timing.navigationStart}},{}],ee:[function(e,n,t){function r(){}function o(e){function n(e){return e&&e instanceof r?e:e?f(e,u,i):i()}function t(t,r,o,i){if(!d.aborted||i){e&&e(t,r,o);for(var a=n(o),u=v(t),f=u.length,c=0;c<f;c++)u[c].apply(a,r);var p=s[y[t]];return p&&p.push([b,t,r,a]),a}}function l(e,n){h[e]=v(e).concat(n)}function m(e,n){var t=h[e];if(t)for(var r=0;r<t.length;r++)t[r]===n&&t.splice(r,1)}function v(e){return h[e]||[]}function g(e){return p[e]=p[e]||o(t)}function w(e,n){c(e,function(e,t){n=n||"feature",y[t]=n,n in s||(s[n]=[])})}var h={},y={},b={on:l,addEventListener:l,removeEventListener:m,emit:t,get:g,listeners:v,context:n,buffer:w,abort:a,aborted:!1};return b}function i(){return new r}function a(){(s.api||s.feature)&&(d.aborted=!0,s=d.backlog={})}var u="nr@context",f=e("gos"),c=e(3),s={},p={},d=n.exports=o();d.backlog=s},{}],gos:[function(e,n,t){function r(e,n,t){if(o.call(e,n))return e[n];var r=t();if(Object.defineProperty&&Object.keys)try{return Object.defineProperty(e,n,{value:r,writable:!0,enumerable:!1}),r}catch(i){}return e[n]=r,r}var o=Object.prototype.hasOwnProperty;n.exports=r},{}],handle:[function(e,n,t){function r(e,n,t,r){o.buffer([e],r),o.emit(e,n,t)}var o=e("ee").get("handle");n.exports=r,r.ee=o},{}],id:[function(e,n,t){function r(e){var n=typeof e;return!e||"object"!==n&&"function"!==n?-1:e===window?0:a(e,i,function(){return o++})}var o=1,i="nr@id",a=e("gos");n.exports=r},{}],loader:[function(e,n,t){function r(){if(!E++){var e=x.info=NREUM.info,n=l.getElementsByTagName("script")[0];if(setTimeout(s.abort,3e4),!(e&&e.licenseKey&&e.applicationID&&n))return s.abort();c(y,function(n,t){e[n]||(e[n]=t)}),f("mark",["onload",a()+x.offset],null,"api");var t=l.createElement("script");t.src="https://"+e.agent,n.parentNode.insertBefore(t,n)}}function o(){"complete"===l.readyState&&i()}function i(){f("mark",["domContent",a()+x.offset],null,"api")}function a(){return O.exists&&performance.now?Math.round(performance.now()):(u=Math.max((new Date).getTime(),u))-x.offset}var u=(new Date).getTime(),f=e("handle"),c=e(3),s=e("ee"),p=e(2),d=window,l=d.document,m="addEventListener",v="attachEvent",g=d.XMLHttpRequest,w=g&&g.prototype;NREUM.o={ST:setTimeout,SI:d.setImmediate,CT:clearTimeout,XHR:g,REQ:d.Request,EV:d.Event,PR:d.Promise,MO:d.MutationObserver};var h=""+location,y={beacon:"bam.nr-data.net",errorBeacon:"bam.nr-data.net",agent:"js-agent.newrelic.com/nr-1123.min.js"},b=g&&w&&w[m]&&!/CriOS/.test(navigator.userAgent),x=n.exports={offset:u,now:a,origin:h,features:{},xhrWrappable:b,userAgent:p};e(1),l[m]?(l[m]("DOMContentLoaded",i,!1),d[m]("load",r,!1)):(l[v]("onreadystatechange",o),d[v]("onload",r)),f("mark",["firstbyte",u],null,"api");var E=0,O=e(5)},{}]},{},["loader"]);</script>
<!--[if lte IE 9]>
    <script src="https://cdn.polyfill.io/v2/polyfill.min.js"></script>
  <![endif]-->
<script>
    window.rails_env = 'production';
  </script>
<script src="./nRF52_bluefruit_Learning_Guide/application-ac8.js" data-turbolinks-track="reload"></script>
<script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "WebSite",
      "url": "https://www.afantor.cc/",
      "potentialAction": {
        "@type": "SearchAction",
        "target": "https://www.afantor.cc/search?q={search_term}",
        "query-input": "required name=search_term"
      }
    }
  </script>
<style id="fit-vids-style">.fluid-width-video-wrapper{width:100%;position:relative;padding:0;}.fluid-width-video-wrapper iframe,.fluid-width-video-wrapper object,.fluid-width-video-wrapper embed {position:absolute;top:0;left:0;width:100%;height:100%;}</style></head>
<body class="application pages show">

<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PRPXBQ6"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

<div id="outer-wrapper">
<div id="inner-wrapper">
<header id="adafruit-header">
<div id="small-header">
<div class="first-row">

</div>
<div class="second-row">
<div id="small-search-wrapper">
<div id="small-search-inner-wrapper">
<form action="https://learn.adafruit.com/search" method="get">
<label for="mobile-search" style="display:none;">Search</label>
<input id="mobile-search" type="text" name="q" placeholder="Search Adafruit">
<i class="fa fa-search"></i>
</form>
</div>
</div>
</div>
<nav id="small-header-nav">
<div class="block">

</div>
</nav>
</div>
<div id="large-header">
<div class="first-row">
<div class="row-content">

<div id="account">

</div>
</div>
</div>
<div class="second-row">
<div class="row-content">
<div class="left-content">
<div id="logo">
<a href="https://www.afantor.cc/">
<img alt="Afantor Logo" title="Adafruit Logo" src="./img/icons/Logo.png">
</a> </div>
<ul class="main-nav-links">
<li class="dropdown with-overlay">
<div class="dropdown-label">Bluefruit nRF52 Learning Guide</div>
<div class="dropdown-container">
<div class="dropdown-content">
<div class="flyouts">
<div class="flyout">
<div class="container">
<div class="flyout-content row">
<div class="column col-lg-6 col-md-6 col-sm-6">
<div class="title categories">
GUIDE CATEGORIES <br class="hidden-lg"><a href="https://www.afantor.cc/">(SEE ALL 8)</a>
</div>
<div class="row">
<div class="col-lg-6 col-md-6 col-sm-6">
<ul class="links categories">
<li><a href="https://www.afantor.cc/category/adabox">ADABOX (55)</a></li>
<li><a href="https://www.afantor.cc/category/adafruit-products">ADAFRUIT PRODUCTS (287)</a></li>
<li><a href="https://www.afantor.cc/category/arduino">ARDUINO COMPATIBLES (389)</a></li>
<li><a href="https://www.afantor.cc/category/breakout-boards">BREAKOUT BOARDS (145)</a></li>
<li><a href="https://www.afantor.cc/category/circuit-playground">CIRCUIT PLAYGROUND (245)</a></li>
<li><a href="https://www.afantor.cc/category/circuitpython">CIRCUITPYTHON (195)</a></li>
<li><a href="https://www.afantor.cc/category/collins-lab">COLLIN'S LAB (8)</a></li>
<li><a href="https://www.afantor.cc/category/components">COMPONENTS (110)</a></li>
<li><a href="https://www.afantor.cc/category/community-support">COMMUNITY SUPPORT (23)</a></li>
<li><a href="https://www.afantor.cc/category/customer-projects">CUSTOMER &amp; PARTNER PROJECTS (34)</a></li>
<li><a href="https://www.afantor.cc/category/development-boards">DEVELOPMENT BOARDS (55)</a></li>
<li><a href="https://www.afantor.cc/category/educators">EDUCATORS (40)</a></li>
<li><a href="https://www.afantor.cc/category/el">EL WIRE/TAPE/PANEL (13)</a></li>
<li><a href="https://www.afantor.cc/category/feather">FEATHER (186)</a></li>
<li><a href="https://www.afantor.cc/category/hacks">HACKS (54)</a></li>
<li><a href="https://www.afantor.cc/category/internet-of-things-iot">INTERNET OF THINGS - IOT (194)</a></li>
</ul>
</div>
<div class="col-lg-6 col-md-6 col-sm-6">
<ul class="links categories">
<li><a href="https://www.afantor.cc/category/lcds-and-displays">LCDS &amp; DISPLAYS (196)</a></li>
<li><a href="https://www.afantor.cc/category/leds">LEDS (372)</a></li>
<li><a href="https://www.afantor.cc/category/maker-business">MAKER BUSINESS (34)</a></li>
<li><a href="https://www.afantor.cc/category/micro-bit">MICRO:BIT (11)</a></li>
<li><a href="https://www.afantor.cc/category/microcontrollers">MICROCONTROLLERS (152)</a></li>
<li><a href="https://www.afantor.cc/category/programming">PROGRAMMING (232)</a></li>
<li><a href="https://www.afantor.cc/category/projects">PROJECTS (218)</a></li>
<li><a href="https://www.afantor.cc/category/raspberry-pi">RASPBERRY PI (359)</a></li>
<li><a href="https://www.afantor.cc/category/robotics">ROBOTICS &amp; CNC (84)</a></li>
<li><a href="https://www.afantor.cc/category/sensors">SENSORS (369)</a></li>
<li><a href="https://www.afantor.cc/category/tools">TOOLS (64)</a></li>
<li><a href="https://www.afantor.cc/category/wearables">WEARABLES (233)</a></li>
<li><a href="https://www.afantor.cc/category/3d-printing">3D PRINTING (299)</a></li>
<li><a href="https://www.afantor.cc/category/crickit">CRICKIT (50)</a></li>
<li><a href="https://www.afantor.cc/category/makecode">MAKECODE (124)</a></li>
<li><a href="https://www.afantor.cc/category/trellis">TRELLIS (31)</a></li>
</ul>
</div>
</div>
</div>
<div class="column col-lg-3 col-md-3 col-sm-3">
 <div class="title new">
NEW GUIDES <br class="hidden-lg"><a href="https://www.afantor.cc/guides/latest">(SEE ALL 118)</a>
</div>
<ul class="links new">
<li>
<a href="https://www.afantor.cc/pyportal-philips-hue-lighting-controller"><img src="./nRF52_bluefruit_Learning_Guide/ezgif.com-video-to-gif_(10).gif" alt="PyPortal Philips Hue Lighting Controller"></a>
<a href="https://www.afantor.cc/pyportal-philips-hue-lighting-controller" class="name">PYPORTAL PHILIPS HUE LIGHTING CONTROLLER</a>
<div class="clear"></div>
</li>
<li>
<a href="https://www.afantor.cc/epaper-display-featherwing-quote-display"><img src="./nRF52_bluefruit_Learning_Guide/epaper_featherwing.jpg" alt="ePaper FeatherWing Quote Display"></a>
<a href="https://www.afantor.cc/epaper-display-featherwing-quote-display" class="name">EPAPER FEATHERWING QUOTE DISPLAY</a>
<div class="clear"></div>
</li>
<li>
<a href="https://www.afantor.cc/league-of-legends-level-trophy-for-pyportal"><img src="./nRF52_bluefruit_Learning_Guide/pyplol01.jpg" alt="League of Legends Level Trophy for PyPortal"></a>
<a href="https://www.afantor.cc/league-of-legends-level-trophy-for-pyportal" class="name">LEAGUE OF LEGENDS LEVEL TROPHY FOR PYPORTAL</a>
<div class="clear"></div>
</li>
<li>
<a href="https://www.afantor.cc/ad8495-thermocouple-amplifier"><img src="./nRF52_bluefruit_Learning_Guide/AD8495_Top_Angle.jpg" alt="AD8495 Analog Output K-Type Thermocouple Amplifier"></a>
<a href="https://www.afantor.cc/ad8495-thermocouple-amplifier" class="name">AD8495 ANALOG OUTPUT K-TYPE THERMOCOUPLE AMPLIFIER</a>
<div class="clear"></div>
</li>
</ul>
</div>
<div class="column col-lg-3 col-md-3 col-sm-3">
<div class="title featured">
FEATURED GUIDES <br class="hidden-lg"><a href="https://www.afantor.cc/guides/featured">(SEE ALL 29)</a>
</div>
<ul class="links featured">
<li>
<a href="https://www.afantor.cc/capacitive-touch-unicorn-horn"><img src="./nRF52_bluefruit_Learning_Guide/unicorn_gif2.gif" alt="Capacitive Touch Unicorn Horn"></a>
<a href="https://www.afantor.cc/capacitive-touch-unicorn-horn" class="name">CAPACITIVE TOUCH UNICORN HORN</a>
<div class="clear"></div>
</li>
<li>
<a href="https://www.afantor.cc/glowing-slime-lunchbox"><img src="./nRF52_bluefruit_Learning_Guide/loop.gif" alt="Glowing Slime Lunchbox"></a>
<a href="https://www.afantor.cc/glowing-slime-lunchbox" class="name">GLOWING SLIME LUNCHBOX</a>
<div class="clear"></div>
</li>
<li>
<a href="https://www.afantor.cc/the-scream-munch-screaming-interactive-scream-painting"><img src="./nRF52_bluefruit_Learning_Guide/scream_CU.gif" alt="The Scream: Interactive Screaming Painting"></a>
<a href="https://www.afantor.cc/the-scream-munch-screaming-interactive-scream-painting" class="name">THE SCREAM: INTERACTIVE SCREAMING PAINTING</a>
<div class="clear"></div>
</li>
<li>
<a href="https://www.afantor.cc/automatic-cat-treat-dispenser"><img src="./nRF52_bluefruit_Learning_Guide/hero.gif" alt="Automatic Cat Treat Dispenser"></a>
<a href="https://www.afantor.cc/automatic-cat-treat-dispenser" class="name">AUTOMATIC CAT TREAT DISPENSER</a>
<div class="clear"></div>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</li>
</ul>
</div>

</div>
</div>
</div>
</header>
<div id="main-content">
<div id="page-wrapper" class="single-page">
<div id="content-wrapper" class="container" data-page-id="8789" data-guide-id="1567">
<div class="row">
<div class="sidebar-left-wrapper hidden-phone hidden-tablet col-lg-two-and-half col-md-3 col-sm-4 col-xs-12">
<div class="sidebar-left-content" data-clampedwidth=".sidebar-left-wrapper">
<nav class="sidebar-left">
<div class="title-bar">
<div class="image-container">
<img class="image-preview" data-error="/assets/missing%2Fmissing.png" src="./img/nrf52/blue1.png">
</div>
<div class="title">
<h1><a href="./nRF52_bluefruit_Learning_Guide.html#introduction">Bluefruit nRF52 Learning Guide</a></h1>
<span class="tagline"><a href="./nRF52_bluefruit_Learning_Guide.html#introduction">Get started now with our most powerful Bluefruit52 board yet!</a></span>
</div>
</div>
<ul class="page-parent nav">
<li class="parent">
<a href="./nRF52_bluefruit_Learning_Guide.html#introduction" class="published">Introduction</a>
</li>
<li class="parent  ">
<a href="./nRF52_bluefruit_Learning_Guide.html#device-pinout" class="published">Device Pinout</a>
</li>
<li class="parent  ">
<a href="./nRF52_bluefruit_Learning_Guide.html#arduino-bsp-setup" class="published">Arduino Support Setup</a>
</li>
<li class="parent  ">
<a href="./nRF52_bluefruit_Learning_Guide.html#arduino-board-setup" class="published">Arduino Board Testing</a>
</li>
<li class="parent  ">
<a data-toggle="collapse" class="collapsed-icon collapsed" href="./nRF52_bluefruit_Learning_Guide.html#page-9052-children" aria-expanded="false"></a>
<a href="./nRF52_bluefruit_Learning_Guide.html#using-the-bootloader" class="published">Using the Bootloader</a>
<ul id="page-9052-children" class="collapse  page-child nav" aria-expanded="false">
<li class="published ">
<a href="./nRF52_bluefruit_Learning_Guide.html#updating-the-bootloader" class="published">Updating the Bootloader</a>
</li>
<li class="published ">
<a href="./nRF52_bluefruit_Learning_Guide.html#flashing-the-bootloader" class="published">Flashing the Bootloader</a>
</li>
</ul></li>
<li class="parent  ">
<a data-toggle="collapse" class="collapsed-icon collapsed" href="./nRF52_bluefruit_Learning_Guide.html#page-8814-children" aria-expanded="false"></a>
<a href="./nRF52_bluefruit_Learning_Guide.html#examples" class="published">Arduino Examples</a>
<ul id="page-8814-children" class="collapse  page-child nav" aria-expanded="false">
<li class="published ">
<a href="./nRF52_bluefruit_Learning_Guide.html#advertising-beacon" class="published">Advertising: Beacon</a>
</li>
<li class="published ">
<a href="./nRF52_bluefruit_Learning_Guide.html#ble-uart-controller" class="published">BLE UART: Controller</a>
</li>
<li class="published ">
<a href="./nRF52_bluefruit_Learning_Guide.html#custom-hrm" class="published">Custom: HRM</a>
</li>
<li class="published ">
<a href="./nRF52_bluefruit_Learning_Guide.html#ble-pin-i-o" class="published">BLE Pin I/O</a>
</li>
<li class="published ">
<a href="./nRF52_bluefruit_Learning_Guide.html#central-bleuart" class="published">Central BLEUART</a>
</li>
<li class="published ">
<a href="./nRF52_bluefruit_Learning_Guide.html#dual-roles-bleuart" class="published">Dual Roles BLEUART</a>
</li>
<li class="published ">
<a href="./nRF52_bluefruit_Learning_Guide.html#custom-central-hrm" class="published">Custom: Central HRM</a>
</li>
</ul></li>
<li class="parent  ">
<a data-toggle="collapse" class="collapsed-icon collapsed" href="./nRF52_bluefruit_Learning_Guide.html#page-8807-children" aria-expanded="false"></a>
<a href="./nRF52_bluefruit_Learning_Guide.html#bluefruit-nrf52-api" class="published">Arduino Bluefruit nRF52 API</a>
<ul id="page-8807-children" class="collapse  page-child nav" aria-expanded="false">
<li class="published ">
<a href="./nRF52_bluefruit_Learning_Guide.html#adafruitbluefruit" class="published">AdafruitBluefruit</a>
</li>
<li class="published ">
<a href="./nRF52_bluefruit_Learning_Guide.html#blegap" class="published">BLEGap</a>
</li>
<li class="published ">
<a href="./nRF52_bluefruit_Learning_Guide.html#bleadvertising" class="published">BLEAdvertising</a>
</li>
<li class="published ">
<a href="./nRF52_bluefruit_Learning_Guide.html#blescanner" class="published">BLEScanner</a>
</li>
<li class="published ">
<a href="./nRF52_bluefruit_Learning_Guide.html#bleservice" class="published">BLEService</a>
</li>
<li class="published ">
<a href="./nRF52_bluefruit_Learning_Guide.html#blecharacteristic" class="published">BLECharacteristic</a>
</li>
<li class="published ">
<a href="./nRF52_bluefruit_Learning_Guide.html#bleclientservice" class="published">BLEClientService</a>
</li>
<li class="published ">
<a href="./nRF52_bluefruit_Learning_Guide.html#bleclientcharacteristic" class="published">BLEClientCharacteristic</a>
</li>
<li class="published ">
<a href="./nRF52_bluefruit_Learning_Guide.html#blediscovery" class="published">BLEDiscovery</a>
</li>
<li class="published ">
<a href="./nRF52_bluefruit_Learning_Guide.html#bledis" class="published">BLEDis</a>
</li>
<li class="published ">
<a href="./nRF52_bluefruit_Learning_Guide.html#bleuart" class="published">BLEUart</a>
</li>
<li class="published ">
<a href="./nRF52_bluefruit_Learning_Guide.html#bleclientuart" class="published">BLEClientUart</a>
</li>
<li class="published ">
<a href="./nRF52_bluefruit_Learning_Guide.html#blebeacon" class="published">BLEBeacon</a>
</li>
<li class="published ">
<a href="./nRF52_bluefruit_Learning_Guide.html#blemidi" class="published">BLEMidi</a>
</li>
<li class="published ">
<a href="./nRF52_bluefruit_Learning_Guide.html#blehidadafruit" class="published">BLEHidAdafruit</a>
</li>
<li class="published ">
<a href="./nRF52_bluefruit_Learning_Guide.html#bleancs" class="published">BLEAncs</a>
</li>
<li class="published ">
<a href="./nRF52_bluefruit_Learning_Guide.html#bleclientcts" class="published">BLEClientCts</a>
</li>
<li class="published ">
<a href="./nRF52_bluefruit_Learning_Guide.html#blecentral" class="published">BLECentral</a>
</li>
</ul></li>
<li class="parent  ">
<a href="./nRF52_bluefruit_Learning_Guide.html#nrf52-adc" class="published">nRF52 ADC</a>
</li>
<li class="parent  ">
<a href="./nRF52_bluefruit_Learning_Guide.html#hathach-memory-map" class="published">Memory Map</a>
</li>
<li class="parent  ">
<a href="./nRF52_bluefruit_Learning_Guide.html#software-resources" class="published">Software Resources</a>
</li>
<li class="parent  ">
<a href="./nRF52_bluefruit_Learning_Guide.html#downloads" class="published">Downloads</a>
</li>
<li class="parent  ">
<a href="./nRF52_bluefruit_Learning_Guide.html#faqs" class="published">FAQs</a>
</li>
<li class="single-page-spacer"></li>

</ul>
</nav>
<header class="sidebar-meta hidden-xs">
<h4>Contributors</h4>
<div><a href="https://www.afantor.cc">Afantor</a></div>
</header>
<header class="sidebar-meta hidden-xs">
<a class="feedback-link" title="Feedback? Corrections?" rel="nofollow" data-remote="true" data-method="get" href="https://blog.csdn.net/solar_Lan/article/details/88688451">
CSDN BLOG
</a> </header>
</div>
</div>
<article class="col-lg-7 col-md-6 col-sm-8 col-xs-12">
<div id="categories">

</div>
<div class="content">
<div class="page-title-wrapper">
<h1 class="headline">
<span id="introduction">Introduction</span>
</h1>
<div class="author">by
<a href="#">
<span class="name">Afantor</span>
</a> </div>
</div>
<div class="page-content all-page-view-content">
<div class="">
<div class="row-fluid build-text">
<p>The <strong>Afantor Bluefruit52 Board </strong> is our latest easy-to-use all-in-one Bluetooth Low Energy board, with a native-bluetooth chip, the nRF52832!&nbsp; It's our take on an 'all-in-one' Arduino-compatible + Bluetooth Low Energy with built in USB.</p>
<p>This chip has twice the flash, SRAM and performance of the nRF51-based board. Best of all it has Arduino IDE support so there is no 'helper' chip like the ATmega32u4 or ATSAMD21. Instead, this chip is programmed directly! It's got tons of awesome peripherals: plenty of GPIO, analog inputs, PWM, timers, etc. Leaving out the extra microcontroller means the price, complexity and power-usage are all lower/better. It allows you to run code directly on the nRF52832, straight from the Arduino IDE as you would with any other MCU or Arduino compatible device. A single MCU means better performance, lower overall power consumption, and lower production costs if you ever want to design your own hardware based on your Bluefruit nRF52 Feather project!</p>
<p>The chips are pre-programed with an auto-resetting bootloader so you can upload quickly in the Arduino IDE with no button-pressing. Want to program the chip directly? You can use our command line tools with your favorite editor and toolchain.</p>
<p>And to get you up and running quickly, we've done all the heavy lifting&nbsp;of getting the&nbsp;low level BLE stack into shape so that you can focus on your project from day one!</p>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#nrf52832-technical-details-1-2" class="anchor-link"><span class="fa fa-link"></span></a><span id="nrf52832-technical-details-1-2" class="anchor-link-target"></span><span id="nrf52832-technical-details" class="anchor-link-target"></span>nRF52832 Technical Details</h1>
<ul>
<li>ARM Cortex M4F (with HW floating point acceleration) running at 64MHz</li>
<li>512KB flash and 64KB SRAM</li>
<li><strong>Built in USB Serial converter for fast and efficient programming and debugging</strong></li>
<li>Bluetooth Low Energy compatible 2.4GHz radio (Details available in the&nbsp;<a href="https://www.nordicsemi.com/eng/Products/Bluetooth-low-energy/nRF52832" target="_blank">nRF52832</a>&nbsp;product specification)</li>
<li><strong>FCC / IC / TELEC certified module</strong></li>
<li>Up to +4dBm output power</li>
<li>1.7v to 3.3v operation with internal linear and DC/DC voltage regulators</li>
<li>26 GPIO, 8 x 12-bit ADC pins, up to 12 PWM outputs (3 PWM modules with 4 outputs each)</li>
<li>Pin #17 red LED for general purpose blinking</li>
<li>Measures 2.0" x 1.01" x 0.28" (51mm x 28mm x 8mm) without headers soldered in</li>
<li>Light as a (large?) feather - 8.7 grams</li>
<li>4 mounting holes</li>
<li>Reset button</li>
<li>Optional SWD connector for debugging</li>

</ul>
<p>Further technical details available in the <a href="https://www.nordicsemi.com/eng/Products/Bluetooth-low-energy/nRF52832" target="_blank">nRF52832</a> product specification.</p>
</div>
<div class="element row-fluid build-alert alert-info">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
The Bluefruit52 Board includes on board has a standard LIPO battery connector to make your wireless projects genuinely 'wireless' at no additional cost (aside from the LIPO cell itself).
</div>
</div>
<div class="row-fluid build-image">
<a href="./nRF52_bluefruit_Learning_Guide.html#nrf52832-technical-details">
<img class="40292-asset img-responsive" src="./img/nrf52/blue2.png" alt="blue2.png">
<span class="image-expand"><i class="fa fa-search-plus"></i></span>
</a> </div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#nrf51-or-nrf52-bluefruit-devices-1-5" class="anchor-link"><span class="fa fa-link"></span></a><span id="nrf51-or-nrf52-bluefruit-devices-1-5" class="anchor-link-target"></span><span id="nrf51-or-nrf52-bluefruit-devices" class="anchor-link-target"></span>nRF51 or nRF52 Devices?</h1>
<p>The Bluefruit52 Board (based on the <a href="https://www.nordicsemi.com/eng/Products/Bluetooth-low-energy/nRF52832" target="_blank">nRF52832</a> SoC) is quite different from the earlier nRF51822 based products.</p>
<p>From a hardware perspective, the nRF52832 is based on a much more powerful ARM Cortex M4F processor, with 512KB flash, 64KB SRAM and hardware floating point acceleration ... whereas the earlier nRF51822 is based on the smaller ARM Cortex M0 core (fewer internal instructions), with 256KB flash and either 16KB or 32KB SRAM.</p>
<p>More importantly, the design approach that we took with the nRF52 is completely different:</p>
<ul>
<li>nRF51 based boards run as modules that you connect to via an external MCU (typically an Atmel 32u4 or a SAMD21), sending AT style commands over SPI or UART.</li>
<li><strong>With the nRF52, you run all of your code directly on the nRF52832 and no external MCU is used or required!</strong></li>
</ul>
<p>This change of design helps keep the overall costs lower, allows for far better performance since you aren't limited by the SPI or UART transport channel, and can help improve overall power consumption.</p>
<p>As a tradeoff, it also means a completely different API and development process, though!</p>
</div>
</div>
</div>
<div class="page-title-wrapper">
<h1 class="headline">
<span id="device-pinout">Device Pinout</span>
</h1>
<div class="author">by
<a href="#">
<span class="name">Afantor</span>
</a> </div>
</div>
<div class="page-content all-page-view-content">
<div class="">
<div class="row-fluid build-image">
<a href="./nRF52_bluefruit_Learning_Guide.html#device-pinout">
<img class="46248-asset img-responsive" src="./img/nrf52/blue4.png" alt="blue4.png">
<span class="image-expand"><i class="fa fa-search-plus"></i></span>
</a> </div>
<div class="row-fluid build-image">
<a href="./nRF52_bluefruit_Learning_Guide.html#device-pinout">
<img class="43921-asset img-responsive" src="./img/nrf52/nrf52_pin.jpg" alt="nrf52_pin.jpg">
<span class="image-expand"><i class="fa fa-search-plus"></i></span>
</a> </div>
<div class="element element element row-fluid build-alert alert-warning">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
Please note that the nRF52832 uses a USB serial adapter to RXD/TXD are with respect to the nRF52
</div>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#special-notes-2-4" class="anchor-link"><span class="fa fa-link"></span></a><span id="special-notes-2-4" class="anchor-link-target"></span><span id="special-notes" class="anchor-link-target"></span>Special Notes</h1>
<p>The following pins have some restrictions that need to be taken into account when using them:</p>
<ul>
<li>
<strong>PIN_DFU / P0.20</strong>: If this pin is detected to be at GND level at startup, the board will enter a special serial bootloader mode and will not execute any user code, going straight into bootloader mode. If you wish to use this pin as a standard GPIO, make sure that it is pulled high with a pullup resistor so that your code will execute normally when the MCU starts up.</li>
<li>
<strong>P0.31 / A7</strong>: This pin is hard wired to a voltage-divider on the LIPO battery input, allow you to safely measure the LIPO battery level on your device. If possible, you should avoid using this pin as an <em>input</em> because you will lose the ability to read the battery voltage. You can use it as an <em>output</em> just make sure to switch the pin to analog input when you want to do the battery read, then back to output when toggling pins</li>
</ul>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#power-pins-2-5" class="anchor-link"><span class="fa fa-link"></span></a><span id="power-pins-2-5" class="anchor-link-target"></span><span id="power-pins" class="anchor-link-target"></span>Power Pins</h1>
<ul>
<li>
<strong>3.3V Output</strong>: This two pins are connected to the output of the on board 3.3V regulator. They can be used to supply 3.3V power to external sensors, breakouts or Feather Wings.</li>
<li>
<strong>LIPO Input (VBAT)</strong>: This is the voltage supply off the optional LIPO cell that can be connected via the JST PH2.0 connector. It is nominally ~3.5-4.2V.</li>
<li>
<strong>USB Power&nbsp;(VBUS)</strong>: This is the voltage supply off USB connector, nominally 4.5-5.2V.</li>
</ul>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#analog-inputs-2-6" class="anchor-link"><span class="fa fa-link"></span></a><span id="analog-inputs-2-6" class="anchor-link-target"></span><span id="analog-inputs" class="anchor-link-target"></span>Analog Inputs</h1>
<p>The 8 available analog inputs can be configured to generate 8, 10 or 12-bit data (or 14-bits with over-sampling), at speeds up to 200kHz (depending on the bit-width of the values generated), based on either an internal 0.6V reference or the external supply.</p>
<p>The following default values are used:</p>
<ul>
<li>
<strong>Default voltage range</strong>: 0-3.6V (uses the internal 0.6V reference with 1/6 gain)</li>
<li>
<strong>Default resolution</strong>: 10-bit (0..1023)</li>
</ul>
</div>
<div class="element element element element row-fluid build-alert alert-info">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
Unlike digital functions, which can be remapped to any GPIO/digital pin, the ADC functionality is tied to specified pins, labelled as&nbsp;A* in the image above (A0, A1, etc.).
</div>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#pwm-outputs-2-8" class="anchor-link"><span class="fa fa-link"></span></a><span id="pwm-outputs-2-8" class="anchor-link-target"></span><span id="pwm-outputs" class="anchor-link-target"></span>PWM Outputs</h1>
<p>Any GPIO pin can be configured as a PWM output, using the dedicated PWM block.</p>
<p>Three PWM modules can provide up to 12 PWM channels with individual frequency control in groups of up to four channels.</p>
</div>
<div class="element element element element row-fluid build-alert alert-info">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
Please note that DMA based PWM output is still a work in progress in the initial release of the nR52 BSP, and further improvements are planned here.

</div>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#i2c-pins-2-10" class="anchor-link"><span class="fa fa-link"></span></a><span id="i2c-pins-2-10" class="anchor-link-target"></span><span id="i2c-pins" class="anchor-link-target"></span>I2C Pins</h1>
<p>I2C pins on the nRF52832 require external pullup resistors to function, which have been on the Bluefruit52 board by default. All Adafruit I2C breakouts have appropriate pullups on them already, so this normally won't be an issue for you.</p>
</div>
</div>
</div>

<div class="page-title-wrapper">
<h1 class="headline">
<span id="arduino-bsp-setup">Arduino Support Setup</span>
</h1>
<div class="author">by
<a href="#">
<span class="name">Afantor</span>
</a> </div>
</div>
<div class="page-content all-page-view-content">
<div class="">
<div class="row-fluid build-text">
<p>You can&nbsp;install the Bluefruit52 nRF52832 BSP (Board Support Package) in two steps:</p>
</div>
<div class="element element element element element row-fluid build-alert">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
nRF52 support requires at least Arduino IDE version 1.8.5! Please make sure you have an up to date version before proceeding with this guide!
</div>
</div>
<div class="element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element row-fluid build-alert alert-danger">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
Please consult the FAQ section at the bottom of this page if you run into any problems installing or using this BSP!

</div>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#1-bsp-installation-5-4" class="anchor-link"><span class="fa fa-link"></span></a><span id="1-bsp-installation-5-4" class="anchor-link-target"></span><span id="1-bsp-installation" class="anchor-link-target"></span>1. BSP Installation</h1>
<h3>Recommended: Installing the BSP&nbsp;via the Board Manager</h3>
<ul>
<li>
<a href="https://www.arduino.cc/en/Main/Software" target="_blank">Download and install the Arduino IDE</a> (At least <strong>v1.8</strong>)</li>
<li>Start the Arduino IDE</li>
<li>Go into Preferences</li>
<li>Add <code>https://www.adafruit.com/package_adafruit_index.json</code>&nbsp;as an '<strong>Additional Board Manager URL</strong>' (see image below)</li>
</ul>
</div>
<div class="row-fluid build-image">
<a href="./nRF52_bluefruit_Learning_Guide.html#1-bsp-installation">
<img class="40294-asset img-responsive" src="./nRF52_bluefruit_Learning_Guide/microcontrollers_Screen_Shot_2017-03-19_at_22.16.49.png" alt="microcontrollers_Screen_Shot_2017-03-19_at_22.16.49.png">
<span class="image-expand"><i class="fa fa-search-plus"></i></span>
</a> </div>
<div class="row-fluid build-text">

<ul>
<li>Restart the Arduino IDE</li>
<li>Open the <strong>Boards Manager</strong>&nbsp;option from the <strong>Tools -&gt; Board</strong> menu and install '<strong>Adafruit nRF52 by Adafruit</strong>' (see image below)</li>
</ul>
</div>
<div class="row-fluid build-image">
<a href="./nRF52_bluefruit_Learning_Guide.html#1-bsp-installation">
<img class="39907-asset img-responsive" src="./nRF52_bluefruit_Learning_Guide/microcontrollers_nRF52BSP.png" alt="microcontrollers_nRF52BSP.png">
<span class="image-expand"><i class="fa fa-search-plus"></i></span>
</a> </div>
<div class="row-fluid build-text">
<p>It will take up to a few minutes to finish installing the cross-compiling toolchain and tools associated with this BSP.</p>
<p><strong>The delay during the installation stage shown in the image below is normal</strong>, please be patient and let the installation terminate normally:</p>
</div>
<div class="row-fluid build-image">
<a href="./nRF52_bluefruit_Learning_Guide.html#1-bsp-installation">
<img class="40938-asset img-responsive" src="./nRF52_bluefruit_Learning_Guide/microcontrollers_Screen_Shot_2017-04-19_at_20.23.20.png" alt="microcontrollers_Screen_Shot_2017-04-19_at_20.23.20.png">
<span class="image-expand"><i class="fa fa-search-plus"></i></span>
</a> </div>
<div class="row-fluid build-text">
<ul>
<li>Once the BSP is installed, select '<strong>Adafruit Bluefruit nRF52832 Feather</strong>' (for the nRF52 Feathger) of <strong>'Adafruit Bluefruit nRF52840 Feather Express'</strong> (for the nRF52840 Feather) from the <strong>Tools -&gt; Board</strong> menu, which will update your system config to use the right compiler and settings for the nRF52:</li>
</ul>
</div>
<div class="row-fluid build-image">
<a href="./nRF52_bluefruit_Learning_Guide.html#1-bsp-installation">
<img class="68583-asset img-responsive" src="./nRF52_bluefruit_Learning_Guide/microcontrollers_Screenshot_2019-01-01_at_12.59.47.png" alt="microcontrollers_Screenshot_2019-01-01_at_12.59.47.png">
<span class="image-expand"><i class="fa fa-search-plus"></i></span>
</a> </div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#2-linux-only-adafruit-nrfutil-tool-installation-5-12" class="anchor-link"><span class="fa fa-link"></span></a><span id="2-linux-only-adafruit-nrfutil-tool-installation-5-12" class="anchor-link-target"></span><span id="2-linux-only-adafruit-nrfutil-tool-installation" class="anchor-link-target"></span>2. LINUX ONLY: adafruit-nrfutil Tool Installation</h1>
<p><a href="https://github.com/adafruit/Adafruit_nRF52_nrfutil">adafruit-nrfutil</a>&nbsp;is a<strong>&nbsp;modified version</strong>&nbsp;of <a href="https://github.com/NordicSemiconductor/pc-nrfutil">Nordic's nrfutil</a>, which is used to flash boards using the built in serial bootloader. It is originally written for python2, but have been migrated to python3 and renamed to&nbsp;<strong>adafruit-nrfutil</strong>&nbsp;since BSP version 0.8.5.</p>
</div>
<div class="element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element row-fluid build-alert alert-warning">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
This step is only required on Linux, pre-built binaries of adafruit-nrfutil for Windows and MacOS are already included in the BSP. That should work out of the box for most setups.
</div>
</div>
<div class="row-fluid build-text">
<p>Install python3 if it is not installed in your system already</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/8790/elements/2998970/download">
file
</a> <div class="code-copy-container">
<a href="" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">$ sudo apt-get install python3</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="pln">$ sudo apt</span><span class="pun">-</span><span class="kwd">get</span><span class="pln"> install python3</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<p>Then run the following command to install the tool from PyPi</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/8790/elements/2998851/download">
file
</a> <div class="code-copy-container">
<a href="#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">$ pip3 install --user adafruit-nrfutil</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="pln">$ pip3 install </span><span class="pun">--</span><span class="pln">user adafruit</span><span class="pun">-</span><span class="pln">nrfutil</span></li></ol></pre>
</div>
<div class="row-fluid build-text">

<p>Add pip3 installation dir to your <strong>PATH</strong> if it is not added already. Make sure adafruit-nrfutil can be executed in terminal by running</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/8790/elements/2998856/download">
file
</a> <div class="code-copy-container">
<a href="#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">$ adafruit-nrfutil version
adafruit-nrfutil version 0.5.3.post12</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="pln">$ adafruit</span><span class="pun">-</span><span class="pln">nrfutil version</span></li><li class="L1"><span class="pln">adafruit</span><span class="pun">-</span><span class="pln">nrfutil version </span><span class="lit">0.5</span><span class="pun">.</span><span class="lit">3.post12</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#3-update-the-bootloader-nrf52832-only-5-20" class="anchor-link"><span class="fa fa-link"></span></a><span id="3-update-the-bootloader-nrf52832-only-5-20" class="anchor-link-target"></span><span id="3-update-the-bootloader-nrf52832-only" class="anchor-link-target"></span>3. Update the bootloader (nRF52832 ONLY)</h1>
<p>To keep up with Nordic's SoftDevice advances, you will likely need to update your bootloader if you are using the original nRF52832 based&nbsp;<strong>Bluefruit52</strong> boards.</p>
<p>Follow this link for instructions on how to do that</p>
</div>
<div class="element element element element element element element row-fluid build-alert alert-info">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
This step ISN'T required for the newer nRF52840 Feather Express, which has a different bootloader entirely!
</div>
</div>
<div id="element-3013510" class="button-element" data-github-release="">
<a href="./nRF52_bluefruit_Learning_Guide.html#updating-the-bootloader" class="btn btn-large btn-block btn-primary" target="_self" data-zip-folder="" type="button">Update the nRF52832 Bootloader</a>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#advanced-option-manually-install-the-bsp-via-git-5-23" class="anchor-link"><span class="fa fa-link"></span></a><span id="advanced-option-manually-install-the-bsp-via-git-5-23" class="anchor-link-target"></span><span id="advanced-option-manually-install-the-bsp-via-git" class="anchor-link-target"></span>Advanced Option: Manually Install the BSP via 'git'</h1>
<p>If you wish to do any development against the core codebase (generate pull requests, etc.), you can also optionally install the Adafruit nRF52 BSP manually using 'git', as decribed below:</p>
<h3>Adafruit nRF52 BSP via git (for core development and PRs only)</h3>
<ol>
<li>Install BSP via Board Manager as above to install compiler &amp; tools.</li>
<li>Delete the core folder <strong>nrf52</strong> installed by Board Manager in Adruino15, depending on your OS. It could be<br><strong>macOS</strong>:&nbsp;<code>~/Library/Arduino15/packages/adafruit/hardware/nrf52<br></code><strong>Linux</strong>:&nbsp;<code>~/.arduino15/packages/adafruit/hardware/nrf52<br></code><strong>Windows</strong>:&nbsp;<code>%APPDATA%\Local\Arduino15\packages\adafruit\hardware\nrf52</code>
</li>
<li>Go to&nbsp;the sketchbook folder on your command line, which should be one of the following:<br><strong>macOS</strong>: <code>~/Documents/Arduino<br></code><strong>Linux</strong>: <code>~/Arduino<br></code><strong>Windows</strong>: <code>~/Documents/Arduino</code>
</li>
<li>Create a folder named <code>hardware/Adafruit</code>, if it does not exist, and change directories into it.</li>
<li>Clone the <a href="https://github.com/adafruit/Adafruit_nRF52_Arduino" target="_blank">Adafruit_nRF52_Arduino</a> repo in the folder described in step 2: <br><code>git clone <a>git@github.com:adafruit/Adafruit_nRF52_Arduino.git</a></code>
</li>
<li>
<p>This should result in a final folder name like <code>~/Documents/Arduino/hardware/Adafruit/Adafruit_nRF52_Arduino</code>&nbsp;(macOS).</p>
</li>
<li>Restart the Arduino IDE</li>
</ol>
</div>
</div>
</div>
<div class="page-title-wrapper">
<h1 class="headline">
<span id="arduino-board-setup">Arduino Board Testing</span>
</h1>
<div class="author">by
<a href="./nRF52_bluefruit_Learning_Guide.html#arduino-board-setup">
<span class="name">Kevin Townsend</span>
</a> </div>
</div>
<div class="page-content all-page-view-content">
<div class="">
<div class="row-fluid build-text">
<p>Once you have the Bluefruit nRF52 BSP setup on your system, you need to select the appropriate board, which will determine the compiler and expose some new menus options:</p>
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#1-select-the-board-target-6-1" class="anchor-link"><span class="fa fa-link"></span></a><span id="1-select-the-board-target-6-1" class="anchor-link-target"></span><span id="1-select-the-board-target" class="anchor-link-target"></span>1. Select the Board Target</h1>
<ul>
<li>Go to the&nbsp;<strong>Tools</strong> menu</li>
<li>Select&nbsp;<strong>Tools &gt; Board &gt; Adafruit Bluefruit nRF52 Feather</strong> for&nbsp;<strong>nRF52832-based boards</strong>
</li>
<li>Select&nbsp;<strong>Tools &gt; Boards Adafruit Bluefruit nRF52840 Feather Express</strong> for&nbsp;<strong>nRF52840-based boards</strong>
</li>
</ul>
</div>
<div class="row-fluid build-image">
<a href="./nRF52_bluefruit_Learning_Guide.html#arduino-board-setup">
<img class="68538-asset img-responsive" src="./nRF52_bluefruit_Learning_Guide/microcontrollers_Screenshot_2019-01-01_at_12.59.47(1).png" alt="microcontrollers_Screenshot_2019-01-01_at_12.59.47.png">
<span class="image-expand"><i class="fa fa-search-plus"></i></span>
</a> </div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#2-select-the-usb-cdc-serial-port-6-3" class="anchor-link"><span class="fa fa-link"></span></a><span id="2-select-the-usb-cdc-serial-port-6-3" class="anchor-link-target"></span><span id="2-select-the-usb-cdc-serial-port" class="anchor-link-target"></span>2. Select the USB CDC Serial Port</h1>
<p>Finally, you need to set the serial port used by Serial Monitor and the serial bootloader:</p>
<ul>
<li>Go to <strong>Tools</strong> &gt; <strong>Port</strong> and select the appropriate device</li>
</ul>
</div>
<div class="row-fluid build-image">
<a href="./nRF52_bluefruit_Learning_Guide.html#arduino-board-setup">
<img class="38676-asset img-responsive" src="./nRF52_bluefruit_Learning_Guide/microcontrollers_Screen_Shot_2017-01-26_at_18.27.51.png" alt="microcontrollers_Screen_Shot_2017-01-26_at_18.27.51.png">
<span class="image-expand"><i class="fa fa-search-plus"></i></span>
</a> </div>
<div class="row-fluid build-text">
<h2>
<a href="#" class="anchor-link"><span class="fa fa-link"></span></a><span id="download-and-install-cp2104-driver-nrf52832-6-5" class="anchor-link-target"></span><span id="download-and-install-cp2104-driver-nrf52832" class="anchor-link-target"></span>Download &amp; Install CP2104 Driver (nRF52832)</h2>
<p>For Feather nRF52832 If you don't see the SiLabs device listed, you may need to install the <a href="http://www.silabs.com/products/mcu/pages/usbtouartbridgevcpdrivers.aspx" target="_blank">SiLabs CP2104 driver</a> on your system.</p>
<p>On MacOS&nbsp;If you see this dialog message while installing driver</p>
</div>
<table class="build-table">
<tbody><tr class="build-row">
<td class="side-images">
<a href="./nRF52_bluefruit_Learning_Guide.html#step-6" class="anchor-link"><span class="fa fa-link"></span></a>
<span id="step-6" class="anchor-link-target"></span>
<ul>
<li class="medium-side">
<a class="large-side-image-link" href="./nRF52_bluefruit_Learning_Guide.html#arduino-board-setup">
<img class="55243-asset medium-side-image img-responsive" src="./nRF52_bluefruit_Learning_Guide/microcontrollers_tn2459_blocked.png" alt="microcontrollers_tn2459_blocked.png">
</a></li>
</ul>
</td>
<td class="side-text"><div class="text"><p>On MacOS If you see this dialog message while installing driver, <strong>System Extension Blocked</strong></p>
<p>&nbsp;</p>
<p>And cannot find the serial port of CP2104, it is highly possible that driver is blocked.</p></div></td>
</tr>
<tr class="build-row">
<td class="side-images">
<a href="./nRF52_bluefruit_Learning_Guide.html#step-7" class="anchor-link"><span class="fa fa-link"></span></a>
<span id="step-7" class="anchor-link-target"></span>
<ul>
<li class="medium-side">
<a class="large-side-image-link" href="./nRF52_bluefruit_Learning_Guide.html#arduino-board-setup">
<img class="55242-asset medium-side-image img-responsive" src="./nRF52_bluefruit_Learning_Guide/microcontrollers_tn2459_approval.png" alt="microcontrollers_tn2459_approval.png">
</a></li>
</ul>
</td>
<td class="side-text"><div class="text"><p>To enable it go to <strong>System Preferences -&gt; Security &amp; Privacy</strong> and click allow if you see Silab in the developer name.</p></div></td>
</tr>
</tbody></table>

<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#3-update-the-bootloader-nrf52832-feather-only-6-9" class="anchor-link"><span class="fa fa-link"></span></a><span id="3-update-the-bootloader-nrf52832-feather-only-6-9" class="anchor-link-target"></span><span id="3-update-the-bootloader-nrf52832-feather-only" class="anchor-link-target"></span>3. Update the bootloader (nRF52832 Feather Only)</h1>
<p>To keep up with Nordic's SoftDevice advances, you will likely need to update your bootloader</p>
<p>Follow this link for instructions on how to do that</p>
</div>
<div class="element element element element element element element element element element element element row-fluid build-alert alert-info">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
This step is only necessary on the nRF52832-based devices.
</div>
</div>
<div id="element-3013641" class="button-element" data-github-release="">
<a href="./nRF52_bluefruit_Learning_Guide.html#updating-the-bootloader" class="btn btn-large btn-block btn-primary" target="_self" data-zip-folder="" type="button">Update the Bootloader</a>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#4-run-a-test-sketch-6-12" class="anchor-link"><span class="fa fa-link"></span></a><span id="4-run-a-test-sketch-6-12" class="anchor-link-target"></span><span id="4-run-a-test-sketch" class="anchor-link-target"></span>4. Run a Test Sketch</h1>
<p>At this point, you should be able to run a test sketch from the&nbsp;<strong>Examples</strong> folder, or just flash the following blinky code from the Arduino IDE:</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="#">
file
</a> <div class="code-copy-container">
<a href="#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">void setup() {
  pinMode(LED_BUILTIN, OUTPUT);
}

void loop() {
  digitalWrite(LED_BUILTIN, HIGH);   // turn the LED on (HIGH is the voltage level)
  delay(1000);                       // wait for a second
  digitalWrite(LED_BUILTIN, LOW);    // turn the LED off by making the voltage LOW
  delay(1000);                       // wait for a second
}</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="kwd">void</span><span class="pln"> setup</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span></li><li class="L1"><span class="pln">  pinMode</span><span class="pun">(</span><span class="pln">LED_BUILTIN</span><span class="pun">,</span><span class="pln"> OUTPUT</span><span class="pun">);</span></li><li class="L2"><span class="pun">}</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="kwd">void</span><span class="pln"> loop</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span></li><li class="L5"><span class="pln">  digitalWrite</span><span class="pun">(</span><span class="pln">LED_BUILTIN</span><span class="pun">,</span><span class="pln"> HIGH</span><span class="pun">);</span><span class="pln">   </span><span class="com">// turn the LED on (HIGH is the voltage level)</span></li><li class="L6"><span class="pln">  delay</span><span class="pun">(</span><span class="lit">1000</span><span class="pun">);</span><span class="pln">                       </span><span class="com">// wait for a second</span></li><li class="L7"><span class="pln">  digitalWrite</span><span class="pun">(</span><span class="pln">LED_BUILTIN</span><span class="pun">,</span><span class="pln"> LOW</span><span class="pun">);</span><span class="pln">    </span><span class="com">// turn the LED off by making the voltage LOW</span></li><li class="L8"><span class="pln">  delay</span><span class="pun">(</span><span class="lit">1000</span><span class="pun">);</span><span class="pln">                       </span><span class="com">// wait for a second</span></li><li class="L9"><span class="pun">}</span></li></ol></pre>
</div>
<div class="row-fluid build-text">

<p>This will blink the red LED beside the USB port on the Feather</p>
</div>
<div class="build-faq ">
<i class="fa fa-question-circle-o"></i>
<div class="collapsible-content">
<a href="./nRF52_bluefruit_Learning_Guide.html#faq-15" class="anchor-link"><span class="fa fa-link"></span></a>
<span id="faq-15" class="anchor-link-target"></span>
<div class="question">
<h2>If Arduino failed to upload sketch to the Feather</h2>
<div class="collapsible-icon">
<i class="collapsed-icon"></i>
</div>
</div>
<div class="answer"><h4><strong>If you get this error:</strong></h4>
<p><code>Timed out waiting for acknowledgement from device.<br><br>Failed to upgrade target. Error is: No data received on serial port. Not able to proceed.<br>Traceback (most recent call last):<br>&nbsp; File "nordicsemi\__main__.py", line 294, in serial<br>&nbsp; File "nordicsemi\dfu\dfu.py", line 235, in dfu_send_images<br>&nbsp; File "nordicsemi\dfu\dfu.py", line 203, in _dfu_send_image<br>&nbsp; File "nordicsemi\dfu\dfu_transport_serial.py", line 155, in send_init_packet<br>&nbsp; File "nordicsemi\dfu\dfu_transport_serial.py", line 243, in send_packet<br>&nbsp; File "nordicsemi\dfu\dfu_transport_serial.py", line 282, in get_ack_nr<br>nordicsemi.exceptions.NordicSemiException: No data received on serial port. Not able to proceed.</code></p>
<p>This is probably caused by the <strong>bootloader</strong> version mismatched on your feather and installed BSP. Due to the difference in flash layout (<a href="./nRF52_bluefruit_Learning_Guide.html#hathach-memory-map">more details</a>) and Softdevice API (which is bundled with bootloader), sketch built with selected bootloader can only upload to board having the same version. In short, you need to <strong>upgrade/burn bootloader to match</strong> on your Feather, follow above&nbsp;<a href="./nRF52_bluefruit_Learning_Guide.html#updating-the-bootloader">Update The Bootloader</a>&nbsp;guide</p>
<p>It only has to be done once to update your Feather</p></div>
</div>
</div>
<div class="build-faq ">
<i class="fa fa-question-circle-o"></i>
<div class="collapsible-content">
<a href="./nRF52_bluefruit_Learning_Guide.html#faq-16" class="anchor-link"><span class="fa fa-link"></span></a>
<span id="faq-16" class="anchor-link-target"></span>
<div class="question">
<h2>On Linux I'm getting 'arm-none-eabi-g++: no such file or directory', even though 'arm-none-eabi-g++' exists in the path specified. What should I do?</h2>
<div class="collapsible-icon">
<i class="collapsed-icon"></i>
</div>
</div>
<div class="answer"><p>This is probably caused by a conflict between 32-bit and 64-bit versions of the compiler, libc and the IDE. The compiler uses 32-bit binaries, so you also need to have a 32-bit version of libc installed on your system (<a href="http://forum.arduino.cc/index.php?topic=221979.0" target="_blank">details</a>). Try running the following commands from the command line to resolve this:</p>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="pln">sudo dpkg </span><span class="pun">--</span><span class="kwd">add</span><span class="pun">-</span><span class="pln">architecture i386</span></li><li class="L1"><span class="pln">sudo apt</span><span class="pun">-</span><span class="kwd">get</span><span class="pln"> update</span></li><li class="L2"><span class="pln">sudo apt</span><span class="pun">-</span><span class="kwd">get</span><span class="pln"> install libc6</span><span class="pun">:</span><span class="pln">i386</span></li></ol></pre></div>
</div>
</div>
</div>
</div>
<div class="page-title-wrapper">
<h1 class="headline">
<span id="using-the-bootloader">Using the Bootloader</span>
</h1>
<div class="author">by
<a href="./nRF52_bluefruit_Learning_Guide.html#using-the-bootloader">
<span class="name">Kevin Townsend</span>
</a> </div>
</div>
<div class="page-content all-page-view-content">
<div class="">
<div class="element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element row-fluid build-alert alert-info">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
This page is for information purposes only. Normally the bootloader will work transparently and automatically from the Arduino IDE, requiring no manual intervention on your behalf.
</div>
</div>
<div class="row-fluid build-text">
<p>The Bluefruit52 board includes a customized version of the Nordic bootloader that enables serial support, over the air (OTA) DFU support, and various fail safe features like factory reset when the FRST pin is grounded at startup.</p>
<p>The bootloader that all Bluefruit52 board ships with allows you to flash user sketches to the nRF52832 using only the CP2104 USB to serial adapter populated on the board.</p>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#forcing-serial-boot-mode-7-3" class="anchor-link"><span class="fa fa-link"></span></a><span id="forcing-serial-boot-mode-7-3" class="anchor-link-target"></span><span id="forcing-serial-boot-mode" class="anchor-link-target"></span>Forcing Serial Boot Mode</h1>
<p>The Bluefruit52 board is designed to briefly enter serial bootloader mode for a short delay every time the device comes out of reset, and the DTR line on the CP2104 USB to Serial adapter will trigger a reset every time the Serial Monitor is opened. This means that you can normally flash a user sketch to the nRF52 with no manual intervention on your part at a HW level.</p>
<p>If you need to force the serial bootloader mode, however, you can connect the&nbsp;<strong>DFU</strong> pin to&nbsp;<strong>GND</strong>&nbsp;at startup, which will force you to enter serial bootloader mode and stay in that mode until you reset or power cycle the board.</p>
<p>This can be used to recover bricked boards where a bad user sketch has been uploaded, since you will enter serial bootloader mode without executing the user sketch, and you can flash a new sketch directly from the Arduino IDE.</p>
</div>
<div class="element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element row-fluid build-alert alert-info">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
Forcing the serial bootloader can often be used to recover bricked devices.
</div>
</div>

<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#advanced-ota-dfu-bootloader-7-9" class="anchor-link"><span class="fa fa-link"></span></a><span id="advanced-ota-dfu-bootloader-7-9" class="anchor-link-target"></span><span id="advanced-ota-dfu-bootloader" class="anchor-link-target"></span>Advanced: OTA DFU Bootloader</h1>
<p>While this is only recommended for advanced users, you can also force OTA (Over The Air) DFU bootloader mode to enable OTA updates using BLE and Nordic's proprietary update protocol (which is support by both Nordic mobile apps, and out own Bluefruit LE Connect).</p>
<p><strong>To force OTA DFU mode, set DFU to GND at startup</strong>. Power cycling the board will cause the device to boot up into OTA DFU mode.</p>
</div>
<div class="element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element row-fluid build-alert alert-danger">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
This option is not actively support nor recommended by Afantor, and we are still working on making this as safe as possible for users via our Bluefruit LE Connect application. Use OTA DFU at your own risk knowing you can brick your device and may need a Segger J-Link or similar device to regain control of it!
</div>
</div>
</div>
</div>
<div class="page-title-wrapper">
<h1 class="headline">
<span id="updating-the-bootloader">Updating the Bootloader</span>
</h1>
<div class="author">by
<a href="./nRF52_bluefruit_Learning_Guide.html#updating-the-bootloader">
<span class="name">Kevin Townsend</span>
</a> </div>
</div>
<div class="page-content all-page-view-content">
<div class="">
<div class="element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element row-fluid build-alert alert-info">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
Upgrading the Bootloader is only possible from BSP release 0.8.0 and higher.
</div>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#upgrading-an-existing-bootloader-8-2" class="anchor-link"><span class="fa fa-link"></span></a><span id="upgrading-an-existing-bootloader-8-2" class="anchor-link-target"></span><span id="upgrading-an-existing-bootloader" class="anchor-link-target"></span>Upgrading an Existing Bootloader</h1>
<p>The nRF52832 Bootloader binary contains not only the DFU code, but also the Bluetooth stack (a.k.a&nbsp;SoftDevice) to make sure they work together reliably. To get the latest and greatest features from the stack such as Bluetooth 5.0 with higher throughput, increased broadcast capacities or larger MTU it is necessary to upgrade Bootloader to get the latest stack.</p>
<p>Therefore latest BSP release could support newer SoftDevice version than one currently exists on your board. Due to the flash memory &amp; API difference between SoftDevice major versions, upgrade your board's bootloader to match one supported by BSP is required to upload compiled sketch. Luckily the Bluefruit nRF52 Bootloader can be upgraded/downgraded without any additional hardware, and we can even do that right in Arduino IDE without at risk of typos or common user errors.</p>
</div>
<div class="element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element row-fluid build-alert alert-danger">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
Close the Serial Monitor before you click "Burn Bootloader". Afterwards, you shouldn't close the Arduino IDE, unplug the Feather, launch Serial Monitor etc ... to abort the process. There is a high chance it will brick your device! Do this with care and caution.
</div>
</div>
<table class="build-table">
<tbody><tr class="build-row">
<td class="side-images">
<a href="./nRF52_bluefruit_Learning_Guide.html#step-4" class="anchor-link"><span class="fa fa-link"></span></a>
<span id="step-4" class="anchor-link-target"></span>
<ul>
<li class="medium-side">
<a class="large-side-image-link" href="./nRF52_bluefruit_Learning_Guide.html#updating-the-bootloader">
<img class="68260-asset medium-side-image img-responsive" src="./nRF52_bluefruit_Learning_Guide/microcontrollers_image.png" alt="microcontrollers_image.png">
</a></li>
</ul>
</td>
<td class="side-text"><div class="text"><p>&nbsp;First select the Bootloader version that you want to upgrade under <strong>Tools-&gt;Bootloader</strong></p></div></td>
</tr>
<tr class="build-row">
<td class="side-images">
<a href="./nRF52_bluefruit_Learning_Guide.html#step-5" class="anchor-link"><span class="fa fa-link"></span></a>
<span id="step-5" class="anchor-link-target"></span>
<ul>
<li class="medium-side">
<a class="large-side-image-link" href="./nRF52_bluefruit_Learning_Guide.html#updating-the-bootloader">
<img class="68261-asset medium-side-image img-responsive" src="./nRF52_bluefruit_Learning_Guide/microcontrollers_image(1).png" alt="microcontrollers_image.png">
</a></li>
</ul>
</td>
<td class="side-text"><div class="text"><p>Then select "<strong>Bootloader DFU for Bluefruit nRF52</strong>" for <strong>Tools-&gt;Programmer</strong></p></div></td>
</tr>
</tbody></table>
<div class="row-fluid build-text">
<p><strong>Double check all of the following: Board, Bootloader Version, Programmer...</strong></p>
<p>Select <strong>Tools-&gt;Burn Bootloader</strong> to start the upgrade.</p>
</div>
<div class="row-fluid build-image">
<a href="./nRF52_bluefruit_Learning_Guide.html#updating-the-bootloader">
<img class="68265-asset img-responsive" src="./nRF52_bluefruit_Learning_Guide/microcontrollers_image(2).png" alt="microcontrollers_image.png">
<span class="image-expand"><i class="fa fa-search-plus"></i></span>
</a> </div>
<div class="row-fluid build-text">
<p>After receiving the new Bootloader over the serial connection, the old Bootloader will erase itself! The new bootloader will then be flashed. The process typically takes 30-60 seconds to complete. Make sure you see the "<strong>Device programmed</strong>" in the output log before launching Serial monitor or uploadinga new sketch.</p>
</div>
<div class="row-fluid build-image">
<a href="./nRF52_bluefruit_Learning_Guide.html#updating-the-bootloader">
<img class="68264-asset img-responsive" src="./nRF52_bluefruit_Learning_Guide/microcontrollers_Screenshot_from_2017-12-24_00-42-24.png" alt="microcontrollers_Screenshot_from_2017-12-24_00-42-24.png">
<span class="image-expand"><i class="fa fa-search-plus"></i></span>
</a> </div>
<div class="row-fluid build-text">
<p>In case you wonder, the command that IDE uses to upgrade bootloader is as follows (bootloader zip file is different for boards and version).</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="#">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">$ adafruit-nrfutil --verbose dfu serial --package feather_nrf52832_bootloader-0.2.9_s132_6.1.1.zip
 -p /dev/ttyACM0 -b 115200 --singlebank --touch 1200</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="pln">$ adafruit</span><span class="pun">-</span><span class="pln">nrfutil </span><span class="pun">--</span><span class="pln">verbose dfu serial </span><span class="pun">--</span><span class="kwd">package</span><span class="pln"> feather_nrf52832_bootloader</span><span class="pun">-</span><span class="lit">0.2</span><span class="pun">.</span><span class="lit">8</span><span class="pln">_s132_6</span><span class="pun">.</span><span class="lit">1.1</span><span class="pun">.</span><span class="pln">zip</span></li><li class="L1"><span class="pln"> </span><span class="pun">-</span><span class="pln">p </span><span class="pun">/</span><span class="pln">dev</span><span class="pun">/</span><span class="pln">ttyACM0 </span><span class="pun">-</span><span class="pln">b </span><span class="lit">115200</span><span class="pln"> </span><span class="pun">--</span><span class="pln">singlebank </span><span class="pun">--</span><span class="pln">touch </span><span class="lit">1200</span></li></ol></pre>
</div>
</div>
</div>
<div class="page-title-wrapper">
<h1 class="headline">
<span id="flashing-the-bootloader">Flashing the Bootloader</span>
</h1>
<div class="author">by
<a href="./nRF52_bluefruit_Learning_Guide.html#flashing-the-bootloader">
<span class="name">Kevin Townsend</span>
</a> </div>
</div>
<div class="page-content all-page-view-content">
<div class="">
<div class="element element element element element element element element element element element element element element element element element element element element element element element element element element element element row-fluid build-alert alert-danger">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>

All Bluefruit52 nRF52832 boards chip with the bootloader pre-flashed. This page is provided for information purposes only!
</div>
</div>
<div class="row-fluid build-text">
<p>All Bluefruit52 nRF52832 boards ship with the serial bootloader pre-flashed, so this page is normally not required when setting your device and system up.</p>
<p>The information provided here is only intended for for rare cases where you may&nbsp;want or need to reflash the bootloader yourself, and have access to the HW required to do so.</p>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#1-updating-the-bootloader-with-a-segger-j-link-and-arduino-ide-9-3" class="anchor-link"><span class="fa fa-link"></span></a><span id="1-updating-the-bootloader-with-a-segger-j-link-and-arduino-ide-9-3" class="anchor-link-target"></span><span id="1-updating-the-bootloader-with-a-segger-j-link-and-arduino-ide" class="anchor-link-target"></span>1. Updating the Bootloader with a Segger J-Link and Arduino IDE</h1>
<p>To burn the bootloader from within the Arduino IDE using a Segger J-Link, you will need the following tools installed on your system and available in the system path:</p>
</div>
<div class="row-fluid build-text">
<h3>JLink Drivers and Tools</h3>
<p>Download and install the <a href="https://www.segger.com/downloads/jlink" target="_blank">JLink Software and Documentation Pack</a>&nbsp;from Segger, which will also install a set of command line tools.</p>
</div>
<div class="row-fluid build-text">
<h3>Burning the Bootloader from the Arduino IDE</h3>
<p>Once the tools above have been installed and added to your system path, from the Arduino IDE:</p>
<ul>
<li>Select `<strong>Tools &gt; Board &gt; Adafruit Bluefruit Feather52</strong>`</li>
<li>Select `<strong>Tools &gt; Programmer &gt; J-Link for Feather52</strong>`</li>
<li>Select `<strong>Tools &gt; Burn Bootloader</strong>` with the board and J-Link connected</li>
</ul>
<p>The appropriate&nbsp;<strong>Programmer</strong> target and&nbsp;<strong>Burn Bootloader</strong> button can be seen below:</p>
</div>
<div class="element element element element element element element element element element element element row-fluid build-alert alert-info">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
You will need a Segger J-Link to flash the bootloader to the nRF52832/nRF52840 SoC!
</div>
</div>
<div class="row-fluid build-image">
<a href="./nRF52_bluefruit_Learning_Guide.html#1-updating-the-bootloader-with-a-segger-j-link-and-arduino-ide">
<img class="38675-asset img-responsive" src="./nRF52_bluefruit_Learning_Guide/microcontrollers_Screen_Shot_2017-01-26_at_18.07.08.png" alt="microcontrollers_Screen_Shot_2017-01-26_at_18.07.08.png">
<span class="image-expand"><i class="fa fa-search-plus"></i></span>
</a> </div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#2-manually-burning-the-bootloader-via-nrfjprog-9-8" class="anchor-link"><span class="fa fa-link"></span></a><span id="2-manually-burning-the-bootloader-via-nrfjprog-9-8" class="anchor-link-target"></span><span id="2-manually-burning-the-bootloader-via-nrfjprog" class="anchor-link-target"></span>2. Manually Burning the Bootloader via nrfjprog</h1>
<p>You can also manually burn the bootloader from the command line, using&nbsp;`nrfjprog` from Nordic.</p>
<p>You can either download <a href="https://www.nordicsemi.com/eng/Products/Bluetooth-low-energy/nRF52832#Downloads" target="_blank">nRF5x-Command-Line-Tools</a> for OSX/Linux/Win32, or use the version that ships with the BSP in the&nbsp;<strong>tools/nrf5x-command-line-tools</strong> folder.</p>
<p>Run the folllwing commands, updating the path to the .hex file as appropriate:</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="#">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">$ nrfjprog --program bootloader_binary.hex --chiperase -f nrf52 --reset</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="pln">$ nrfjprog </span><span class="pun">--</span><span class="pln">program bootloader_binary</span><span class="pun">.</span><span class="pln">hex </span><span class="pun">--</span><span class="pln">chiperase </span><span class="pun">-</span><span class="pln">f nrf52 </span><span class="pun">--</span><span class="pln">reset</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<p>You should see something similar to the following output, followed by a fast blinky on the status LED to indicate that you are in DFU/bootloader mode since no user sketch was found after the device reset:</p>
</div>
<div class="element element element element element element element element element element element element element element element element element element element element element element element element element element element element row-fluid build-alert alert-info">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
All commands below were run from 'tools/nrf5x-command-line-tools/osx/nrfjprog'
</div>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="#">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">$ ./nrfjprog -e -f nrf52
Erasing code and UICR flash areas.
Applying system reset.

$ ./nrfjprog --program  ../../../../bin/bootloader/bootloader_v050_s132_v201.hex -f nrf52
Parsing hex file.
Reading flash area to program to guarantee it is erased.
Checking that the area to write is not protected.
Programing device.

$ ./nrfjprog --reset -f nrf52
Applying system reset.
Run.</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="pln">$ </span><span class="pun">./</span><span class="pln">nrfjprog </span><span class="pun">-</span><span class="pln">e </span><span class="pun">-</span><span class="pln">f nrf52</span></li><li class="L1"><span class="typ">Erasing</span><span class="pln"> code </span><span class="kwd">and</span><span class="pln"> UICR flash areas</span><span class="pun">.</span></li><li class="L2"><span class="typ">Applying</span><span class="pln"> system reset</span><span class="pun">.</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln">$ </span><span class="pun">./</span><span class="pln">nrfjprog </span><span class="pun">--</span><span class="pln">program  </span><span class="pun">../../../../</span><span class="pln">bin</span><span class="pun">/</span><span class="pln">bootloader</span><span class="pun">/</span><span class="pln">bootloader_v050_s132_v201</span><span class="pun">.</span><span class="pln">hex </span><span class="pun">-</span><span class="pln">f nrf52</span></li><li class="L5"><span class="typ">Parsing</span><span class="pln"> hex file</span><span class="pun">.</span></li><li class="L6"><span class="typ">Reading</span><span class="pln"> flash area to program to guarantee it </span><span class="kwd">is</span><span class="pln"> erased</span><span class="pun">.</span></li><li class="L7"><span class="typ">Checking</span><span class="pln"> that the area to write </span><span class="kwd">is</span><span class="pln"> </span><span class="kwd">not</span><span class="pln"> </span><span class="kwd">protected</span><span class="pun">.</span></li><li class="L8"><span class="typ">Programing</span><span class="pln"> device</span><span class="pun">.</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="pln">$ </span><span class="pun">./</span><span class="pln">nrfjprog </span><span class="pun">--</span><span class="pln">reset </span><span class="pun">-</span><span class="pln">f nrf52</span></li><li class="L1"><span class="typ">Applying</span><span class="pln"> system reset</span><span class="pun">.</span></li><li class="L2"><span class="typ">Run</span><span class="pun">.</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<p><strong>OS X Note:</strong>&nbsp;You may need to create a symlink in `/usr/local/bin` to the<br>`nrfjprog` tool wherever you have added it. You can run the following command, for example:</p>
<pre>$ ln -s $HOME/prog/nordic/nrfjprog/nrfjprog /usr/local/bin/nrfjprog</pre>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#3-manually-burning-the-bootloader-via-adalink-9-14" class="anchor-link"><span class="fa fa-link"></span></a><span id="3-manually-burning-the-bootloader-via-adalink-9-14" class="anchor-link-target"></span><span id="3-manually-burning-the-bootloader-via-adalink" class="anchor-link-target"></span>3. Manually Burning the Bootloader via AdaLink</h1>
<p>Alternatively, you can use <a href="https://github.com/adafruit/Adafruit_Adalink" target="_blank">AdaLink</a> to flash the bootloader with a Segger J-Link:</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="#">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;"># First erase the device's flash contents
$ adalink nrf52832 -p jlink -w

# Then flash the bootloader and SoftDevice .hex file
$ adalink nrf52832 -p jlink -h feather52_bootloader_v050_s132_v201.hex</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="com"># First erase the device's flash contents</span></li><li class="L1"><span class="pln">$ adalink nrf52832 </span><span class="pun">-</span><span class="pln">p jlink </span><span class="pun">-</span><span class="pln">w</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="com"># Then flash the bootloader and SoftDevice .hex file</span></li><li class="L4"><span class="pln">$ adalink nrf52832 </span><span class="pun">-</span><span class="pln">p jlink </span><span class="pun">-</span><span class="pln">h feather52_bootloader_v050_s132_v201</span><span class="pun">.</span><span class="pln">hex</span></li></ol></pre>
</div>
</div>
</div>
<div class="page-title-wrapper">
<h1 class="headline">
<span id="examples">Arduino Examples</span>
</h1>
<div class="author">by
<a href="./nRF52_bluefruit_Learning_Guide.html#examples">
<span class="name">Kevin Townsend</span>
</a> </div>
</div>
<div class="page-content all-page-view-content">
<div class="">
<div class="row-fluid build-text">
<p>There are numerous examples available for the Bluefruit52 board in the&nbsp;<strong>Examples</strong> menu of the nRF52 BSP, and these are always up to date. You're first stop looking for example code should be there:</p>
</div>
<div class="row-fluid build-image">
<a href="./nRF52_bluefruit_Learning_Guide.html#examples">
<img class="39998-asset img-responsive" src="./nRF52_bluefruit_Learning_Guide/microcontrollers_Screen_Shot_2017-03-09_at_15.55.02.png" alt="microcontrollers_Screen_Shot_2017-03-09_at_15.55.02.png">
<span class="image-expand"><i class="fa fa-search-plus"></i></span>
</a> </div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#example-source-code-10-3" class="anchor-link"><span class="fa fa-link"></span></a><span id="example-source-code-10-3" class="anchor-link-target"></span><span id="example-source-code" class="anchor-link-target"></span>Example Source Code</h1>
<p>The latest example source code is always available and visible on Github, and the public git repository should be considered the definitive source of example code for this board.</p>
</div>
<div id="element-2860649" class="button-element" data-github-release="">
<a href="https://github.com/adafruit/Adafruit_nRF52_Arduino/tree/master/libraries/Bluefruit52Lib/examples" class="btn btn-large btn-block btn-info" target="_blank" data-zip-folder="" type="button">Click here to browse the example source code on Github</a>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#documented-examples-10-5" class="anchor-link"><span class="fa fa-link"></span></a><span id="documented-examples-10-5" class="anchor-link-target"></span><span id="documented-examples" class="anchor-link-target"></span>Documented Examples</h1>
<p>To help explain some common use cases for the nRF52 BLE API, feel free to consult the example documentation in this section of the learning guide:</p>
<ul>
<li>
<strong>Advertising: Beacon</strong> - Shows how to use the BLEBeacon helper class to configure your Bleufruit nRF52 Feather as a beacon</li>
<li>
<strong>BLE UART: Controller</strong> - Shows how to use the <strong>Controller</strong>&nbsp;utility in our Bluefruit LE Connect apps to send basic data between your peripheral and your phone or tablet.</li>
<li>
<strong>Custom: HRM</strong> - Shows how to defined and work with a custom GATT Service and Characteristic, using the officially adopted Heart Rate Monitor (HRM) service as an example.</li>
<li>
<strong>BLE Pin I/O</strong> (StandardFirmataBLE) Shows how to control Pin I/O of nRF52 with Firmata protocol</li>
</ul>
</div>
</div>
</div>
<div class="page-title-wrapper">
<h1 class="headline">
<span id="advertising-beacon">Advertising: Beacon</span>
</h1>
<div class="author">by
<a href="./nRF52_bluefruit_Learning_Guide.html#advertising-beacon">
<span class="name">Kevin Townsend</span>
</a> </div>
</div>
<div class="page-content all-page-view-content">
<div class="">
<div class="row-fluid build-text">
<p>This example shows how you can use the BLEBeacon helper class and advertising API to configure your Bluefruit nRF52 board as a 'Beacon'.</p>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#complete-code-11-2" class="anchor-link"><span class="fa fa-link"></span></a><span id="complete-code-11-2" class="anchor-link-target"></span><span id="complete-code" class="anchor-link-target"></span>Complete Code</h1>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/9036/elements/3014335/download?type=zip">
Project Zip
</a> <span class="divider">or</span>
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/9036/elements/3014335/download">
beacon.ino
</a> <span class="divider visible-lg-inline">|</span>
<a target="_blank" class="visible-lg-inline" href="https://github.com/adafruit/Adafruit_nRF52_Arduino/blob/master/libraries/Bluefruit52Lib/examples/Peripheral/beacon/beacon.ino">
<i class="fa fa-github"></i>
View on Github
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">/*********************************************************************
 This is an example for our nRF52 based Bluefruit LE modules

 Pick one up today in the adafruit shop!

 Adafruit invests time and resources providing this open source code,
 please support Adafruit and open-source hardware by purchasing
 products from Adafruit!

 MIT license, check LICENSE for more information
 All text above, and the splash screen below must be included in
 any redistribution
*********************************************************************/
#include &lt;bluefruit.h&gt;

// Beacon uses the Manufacturer Specific Data field in the advertising
// packet, which means you must provide a valid Manufacturer ID. Update
// the field below to an appropriate value. For a list of valid IDs see:
// https://www.bluetooth.com/specifications/assigned-numbers/company-identifiers
// 0x004C is Apple (for example)
#define MANUFACTURER_ID   0x004C 

// AirLocate UUID: E2C56DB5-DFFB-48D2-B060-D0F5A71096E0
uint8_t beaconUuid[16] = 
{ 
  0xE2, 0xC5, 0x6D, 0xB5, 0xDF, 0xFB, 0x48, 0xD2, 
  0xB0, 0x60, 0xD0, 0xF5, 0xA7, 0x10, 0x96, 0xE0, 
};

// A valid Beacon packet consists of the following information:
// UUID, Major, Minor, RSSI @ 1M
BLEBeacon beacon(beaconUuid, 0x0000, 0x0000, -54);

void setup() 
{
  Serial.begin(115200);
  while ( !Serial ) delay(10);   // for nrf52840 with native usb

  Serial.println("Bluefruit52 Beacon Example");
  Serial.println("--------------------------\n");

  Bluefruit.begin();

  // off Blue LED for lowest power consumption
  Bluefruit.autoConnLed(false);
  Bluefruit.setTxPower(0);    // Check bluefruit.h for supported values
  Bluefruit.setName("Bluefruit52");

  // Manufacturer ID is required for Manufacturer Specific Data
  beacon.setManufacturer(MANUFACTURER_ID);

  // Setup the advertising packet
  startAdv();

  Serial.println("Broadcasting beacon, open your beacon app to test");

  // Suspend Loop() to save power, since we didn't have any code there
  suspendLoop();
}

void startAdv(void)
{  
  // Advertising packet
  // Set the beacon payload using the BLEBeacon class populated
  // earlier in this example
  Bluefruit.Advertising.setBeacon(beacon);

  // Secondary Scan Response packet (optional)
  // Since there is no room for 'Name' in Advertising packet
  Bluefruit.ScanResponse.addName();
  
  /* Start Advertising
   * - Enable auto advertising if disconnected
   * - Timeout for fast mode is 30 seconds
   * - Start(timeout) with timeout = 0 will advertise forever (until connected)
   * 
   * Apple Beacon specs
   * - Type: Non connectable, undirected
   * - Fixed interval: 100 ms -&gt; fast = slow = 100 ms
   */
  //Bluefruit.Advertising.setType(BLE_GAP_ADV_TYPE_ADV_NONCONN_IND);
  Bluefruit.Advertising.restartOnDisconnect(true);
  Bluefruit.Advertising.setInterval(160, 160);    // in unit of 0.625 ms
  Bluefruit.Advertising.setFastTimeout(30);      // number of seconds in fast mode
  Bluefruit.Advertising.start(0);                // 0 = Don't stop advertising after n seconds  
}

void loop() 
{
  // loop is already suspended, CPU will not run loop() at all
}
</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="com">/*********************************************************************</span></li><li class="L1"><span class="com"> This is an example for our nRF52 based Bluefruit LE modules</span></li><li class="L2"><span class="com">&nbsp;</span></li><li class="L3"><span class="com"> Pick one up today in the adafruit shop!</span></li><li class="L4"><span class="com">&nbsp;</span></li><li class="L5"><span class="com"> Adafruit invests time and resources providing this open source code,</span></li><li class="L6"><span class="com"> please support Adafruit and open-source hardware by purchasing</span></li><li class="L7"><span class="com"> products from Adafruit!</span></li><li class="L8"><span class="com">&nbsp;</span></li><li class="L9"><span class="com"> MIT license, check LICENSE for more information</span></li><li class="L0"><span class="com"> All text above, and the splash screen below must be included in</span></li><li class="L1"><span class="com"> any redistribution</span></li><li class="L2"><span class="com">*********************************************************************/</span></li><li class="L3"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;bluefruit.h&gt;</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="com">// Beacon uses the Manufacturer Specific Data field in the advertising</span></li><li class="L6"><span class="com">// packet, which means you must provide a valid Manufacturer ID. Update</span></li><li class="L7"><span class="com">// the field below to an appropriate value. For a list of valid IDs see:</span></li><li class="L8"><span class="com">// https://www.bluetooth.com/specifications/assigned-numbers/company-identifiers</span></li><li class="L9"><span class="com">// 0x004C is Apple (for example)</span></li><li class="L0"><span class="com">#define</span><span class="pln"> MANUFACTURER_ID   </span><span class="lit">0x004C</span><span class="pln"> </span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="com">// AirLocate UUID: E2C56DB5-DFFB-48D2-B060-D0F5A71096E0</span></li><li class="L3"><span class="typ">uint8_t</span><span class="pln"> beaconUuid</span><span class="pun">[</span><span class="lit">16</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span></li><li class="L4"><span class="pun">{</span><span class="pln"> </span></li><li class="L5"><span class="pln">  </span><span class="lit">0xE2</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0xC5</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x6D</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0xB5</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0xDF</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0xFB</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x48</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0xD2</span><span class="pun">,</span><span class="pln"> </span></li><li class="L6"><span class="pln">  </span><span class="lit">0xB0</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x60</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0xD0</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0xF5</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0xA7</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x10</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x96</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0xE0</span><span class="pun">,</span><span class="pln"> </span></li><li class="L7"><span class="pun">};</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="com">// A valid Beacon packet consists of the following information:</span></li><li class="L0"><span class="com">// UUID, Major, Minor, RSSI @ 1M</span></li><li class="L1"><span class="typ">BLEBeacon</span><span class="pln"> beacon</span><span class="pun">(</span><span class="pln">beaconUuid</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x0000</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x0000</span><span class="pun">,</span><span class="pln"> </span><span class="pun">-</span><span class="lit">54</span><span class="pun">);</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="kwd">void</span><span class="pln"> setup</span><span class="pun">()</span><span class="pln"> </span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">(</span><span class="lit">115200</span><span class="pun">);</span></li><li class="L6"><span class="pln">  </span><span class="kwd">while</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="typ">Serial</span><span class="pln"> </span><span class="pun">)</span><span class="pln"> delay</span><span class="pun">(</span><span class="lit">10</span><span class="pun">);</span><span class="pln">   </span><span class="com">// for nrf52840 with native usb</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Bluefruit52 Beacon Example"</span><span class="pun">);</span></li><li class="L9"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"--------------------------\n"</span><span class="pun">);</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="pln">  </span><span class="com">// off Blue LED for lowest power consumption</span></li><li class="L4"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="pln">autoConnLed</span><span class="pun">(</span><span class="kwd">false</span><span class="pun">);</span></li><li class="L5"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="pln">setTxPower</span><span class="pun">(</span><span class="lit">0</span><span class="pun">);</span><span class="pln">    </span><span class="com">// Check bluefruit.h for supported values</span></li><li class="L6"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="pln">setName</span><span class="pun">(</span><span class="str">"Bluefruit52"</span><span class="pun">);</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">  </span><span class="com">// Manufacturer ID is required for Manufacturer Specific Data</span></li><li class="L9"><span class="pln">  beacon</span><span class="pun">.</span><span class="pln">setManufacturer</span><span class="pun">(</span><span class="pln">MANUFACTURER_ID</span><span class="pun">);</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">  </span><span class="com">// Setup the advertising packet</span></li><li class="L2"><span class="pln">  startAdv</span><span class="pun">();</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Broadcasting beacon, open your beacon app to test"</span><span class="pun">);</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">  </span><span class="com">// Suspend Loop() to save power, since we didn't have any code there</span></li><li class="L7"><span class="pln">  suspendLoop</span><span class="pun">();</span></li><li class="L8"><span class="pun">}</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="kwd">void</span><span class="pln"> startAdv</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span></li><li class="L1"><span class="pun">{</span><span class="pln">  </span></li><li class="L2"><span class="pln">  </span><span class="com">// Advertising packet</span></li><li class="L3"><span class="pln">  </span><span class="com">// Set the beacon payload using the BLEBeacon class populated</span></li><li class="L4"><span class="pln">  </span><span class="com">// earlier in this example</span></li><li class="L5"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">setBeacon</span><span class="pun">(</span><span class="pln">beacon</span><span class="pun">);</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="pln">  </span><span class="com">// Secondary Scan Response packet (optional)</span></li><li class="L8"><span class="pln">  </span><span class="com">// Since there is no room for 'Name' in Advertising packet</span></li><li class="L9"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">ScanResponse</span><span class="pun">.</span><span class="pln">addName</span><span class="pun">();</span></li><li class="L0"><span class="pln">  </span></li><li class="L1"><span class="pln">  </span><span class="com">/* Start Advertising</span></li><li class="L2"><span class="com">   * - Enable auto advertising if disconnected</span></li><li class="L3"><span class="com">   * - Timeout for fast mode is 30 seconds</span></li><li class="L4"><span class="com">   * - Start(timeout) with timeout = 0 will advertise forever (until connected)</span></li><li class="L5"><span class="com">   * </span></li><li class="L6"><span class="com">   * Apple Beacon specs</span></li><li class="L7"><span class="com">   * - Type: Non connectable, undirected</span></li><li class="L8"><span class="com">   * - Fixed interval: 100 ms -&gt; fast = slow = 100 ms</span></li><li class="L9"><span class="com">   */</span></li><li class="L0"><span class="pln">  </span><span class="com">//Bluefruit.Advertising.setType(BLE_GAP_ADV_TYPE_ADV_NONCONN_IND);</span></li><li class="L1"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">restartOnDisconnect</span><span class="pun">(</span><span class="kwd">true</span><span class="pun">);</span></li><li class="L2"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">setInterval</span><span class="pun">(</span><span class="lit">160</span><span class="pun">,</span><span class="pln"> </span><span class="lit">160</span><span class="pun">);</span><span class="pln">    </span><span class="com">// in unit of 0.625 ms</span></li><li class="L3"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">setFastTimeout</span><span class="pun">(</span><span class="lit">30</span><span class="pun">);</span><span class="pln">      </span><span class="com">// number of seconds in fast mode</span></li><li class="L4"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">start</span><span class="pun">(</span><span class="lit">0</span><span class="pun">);</span><span class="pln">                </span><span class="com">// 0 = Don't stop advertising after n seconds  </span></li><li class="L5"><span class="pun">}</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="kwd">void</span><span class="pln"> loop</span><span class="pun">()</span><span class="pln"> </span></li><li class="L8"><span class="pun">{</span></li><li class="L9"><span class="pln">  </span><span class="com">// loop is already suspended, CPU will not run loop() at all</span></li><li class="L0"><span class="pun">}</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#output-11-4" class="anchor-link"><span class="fa fa-link"></span></a><span id="output-11-4" class="anchor-link-target"></span><span id="output" class="anchor-link-target"></span>Output</h1>
<p>You can use the nRF Beacons application from Nordic Semiconductors to test this sketch:</p>
<ul>
<li><a href="https://itunes.apple.com/app/nrf-beacons/id879614768?mt=8" target="_blank">nRF Beacons for iOS</a></li>
<li><a href="https://play.google.com/store/apps/details?id=no.nordicsemi.android.nrfbeacon" target="_blank">nRF Beacons for Android</a></li>
</ul>
<p>Make sure that you set the UUID, Major and Minor values to match the sketch above, and then run the sketch at the same time as the nRF Beacons application.</p>
<p>With the default setup you should see a Mona Lisa icon when the beacon is detected. If you don't see this, double check the UUID, Major and Minor values to be sure they match exactly.</p>
</div>
<div class="row-fluid build-image">
<a href="./nRF52_bluefruit_Learning_Guide.html#output">
<img class="40306-asset img-responsive" src="./nRF52_bluefruit_Learning_Guide/microcontrollers_Beacons.png" alt="microcontrollers_Beacons.png">
<span class="image-expand"><i class="fa fa-search-plus"></i></span>
</a> </div>
</div>
</div>
<div class="page-title-wrapper">
<h1 class="headline">
<span id="ble-uart-controller">BLE UART: Controller</span>
</h1>
<div class="author">by
<a href="./nRF52_bluefruit_Learning_Guide.html#ble-uart-controller">
<span class="name">Kevin Townsend</span>
</a> </div>
</div>
<div class="page-content all-page-view-content">
 <div class="">
<div class="row-fluid build-text">
<p>This examples shows you you can use the BLEUart helper class and the Bluefruit LE Connect applications to send based keypad and sensor data to your nRF52.</p>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#setup-12-2" class="anchor-link"><span class="fa fa-link"></span></a><span id="setup-12-2" class="anchor-link-target"></span><span id="setup" class="anchor-link-target"></span>Setup</h1>
<p>In order to use this sketch, you will need to open Bluefruit LE Connect on your mobile device using our free <a href="https://itunes.apple.com/app/adafruit-bluefruit-le-connect/id830125974?mt=8" target="_blank">iOS</a>, <a href="https://play.google.com/store/apps/details?id=com.adafruit.bluefruit.le.connect" target="_blank">Android</a> or <a href="https://itunes.apple.com/us/app/adafruit-bluefruit-le-connect/id1082414600?mt=12" target="_blank">OS X</a> applications.</p>
<ul>
<li>Load the&nbsp;<a href="https://github.com/adafruit/Adafruit_nRF52_Arduino/tree/master/libraries/Bluefruit52Lib/examples/Peripheral/controller" target="_blank"><strong>Controller</strong> example sketch</a> in the Arduino IDE</li>
<li>Compile the sketch and flash it to your nRF52 based Feather</li>
<li>Once you are done uploading, open the&nbsp;<strong>Serial Monitor</strong> (Tools &gt; Serial Monitor)</li>
<li>Open the <strong>Bluefruit LE Connect</strong> application on your mobile device</li>
<li>Connect to the appropriate target (probably '<strong>Bluefruit52</strong>')</li>
<li>Once connected switch to the&nbsp;<strong>Controller</strong>&nbsp;application inside the app</li>
<li>Enable an appropriate control surface. The&nbsp;<strong>Color Picker</strong> control surface is shown below, for example (screen shot taken from the iOS application):</li>
</ul>
</div>
<div class="row-fluid build-image">
<a href="./nRF52_bluefruit_Learning_Guide.html#ble-uart-controller">
<img class="39829-asset img-responsive" src="./nRF52_bluefruit_Learning_Guide/microcontrollers_bluefruitcolorpicker.jpeg" alt="microcontrollers_bluefruitcolorpicker.jpeg">
<span class="image-expand"><i class="fa fa-search-plus"></i></span>
</a> </div>
<div class="row-fluid build-text">
<p>As you change the color (or as other data becomes available) you should receive the data on the nRF52, and see it in the Serial Monitor output:</p>
</div>
<div class="row-fluid build-image">
<a href="./nRF52_bluefruit_Learning_Guide.html#ble-uart-controller">
<img class="39830-asset img-responsive" src="./nRF52_bluefruit_Learning_Guide/microcontrollers_Screen_Shot_2017-03-06_at_15.08.33.png" alt="microcontrollers_Screen_Shot_2017-03-06_at_15.08.33.png">
<span class="image-expand"><i class="fa fa-search-plus"></i></span>
</a> </div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#complete-code-12-6" class="anchor-link"><span class="fa fa-link"></span></a><span id="complete-code-12-6" class="anchor-link-target"></span><span id="complete-code" class="anchor-link-target"></span>Complete Code</h1>
<p>&nbsp;</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/9037/elements/3014336/download?type=zip">
Project Zip
</a> <span class="divider">or</span>
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/9037/elements/3014336/download">
controller.ino
</a> <span class="divider visible-lg-inline">|</span>
<a target="_blank" class="visible-lg-inline" href="https://github.com/adafruit/Adafruit_nRF52_Arduino/blob/master/libraries/Bluefruit52Lib/examples/Peripheral/controller/controller.ino">
<i class="fa fa-github"></i>
View on Github
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">/*********************************************************************
 This is an example for our nRF52 based Bluefruit LE modules

 Pick one up today in the adafruit shop!

 Adafruit invests time and resources providing this open source code,
 please support Adafruit and open-source hardware by purchasing
 products from Adafruit!

 MIT license, check LICENSE for more information
 All text above, and the splash screen below must be included in
 any redistribution
*********************************************************************/

#include &lt;bluefruit.h&gt;

// OTA DFU service
BLEDfu bledfu;

// Uart over BLE service
BLEUart bleuart;

// Function prototypes for packetparser.cpp
uint8_t readPacket (BLEUart *ble_uart, uint16_t timeout);
float   parsefloat (uint8_t *buffer);
void    printHex   (const uint8_t * data, const uint32_t numBytes);

// Packet buffer
extern uint8_t packetbuffer[];

void setup(void)
{
  Serial.begin(115200);
  while ( !Serial ) delay(10);   // for nrf52840 with native usb

  Serial.println(F("Adafruit Bluefruit52 Controller App Example"));
  Serial.println(F("-------------------------------------------"));

  Bluefruit.begin();
  Bluefruit.setTxPower(4);    // Check bluefruit.h for supported values
  Bluefruit.setName("Bluefruit52");

  // To be consistent OTA DFU should be added first if it exists
  bledfu.begin();

  // Configure and start the BLE Uart service
  bleuart.begin();

  // Set up and start advertising
  startAdv();

  Serial.println(F("Please use Adafruit Bluefruit LE app to connect in Controller mode"));
  Serial.println(F("Then activate/use the sensors, color picker, game controller, etc!"));
  Serial.println();  
}

void startAdv(void)
{
  // Advertising packet
  Bluefruit.Advertising.addFlags(BLE_GAP_ADV_FLAGS_LE_ONLY_GENERAL_DISC_MODE);
  Bluefruit.Advertising.addTxPower();
  
  // Include the BLE UART (AKA 'NUS') 128-bit UUID
  Bluefruit.Advertising.addService(bleuart);

  // Secondary Scan Response packet (optional)
  // Since there is no room for 'Name' in Advertising packet
  Bluefruit.ScanResponse.addName();

  /* Start Advertising
   * - Enable auto advertising if disconnected
   * - Interval:  fast mode = 20 ms, slow mode = 152.5 ms
   * - Timeout for fast mode is 30 seconds
   * - Start(timeout) with timeout = 0 will advertise forever (until connected)
   * 
   * For recommended advertising interval
   * https://developer.apple.com/library/content/qa/qa1931/_index.html   
   */
  Bluefruit.Advertising.restartOnDisconnect(true);
  Bluefruit.Advertising.setInterval(32, 244);    // in unit of 0.625 ms
  Bluefruit.Advertising.setFastTimeout(30);      // number of seconds in fast mode
  Bluefruit.Advertising.start(0);                // 0 = Don't stop advertising after n seconds  
}

/**************************************************************************/
/*!
    @brief  Constantly poll for new command or response data
*/
/**************************************************************************/
void loop(void)
{
  // Wait for new data to arrive
  uint8_t len = readPacket(&amp;bleuart, 500);
  if (len == 0) return;

  // Got a packet!
  // printHex(packetbuffer, len);

  // Color
  if (packetbuffer[1] == 'C') {
    uint8_t red = packetbuffer[2];
    uint8_t green = packetbuffer[3];
    uint8_t blue = packetbuffer[4];
    Serial.print ("RGB #");
    if (red &lt; 0x10) Serial.print("0");
    Serial.print(red, HEX);
    if (green &lt; 0x10) Serial.print("0");
    Serial.print(green, HEX);
    if (blue &lt; 0x10) Serial.print("0");
    Serial.println(blue, HEX);
  }

  // Buttons
  if (packetbuffer[1] == 'B') {
    uint8_t buttnum = packetbuffer[2] - '0';
    boolean pressed = packetbuffer[3] - '0';
    Serial.print ("Button "); Serial.print(buttnum);
    if (pressed) {
      Serial.println(" pressed");
    } else {
      Serial.println(" released");
    }
  }

  // GPS Location
  if (packetbuffer[1] == 'L') {
    float lat, lon, alt;
    lat = parsefloat(packetbuffer+2);
    lon = parsefloat(packetbuffer+6);
    alt = parsefloat(packetbuffer+10);
    Serial.print("GPS Location\t");
    Serial.print("Lat: "); Serial.print(lat, 4); // 4 digits of precision!
    Serial.print('\t');
    Serial.print("Lon: "); Serial.print(lon, 4); // 4 digits of precision!
    Serial.print('\t');
    Serial.print(alt, 4); Serial.println(" meters");
  }

  // Accelerometer
  if (packetbuffer[1] == 'A') {
    float x, y, z;
    x = parsefloat(packetbuffer+2);
    y = parsefloat(packetbuffer+6);
    z = parsefloat(packetbuffer+10);
    Serial.print("Accel\t");
    Serial.print(x); Serial.print('\t');
    Serial.print(y); Serial.print('\t');
    Serial.print(z); Serial.println();
  }

  // Magnetometer
  if (packetbuffer[1] == 'M') {
    float x, y, z;
    x = parsefloat(packetbuffer+2);
    y = parsefloat(packetbuffer+6);
    z = parsefloat(packetbuffer+10);
    Serial.print("Mag\t");
    Serial.print(x); Serial.print('\t');
    Serial.print(y); Serial.print('\t');
    Serial.print(z); Serial.println();
  }

  // Gyroscope
  if (packetbuffer[1] == 'G') {
    float x, y, z;
    x = parsefloat(packetbuffer+2);
    y = parsefloat(packetbuffer+6);
    z = parsefloat(packetbuffer+10);
    Serial.print("Gyro\t");
    Serial.print(x); Serial.print('\t');
    Serial.print(y); Serial.print('\t');
    Serial.print(z); Serial.println();
  }

  // Quaternions
  if (packetbuffer[1] == 'Q') {
    float x, y, z, w;
    x = parsefloat(packetbuffer+2);
    y = parsefloat(packetbuffer+6);
    z = parsefloat(packetbuffer+10);
    w = parsefloat(packetbuffer+14);
    Serial.print("Quat\t");
    Serial.print(x); Serial.print('\t');
    Serial.print(y); Serial.print('\t');
    Serial.print(z); Serial.print('\t');
    Serial.print(w); Serial.println();
  }
}
</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="com">/*********************************************************************</span></li><li class="L1"><span class="com"> This is an example for our nRF52 based Bluefruit LE modules</span></li><li class="L2"><span class="com">&nbsp;</span></li><li class="L3"><span class="com"> Pick one up today in the adafruit shop!</span></li><li class="L4"><span class="com">&nbsp;</span></li><li class="L5"><span class="com"> Adafruit invests time and resources providing this open source code,</span></li><li class="L6"><span class="com"> please support Adafruit and open-source hardware by purchasing</span></li><li class="L7"><span class="com"> products from Adafruit!</span></li><li class="L8"><span class="com">&nbsp;</span></li><li class="L9"><span class="com"> MIT license, check LICENSE for more information</span></li><li class="L0"><span class="com"> All text above, and the splash screen below must be included in</span></li><li class="L1"><span class="com"> any redistribution</span></li><li class="L2"><span class="com">*********************************************************************/</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;bluefruit.h&gt;</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="com">// OTA DFU service</span></li><li class="L7"><span class="typ">BLEDfu</span><span class="pln"> bledfu</span><span class="pun">;</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="com">// Uart over BLE service</span></li><li class="L0"><span class="typ">BLEUart</span><span class="pln"> bleuart</span><span class="pun">;</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="com">// Function prototypes for packetparser.cpp</span></li><li class="L3"><span class="typ">uint8_t</span><span class="pln"> readPacket </span><span class="pun">(</span><span class="typ">BLEUart</span><span class="pln"> </span><span class="pun">*</span><span class="pln">ble_uart</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint16_t</span><span class="pln"> timeout</span><span class="pun">);</span></li><li class="L4"><span class="kwd">float</span><span class="pln">   parsefloat </span><span class="pun">(</span><span class="typ">uint8_t</span><span class="pln"> </span><span class="pun">*</span><span class="pln">buffer</span><span class="pun">);</span></li><li class="L5"><span class="kwd">void</span><span class="pln">    printHex   </span><span class="pun">(</span><span class="kwd">const</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> data</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">const</span><span class="pln"> </span><span class="typ">uint32_t</span><span class="pln"> numBytes</span><span class="pun">);</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="com">// Packet buffer</span></li><li class="L8"><span class="kwd">extern</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pln"> packetbuffer</span><span class="pun">[];</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="kwd">void</span><span class="pln"> setup</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">(</span><span class="lit">115200</span><span class="pun">);</span></li><li class="L3"><span class="pln">  </span><span class="kwd">while</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="typ">Serial</span><span class="pln"> </span><span class="pun">)</span><span class="pln"> delay</span><span class="pun">(</span><span class="lit">10</span><span class="pun">);</span><span class="pln">   </span><span class="com">// for nrf52840 with native usb</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="pln">F</span><span class="pun">(</span><span class="str">"Adafruit Bluefruit52 Controller App Example"</span><span class="pun">));</span></li><li class="L6"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="pln">F</span><span class="pun">(</span><span class="str">"-------------------------------------------"</span><span class="pun">));</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L9"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="pln">setTxPower</span><span class="pun">(</span><span class="lit">4</span><span class="pun">);</span><span class="pln">    </span><span class="com">// Check bluefruit.h for supported values</span></li><li class="L0"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="pln">setName</span><span class="pun">(</span><span class="str">"Bluefruit52"</span><span class="pun">);</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="pln">  </span><span class="com">// To be consistent OTA DFU should be added first if it exists</span></li><li class="L3"><span class="pln">  bledfu</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">  </span><span class="com">// Configure and start the BLE Uart service</span></li><li class="L6"><span class="pln">  bleuart</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">  </span><span class="com">// Set up and start advertising</span></li><li class="L9"><span class="pln">  startAdv</span><span class="pun">();</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="pln">F</span><span class="pun">(</span><span class="str">"Please use Adafruit Bluefruit LE app to connect in Controller mode"</span><span class="pun">));</span></li><li class="L2"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="pln">F</span><span class="pun">(</span><span class="str">"Then activate/use the sensors, color picker, game controller, etc!"</span><span class="pun">));</span></li><li class="L3"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">();</span><span class="pln">  </span></li><li class="L4"><span class="pun">}</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="kwd">void</span><span class="pln"> startAdv</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span></li><li class="L7"><span class="pun">{</span></li><li class="L8"><span class="pln">  </span><span class="com">// Advertising packet</span></li><li class="L9"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">addFlags</span><span class="pun">(</span><span class="pln">BLE_GAP_ADV_FLAGS_LE_ONLY_GENERAL_DISC_MODE</span><span class="pun">);</span></li><li class="L0"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">addTxPower</span><span class="pun">();</span></li><li class="L1"><span class="pln">  </span></li><li class="L2"><span class="pln">  </span><span class="com">// Include the BLE UART (AKA 'NUS') 128-bit UUID</span></li><li class="L3"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">addService</span><span class="pun">(</span><span class="pln">bleuart</span><span class="pun">);</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">  </span><span class="com">// Secondary Scan Response packet (optional)</span></li><li class="L6"><span class="pln">  </span><span class="com">// Since there is no room for 'Name' in Advertising packet</span></li><li class="L7"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">ScanResponse</span><span class="pun">.</span><span class="pln">addName</span><span class="pun">();</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="pln">  </span><span class="com">/* Start Advertising</span></li><li class="L0"><span class="com">   * - Enable auto advertising if disconnected</span></li><li class="L1"><span class="com">   * - Interval:  fast mode = 20 ms, slow mode = 152.5 ms</span></li><li class="L2"><span class="com">   * - Timeout for fast mode is 30 seconds</span></li><li class="L3"><span class="com">   * - Start(timeout) with timeout = 0 will advertise forever (until connected)</span></li><li class="L4"><span class="com">   * </span></li><li class="L5"><span class="com">   * For recommended advertising interval</span></li><li class="L6"><span class="com">   * https://developer.apple.com/library/content/qa/qa1931/_index.html   </span></li><li class="L7"><span class="com">   */</span></li><li class="L8"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">restartOnDisconnect</span><span class="pun">(</span><span class="kwd">true</span><span class="pun">);</span></li><li class="L9"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">setInterval</span><span class="pun">(</span><span class="lit">32</span><span class="pun">,</span><span class="pln"> </span><span class="lit">244</span><span class="pun">);</span><span class="pln">    </span><span class="com">// in unit of 0.625 ms</span></li><li class="L0"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">setFastTimeout</span><span class="pun">(</span><span class="lit">30</span><span class="pun">);</span><span class="pln">      </span><span class="com">// number of seconds in fast mode</span></li><li class="L1"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">start</span><span class="pun">(</span><span class="lit">0</span><span class="pun">);</span><span class="pln">                </span><span class="com">// 0 = Don't stop advertising after n seconds  </span></li><li class="L2"><span class="pun">}</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="com">/**************************************************************************/</span></li><li class="L5"><span class="com">/*!</span></li><li class="L6"><span class="com">    @brief  Constantly poll for new command or response data</span></li><li class="L7"><span class="com">*/</span></li><li class="L8"><span class="com">/**************************************************************************/</span></li><li class="L9"><span class="kwd">void</span><span class="pln"> loop</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span></li><li class="L0"><span class="pun">{</span></li><li class="L1"><span class="pln">  </span><span class="com">// Wait for new data to arrive</span></li><li class="L2"><span class="pln">  </span><span class="typ">uint8_t</span><span class="pln"> len </span><span class="pun">=</span><span class="pln"> readPacket</span><span class="pun">(&amp;</span><span class="pln">bleuart</span><span class="pun">,</span><span class="pln"> </span><span class="lit">500</span><span class="pun">);</span></li><li class="L3"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">len </span><span class="pun">==</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">return</span><span class="pun">;</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">  </span><span class="com">// Got a packet!</span></li><li class="L6"><span class="pln">  </span><span class="com">// printHex(packetbuffer, len);</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">  </span><span class="com">// Color</span></li><li class="L9"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">packetbuffer</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="str">'C'</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L0"><span class="pln">    </span><span class="typ">uint8_t</span><span class="pln"> red </span><span class="pun">=</span><span class="pln"> packetbuffer</span><span class="pun">[</span><span class="lit">2</span><span class="pun">];</span></li><li class="L1"><span class="pln">    </span><span class="typ">uint8_t</span><span class="pln"> green </span><span class="pun">=</span><span class="pln"> packetbuffer</span><span class="pun">[</span><span class="lit">3</span><span class="pun">];</span></li><li class="L2"><span class="pln">    </span><span class="typ">uint8_t</span><span class="pln"> blue </span><span class="pun">=</span><span class="pln"> packetbuffer</span><span class="pun">[</span><span class="lit">4</span><span class="pun">];</span></li><li class="L3"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pln"> </span><span class="pun">(</span><span class="str">"RGB #"</span><span class="pun">);</span></li><li class="L4"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">red </span><span class="pun">&lt;</span><span class="pln"> </span><span class="lit">0x10</span><span class="pun">)</span><span class="pln"> </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"0"</span><span class="pun">);</span></li><li class="L5"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="pln">red</span><span class="pun">,</span><span class="pln"> HEX</span><span class="pun">);</span></li><li class="L6"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">green </span><span class="pun">&lt;</span><span class="pln"> </span><span class="lit">0x10</span><span class="pun">)</span><span class="pln"> </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"0"</span><span class="pun">);</span></li><li class="L7"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="pln">green</span><span class="pun">,</span><span class="pln"> HEX</span><span class="pun">);</span></li><li class="L8"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">blue </span><span class="pun">&lt;</span><span class="pln"> </span><span class="lit">0x10</span><span class="pun">)</span><span class="pln"> </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"0"</span><span class="pun">);</span></li><li class="L9"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="pln">blue</span><span class="pun">,</span><span class="pln"> HEX</span><span class="pun">);</span></li><li class="L0"><span class="pln">  </span><span class="pun">}</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="pln">  </span><span class="com">// Buttons</span></li><li class="L3"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">packetbuffer</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="str">'B'</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L4"><span class="pln">    </span><span class="typ">uint8_t</span><span class="pln"> buttnum </span><span class="pun">=</span><span class="pln"> packetbuffer</span><span class="pun">[</span><span class="lit">2</span><span class="pun">]</span><span class="pln"> </span><span class="pun">-</span><span class="pln"> </span><span class="str">'0'</span><span class="pun">;</span></li><li class="L5"><span class="pln">    </span><span class="kwd">boolean</span><span class="pln"> pressed </span><span class="pun">=</span><span class="pln"> packetbuffer</span><span class="pun">[</span><span class="lit">3</span><span class="pun">]</span><span class="pln"> </span><span class="pun">-</span><span class="pln"> </span><span class="str">'0'</span><span class="pun">;</span></li><li class="L6"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pln"> </span><span class="pun">(</span><span class="str">"Button "</span><span class="pun">);</span><span class="pln"> </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="pln">buttnum</span><span class="pun">);</span></li><li class="L7"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">pressed</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L8"><span class="pln">      </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">" pressed"</span><span class="pun">);</span></li><li class="L9"><span class="pln">    </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span></li><li class="L0"><span class="pln">      </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">" released"</span><span class="pun">);</span></li><li class="L1"><span class="pln">    </span><span class="pun">}</span></li><li class="L2"><span class="pln">  </span><span class="pun">}</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln">  </span><span class="com">// GPS Location</span></li><li class="L5"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">packetbuffer</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="str">'L'</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L6"><span class="pln">    </span><span class="kwd">float</span><span class="pln"> lat</span><span class="pun">,</span><span class="pln"> lon</span><span class="pun">,</span><span class="pln"> alt</span><span class="pun">;</span></li><li class="L7"><span class="pln">    lat </span><span class="pun">=</span><span class="pln"> parsefloat</span><span class="pun">(</span><span class="pln">packetbuffer</span><span class="pun">+</span><span class="lit">2</span><span class="pun">);</span></li><li class="L8"><span class="pln">    lon </span><span class="pun">=</span><span class="pln"> parsefloat</span><span class="pun">(</span><span class="pln">packetbuffer</span><span class="pun">+</span><span class="lit">6</span><span class="pun">);</span></li><li class="L9"><span class="pln">    alt </span><span class="pun">=</span><span class="pln"> parsefloat</span><span class="pun">(</span><span class="pln">packetbuffer</span><span class="pun">+</span><span class="lit">10</span><span class="pun">);</span></li><li class="L0"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"GPS Location\t"</span><span class="pun">);</span></li><li class="L1"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"Lat: "</span><span class="pun">);</span><span class="pln"> </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="pln">lat</span><span class="pun">,</span><span class="pln"> </span><span class="lit">4</span><span class="pun">);</span><span class="pln"> </span><span class="com">// 4 digits of precision!</span></li><li class="L2"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">'\t'</span><span class="pun">);</span></li><li class="L3"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"Lon: "</span><span class="pun">);</span><span class="pln"> </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="pln">lon</span><span class="pun">,</span><span class="pln"> </span><span class="lit">4</span><span class="pun">);</span><span class="pln"> </span><span class="com">// 4 digits of precision!</span></li><li class="L4"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">'\t'</span><span class="pun">);</span></li><li class="L5"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="pln">alt</span><span class="pun">,</span><span class="pln"> </span><span class="lit">4</span><span class="pun">);</span><span class="pln"> </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">" meters"</span><span class="pun">);</span></li><li class="L6"><span class="pln">  </span><span class="pun">}</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">  </span><span class="com">// Accelerometer</span></li><li class="L9"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">packetbuffer</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="str">'A'</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L0"><span class="pln">    </span><span class="kwd">float</span><span class="pln"> x</span><span class="pun">,</span><span class="pln"> y</span><span class="pun">,</span><span class="pln"> z</span><span class="pun">;</span></li><li class="L1"><span class="pln">    x </span><span class="pun">=</span><span class="pln"> parsefloat</span><span class="pun">(</span><span class="pln">packetbuffer</span><span class="pun">+</span><span class="lit">2</span><span class="pun">);</span></li><li class="L2"><span class="pln">    y </span><span class="pun">=</span><span class="pln"> parsefloat</span><span class="pun">(</span><span class="pln">packetbuffer</span><span class="pun">+</span><span class="lit">6</span><span class="pun">);</span></li><li class="L3"><span class="pln">    z </span><span class="pun">=</span><span class="pln"> parsefloat</span><span class="pun">(</span><span class="pln">packetbuffer</span><span class="pun">+</span><span class="lit">10</span><span class="pun">);</span></li><li class="L4"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"Accel\t"</span><span class="pun">);</span></li><li class="L5"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="pln">x</span><span class="pun">);</span><span class="pln"> </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">'\t'</span><span class="pun">);</span></li><li class="L6"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="pln">y</span><span class="pun">);</span><span class="pln"> </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">'\t'</span><span class="pun">);</span></li><li class="L7"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="pln">z</span><span class="pun">);</span><span class="pln"> </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">();</span></li><li class="L8"><span class="pln">  </span><span class="pun">}</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="pln">  </span><span class="com">// Magnetometer</span></li><li class="L1"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">packetbuffer</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="str">'M'</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L2"><span class="pln">    </span><span class="kwd">float</span><span class="pln"> x</span><span class="pun">,</span><span class="pln"> y</span><span class="pun">,</span><span class="pln"> z</span><span class="pun">;</span></li><li class="L3"><span class="pln">    x </span><span class="pun">=</span><span class="pln"> parsefloat</span><span class="pun">(</span><span class="pln">packetbuffer</span><span class="pun">+</span><span class="lit">2</span><span class="pun">);</span></li><li class="L4"><span class="pln">    y </span><span class="pun">=</span><span class="pln"> parsefloat</span><span class="pun">(</span><span class="pln">packetbuffer</span><span class="pun">+</span><span class="lit">6</span><span class="pun">);</span></li><li class="L5"><span class="pln">    z </span><span class="pun">=</span><span class="pln"> parsefloat</span><span class="pun">(</span><span class="pln">packetbuffer</span><span class="pun">+</span><span class="lit">10</span><span class="pun">);</span></li><li class="L6"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"Mag\t"</span><span class="pun">);</span></li><li class="L7"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="pln">x</span><span class="pun">);</span><span class="pln"> </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">'\t'</span><span class="pun">);</span></li><li class="L8"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="pln">y</span><span class="pun">);</span><span class="pln"> </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">'\t'</span><span class="pun">);</span></li><li class="L9"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="pln">z</span><span class="pun">);</span><span class="pln"> </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">();</span></li><li class="L0"><span class="pln">  </span><span class="pun">}</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="pln">  </span><span class="com">// Gyroscope</span></li><li class="L3"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">packetbuffer</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="str">'G'</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L4"><span class="pln">    </span><span class="kwd">float</span><span class="pln"> x</span><span class="pun">,</span><span class="pln"> y</span><span class="pun">,</span><span class="pln"> z</span><span class="pun">;</span></li><li class="L5"><span class="pln">    x </span><span class="pun">=</span><span class="pln"> parsefloat</span><span class="pun">(</span><span class="pln">packetbuffer</span><span class="pun">+</span><span class="lit">2</span><span class="pun">);</span></li><li class="L6"><span class="pln">    y </span><span class="pun">=</span><span class="pln"> parsefloat</span><span class="pun">(</span><span class="pln">packetbuffer</span><span class="pun">+</span><span class="lit">6</span><span class="pun">);</span></li><li class="L7"><span class="pln">    z </span><span class="pun">=</span><span class="pln"> parsefloat</span><span class="pun">(</span><span class="pln">packetbuffer</span><span class="pun">+</span><span class="lit">10</span><span class="pun">);</span></li><li class="L8"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"Gyro\t"</span><span class="pun">);</span></li><li class="L9"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="pln">x</span><span class="pun">);</span><span class="pln"> </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">'\t'</span><span class="pun">);</span></li><li class="L0"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="pln">y</span><span class="pun">);</span><span class="pln"> </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">'\t'</span><span class="pun">);</span></li><li class="L1"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="pln">z</span><span class="pun">);</span><span class="pln"> </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">();</span></li><li class="L2"><span class="pln">  </span><span class="pun">}</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln">  </span><span class="com">// Quaternions</span></li><li class="L5"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">packetbuffer</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="str">'Q'</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L6"><span class="pln">    </span><span class="kwd">float</span><span class="pln"> x</span><span class="pun">,</span><span class="pln"> y</span><span class="pun">,</span><span class="pln"> z</span><span class="pun">,</span><span class="pln"> w</span><span class="pun">;</span></li><li class="L7"><span class="pln">    x </span><span class="pun">=</span><span class="pln"> parsefloat</span><span class="pun">(</span><span class="pln">packetbuffer</span><span class="pun">+</span><span class="lit">2</span><span class="pun">);</span></li><li class="L8"><span class="pln">    y </span><span class="pun">=</span><span class="pln"> parsefloat</span><span class="pun">(</span><span class="pln">packetbuffer</span><span class="pun">+</span><span class="lit">6</span><span class="pun">);</span></li><li class="L9"><span class="pln">    z </span><span class="pun">=</span><span class="pln"> parsefloat</span><span class="pun">(</span><span class="pln">packetbuffer</span><span class="pun">+</span><span class="lit">10</span><span class="pun">);</span></li><li class="L0"><span class="pln">    w </span><span class="pun">=</span><span class="pln"> parsefloat</span><span class="pun">(</span><span class="pln">packetbuffer</span><span class="pun">+</span><span class="lit">14</span><span class="pun">);</span></li><li class="L1"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"Quat\t"</span><span class="pun">);</span></li><li class="L2"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="pln">x</span><span class="pun">);</span><span class="pln"> </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">'\t'</span><span class="pun">);</span></li><li class="L3"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="pln">y</span><span class="pun">);</span><span class="pln"> </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">'\t'</span><span class="pun">);</span></li><li class="L4"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="pln">z</span><span class="pun">);</span><span class="pln"> </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">'\t'</span><span class="pun">);</span></li><li class="L5"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="pln">w</span><span class="pun">);</span><span class="pln"> </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">();</span></li><li class="L6"><span class="pln">  </span><span class="pun">}</span></li><li class="L7"><span class="pun">}</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<p>You will also need the following helper class in a file called&nbsp;<strong>packetParser.cpp</strong>:</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/9037/elements/3014337/download?type=zip">
Project Zip
</a> <span class="divider">or</span>
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/9037/elements/3014337/download">
packetParser.cpp
</a> <span class="divider visible-lg-inline">|</span>
<a target="_blank" class="visible-lg-inline" href="https://github.com/adafruit/Adafruit_nRF52_Arduino/blob/master/libraries/Bluefruit52Lib/examples/Peripheral/controller/packetParser.cpp">
<i class="fa fa-github"></i>
View on Github
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">#include &lt;string.h&gt;
#include &lt;Arduino.h&gt;
#include &lt;bluefruit.h&gt;


#define PACKET_ACC_LEN                  (15)
#define PACKET_GYRO_LEN                 (15)
#define PACKET_MAG_LEN                  (15)
#define PACKET_QUAT_LEN                 (19)
#define PACKET_BUTTON_LEN               (5)
#define PACKET_COLOR_LEN                (6)
#define PACKET_LOCATION_LEN             (15)

//    READ_BUFSIZE            Size of the read buffer for incoming packets
#define READ_BUFSIZE                    (20)


/* Buffer to hold incoming characters */
uint8_t packetbuffer[READ_BUFSIZE+1];

/**************************************************************************/
/*!
    @brief  Casts the four bytes at the specified address to a float
*/
/**************************************************************************/
float parsefloat(uint8_t *buffer) 
{
  float f;
  memcpy(&amp;f, buffer, 4);
  return f;
}

/**************************************************************************/
/*! 
    @brief  Prints a hexadecimal value in plain characters
    @param  data      Pointer to the byte data
    @param  numBytes  Data length in bytes
*/
/**************************************************************************/
void printHex(const uint8_t * data, const uint32_t numBytes)
{
  uint32_t szPos;
  for (szPos=0; szPos &lt; numBytes; szPos++) 
  {
    Serial.print(F("0x"));
    // Append leading 0 for small values
    if (data[szPos] &lt;= 0xF)
    {
      Serial.print(F("0"));
      Serial.print(data[szPos] &amp; 0xf, HEX);
    }
    else
    {
      Serial.print(data[szPos] &amp; 0xff, HEX);
    }
    // Add a trailing space if appropriate
    if ((numBytes &gt; 1) &amp;&amp; (szPos != numBytes - 1))
    {
      Serial.print(F(" "));
    }
  }
  Serial.println();
}

/**************************************************************************/
/*!
    @brief  Waits for incoming data and parses it
*/
/**************************************************************************/
uint8_t readPacket(BLEUart *ble_uart, uint16_t timeout) 
{
  uint16_t origtimeout = timeout, replyidx = 0;

  memset(packetbuffer, 0, READ_BUFSIZE);

  while (timeout--) {
    if (replyidx &gt;= 20) break;
    if ((packetbuffer[1] == 'A') &amp;&amp; (replyidx == PACKET_ACC_LEN))
      break;
    if ((packetbuffer[1] == 'G') &amp;&amp; (replyidx == PACKET_GYRO_LEN))
      break;
    if ((packetbuffer[1] == 'M') &amp;&amp; (replyidx == PACKET_MAG_LEN))
      break;
    if ((packetbuffer[1] == 'Q') &amp;&amp; (replyidx == PACKET_QUAT_LEN))
      break;
    if ((packetbuffer[1] == 'B') &amp;&amp; (replyidx == PACKET_BUTTON_LEN))
      break;
    if ((packetbuffer[1] == 'C') &amp;&amp; (replyidx == PACKET_COLOR_LEN))
      break;
    if ((packetbuffer[1] == 'L') &amp;&amp; (replyidx == PACKET_LOCATION_LEN))
      break;

    while (ble_uart-&gt;available()) {
      char c =  ble_uart-&gt;read();
      if (c == '!') {
        replyidx = 0;
      }
      packetbuffer[replyidx] = c;
      replyidx++;
      timeout = origtimeout;
    }
    
    if (timeout == 0) break;
    delay(1);
  }

  packetbuffer[replyidx] = 0;  // null term

  if (!replyidx)  // no data or timeout 
    return 0;
  if (packetbuffer[0] != '!')  // doesn't start with '!' packet beginning
    return 0;
  
  // check checksum!
  uint8_t xsum = 0;
  uint8_t checksum = packetbuffer[replyidx-1];
  
  for (uint8_t i=0; i&lt;replyidx-1; i++) {
    xsum += packetbuffer[i];
  }
  xsum = ~xsum;

  // Throw an error message if the checksum's don't match
  if (xsum != checksum)
  {
    Serial.print("Checksum mismatch in packet : ");
    printHex(packetbuffer, replyidx+1);
    return 0;
  }
  
  // checksum passed!
  return replyidx;
}

</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;string.h&gt;</span></li><li class="L1"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;Arduino.h&gt;</span></li><li class="L2"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;bluefruit.h&gt;</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="com">#define</span><span class="pln"> PACKET_ACC_LEN                  </span><span class="pun">(</span><span class="lit">15</span><span class="pun">)</span></li><li class="L6"><span class="com">#define</span><span class="pln"> PACKET_GYRO_LEN                 </span><span class="pun">(</span><span class="lit">15</span><span class="pun">)</span></li><li class="L7"><span class="com">#define</span><span class="pln"> PACKET_MAG_LEN                  </span><span class="pun">(</span><span class="lit">15</span><span class="pun">)</span></li><li class="L8"><span class="com">#define</span><span class="pln"> PACKET_QUAT_LEN                 </span><span class="pun">(</span><span class="lit">19</span><span class="pun">)</span></li><li class="L9"><span class="com">#define</span><span class="pln"> PACKET_BUTTON_LEN               </span><span class="pun">(</span><span class="lit">5</span><span class="pun">)</span></li><li class="L0"><span class="com">#define</span><span class="pln"> PACKET_COLOR_LEN                </span><span class="pun">(</span><span class="lit">6</span><span class="pun">)</span></li><li class="L1"><span class="com">#define</span><span class="pln"> PACKET_LOCATION_LEN             </span><span class="pun">(</span><span class="lit">15</span><span class="pun">)</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="com">//    READ_BUFSIZE            Size of the read buffer for incoming packets</span></li><li class="L4"><span class="com">#define</span><span class="pln"> READ_BUFSIZE                    </span><span class="pun">(</span><span class="lit">20</span><span class="pun">)</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="com">/* Buffer to hold incoming characters */</span></li><li class="L8"><span class="typ">uint8_t</span><span class="pln"> packetbuffer</span><span class="pun">[</span><span class="pln">READ_BUFSIZE</span><span class="pun">+</span><span class="lit">1</span><span class="pun">];</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="com">/**************************************************************************/</span></li><li class="L1"><span class="com">/*!</span></li><li class="L2"><span class="com">    @brief  Casts the four bytes at the specified address to a float</span></li><li class="L3"><span class="com">*/</span></li><li class="L4"><span class="com">/**************************************************************************/</span></li><li class="L5"><span class="kwd">float</span><span class="pln"> parsefloat</span><span class="pun">(</span><span class="typ">uint8_t</span><span class="pln"> </span><span class="pun">*</span><span class="pln">buffer</span><span class="pun">)</span><span class="pln"> </span></li><li class="L6"><span class="pun">{</span></li><li class="L7"><span class="pln">  </span><span class="kwd">float</span><span class="pln"> f</span><span class="pun">;</span></li><li class="L8"><span class="pln">  memcpy</span><span class="pun">(&amp;</span><span class="pln">f</span><span class="pun">,</span><span class="pln"> buffer</span><span class="pun">,</span><span class="pln"> </span><span class="lit">4</span><span class="pun">);</span></li><li class="L9"><span class="pln">  </span><span class="kwd">return</span><span class="pln"> f</span><span class="pun">;</span></li><li class="L0"><span class="pun">}</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="com">/**************************************************************************/</span></li><li class="L3"><span class="com">/*! </span></li><li class="L4"><span class="com">    @brief  Prints a hexadecimal value in plain characters</span></li><li class="L5"><span class="com">    @param  data      Pointer to the byte data</span></li><li class="L6"><span class="com">    @param  numBytes  Data length in bytes</span></li><li class="L7"><span class="com">*/</span></li><li class="L8"><span class="com">/**************************************************************************/</span></li><li class="L9"><span class="kwd">void</span><span class="pln"> printHex</span><span class="pun">(</span><span class="kwd">const</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> data</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">const</span><span class="pln"> </span><span class="typ">uint32_t</span><span class="pln"> numBytes</span><span class="pun">)</span></li><li class="L0"><span class="pun">{</span></li><li class="L1"><span class="pln">  </span><span class="typ">uint32_t</span><span class="pln"> szPos</span><span class="pun">;</span></li><li class="L2"><span class="pln">  </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="pln">szPos</span><span class="pun">=</span><span class="lit">0</span><span class="pun">;</span><span class="pln"> szPos </span><span class="pun">&lt;</span><span class="pln"> numBytes</span><span class="pun">;</span><span class="pln"> szPos</span><span class="pun">++)</span><span class="pln"> </span></li><li class="L3"><span class="pln">  </span><span class="pun">{</span></li><li class="L4"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="pln">F</span><span class="pun">(</span><span class="str">"0x"</span><span class="pun">));</span></li><li class="L5"><span class="pln">    </span><span class="com">// Append leading 0 for small values</span></li><li class="L6"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">data</span><span class="pun">[</span><span class="pln">szPos</span><span class="pun">]</span><span class="pln"> </span><span class="pun">&lt;=</span><span class="pln"> </span><span class="lit">0xF</span><span class="pun">)</span></li><li class="L7"><span class="pln">    </span><span class="pun">{</span></li><li class="L8"><span class="pln">      </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="pln">F</span><span class="pun">(</span><span class="str">"0"</span><span class="pun">));</span></li><li class="L9"><span class="pln">      </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="pln">data</span><span class="pun">[</span><span class="pln">szPos</span><span class="pun">]</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln"> </span><span class="lit">0xf</span><span class="pun">,</span><span class="pln"> HEX</span><span class="pun">);</span></li><li class="L0"><span class="pln">    </span><span class="pun">}</span></li><li class="L1"><span class="pln">    </span><span class="kwd">else</span></li><li class="L2"><span class="pln">    </span><span class="pun">{</span></li><li class="L3"><span class="pln">      </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="pln">data</span><span class="pun">[</span><span class="pln">szPos</span><span class="pun">]</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln"> </span><span class="lit">0xff</span><span class="pun">,</span><span class="pln"> HEX</span><span class="pun">);</span></li><li class="L4"><span class="pln">    </span><span class="pun">}</span></li><li class="L5"><span class="pln">    </span><span class="com">// Add a trailing space if appropriate</span></li><li class="L6"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">((</span><span class="pln">numBytes </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">1</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> </span><span class="pun">(</span><span class="pln">szPos </span><span class="pun">!=</span><span class="pln"> numBytes </span><span class="pun">-</span><span class="pln"> </span><span class="lit">1</span><span class="pun">))</span></li><li class="L7"><span class="pln">    </span><span class="pun">{</span></li><li class="L8"><span class="pln">      </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="pln">F</span><span class="pun">(</span><span class="str">" "</span><span class="pun">));</span></li><li class="L9"><span class="pln">    </span><span class="pun">}</span></li><li class="L0"><span class="pln">  </span><span class="pun">}</span></li><li class="L1"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">();</span></li><li class="L2"><span class="pun">}</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="com">/**************************************************************************/</span></li><li class="L5"><span class="com">/*!</span></li><li class="L6"><span class="com">    @brief  Waits for incoming data and parses it</span></li><li class="L7"><span class="com">*/</span></li><li class="L8"><span class="com">/**************************************************************************/</span></li><li class="L9"><span class="typ">uint8_t</span><span class="pln"> readPacket</span><span class="pun">(</span><span class="typ">BLEUart</span><span class="pln"> </span><span class="pun">*</span><span class="pln">ble_uart</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint16_t</span><span class="pln"> timeout</span><span class="pun">)</span><span class="pln"> </span></li><li class="L0"><span class="pun">{</span></li><li class="L1"><span class="pln">  </span><span class="typ">uint16_t</span><span class="pln"> origtimeout </span><span class="pun">=</span><span class="pln"> timeout</span><span class="pun">,</span><span class="pln"> replyidx </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="pln">  memset</span><span class="pun">(</span><span class="pln">packetbuffer</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0</span><span class="pun">,</span><span class="pln"> READ_BUFSIZE</span><span class="pun">);</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">  </span><span class="kwd">while</span><span class="pln"> </span><span class="pun">(</span><span class="pln">timeout</span><span class="pun">--)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L6"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">replyidx </span><span class="pun">&gt;=</span><span class="pln"> </span><span class="lit">20</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">break</span><span class="pun">;</span></li><li class="L7"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">((</span><span class="pln">packetbuffer</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="str">'A'</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> </span><span class="pun">(</span><span class="pln">replyidx </span><span class="pun">==</span><span class="pln"> PACKET_ACC_LEN</span><span class="pun">))</span></li><li class="L8"><span class="pln">      </span><span class="kwd">break</span><span class="pun">;</span></li><li class="L9"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">((</span><span class="pln">packetbuffer</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="str">'G'</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> </span><span class="pun">(</span><span class="pln">replyidx </span><span class="pun">==</span><span class="pln"> PACKET_GYRO_LEN</span><span class="pun">))</span></li><li class="L0"><span class="pln">      </span><span class="kwd">break</span><span class="pun">;</span></li><li class="L1"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">((</span><span class="pln">packetbuffer</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="str">'M'</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> </span><span class="pun">(</span><span class="pln">replyidx </span><span class="pun">==</span><span class="pln"> PACKET_MAG_LEN</span><span class="pun">))</span></li><li class="L2"><span class="pln">      </span><span class="kwd">break</span><span class="pun">;</span></li><li class="L3"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">((</span><span class="pln">packetbuffer</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="str">'Q'</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> </span><span class="pun">(</span><span class="pln">replyidx </span><span class="pun">==</span><span class="pln"> PACKET_QUAT_LEN</span><span class="pun">))</span></li><li class="L4"><span class="pln">      </span><span class="kwd">break</span><span class="pun">;</span></li><li class="L5"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">((</span><span class="pln">packetbuffer</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="str">'B'</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> </span><span class="pun">(</span><span class="pln">replyidx </span><span class="pun">==</span><span class="pln"> PACKET_BUTTON_LEN</span><span class="pun">))</span></li><li class="L6"><span class="pln">      </span><span class="kwd">break</span><span class="pun">;</span></li><li class="L7"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">((</span><span class="pln">packetbuffer</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="str">'C'</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> </span><span class="pun">(</span><span class="pln">replyidx </span><span class="pun">==</span><span class="pln"> PACKET_COLOR_LEN</span><span class="pun">))</span></li><li class="L8"><span class="pln">      </span><span class="kwd">break</span><span class="pun">;</span></li><li class="L9"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">((</span><span class="pln">packetbuffer</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="str">'L'</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> </span><span class="pun">(</span><span class="pln">replyidx </span><span class="pun">==</span><span class="pln"> PACKET_LOCATION_LEN</span><span class="pun">))</span></li><li class="L0"><span class="pln">      </span><span class="kwd">break</span><span class="pun">;</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="pln">    </span><span class="kwd">while</span><span class="pln"> </span><span class="pun">(</span><span class="pln">ble_uart</span><span class="pun">-&gt;</span><span class="pln">available</span><span class="pun">())</span><span class="pln"> </span><span class="pun">{</span></li><li class="L3"><span class="pln">      </span><span class="kwd">char</span><span class="pln"> c </span><span class="pun">=</span><span class="pln">  ble_uart</span><span class="pun">-&gt;</span><span class="pln">read</span><span class="pun">();</span></li><li class="L4"><span class="pln">      </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">c </span><span class="pun">==</span><span class="pln"> </span><span class="str">'!'</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L5"><span class="pln">        replyidx </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></li><li class="L6"><span class="pln">      </span><span class="pun">}</span></li><li class="L7"><span class="pln">      packetbuffer</span><span class="pun">[</span><span class="pln">replyidx</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> c</span><span class="pun">;</span></li><li class="L8"><span class="pln">      replyidx</span><span class="pun">++;</span></li><li class="L9"><span class="pln">      timeout </span><span class="pun">=</span><span class="pln"> origtimeout</span><span class="pun">;</span></li><li class="L0"><span class="pln">    </span><span class="pun">}</span></li><li class="L1"><span class="pln">    </span></li><li class="L2"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">timeout </span><span class="pun">==</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">break</span><span class="pun">;</span></li><li class="L3"><span class="pln">    delay</span><span class="pun">(</span><span class="lit">1</span><span class="pun">);</span></li><li class="L4"><span class="pln">  </span><span class="pun">}</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">  packetbuffer</span><span class="pun">[</span><span class="pln">replyidx</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span><span class="pln">  </span><span class="com">// null term</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(!</span><span class="pln">replyidx</span><span class="pun">)</span><span class="pln">  </span><span class="com">// no data or timeout </span></li><li class="L9"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></li><li class="L0"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">packetbuffer</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]</span><span class="pln"> </span><span class="pun">!=</span><span class="pln"> </span><span class="str">'!'</span><span class="pun">)</span><span class="pln">  </span><span class="com">// doesn't start with '!' packet beginning</span></li><li class="L1"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></li><li class="L2"><span class="pln">  </span></li><li class="L3"><span class="pln">  </span><span class="com">// check checksum!</span></li><li class="L4"><span class="pln">  </span><span class="typ">uint8_t</span><span class="pln"> xsum </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></li><li class="L5"><span class="pln">  </span><span class="typ">uint8_t</span><span class="pln"> checksum </span><span class="pun">=</span><span class="pln"> packetbuffer</span><span class="pun">[</span><span class="pln">replyidx</span><span class="pun">-</span><span class="lit">1</span><span class="pun">];</span></li><li class="L6"><span class="pln">  </span></li><li class="L7"><span class="pln">  </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="typ">uint8_t</span><span class="pln"> i</span><span class="pun">=</span><span class="lit">0</span><span class="pun">;</span><span class="pln"> i</span><span class="pun">&lt;</span><span class="pln">replyidx</span><span class="pun">-</span><span class="lit">1</span><span class="pun">;</span><span class="pln"> i</span><span class="pun">++)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L8"><span class="pln">    xsum </span><span class="pun">+=</span><span class="pln"> packetbuffer</span><span class="pun">[</span><span class="pln">i</span><span class="pun">];</span></li><li class="L9"><span class="pln">  </span><span class="pun">}</span></li><li class="L0"><span class="pln">  xsum </span><span class="pun">=</span><span class="pln"> </span><span class="pun">~</span><span class="pln">xsum</span><span class="pun">;</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="pln">  </span><span class="com">// Throw an error message if the checksum's don't match</span></li><li class="L3"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">xsum </span><span class="pun">!=</span><span class="pln"> checksum</span><span class="pun">)</span></li><li class="L4"><span class="pln">  </span><span class="pun">{</span></li><li class="L5"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"Checksum mismatch in packet : "</span><span class="pun">);</span></li><li class="L6"><span class="pln">    printHex</span><span class="pun">(</span><span class="pln">packetbuffer</span><span class="pun">,</span><span class="pln"> replyidx</span><span class="pun">+</span><span class="lit">1</span><span class="pun">);</span></li><li class="L7"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></li><li class="L8"><span class="pln">  </span><span class="pun">}</span></li><li class="L9"><span class="pln">  </span></li><li class="L0"><span class="pln">  </span><span class="com">// checksum passed!</span></li><li class="L1"><span class="pln">  </span><span class="kwd">return</span><span class="pln"> replyidx</span><span class="pun">;</span></li><li class="L2"><span class="pun">}</span></li><li class="L3"><span class="pln">&nbsp;</span></li></ol></pre>
</div>
</div>
</div>
<div class="page-title-wrapper">
<h1 class="headline">
<span id="custom-hrm">Custom: HRM</span>
</h1>
<div class="author">by
<a href="./nRF52_bluefruit_Learning_Guide.html#custom-hrm">
<span class="name">Kevin Townsend</span>
</a> </div>
</div>
<div class="page-content all-page-view-content">
<div class="">
<div class="row-fluid build-text">
<p>The BLEService and BLECharacteristic classes can be used to implement any custom or officially adopted BLE service of characteristic using a set of basic properties and callback handlers.</p>
<p>The example below shows how to use these classes to implement the <a href="https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.service.heart_rate.xml" target="_blank">Heart Rate Monitor</a> service, as defined by the Bluetooth SIG.</p>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#hrm-service-definition-13-2" class="anchor-link"><span class="fa fa-link"></span></a><span id="hrm-service-definition-13-2" class="anchor-link-target"></span><span id="hrm-service-definition" class="anchor-link-target"></span>HRM Service Definition</h1>
<p><strong>UUID</strong>: <a href="https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.service.heart_rate.xml" target="_blank">0x180D</a></p>

</div>
<div class="editor-table-container">
<table class="editor-table"><tbody><tr>
<td><p><strong>Characteristic Name</strong><br><a href="https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.characteristic.heart_rate_measurement.xml" target="_blank">Heart Rate Measurement</a><br><a href="https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.characteristic.body_sensor_location.xml" target="_blank">Body Sensor Location</a><br><a href="https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.characteristic.heart_rate_control_point.xml" target="_blank">Heart Rate Control Point</a></p></td>
<td><p><strong>UUID</strong><br>0x2A37<br>0x2A38<br>0x2A39</p></td>
<td><p><strong>Requirement</strong><br>Mandatory<br>Optional<br>Conditional</p></td>
<td><p><strong>Properties</strong><br>Notify<br>Read<br>Write</p></td>
</tr></tbody></table>
</div>
<div class="row-fluid build-text">
<p>Only the first characteristic is mandatory, but we will also implement the optional&nbsp;<strong>Body Sensor Location</strong> characteristic. Heart Rate Control Point won't be used in this example to keep things simple.</p>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#implementing-the-hrm-service-and-characteristics-13-5" class="anchor-link"><span class="fa fa-link"></span></a><span id="implementing-the-hrm-service-and-characteristics-13-5" class="anchor-link-target"></span><span id="implementing-the-hrm-service-and-characteristics" class="anchor-link-target"></span>Implementing the HRM Service and Characteristics</h1>
<p>The core service and the first two characteristics can be implemented with the following code:</p>
<p>First, define the BLEService and BLECharacteristic variables that will be used in your project:</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/9027/elements/2860673/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">/* HRM Service Definitions
 * Heart Rate Monitor Service:  0x180D
 * Heart Rate Measurement Char: 0x2A37
 * Body Sensor Location Char:   0x2A38
 */
BLEService        hrms = BLEService(UUID16_SVC_HEART_RATE);
BLECharacteristic hrmc = BLECharacteristic(UUID16_CHR_HEART_RATE_MEASUREMENT);
BLECharacteristic bslc = BLECharacteristic(UUID16_CHR_BODY_SENSOR_LOCATION);</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="com">/* HRM Service Definitions</span></li><li class="L1"><span class="com"> * Heart Rate Monitor Service:  0x180D</span></li><li class="L2"><span class="com"> * Heart Rate Measurement Char: 0x2A37</span></li><li class="L3"><span class="com"> * Body Sensor Location Char:   0x2A38</span></li><li class="L4"><span class="com"> */</span></li><li class="L5"><span class="typ">BLEService</span><span class="pln">        hrms </span><span class="pun">=</span><span class="pln"> </span><span class="typ">BLEService</span><span class="pun">(</span><span class="pln">UUID16_SVC_HEART_RATE</span><span class="pun">);</span></li><li class="L6"><span class="typ">BLECharacteristic</span><span class="pln"> hrmc </span><span class="pun">=</span><span class="pln"> </span><span class="typ">BLECharacteristic</span><span class="pun">(</span><span class="pln">UUID16_CHR_HEART_RATE_MEASUREMENT</span><span class="pun">);</span></li><li class="L7"><span class="typ">BLECharacteristic</span><span class="pln"> bslc </span><span class="pun">=</span><span class="pln"> </span><span class="typ">BLECharacteristic</span><span class="pun">(</span><span class="pln">UUID16_CHR_BODY_SENSOR_LOCATION</span><span class="pun">);</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<p>Then you need to 'populate' those variables with appropriate values. For simplicity sake, you can define a custom function for your service where all of the code is placed, and then just call this function once in the 'setup' function:</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/9027/elements/2860675/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">void setupHRM(void)
{
  // Configure the Heart Rate Monitor service
  // See: https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.service.heart_rate.xml
  // Supported Characteristics:
  // Name                         UUID    Requirement Properties
  // ---------------------------- ------  ----------- ----------
  // Heart Rate Measurement       0x2A37  Mandatory   Notify
  // Body Sensor Location         0x2A38  Optional    Read
  // Heart Rate Control Point     0x2A39  Conditional Write       &lt;-- Not used here
  hrms.begin();

  // Note: You must call .begin() on the BLEService before calling .begin() on
  // any characteristic(s) within that service definition.. Calling .begin() on
  // a BLECharacteristic will cause it to be added to the last BLEService that
  // was 'begin()'ed!

  // Configure the Heart Rate Measurement characteristic
  // See: https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.characteristic.heart_rate_measurement.xml
  // Permission = Notify
  // Min Len    = 1
  // Max Len    = 8
  //    B0      = UINT8  - Flag (MANDATORY)
  //      b5:7  = Reserved
  //      b4    = RR-Internal (0 = Not present, 1 = Present)
  //      b3    = Energy expended status (0 = Not present, 1 = Present)
  //      b1:2  = Sensor contact status (0+1 = Not supported, 2 = Supported but contact not detected, 3 = Supported and detected)
  //      b0    = Value format (0 = UINT8, 1 = UINT16)
  //    B1      = UINT8  - 8-bit heart rate measurement value in BPM
  //    B2:3    = UINT16 - 16-bit heart rate measurement value in BPM
  //    B4:5    = UINT16 - Energy expended in joules
  //    B6:7    = UINT16 - RR Internal (1/1024 second resolution)
  hrmc.setProperties(CHR_PROPS_NOTIFY);
  hrmc.setPermission(SECMODE_OPEN, SECMODE_NO_ACCESS);
  hrmc.setFixedLen(2);
  hrmc.setCccdWriteCallback(cccd_callback);  // Optionally capture CCCD updates
  hrmc.begin();
  uint8_t hrmdata[2] = { 0b00000110, 0x40 }; // Set the characteristic to use 8-bit values, with the sensor connected and detected
  hrmc.notify(hrmdata, 2);                   // Use .notify instead of .write!

  // Configure the Body Sensor Location characteristic
  // See: https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.characteristic.body_sensor_location.xml
  // Permission = Read
  // Min Len    = 1
  // Max Len    = 1
  //    B0      = UINT8 - Body Sensor Location
  //      0     = Other
  //      1     = Chest
  //      2     = Wrist
  //      3     = Finger
  //      4     = Hand
  //      5     = Ear Lobe
  //      6     = Foot
  //      7:255 = Reserved
  bslc.setProperties(CHR_PROPS_READ);
  bslc.setPermission(SECMODE_OPEN, SECMODE_NO_ACCESS);
  bslc.setFixedLen(1);
  bslc.begin();
  bslc.write8(2);    // Set the characteristic to 'Wrist' (2)
}</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="kwd">void</span><span class="pln"> setupHRM</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="pln">  </span><span class="com">// Configure the Heart Rate Monitor service</span></li><li class="L3"><span class="pln">  </span><span class="com">// See: https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.service.heart_rate.xml</span></li><li class="L4"><span class="pln">  </span><span class="com">// Supported Characteristics:</span></li><li class="L5"><span class="pln">  </span><span class="com">// Name                         UUID    Requirement Properties</span></li><li class="L6"><span class="pln">  </span><span class="com">// ---------------------------- ------  ----------- ----------</span></li><li class="L7"><span class="pln">  </span><span class="com">// Heart Rate Measurement       0x2A37  Mandatory   Notify</span></li><li class="L8"><span class="pln">  </span><span class="com">// Body Sensor Location         0x2A38  Optional    Read</span></li><li class="L9"><span class="pln">  </span><span class="com">// Heart Rate Control Point     0x2A39  Conditional Write       &lt;-- Not used here</span></li><li class="L0"><span class="pln">  hrms</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="pln">  </span><span class="com">// Note: You must call .begin() on the BLEService before calling .begin() on</span></li><li class="L3"><span class="pln">  </span><span class="com">// any characteristic(s) within that service definition.. Calling .begin() on</span></li><li class="L4"><span class="pln">  </span><span class="com">// a BLECharacteristic will cause it to be added to the last BLEService that</span></li><li class="L5"><span class="pln">  </span><span class="com">// was 'begin()'ed!</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="pln">  </span><span class="com">// Configure the Heart Rate Measurement characteristic</span></li><li class="L8"><span class="pln">  </span><span class="com">// See: https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.characteristic.heart_rate_measurement.xml</span></li><li class="L9"><span class="pln">  </span><span class="com">// Permission = Notify</span></li><li class="L0"><span class="pln">  </span><span class="com">// Min Len    = 1</span></li><li class="L1"><span class="pln">  </span><span class="com">// Max Len    = 8</span></li><li class="L2"><span class="pln">  </span><span class="com">//    B0      = UINT8  - Flag (MANDATORY)</span></li><li class="L3"><span class="pln">  </span><span class="com">//      b5:7  = Reserved</span></li><li class="L4"><span class="pln">  </span><span class="com">//      b4    = RR-Internal (0 = Not present, 1 = Present)</span></li><li class="L5"><span class="pln">  </span><span class="com">//      b3    = Energy expended status (0 = Not present, 1 = Present)</span></li><li class="L6"><span class="pln">  </span><span class="com">//      b1:2  = Sensor contact status (0+1 = Not supported, 2 = Supported but contact not detected, 3 = Supported and detected)</span></li><li class="L7"><span class="pln">  </span><span class="com">//      b0    = Value format (0 = UINT8, 1 = UINT16)</span></li><li class="L8"><span class="pln">  </span><span class="com">//    B1      = UINT8  - 8-bit heart rate measurement value in BPM</span></li><li class="L9"><span class="pln">  </span><span class="com">//    B2:3    = UINT16 - 16-bit heart rate measurement value in BPM</span></li><li class="L0"><span class="pln">  </span><span class="com">//    B4:5    = UINT16 - Energy expended in joules</span></li><li class="L1"><span class="pln">  </span><span class="com">//    B6:7    = UINT16 - RR Internal (1/1024 second resolution)</span></li><li class="L2"><span class="pln">  hrmc</span><span class="pun">.</span><span class="pln">setProperties</span><span class="pun">(</span><span class="pln">CHR_PROPS_NOTIFY</span><span class="pun">);</span></li><li class="L3"><span class="pln">  hrmc</span><span class="pun">.</span><span class="pln">setPermission</span><span class="pun">(</span><span class="pln">SECMODE_OPEN</span><span class="pun">,</span><span class="pln"> SECMODE_NO_ACCESS</span><span class="pun">);</span></li><li class="L4"><span class="pln">  hrmc</span><span class="pun">.</span><span class="pln">setFixedLen</span><span class="pun">(</span><span class="lit">2</span><span class="pun">);</span></li><li class="L5"><span class="pln">  hrmc</span><span class="pun">.</span><span class="pln">setCccdWriteCallback</span><span class="pun">(</span><span class="pln">cccd_callback</span><span class="pun">);</span><span class="pln">  </span><span class="com">// Optionally capture CCCD updates</span></li><li class="L6"><span class="pln">  hrmc</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L7"><span class="pln">  </span><span class="typ">uint8_t</span><span class="pln"> hrmdata</span><span class="pun">[</span><span class="lit">2</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="lit">0b00000110</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x40</span><span class="pln"> </span><span class="pun">};</span><span class="pln"> </span><span class="com">// Set the characteristic to use 8-bit values, with the sensor connected and detected</span></li><li class="L8"><span class="pln">  hrmc</span><span class="pun">.</span><span class="pln">notify</span><span class="pun">(</span><span class="pln">hrmdata</span><span class="pun">,</span><span class="pln"> </span><span class="lit">2</span><span class="pun">);</span><span class="pln">                   </span><span class="com">// Use .notify instead of .write!</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="pln">  </span><span class="com">// Configure the Body Sensor Location characteristic</span></li><li class="L1"><span class="pln">  </span><span class="com">// See: https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.characteristic.body_sensor_location.xml</span></li><li class="L2"><span class="pln">  </span><span class="com">// Permission = Read</span></li><li class="L3"><span class="pln">  </span><span class="com">// Min Len    = 1</span></li><li class="L4"><span class="pln">  </span><span class="com">// Max Len    = 1</span></li><li class="L5"><span class="pln">  </span><span class="com">//    B0      = UINT8 - Body Sensor Location</span></li><li class="L6"><span class="pln">  </span><span class="com">//      0     = Other</span></li><li class="L7"><span class="pln">  </span><span class="com">//      1     = Chest</span></li><li class="L8"><span class="pln">  </span><span class="com">//      2     = Wrist</span></li><li class="L9"><span class="pln">  </span><span class="com">//      3     = Finger</span></li><li class="L0"><span class="pln">  </span><span class="com">//      4     = Hand</span></li><li class="L1"><span class="pln">  </span><span class="com">//      5     = Ear Lobe</span></li><li class="L2"><span class="pln">  </span><span class="com">//      6     = Foot</span></li><li class="L3"><span class="pln">  </span><span class="com">//      7:255 = Reserved</span></li><li class="L4"><span class="pln">  bslc</span><span class="pun">.</span><span class="pln">setProperties</span><span class="pun">(</span><span class="pln">CHR_PROPS_READ</span><span class="pun">);</span></li><li class="L5"><span class="pln">  bslc</span><span class="pun">.</span><span class="pln">setPermission</span><span class="pun">(</span><span class="pln">SECMODE_OPEN</span><span class="pun">,</span><span class="pln"> SECMODE_NO_ACCESS</span><span class="pun">);</span></li><li class="L6"><span class="pln">  bslc</span><span class="pun">.</span><span class="pln">setFixedLen</span><span class="pun">(</span><span class="lit">1</span><span class="pun">);</span></li><li class="L7"><span class="pln">  bslc</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L8"><span class="pln">  bslc</span><span class="pun">.</span><span class="pln">write8</span><span class="pun">(</span><span class="lit">2</span><span class="pun">);</span><span class="pln">    </span><span class="com">// Set the characteristic to 'Wrist' (2)</span></li><li class="L9"><span class="pun">}</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<h2>
<a href="./nRF52_bluefruit_Learning_Guide.html#service-plus-characteristic-setup-code-analysis-13-9" class="anchor-link"><span class="fa fa-link"></span></a><span id="service-plus-characteristic-setup-code-analysis-13-9" class="anchor-link-target"></span><span id="service-plus-characteristic-setup-code-analysis" class="anchor-link-target"></span>Service + Characteristic Setup Code Analysis</h2>
<p>1. The first thing to do is to call&nbsp;<strong>.begin()</strong> on the BLEService (<strong>hrms</strong> above). Since the UUID is set in the object declaration at the top of the sketch, there is normally nothing else to do with the BLEService instance.</p>
</div>
<div class="element element element element element element element element element row-fluid build-alert alert-danger">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
You MUST call .begin() on the BLEService before adding any BLECharacteristics. Any BLECharacteristic will automatically be added to the last BLEService that was `begin()'ed!
</div>
</div>
<div class="row-fluid build-text">
<p>2. Next, you can configure the&nbsp;<strong>Heart Rate Measurement</strong> characteristic (<strong>hrmc</strong> above). The values that you set for this will depend on the characteristic definition, but for convenience sake we've documented the key information in the comments in the code above.</p>
<ul>
<li>'<code>hrmc.setProperties(CHR_PROPS_NOTIFY);</code>' - This sets the PROPERTIES value for the characteristic, which determines how the characteristic can be accessed. In this case, the Bluetooth SIG has defined the characteristic as&nbsp;<strong>Notify</strong>, which means that&nbsp;the peripheral will receive a request ('notification') from the Central when the Central wants to receive data using this characteristic.</li>
<li>`<code>hrmc.setPermission(SECMODE_OPEN, SECMODE_NO_ACCESS);</code>` - This sets the security for the characteristic, and should normally be set to the values used in this example.</li>
<li>`<code>hrmc.setFixedLen(2);</code>` - This tells the Bluetooth stack how many bytes the characteristic contains (normally a value between 1 and 20). In this case, we will use a fixed size of two bytes, so we call&nbsp;<strong>.setFixedLen</strong>. If the characteristic has a variable length, you would need to set the max size via <strong>.setMaxLen</strong>.&nbsp;</li>
<li>'<code>hrmc.setCccdWriteCallback(cccd_callback);</code>' - This optional code sets the callback that will be fired when the CCCD record is updated by the central. This is relevant because the characteristic is setup with the NOTIFY property. When the Central sets to 'Notify' bit, it will write to the CCCD record, and you can capture this write even in the CCCD callback and turn the sensor on, for example, allowing you to save power by only turning the sensor on (and back off) when it is or isn't actually being used. For the implementation of the CCCD callback handler, see the full sample code at the bottom of this page.</li>
<li>'<code>hrmc.begin();</code>' Once all of the properties have been set, you must call&nbsp;<strong>.begin()</strong> which will add the characteristic definition to the last BLEService that was '.begin()ed'.</li>
</ul>
</div>
<div class="row-fluid build-text">
<p>3. Optionally set an initial value for the characteristic(s), such as the following code that populates 'hrmc' with a correct values, indicating that we are providing 8-bit heart rate monitor values, that the Body Sensor Location characteristic is present, and setting the first heart rate value to 0x04:</p>
</div>
<div class="element element element element element element element element element row-fluid build-alert alert-info">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
Note that we use .notify() in the example above instead of .write(), since this characteristic is setup with the NOTIFY property which needs to be handled in a slightly different manner than other characteristics.
</div>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/9027/elements/2860681/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">// Set the characteristic to use 8-bit values, with the sensor connected and detected
uint8_t hrmdata[2] = { 0b00000110, 0x40 };

// Use .notify instead of .write!
hrmc.notify(hrmdata, 2);</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="com">// Set the characteristic to use 8-bit values, with the sensor connected and detected</span></li><li class="L1"><span class="typ">uint8_t</span><span class="pln"> hrmdata</span><span class="pun">[</span><span class="lit">2</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="lit">0b00000110</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x40</span><span class="pln"> </span><span class="pun">};</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="com">// Use .notify instead of .write!</span></li><li class="L4"><span class="pln">hrmc</span><span class="pun">.</span><span class="pln">notify</span><span class="pun">(</span><span class="pln">hrmdata</span><span class="pun">,</span><span class="pln"> </span><span class="lit">2</span><span class="pun">);</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<p>The CCCD callback handler has the following signature:</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/9027/elements/2860683/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">void cccd_callback(uint16_t conn_hdl, BLECharacteristic* chr, uint16_t cccd_value)
{
    // Display the raw request packet
    Serial.print("CCCD Updated: ");
    //Serial.printBuffer(request-&gt;data, request-&gt;len);
    Serial.print(cccd_value);
    Serial.println("");

    // Check the characteristic this CCCD update is associated with in case
    // this handler is used for multiple CCCD records.
    if (chr-&gt;uuid == htmc.uuid) {
        if (chr-&gt;indicateEnabled(conn_hdl)) {
            Serial.println("Temperature Measurement 'Indicate' enabled");
        } else {
            Serial.println("Temperature Measurement 'Indicate' disabled");
        }
    }
}</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="kwd">void</span><span class="pln"> cccd_callback</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> conn_hdl</span><span class="pun">,</span><span class="pln"> </span><span class="typ">BLECharacteristic</span><span class="pun">*</span><span class="pln"> chr</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint16_t</span><span class="pln"> cccd_value</span><span class="pun">)</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="pln">    </span><span class="com">// Display the raw request packet</span></li><li class="L3"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"CCCD Updated: "</span><span class="pun">);</span></li><li class="L4"><span class="pln">    </span><span class="com">//Serial.printBuffer(request-&gt;data, request-&gt;len);</span></li><li class="L5"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="pln">cccd_value</span><span class="pun">);</span></li><li class="L6"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">""</span><span class="pun">);</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">    </span><span class="com">// Check the characteristic this CCCD update is associated with in case</span></li><li class="L9"><span class="pln">    </span><span class="com">// this handler is used for multiple CCCD records.</span></li><li class="L0"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">chr</span><span class="pun">-&gt;</span><span class="pln">uuid </span><span class="pun">==</span><span class="pln"> htmc</span><span class="pun">.</span><span class="pln">uuid</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L1"><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">chr</span><span class="pun">-&gt;</span><span class="pln">indicateEnabled</span><span class="pun">(</span><span class="pln">conn_hdl</span><span class="pun">))</span><span class="pln"> </span><span class="pun">{</span></li><li class="L2"><span class="pln">            </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Temperature Measurement 'Indicate' enabled"</span><span class="pun">);</span></li><li class="L3"><span class="pln">        </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span></li><li class="L4"><span class="pln">            </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Temperature Measurement 'Indicate' disabled"</span><span class="pun">);</span></li><li class="L5"><span class="pln">        </span><span class="pun">}</span></li><li class="L6"><span class="pln">    </span><span class="pun">}</span></li><li class="L7"><span class="pun">}</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<p>4. Repeat the same procedure for any other BLECharacteristics in your service.</p>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#full-sample-code-13-18" class="anchor-link"><span class="fa fa-link"></span></a><span id="full-sample-code-13-18" class="anchor-link-target"></span><span id="full-sample-code" class="anchor-link-target"></span>Full Sample Code</h1>
<p>The full sample code for this example can be seen below:</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/9027/elements/3014339/download?type=zip">
Project Zip
</a> <span class="divider">or</span>
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/9027/elements/3014339/download">
custom_hrm.ino
</a> <span class="divider visible-lg-inline">|</span>
<a target="_blank" class="visible-lg-inline" href="https://github.com/adafruit/Adafruit_nRF52_Arduino/blob/master/libraries/Bluefruit52Lib/examples/Peripheral/custom_hrm/custom_hrm.ino">
<i class="fa fa-github"></i>
View on Github
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">/*********************************************************************
 This is an example for our nRF52 based Bluefruit LE modules

 Pick one up today in the adafruit shop!

 Adafruit invests time and resources providing this open source code,
 please support Adafruit and open-source hardware by purchasing
 products from Adafruit!

 MIT license, check LICENSE for more information
 All text above, and the splash screen below must be included in
 any redistribution
*********************************************************************/
#include &lt;bluefruit.h&gt;

/* HRM Service Definitions
 * Heart Rate Monitor Service:  0x180D
 * Heart Rate Measurement Char: 0x2A37
 * Body Sensor Location Char:   0x2A38
 */
BLEService        hrms = BLEService(UUID16_SVC_HEART_RATE);
BLECharacteristic hrmc = BLECharacteristic(UUID16_CHR_HEART_RATE_MEASUREMENT);
BLECharacteristic bslc = BLECharacteristic(UUID16_CHR_BODY_SENSOR_LOCATION);

BLEDis bledis;    // DIS (Device Information Service) helper class instance
BLEBas blebas;    // BAS (Battery Service) helper class instance

uint8_t  bps = 0;

void setup()
{
  Serial.begin(115200);
  while ( !Serial ) delay(10);   // for nrf52840 with native usb

  Serial.println("Bluefruit52 HRM Example");
  Serial.println("-----------------------\n");

  // Initialise the Bluefruit module
  Serial.println("Initialise the Bluefruit nRF52 module");
  Bluefruit.begin();

  // Set the advertised device name (keep it short!)
  Serial.println("Setting Device Name to 'Feather52 HRM'");
  Bluefruit.setName("Bluefruit52 HRM");

  // Set the connect/disconnect callback handlers
  Bluefruit.Periph.setConnectCallback(connect_callback);
  Bluefruit.Periph.setDisconnectCallback(disconnect_callback);

  // Configure and Start the Device Information Service
  Serial.println("Configuring the Device Information Service");
  bledis.setManufacturer("Adafruit Industries");
  bledis.setModel("Bluefruit Feather52");
  bledis.begin();

  // Start the BLE Battery Service and set it to 100%
  Serial.println("Configuring the Battery Service");
  blebas.begin();
  blebas.write(100);

  // Setup the Heart Rate Monitor service using
  // BLEService and BLECharacteristic classes
  Serial.println("Configuring the Heart Rate Monitor Service");
  setupHRM();

  // Setup the advertising packet(s)
  Serial.println("Setting up the advertising payload(s)");
  startAdv();

  Serial.println("Ready Player One!!!");
  Serial.println("\nAdvertising");
}

void startAdv(void)
{
  // Advertising packet
  Bluefruit.Advertising.addFlags(BLE_GAP_ADV_FLAGS_LE_ONLY_GENERAL_DISC_MODE);
  Bluefruit.Advertising.addTxPower();

  // Include HRM Service UUID
  Bluefruit.Advertising.addService(hrms);

  // Include Name
  Bluefruit.Advertising.addName();
  
  /* Start Advertising
   * - Enable auto advertising if disconnected
   * - Interval:  fast mode = 20 ms, slow mode = 152.5 ms
   * - Timeout for fast mode is 30 seconds
   * - Start(timeout) with timeout = 0 will advertise forever (until connected)
   * 
   * For recommended advertising interval
   * https://developer.apple.com/library/content/qa/qa1931/_index.html   
   */
  Bluefruit.Advertising.restartOnDisconnect(true);
  Bluefruit.Advertising.setInterval(32, 244);    // in unit of 0.625 ms
  Bluefruit.Advertising.setFastTimeout(30);      // number of seconds in fast mode
  Bluefruit.Advertising.start(0);                // 0 = Don't stop advertising after n seconds  
}

void setupHRM(void)
{
  // Configure the Heart Rate Monitor service
  // See: https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.service.heart_rate.xml
  // Supported Characteristics:
  // Name                         UUID    Requirement Properties
  // ---------------------------- ------  ----------- ----------
  // Heart Rate Measurement       0x2A37  Mandatory   Notify
  // Body Sensor Location         0x2A38  Optional    Read
  // Heart Rate Control Point     0x2A39  Conditional Write       &lt;-- Not used here
  hrms.begin();

  // Note: You must call .begin() on the BLEService before calling .begin() on
  // any characteristic(s) within that service definition.. Calling .begin() on
  // a BLECharacteristic will cause it to be added to the last BLEService that
  // was 'begin()'ed!

  // Configure the Heart Rate Measurement characteristic
  // See: https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.characteristic.heart_rate_measurement.xml
  // Properties = Notify
  // Min Len    = 1
  // Max Len    = 8
  //    B0      = UINT8  - Flag (MANDATORY)
  //      b5:7  = Reserved
  //      b4    = RR-Internal (0 = Not present, 1 = Present)
  //      b3    = Energy expended status (0 = Not present, 1 = Present)
  //      b1:2  = Sensor contact status (0+1 = Not supported, 2 = Supported but contact not detected, 3 = Supported and detected)
  //      b0    = Value format (0 = UINT8, 1 = UINT16)
  //    B1      = UINT8  - 8-bit heart rate measurement value in BPM
  //    B2:3    = UINT16 - 16-bit heart rate measurement value in BPM
  //    B4:5    = UINT16 - Energy expended in joules
  //    B6:7    = UINT16 - RR Internal (1/1024 second resolution)
  hrmc.setProperties(CHR_PROPS_NOTIFY);
  hrmc.setPermission(SECMODE_OPEN, SECMODE_NO_ACCESS);
  hrmc.setFixedLen(2);
  hrmc.setCccdWriteCallback(cccd_callback);  // Optionally capture CCCD updates
  hrmc.begin();
  uint8_t hrmdata[2] = { 0b00000110, 0x40 }; // Set the characteristic to use 8-bit values, with the sensor connected and detected
  hrmc.write(hrmdata, 2);

  // Configure the Body Sensor Location characteristic
  // See: https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.characteristic.body_sensor_location.xml
  // Properties = Read
  // Min Len    = 1
  // Max Len    = 1
  //    B0      = UINT8 - Body Sensor Location
  //      0     = Other
  //      1     = Chest
  //      2     = Wrist
  //      3     = Finger
  //      4     = Hand
  //      5     = Ear Lobe
  //      6     = Foot
  //      7:255 = Reserved
  bslc.setProperties(CHR_PROPS_READ);
  bslc.setPermission(SECMODE_OPEN, SECMODE_NO_ACCESS);
  bslc.setFixedLen(1);
  bslc.begin();
  bslc.write8(2);    // Set the characteristic to 'Wrist' (2)
}

void connect_callback(uint16_t conn_handle)
{
  // Get the reference to current connection
  BLEConnection* connection = Bluefruit.Connection(conn_handle);

  char central_name[32] = { 0 };
  connection-&gt;getPeerName(central_name, sizeof(central_name));

  Serial.print("Connected to ");
  Serial.println(central_name);
}

/**
 * Callback invoked when a connection is dropped
 * @param conn_handle connection where this event happens
 * @param reason is a BLE_HCI_STATUS_CODE which can be found in ble_hci.h
 */
void disconnect_callback(uint16_t conn_handle, uint8_t reason)
{
  (void) conn_handle;
  (void) reason;

  Serial.println("Disconnected");
  Serial.println("Advertising!");
}

void cccd_callback(uint16_t conn_hdl, BLECharacteristic* chr, uint16_t cccd_value)
{
    // Display the raw request packet
    Serial.print("CCCD Updated: ");
    //Serial.printBuffer(request-&gt;data, request-&gt;len);
    Serial.print(cccd_value);
    Serial.println("");

    // Check the characteristic this CCCD update is associated with in case
    // this handler is used for multiple CCCD records.
    if (chr-&gt;uuid == hrmc.uuid) {
        if (chr-&gt;notifyEnabled(conn_hdl)) {
            Serial.println("Heart Rate Measurement 'Notify' enabled");
        } else {
            Serial.println("Heart Rate Measurement 'Notify' disabled");
        }
    }
}

void loop()
{
  digitalToggle(LED_RED);
  
  if ( Bluefruit.connected() ) {
    uint8_t hrmdata[2] = { 0b00000110, bps++ };           // Sensor connected, increment BPS value
    
    // Note: We use .notify instead of .write!
    // If it is connected but CCCD is not enabled
    // The characteristic's value is still updated although notification is not sent
    if ( hrmc.notify(hrmdata, sizeof(hrmdata)) ){
      Serial.print("Heart Rate Measurement updated to: "); Serial.println(bps); 
    }else{
      Serial.println("ERROR: Notify not set in the CCCD or not connected!");
    }
  }

  // Only send update once per second
  delay(1000);
}
</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="com">/*********************************************************************</span></li><li class="L1"><span class="com"> This is an example for our nRF52 based Bluefruit LE modules</span></li><li class="L2"><span class="com">&nbsp;</span></li><li class="L3"><span class="com"> Pick one up today in the adafruit shop!</span></li><li class="L4"><span class="com">&nbsp;</span></li><li class="L5"><span class="com"> Adafruit invests time and resources providing this open source code,</span></li><li class="L6"><span class="com"> please support Adafruit and open-source hardware by purchasing</span></li><li class="L7"><span class="com"> products from Adafruit!</span></li><li class="L8"><span class="com">&nbsp;</span></li><li class="L9"><span class="com"> MIT license, check LICENSE for more information</span></li><li class="L0"><span class="com"> All text above, and the splash screen below must be included in</span></li><li class="L1"><span class="com"> any redistribution</span></li><li class="L2"><span class="com">*********************************************************************/</span></li><li class="L3"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;bluefruit.h&gt;</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="com">/* HRM Service Definitions</span></li><li class="L6"><span class="com"> * Heart Rate Monitor Service:  0x180D</span></li><li class="L7"><span class="com"> * Heart Rate Measurement Char: 0x2A37</span></li><li class="L8"><span class="com"> * Body Sensor Location Char:   0x2A38</span></li><li class="L9"><span class="com"> */</span></li><li class="L0"><span class="typ">BLEService</span><span class="pln">        hrms </span><span class="pun">=</span><span class="pln"> </span><span class="typ">BLEService</span><span class="pun">(</span><span class="pln">UUID16_SVC_HEART_RATE</span><span class="pun">);</span></li><li class="L1"><span class="typ">BLECharacteristic</span><span class="pln"> hrmc </span><span class="pun">=</span><span class="pln"> </span><span class="typ">BLECharacteristic</span><span class="pun">(</span><span class="pln">UUID16_CHR_HEART_RATE_MEASUREMENT</span><span class="pun">);</span></li><li class="L2"><span class="typ">BLECharacteristic</span><span class="pln"> bslc </span><span class="pun">=</span><span class="pln"> </span><span class="typ">BLECharacteristic</span><span class="pun">(</span><span class="pln">UUID16_CHR_BODY_SENSOR_LOCATION</span><span class="pun">);</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="typ">BLEDis</span><span class="pln"> bledis</span><span class="pun">;</span><span class="pln">    </span><span class="com">// DIS (Device Information Service) helper class instance</span></li><li class="L5"><span class="typ">BLEBas</span><span class="pln"> blebas</span><span class="pun">;</span><span class="pln">    </span><span class="com">// BAS (Battery Service) helper class instance</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="typ">uint8_t</span><span class="pln">  bps </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="kwd">void</span><span class="pln"> setup</span><span class="pun">()</span></li><li class="L0"><span class="pun">{</span></li><li class="L1"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">(</span><span class="lit">115200</span><span class="pun">);</span></li><li class="L2"><span class="pln">  </span><span class="kwd">while</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="typ">Serial</span><span class="pln"> </span><span class="pun">)</span><span class="pln"> delay</span><span class="pun">(</span><span class="lit">10</span><span class="pun">);</span><span class="pln">   </span><span class="com">// for nrf52840 with native usb</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Bluefruit52 HRM Example"</span><span class="pun">);</span></li><li class="L5"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"-----------------------\n"</span><span class="pun">);</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="pln">  </span><span class="com">// Initialise the Bluefruit module</span></li><li class="L8"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Initialise the Bluefruit nRF52 module"</span><span class="pun">);</span></li><li class="L9"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">  </span><span class="com">// Set the advertised device name (keep it short!)</span></li><li class="L2"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Setting Device Name to 'Feather52 HRM'"</span><span class="pun">);</span></li><li class="L3"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="pln">setName</span><span class="pun">(</span><span class="str">"Bluefruit52 HRM"</span><span class="pun">);</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">  </span><span class="com">// Set the connect/disconnect callback handlers</span></li><li class="L6"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Periph</span><span class="pun">.</span><span class="pln">setConnectCallback</span><span class="pun">(</span><span class="pln">connect_callback</span><span class="pun">);</span></li><li class="L7"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Periph</span><span class="pun">.</span><span class="pln">setDisconnectCallback</span><span class="pun">(</span><span class="pln">disconnect_callback</span><span class="pun">);</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="pln">  </span><span class="com">// Configure and Start the Device Information Service</span></li><li class="L0"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Configuring the Device Information Service"</span><span class="pun">);</span></li><li class="L1"><span class="pln">  bledis</span><span class="pun">.</span><span class="pln">setManufacturer</span><span class="pun">(</span><span class="str">"Adafruit Industries"</span><span class="pun">);</span></li><li class="L2"><span class="pln">  bledis</span><span class="pun">.</span><span class="pln">setModel</span><span class="pun">(</span><span class="str">"Bluefruit Feather52"</span><span class="pun">);</span></li><li class="L3"><span class="pln">  bledis</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">  </span><span class="com">// Start the BLE Battery Service and set it to 100%</span></li><li class="L6"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Configuring the Battery Service"</span><span class="pun">);</span></li><li class="L7"><span class="pln">  blebas</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L8"><span class="pln">  blebas</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="lit">100</span><span class="pun">);</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="pln">  </span><span class="com">// Setup the Heart Rate Monitor service using</span></li><li class="L1"><span class="pln">  </span><span class="com">// BLEService and BLECharacteristic classes</span></li><li class="L2"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Configuring the Heart Rate Monitor Service"</span><span class="pun">);</span></li><li class="L3"><span class="pln">  setupHRM</span><span class="pun">();</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">  </span><span class="com">// Setup the advertising packet(s)</span></li><li class="L6"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Setting up the advertising payload(s)"</span><span class="pun">);</span></li><li class="L7"><span class="pln">  startAdv</span><span class="pun">();</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Ready Player One!!!"</span><span class="pun">);</span></li><li class="L0"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"\nAdvertising"</span><span class="pun">);</span></li><li class="L1"><span class="pun">}</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="kwd">void</span><span class="pln"> startAdv</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="pln">  </span><span class="com">// Advertising packet</span></li><li class="L6"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">addFlags</span><span class="pun">(</span><span class="pln">BLE_GAP_ADV_FLAGS_LE_ONLY_GENERAL_DISC_MODE</span><span class="pun">);</span></li><li class="L7"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">addTxPower</span><span class="pun">();</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="pln">  </span><span class="com">// Include HRM Service UUID</span></li><li class="L0"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">addService</span><span class="pun">(</span><span class="pln">hrms</span><span class="pun">);</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="pln">  </span><span class="com">// Include Name</span></li><li class="L3"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">addName</span><span class="pun">();</span></li><li class="L4"><span class="pln">  </span></li><li class="L5"><span class="pln">  </span><span class="com">/* Start Advertising</span></li><li class="L6"><span class="com">   * - Enable auto advertising if disconnected</span></li><li class="L7"><span class="com">   * - Interval:  fast mode = 20 ms, slow mode = 152.5 ms</span></li><li class="L8"><span class="com">   * - Timeout for fast mode is 30 seconds</span></li><li class="L9"><span class="com">   * - Start(timeout) with timeout = 0 will advertise forever (until connected)</span></li><li class="L0"><span class="com">   * </span></li><li class="L1"><span class="com">   * For recommended advertising interval</span></li><li class="L2"><span class="com">   * https://developer.apple.com/library/content/qa/qa1931/_index.html   </span></li><li class="L3"><span class="com">   */</span></li><li class="L4"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">restartOnDisconnect</span><span class="pun">(</span><span class="kwd">true</span><span class="pun">);</span></li><li class="L5"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">setInterval</span><span class="pun">(</span><span class="lit">32</span><span class="pun">,</span><span class="pln"> </span><span class="lit">244</span><span class="pun">);</span><span class="pln">    </span><span class="com">// in unit of 0.625 ms</span></li><li class="L6"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">setFastTimeout</span><span class="pun">(</span><span class="lit">30</span><span class="pun">);</span><span class="pln">      </span><span class="com">// number of seconds in fast mode</span></li><li class="L7"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">start</span><span class="pun">(</span><span class="lit">0</span><span class="pun">);</span><span class="pln">                </span><span class="com">// 0 = Don't stop advertising after n seconds  </span></li><li class="L8"><span class="pun">}</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="kwd">void</span><span class="pln"> setupHRM</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="pln">  </span><span class="com">// Configure the Heart Rate Monitor service</span></li><li class="L3"><span class="pln">  </span><span class="com">// See: https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.service.heart_rate.xml</span></li><li class="L4"><span class="pln">  </span><span class="com">// Supported Characteristics:</span></li><li class="L5"><span class="pln">  </span><span class="com">// Name                         UUID    Requirement Properties</span></li><li class="L6"><span class="pln">  </span><span class="com">// ---------------------------- ------  ----------- ----------</span></li><li class="L7"><span class="pln">  </span><span class="com">// Heart Rate Measurement       0x2A37  Mandatory   Notify</span></li><li class="L8"><span class="pln">  </span><span class="com">// Body Sensor Location         0x2A38  Optional    Read</span></li><li class="L9"><span class="pln">  </span><span class="com">// Heart Rate Control Point     0x2A39  Conditional Write       &lt;-- Not used here</span></li><li class="L0"><span class="pln">  hrms</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="pln">  </span><span class="com">// Note: You must call .begin() on the BLEService before calling .begin() on</span></li><li class="L3"><span class="pln">  </span><span class="com">// any characteristic(s) within that service definition.. Calling .begin() on</span></li><li class="L4"><span class="pln">  </span><span class="com">// a BLECharacteristic will cause it to be added to the last BLEService that</span></li><li class="L5"><span class="pln">  </span><span class="com">// was 'begin()'ed!</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="pln">  </span><span class="com">// Configure the Heart Rate Measurement characteristic</span></li><li class="L8"><span class="pln">  </span><span class="com">// See: https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.characteristic.heart_rate_measurement.xml</span></li><li class="L9"><span class="pln">  </span><span class="com">// Properties = Notify</span></li><li class="L0"><span class="pln">  </span><span class="com">// Min Len    = 1</span></li><li class="L1"><span class="pln">  </span><span class="com">// Max Len    = 8</span></li><li class="L2"><span class="pln">  </span><span class="com">//    B0      = UINT8  - Flag (MANDATORY)</span></li><li class="L3"><span class="pln">  </span><span class="com">//      b5:7  = Reserved</span></li><li class="L4"><span class="pln">  </span><span class="com">//      b4    = RR-Internal (0 = Not present, 1 = Present)</span></li><li class="L5"><span class="pln">  </span><span class="com">//      b3    = Energy expended status (0 = Not present, 1 = Present)</span></li><li class="L6"><span class="pln">  </span><span class="com">//      b1:2  = Sensor contact status (0+1 = Not supported, 2 = Supported but contact not detected, 3 = Supported and detected)</span></li><li class="L7"><span class="pln">  </span><span class="com">//      b0    = Value format (0 = UINT8, 1 = UINT16)</span></li><li class="L8"><span class="pln">  </span><span class="com">//    B1      = UINT8  - 8-bit heart rate measurement value in BPM</span></li><li class="L9"><span class="pln">  </span><span class="com">//    B2:3    = UINT16 - 16-bit heart rate measurement value in BPM</span></li><li class="L0"><span class="pln">  </span><span class="com">//    B4:5    = UINT16 - Energy expended in joules</span></li><li class="L1"><span class="pln">  </span><span class="com">//    B6:7    = UINT16 - RR Internal (1/1024 second resolution)</span></li><li class="L2"><span class="pln">  hrmc</span><span class="pun">.</span><span class="pln">setProperties</span><span class="pun">(</span><span class="pln">CHR_PROPS_NOTIFY</span><span class="pun">);</span></li><li class="L3"><span class="pln">  hrmc</span><span class="pun">.</span><span class="pln">setPermission</span><span class="pun">(</span><span class="pln">SECMODE_OPEN</span><span class="pun">,</span><span class="pln"> SECMODE_NO_ACCESS</span><span class="pun">);</span></li><li class="L4"><span class="pln">  hrmc</span><span class="pun">.</span><span class="pln">setFixedLen</span><span class="pun">(</span><span class="lit">2</span><span class="pun">);</span></li><li class="L5"><span class="pln">  hrmc</span><span class="pun">.</span><span class="pln">setCccdWriteCallback</span><span class="pun">(</span><span class="pln">cccd_callback</span><span class="pun">);</span><span class="pln">  </span><span class="com">// Optionally capture CCCD updates</span></li><li class="L6"><span class="pln">  hrmc</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L7"><span class="pln">  </span><span class="typ">uint8_t</span><span class="pln"> hrmdata</span><span class="pun">[</span><span class="lit">2</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="lit">0b00000110</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x40</span><span class="pln"> </span><span class="pun">};</span><span class="pln"> </span><span class="com">// Set the characteristic to use 8-bit values, with the sensor connected and detected</span></li><li class="L8"><span class="pln">  hrmc</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="pln">hrmdata</span><span class="pun">,</span><span class="pln"> </span><span class="lit">2</span><span class="pun">);</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="pln">  </span><span class="com">// Configure the Body Sensor Location characteristic</span></li><li class="L1"><span class="pln">  </span><span class="com">// See: https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.characteristic.body_sensor_location.xml</span></li><li class="L2"><span class="pln">  </span><span class="com">// Properties = Read</span></li><li class="L3"><span class="pln">  </span><span class="com">// Min Len    = 1</span></li><li class="L4"><span class="pln">  </span><span class="com">// Max Len    = 1</span></li><li class="L5"><span class="pln">  </span><span class="com">//    B0      = UINT8 - Body Sensor Location</span></li><li class="L6"><span class="pln">  </span><span class="com">//      0     = Other</span></li><li class="L7"><span class="pln">  </span><span class="com">//      1     = Chest</span></li><li class="L8"><span class="pln">  </span><span class="com">//      2     = Wrist</span></li><li class="L9"><span class="pln">  </span><span class="com">//      3     = Finger</span></li><li class="L0"><span class="pln">  </span><span class="com">//      4     = Hand</span></li><li class="L1"><span class="pln">  </span><span class="com">//      5     = Ear Lobe</span></li><li class="L2"><span class="pln">  </span><span class="com">//      6     = Foot</span></li><li class="L3"><span class="pln">  </span><span class="com">//      7:255 = Reserved</span></li><li class="L4"><span class="pln">  bslc</span><span class="pun">.</span><span class="pln">setProperties</span><span class="pun">(</span><span class="pln">CHR_PROPS_READ</span><span class="pun">);</span></li><li class="L5"><span class="pln">  bslc</span><span class="pun">.</span><span class="pln">setPermission</span><span class="pun">(</span><span class="pln">SECMODE_OPEN</span><span class="pun">,</span><span class="pln"> SECMODE_NO_ACCESS</span><span class="pun">);</span></li><li class="L6"><span class="pln">  bslc</span><span class="pun">.</span><span class="pln">setFixedLen</span><span class="pun">(</span><span class="lit">1</span><span class="pun">);</span></li><li class="L7"><span class="pln">  bslc</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L8"><span class="pln">  bslc</span><span class="pun">.</span><span class="pln">write8</span><span class="pun">(</span><span class="lit">2</span><span class="pun">);</span><span class="pln">    </span><span class="com">// Set the characteristic to 'Wrist' (2)</span></li><li class="L9"><span class="pun">}</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="kwd">void</span><span class="pln"> connect_callback</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> conn_handle</span><span class="pun">)</span></li><li class="L2"><span class="pun">{</span></li><li class="L3"><span class="pln">  </span><span class="com">// Get the reference to current connection</span></li><li class="L4"><span class="pln">  </span><span class="typ">BLEConnection</span><span class="pun">*</span><span class="pln"> connection </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Connection</span><span class="pun">(</span><span class="pln">conn_handle</span><span class="pun">);</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">  </span><span class="kwd">char</span><span class="pln"> central_name</span><span class="pun">[</span><span class="lit">32</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="lit">0</span><span class="pln"> </span><span class="pun">};</span></li><li class="L7"><span class="pln">  connection</span><span class="pun">-&gt;</span><span class="pln">getPeerName</span><span class="pun">(</span><span class="pln">central_name</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">sizeof</span><span class="pun">(</span><span class="pln">central_name</span><span class="pun">));</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"Connected to "</span><span class="pun">);</span></li><li class="L0"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="pln">central_name</span><span class="pun">);</span></li><li class="L1"><span class="pun">}</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="com">/**</span></li><li class="L4"><span class="com"> * Callback invoked when a connection is dropped</span></li><li class="L5"><span class="com"> * @param conn_handle connection where this event happens</span></li><li class="L6"><span class="com"> * @param reason is a BLE_HCI_STATUS_CODE which can be found in ble_hci.h</span></li><li class="L7"><span class="com"> */</span></li><li class="L8"><span class="kwd">void</span><span class="pln"> disconnect_callback</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> conn_handle</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pln"> reason</span><span class="pun">)</span></li><li class="L9"><span class="pun">{</span></li><li class="L0"><span class="pln">  </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span><span class="pln"> conn_handle</span><span class="pun">;</span></li><li class="L1"><span class="pln">  </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span><span class="pln"> reason</span><span class="pun">;</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Disconnected"</span><span class="pun">);</span></li><li class="L4"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Advertising!"</span><span class="pun">);</span></li><li class="L5"><span class="pun">}</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="kwd">void</span><span class="pln"> cccd_callback</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> conn_hdl</span><span class="pun">,</span><span class="pln"> </span><span class="typ">BLECharacteristic</span><span class="pun">*</span><span class="pln"> chr</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint16_t</span><span class="pln"> cccd_value</span><span class="pun">)</span></li><li class="L8"><span class="pun">{</span></li><li class="L9"><span class="pln">    </span><span class="com">// Display the raw request packet</span></li><li class="L0"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"CCCD Updated: "</span><span class="pun">);</span></li><li class="L1"><span class="pln">    </span><span class="com">//Serial.printBuffer(request-&gt;data, request-&gt;len);</span></li><li class="L2"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="pln">cccd_value</span><span class="pun">);</span></li><li class="L3"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">""</span><span class="pun">);</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">    </span><span class="com">// Check the characteristic this CCCD update is associated with in case</span></li><li class="L6"><span class="pln">    </span><span class="com">// this handler is used for multiple CCCD records.</span></li><li class="L7"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">chr</span><span class="pun">-&gt;</span><span class="pln">uuid </span><span class="pun">==</span><span class="pln"> hrmc</span><span class="pun">.</span><span class="pln">uuid</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L8"><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">chr</span><span class="pun">-&gt;</span><span class="pln">notifyEnabled</span><span class="pun">(</span><span class="pln">conn_hdl</span><span class="pun">))</span><span class="pln"> </span><span class="pun">{</span></li><li class="L9"><span class="pln">            </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Heart Rate Measurement 'Notify' enabled"</span><span class="pun">);</span></li><li class="L0"><span class="pln">        </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span></li><li class="L1"><span class="pln">            </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Heart Rate Measurement 'Notify' disabled"</span><span class="pun">);</span></li><li class="L2"><span class="pln">        </span><span class="pun">}</span></li><li class="L3"><span class="pln">    </span><span class="pun">}</span></li><li class="L4"><span class="pun">}</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="kwd">void</span><span class="pln"> loop</span><span class="pun">()</span></li><li class="L7"><span class="pun">{</span></li><li class="L8"><span class="pln">  digitalToggle</span><span class="pun">(</span><span class="pln">LED_RED</span><span class="pun">);</span></li><li class="L9"><span class="pln">  </span></li><li class="L0"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="pln">connected</span><span class="pun">()</span><span class="pln"> </span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L1"><span class="pln">    </span><span class="typ">uint8_t</span><span class="pln"> hrmdata</span><span class="pun">[</span><span class="lit">2</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="lit">0b00000110</span><span class="pun">,</span><span class="pln"> bps</span><span class="pun">++</span><span class="pln"> </span><span class="pun">};</span><span class="pln">           </span><span class="com">// Sensor connected, increment BPS value</span></li><li class="L2"><span class="pln">    </span></li><li class="L3"><span class="pln">    </span><span class="com">// Note: We use .notify instead of .write!</span></li><li class="L4"><span class="pln">    </span><span class="com">// If it is connected but CCCD is not enabled</span></li><li class="L5"><span class="pln">    </span><span class="com">// The characteristic's value is still updated although notification is not sent</span></li><li class="L6"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> hrmc</span><span class="pun">.</span><span class="pln">notify</span><span class="pun">(</span><span class="pln">hrmdata</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">sizeof</span><span class="pun">(</span><span class="pln">hrmdata</span><span class="pun">))</span><span class="pln"> </span><span class="pun">){</span></li><li class="L7"><span class="pln">      </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"Heart Rate Measurement updated to: "</span><span class="pun">);</span><span class="pln"> </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="pln">bps</span><span class="pun">);</span><span class="pln"> </span></li><li class="L8"><span class="pln">    </span><span class="pun">}</span><span class="kwd">else</span><span class="pun">{</span></li><li class="L9"><span class="pln">      </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"ERROR: Notify not set in the CCCD or not connected!"</span><span class="pun">);</span></li><li class="L0"><span class="pln">    </span><span class="pun">}</span></li><li class="L1"><span class="pln">  </span><span class="pun">}</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="pln">  </span><span class="com">// Only send update once per second</span></li><li class="L4"><span class="pln">  delay</span><span class="pun">(</span><span class="lit">1000</span><span class="pun">);</span></li><li class="L5"><span class="pun">}</span></li></ol></pre>
</div>
</div>
</div>
<div class="page-title-wrapper">
<h1 class="headline">
<span id="ble-pin-i-o">BLE Pin I/O</span>
</h1>
<div class="author">by
<a href="./nRF52_bluefruit_Learning_Guide.html#ble-pin-i-o">
<span class="name">Thach Ha</span>
</a> </div>
</div>
<div class="page-content all-page-view-content">
<div class="">
<div class="row-fluid build-text">

<p>Firmata is a generic protocol for communicating with microcontrollers and controlling the board's pins such as setting the GPIO outputs and inputs, PWM output, analog reads, etc....</p>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#setup-14-2" class="anchor-link"><span class="fa fa-link"></span></a><span id="setup-14-2" class="anchor-link-target"></span><span id="setup" class="anchor-link-target"></span>Setup</h1>
<p>In order to run this demo, you will need to open Bluefruit LE Connect on your mobile device&nbsp;using our free <a href="https://itunes.apple.com/app/adafruit-bluefruit-le-connect/id830125974?mt=8" target="_blank">iOS</a>, <a href="https://play.google.com/store/apps/details?id=com.adafruit.bluefruit.le.connect" target="_blank">Android</a> or <a href="https://itunes.apple.com/us/app/adafruit-bluefruit-le-connect/id1082414600?mt=12" target="_blank">OS X</a> applications.</p>
<ul>
<li>Load the <a href="https://github.com/adafruit/Adafruit_nRF52_Arduino/tree/master/libraries/Bluefruit52Lib/examples/Peripheral/StandardFirmataBLE"><strong>StandardFirmataBLE</strong> example sketch</a> in the Arduino IDE</li>
<li>Compile the sketch and flash it to your nRF52 based Feather</li>
<li>Once you are done uploading, open the&nbsp;<strong>Serial Monitor</strong> (Tools &gt; Serial Monitor)</li>
<li>Open the <strong>Bluefruit LE Connect</strong> application on your mobile device</li>
<li>Connect to the appropriate target (probably '<strong>Bluefruit52</strong>')</li>
<li>Once connected switch to the&nbsp;<strong>Pin I/O</strong>&nbsp;application inside the app</li>
</ul>
<p>For more information using Pin I/O module, you could check out this tutorial here&nbsp;https://learn.adafruit.com/bluefruit-le-connect-for-ios/pin-i-o</p>
</div>
<div class="row-fluid build-image">
<a href="./nRF52_bluefruit_Learning_Guide.html#ble-pin-i-o">
<img class="49548-asset img-responsive" src="./nRF52_bluefruit_Learning_Guide/microcontrollers_IMG_0042.png" alt="microcontrollers_IMG_0042.png">
<span class="image-expand"><i class="fa fa-search-plus"></i></span>
</a> </div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#complete-code-14-4" class="anchor-link"><span class="fa fa-link"></span></a><span id="complete-code-14-4" class="anchor-link-target"></span><span id="complete-code" class="anchor-link-target"></span>Complete Code</h1>
<p>The latest version of this code is always available on <a href="https://github.com/adafruit/Adafruit_nRF52_Arduino/tree/master/libraries/Bluefruit52Lib/examples/Peripheral/controller" target="_blank">Github</a>, and in the&nbsp;<strong>Examples</strong> folder of the nRF52 BSP.</p>
</div>
<div class="element element element element element element element element element element element element element row-fluid build-alert alert-danger">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
The code below is provided for convenience sake, but may be out of date! See the link above for the latest code.
</div>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/11194/elements/3014345/download?type=zip">
Project Zip
</a> <span class="divider">or</span>
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/11194/elements/3014345/download">
StandardFirmataBLE.ino
</a> <span class="divider visible-lg-inline">|</span>
<a target="_blank" class="visible-lg-inline" href="https://github.com/adafruit/Adafruit_nRF52_Arduino/blob/master/libraries/Bluefruit52Lib/examples/Peripheral/StandardFirmataBLE/StandardFirmataBLE.ino">
<i class="fa fa-github"></i>
View on Github
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">/*
  Firmata is a generic protocol for communicating with microcontrollers
  from software on a host computer. It is intended to work with
  any host computer software package.

  To download a host software package, please click on the following link
  to open the list of Firmata client libraries in your default browser.

  https://github.com/firmata/arduino#firmata-client-libraries

  Copyright (C) 2006-2008 Hans-Christoph Steiner.  All rights reserved.
  Copyright (C) 2010-2011 Paul Stoffregen.  All rights reserved.
  Copyright (C) 2009 Shigeru Kobayashi.  All rights reserved.
  Copyright (C) 2009-2016 Jeff Hoefs.  All rights reserved.

  This library is free software; you can redistribute it and/or
  modify it under the terms of the GNU Lesser General Public
  License as published by the Free Software Foundation; either
  version 2.1 of the License, or (at your option) any later version.

  See file LICENSE.txt for further informations on licensing terms.

  Last updated October 16th, 2016
*/

// Adafruit nRF52 Boards require Firmata at least 2.5.7

#include &lt;bluefruit.h&gt;
#include &lt;Servo.h&gt;
#include &lt;Wire.h&gt;
#include &lt;Firmata.h&gt;

#define I2C_WRITE                   B00000000
#define I2C_READ                    B00001000
#define I2C_READ_CONTINUOUSLY       B00010000
#define I2C_STOP_READING            B00011000
#define I2C_READ_WRITE_MODE_MASK    B00011000
#define I2C_10BIT_ADDRESS_MODE_MASK B00100000
#define I2C_END_TX_MASK             B01000000
#define I2C_STOP_TX                 1
#define I2C_RESTART_TX              0
#define I2C_MAX_QUERIES             8
#define I2C_REGISTER_NOT_SPECIFIED  -1

// the minimum interval for sampling analog input
#define MINIMUM_SAMPLING_INTERVAL   1

// Adafruit
uint8_t ANALOG_TO_PIN(uint8_t n)
{
  switch (n)
  {
    case 0 : return PIN_A0;
    case 1 : return PIN_A1;
    case 2 : return PIN_A2;
    case 3 : return PIN_A3;
    case 4 : return PIN_A4;
    case 5 : return PIN_A5;
    case 6 : return PIN_A6;
    case 7 : return PIN_A7;
  }

  return 127;
}


/*==============================================================================
 * GLOBAL VARIABLES
 *============================================================================*/

#ifdef FIRMATA_SERIAL_FEATURE
SerialFirmata serialFeature;
#endif

BLEUart bleuart;

/* analog inputs */
int analogInputsToReport = 0; // bitwise array to store pin reporting

/* digital input ports */
byte reportPINs[TOTAL_PORTS];       // 1 = report this port, 0 = silence
byte previousPINs[TOTAL_PORTS];     // previous 8 bits sent

/* pins configuration */
byte portConfigInputs[TOTAL_PORTS]; // each bit: 1 = pin in INPUT, 0 = anything else

/* timer variables */
unsigned long currentMillis;        // store the current value from millis()
unsigned long previousMillis;       // for comparison with currentMillis
unsigned int samplingInterval = 19; // how often to run the main loop (in ms)

/* i2c data */
struct i2c_device_info {
  byte addr;
  int reg;
  byte bytes;
  byte stopTX;
};

/* for i2c read continuous more */
i2c_device_info query[I2C_MAX_QUERIES];

byte i2cRxData[64];
boolean isI2CEnabled = false;
signed char queryIndex = -1;
// default delay time between i2c read request and Wire.requestFrom()
unsigned int i2cReadDelayTime = 0;

Servo servos[MAX_SERVOS];
byte servoPinMap[TOTAL_PINS];
byte detachedServos[MAX_SERVOS];
byte detachedServoCount = 0;
byte servoCount = 0;

boolean isResetting = false;

// Forward declare a few functions to avoid compiler errors with older versions
// of the Arduino IDE.
void setPinModeCallback(byte, int);
void reportAnalogCallback(byte analogPin, int value);
void sysexCallback(byte, byte, byte*);

/* utility functions */
void wireWrite(byte data)
{
#if ARDUINO &gt;= 100
  Wire.write((byte)data);
#else
  Wire.send(data);
#endif
}

byte wireRead(void)
{
#if ARDUINO &gt;= 100
  return Wire.read();
#else
  return Wire.receive();
#endif
}

/*==============================================================================
 * FUNCTIONS
 *============================================================================*/

void attachServo(byte pin, int minPulse, int maxPulse)
{
  if (servoCount &lt; MAX_SERVOS) {
    // reuse indexes of detached servos until all have been reallocated
    if (detachedServoCount &gt; 0) {
      servoPinMap[pin] = detachedServos[detachedServoCount - 1];
      if (detachedServoCount &gt; 0) detachedServoCount--;
    } else {
      servoPinMap[pin] = servoCount;
      servoCount++;
    }
    if (minPulse &gt; 0 &amp;&amp; maxPulse &gt; 0) {
      servos[servoPinMap[pin]].attach(PIN_TO_DIGITAL(pin), minPulse, maxPulse);
    } else {
      servos[servoPinMap[pin]].attach(PIN_TO_DIGITAL(pin));
    }
  } else {
    Firmata.sendString("Max servos attached");
  }
}

void detachServo(byte pin)
{
  servos[servoPinMap[pin]].detach();
  // if we're detaching the last servo, decrement the count
  // otherwise store the index of the detached servo
  if (servoPinMap[pin] == servoCount &amp;&amp; servoCount &gt; 0) {
    servoCount--;
  } else if (servoCount &gt; 0) {
    // keep track of detached servos because we want to reuse their indexes
    // before incrementing the count of attached servos
    detachedServoCount++;
    detachedServos[detachedServoCount - 1] = servoPinMap[pin];
  }

  servoPinMap[pin] = 255;
}

void enableI2CPins()
{
  byte i;
  // is there a faster way to do this? would probaby require importing
  // Arduino.h to get SCL and SDA pins
  for (i = 0; i &lt; TOTAL_PINS; i++) {
    if (IS_PIN_I2C(i)) {
      // mark pins as i2c so they are ignore in non i2c data requests
      setPinModeCallback(i, PIN_MODE_I2C);
    }
  }

  isI2CEnabled = true;

  Wire.begin();
}

/* disable the i2c pins so they can be used for other functions */
void disableI2CPins() {
  isI2CEnabled = false;
  // disable read continuous mode for all devices
  queryIndex = -1;
}

void readAndReportData(byte address, int theRegister, byte numBytes, byte stopTX) {
  // allow I2C requests that don't require a register read
  // for example, some devices using an interrupt pin to signify new data available
  // do not always require the register read so upon interrupt you call Wire.requestFrom()
  if (theRegister != I2C_REGISTER_NOT_SPECIFIED) {
    Wire.beginTransmission(address);
    wireWrite((byte)theRegister);
    Wire.endTransmission(stopTX); // default = true
    // do not set a value of 0
    if (i2cReadDelayTime &gt; 0) {
      // delay is necessary for some devices such as WiiNunchuck
      delayMicroseconds(i2cReadDelayTime);
    }
  } else {
    theRegister = 0;  // fill the register with a dummy value
  }

  Wire.requestFrom(address, numBytes);  // all bytes are returned in requestFrom

  // check to be sure correct number of bytes were returned by slave
  if (numBytes &lt; Wire.available()) {
    Firmata.sendString("I2C: Too many bytes received");
  } else if (numBytes &gt; Wire.available()) {
    Firmata.sendString("I2C: Too few bytes received");
  }

  i2cRxData[0] = address;
  i2cRxData[1] = theRegister;

  for (int i = 0; i &lt; numBytes &amp;&amp; Wire.available(); i++) {
    i2cRxData[2 + i] = wireRead();
  }

  // send slave address, register and received bytes
  Firmata.sendSysex(SYSEX_I2C_REPLY, numBytes + 2, i2cRxData);
}

void outputPort(byte portNumber, byte portValue, byte forceSend)
{
  // pins not configured as INPUT are cleared to zeros
  portValue = portValue &amp; portConfigInputs[portNumber];
  // only send if the value is different than previously sent
  if (forceSend || previousPINs[portNumber] != portValue) {
    Firmata.sendDigitalPort(portNumber, portValue);
    previousPINs[portNumber] = portValue;
  }
}

/* -----------------------------------------------------------------------------
 * check all the active digital inputs for change of state, then add any events
 * to the Serial output queue using Serial.print() */
void checkDigitalInputs(void)
{
  /* Using non-looping code allows constants to be given to readPort().
   * The compiler will apply substantial optimizations if the inputs
   * to readPort() are compile-time constants. */
  if (TOTAL_PORTS &gt; 0 &amp;&amp; reportPINs[0]) outputPort(0, readPort(0, portConfigInputs[0]), false);
  if (TOTAL_PORTS &gt; 1 &amp;&amp; reportPINs[1]) outputPort(1, readPort(1, portConfigInputs[1]), false);
  if (TOTAL_PORTS &gt; 2 &amp;&amp; reportPINs[2]) outputPort(2, readPort(2, portConfigInputs[2]), false);
  if (TOTAL_PORTS &gt; 3 &amp;&amp; reportPINs[3]) outputPort(3, readPort(3, portConfigInputs[3]), false);
  if (TOTAL_PORTS &gt; 4 &amp;&amp; reportPINs[4]) outputPort(4, readPort(4, portConfigInputs[4]), false);
  if (TOTAL_PORTS &gt; 5 &amp;&amp; reportPINs[5]) outputPort(5, readPort(5, portConfigInputs[5]), false);
  if (TOTAL_PORTS &gt; 6 &amp;&amp; reportPINs[6]) outputPort(6, readPort(6, portConfigInputs[6]), false);
  if (TOTAL_PORTS &gt; 7 &amp;&amp; reportPINs[7]) outputPort(7, readPort(7, portConfigInputs[7]), false);
  if (TOTAL_PORTS &gt; 8 &amp;&amp; reportPINs[8]) outputPort(8, readPort(8, portConfigInputs[8]), false);
  if (TOTAL_PORTS &gt; 9 &amp;&amp; reportPINs[9]) outputPort(9, readPort(9, portConfigInputs[9]), false);
  if (TOTAL_PORTS &gt; 10 &amp;&amp; reportPINs[10]) outputPort(10, readPort(10, portConfigInputs[10]), false);
  if (TOTAL_PORTS &gt; 11 &amp;&amp; reportPINs[11]) outputPort(11, readPort(11, portConfigInputs[11]), false);
  if (TOTAL_PORTS &gt; 12 &amp;&amp; reportPINs[12]) outputPort(12, readPort(12, portConfigInputs[12]), false);
  if (TOTAL_PORTS &gt; 13 &amp;&amp; reportPINs[13]) outputPort(13, readPort(13, portConfigInputs[13]), false);
  if (TOTAL_PORTS &gt; 14 &amp;&amp; reportPINs[14]) outputPort(14, readPort(14, portConfigInputs[14]), false);
  if (TOTAL_PORTS &gt; 15 &amp;&amp; reportPINs[15]) outputPort(15, readPort(15, portConfigInputs[15]), false);
}

// -----------------------------------------------------------------------------
/* sets the pin mode to the correct state and sets the relevant bits in the
 * two bit-arrays that track Digital I/O and PWM status
 */
void setPinModeCallback(byte pin, int mode)
{
  if (Firmata.getPinMode(pin) == PIN_MODE_IGNORE)
    return;

  if (Firmata.getPinMode(pin) == PIN_MODE_I2C &amp;&amp; isI2CEnabled &amp;&amp; mode != PIN_MODE_I2C) {
    // disable i2c so pins can be used for other functions
    // the following if statements should reconfigure the pins properly
    disableI2CPins();
  }
  if (IS_PIN_DIGITAL(pin) &amp;&amp; mode != PIN_MODE_SERVO) {
    if (servoPinMap[pin] &lt; MAX_SERVOS &amp;&amp; servos[servoPinMap[pin]].attached()) {
      detachServo(pin);
    }
  }
  if (IS_PIN_ANALOG(pin)) {
    reportAnalogCallback(PIN_TO_ANALOG(pin), mode == PIN_MODE_ANALOG ? 1 : 0); // turn on/off reporting
  }
  if (IS_PIN_DIGITAL(pin)) {
    if (mode == INPUT || mode == PIN_MODE_PULLUP) {
      portConfigInputs[pin / 8] |= (1 &lt;&lt; (pin &amp; 7));
    } else {
      portConfigInputs[pin / 8] &amp;= ~(1 &lt;&lt; (pin &amp; 7));
    }
  }
  Firmata.setPinState(pin, 0);
  switch (mode) {
    case PIN_MODE_ANALOG:
      if (IS_PIN_ANALOG(pin)) {
        if (IS_PIN_DIGITAL(pin)) {
          pinMode(PIN_TO_DIGITAL(pin), INPUT);    // disable output driver
#if ARDUINO &lt;= 100
          // deprecated since Arduino 1.0.1 - TODO: drop support in Firmata 2.6
          digitalWrite(PIN_TO_DIGITAL(pin), LOW); // disable internal pull-ups
#endif
        }
        Firmata.setPinMode(pin, PIN_MODE_ANALOG);
      }
      break;
    case INPUT:
// Adafruit: Input without pull up cause pin state changes randomly --&gt; lots of transmission data     
//      if (IS_PIN_DIGITAL(pin)) {
//        pinMode(PIN_TO_DIGITAL(pin), INPUT);    // disable output driver
//#if ARDUINO &lt;= 100
//        // deprecated since Arduino 1.0.1 - TODO: drop support in Firmata 2.6
//        digitalWrite(PIN_TO_DIGITAL(pin), LOW); // disable internal pull-ups
//#endif
//        Firmata.setPinMode(pin, INPUT);
//      }
//      break;
    case PIN_MODE_PULLUP:
      if (IS_PIN_DIGITAL(pin)) {
        pinMode(PIN_TO_DIGITAL(pin), INPUT_PULLUP);
        Firmata.setPinMode(pin, PIN_MODE_PULLUP);
        Firmata.setPinState(pin, 1);
      }
      break;
    case OUTPUT:
      if (IS_PIN_DIGITAL(pin)) {
        if (Firmata.getPinMode(pin) == PIN_MODE_PWM) {
          // Disable PWM if pin mode was previously set to PWM.
          digitalWrite(PIN_TO_DIGITAL(pin), LOW);
        }
        pinMode(PIN_TO_DIGITAL(pin), OUTPUT);
        Firmata.setPinMode(pin, OUTPUT);
      }
      break;
    case PIN_MODE_PWM:
      if (IS_PIN_PWM(pin)) {
        pinMode(PIN_TO_PWM(pin), OUTPUT);
        analogWrite(PIN_TO_PWM(pin), 0);
        Firmata.setPinMode(pin, PIN_MODE_PWM);
      }
      break;
    case PIN_MODE_SERVO:
      if (IS_PIN_DIGITAL(pin)) {
        Firmata.setPinMode(pin, PIN_MODE_SERVO);
        if (servoPinMap[pin] == 255 || !servos[servoPinMap[pin]].attached()) {
          // pass -1 for min and max pulse values to use default values set
          // by Servo library
          attachServo(pin, -1, -1);
        }
      }
      break;
    case PIN_MODE_I2C:
      if (IS_PIN_I2C(pin)) {
        // mark the pin as i2c
        // the user must call I2C_CONFIG to enable I2C for a device
        Firmata.setPinMode(pin, PIN_MODE_I2C);
      }
      break;
    case PIN_MODE_SERIAL:
#ifdef FIRMATA_SERIAL_FEATURE
      serialFeature.handlePinMode(pin, PIN_MODE_SERIAL);
#endif
      break;
    default:
      Firmata.sendString("Unknown pin mode"); // TODO: put error msgs in EEPROM
  }
  // TODO: save status to EEPROM here, if changed
}

/*
 * Sets the value of an individual pin. Useful if you want to set a pin value but
 * are not tracking the digital port state.
 * Can only be used on pins configured as OUTPUT.
 * Cannot be used to enable pull-ups on Digital INPUT pins.
 */
void setPinValueCallback(byte pin, int value)
{
  if (pin &lt; TOTAL_PINS &amp;&amp; IS_PIN_DIGITAL(pin)) {
    if (Firmata.getPinMode(pin) == OUTPUT) {
      Firmata.setPinState(pin, value);
      digitalWrite(PIN_TO_DIGITAL(pin), value);
    }
  }
}

void analogWriteCallback(byte pin, int value)
{
  if (pin &lt; TOTAL_PINS) {
    switch (Firmata.getPinMode(pin)) {
      case PIN_MODE_SERVO:
        if (IS_PIN_DIGITAL(pin))
          servos[servoPinMap[pin]].write(value);
        Firmata.setPinState(pin, value);
        break;
      case PIN_MODE_PWM:
        if (IS_PIN_PWM(pin))
          analogWrite(PIN_TO_PWM(pin), value);
        Firmata.setPinState(pin, value);
        break;
    }
  }
}

void digitalWriteCallback(byte port, int value)
{
  byte pin, lastPin, pinValue, mask = 1, pinWriteMask = 0;

  if (port &lt; TOTAL_PORTS) {
    // create a mask of the pins on this port that are writable.
    lastPin = port * 8 + 8;
    if (lastPin &gt; TOTAL_PINS) lastPin = TOTAL_PINS;
    for (pin = port * 8; pin &lt; lastPin; pin++) {
      // do not disturb non-digital pins (eg, Rx &amp; Tx)
      if (IS_PIN_DIGITAL(pin)) {
        // do not touch pins in PWM, ANALOG, SERVO or other modes
        if (Firmata.getPinMode(pin) == OUTPUT || Firmata.getPinMode(pin) == INPUT) {
          pinValue = ((byte)value &amp; mask) ? 1 : 0;
          if (Firmata.getPinMode(pin) == OUTPUT) {
            pinWriteMask |= mask;
          } else if (Firmata.getPinMode(pin) == INPUT &amp;&amp; pinValue == 1 &amp;&amp; Firmata.getPinState(pin) != 1) {
            // only handle INPUT here for backwards compatibility
#if ARDUINO &gt; 100
            pinMode(pin, INPUT_PULLUP);
#else
            // only write to the INPUT pin to enable pullups if Arduino v1.0.0 or earlier
            pinWriteMask |= mask;
#endif
          }
          Firmata.setPinState(pin, pinValue);
        }
      }
      mask = mask &lt;&lt; 1;
    }
    writePort(port, (byte)value, pinWriteMask);
  }
}


// -----------------------------------------------------------------------------
/* sets bits in a bit array (int) to toggle the reporting of the analogIns
 */
//void FirmataClass::setAnalogPinReporting(byte pin, byte state) {
//}
void reportAnalogCallback(byte analogPin, int value)
{
  if (analogPin &lt; TOTAL_ANALOG_PINS) {
    if (value == 0) {
      analogInputsToReport = analogInputsToReport &amp; ~ (1 &lt;&lt; analogPin);
    } else {
      analogInputsToReport = analogInputsToReport | (1 &lt;&lt; analogPin);
      // prevent during system reset or all analog pin values will be reported
      // which may report noise for unconnected analog pins
      if (!isResetting) {
        // Send pin value immediately. This is helpful when connected via
        // ethernet, wi-fi or bluetooth so pin states can be known upon
        // reconnecting.
        Firmata.sendAnalog(analogPin, analogRead( ANALOG_TO_PIN(analogPin) ) );
      }
    }
  }
  // TODO: save status to EEPROM here, if changed
}

void reportDigitalCallback(byte port, int value)
{
  if (port &lt; TOTAL_PORTS) {
    reportPINs[port] = (byte)value;
    // Send port value immediately. This is helpful when connected via
    // ethernet, wi-fi or bluetooth so pin states can be known upon
    // reconnecting.
    if (value) outputPort(port, readPort(port, portConfigInputs[port]), true);
  }
  // do not disable analog reporting on these 8 pins, to allow some
  // pins used for digital, others analog.  Instead, allow both types
  // of reporting to be enabled, but check if the pin is configured
  // as analog when sampling the analog inputs.  Likewise, while
  // scanning digital pins, portConfigInputs will mask off values from any
  // pins configured as analog
}

/*==============================================================================
 * SYSEX-BASED commands
 *============================================================================*/

void sysexCallback(byte command, byte argc, byte *argv)
{
  byte mode;
  byte stopTX;
  byte slaveAddress;
  byte data;
  int slaveRegister;
  unsigned int delayTime;

  switch (command) {
    case I2C_REQUEST:
      mode = argv[1] &amp; I2C_READ_WRITE_MODE_MASK;
      if (argv[1] &amp; I2C_10BIT_ADDRESS_MODE_MASK) {
        Firmata.sendString("10-bit addressing not supported");
        return;
      }
      else {
        slaveAddress = argv[0];
      }

      // need to invert the logic here since 0 will be default for client
      // libraries that have not updated to add support for restart tx
      if (argv[1] &amp; I2C_END_TX_MASK) {
        stopTX = I2C_RESTART_TX;
      }
      else {
        stopTX = I2C_STOP_TX; // default
      }

      switch (mode) {
        case I2C_WRITE:
          Wire.beginTransmission(slaveAddress);
          for (byte i = 2; i &lt; argc; i += 2) {
            data = argv[i] + (argv[i + 1] &lt;&lt; 7);
            wireWrite(data);
          }
          Wire.endTransmission();
          delayMicroseconds(70);
          break;
        case I2C_READ:
          if (argc == 6) {
            // a slave register is specified
            slaveRegister = argv[2] + (argv[3] &lt;&lt; 7);
            data = argv[4] + (argv[5] &lt;&lt; 7);  // bytes to read
          }
          else {
            // a slave register is NOT specified
            slaveRegister = I2C_REGISTER_NOT_SPECIFIED;
            data = argv[2] + (argv[3] &lt;&lt; 7);  // bytes to read
          }
          readAndReportData(slaveAddress, (int)slaveRegister, data, stopTX);
          break;
        case I2C_READ_CONTINUOUSLY:
          if ((queryIndex + 1) &gt;= I2C_MAX_QUERIES) {
            // too many queries, just ignore
            Firmata.sendString("too many queries");
            break;
          }
          if (argc == 6) {
            // a slave register is specified
            slaveRegister = argv[2] + (argv[3] &lt;&lt; 7);
            data = argv[4] + (argv[5] &lt;&lt; 7);  // bytes to read
          }
          else {
            // a slave register is NOT specified
            slaveRegister = (int)I2C_REGISTER_NOT_SPECIFIED;
            data = argv[2] + (argv[3] &lt;&lt; 7);  // bytes to read
          }
          queryIndex++;
          query[queryIndex].addr = slaveAddress;
          query[queryIndex].reg = slaveRegister;
          query[queryIndex].bytes = data;
          query[queryIndex].stopTX = stopTX;
          break;
        case I2C_STOP_READING:
          byte queryIndexToSkip;
          // if read continuous mode is enabled for only 1 i2c device, disable
          // read continuous reporting for that device
          if (queryIndex &lt;= 0) {
            queryIndex = -1;
          } else {
            queryIndexToSkip = 0;
            // if read continuous mode is enabled for multiple devices,
            // determine which device to stop reading and remove it's data from
            // the array, shifiting other array data to fill the space
            for (byte i = 0; i &lt; queryIndex + 1; i++) {
              if (query[i].addr == slaveAddress) {
                queryIndexToSkip = i;
                break;
              }
            }

            for (byte i = queryIndexToSkip; i &lt; queryIndex + 1; i++) {
              if (i &lt; I2C_MAX_QUERIES) {
                query[i].addr = query[i + 1].addr;
                query[i].reg = query[i + 1].reg;
                query[i].bytes = query[i + 1].bytes;
                query[i].stopTX = query[i + 1].stopTX;
              }
            }
            queryIndex--;
          }
          break;
        default:
          break;
      }
      break;
    case I2C_CONFIG:
      delayTime = (argv[0] + (argv[1] &lt;&lt; 7));

      if (delayTime &gt; 0) {
        i2cReadDelayTime = delayTime;
      }

      if (!isI2CEnabled) {
        enableI2CPins();
      }

      break;
    case SERVO_CONFIG:
      if (argc &gt; 4) {
        // these vars are here for clarity, they'll optimized away by the compiler
        byte pin = argv[0];
        int minPulse = argv[1] + (argv[2] &lt;&lt; 7);
        int maxPulse = argv[3] + (argv[4] &lt;&lt; 7);

        if (IS_PIN_DIGITAL(pin)) {
          if (servoPinMap[pin] &lt; MAX_SERVOS &amp;&amp; servos[servoPinMap[pin]].attached()) {
            detachServo(pin);
          }
          attachServo(pin, minPulse, maxPulse);
          setPinModeCallback(pin, PIN_MODE_SERVO);
        }
      }
      break;
    case SAMPLING_INTERVAL:
      if (argc &gt; 1) {
        samplingInterval = argv[0] + (argv[1] &lt;&lt; 7);
        if (samplingInterval &lt; MINIMUM_SAMPLING_INTERVAL) {
          samplingInterval = MINIMUM_SAMPLING_INTERVAL;
        }
      } else {
        //Firmata.sendString("Not enough data");
      }
      break;
    case EXTENDED_ANALOG:
      if (argc &gt; 1) {
        int val = argv[1];
        if (argc &gt; 2) val |= (argv[2] &lt;&lt; 7);
        if (argc &gt; 3) val |= (argv[3] &lt;&lt; 14);
        analogWriteCallback(argv[0], val);
      }
      break;
    case CAPABILITY_QUERY:
      Firmata.write(START_SYSEX);
      Firmata.write(CAPABILITY_RESPONSE);
      for (byte pin = 0; pin &lt; TOTAL_PINS; pin++) {
        if (IS_PIN_DIGITAL(pin)) {
          Firmata.write((byte)INPUT);
          Firmata.write(1);
          Firmata.write((byte)PIN_MODE_PULLUP);
          Firmata.write(1);
          Firmata.write((byte)OUTPUT);
          Firmata.write(1);
        }
        if (IS_PIN_ANALOG(pin)) {
          Firmata.write(PIN_MODE_ANALOG);
          Firmata.write(10); // 10 = 10-bit resolution
        }
        if (IS_PIN_PWM(pin)) {
          Firmata.write(PIN_MODE_PWM);
          Firmata.write(DEFAULT_PWM_RESOLUTION);
        }
        if (IS_PIN_DIGITAL(pin)) {
          Firmata.write(PIN_MODE_SERVO);
          Firmata.write(14);
        }
        if (IS_PIN_I2C(pin)) {
          Firmata.write(PIN_MODE_I2C);
          Firmata.write(1);  // TODO: could assign a number to map to SCL or SDA
        }
#ifdef FIRMATA_SERIAL_FEATURE
        serialFeature.handleCapability(pin);
#endif
        Firmata.write(127);
      }
      Firmata.write(END_SYSEX);
      break;
    case PIN_STATE_QUERY:
      if (argc &gt; 0) {
        byte pin = argv[0];
        Firmata.write(START_SYSEX);
        Firmata.write(PIN_STATE_RESPONSE);
        Firmata.write(pin);
        if (pin &lt; TOTAL_PINS) {
          Firmata.write(Firmata.getPinMode(pin));
          Firmata.write((byte)Firmata.getPinState(pin) &amp; 0x7F);
          if (Firmata.getPinState(pin) &amp; 0xFF80) Firmata.write((byte)(Firmata.getPinState(pin) &gt;&gt; 7) &amp; 0x7F);
          if (Firmata.getPinState(pin) &amp; 0xC000) Firmata.write((byte)(Firmata.getPinState(pin) &gt;&gt; 14) &amp; 0x7F);
        }
        Firmata.write(END_SYSEX);
      }
      break;
    case ANALOG_MAPPING_QUERY:
      Firmata.write(START_SYSEX);
      Firmata.write(ANALOG_MAPPING_RESPONSE);
      for (byte pin = 0; pin &lt; TOTAL_PINS; pin++) {
        Firmata.write(IS_PIN_ANALOG(pin) ? PIN_TO_ANALOG(pin) : 127);
      }
      Firmata.write(END_SYSEX);
      break;

    case SERIAL_MESSAGE:
#ifdef FIRMATA_SERIAL_FEATURE
      serialFeature.handleSysex(command, argc, argv);
#endif
      break;
  }
}

/*==============================================================================
 * SETUP()
 *============================================================================*/

void systemResetCallback()
{
  isResetting = true;

  // initialize a defalt state
  // TODO: option to load config from EEPROM instead of default

#ifdef FIRMATA_SERIAL_FEATURE
  serialFeature.reset();
#endif

  if (isI2CEnabled) {
    disableI2CPins();
  }

  for (byte i = 0; i &lt; TOTAL_PORTS; i++) {
    reportPINs[i] = false;    // by default, reporting off
    portConfigInputs[i] = 0;  // until activated
    previousPINs[i] = 0;
  }

  for (byte i = 0; i &lt; TOTAL_PINS; i++) {
    // pins with analog capability default to analog input
    // otherwise, pins default to digital output
    if (IS_PIN_ANALOG(i)) {
      // turns off pullup, configures everything
      setPinModeCallback(i, PIN_MODE_ANALOG);
    } else if (IS_PIN_DIGITAL(i)) {
      // sets the output to 0, configures portConfigInputs
      setPinModeCallback(i, OUTPUT);
    }

    servoPinMap[i] = 255;
  }
  // by default, do not report any analog inputs
  analogInputsToReport = 0;

  detachedServoCount = 0;
  servoCount = 0;

  /* send digital inputs to set the initial state on the host computer,
   * since once in the loop(), this firmware will only send on change */
  /*
  TODO: this can never execute, since no pins default to digital input
        but it will be needed when/if we support EEPROM stored config
  for (byte i=0; i &lt; TOTAL_PORTS; i++) {
    outputPort(i, readPort(i, portConfigInputs[i]), true);
  }
  */
  isResetting = false;
}

void setup()
{
  Serial.begin(115200);
  while ( !Serial ) delay(10);   // for nrf52840 with native usb

  Serial.println("Bluefruit52 Standard Firmata via BLEUART Example");
  Serial.println("------------------------------------------------\n");

  // Config the peripheral connection with maximum bandwidth 
  // more SRAM required by SoftDevice
  // Note: All config***() function must be called before begin()
  Bluefruit.configPrphBandwidth(BANDWIDTH_MAX);
  
  Bluefruit.begin();
  Bluefruit.setName("Bluefruit52");
  Bluefruit.setTxPower(4);    // Check bluefruit.h for supported values
  
  // try to go as fast as possible, could be rejected by some central, increase it if needed
  // iOS won't negotitate and will mostly use 30ms
  Bluefruit.Periph.setConnInterval(9, 24); // min = 9*1.25=11.25 ms, max = 23*1.25=30ms
  
  // Configure and Start BLE Uart Service
  // Firmata use several small write(1) --&gt; buffering TXD is required to run smoothly
  // Enable buffering TXD
  bleuart.begin();
  bleuart.bufferTXD(true);
  
  Firmata.setFirmwareVersion(FIRMATA_FIRMWARE_MAJOR_VERSION, FIRMATA_FIRMWARE_MINOR_VERSION);

  Firmata.attach(ANALOG_MESSAGE, analogWriteCallback);
  Firmata.attach(DIGITAL_MESSAGE, digitalWriteCallback);
  Firmata.attach(REPORT_ANALOG, reportAnalogCallback);
  Firmata.attach(REPORT_DIGITAL, reportDigitalCallback);
  Firmata.attach(SET_PIN_MODE, setPinModeCallback);
  Firmata.attach(SET_DIGITAL_PIN_VALUE, setPinValueCallback);
  Firmata.attach(START_SYSEX, sysexCallback);
  Firmata.attach(SYSTEM_RESET, systemResetCallback);

  // use bleuart as transportation layer
  Firmata.begin(bleuart);

  // to use a port other than Serial, such as Serial1 on an Arduino Leonardo or Mega,
  // Call begin(baud) on the alternate serial port and pass it to Firmata to begin like this:
  // Serial1.begin(57600);
  // Firmata.begin(Serial1);
  // However do not do this if you are using SERIAL_MESSAGE

  //Firmata.begin(57600);
  //while (!Serial) {
  //  ; // wait for serial port to connect. Needed for ATmega32u4-based boards and Arduino 101
  //}

  systemResetCallback();  // reset to default config

  // Set up and start advertising
  startAdv();  
}

void startAdv(void)
{
  // Advertising packet
  Bluefruit.Advertising.addFlags(BLE_GAP_ADV_FLAGS_LE_ONLY_GENERAL_DISC_MODE);
  Bluefruit.Advertising.addTxPower();

  // Include bleuart 128-bit uuid
  Bluefruit.Advertising.addService(bleuart);

  // Secondary Scan Response packet (optional)
  // Since there is no room for 'Name' in Advertising packet
  Bluefruit.ScanResponse.addName();
  
  /* Start Advertising
   * - Enable auto advertising if disconnected
   * - Interval:  fast mode = 20 ms, slow mode = 152.5 ms
   * - Timeout for fast mode is 30 seconds
   * - Start(timeout) with timeout = 0 will advertise forever (until connected)
   * 
   * For recommended advertising interval
   * https://developer.apple.com/library/content/qa/qa1931/_index.html   
   */
  Bluefruit.Advertising.restartOnDisconnect(true);
  Bluefruit.Advertising.setInterval(32, 244);    // in unit of 0.625 ms
  Bluefruit.Advertising.setFastTimeout(30);      // number of seconds in fast mode
  Bluefruit.Advertising.start(0);                // 0 = Don't stop advertising after n seconds  
}

/*==============================================================================
 * LOOP()
 *============================================================================*/
void loop()
{
  // Skip if not connected and bleuart notification is not enabled
  if (  !(Bluefruit.connected() &amp;&amp; bleuart.notifyEnabled()) ) return;
  
  byte pin, analogPin;

  /* DIGITALREAD - as fast as possible, check for changes and output them to the
   * FTDI buffer using Serial.print()  */
  checkDigitalInputs();

  /* STREAMREAD - processing incoming messagse as soon as possible, while still
   * checking digital inputs.  */
  while (Firmata.available())
    Firmata.processInput();

  // TODO - ensure that Stream buffer doesn't go over 60 bytes

  currentMillis = millis();
  if (currentMillis - previousMillis &gt; samplingInterval) {
    previousMillis += samplingInterval;
    /* ANALOGREAD - do all analogReads() at the configured sampling interval */
    for (pin = 0; pin &lt; TOTAL_PINS; pin++) {
      if (IS_PIN_ANALOG(pin) &amp;&amp; Firmata.getPinMode(pin) == PIN_MODE_ANALOG) {
        analogPin = PIN_TO_ANALOG(pin);
        if (analogInputsToReport &amp; (1 &lt;&lt; analogPin)) {
          Firmata.sendAnalog(analogPin, analogRead( ANALOG_TO_PIN(analogPin) ));
        }
      }
    }
    // report i2c data for all device with read continuous mode enabled
    if (queryIndex &gt; -1) {
      for (byte i = 0; i &lt; queryIndex + 1; i++) {
        readAndReportData(query[i].addr, query[i].reg, query[i].bytes, query[i].stopTX);
      }
    }
  }

#ifdef FIRMATA_SERIAL_FEATURE
  serialFeature.update();
#endif

  // flush TXD since we use bufferTXD()
  bleuart.flushTXD();
}
</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="com">/*</span></li><li class="L1"><span class="com">  Firmata is a generic protocol for communicating with microcontrollers</span></li><li class="L2"><span class="com">  from software on a host computer. It is intended to work with</span></li><li class="L3"><span class="com">  any host computer software package.</span></li><li class="L4"><span class="com">&nbsp;</span></li><li class="L5"><span class="com">  To download a host software package, please click on the following link</span></li><li class="L6"><span class="com">  to open the list of Firmata client libraries in your default browser.</span></li><li class="L7"><span class="com">&nbsp;</span></li><li class="L8"><span class="com">  https://github.com/firmata/arduino#firmata-client-libraries</span></li><li class="L9"><span class="com">&nbsp;</span></li><li class="L0"><span class="com">  Copyright (C) 2006-2008 Hans-Christoph Steiner.  All rights reserved.</span></li><li class="L1"><span class="com">  Copyright (C) 2010-2011 Paul Stoffregen.  All rights reserved.</span></li><li class="L2"><span class="com">  Copyright (C) 2009 Shigeru Kobayashi.  All rights reserved.</span></li><li class="L3"><span class="com">  Copyright (C) 2009-2016 Jeff Hoefs.  All rights reserved.</span></li><li class="L4"><span class="com">&nbsp;</span></li><li class="L5"><span class="com">  This library is free software; you can redistribute it and/or</span></li><li class="L6"><span class="com">  modify it under the terms of the GNU Lesser General Public</span></li><li class="L7"><span class="com">  License as published by the Free Software Foundation; either</span></li><li class="L8"><span class="com">  version 2.1 of the License, or (at your option) any later version.</span></li><li class="L9"><span class="com">&nbsp;</span></li><li class="L0"><span class="com">  See file LICENSE.txt for further informations on licensing terms.</span></li><li class="L1"><span class="com">&nbsp;</span></li><li class="L2"><span class="com">  Last updated October 16th, 2016</span></li><li class="L3"><span class="com">*/</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="com">// Adafruit nRF52 Boards require Firmata at least 2.5.7</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;bluefruit.h&gt;</span></li><li class="L8"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;Servo.h&gt;</span></li><li class="L9"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;Wire.h&gt;</span></li><li class="L0"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;Firmata.h&gt;</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="com">#define</span><span class="pln"> I2C_WRITE                   B00000000</span></li><li class="L3"><span class="com">#define</span><span class="pln"> I2C_READ                    B00001000</span></li><li class="L4"><span class="com">#define</span><span class="pln"> I2C_READ_CONTINUOUSLY       B00010000</span></li><li class="L5"><span class="com">#define</span><span class="pln"> I2C_STOP_READING            B00011000</span></li><li class="L6"><span class="com">#define</span><span class="pln"> I2C_READ_WRITE_MODE_MASK    B00011000</span></li><li class="L7"><span class="com">#define</span><span class="pln"> I2C_10BIT_ADDRESS_MODE_MASK B00100000</span></li><li class="L8"><span class="com">#define</span><span class="pln"> I2C_END_TX_MASK             B01000000</span></li><li class="L9"><span class="com">#define</span><span class="pln"> I2C_STOP_TX                 </span><span class="lit">1</span></li><li class="L0"><span class="com">#define</span><span class="pln"> I2C_RESTART_TX              </span><span class="lit">0</span></li><li class="L1"><span class="com">#define</span><span class="pln"> I2C_MAX_QUERIES             </span><span class="lit">8</span></li><li class="L2"><span class="com">#define</span><span class="pln"> I2C_REGISTER_NOT_SPECIFIED  </span><span class="pun">-</span><span class="lit">1</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="com">// the minimum interval for sampling analog input</span></li><li class="L5"><span class="com">#define</span><span class="pln"> MINIMUM_SAMPLING_INTERVAL   </span><span class="lit">1</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="com">// Adafruit</span></li><li class="L8"><span class="typ">uint8_t</span><span class="pln"> ANALOG_TO_PIN</span><span class="pun">(</span><span class="typ">uint8_t</span><span class="pln"> n</span><span class="pun">)</span></li><li class="L9"><span class="pun">{</span></li><li class="L0"><span class="pln">  </span><span class="kwd">switch</span><span class="pln"> </span><span class="pun">(</span><span class="pln">n</span><span class="pun">)</span></li><li class="L1"><span class="pln">  </span><span class="pun">{</span></li><li class="L2"><span class="pln">    </span><span class="kwd">case</span><span class="pln"> </span><span class="lit">0</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> PIN_A0</span><span class="pun">;</span></li><li class="L3"><span class="pln">    </span><span class="kwd">case</span><span class="pln"> </span><span class="lit">1</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> PIN_A1</span><span class="pun">;</span></li><li class="L4"><span class="pln">    </span><span class="kwd">case</span><span class="pln"> </span><span class="lit">2</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> PIN_A2</span><span class="pun">;</span></li><li class="L5"><span class="pln">    </span><span class="kwd">case</span><span class="pln"> </span><span class="lit">3</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> PIN_A3</span><span class="pun">;</span></li><li class="L6"><span class="pln">    </span><span class="kwd">case</span><span class="pln"> </span><span class="lit">4</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> PIN_A4</span><span class="pun">;</span></li><li class="L7"><span class="pln">    </span><span class="kwd">case</span><span class="pln"> </span><span class="lit">5</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> PIN_A5</span><span class="pun">;</span></li><li class="L8"><span class="pln">    </span><span class="kwd">case</span><span class="pln"> </span><span class="lit">6</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> PIN_A6</span><span class="pun">;</span></li><li class="L9"><span class="pln">    </span><span class="kwd">case</span><span class="pln"> </span><span class="lit">7</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> PIN_A7</span><span class="pun">;</span></li><li class="L0"><span class="pln">  </span><span class="pun">}</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="pln">  </span><span class="kwd">return</span><span class="pln"> </span><span class="lit">127</span><span class="pun">;</span></li><li class="L3"><span class="pun">}</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="com">/*==============================================================================</span></li><li class="L7"><span class="com"> * GLOBAL VARIABLES</span></li><li class="L8"><span class="com"> *============================================================================*/</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="com">#ifdef</span><span class="pln"> FIRMATA_SERIAL_FEATURE</span></li><li class="L1"><span class="typ">SerialFirmata</span><span class="pln"> serialFeature</span><span class="pun">;</span></li><li class="L2"><span class="com">#endif</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="typ">BLEUart</span><span class="pln"> bleuart</span><span class="pun">;</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="com">/* analog inputs */</span></li><li class="L7"><span class="kwd">int</span><span class="pln"> analogInputsToReport </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span><span class="pln"> </span><span class="com">// bitwise array to store pin reporting</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="com">/* digital input ports */</span></li><li class="L0"><span class="kwd">byte</span><span class="pln"> reportPINs</span><span class="pun">[</span><span class="pln">TOTAL_PORTS</span><span class="pun">];</span><span class="pln">       </span><span class="com">// 1 = report this port, 0 = silence</span></li><li class="L1"><span class="kwd">byte</span><span class="pln"> previousPINs</span><span class="pun">[</span><span class="pln">TOTAL_PORTS</span><span class="pun">];</span><span class="pln">     </span><span class="com">// previous 8 bits sent</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="com">/* pins configuration */</span></li><li class="L4"><span class="kwd">byte</span><span class="pln"> portConfigInputs</span><span class="pun">[</span><span class="pln">TOTAL_PORTS</span><span class="pun">];</span><span class="pln"> </span><span class="com">// each bit: 1 = pin in INPUT, 0 = anything else</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="com">/* timer variables */</span></li><li class="L7"><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">long</span><span class="pln"> currentMillis</span><span class="pun">;</span><span class="pln">        </span><span class="com">// store the current value from millis()</span></li><li class="L8"><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">long</span><span class="pln"> previousMillis</span><span class="pun">;</span><span class="pln">       </span><span class="com">// for comparison with currentMillis</span></li><li class="L9"><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">int</span><span class="pln"> samplingInterval </span><span class="pun">=</span><span class="pln"> </span><span class="lit">19</span><span class="pun">;</span><span class="pln"> </span><span class="com">// how often to run the main loop (in ms)</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="com">/* i2c data */</span></li><li class="L2"><span class="kwd">struct</span><span class="pln"> i2c_device_info </span><span class="pun">{</span></li><li class="L3"><span class="pln">  </span><span class="kwd">byte</span><span class="pln"> addr</span><span class="pun">;</span></li><li class="L4"><span class="pln">  </span><span class="kwd">int</span><span class="pln"> reg</span><span class="pun">;</span></li><li class="L5"><span class="pln">  </span><span class="kwd">byte</span><span class="pln"> bytes</span><span class="pun">;</span></li><li class="L6"><span class="pln">  </span><span class="kwd">byte</span><span class="pln"> stopTX</span><span class="pun">;</span></li><li class="L7"><span class="pun">};</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="com">/* for i2c read continuous more */</span></li><li class="L0"><span class="pln">i2c_device_info query</span><span class="pun">[</span><span class="pln">I2C_MAX_QUERIES</span><span class="pun">];</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="kwd">byte</span><span class="pln"> i2cRxData</span><span class="pun">[</span><span class="lit">64</span><span class="pun">];</span></li><li class="L3"><span class="kwd">boolean</span><span class="pln"> isI2CEnabled </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">;</span></li><li class="L4"><span class="kwd">signed</span><span class="pln"> </span><span class="kwd">char</span><span class="pln"> queryIndex </span><span class="pun">=</span><span class="pln"> </span><span class="pun">-</span><span class="lit">1</span><span class="pun">;</span></li><li class="L5"><span class="com">// default delay time between i2c read request and Wire.requestFrom()</span></li><li class="L6"><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">int</span><span class="pln"> i2cReadDelayTime </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="typ">Servo</span><span class="pln"> servos</span><span class="pun">[</span><span class="pln">MAX_SERVOS</span><span class="pun">];</span></li><li class="L9"><span class="kwd">byte</span><span class="pln"> servoPinMap</span><span class="pun">[</span><span class="pln">TOTAL_PINS</span><span class="pun">];</span></li><li class="L0"><span class="kwd">byte</span><span class="pln"> detachedServos</span><span class="pun">[</span><span class="pln">MAX_SERVOS</span><span class="pun">];</span></li><li class="L1"><span class="kwd">byte</span><span class="pln"> detachedServoCount </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></li><li class="L2"><span class="kwd">byte</span><span class="pln"> servoCount </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="kwd">boolean</span><span class="pln"> isResetting </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">;</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="com">// Forward declare a few functions to avoid compiler errors with older versions</span></li><li class="L7"><span class="com">// of the Arduino IDE.</span></li><li class="L8"><span class="kwd">void</span><span class="pln"> setPinModeCallback</span><span class="pun">(</span><span class="kwd">byte</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">int</span><span class="pun">);</span></li><li class="L9"><span class="kwd">void</span><span class="pln"> reportAnalogCallback</span><span class="pun">(</span><span class="kwd">byte</span><span class="pln"> analogPin</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">int</span><span class="pln"> </span><span class="kwd">value</span><span class="pun">);</span></li><li class="L0"><span class="kwd">void</span><span class="pln"> sysexCallback</span><span class="pun">(</span><span class="kwd">byte</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">byte</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">byte</span><span class="pun">*);</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="com">/* utility functions */</span></li><li class="L3"><span class="kwd">void</span><span class="pln"> wireWrite</span><span class="pun">(</span><span class="kwd">byte</span><span class="pln"> data</span><span class="pun">)</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="com">#if ARDUINO &gt;= 100</span></li><li class="L6"><span class="pln">  </span><span class="typ">Wire</span><span class="pun">.</span><span class="pln">write</span><span class="pun">((</span><span class="kwd">byte</span><span class="pun">)</span><span class="pln">data</span><span class="pun">);</span></li><li class="L7"><span class="com">#else</span></li><li class="L8"><span class="pln">  </span><span class="typ">Wire</span><span class="pun">.</span><span class="pln">send</span><span class="pun">(</span><span class="pln">data</span><span class="pun">);</span></li><li class="L9"><span class="com">#endif</span></li><li class="L0"><span class="pun">}</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="kwd">byte</span><span class="pln"> wireRead</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span></li><li class="L3"><span class="pun">{</span></li><li class="L4"><span class="com">#if ARDUINO &gt;= 100</span></li><li class="L5"><span class="pln">  </span><span class="kwd">return</span><span class="pln"> </span><span class="typ">Wire</span><span class="pun">.</span><span class="pln">read</span><span class="pun">();</span></li><li class="L6"><span class="com">#else</span></li><li class="L7"><span class="pln">  </span><span class="kwd">return</span><span class="pln"> </span><span class="typ">Wire</span><span class="pun">.</span><span class="pln">receive</span><span class="pun">();</span></li><li class="L8"><span class="com">#endif</span></li><li class="L9"><span class="pun">}</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="com">/*==============================================================================</span></li><li class="L2"><span class="com"> * FUNCTIONS</span></li><li class="L3"><span class="com"> *============================================================================*/</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="kwd">void</span><span class="pln"> attachServo</span><span class="pun">(</span><span class="kwd">byte</span><span class="pln"> pin</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">int</span><span class="pln"> minPulse</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">int</span><span class="pln"> maxPulse</span><span class="pun">)</span></li><li class="L6"><span class="pun">{</span></li><li class="L7"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">servoCount </span><span class="pun">&lt;</span><span class="pln"> MAX_SERVOS</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L8"><span class="pln">    </span><span class="com">// reuse indexes of detached servos until all have been reallocated</span></li><li class="L9"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">detachedServoCount </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L0"><span class="pln">      servoPinMap</span><span class="pun">[</span><span class="pln">pin</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> detachedServos</span><span class="pun">[</span><span class="pln">detachedServoCount </span><span class="pun">-</span><span class="pln"> </span><span class="lit">1</span><span class="pun">];</span></li><li class="L1"><span class="pln">      </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">detachedServoCount </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span><span class="pln"> detachedServoCount</span><span class="pun">--;</span></li><li class="L2"><span class="pln">    </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span></li><li class="L3"><span class="pln">      servoPinMap</span><span class="pun">[</span><span class="pln">pin</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> servoCount</span><span class="pun">;</span></li><li class="L4"><span class="pln">      servoCount</span><span class="pun">++;</span></li><li class="L5"><span class="pln">    </span><span class="pun">}</span></li><li class="L6"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">minPulse </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">0</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> maxPulse </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L7"><span class="pln">      servos</span><span class="pun">[</span><span class="pln">servoPinMap</span><span class="pun">[</span><span class="pln">pin</span><span class="pun">]].</span><span class="pln">attach</span><span class="pun">(</span><span class="pln">PIN_TO_DIGITAL</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">),</span><span class="pln"> minPulse</span><span class="pun">,</span><span class="pln"> maxPulse</span><span class="pun">);</span></li><li class="L8"><span class="pln">    </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span></li><li class="L9"><span class="pln">      servos</span><span class="pun">[</span><span class="pln">servoPinMap</span><span class="pun">[</span><span class="pln">pin</span><span class="pun">]].</span><span class="pln">attach</span><span class="pun">(</span><span class="pln">PIN_TO_DIGITAL</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">));</span></li><li class="L0"><span class="pln">    </span><span class="pun">}</span></li><li class="L1"><span class="pln">  </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span></li><li class="L2"><span class="pln">    </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">sendString</span><span class="pun">(</span><span class="str">"Max servos attached"</span><span class="pun">);</span></li><li class="L3"><span class="pln">  </span><span class="pun">}</span></li><li class="L4"><span class="pun">}</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="kwd">void</span><span class="pln"> detachServo</span><span class="pun">(</span><span class="kwd">byte</span><span class="pln"> pin</span><span class="pun">)</span></li><li class="L7"><span class="pun">{</span></li><li class="L8"><span class="pln">  servos</span><span class="pun">[</span><span class="pln">servoPinMap</span><span class="pun">[</span><span class="pln">pin</span><span class="pun">]].</span><span class="pln">detach</span><span class="pun">();</span></li><li class="L9"><span class="pln">  </span><span class="com">// if we're detaching the last servo, decrement the count</span></li><li class="L0"><span class="pln">  </span><span class="com">// otherwise store the index of the detached servo</span></li><li class="L1"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">servoPinMap</span><span class="pun">[</span><span class="pln">pin</span><span class="pun">]</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> servoCount </span><span class="pun">&amp;&amp;</span><span class="pln"> servoCount </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L2"><span class="pln">    servoCount</span><span class="pun">--;</span></li><li class="L3"><span class="pln">  </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">servoCount </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L4"><span class="pln">    </span><span class="com">// keep track of detached servos because we want to reuse their indexes</span></li><li class="L5"><span class="pln">    </span><span class="com">// before incrementing the count of attached servos</span></li><li class="L6"><span class="pln">    detachedServoCount</span><span class="pun">++;</span></li><li class="L7"><span class="pln">    detachedServos</span><span class="pun">[</span><span class="pln">detachedServoCount </span><span class="pun">-</span><span class="pln"> </span><span class="lit">1</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> servoPinMap</span><span class="pun">[</span><span class="pln">pin</span><span class="pun">];</span></li><li class="L8"><span class="pln">  </span><span class="pun">}</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="pln">  servoPinMap</span><span class="pun">[</span><span class="pln">pin</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="lit">255</span><span class="pun">;</span></li><li class="L1"><span class="pun">}</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="kwd">void</span><span class="pln"> enableI2CPins</span><span class="pun">()</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="pln">  </span><span class="kwd">byte</span><span class="pln"> i</span><span class="pun">;</span></li><li class="L6"><span class="pln">  </span><span class="com">// is there a faster way to do this? would probaby require importing</span></li><li class="L7"><span class="pln">  </span><span class="com">// Arduino.h to get SCL and SDA pins</span></li><li class="L8"><span class="pln">  </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="pln">i </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span><span class="pln"> i </span><span class="pun">&lt;</span><span class="pln"> TOTAL_PINS</span><span class="pun">;</span><span class="pln"> i</span><span class="pun">++)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L9"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">IS_PIN_I2C</span><span class="pun">(</span><span class="pln">i</span><span class="pun">))</span><span class="pln"> </span><span class="pun">{</span></li><li class="L0"><span class="pln">      </span><span class="com">// mark pins as i2c so they are ignore in non i2c data requests</span></li><li class="L1"><span class="pln">      setPinModeCallback</span><span class="pun">(</span><span class="pln">i</span><span class="pun">,</span><span class="pln"> PIN_MODE_I2C</span><span class="pun">);</span></li><li class="L2"><span class="pln">    </span><span class="pun">}</span></li><li class="L3"><span class="pln">  </span><span class="pun">}</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">  isI2CEnabled </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">;</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="pln">  </span><span class="typ">Wire</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L8"><span class="pun">}</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="com">/* disable the i2c pins so they can be used for other functions */</span></li><li class="L1"><span class="kwd">void</span><span class="pln"> disableI2CPins</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span></li><li class="L2"><span class="pln">  isI2CEnabled </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">;</span></li><li class="L3"><span class="pln">  </span><span class="com">// disable read continuous mode for all devices</span></li><li class="L4"><span class="pln">  queryIndex </span><span class="pun">=</span><span class="pln"> </span><span class="pun">-</span><span class="lit">1</span><span class="pun">;</span></li><li class="L5"><span class="pun">}</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="kwd">void</span><span class="pln"> readAndReportData</span><span class="pun">(</span><span class="kwd">byte</span><span class="pln"> address</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">int</span><span class="pln"> theRegister</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">byte</span><span class="pln"> numBytes</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">byte</span><span class="pln"> stopTX</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L8"><span class="pln">  </span><span class="com">// allow I2C requests that don't require a register read</span></li><li class="L9"><span class="pln">  </span><span class="com">// for example, some devices using an interrupt pin to signify new data available</span></li><li class="L0"><span class="pln">  </span><span class="com">// do not always require the register read so upon interrupt you call Wire.requestFrom()</span></li><li class="L1"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">theRegister </span><span class="pun">!=</span><span class="pln"> I2C_REGISTER_NOT_SPECIFIED</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L2"><span class="pln">    </span><span class="typ">Wire</span><span class="pun">.</span><span class="pln">beginTransmission</span><span class="pun">(</span><span class="pln">address</span><span class="pun">);</span></li><li class="L3"><span class="pln">    wireWrite</span><span class="pun">((</span><span class="kwd">byte</span><span class="pun">)</span><span class="pln">theRegister</span><span class="pun">);</span></li><li class="L4"><span class="pln">    </span><span class="typ">Wire</span><span class="pun">.</span><span class="pln">endTransmission</span><span class="pun">(</span><span class="pln">stopTX</span><span class="pun">);</span><span class="pln"> </span><span class="com">// default = true</span></li><li class="L5"><span class="pln">    </span><span class="com">// do not set a value of 0</span></li><li class="L6"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">i2cReadDelayTime </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L7"><span class="pln">      </span><span class="com">// delay is necessary for some devices such as WiiNunchuck</span></li><li class="L8"><span class="pln">      delayMicroseconds</span><span class="pun">(</span><span class="pln">i2cReadDelayTime</span><span class="pun">);</span></li><li class="L9"><span class="pln">    </span><span class="pun">}</span></li><li class="L0"><span class="pln">  </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span></li><li class="L1"><span class="pln">    theRegister </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span><span class="pln">  </span><span class="com">// fill the register with a dummy value</span></li><li class="L2"><span class="pln">  </span><span class="pun">}</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln">  </span><span class="typ">Wire</span><span class="pun">.</span><span class="pln">requestFrom</span><span class="pun">(</span><span class="pln">address</span><span class="pun">,</span><span class="pln"> numBytes</span><span class="pun">);</span><span class="pln">  </span><span class="com">// all bytes are returned in requestFrom</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">  </span><span class="com">// check to be sure correct number of bytes were returned by slave</span></li><li class="L7"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">numBytes </span><span class="pun">&lt;</span><span class="pln"> </span><span class="typ">Wire</span><span class="pun">.</span><span class="pln">available</span><span class="pun">())</span><span class="pln"> </span><span class="pun">{</span></li><li class="L8"><span class="pln">    </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">sendString</span><span class="pun">(</span><span class="str">"I2C: Too many bytes received"</span><span class="pun">);</span></li><li class="L9"><span class="pln">  </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">numBytes </span><span class="pun">&gt;</span><span class="pln"> </span><span class="typ">Wire</span><span class="pun">.</span><span class="pln">available</span><span class="pun">())</span><span class="pln"> </span><span class="pun">{</span></li><li class="L0"><span class="pln">    </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">sendString</span><span class="pun">(</span><span class="str">"I2C: Too few bytes received"</span><span class="pun">);</span></li><li class="L1"><span class="pln">  </span><span class="pun">}</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="pln">  i2cRxData</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> address</span><span class="pun">;</span></li><li class="L4"><span class="pln">  i2cRxData</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> theRegister</span><span class="pun">;</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">  </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">int</span><span class="pln"> i </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span><span class="pln"> i </span><span class="pun">&lt;</span><span class="pln"> numBytes </span><span class="pun">&amp;&amp;</span><span class="pln"> </span><span class="typ">Wire</span><span class="pun">.</span><span class="pln">available</span><span class="pun">();</span><span class="pln"> i</span><span class="pun">++)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L7"><span class="pln">    i2cRxData</span><span class="pun">[</span><span class="lit">2</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> i</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> wireRead</span><span class="pun">();</span></li><li class="L8"><span class="pln">  </span><span class="pun">}</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="pln">  </span><span class="com">// send slave address, register and received bytes</span></li><li class="L1"><span class="pln">  </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">sendSysex</span><span class="pun">(</span><span class="pln">SYSEX_I2C_REPLY</span><span class="pun">,</span><span class="pln"> numBytes </span><span class="pun">+</span><span class="pln"> </span><span class="lit">2</span><span class="pun">,</span><span class="pln"> i2cRxData</span><span class="pun">);</span></li><li class="L2"><span class="pun">}</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="kwd">void</span><span class="pln"> outputPort</span><span class="pun">(</span><span class="kwd">byte</span><span class="pln"> portNumber</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">byte</span><span class="pln"> portValue</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">byte</span><span class="pln"> forceSend</span><span class="pun">)</span></li><li class="L5"><span class="pun">{</span></li><li class="L6"><span class="pln">  </span><span class="com">// pins not configured as INPUT are cleared to zeros</span></li><li class="L7"><span class="pln">  portValue </span><span class="pun">=</span><span class="pln"> portValue </span><span class="pun">&amp;</span><span class="pln"> portConfigInputs</span><span class="pun">[</span><span class="pln">portNumber</span><span class="pun">];</span></li><li class="L8"><span class="pln">  </span><span class="com">// only send if the value is different than previously sent</span></li><li class="L9"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">forceSend </span><span class="pun">||</span><span class="pln"> previousPINs</span><span class="pun">[</span><span class="pln">portNumber</span><span class="pun">]</span><span class="pln"> </span><span class="pun">!=</span><span class="pln"> portValue</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L0"><span class="pln">    </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">sendDigitalPort</span><span class="pun">(</span><span class="pln">portNumber</span><span class="pun">,</span><span class="pln"> portValue</span><span class="pun">);</span></li><li class="L1"><span class="pln">    previousPINs</span><span class="pun">[</span><span class="pln">portNumber</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> portValue</span><span class="pun">;</span></li><li class="L2"><span class="pln">  </span><span class="pun">}</span></li><li class="L3"><span class="pun">}</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="com">/* -----------------------------------------------------------------------------</span></li><li class="L6"><span class="com"> * check all the active digital inputs for change of state, then add any events</span></li><li class="L7"><span class="com"> * to the Serial output queue using Serial.print() */</span></li><li class="L8"><span class="kwd">void</span><span class="pln"> checkDigitalInputs</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span></li><li class="L9"><span class="pun">{</span></li><li class="L0"><span class="pln">  </span><span class="com">/* Using non-looping code allows constants to be given to readPort().</span></li><li class="L1"><span class="com">   * The compiler will apply substantial optimizations if the inputs</span></li><li class="L2"><span class="com">   * to readPort() are compile-time constants. */</span></li><li class="L3"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">TOTAL_PORTS </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">0</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> reportPINs</span><span class="pun">[</span><span class="lit">0</span><span class="pun">])</span><span class="pln"> outputPort</span><span class="pun">(</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> readPort</span><span class="pun">(</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> portConfigInputs</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]),</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">);</span></li><li class="L4"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">TOTAL_PORTS </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">1</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> reportPINs</span><span class="pun">[</span><span class="lit">1</span><span class="pun">])</span><span class="pln"> outputPort</span><span class="pun">(</span><span class="lit">1</span><span class="pun">,</span><span class="pln"> readPort</span><span class="pun">(</span><span class="lit">1</span><span class="pun">,</span><span class="pln"> portConfigInputs</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]),</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">);</span></li><li class="L5"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">TOTAL_PORTS </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">2</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> reportPINs</span><span class="pun">[</span><span class="lit">2</span><span class="pun">])</span><span class="pln"> outputPort</span><span class="pun">(</span><span class="lit">2</span><span class="pun">,</span><span class="pln"> readPort</span><span class="pun">(</span><span class="lit">2</span><span class="pun">,</span><span class="pln"> portConfigInputs</span><span class="pun">[</span><span class="lit">2</span><span class="pun">]),</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">);</span></li><li class="L6"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">TOTAL_PORTS </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">3</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> reportPINs</span><span class="pun">[</span><span class="lit">3</span><span class="pun">])</span><span class="pln"> outputPort</span><span class="pun">(</span><span class="lit">3</span><span class="pun">,</span><span class="pln"> readPort</span><span class="pun">(</span><span class="lit">3</span><span class="pun">,</span><span class="pln"> portConfigInputs</span><span class="pun">[</span><span class="lit">3</span><span class="pun">]),</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">);</span></li><li class="L7"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">TOTAL_PORTS </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">4</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> reportPINs</span><span class="pun">[</span><span class="lit">4</span><span class="pun">])</span><span class="pln"> outputPort</span><span class="pun">(</span><span class="lit">4</span><span class="pun">,</span><span class="pln"> readPort</span><span class="pun">(</span><span class="lit">4</span><span class="pun">,</span><span class="pln"> portConfigInputs</span><span class="pun">[</span><span class="lit">4</span><span class="pun">]),</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">);</span></li><li class="L8"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">TOTAL_PORTS </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">5</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> reportPINs</span><span class="pun">[</span><span class="lit">5</span><span class="pun">])</span><span class="pln"> outputPort</span><span class="pun">(</span><span class="lit">5</span><span class="pun">,</span><span class="pln"> readPort</span><span class="pun">(</span><span class="lit">5</span><span class="pun">,</span><span class="pln"> portConfigInputs</span><span class="pun">[</span><span class="lit">5</span><span class="pun">]),</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">);</span></li><li class="L9"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">TOTAL_PORTS </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">6</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> reportPINs</span><span class="pun">[</span><span class="lit">6</span><span class="pun">])</span><span class="pln"> outputPort</span><span class="pun">(</span><span class="lit">6</span><span class="pun">,</span><span class="pln"> readPort</span><span class="pun">(</span><span class="lit">6</span><span class="pun">,</span><span class="pln"> portConfigInputs</span><span class="pun">[</span><span class="lit">6</span><span class="pun">]),</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">);</span></li><li class="L0"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">TOTAL_PORTS </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">7</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> reportPINs</span><span class="pun">[</span><span class="lit">7</span><span class="pun">])</span><span class="pln"> outputPort</span><span class="pun">(</span><span class="lit">7</span><span class="pun">,</span><span class="pln"> readPort</span><span class="pun">(</span><span class="lit">7</span><span class="pun">,</span><span class="pln"> portConfigInputs</span><span class="pun">[</span><span class="lit">7</span><span class="pun">]),</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">);</span></li><li class="L1"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">TOTAL_PORTS </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">8</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> reportPINs</span><span class="pun">[</span><span class="lit">8</span><span class="pun">])</span><span class="pln"> outputPort</span><span class="pun">(</span><span class="lit">8</span><span class="pun">,</span><span class="pln"> readPort</span><span class="pun">(</span><span class="lit">8</span><span class="pun">,</span><span class="pln"> portConfigInputs</span><span class="pun">[</span><span class="lit">8</span><span class="pun">]),</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">);</span></li><li class="L2"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">TOTAL_PORTS </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">9</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> reportPINs</span><span class="pun">[</span><span class="lit">9</span><span class="pun">])</span><span class="pln"> outputPort</span><span class="pun">(</span><span class="lit">9</span><span class="pun">,</span><span class="pln"> readPort</span><span class="pun">(</span><span class="lit">9</span><span class="pun">,</span><span class="pln"> portConfigInputs</span><span class="pun">[</span><span class="lit">9</span><span class="pun">]),</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">);</span></li><li class="L3"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">TOTAL_PORTS </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">10</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> reportPINs</span><span class="pun">[</span><span class="lit">10</span><span class="pun">])</span><span class="pln"> outputPort</span><span class="pun">(</span><span class="lit">10</span><span class="pun">,</span><span class="pln"> readPort</span><span class="pun">(</span><span class="lit">10</span><span class="pun">,</span><span class="pln"> portConfigInputs</span><span class="pun">[</span><span class="lit">10</span><span class="pun">]),</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">);</span></li><li class="L4"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">TOTAL_PORTS </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">11</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> reportPINs</span><span class="pun">[</span><span class="lit">11</span><span class="pun">])</span><span class="pln"> outputPort</span><span class="pun">(</span><span class="lit">11</span><span class="pun">,</span><span class="pln"> readPort</span><span class="pun">(</span><span class="lit">11</span><span class="pun">,</span><span class="pln"> portConfigInputs</span><span class="pun">[</span><span class="lit">11</span><span class="pun">]),</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">);</span></li><li class="L5"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">TOTAL_PORTS </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">12</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> reportPINs</span><span class="pun">[</span><span class="lit">12</span><span class="pun">])</span><span class="pln"> outputPort</span><span class="pun">(</span><span class="lit">12</span><span class="pun">,</span><span class="pln"> readPort</span><span class="pun">(</span><span class="lit">12</span><span class="pun">,</span><span class="pln"> portConfigInputs</span><span class="pun">[</span><span class="lit">12</span><span class="pun">]),</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">);</span></li><li class="L6"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">TOTAL_PORTS </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">13</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> reportPINs</span><span class="pun">[</span><span class="lit">13</span><span class="pun">])</span><span class="pln"> outputPort</span><span class="pun">(</span><span class="lit">13</span><span class="pun">,</span><span class="pln"> readPort</span><span class="pun">(</span><span class="lit">13</span><span class="pun">,</span><span class="pln"> portConfigInputs</span><span class="pun">[</span><span class="lit">13</span><span class="pun">]),</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">);</span></li><li class="L7"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">TOTAL_PORTS </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">14</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> reportPINs</span><span class="pun">[</span><span class="lit">14</span><span class="pun">])</span><span class="pln"> outputPort</span><span class="pun">(</span><span class="lit">14</span><span class="pun">,</span><span class="pln"> readPort</span><span class="pun">(</span><span class="lit">14</span><span class="pun">,</span><span class="pln"> portConfigInputs</span><span class="pun">[</span><span class="lit">14</span><span class="pun">]),</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">);</span></li><li class="L8"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">TOTAL_PORTS </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">15</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> reportPINs</span><span class="pun">[</span><span class="lit">15</span><span class="pun">])</span><span class="pln"> outputPort</span><span class="pun">(</span><span class="lit">15</span><span class="pun">,</span><span class="pln"> readPort</span><span class="pun">(</span><span class="lit">15</span><span class="pun">,</span><span class="pln"> portConfigInputs</span><span class="pun">[</span><span class="lit">15</span><span class="pun">]),</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">);</span></li><li class="L9"><span class="pun">}</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="com">// -----------------------------------------------------------------------------</span></li><li class="L2"><span class="com">/* sets the pin mode to the correct state and sets the relevant bits in the</span></li><li class="L3"><span class="com"> * two bit-arrays that track Digital I/O and PWM status</span></li><li class="L4"><span class="com"> */</span></li><li class="L5"><span class="kwd">void</span><span class="pln"> setPinModeCallback</span><span class="pun">(</span><span class="kwd">byte</span><span class="pln"> pin</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">int</span><span class="pln"> mode</span><span class="pun">)</span></li><li class="L6"><span class="pun">{</span></li><li class="L7"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">getPinMode</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">)</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> PIN_MODE_IGNORE</span><span class="pun">)</span></li><li class="L8"><span class="pln">    </span><span class="kwd">return</span><span class="pun">;</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">getPinMode</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">)</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> PIN_MODE_I2C </span><span class="pun">&amp;&amp;</span><span class="pln"> isI2CEnabled </span><span class="pun">&amp;&amp;</span><span class="pln"> mode </span><span class="pun">!=</span><span class="pln"> PIN_MODE_I2C</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L1"><span class="pln">    </span><span class="com">// disable i2c so pins can be used for other functions</span></li><li class="L2"><span class="pln">    </span><span class="com">// the following if statements should reconfigure the pins properly</span></li><li class="L3"><span class="pln">    disableI2CPins</span><span class="pun">();</span></li><li class="L4"><span class="pln">  </span><span class="pun">}</span></li><li class="L5"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">IS_PIN_DIGITAL</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> mode </span><span class="pun">!=</span><span class="pln"> PIN_MODE_SERVO</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L6"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">servoPinMap</span><span class="pun">[</span><span class="pln">pin</span><span class="pun">]</span><span class="pln"> </span><span class="pun">&lt;</span><span class="pln"> MAX_SERVOS </span><span class="pun">&amp;&amp;</span><span class="pln"> servos</span><span class="pun">[</span><span class="pln">servoPinMap</span><span class="pun">[</span><span class="pln">pin</span><span class="pun">]].</span><span class="pln">attached</span><span class="pun">())</span><span class="pln"> </span><span class="pun">{</span></li><li class="L7"><span class="pln">      detachServo</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">);</span></li><li class="L8"><span class="pln">    </span><span class="pun">}</span></li><li class="L9"><span class="pln">  </span><span class="pun">}</span></li><li class="L0"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">IS_PIN_ANALOG</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">))</span><span class="pln"> </span><span class="pun">{</span></li><li class="L1"><span class="pln">    reportAnalogCallback</span><span class="pun">(</span><span class="pln">PIN_TO_ANALOG</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">),</span><span class="pln"> mode </span><span class="pun">==</span><span class="pln"> PIN_MODE_ANALOG </span><span class="pun">?</span><span class="pln"> </span><span class="lit">1</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> </span><span class="lit">0</span><span class="pun">);</span><span class="pln"> </span><span class="com">// turn on/off reporting</span></li><li class="L2"><span class="pln">  </span><span class="pun">}</span></li><li class="L3"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">IS_PIN_DIGITAL</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">))</span><span class="pln"> </span><span class="pun">{</span></li><li class="L4"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">mode </span><span class="pun">==</span><span class="pln"> INPUT </span><span class="pun">||</span><span class="pln"> mode </span><span class="pun">==</span><span class="pln"> PIN_MODE_PULLUP</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L5"><span class="pln">      portConfigInputs</span><span class="pun">[</span><span class="pln">pin </span><span class="pun">/</span><span class="pln"> </span><span class="lit">8</span><span class="pun">]</span><span class="pln"> </span><span class="pun">|=</span><span class="pln"> </span><span class="pun">(</span><span class="lit">1</span><span class="pln"> </span><span class="pun">&lt;&lt;</span><span class="pln"> </span><span class="pun">(</span><span class="pln">pin </span><span class="pun">&amp;</span><span class="pln"> </span><span class="lit">7</span><span class="pun">));</span></li><li class="L6"><span class="pln">    </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span></li><li class="L7"><span class="pln">      portConfigInputs</span><span class="pun">[</span><span class="pln">pin </span><span class="pun">/</span><span class="pln"> </span><span class="lit">8</span><span class="pun">]</span><span class="pln"> </span><span class="pun">&amp;=</span><span class="pln"> </span><span class="pun">~(</span><span class="lit">1</span><span class="pln"> </span><span class="pun">&lt;&lt;</span><span class="pln"> </span><span class="pun">(</span><span class="pln">pin </span><span class="pun">&amp;</span><span class="pln"> </span><span class="lit">7</span><span class="pun">));</span></li><li class="L8"><span class="pln">    </span><span class="pun">}</span></li><li class="L9"><span class="pln">  </span><span class="pun">}</span></li><li class="L0"><span class="pln">  </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">setPinState</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0</span><span class="pun">);</span></li><li class="L1"><span class="pln">  </span><span class="kwd">switch</span><span class="pln"> </span><span class="pun">(</span><span class="pln">mode</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L2"><span class="pln">    </span><span class="kwd">case</span><span class="pln"> PIN_MODE_ANALOG</span><span class="pun">:</span></li><li class="L3"><span class="pln">      </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">IS_PIN_ANALOG</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">))</span><span class="pln"> </span><span class="pun">{</span></li><li class="L4"><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">IS_PIN_DIGITAL</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">))</span><span class="pln"> </span><span class="pun">{</span></li><li class="L5"><span class="pln">          pinMode</span><span class="pun">(</span><span class="pln">PIN_TO_DIGITAL</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">),</span><span class="pln"> INPUT</span><span class="pun">);</span><span class="pln">    </span><span class="com">// disable output driver</span></li><li class="L6"><span class="com">#if ARDUINO &lt;= 100</span></li><li class="L7"><span class="pln">          </span><span class="com">// deprecated since Arduino 1.0.1 - TODO: drop support in Firmata 2.6</span></li><li class="L8"><span class="pln">          digitalWrite</span><span class="pun">(</span><span class="pln">PIN_TO_DIGITAL</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">),</span><span class="pln"> LOW</span><span class="pun">);</span><span class="pln"> </span><span class="com">// disable internal pull-ups</span></li><li class="L9"><span class="com">#endif</span></li><li class="L0"><span class="pln">        </span><span class="pun">}</span></li><li class="L1"><span class="pln">        </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">setPinMode</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">,</span><span class="pln"> PIN_MODE_ANALOG</span><span class="pun">);</span></li><li class="L2"><span class="pln">      </span><span class="pun">}</span></li><li class="L3"><span class="pln">      </span><span class="kwd">break</span><span class="pun">;</span></li><li class="L4"><span class="pln">    </span><span class="kwd">case</span><span class="pln"> INPUT</span><span class="pun">:</span></li><li class="L5"><span class="com">// Adafruit: Input without pull up cause pin state changes randomly --&gt; lots of transmission data     </span></li><li class="L6"><span class="com">//      if (IS_PIN_DIGITAL(pin)) {</span></li><li class="L7"><span class="com">//        pinMode(PIN_TO_DIGITAL(pin), INPUT);    // disable output driver</span></li><li class="L8"><span class="com">//#if ARDUINO &lt;= 100</span></li><li class="L9"><span class="com">//        // deprecated since Arduino 1.0.1 - TODO: drop support in Firmata 2.6</span></li><li class="L0"><span class="com">//        digitalWrite(PIN_TO_DIGITAL(pin), LOW); // disable internal pull-ups</span></li><li class="L1"><span class="com">//#endif</span></li><li class="L2"><span class="com">//        Firmata.setPinMode(pin, INPUT);</span></li><li class="L3"><span class="com">//      }</span></li><li class="L4"><span class="com">//      break;</span></li><li class="L5"><span class="pln">    </span><span class="kwd">case</span><span class="pln"> PIN_MODE_PULLUP</span><span class="pun">:</span></li><li class="L6"><span class="pln">      </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">IS_PIN_DIGITAL</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">))</span><span class="pln"> </span><span class="pun">{</span></li><li class="L7"><span class="pln">        pinMode</span><span class="pun">(</span><span class="pln">PIN_TO_DIGITAL</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">),</span><span class="pln"> INPUT_PULLUP</span><span class="pun">);</span></li><li class="L8"><span class="pln">        </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">setPinMode</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">,</span><span class="pln"> PIN_MODE_PULLUP</span><span class="pun">);</span></li><li class="L9"><span class="pln">        </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">setPinState</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">);</span></li><li class="L0"><span class="pln">      </span><span class="pun">}</span></li><li class="L1"><span class="pln">      </span><span class="kwd">break</span><span class="pun">;</span></li><li class="L2"><span class="pln">    </span><span class="kwd">case</span><span class="pln"> OUTPUT</span><span class="pun">:</span></li><li class="L3"><span class="pln">      </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">IS_PIN_DIGITAL</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">))</span><span class="pln"> </span><span class="pun">{</span></li><li class="L4"><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">getPinMode</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">)</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> PIN_MODE_PWM</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L5"><span class="pln">          </span><span class="com">// Disable PWM if pin mode was previously set to PWM.</span></li><li class="L6"><span class="pln">          digitalWrite</span><span class="pun">(</span><span class="pln">PIN_TO_DIGITAL</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">),</span><span class="pln"> LOW</span><span class="pun">);</span></li><li class="L7"><span class="pln">        </span><span class="pun">}</span></li><li class="L8"><span class="pln">        pinMode</span><span class="pun">(</span><span class="pln">PIN_TO_DIGITAL</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">),</span><span class="pln"> OUTPUT</span><span class="pun">);</span></li><li class="L9"><span class="pln">        </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">setPinMode</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">,</span><span class="pln"> OUTPUT</span><span class="pun">);</span></li><li class="L0"><span class="pln">      </span><span class="pun">}</span></li><li class="L1"><span class="pln">      </span><span class="kwd">break</span><span class="pun">;</span></li><li class="L2"><span class="pln">    </span><span class="kwd">case</span><span class="pln"> PIN_MODE_PWM</span><span class="pun">:</span></li><li class="L3"><span class="pln">      </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">IS_PIN_PWM</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">))</span><span class="pln"> </span><span class="pun">{</span></li><li class="L4"><span class="pln">        pinMode</span><span class="pun">(</span><span class="pln">PIN_TO_PWM</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">),</span><span class="pln"> OUTPUT</span><span class="pun">);</span></li><li class="L5"><span class="pln">        analogWrite</span><span class="pun">(</span><span class="pln">PIN_TO_PWM</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">),</span><span class="pln"> </span><span class="lit">0</span><span class="pun">);</span></li><li class="L6"><span class="pln">        </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">setPinMode</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">,</span><span class="pln"> PIN_MODE_PWM</span><span class="pun">);</span></li><li class="L7"><span class="pln">      </span><span class="pun">}</span></li><li class="L8"><span class="pln">      </span><span class="kwd">break</span><span class="pun">;</span></li><li class="L9"><span class="pln">    </span><span class="kwd">case</span><span class="pln"> PIN_MODE_SERVO</span><span class="pun">:</span></li><li class="L0"><span class="pln">      </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">IS_PIN_DIGITAL</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">))</span><span class="pln"> </span><span class="pun">{</span></li><li class="L1"><span class="pln">        </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">setPinMode</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">,</span><span class="pln"> PIN_MODE_SERVO</span><span class="pun">);</span></li><li class="L2"><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">servoPinMap</span><span class="pun">[</span><span class="pln">pin</span><span class="pun">]</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">255</span><span class="pln"> </span><span class="pun">||</span><span class="pln"> </span><span class="pun">!</span><span class="pln">servos</span><span class="pun">[</span><span class="pln">servoPinMap</span><span class="pun">[</span><span class="pln">pin</span><span class="pun">]].</span><span class="pln">attached</span><span class="pun">())</span><span class="pln"> </span><span class="pun">{</span></li><li class="L3"><span class="pln">          </span><span class="com">// pass -1 for min and max pulse values to use default values set</span></li><li class="L4"><span class="pln">          </span><span class="com">// by Servo library</span></li><li class="L5"><span class="pln">          attachServo</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">,</span><span class="pln"> </span><span class="pun">-</span><span class="lit">1</span><span class="pun">,</span><span class="pln"> </span><span class="pun">-</span><span class="lit">1</span><span class="pun">);</span></li><li class="L6"><span class="pln">        </span><span class="pun">}</span></li><li class="L7"><span class="pln">      </span><span class="pun">}</span></li><li class="L8"><span class="pln">      </span><span class="kwd">break</span><span class="pun">;</span></li><li class="L9"><span class="pln">    </span><span class="kwd">case</span><span class="pln"> PIN_MODE_I2C</span><span class="pun">:</span></li><li class="L0"><span class="pln">      </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">IS_PIN_I2C</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">))</span><span class="pln"> </span><span class="pun">{</span></li><li class="L1"><span class="pln">        </span><span class="com">// mark the pin as i2c</span></li><li class="L2"><span class="pln">        </span><span class="com">// the user must call I2C_CONFIG to enable I2C for a device</span></li><li class="L3"><span class="pln">        </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">setPinMode</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">,</span><span class="pln"> PIN_MODE_I2C</span><span class="pun">);</span></li><li class="L4"><span class="pln">      </span><span class="pun">}</span></li><li class="L5"><span class="pln">      </span><span class="kwd">break</span><span class="pun">;</span></li><li class="L6"><span class="pln">    </span><span class="kwd">case</span><span class="pln"> PIN_MODE_SERIAL</span><span class="pun">:</span></li><li class="L7"><span class="com">#ifdef</span><span class="pln"> FIRMATA_SERIAL_FEATURE</span></li><li class="L8"><span class="pln">      serialFeature</span><span class="pun">.</span><span class="pln">handlePinMode</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">,</span><span class="pln"> PIN_MODE_SERIAL</span><span class="pun">);</span></li><li class="L9"><span class="com">#endif</span></li><li class="L0"><span class="pln">      </span><span class="kwd">break</span><span class="pun">;</span></li><li class="L1"><span class="pln">    </span><span class="kwd">default</span><span class="pun">:</span></li><li class="L2"><span class="pln">      </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">sendString</span><span class="pun">(</span><span class="str">"Unknown pin mode"</span><span class="pun">);</span><span class="pln"> </span><span class="com">// TODO: put error msgs in EEPROM</span></li><li class="L3"><span class="pln">  </span><span class="pun">}</span></li><li class="L4"><span class="pln">  </span><span class="com">// TODO: save status to EEPROM here, if changed</span></li><li class="L5"><span class="pun">}</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="com">/*</span></li><li class="L8"><span class="com"> * Sets the value of an individual pin. Useful if you want to set a pin value but</span></li><li class="L9"><span class="com"> * are not tracking the digital port state.</span></li><li class="L0"><span class="com"> * Can only be used on pins configured as OUTPUT.</span></li><li class="L1"><span class="com"> * Cannot be used to enable pull-ups on Digital INPUT pins.</span></li><li class="L2"><span class="com"> */</span></li><li class="L3"><span class="kwd">void</span><span class="pln"> setPinValueCallback</span><span class="pun">(</span><span class="kwd">byte</span><span class="pln"> pin</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">int</span><span class="pln"> </span><span class="kwd">value</span><span class="pun">)</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">pin </span><span class="pun">&lt;</span><span class="pln"> TOTAL_PINS </span><span class="pun">&amp;&amp;</span><span class="pln"> IS_PIN_DIGITAL</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">))</span><span class="pln"> </span><span class="pun">{</span></li><li class="L6"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">getPinMode</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">)</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> OUTPUT</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L7"><span class="pln">      </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">setPinState</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">value</span><span class="pun">);</span></li><li class="L8"><span class="pln">      digitalWrite</span><span class="pun">(</span><span class="pln">PIN_TO_DIGITAL</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">),</span><span class="pln"> </span><span class="kwd">value</span><span class="pun">);</span></li><li class="L9"><span class="pln">    </span><span class="pun">}</span></li><li class="L0"><span class="pln">  </span><span class="pun">}</span></li><li class="L1"><span class="pun">}</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="kwd">void</span><span class="pln"> analogWriteCallback</span><span class="pun">(</span><span class="kwd">byte</span><span class="pln"> pin</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">int</span><span class="pln"> </span><span class="kwd">value</span><span class="pun">)</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">pin </span><span class="pun">&lt;</span><span class="pln"> TOTAL_PINS</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L6"><span class="pln">    </span><span class="kwd">switch</span><span class="pln"> </span><span class="pun">(</span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">getPinMode</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">))</span><span class="pln"> </span><span class="pun">{</span></li><li class="L7"><span class="pln">      </span><span class="kwd">case</span><span class="pln"> PIN_MODE_SERVO</span><span class="pun">:</span></li><li class="L8"><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">IS_PIN_DIGITAL</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">))</span></li><li class="L9"><span class="pln">          servos</span><span class="pun">[</span><span class="pln">servoPinMap</span><span class="pun">[</span><span class="pln">pin</span><span class="pun">]].</span><span class="pln">write</span><span class="pun">(</span><span class="kwd">value</span><span class="pun">);</span></li><li class="L0"><span class="pln">        </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">setPinState</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">value</span><span class="pun">);</span></li><li class="L1"><span class="pln">        </span><span class="kwd">break</span><span class="pun">;</span></li><li class="L2"><span class="pln">      </span><span class="kwd">case</span><span class="pln"> PIN_MODE_PWM</span><span class="pun">:</span></li><li class="L3"><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">IS_PIN_PWM</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">))</span></li><li class="L4"><span class="pln">          analogWrite</span><span class="pun">(</span><span class="pln">PIN_TO_PWM</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">),</span><span class="pln"> </span><span class="kwd">value</span><span class="pun">);</span></li><li class="L5"><span class="pln">        </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">setPinState</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">value</span><span class="pun">);</span></li><li class="L6"><span class="pln">        </span><span class="kwd">break</span><span class="pun">;</span></li><li class="L7"><span class="pln">    </span><span class="pun">}</span></li><li class="L8"><span class="pln">  </span><span class="pun">}</span></li><li class="L9"><span class="pun">}</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="kwd">void</span><span class="pln"> digitalWriteCallback</span><span class="pun">(</span><span class="kwd">byte</span><span class="pln"> port</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">int</span><span class="pln"> </span><span class="kwd">value</span><span class="pun">)</span></li><li class="L2"><span class="pun">{</span></li><li class="L3"><span class="pln">  </span><span class="kwd">byte</span><span class="pln"> pin</span><span class="pun">,</span><span class="pln"> lastPin</span><span class="pun">,</span><span class="pln"> pinValue</span><span class="pun">,</span><span class="pln"> mask </span><span class="pun">=</span><span class="pln"> </span><span class="lit">1</span><span class="pun">,</span><span class="pln"> pinWriteMask </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">port </span><span class="pun">&lt;</span><span class="pln"> TOTAL_PORTS</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L6"><span class="pln">    </span><span class="com">// create a mask of the pins on this port that are writable.</span></li><li class="L7"><span class="pln">    lastPin </span><span class="pun">=</span><span class="pln"> port </span><span class="pun">*</span><span class="pln"> </span><span class="lit">8</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="lit">8</span><span class="pun">;</span></li><li class="L8"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">lastPin </span><span class="pun">&gt;</span><span class="pln"> TOTAL_PINS</span><span class="pun">)</span><span class="pln"> lastPin </span><span class="pun">=</span><span class="pln"> TOTAL_PINS</span><span class="pun">;</span></li><li class="L9"><span class="pln">    </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="pln">pin </span><span class="pun">=</span><span class="pln"> port </span><span class="pun">*</span><span class="pln"> </span><span class="lit">8</span><span class="pun">;</span><span class="pln"> pin </span><span class="pun">&lt;</span><span class="pln"> lastPin</span><span class="pun">;</span><span class="pln"> pin</span><span class="pun">++)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L0"><span class="pln">      </span><span class="com">// do not disturb non-digital pins (eg, Rx &amp; Tx)</span></li><li class="L1"><span class="pln">      </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">IS_PIN_DIGITAL</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">))</span><span class="pln"> </span><span class="pun">{</span></li><li class="L2"><span class="pln">        </span><span class="com">// do not touch pins in PWM, ANALOG, SERVO or other modes</span></li><li class="L3"><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">getPinMode</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">)</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> OUTPUT </span><span class="pun">||</span><span class="pln"> </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">getPinMode</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">)</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> INPUT</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L4"><span class="pln">          pinValue </span><span class="pun">=</span><span class="pln"> </span><span class="pun">((</span><span class="kwd">byte</span><span class="pun">)</span><span class="kwd">value</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln"> mask</span><span class="pun">)</span><span class="pln"> </span><span class="pun">?</span><span class="pln"> </span><span class="lit">1</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></li><li class="L5"><span class="pln">          </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">getPinMode</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">)</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> OUTPUT</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L6"><span class="pln">            pinWriteMask </span><span class="pun">|=</span><span class="pln"> mask</span><span class="pun">;</span></li><li class="L7"><span class="pln">          </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">getPinMode</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">)</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> INPUT </span><span class="pun">&amp;&amp;</span><span class="pln"> pinValue </span><span class="pun">==</span><span class="pln"> </span><span class="lit">1</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">getPinState</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">)</span><span class="pln"> </span><span class="pun">!=</span><span class="pln"> </span><span class="lit">1</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L8"><span class="pln">            </span><span class="com">// only handle INPUT here for backwards compatibility</span></li><li class="L9"><span class="com">#if ARDUINO &gt; 100</span></li><li class="L0"><span class="pln">            pinMode</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">,</span><span class="pln"> INPUT_PULLUP</span><span class="pun">);</span></li><li class="L1"><span class="com">#else</span></li><li class="L2"><span class="pln">            </span><span class="com">// only write to the INPUT pin to enable pullups if Arduino v1.0.0 or earlier</span></li><li class="L3"><span class="pln">            pinWriteMask </span><span class="pun">|=</span><span class="pln"> mask</span><span class="pun">;</span></li><li class="L4"><span class="com">#endif</span></li><li class="L5"><span class="pln">          </span><span class="pun">}</span></li><li class="L6"><span class="pln">          </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">setPinState</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">,</span><span class="pln"> pinValue</span><span class="pun">);</span></li><li class="L7"><span class="pln">        </span><span class="pun">}</span></li><li class="L8"><span class="pln">      </span><span class="pun">}</span></li><li class="L9"><span class="pln">      mask </span><span class="pun">=</span><span class="pln"> mask </span><span class="pun">&lt;&lt;</span><span class="pln"> </span><span class="lit">1</span><span class="pun">;</span></li><li class="L0"><span class="pln">    </span><span class="pun">}</span></li><li class="L1"><span class="pln">    writePort</span><span class="pun">(</span><span class="pln">port</span><span class="pun">,</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">byte</span><span class="pun">)</span><span class="kwd">value</span><span class="pun">,</span><span class="pln"> pinWriteMask</span><span class="pun">);</span></li><li class="L2"><span class="pln">  </span><span class="pun">}</span></li><li class="L3"><span class="pun">}</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="com">// -----------------------------------------------------------------------------</span></li><li class="L7"><span class="com">/* sets bits in a bit array (int) to toggle the reporting of the analogIns</span></li><li class="L8"><span class="com"> */</span></li><li class="L9"><span class="com">//void FirmataClass::setAnalogPinReporting(byte pin, byte state) {</span></li><li class="L0"><span class="com">//}</span></li><li class="L1"><span class="kwd">void</span><span class="pln"> reportAnalogCallback</span><span class="pun">(</span><span class="kwd">byte</span><span class="pln"> analogPin</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">int</span><span class="pln"> </span><span class="kwd">value</span><span class="pun">)</span></li><li class="L2"><span class="pun">{</span></li><li class="L3"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">analogPin </span><span class="pun">&lt;</span><span class="pln"> TOTAL_ANALOG_PINS</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L4"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">value</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L5"><span class="pln">      analogInputsToReport </span><span class="pun">=</span><span class="pln"> analogInputsToReport </span><span class="pun">&amp;</span><span class="pln"> </span><span class="pun">~</span><span class="pln"> </span><span class="pun">(</span><span class="lit">1</span><span class="pln"> </span><span class="pun">&lt;&lt;</span><span class="pln"> analogPin</span><span class="pun">);</span></li><li class="L6"><span class="pln">    </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span></li><li class="L7"><span class="pln">      analogInputsToReport </span><span class="pun">=</span><span class="pln"> analogInputsToReport </span><span class="pun">|</span><span class="pln"> </span><span class="pun">(</span><span class="lit">1</span><span class="pln"> </span><span class="pun">&lt;&lt;</span><span class="pln"> analogPin</span><span class="pun">);</span></li><li class="L8"><span class="pln">      </span><span class="com">// prevent during system reset or all analog pin values will be reported</span></li><li class="L9"><span class="pln">      </span><span class="com">// which may report noise for unconnected analog pins</span></li><li class="L0"><span class="pln">      </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(!</span><span class="pln">isResetting</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L1"><span class="pln">        </span><span class="com">// Send pin value immediately. This is helpful when connected via</span></li><li class="L2"><span class="pln">        </span><span class="com">// ethernet, wi-fi or bluetooth so pin states can be known upon</span></li><li class="L3"><span class="pln">        </span><span class="com">// reconnecting.</span></li><li class="L4"><span class="pln">        </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">sendAnalog</span><span class="pun">(</span><span class="pln">analogPin</span><span class="pun">,</span><span class="pln"> analogRead</span><span class="pun">(</span><span class="pln"> ANALOG_TO_PIN</span><span class="pun">(</span><span class="pln">analogPin</span><span class="pun">)</span><span class="pln"> </span><span class="pun">)</span><span class="pln"> </span><span class="pun">);</span></li><li class="L5"><span class="pln">      </span><span class="pun">}</span></li><li class="L6"><span class="pln">    </span><span class="pun">}</span></li><li class="L7"><span class="pln">  </span><span class="pun">}</span></li><li class="L8"><span class="pln">  </span><span class="com">// TODO: save status to EEPROM here, if changed</span></li><li class="L9"><span class="pun">}</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="kwd">void</span><span class="pln"> reportDigitalCallback</span><span class="pun">(</span><span class="kwd">byte</span><span class="pln"> port</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">int</span><span class="pln"> </span><span class="kwd">value</span><span class="pun">)</span></li><li class="L2"><span class="pun">{</span></li><li class="L3"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">port </span><span class="pun">&lt;</span><span class="pln"> TOTAL_PORTS</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L4"><span class="pln">    reportPINs</span><span class="pun">[</span><span class="pln">port</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">byte</span><span class="pun">)</span><span class="kwd">value</span><span class="pun">;</span></li><li class="L5"><span class="pln">    </span><span class="com">// Send port value immediately. This is helpful when connected via</span></li><li class="L6"><span class="pln">    </span><span class="com">// ethernet, wi-fi or bluetooth so pin states can be known upon</span></li><li class="L7"><span class="pln">    </span><span class="com">// reconnecting.</span></li><li class="L8"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">value</span><span class="pun">)</span><span class="pln"> outputPort</span><span class="pun">(</span><span class="pln">port</span><span class="pun">,</span><span class="pln"> readPort</span><span class="pun">(</span><span class="pln">port</span><span class="pun">,</span><span class="pln"> portConfigInputs</span><span class="pun">[</span><span class="pln">port</span><span class="pun">]),</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">);</span></li><li class="L9"><span class="pln">  </span><span class="pun">}</span></li><li class="L0"><span class="pln">  </span><span class="com">// do not disable analog reporting on these 8 pins, to allow some</span></li><li class="L1"><span class="pln">  </span><span class="com">// pins used for digital, others analog.  Instead, allow both types</span></li><li class="L2"><span class="pln">  </span><span class="com">// of reporting to be enabled, but check if the pin is configured</span></li><li class="L3"><span class="pln">  </span><span class="com">// as analog when sampling the analog inputs.  Likewise, while</span></li><li class="L4"><span class="pln">  </span><span class="com">// scanning digital pins, portConfigInputs will mask off values from any</span></li><li class="L5"><span class="pln">  </span><span class="com">// pins configured as analog</span></li><li class="L6"><span class="pun">}</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="com">/*==============================================================================</span></li><li class="L9"><span class="com"> * SYSEX-BASED commands</span></li><li class="L0"><span class="com"> *============================================================================*/</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="kwd">void</span><span class="pln"> sysexCallback</span><span class="pun">(</span><span class="kwd">byte</span><span class="pln"> command</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">byte</span><span class="pln"> argc</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">byte</span><span class="pln"> </span><span class="pun">*</span><span class="pln">argv</span><span class="pun">)</span></li><li class="L3"><span class="pun">{</span></li><li class="L4"><span class="pln">  </span><span class="kwd">byte</span><span class="pln"> mode</span><span class="pun">;</span></li><li class="L5"><span class="pln">  </span><span class="kwd">byte</span><span class="pln"> stopTX</span><span class="pun">;</span></li><li class="L6"><span class="pln">  </span><span class="kwd">byte</span><span class="pln"> slaveAddress</span><span class="pun">;</span></li><li class="L7"><span class="pln">  </span><span class="kwd">byte</span><span class="pln"> data</span><span class="pun">;</span></li><li class="L8"><span class="pln">  </span><span class="kwd">int</span><span class="pln"> slaveRegister</span><span class="pun">;</span></li><li class="L9"><span class="pln">  </span><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">int</span><span class="pln"> delayTime</span><span class="pun">;</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">  </span><span class="kwd">switch</span><span class="pln"> </span><span class="pun">(</span><span class="pln">command</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L2"><span class="pln">    </span><span class="kwd">case</span><span class="pln"> I2C_REQUEST</span><span class="pun">:</span></li><li class="L3"><span class="pln">      mode </span><span class="pun">=</span><span class="pln"> argv</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln"> I2C_READ_WRITE_MODE_MASK</span><span class="pun">;</span></li><li class="L4"><span class="pln">      </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">argv</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln"> I2C_10BIT_ADDRESS_MODE_MASK</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L5"><span class="pln">        </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">sendString</span><span class="pun">(</span><span class="str">"10-bit addressing not supported"</span><span class="pun">);</span></li><li class="L6"><span class="pln">        </span><span class="kwd">return</span><span class="pun">;</span></li><li class="L7"><span class="pln">      </span><span class="pun">}</span></li><li class="L8"><span class="pln">      </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span></li><li class="L9"><span class="pln">        slaveAddress </span><span class="pun">=</span><span class="pln"> argv</span><span class="pun">[</span><span class="lit">0</span><span class="pun">];</span></li><li class="L0"><span class="pln">      </span><span class="pun">}</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="pln">      </span><span class="com">// need to invert the logic here since 0 will be default for client</span></li><li class="L3"><span class="pln">      </span><span class="com">// libraries that have not updated to add support for restart tx</span></li><li class="L4"><span class="pln">      </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">argv</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln"> I2C_END_TX_MASK</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L5"><span class="pln">        stopTX </span><span class="pun">=</span><span class="pln"> I2C_RESTART_TX</span><span class="pun">;</span></li><li class="L6"><span class="pln">      </span><span class="pun">}</span></li><li class="L7"><span class="pln">      </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span></li><li class="L8"><span class="pln">        stopTX </span><span class="pun">=</span><span class="pln"> I2C_STOP_TX</span><span class="pun">;</span><span class="pln"> </span><span class="com">// default</span></li><li class="L9"><span class="pln">      </span><span class="pun">}</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">      </span><span class="kwd">switch</span><span class="pln"> </span><span class="pun">(</span><span class="pln">mode</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L2"><span class="pln">        </span><span class="kwd">case</span><span class="pln"> I2C_WRITE</span><span class="pun">:</span></li><li class="L3"><span class="pln">          </span><span class="typ">Wire</span><span class="pun">.</span><span class="pln">beginTransmission</span><span class="pun">(</span><span class="pln">slaveAddress</span><span class="pun">);</span></li><li class="L4"><span class="pln">          </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">byte</span><span class="pln"> i </span><span class="pun">=</span><span class="pln"> </span><span class="lit">2</span><span class="pun">;</span><span class="pln"> i </span><span class="pun">&lt;</span><span class="pln"> argc</span><span class="pun">;</span><span class="pln"> i </span><span class="pun">+=</span><span class="pln"> </span><span class="lit">2</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L5"><span class="pln">            data </span><span class="pun">=</span><span class="pln"> argv</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="pun">(</span><span class="pln">argv</span><span class="pun">[</span><span class="pln">i </span><span class="pun">+</span><span class="pln"> </span><span class="lit">1</span><span class="pun">]</span><span class="pln"> </span><span class="pun">&lt;&lt;</span><span class="pln"> </span><span class="lit">7</span><span class="pun">);</span></li><li class="L6"><span class="pln">            wireWrite</span><span class="pun">(</span><span class="pln">data</span><span class="pun">);</span></li><li class="L7"><span class="pln">          </span><span class="pun">}</span></li><li class="L8"><span class="pln">          </span><span class="typ">Wire</span><span class="pun">.</span><span class="pln">endTransmission</span><span class="pun">();</span></li><li class="L9"><span class="pln">          delayMicroseconds</span><span class="pun">(</span><span class="lit">70</span><span class="pun">);</span></li><li class="L0"><span class="pln">          </span><span class="kwd">break</span><span class="pun">;</span></li><li class="L1"><span class="pln">        </span><span class="kwd">case</span><span class="pln"> I2C_READ</span><span class="pun">:</span></li><li class="L2"><span class="pln">          </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">argc </span><span class="pun">==</span><span class="pln"> </span><span class="lit">6</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L3"><span class="pln">            </span><span class="com">// a slave register is specified</span></li><li class="L4"><span class="pln">            slaveRegister </span><span class="pun">=</span><span class="pln"> argv</span><span class="pun">[</span><span class="lit">2</span><span class="pun">]</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="pun">(</span><span class="pln">argv</span><span class="pun">[</span><span class="lit">3</span><span class="pun">]</span><span class="pln"> </span><span class="pun">&lt;&lt;</span><span class="pln"> </span><span class="lit">7</span><span class="pun">);</span></li><li class="L5"><span class="pln">            data </span><span class="pun">=</span><span class="pln"> argv</span><span class="pun">[</span><span class="lit">4</span><span class="pun">]</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="pun">(</span><span class="pln">argv</span><span class="pun">[</span><span class="lit">5</span><span class="pun">]</span><span class="pln"> </span><span class="pun">&lt;&lt;</span><span class="pln"> </span><span class="lit">7</span><span class="pun">);</span><span class="pln">  </span><span class="com">// bytes to read</span></li><li class="L6"><span class="pln">          </span><span class="pun">}</span></li><li class="L7"><span class="pln">          </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span></li><li class="L8"><span class="pln">            </span><span class="com">// a slave register is NOT specified</span></li><li class="L9"><span class="pln">            slaveRegister </span><span class="pun">=</span><span class="pln"> I2C_REGISTER_NOT_SPECIFIED</span><span class="pun">;</span></li><li class="L0"><span class="pln">            data </span><span class="pun">=</span><span class="pln"> argv</span><span class="pun">[</span><span class="lit">2</span><span class="pun">]</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="pun">(</span><span class="pln">argv</span><span class="pun">[</span><span class="lit">3</span><span class="pun">]</span><span class="pln"> </span><span class="pun">&lt;&lt;</span><span class="pln"> </span><span class="lit">7</span><span class="pun">);</span><span class="pln">  </span><span class="com">// bytes to read</span></li><li class="L1"><span class="pln">          </span><span class="pun">}</span></li><li class="L2"><span class="pln">          readAndReportData</span><span class="pun">(</span><span class="pln">slaveAddress</span><span class="pun">,</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">int</span><span class="pun">)</span><span class="pln">slaveRegister</span><span class="pun">,</span><span class="pln"> data</span><span class="pun">,</span><span class="pln"> stopTX</span><span class="pun">);</span></li><li class="L3"><span class="pln">          </span><span class="kwd">break</span><span class="pun">;</span></li><li class="L4"><span class="pln">        </span><span class="kwd">case</span><span class="pln"> I2C_READ_CONTINUOUSLY</span><span class="pun">:</span></li><li class="L5"><span class="pln">          </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">((</span><span class="pln">queryIndex </span><span class="pun">+</span><span class="pln"> </span><span class="lit">1</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&gt;=</span><span class="pln"> I2C_MAX_QUERIES</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L6"><span class="pln">            </span><span class="com">// too many queries, just ignore</span></li><li class="L7"><span class="pln">            </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">sendString</span><span class="pun">(</span><span class="str">"too many queries"</span><span class="pun">);</span></li><li class="L8"><span class="pln">            </span><span class="kwd">break</span><span class="pun">;</span></li><li class="L9"><span class="pln">          </span><span class="pun">}</span></li><li class="L0"><span class="pln">          </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">argc </span><span class="pun">==</span><span class="pln"> </span><span class="lit">6</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L1"><span class="pln">            </span><span class="com">// a slave register is specified</span></li><li class="L2"><span class="pln">            slaveRegister </span><span class="pun">=</span><span class="pln"> argv</span><span class="pun">[</span><span class="lit">2</span><span class="pun">]</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="pun">(</span><span class="pln">argv</span><span class="pun">[</span><span class="lit">3</span><span class="pun">]</span><span class="pln"> </span><span class="pun">&lt;&lt;</span><span class="pln"> </span><span class="lit">7</span><span class="pun">);</span></li><li class="L3"><span class="pln">            data </span><span class="pun">=</span><span class="pln"> argv</span><span class="pun">[</span><span class="lit">4</span><span class="pun">]</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="pun">(</span><span class="pln">argv</span><span class="pun">[</span><span class="lit">5</span><span class="pun">]</span><span class="pln"> </span><span class="pun">&lt;&lt;</span><span class="pln"> </span><span class="lit">7</span><span class="pun">);</span><span class="pln">  </span><span class="com">// bytes to read</span></li><li class="L4"><span class="pln">          </span><span class="pun">}</span></li><li class="L5"><span class="pln">          </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span></li><li class="L6"><span class="pln">            </span><span class="com">// a slave register is NOT specified</span></li><li class="L7"><span class="pln">            slaveRegister </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">int</span><span class="pun">)</span><span class="pln">I2C_REGISTER_NOT_SPECIFIED</span><span class="pun">;</span></li><li class="L8"><span class="pln">            data </span><span class="pun">=</span><span class="pln"> argv</span><span class="pun">[</span><span class="lit">2</span><span class="pun">]</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="pun">(</span><span class="pln">argv</span><span class="pun">[</span><span class="lit">3</span><span class="pun">]</span><span class="pln"> </span><span class="pun">&lt;&lt;</span><span class="pln"> </span><span class="lit">7</span><span class="pun">);</span><span class="pln">  </span><span class="com">// bytes to read</span></li><li class="L9"><span class="pln">          </span><span class="pun">}</span></li><li class="L0"><span class="pln">          queryIndex</span><span class="pun">++;</span></li><li class="L1"><span class="pln">          query</span><span class="pun">[</span><span class="pln">queryIndex</span><span class="pun">].</span><span class="pln">addr </span><span class="pun">=</span><span class="pln"> slaveAddress</span><span class="pun">;</span></li><li class="L2"><span class="pln">          query</span><span class="pun">[</span><span class="pln">queryIndex</span><span class="pun">].</span><span class="pln">reg </span><span class="pun">=</span><span class="pln"> slaveRegister</span><span class="pun">;</span></li><li class="L3"><span class="pln">          query</span><span class="pun">[</span><span class="pln">queryIndex</span><span class="pun">].</span><span class="pln">bytes </span><span class="pun">=</span><span class="pln"> data</span><span class="pun">;</span></li><li class="L4"><span class="pln">          query</span><span class="pun">[</span><span class="pln">queryIndex</span><span class="pun">].</span><span class="pln">stopTX </span><span class="pun">=</span><span class="pln"> stopTX</span><span class="pun">;</span></li><li class="L5"><span class="pln">          </span><span class="kwd">break</span><span class="pun">;</span></li><li class="L6"><span class="pln">        </span><span class="kwd">case</span><span class="pln"> I2C_STOP_READING</span><span class="pun">:</span></li><li class="L7"><span class="pln">          </span><span class="kwd">byte</span><span class="pln"> queryIndexToSkip</span><span class="pun">;</span></li><li class="L8"><span class="pln">          </span><span class="com">// if read continuous mode is enabled for only 1 i2c device, disable</span></li><li class="L9"><span class="pln">          </span><span class="com">// read continuous reporting for that device</span></li><li class="L0"><span class="pln">          </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">queryIndex </span><span class="pun">&lt;=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L1"><span class="pln">            queryIndex </span><span class="pun">=</span><span class="pln"> </span><span class="pun">-</span><span class="lit">1</span><span class="pun">;</span></li><li class="L2"><span class="pln">          </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span></li><li class="L3"><span class="pln">            queryIndexToSkip </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></li><li class="L4"><span class="pln">            </span><span class="com">// if read continuous mode is enabled for multiple devices,</span></li><li class="L5"><span class="pln">            </span><span class="com">// determine which device to stop reading and remove it's data from</span></li><li class="L6"><span class="pln">            </span><span class="com">// the array, shifiting other array data to fill the space</span></li><li class="L7"><span class="pln">            </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">byte</span><span class="pln"> i </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span><span class="pln"> i </span><span class="pun">&lt;</span><span class="pln"> queryIndex </span><span class="pun">+</span><span class="pln"> </span><span class="lit">1</span><span class="pun">;</span><span class="pln"> i</span><span class="pun">++)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L8"><span class="pln">              </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">query</span><span class="pun">[</span><span class="pln">i</span><span class="pun">].</span><span class="pln">addr </span><span class="pun">==</span><span class="pln"> slaveAddress</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L9"><span class="pln">                queryIndexToSkip </span><span class="pun">=</span><span class="pln"> i</span><span class="pun">;</span></li><li class="L0"><span class="pln">                </span><span class="kwd">break</span><span class="pun">;</span></li><li class="L1"><span class="pln">              </span><span class="pun">}</span></li><li class="L2"><span class="pln">            </span><span class="pun">}</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln">            </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">byte</span><span class="pln"> i </span><span class="pun">=</span><span class="pln"> queryIndexToSkip</span><span class="pun">;</span><span class="pln"> i </span><span class="pun">&lt;</span><span class="pln"> queryIndex </span><span class="pun">+</span><span class="pln"> </span><span class="lit">1</span><span class="pun">;</span><span class="pln"> i</span><span class="pun">++)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L5"><span class="pln">              </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">i </span><span class="pun">&lt;</span><span class="pln"> I2C_MAX_QUERIES</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L6"><span class="pln">                query</span><span class="pun">[</span><span class="pln">i</span><span class="pun">].</span><span class="pln">addr </span><span class="pun">=</span><span class="pln"> query</span><span class="pun">[</span><span class="pln">i </span><span class="pun">+</span><span class="pln"> </span><span class="lit">1</span><span class="pun">].</span><span class="pln">addr</span><span class="pun">;</span></li><li class="L7"><span class="pln">                query</span><span class="pun">[</span><span class="pln">i</span><span class="pun">].</span><span class="pln">reg </span><span class="pun">=</span><span class="pln"> query</span><span class="pun">[</span><span class="pln">i </span><span class="pun">+</span><span class="pln"> </span><span class="lit">1</span><span class="pun">].</span><span class="pln">reg</span><span class="pun">;</span></li><li class="L8"><span class="pln">                query</span><span class="pun">[</span><span class="pln">i</span><span class="pun">].</span><span class="pln">bytes </span><span class="pun">=</span><span class="pln"> query</span><span class="pun">[</span><span class="pln">i </span><span class="pun">+</span><span class="pln"> </span><span class="lit">1</span><span class="pun">].</span><span class="pln">bytes</span><span class="pun">;</span></li><li class="L9"><span class="pln">                query</span><span class="pun">[</span><span class="pln">i</span><span class="pun">].</span><span class="pln">stopTX </span><span class="pun">=</span><span class="pln"> query</span><span class="pun">[</span><span class="pln">i </span><span class="pun">+</span><span class="pln"> </span><span class="lit">1</span><span class="pun">].</span><span class="pln">stopTX</span><span class="pun">;</span></li><li class="L0"><span class="pln">              </span><span class="pun">}</span></li><li class="L1"><span class="pln">            </span><span class="pun">}</span></li><li class="L2"><span class="pln">            queryIndex</span><span class="pun">--;</span></li><li class="L3"><span class="pln">          </span><span class="pun">}</span></li><li class="L4"><span class="pln">          </span><span class="kwd">break</span><span class="pun">;</span></li><li class="L5"><span class="pln">        </span><span class="kwd">default</span><span class="pun">:</span></li><li class="L6"><span class="pln">          </span><span class="kwd">break</span><span class="pun">;</span></li><li class="L7"><span class="pln">      </span><span class="pun">}</span></li><li class="L8"><span class="pln">      </span><span class="kwd">break</span><span class="pun">;</span></li><li class="L9"><span class="pln">    </span><span class="kwd">case</span><span class="pln"> I2C_CONFIG</span><span class="pun">:</span></li><li class="L0"><span class="pln">      delayTime </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">argv</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="pun">(</span><span class="pln">argv</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]</span><span class="pln"> </span><span class="pun">&lt;&lt;</span><span class="pln"> </span><span class="lit">7</span><span class="pun">));</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="pln">      </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">delayTime </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L3"><span class="pln">        i2cReadDelayTime </span><span class="pun">=</span><span class="pln"> delayTime</span><span class="pun">;</span></li><li class="L4"><span class="pln">      </span><span class="pun">}</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">      </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(!</span><span class="pln">isI2CEnabled</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L7"><span class="pln">        enableI2CPins</span><span class="pun">();</span></li><li class="L8"><span class="pln">      </span><span class="pun">}</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="pln">      </span><span class="kwd">break</span><span class="pun">;</span></li><li class="L1"><span class="pln">    </span><span class="kwd">case</span><span class="pln"> SERVO_CONFIG</span><span class="pun">:</span></li><li class="L2"><span class="pln">      </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">argc </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">4</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L3"><span class="pln">        </span><span class="com">// these vars are here for clarity, they'll optimized away by the compiler</span></li><li class="L4"><span class="pln">        </span><span class="kwd">byte</span><span class="pln"> pin </span><span class="pun">=</span><span class="pln"> argv</span><span class="pun">[</span><span class="lit">0</span><span class="pun">];</span></li><li class="L5"><span class="pln">        </span><span class="kwd">int</span><span class="pln"> minPulse </span><span class="pun">=</span><span class="pln"> argv</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="pun">(</span><span class="pln">argv</span><span class="pun">[</span><span class="lit">2</span><span class="pun">]</span><span class="pln"> </span><span class="pun">&lt;&lt;</span><span class="pln"> </span><span class="lit">7</span><span class="pun">);</span></li><li class="L6"><span class="pln">        </span><span class="kwd">int</span><span class="pln"> maxPulse </span><span class="pun">=</span><span class="pln"> argv</span><span class="pun">[</span><span class="lit">3</span><span class="pun">]</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="pun">(</span><span class="pln">argv</span><span class="pun">[</span><span class="lit">4</span><span class="pun">]</span><span class="pln"> </span><span class="pun">&lt;&lt;</span><span class="pln"> </span><span class="lit">7</span><span class="pun">);</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">IS_PIN_DIGITAL</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">))</span><span class="pln"> </span><span class="pun">{</span></li><li class="L9"><span class="pln">          </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">servoPinMap</span><span class="pun">[</span><span class="pln">pin</span><span class="pun">]</span><span class="pln"> </span><span class="pun">&lt;</span><span class="pln"> MAX_SERVOS </span><span class="pun">&amp;&amp;</span><span class="pln"> servos</span><span class="pun">[</span><span class="pln">servoPinMap</span><span class="pun">[</span><span class="pln">pin</span><span class="pun">]].</span><span class="pln">attached</span><span class="pun">())</span><span class="pln"> </span><span class="pun">{</span></li><li class="L0"><span class="pln">            detachServo</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">);</span></li><li class="L1"><span class="pln">          </span><span class="pun">}</span></li><li class="L2"><span class="pln">          attachServo</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">,</span><span class="pln"> minPulse</span><span class="pun">,</span><span class="pln"> maxPulse</span><span class="pun">);</span></li><li class="L3"><span class="pln">          setPinModeCallback</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">,</span><span class="pln"> PIN_MODE_SERVO</span><span class="pun">);</span></li><li class="L4"><span class="pln">        </span><span class="pun">}</span></li><li class="L5"><span class="pln">      </span><span class="pun">}</span></li><li class="L6"><span class="pln">      </span><span class="kwd">break</span><span class="pun">;</span></li><li class="L7"><span class="pln">    </span><span class="kwd">case</span><span class="pln"> SAMPLING_INTERVAL</span><span class="pun">:</span></li><li class="L8"><span class="pln">      </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">argc </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">1</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L9"><span class="pln">        samplingInterval </span><span class="pun">=</span><span class="pln"> argv</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="pun">(</span><span class="pln">argv</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]</span><span class="pln"> </span><span class="pun">&lt;&lt;</span><span class="pln"> </span><span class="lit">7</span><span class="pun">);</span></li><li class="L0"><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">samplingInterval </span><span class="pun">&lt;</span><span class="pln"> MINIMUM_SAMPLING_INTERVAL</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L1"><span class="pln">          samplingInterval </span><span class="pun">=</span><span class="pln"> MINIMUM_SAMPLING_INTERVAL</span><span class="pun">;</span></li><li class="L2"><span class="pln">        </span><span class="pun">}</span></li><li class="L3"><span class="pln">      </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span></li><li class="L4"><span class="pln">        </span><span class="com">//Firmata.sendString("Not enough data");</span></li><li class="L5"><span class="pln">      </span><span class="pun">}</span></li><li class="L6"><span class="pln">      </span><span class="kwd">break</span><span class="pun">;</span></li><li class="L7"><span class="pln">    </span><span class="kwd">case</span><span class="pln"> EXTENDED_ANALOG</span><span class="pun">:</span></li><li class="L8"><span class="pln">      </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">argc </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">1</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L9"><span class="pln">        </span><span class="kwd">int</span><span class="pln"> val </span><span class="pun">=</span><span class="pln"> argv</span><span class="pun">[</span><span class="lit">1</span><span class="pun">];</span></li><li class="L0"><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">argc </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">2</span><span class="pun">)</span><span class="pln"> val </span><span class="pun">|=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">argv</span><span class="pun">[</span><span class="lit">2</span><span class="pun">]</span><span class="pln"> </span><span class="pun">&lt;&lt;</span><span class="pln"> </span><span class="lit">7</span><span class="pun">);</span></li><li class="L1"><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">argc </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">3</span><span class="pun">)</span><span class="pln"> val </span><span class="pun">|=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">argv</span><span class="pun">[</span><span class="lit">3</span><span class="pun">]</span><span class="pln"> </span><span class="pun">&lt;&lt;</span><span class="pln"> </span><span class="lit">14</span><span class="pun">);</span></li><li class="L2"><span class="pln">        analogWriteCallback</span><span class="pun">(</span><span class="pln">argv</span><span class="pun">[</span><span class="lit">0</span><span class="pun">],</span><span class="pln"> val</span><span class="pun">);</span></li><li class="L3"><span class="pln">      </span><span class="pun">}</span></li><li class="L4"><span class="pln">      </span><span class="kwd">break</span><span class="pun">;</span></li><li class="L5"><span class="pln">    </span><span class="kwd">case</span><span class="pln"> CAPABILITY_QUERY</span><span class="pun">:</span></li><li class="L6"><span class="pln">      </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="pln">START_SYSEX</span><span class="pun">);</span></li><li class="L7"><span class="pln">      </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="pln">CAPABILITY_RESPONSE</span><span class="pun">);</span></li><li class="L8"><span class="pln">      </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">byte</span><span class="pln"> pin </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span><span class="pln"> pin </span><span class="pun">&lt;</span><span class="pln"> TOTAL_PINS</span><span class="pun">;</span><span class="pln"> pin</span><span class="pun">++)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L9"><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">IS_PIN_DIGITAL</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">))</span><span class="pln"> </span><span class="pun">{</span></li><li class="L0"><span class="pln">          </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">write</span><span class="pun">((</span><span class="kwd">byte</span><span class="pun">)</span><span class="pln">INPUT</span><span class="pun">);</span></li><li class="L1"><span class="pln">          </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="lit">1</span><span class="pun">);</span></li><li class="L2"><span class="pln">          </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">write</span><span class="pun">((</span><span class="kwd">byte</span><span class="pun">)</span><span class="pln">PIN_MODE_PULLUP</span><span class="pun">);</span></li><li class="L3"><span class="pln">          </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="lit">1</span><span class="pun">);</span></li><li class="L4"><span class="pln">          </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">write</span><span class="pun">((</span><span class="kwd">byte</span><span class="pun">)</span><span class="pln">OUTPUT</span><span class="pun">);</span></li><li class="L5"><span class="pln">          </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="lit">1</span><span class="pun">);</span></li><li class="L6"><span class="pln">        </span><span class="pun">}</span></li><li class="L7"><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">IS_PIN_ANALOG</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">))</span><span class="pln"> </span><span class="pun">{</span></li><li class="L8"><span class="pln">          </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="pln">PIN_MODE_ANALOG</span><span class="pun">);</span></li><li class="L9"><span class="pln">          </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="lit">10</span><span class="pun">);</span><span class="pln"> </span><span class="com">// 10 = 10-bit resolution</span></li><li class="L0"><span class="pln">        </span><span class="pun">}</span></li><li class="L1"><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">IS_PIN_PWM</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">))</span><span class="pln"> </span><span class="pun">{</span></li><li class="L2"><span class="pln">          </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="pln">PIN_MODE_PWM</span><span class="pun">);</span></li><li class="L3"><span class="pln">          </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="pln">DEFAULT_PWM_RESOLUTION</span><span class="pun">);</span></li><li class="L4"><span class="pln">        </span><span class="pun">}</span></li><li class="L5"><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">IS_PIN_DIGITAL</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">))</span><span class="pln"> </span><span class="pun">{</span></li><li class="L6"><span class="pln">          </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="pln">PIN_MODE_SERVO</span><span class="pun">);</span></li><li class="L7"><span class="pln">          </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="lit">14</span><span class="pun">);</span></li><li class="L8"><span class="pln">        </span><span class="pun">}</span></li><li class="L9"><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">IS_PIN_I2C</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">))</span><span class="pln"> </span><span class="pun">{</span></li><li class="L0"><span class="pln">          </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="pln">PIN_MODE_I2C</span><span class="pun">);</span></li><li class="L1"><span class="pln">          </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="lit">1</span><span class="pun">);</span><span class="pln">  </span><span class="com">// TODO: could assign a number to map to SCL or SDA</span></li><li class="L2"><span class="pln">        </span><span class="pun">}</span></li><li class="L3"><span class="com">#ifdef</span><span class="pln"> FIRMATA_SERIAL_FEATURE</span></li><li class="L4"><span class="pln">        serialFeature</span><span class="pun">.</span><span class="pln">handleCapability</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">);</span></li><li class="L5"><span class="com">#endif</span></li><li class="L6"><span class="pln">        </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="lit">127</span><span class="pun">);</span></li><li class="L7"><span class="pln">      </span><span class="pun">}</span></li><li class="L8"><span class="pln">      </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="pln">END_SYSEX</span><span class="pun">);</span></li><li class="L9"><span class="pln">      </span><span class="kwd">break</span><span class="pun">;</span></li><li class="L0"><span class="pln">    </span><span class="kwd">case</span><span class="pln"> PIN_STATE_QUERY</span><span class="pun">:</span></li><li class="L1"><span class="pln">      </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">argc </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L2"><span class="pln">        </span><span class="kwd">byte</span><span class="pln"> pin </span><span class="pun">=</span><span class="pln"> argv</span><span class="pun">[</span><span class="lit">0</span><span class="pun">];</span></li><li class="L3"><span class="pln">        </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="pln">START_SYSEX</span><span class="pun">);</span></li><li class="L4"><span class="pln">        </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="pln">PIN_STATE_RESPONSE</span><span class="pun">);</span></li><li class="L5"><span class="pln">        </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">);</span></li><li class="L6"><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">pin </span><span class="pun">&lt;</span><span class="pln"> TOTAL_PINS</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L7"><span class="pln">          </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">getPinMode</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">));</span></li><li class="L8"><span class="pln">          </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">write</span><span class="pun">((</span><span class="kwd">byte</span><span class="pun">)</span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">getPinState</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln"> </span><span class="lit">0x7F</span><span class="pun">);</span></li><li class="L9"><span class="pln">          </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">getPinState</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln"> </span><span class="lit">0xFF80</span><span class="pun">)</span><span class="pln"> </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">write</span><span class="pun">((</span><span class="kwd">byte</span><span class="pun">)(</span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">getPinState</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&gt;&gt;</span><span class="pln"> </span><span class="lit">7</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln"> </span><span class="lit">0x7F</span><span class="pun">);</span></li><li class="L0"><span class="pln">          </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">getPinState</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln"> </span><span class="lit">0xC000</span><span class="pun">)</span><span class="pln"> </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">write</span><span class="pun">((</span><span class="kwd">byte</span><span class="pun">)(</span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">getPinState</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&gt;&gt;</span><span class="pln"> </span><span class="lit">14</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln"> </span><span class="lit">0x7F</span><span class="pun">);</span></li><li class="L1"><span class="pln">        </span><span class="pun">}</span></li><li class="L2"><span class="pln">        </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="pln">END_SYSEX</span><span class="pun">);</span></li><li class="L3"><span class="pln">      </span><span class="pun">}</span></li><li class="L4"><span class="pln">      </span><span class="kwd">break</span><span class="pun">;</span></li><li class="L5"><span class="pln">    </span><span class="kwd">case</span><span class="pln"> ANALOG_MAPPING_QUERY</span><span class="pun">:</span></li><li class="L6"><span class="pln">      </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="pln">START_SYSEX</span><span class="pun">);</span></li><li class="L7"><span class="pln">      </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="pln">ANALOG_MAPPING_RESPONSE</span><span class="pun">);</span></li><li class="L8"><span class="pln">      </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">byte</span><span class="pln"> pin </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span><span class="pln"> pin </span><span class="pun">&lt;</span><span class="pln"> TOTAL_PINS</span><span class="pun">;</span><span class="pln"> pin</span><span class="pun">++)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L9"><span class="pln">        </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="pln">IS_PIN_ANALOG</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">)</span><span class="pln"> </span><span class="pun">?</span><span class="pln"> PIN_TO_ANALOG</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">)</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> </span><span class="lit">127</span><span class="pun">);</span></li><li class="L0"><span class="pln">      </span><span class="pun">}</span></li><li class="L1"><span class="pln">      </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="pln">END_SYSEX</span><span class="pun">);</span></li><li class="L2"><span class="pln">      </span><span class="kwd">break</span><span class="pun">;</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln">    </span><span class="kwd">case</span><span class="pln"> SERIAL_MESSAGE</span><span class="pun">:</span></li><li class="L5"><span class="com">#ifdef</span><span class="pln"> FIRMATA_SERIAL_FEATURE</span></li><li class="L6"><span class="pln">      serialFeature</span><span class="pun">.</span><span class="pln">handleSysex</span><span class="pun">(</span><span class="pln">command</span><span class="pun">,</span><span class="pln"> argc</span><span class="pun">,</span><span class="pln"> argv</span><span class="pun">);</span></li><li class="L7"><span class="com">#endif</span></li><li class="L8"><span class="pln">      </span><span class="kwd">break</span><span class="pun">;</span></li><li class="L9"><span class="pln">  </span><span class="pun">}</span></li><li class="L0"><span class="pun">}</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="com">/*==============================================================================</span></li><li class="L3"><span class="com"> * SETUP()</span></li><li class="L4"><span class="com"> *============================================================================*/</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="kwd">void</span><span class="pln"> systemResetCallback</span><span class="pun">()</span></li><li class="L7"><span class="pun">{</span></li><li class="L8"><span class="pln">  isResetting </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">;</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="pln">  </span><span class="com">// initialize a defalt state</span></li><li class="L1"><span class="pln">  </span><span class="com">// TODO: option to load config from EEPROM instead of default</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="com">#ifdef</span><span class="pln"> FIRMATA_SERIAL_FEATURE</span></li><li class="L4"><span class="pln">  serialFeature</span><span class="pun">.</span><span class="pln">reset</span><span class="pun">();</span></li><li class="L5"><span class="com">#endif</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">isI2CEnabled</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L8"><span class="pln">    disableI2CPins</span><span class="pun">();</span></li><li class="L9"><span class="pln">  </span><span class="pun">}</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">  </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">byte</span><span class="pln"> i </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span><span class="pln"> i </span><span class="pun">&lt;</span><span class="pln"> TOTAL_PORTS</span><span class="pun">;</span><span class="pln"> i</span><span class="pun">++)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L2"><span class="pln">    reportPINs</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">;</span><span class="pln">    </span><span class="com">// by default, reporting off</span></li><li class="L3"><span class="pln">    portConfigInputs</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span><span class="pln">  </span><span class="com">// until activated</span></li><li class="L4"><span class="pln">    previousPINs</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></li><li class="L5"><span class="pln">  </span><span class="pun">}</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="pln">  </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">byte</span><span class="pln"> i </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span><span class="pln"> i </span><span class="pun">&lt;</span><span class="pln"> TOTAL_PINS</span><span class="pun">;</span><span class="pln"> i</span><span class="pun">++)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L8"><span class="pln">    </span><span class="com">// pins with analog capability default to analog input</span></li><li class="L9"><span class="pln">    </span><span class="com">// otherwise, pins default to digital output</span></li><li class="L0"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">IS_PIN_ANALOG</span><span class="pun">(</span><span class="pln">i</span><span class="pun">))</span><span class="pln"> </span><span class="pun">{</span></li><li class="L1"><span class="pln">      </span><span class="com">// turns off pullup, configures everything</span></li><li class="L2"><span class="pln">      setPinModeCallback</span><span class="pun">(</span><span class="pln">i</span><span class="pun">,</span><span class="pln"> PIN_MODE_ANALOG</span><span class="pun">);</span></li><li class="L3"><span class="pln">    </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">IS_PIN_DIGITAL</span><span class="pun">(</span><span class="pln">i</span><span class="pun">))</span><span class="pln"> </span><span class="pun">{</span></li><li class="L4"><span class="pln">      </span><span class="com">// sets the output to 0, configures portConfigInputs</span></li><li class="L5"><span class="pln">      setPinModeCallback</span><span class="pun">(</span><span class="pln">i</span><span class="pun">,</span><span class="pln"> OUTPUT</span><span class="pun">);</span></li><li class="L6"><span class="pln">    </span><span class="pun">}</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">    servoPinMap</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="lit">255</span><span class="pun">;</span></li><li class="L9"><span class="pln">  </span><span class="pun">}</span></li><li class="L0"><span class="pln">  </span><span class="com">// by default, do not report any analog inputs</span></li><li class="L1"><span class="pln">  analogInputsToReport </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="pln">  detachedServoCount </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></li><li class="L4"><span class="pln">  servoCount </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">  </span><span class="com">/* send digital inputs to set the initial state on the host computer,</span></li><li class="L7"><span class="com">   * since once in the loop(), this firmware will only send on change */</span></li><li class="L8"><span class="pln">  </span><span class="com">/*</span></li><li class="L9"><span class="com">  TODO: this can never execute, since no pins default to digital input</span></li><li class="L0"><span class="com">        but it will be needed when/if we support EEPROM stored config</span></li><li class="L1"><span class="com">  for (byte i=0; i &lt; TOTAL_PORTS; i++) {</span></li><li class="L2"><span class="com">    outputPort(i, readPort(i, portConfigInputs[i]), true);</span></li><li class="L3"><span class="com">  }</span></li><li class="L4"><span class="com">  */</span></li><li class="L5"><span class="pln">  isResetting </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">;</span></li><li class="L6"><span class="pun">}</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="kwd">void</span><span class="pln"> setup</span><span class="pun">()</span></li><li class="L9"><span class="pun">{</span></li><li class="L0"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">(</span><span class="lit">115200</span><span class="pun">);</span></li><li class="L1"><span class="pln">  </span><span class="kwd">while</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="typ">Serial</span><span class="pln"> </span><span class="pun">)</span><span class="pln"> delay</span><span class="pun">(</span><span class="lit">10</span><span class="pun">);</span><span class="pln">   </span><span class="com">// for nrf52840 with native usb</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Bluefruit52 Standard Firmata via BLEUART Example"</span><span class="pun">);</span></li><li class="L4"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"------------------------------------------------\n"</span><span class="pun">);</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">  </span><span class="com">// Config the peripheral connection with maximum bandwidth </span></li><li class="L7"><span class="pln">  </span><span class="com">// more SRAM required by SoftDevice</span></li><li class="L8"><span class="pln">  </span><span class="com">// Note: All config***() function must be called before begin()</span></li><li class="L9"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="pln">configPrphBandwidth</span><span class="pun">(</span><span class="pln">BANDWIDTH_MAX</span><span class="pun">);</span></li><li class="L0"><span class="pln">  </span></li><li class="L1"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L2"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="pln">setName</span><span class="pun">(</span><span class="str">"Bluefruit52"</span><span class="pun">);</span></li><li class="L3"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="pln">setTxPower</span><span class="pun">(</span><span class="lit">4</span><span class="pun">);</span><span class="pln">    </span><span class="com">// Check bluefruit.h for supported values</span></li><li class="L4"><span class="pln">  </span></li><li class="L5"><span class="pln">  </span><span class="com">// try to go as fast as possible, could be rejected by some central, increase it if needed</span></li><li class="L6"><span class="pln">  </span><span class="com">// iOS won't negotitate and will mostly use 30ms</span></li><li class="L7"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Periph</span><span class="pun">.</span><span class="pln">setConnInterval</span><span class="pun">(</span><span class="lit">9</span><span class="pun">,</span><span class="pln"> </span><span class="lit">24</span><span class="pun">);</span><span class="pln"> </span><span class="com">// min = 9*1.25=11.25 ms, max = 23*1.25=30ms</span></li><li class="L8"><span class="pln">  </span></li><li class="L9"><span class="pln">  </span><span class="com">// Configure and Start BLE Uart Service</span></li><li class="L0"><span class="pln">  </span><span class="com">// Firmata use several small write(1) --&gt; buffering TXD is required to run smoothly</span></li><li class="L1"><span class="pln">  </span><span class="com">// Enable buffering TXD</span></li><li class="L2"><span class="pln">  bleuart</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L3"><span class="pln">  bleuart</span><span class="pun">.</span><span class="pln">bufferTXD</span><span class="pun">(</span><span class="kwd">true</span><span class="pun">);</span></li><li class="L4"><span class="pln">  </span></li><li class="L5"><span class="pln">  </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">setFirmwareVersion</span><span class="pun">(</span><span class="pln">FIRMATA_FIRMWARE_MAJOR_VERSION</span><span class="pun">,</span><span class="pln"> FIRMATA_FIRMWARE_MINOR_VERSION</span><span class="pun">);</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="pln">  </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">attach</span><span class="pun">(</span><span class="pln">ANALOG_MESSAGE</span><span class="pun">,</span><span class="pln"> analogWriteCallback</span><span class="pun">);</span></li><li class="L8"><span class="pln">  </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">attach</span><span class="pun">(</span><span class="pln">DIGITAL_MESSAGE</span><span class="pun">,</span><span class="pln"> digitalWriteCallback</span><span class="pun">);</span></li><li class="L9"><span class="pln">  </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">attach</span><span class="pun">(</span><span class="pln">REPORT_ANALOG</span><span class="pun">,</span><span class="pln"> reportAnalogCallback</span><span class="pun">);</span></li><li class="L0"><span class="pln">  </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">attach</span><span class="pun">(</span><span class="pln">REPORT_DIGITAL</span><span class="pun">,</span><span class="pln"> reportDigitalCallback</span><span class="pun">);</span></li><li class="L1"><span class="pln">  </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">attach</span><span class="pun">(</span><span class="pln">SET_PIN_MODE</span><span class="pun">,</span><span class="pln"> setPinModeCallback</span><span class="pun">);</span></li><li class="L2"><span class="pln">  </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">attach</span><span class="pun">(</span><span class="pln">SET_DIGITAL_PIN_VALUE</span><span class="pun">,</span><span class="pln"> setPinValueCallback</span><span class="pun">);</span></li><li class="L3"><span class="pln">  </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">attach</span><span class="pun">(</span><span class="pln">START_SYSEX</span><span class="pun">,</span><span class="pln"> sysexCallback</span><span class="pun">);</span></li><li class="L4"><span class="pln">  </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">attach</span><span class="pun">(</span><span class="pln">SYSTEM_RESET</span><span class="pun">,</span><span class="pln"> systemResetCallback</span><span class="pun">);</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">  </span><span class="com">// use bleuart as transportation layer</span></li><li class="L7"><span class="pln">  </span><span class="typ">Firmata</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">(</span><span class="pln">bleuart</span><span class="pun">);</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="pln">  </span><span class="com">// to use a port other than Serial, such as Serial1 on an Arduino Leonardo or Mega,</span></li><li class="L0"><span class="pln">  </span><span class="com">// Call begin(baud) on the alternate serial port and pass it to Firmata to begin like this:</span></li><li class="L1"><span class="pln">  </span><span class="com">// Serial1.begin(57600);</span></li><li class="L2"><span class="pln">  </span><span class="com">// Firmata.begin(Serial1);</span></li><li class="L3"><span class="pln">  </span><span class="com">// However do not do this if you are using SERIAL_MESSAGE</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">  </span><span class="com">//Firmata.begin(57600);</span></li><li class="L6"><span class="pln">  </span><span class="com">//while (!Serial) {</span></li><li class="L7"><span class="pln">  </span><span class="com">//  ; // wait for serial port to connect. Needed for ATmega32u4-based boards and Arduino 101</span></li><li class="L8"><span class="pln">  </span><span class="com">//}</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="pln">  systemResetCallback</span><span class="pun">();</span><span class="pln">  </span><span class="com">// reset to default config</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="pln">  </span><span class="com">// Set up and start advertising</span></li><li class="L3"><span class="pln">  startAdv</span><span class="pun">();</span><span class="pln">  </span></li><li class="L4"><span class="pun">}</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="kwd">void</span><span class="pln"> startAdv</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span></li><li class="L7"><span class="pun">{</span></li><li class="L8"><span class="pln">  </span><span class="com">// Advertising packet</span></li><li class="L9"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">addFlags</span><span class="pun">(</span><span class="pln">BLE_GAP_ADV_FLAGS_LE_ONLY_GENERAL_DISC_MODE</span><span class="pun">);</span></li><li class="L0"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">addTxPower</span><span class="pun">();</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="pln">  </span><span class="com">// Include bleuart 128-bit uuid</span></li><li class="L3"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">addService</span><span class="pun">(</span><span class="pln">bleuart</span><span class="pun">);</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">  </span><span class="com">// Secondary Scan Response packet (optional)</span></li><li class="L6"><span class="pln">  </span><span class="com">// Since there is no room for 'Name' in Advertising packet</span></li><li class="L7"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">ScanResponse</span><span class="pun">.</span><span class="pln">addName</span><span class="pun">();</span></li><li class="L8"><span class="pln">  </span></li><li class="L9"><span class="pln">  </span><span class="com">/* Start Advertising</span></li><li class="L0"><span class="com">   * - Enable auto advertising if disconnected</span></li><li class="L1"><span class="com">   * - Interval:  fast mode = 20 ms, slow mode = 152.5 ms</span></li><li class="L2"><span class="com">   * - Timeout for fast mode is 30 seconds</span></li><li class="L3"><span class="com">   * - Start(timeout) with timeout = 0 will advertise forever (until connected)</span></li><li class="L4"><span class="com">   * </span></li><li class="L5"><span class="com">   * For recommended advertising interval</span></li><li class="L6"><span class="com">   * https://developer.apple.com/library/content/qa/qa1931/_index.html   </span></li><li class="L7"><span class="com">   */</span></li><li class="L8"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">restartOnDisconnect</span><span class="pun">(</span><span class="kwd">true</span><span class="pun">);</span></li><li class="L9"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">setInterval</span><span class="pun">(</span><span class="lit">32</span><span class="pun">,</span><span class="pln"> </span><span class="lit">244</span><span class="pun">);</span><span class="pln">    </span><span class="com">// in unit of 0.625 ms</span></li><li class="L0"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">setFastTimeout</span><span class="pun">(</span><span class="lit">30</span><span class="pun">);</span><span class="pln">      </span><span class="com">// number of seconds in fast mode</span></li><li class="L1"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">start</span><span class="pun">(</span><span class="lit">0</span><span class="pun">);</span><span class="pln">                </span><span class="com">// 0 = Don't stop advertising after n seconds  </span></li><li class="L2"><span class="pun">}</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="com">/*==============================================================================</span></li><li class="L5"><span class="com"> * LOOP()</span></li><li class="L6"><span class="com"> *============================================================================*/</span></li><li class="L7"><span class="kwd">void</span><span class="pln"> loop</span><span class="pun">()</span></li><li class="L8"><span class="pun">{</span></li><li class="L9"><span class="pln">  </span><span class="com">// Skip if not connected and bleuart notification is not enabled</span></li><li class="L0"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">  </span><span class="pun">!(</span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="pln">connected</span><span class="pun">()</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> bleuart</span><span class="pun">.</span><span class="pln">notifyEnabled</span><span class="pun">())</span><span class="pln"> </span><span class="pun">)</span><span class="pln"> </span><span class="kwd">return</span><span class="pun">;</span></li><li class="L1"><span class="pln">  </span></li><li class="L2"><span class="pln">  </span><span class="kwd">byte</span><span class="pln"> pin</span><span class="pun">,</span><span class="pln"> analogPin</span><span class="pun">;</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln">  </span><span class="com">/* DIGITALREAD - as fast as possible, check for changes and output them to the</span></li><li class="L5"><span class="com">   * FTDI buffer using Serial.print()  */</span></li><li class="L6"><span class="pln">  checkDigitalInputs</span><span class="pun">();</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">  </span><span class="com">/* STREAMREAD - processing incoming messagse as soon as possible, while still</span></li><li class="L9"><span class="com">   * checking digital inputs.  */</span></li><li class="L0"><span class="pln">  </span><span class="kwd">while</span><span class="pln"> </span><span class="pun">(</span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">available</span><span class="pun">())</span></li><li class="L1"><span class="pln">    </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">processInput</span><span class="pun">();</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="pln">  </span><span class="com">// TODO - ensure that Stream buffer doesn't go over 60 bytes</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">  currentMillis </span><span class="pun">=</span><span class="pln"> millis</span><span class="pun">();</span></li><li class="L6"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">currentMillis </span><span class="pun">-</span><span class="pln"> previousMillis </span><span class="pun">&gt;</span><span class="pln"> samplingInterval</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L7"><span class="pln">    previousMillis </span><span class="pun">+=</span><span class="pln"> samplingInterval</span><span class="pun">;</span></li><li class="L8"><span class="pln">    </span><span class="com">/* ANALOGREAD - do all analogReads() at the configured sampling interval */</span></li><li class="L9"><span class="pln">    </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="pln">pin </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span><span class="pln"> pin </span><span class="pun">&lt;</span><span class="pln"> TOTAL_PINS</span><span class="pun">;</span><span class="pln"> pin</span><span class="pun">++)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L0"><span class="pln">      </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">IS_PIN_ANALOG</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">getPinMode</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">)</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> PIN_MODE_ANALOG</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L1"><span class="pln">        analogPin </span><span class="pun">=</span><span class="pln"> PIN_TO_ANALOG</span><span class="pun">(</span><span class="pln">pin</span><span class="pun">);</span></li><li class="L2"><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">analogInputsToReport </span><span class="pun">&amp;</span><span class="pln"> </span><span class="pun">(</span><span class="lit">1</span><span class="pln"> </span><span class="pun">&lt;&lt;</span><span class="pln"> analogPin</span><span class="pun">))</span><span class="pln"> </span><span class="pun">{</span></li><li class="L3"><span class="pln">          </span><span class="typ">Firmata</span><span class="pun">.</span><span class="pln">sendAnalog</span><span class="pun">(</span><span class="pln">analogPin</span><span class="pun">,</span><span class="pln"> analogRead</span><span class="pun">(</span><span class="pln"> ANALOG_TO_PIN</span><span class="pun">(</span><span class="pln">analogPin</span><span class="pun">)</span><span class="pln"> </span><span class="pun">));</span></li><li class="L4"><span class="pln">        </span><span class="pun">}</span></li><li class="L5"><span class="pln">      </span><span class="pun">}</span></li><li class="L6"><span class="pln">    </span><span class="pun">}</span></li><li class="L7"><span class="pln">    </span><span class="com">// report i2c data for all device with read continuous mode enabled</span></li><li class="L8"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">queryIndex </span><span class="pun">&gt;</span><span class="pln"> </span><span class="pun">-</span><span class="lit">1</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L9"><span class="pln">      </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">byte</span><span class="pln"> i </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span><span class="pln"> i </span><span class="pun">&lt;</span><span class="pln"> queryIndex </span><span class="pun">+</span><span class="pln"> </span><span class="lit">1</span><span class="pun">;</span><span class="pln"> i</span><span class="pun">++)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L0"><span class="pln">        readAndReportData</span><span class="pun">(</span><span class="pln">query</span><span class="pun">[</span><span class="pln">i</span><span class="pun">].</span><span class="pln">addr</span><span class="pun">,</span><span class="pln"> query</span><span class="pun">[</span><span class="pln">i</span><span class="pun">].</span><span class="pln">reg</span><span class="pun">,</span><span class="pln"> query</span><span class="pun">[</span><span class="pln">i</span><span class="pun">].</span><span class="pln">bytes</span><span class="pun">,</span><span class="pln"> query</span><span class="pun">[</span><span class="pln">i</span><span class="pun">].</span><span class="pln">stopTX</span><span class="pun">);</span></li><li class="L1"><span class="pln">      </span><span class="pun">}</span></li><li class="L2"><span class="pln">    </span><span class="pun">}</span></li><li class="L3"><span class="pln">  </span><span class="pun">}</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="com">#ifdef</span><span class="pln"> FIRMATA_SERIAL_FEATURE</span></li><li class="L6"><span class="pln">  serialFeature</span><span class="pun">.</span><span class="pln">update</span><span class="pun">();</span></li><li class="L7"><span class="com">#endif</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="pln">  </span><span class="com">// flush TXD since we use bufferTXD()</span></li><li class="L0"><span class="pln">  bleuart</span><span class="pun">.</span><span class="pln">flushTXD</span><span class="pun">();</span></li><li class="L1"><span class="pun">}</span></li></ol></pre>
</div>
</div>
</div>
<div class="page-title-wrapper">
<h1 class="headline">
<span id="central-bleuart">Central BLEUART</span>
</h1>
<div class="author">by
<a href="./nRF52_bluefruit_Learning_Guide.html#central-bleuart">
<span class="name">Thach Ha</span>
</a> </div>
</div>
<div class="page-content all-page-view-content">
<div class="">
<div class="row-fluid build-text">
<p>This example show you how to use Bluefruit52 as a <strong>Central</strong> to talk to other Bluefruit52 peripherals exposing the bleuart (AKA 'NUS') service.</p>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#client-services-15-2" class="anchor-link"><span class="fa fa-link"></span></a><span id="client-services-15-2" class="anchor-link-target"></span><span id="client-services" class="anchor-link-target"></span>Client Services</h1>
<p>Since the Central role accesses the GATT server on the peripheral, we first need to declare a client bleuart instance using the <strong>BLEClientUart</strong>&nbsp;helper class. We can also conveniently read Device Information if <strong>BLEClientDis</strong> is also used.</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/11267/elements/2979330/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">BLEClientDis  clientDis;
BLEClientUart clientUart;
</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="typ">BLEClientDis</span><span class="pln">  clientDis</span><span class="pun">;</span></li><li class="L1"><span class="typ">BLEClientUart</span><span class="pln"> clientUart</span><span class="pun">;</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<p>Before we can configure client services, <code>Bluefruit.begin()</code> must be called with at least 1 for the number of concurrent connections supported in central mode. Since we won't be running the nRF52 as a peripheral in this instance, we will set the peripheral count to 0:</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/11267/elements/2979333/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">// Initialize Bluefruit with maximum connections as Peripheral = 0, Central = 1
Bluefruit.begin(0, 1);</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="com">// Initialize Bluefruit with maximum connections as Peripheral = 0, Central = 1</span></li><li class="L1"><span class="typ">Bluefruit</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">(</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">);</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<p>Afterward this, the client service(s) must be initialized by calling their <code>begin()</code>&nbsp;function, and you can&nbsp;setup any callbacks that you wish to use from the helper class:</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/11267/elements/2979332/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">// Configure DIS client
clientDis.begin();

// Init BLE Central Uart Serivce
clientUart.begin();
clientUart.setRxCallback(bleuart_rx_callback);</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="com">// Configure DIS client</span></li><li class="L1"><span class="pln">clientDis</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="com">// Init BLE Central Uart Serivce</span></li><li class="L4"><span class="pln">clientUart</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L5"><span class="pln">clientUart</span><span class="pun">.</span><span class="pln">setRxCallback</span><span class="pun">(</span><span class="pln">bleuart_rx_callback</span><span class="pun">);</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#scanner-15-8" class="anchor-link"><span class="fa fa-link"></span></a><span id="scanner-15-8" class="anchor-link-target"></span><span id="scanner" class="anchor-link-target"></span>Scanner</h1>
<p>Let's start the advertising scanner to find a peripheral.</p>
<p>We'll hook up the scan result callback with <strong>setRxCallback().&nbsp;</strong></p>
<p>Whenever advertising data is found by the scanner, it will be passed to this callback handler, and we can examine the advertising data there, and only connect to peripheral(s) that advertise the bleuart service.</p>
<p>Note: If the peripheral has multiple services and bleuart is not included in the UUID list in the advertising packet, you could optionally use another check such as matching the MAC address, name checking, using "another service", etc.</p>
<p>Once we find a peripheral that we wish to communicate with, call <code>Bluefruit.Central.connect()</code> to establish connection with it:</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/11267/elements/2979336/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">void setup()
{
  // Other set up .....

  /* Start Central Scanning
   * - Enable auto scan if disconnected
   * - Interval = 100 ms, window = 80 ms
   * - Don't use active scan
   * - Start(timeout) with timeout = 0 will scan forever (until connected)
   */
  Bluefruit.Scanner.setRxCallback(scan_callback);
  Bluefruit.Scanner.restartOnDisconnect(true);
  Bluefruit.Scanner.setInterval(160, 80); // in unit of 0.625 ms
  Bluefruit.Scanner.useActiveScan(false);
  Bluefruit.Scanner.start(0);                   // // 0 = Don't stop scanning after n seconds
}

/**
 * Callback invoked when scanner pick up an advertising data
 * @param report Structural advertising data
 */
void scan_callback(ble_gap_evt_adv_report_t* report)
{
  // Check if advertising contain BleUart service
  if ( Bluefruit.Scanner.checkReportForService(report, clientUart) )
  {
    Serial.print("BLE UART service detected. Connecting ... ");

    // Connect to device with bleuart service in advertising
    Bluefruit.Central.connect(report);
  }
}</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="kwd">void</span><span class="pln"> setup</span><span class="pun">()</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="pln">  </span><span class="com">// Other set up .....</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln">  </span><span class="com">/* Start Central Scanning</span></li><li class="L5"><span class="com">   * - Enable auto scan if disconnected</span></li><li class="L6"><span class="com">   * - Interval = 100 ms, window = 80 ms</span></li><li class="L7"><span class="com">   * - Don't use active scan</span></li><li class="L8"><span class="com">   * - Start(timeout) with timeout = 0 will scan forever (until connected)</span></li><li class="L9"><span class="com">   */</span></li><li class="L0"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Scanner</span><span class="pun">.</span><span class="pln">setRxCallback</span><span class="pun">(</span><span class="pln">scan_callback</span><span class="pun">);</span></li><li class="L1"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Scanner</span><span class="pun">.</span><span class="pln">restartOnDisconnect</span><span class="pun">(</span><span class="kwd">true</span><span class="pun">);</span></li><li class="L2"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Scanner</span><span class="pun">.</span><span class="pln">setInterval</span><span class="pun">(</span><span class="lit">160</span><span class="pun">,</span><span class="pln"> </span><span class="lit">80</span><span class="pun">);</span><span class="pln"> </span><span class="com">// in unit of 0.625 ms</span></li><li class="L3"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Scanner</span><span class="pun">.</span><span class="pln">useActiveScan</span><span class="pun">(</span><span class="kwd">false</span><span class="pun">);</span></li><li class="L4"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Scanner</span><span class="pun">.</span><span class="pln">start</span><span class="pun">(</span><span class="lit">0</span><span class="pun">);</span><span class="pln">                   </span><span class="com">// // 0 = Don't stop scanning after n seconds</span></li><li class="L5"><span class="pun">}</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="com">/**</span></li><li class="L8"><span class="com"> * Callback invoked when scanner pick up an advertising data</span></li><li class="L9"><span class="com"> * @param report Structural advertising data</span></li><li class="L0"><span class="com"> */</span></li><li class="L1"><span class="kwd">void</span><span class="pln"> scan_callback</span><span class="pun">(</span><span class="typ">ble_gap_evt_adv_report_t</span><span class="pun">*</span><span class="pln"> report</span><span class="pun">)</span></li><li class="L2"><span class="pun">{</span></li><li class="L3"><span class="pln">  </span><span class="com">// Check if advertising contain BleUart service</span></li><li class="L4"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Scanner</span><span class="pun">.</span><span class="pln">checkReportForService</span><span class="pun">(</span><span class="pln">report</span><span class="pun">,</span><span class="pln"> clientUart</span><span class="pun">)</span><span class="pln"> </span><span class="pun">)</span></li><li class="L5"><span class="pln">  </span><span class="pun">{</span></li><li class="L6"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"BLE UART service detected. Connecting ... "</span><span class="pun">);</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">    </span><span class="com">// Connect to device with bleuart service in advertising</span></li><li class="L9"><span class="pln">    </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Central</span><span class="pun">.</span><span class="pln">connect</span><span class="pun">(</span><span class="pln">report</span><span class="pun">);</span></li><li class="L0"><span class="pln">  </span><span class="pun">}</span></li><li class="L1"><span class="pun">}</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#central-role-15-10" class="anchor-link"><span class="fa fa-link"></span></a><span id="central-role-15-10" class="anchor-link-target"></span><span id="central-role" class="anchor-link-target"></span>Central Role</h1>
<p>You normally need to setup the Central mode device's <strong>connect callback</strong>, which&nbsp;fires when a connection is established/disconnected with a peripheral device. Alternatively you could poll the connection status with connected(), but callbacks help to simplify the code significantly:&nbsp;</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/11267/elements/2979353/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">// Callbacks for Central
Bluefruit.Central.setConnectCallback(connect_callback);
Bluefruit.Central.setDisconnectCallback(disconnect_callback);</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="com">// Callbacks for Central</span></li><li class="L1"><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Central</span><span class="pun">.</span><span class="pln">setConnectCallback</span><span class="pun">(</span><span class="pln">connect_callback</span><span class="pun">);</span></li><li class="L2"><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Central</span><span class="pun">.</span><span class="pln">setDisconnectCallback</span><span class="pun">(</span><span class="pln">disconnect_callback</span><span class="pun">);</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<p>In the connect callback, we will try to <strong>discover&nbsp;</strong>the bleuart service by browsing the GATT table of the peripheral. This will help to determine the handle values for characteristics (e.g TXD, RXD, etc.). This is all done by BLEClientUart's <code>.discover()</code>. Once the service is found, enable the TXD characteristic's CCCD to allow the peripheral to send data, and we are ready to send data back and forth&nbsp;between the devices:</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/11267/elements/2979338/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">void connect_callback(uint16_t conn_handle)
{
  Serial.println("Connected");

  Serial.print("Dicovering DIS ... ");
  if ( clientDis.discover(conn_handle) )
  {
    Serial.println("Found it");
    char buffer[32+1];
    
    // read and print out Manufacturer
    memset(buffer, 0, sizeof(buffer));
    if ( clientDis.getManufacturer(buffer, sizeof(buffer)) )
    {
      Serial.print("Manufacturer: ");
      Serial.println(buffer);
    }

    // read and print out Model Number
    memset(buffer, 0, sizeof(buffer));
    if ( clientDis.getModel(buffer, sizeof(buffer)) )
    {
      Serial.print("Model: ");
      Serial.println(buffer);
    }

    Serial.println();
  }  

  Serial.print("Discovering BLE Uart Service ... ");

  if ( clientUart.discover(conn_handle) )
  {
    Serial.println("Found it");

    Serial.println("Enable TXD's notify");
    clientUart.enableTXD();

    Serial.println("Ready to receive from peripheral");
  }else
  {
    Serial.println("Found NONE");
    
    // disconect since we couldn't find bleuart service
    Bluefruit.Central.disconnect(conn_handle);
  }  
}</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="kwd">void</span><span class="pln"> connect_callback</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> conn_handle</span><span class="pun">)</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Connected"</span><span class="pun">);</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"Dicovering DIS ... "</span><span class="pun">);</span></li><li class="L5"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> clientDis</span><span class="pun">.</span><span class="pln">discover</span><span class="pun">(</span><span class="pln">conn_handle</span><span class="pun">)</span><span class="pln"> </span><span class="pun">)</span></li><li class="L6"><span class="pln">  </span><span class="pun">{</span></li><li class="L7"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Found it"</span><span class="pun">);</span></li><li class="L8"><span class="pln">    </span><span class="kwd">char</span><span class="pln"> buffer</span><span class="pun">[</span><span class="lit">32</span><span class="pun">+</span><span class="lit">1</span><span class="pun">];</span></li><li class="L9"><span class="pln">    </span></li><li class="L0"><span class="pln">    </span><span class="com">// read and print out Manufacturer</span></li><li class="L1"><span class="pln">    memset</span><span class="pun">(</span><span class="pln">buffer</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">sizeof</span><span class="pun">(</span><span class="pln">buffer</span><span class="pun">));</span></li><li class="L2"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> clientDis</span><span class="pun">.</span><span class="pln">getManufacturer</span><span class="pun">(</span><span class="pln">buffer</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">sizeof</span><span class="pun">(</span><span class="pln">buffer</span><span class="pun">))</span><span class="pln"> </span><span class="pun">)</span></li><li class="L3"><span class="pln">    </span><span class="pun">{</span></li><li class="L4"><span class="pln">      </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"Manufacturer: "</span><span class="pun">);</span></li><li class="L5"><span class="pln">      </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="pln">buffer</span><span class="pun">);</span></li><li class="L6"><span class="pln">    </span><span class="pun">}</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">    </span><span class="com">// read and print out Model Number</span></li><li class="L9"><span class="pln">    memset</span><span class="pun">(</span><span class="pln">buffer</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">sizeof</span><span class="pun">(</span><span class="pln">buffer</span><span class="pun">));</span></li><li class="L0"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> clientDis</span><span class="pun">.</span><span class="pln">getModel</span><span class="pun">(</span><span class="pln">buffer</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">sizeof</span><span class="pun">(</span><span class="pln">buffer</span><span class="pun">))</span><span class="pln"> </span><span class="pun">)</span></li><li class="L1"><span class="pln">    </span><span class="pun">{</span></li><li class="L2"><span class="pln">      </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"Model: "</span><span class="pun">);</span></li><li class="L3"><span class="pln">      </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="pln">buffer</span><span class="pun">);</span></li><li class="L4"><span class="pln">    </span><span class="pun">}</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">();</span></li><li class="L7"><span class="pln">  </span><span class="pun">}</span><span class="pln">  </span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"Discovering BLE Uart Service ... "</span><span class="pun">);</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> clientUart</span><span class="pun">.</span><span class="pln">discover</span><span class="pun">(</span><span class="pln">conn_handle</span><span class="pun">)</span><span class="pln"> </span><span class="pun">)</span></li><li class="L2"><span class="pln">  </span><span class="pun">{</span></li><li class="L3"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Found it"</span><span class="pun">);</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Enable TXD's notify"</span><span class="pun">);</span></li><li class="L6"><span class="pln">    clientUart</span><span class="pun">.</span><span class="pln">enableTXD</span><span class="pun">();</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Ready to receive from peripheral"</span><span class="pun">);</span></li><li class="L9"><span class="pln">  </span><span class="pun">}</span><span class="kwd">else</span></li><li class="L0"><span class="pln">  </span><span class="pun">{</span></li><li class="L1"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Found NONE"</span><span class="pun">);</span></li><li class="L2"><span class="pln">    </span></li><li class="L3"><span class="pln">    </span><span class="com">// disconect since we couldn't find bleuart service</span></li><li class="L4"><span class="pln">    </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Central</span><span class="pun">.</span><span class="pln">disconnect</span><span class="pun">(</span><span class="pln">conn_handle</span><span class="pun">);</span></li><li class="L5"><span class="pln">  </span><span class="pun">}</span><span class="pln">  </span></li><li class="L6"><span class="pun">}</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#full-sample-code-15-14" class="anchor-link"><span class="fa fa-link"></span></a><span id="full-sample-code-15-14" class="anchor-link-target"></span><span id="full-sample-code" class="anchor-link-target"></span>Full Sample Code</h1>
<p>The full sample code for this example can be seen below:</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/11267/elements/3014346/download?type=zip">
Project Zip
</a> <span class="divider">or</span>
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/11267/elements/3014346/download">
central_bleuart.ino
</a> <span class="divider visible-lg-inline">|</span>
<a target="_blank" class="visible-lg-inline" href="https://github.com/adafruit/Adafruit_nRF52_Arduino/blob/master/libraries/Bluefruit52Lib/examples/Central/central_bleuart/central_bleuart.ino">
<i class="fa fa-github"></i>
View on Github
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">/*********************************************************************
 This is an example for our nRF52 based Bluefruit LE modules

 Pick one up today in the adafruit shop!

 Adafruit invests time and resources providing this open source code,
 please support Adafruit and open-source hardware by purchasing
 products from Adafruit!

 MIT license, check LICENSE for more information
 All text above, and the splash screen below must be included in
 any redistribution
*********************************************************************/

/*
 * This sketch demonstrate the central API(). A additional bluefruit
 * that has bleuart as peripheral is required for the demo.
 */
#include &lt;bluefruit.h&gt;

BLEClientBas  clientBas;  // battery client
BLEClientDis  clientDis;  // device information client
BLEClientUart clientUart; // bleuart client

void setup()
{
  Serial.begin(115200);
  while ( !Serial ) delay(10);   // for nrf52840 with native usb

  Serial.println("Bluefruit52 Central BLEUART Example");
  Serial.println("-----------------------------------\n");
  
  // Initialize Bluefruit with maximum connections as Peripheral = 0, Central = 1
  // SRAM usage required by SoftDevice will increase dramatically with number of connections
  Bluefruit.begin(0, 1);
  
  Bluefruit.setName("Bluefruit52 Central");

  // Configure Battyer client
  clientBas.begin();  

  // Configure DIS client
  clientDis.begin();

  // Init BLE Central Uart Serivce
  clientUart.begin();
  clientUart.setRxCallback(bleuart_rx_callback);

  // Increase Blink rate to different from PrPh advertising mode
  Bluefruit.setConnLedInterval(250);

  // Callbacks for Central
  Bluefruit.Central.setConnectCallback(connect_callback);
  Bluefruit.Central.setDisconnectCallback(disconnect_callback);

  /* Start Central Scanning
   * - Enable auto scan if disconnected
   * - Interval = 100 ms, window = 80 ms
   * - Don't use active scan
   * - Start(timeout) with timeout = 0 will scan forever (until connected)
   */
  Bluefruit.Scanner.setRxCallback(scan_callback);
  Bluefruit.Scanner.restartOnDisconnect(true);
  Bluefruit.Scanner.setInterval(160, 80); // in unit of 0.625 ms
  Bluefruit.Scanner.useActiveScan(false);
  Bluefruit.Scanner.start(0);                   // // 0 = Don't stop scanning after n seconds
}

/**
 * Callback invoked when scanner pick up an advertising data
 * @param report Structural advertising data
 */
void scan_callback(ble_gap_evt_adv_report_t* report)
{
  // Check if advertising contain BleUart service
  if ( Bluefruit.Scanner.checkReportForService(report, clientUart) )
  {
    Serial.print("BLE UART service detected. Connecting ... ");

    // Connect to device with bleuart service in advertising
    Bluefruit.Central.connect(report);
  }else
  {      
    // For Softdevice v6: after received a report, scanner will be paused
    // We need to call Scanner resume() to continue scanning
    Bluefruit.Scanner.resume();
  }
}

/**
 * Callback invoked when an connection is established
 * @param conn_handle
 */
void connect_callback(uint16_t conn_handle)
{
  Serial.println("Connected");

  Serial.print("Dicovering Device Information ... ");
  if ( clientDis.discover(conn_handle) )
  {
    Serial.println("Found it");
    char buffer[32+1];
    
    // read and print out Manufacturer
    memset(buffer, 0, sizeof(buffer));
    if ( clientDis.getManufacturer(buffer, sizeof(buffer)) )
    {
      Serial.print("Manufacturer: ");
      Serial.println(buffer);
    }

    // read and print out Model Number
    memset(buffer, 0, sizeof(buffer));
    if ( clientDis.getModel(buffer, sizeof(buffer)) )
    {
      Serial.print("Model: ");
      Serial.println(buffer);
    }

    Serial.println();
  }else
  {
    Serial.println("Found NONE");
  }

  Serial.print("Dicovering Battery ... ");
  if ( clientBas.discover(conn_handle) )
  {
    Serial.println("Found it");
    Serial.print("Battery level: ");
    Serial.print(clientBas.read());
    Serial.println("%");
  }else
  {
    Serial.println("Found NONE");
  }

  Serial.print("Discovering BLE Uart Service ... ");
  if ( clientUart.discover(conn_handle) )
  {
    Serial.println("Found it");

    Serial.println("Enable TXD's notify");
    clientUart.enableTXD();

    Serial.println("Ready to receive from peripheral");
  }else
  {
    Serial.println("Found NONE");
    
    // disconnect since we couldn't find bleuart service
    Bluefruit.disconnect(conn_handle);
  }  
}

/**
 * Callback invoked when a connection is dropped
 * @param conn_handle
 * @param reason is a BLE_HCI_STATUS_CODE which can be found in ble_hci.h
 */
void disconnect_callback(uint16_t conn_handle, uint8_t reason)
{
  (void) conn_handle;
  (void) reason;
  
  Serial.println("Disconnected");
}

/**
 * Callback invoked when uart received data
 * @param uart_svc Reference object to the service where the data 
 * arrived. In this example it is clientUart
 */
void bleuart_rx_callback(BLEClientUart&amp; uart_svc)
{
  Serial.print("[RX]: ");
  
  while ( uart_svc.available() )
  {
    Serial.print( (char) uart_svc.read() );
  }

  Serial.println();
}

void loop()
{
  if ( Bluefruit.Central.connected() )
  {
    // Not discovered yet
    if ( clientUart.discovered() )
    {
      // Discovered means in working state
      // Get Serial input and send to Peripheral
      if ( Serial.available() )
      {
        delay(2); // delay a bit for all characters to arrive
        
        char str[20+1] = { 0 };
        Serial.readBytes(str, 20);
        
        clientUart.print( str );
      }
    }
  }
}
</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="com">/*********************************************************************</span></li><li class="L1"><span class="com"> This is an example for our nRF52 based Bluefruit LE modules</span></li><li class="L2"><span class="com">&nbsp;</span></li><li class="L3"><span class="com"> Pick one up today in the adafruit shop!</span></li><li class="L4"><span class="com">&nbsp;</span></li><li class="L5"><span class="com"> Adafruit invests time and resources providing this open source code,</span></li><li class="L6"><span class="com"> please support Adafruit and open-source hardware by purchasing</span></li><li class="L7"><span class="com"> products from Adafruit!</span></li><li class="L8"><span class="com">&nbsp;</span></li><li class="L9"><span class="com"> MIT license, check LICENSE for more information</span></li><li class="L0"><span class="com"> All text above, and the splash screen below must be included in</span></li><li class="L1"><span class="com"> any redistribution</span></li><li class="L2"><span class="com">*********************************************************************/</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="com">/*</span></li><li class="L5"><span class="com"> * This sketch demonstrate the central API(). A additional bluefruit</span></li><li class="L6"><span class="com"> * that has bleuart as peripheral is required for the demo.</span></li><li class="L7"><span class="com"> */</span></li><li class="L8"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;bluefruit.h&gt;</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="typ">BLEClientBas</span><span class="pln">  clientBas</span><span class="pun">;</span><span class="pln">  </span><span class="com">// battery client</span></li><li class="L1"><span class="typ">BLEClientDis</span><span class="pln">  clientDis</span><span class="pun">;</span><span class="pln">  </span><span class="com">// device information client</span></li><li class="L2"><span class="typ">BLEClientUart</span><span class="pln"> clientUart</span><span class="pun">;</span><span class="pln"> </span><span class="com">// bleuart client</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="kwd">void</span><span class="pln"> setup</span><span class="pun">()</span></li><li class="L5"><span class="pun">{</span></li><li class="L6"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">(</span><span class="lit">115200</span><span class="pun">);</span></li><li class="L7"><span class="pln">  </span><span class="kwd">while</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="typ">Serial</span><span class="pln"> </span><span class="pun">)</span><span class="pln"> delay</span><span class="pun">(</span><span class="lit">10</span><span class="pun">);</span><span class="pln">   </span><span class="com">// for nrf52840 with native usb</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Bluefruit52 Central BLEUART Example"</span><span class="pun">);</span></li><li class="L0"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"-----------------------------------\n"</span><span class="pun">);</span></li><li class="L1"><span class="pln">  </span></li><li class="L2"><span class="pln">  </span><span class="com">// Initialize Bluefruit with maximum connections as Peripheral = 0, Central = 1</span></li><li class="L3"><span class="pln">  </span><span class="com">// SRAM usage required by SoftDevice will increase dramatically with number of connections</span></li><li class="L4"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">(</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">);</span></li><li class="L5"><span class="pln">  </span></li><li class="L6"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="pln">setName</span><span class="pun">(</span><span class="str">"Bluefruit52 Central"</span><span class="pun">);</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">  </span><span class="com">// Configure Battyer client</span></li><li class="L9"><span class="pln">  clientBas</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span><span class="pln">  </span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">  </span><span class="com">// Configure DIS client</span></li><li class="L2"><span class="pln">  clientDis</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln">  </span><span class="com">// Init BLE Central Uart Serivce</span></li><li class="L5"><span class="pln">  clientUart</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L6"><span class="pln">  clientUart</span><span class="pun">.</span><span class="pln">setRxCallback</span><span class="pun">(</span><span class="pln">bleuart_rx_callback</span><span class="pun">);</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">  </span><span class="com">// Increase Blink rate to different from PrPh advertising mode</span></li><li class="L9"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="pln">setConnLedInterval</span><span class="pun">(</span><span class="lit">250</span><span class="pun">);</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">  </span><span class="com">// Callbacks for Central</span></li><li class="L2"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Central</span><span class="pun">.</span><span class="pln">setConnectCallback</span><span class="pun">(</span><span class="pln">connect_callback</span><span class="pun">);</span></li><li class="L3"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Central</span><span class="pun">.</span><span class="pln">setDisconnectCallback</span><span class="pun">(</span><span class="pln">disconnect_callback</span><span class="pun">);</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">  </span><span class="com">/* Start Central Scanning</span></li><li class="L6"><span class="com">   * - Enable auto scan if disconnected</span></li><li class="L7"><span class="com">   * - Interval = 100 ms, window = 80 ms</span></li><li class="L8"><span class="com">   * - Don't use active scan</span></li><li class="L9"><span class="com">   * - Start(timeout) with timeout = 0 will scan forever (until connected)</span></li><li class="L0"><span class="com">   */</span></li><li class="L1"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Scanner</span><span class="pun">.</span><span class="pln">setRxCallback</span><span class="pun">(</span><span class="pln">scan_callback</span><span class="pun">);</span></li><li class="L2"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Scanner</span><span class="pun">.</span><span class="pln">restartOnDisconnect</span><span class="pun">(</span><span class="kwd">true</span><span class="pun">);</span></li><li class="L3"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Scanner</span><span class="pun">.</span><span class="pln">setInterval</span><span class="pun">(</span><span class="lit">160</span><span class="pun">,</span><span class="pln"> </span><span class="lit">80</span><span class="pun">);</span><span class="pln"> </span><span class="com">// in unit of 0.625 ms</span></li><li class="L4"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Scanner</span><span class="pun">.</span><span class="pln">useActiveScan</span><span class="pun">(</span><span class="kwd">false</span><span class="pun">);</span></li><li class="L5"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Scanner</span><span class="pun">.</span><span class="pln">start</span><span class="pun">(</span><span class="lit">0</span><span class="pun">);</span><span class="pln">                   </span><span class="com">// // 0 = Don't stop scanning after n seconds</span></li><li class="L6"><span class="pun">}</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="com">/**</span></li><li class="L9"><span class="com"> * Callback invoked when scanner pick up an advertising data</span></li><li class="L0"><span class="com"> * @param report Structural advertising data</span></li><li class="L1"><span class="com"> */</span></li><li class="L2"><span class="kwd">void</span><span class="pln"> scan_callback</span><span class="pun">(</span><span class="typ">ble_gap_evt_adv_report_t</span><span class="pun">*</span><span class="pln"> report</span><span class="pun">)</span></li><li class="L3"><span class="pun">{</span></li><li class="L4"><span class="pln">  </span><span class="com">// Check if advertising contain BleUart service</span></li><li class="L5"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Scanner</span><span class="pun">.</span><span class="pln">checkReportForService</span><span class="pun">(</span><span class="pln">report</span><span class="pun">,</span><span class="pln"> clientUart</span><span class="pun">)</span><span class="pln"> </span><span class="pun">)</span></li><li class="L6"><span class="pln">  </span><span class="pun">{</span></li><li class="L7"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"BLE UART service detected. Connecting ... "</span><span class="pun">);</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="pln">    </span><span class="com">// Connect to device with bleuart service in advertising</span></li><li class="L0"><span class="pln">    </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Central</span><span class="pun">.</span><span class="pln">connect</span><span class="pun">(</span><span class="pln">report</span><span class="pun">);</span></li><li class="L1"><span class="pln">  </span><span class="pun">}</span><span class="kwd">else</span></li><li class="L2"><span class="pln">  </span><span class="pun">{</span><span class="pln">      </span></li><li class="L3"><span class="pln">    </span><span class="com">// For Softdevice v6: after received a report, scanner will be paused</span></li><li class="L4"><span class="pln">    </span><span class="com">// We need to call Scanner resume() to continue scanning</span></li><li class="L5"><span class="pln">    </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Scanner</span><span class="pun">.</span><span class="pln">resume</span><span class="pun">();</span></li><li class="L6"><span class="pln">  </span><span class="pun">}</span></li><li class="L7"><span class="pun">}</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="com">/**</span></li><li class="L0"><span class="com"> * Callback invoked when an connection is established</span></li><li class="L1"><span class="com"> * @param conn_handle</span></li><li class="L2"><span class="com"> */</span></li><li class="L3"><span class="kwd">void</span><span class="pln"> connect_callback</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> conn_handle</span><span class="pun">)</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Connected"</span><span class="pun">);</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"Dicovering Device Information ... "</span><span class="pun">);</span></li><li class="L8"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> clientDis</span><span class="pun">.</span><span class="pln">discover</span><span class="pun">(</span><span class="pln">conn_handle</span><span class="pun">)</span><span class="pln"> </span><span class="pun">)</span></li><li class="L9"><span class="pln">  </span><span class="pun">{</span></li><li class="L0"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Found it"</span><span class="pun">);</span></li><li class="L1"><span class="pln">    </span><span class="kwd">char</span><span class="pln"> buffer</span><span class="pun">[</span><span class="lit">32</span><span class="pun">+</span><span class="lit">1</span><span class="pun">];</span></li><li class="L2"><span class="pln">    </span></li><li class="L3"><span class="pln">    </span><span class="com">// read and print out Manufacturer</span></li><li class="L4"><span class="pln">    memset</span><span class="pun">(</span><span class="pln">buffer</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">sizeof</span><span class="pun">(</span><span class="pln">buffer</span><span class="pun">));</span></li><li class="L5"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> clientDis</span><span class="pun">.</span><span class="pln">getManufacturer</span><span class="pun">(</span><span class="pln">buffer</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">sizeof</span><span class="pun">(</span><span class="pln">buffer</span><span class="pun">))</span><span class="pln"> </span><span class="pun">)</span></li><li class="L6"><span class="pln">    </span><span class="pun">{</span></li><li class="L7"><span class="pln">      </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"Manufacturer: "</span><span class="pun">);</span></li><li class="L8"><span class="pln">      </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="pln">buffer</span><span class="pun">);</span></li><li class="L9"><span class="pln">    </span><span class="pun">}</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">    </span><span class="com">// read and print out Model Number</span></li><li class="L2"><span class="pln">    memset</span><span class="pun">(</span><span class="pln">buffer</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">sizeof</span><span class="pun">(</span><span class="pln">buffer</span><span class="pun">));</span></li><li class="L3"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> clientDis</span><span class="pun">.</span><span class="pln">getModel</span><span class="pun">(</span><span class="pln">buffer</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">sizeof</span><span class="pun">(</span><span class="pln">buffer</span><span class="pun">))</span><span class="pln"> </span><span class="pun">)</span></li><li class="L4"><span class="pln">    </span><span class="pun">{</span></li><li class="L5"><span class="pln">      </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"Model: "</span><span class="pun">);</span></li><li class="L6"><span class="pln">      </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="pln">buffer</span><span class="pun">);</span></li><li class="L7"><span class="pln">    </span><span class="pun">}</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">();</span></li><li class="L0"><span class="pln">  </span><span class="pun">}</span><span class="kwd">else</span></li><li class="L1"><span class="pln">  </span><span class="pun">{</span></li><li class="L2"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Found NONE"</span><span class="pun">);</span></li><li class="L3"><span class="pln">  </span><span class="pun">}</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"Dicovering Battery ... "</span><span class="pun">);</span></li><li class="L6"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> clientBas</span><span class="pun">.</span><span class="pln">discover</span><span class="pun">(</span><span class="pln">conn_handle</span><span class="pun">)</span><span class="pln"> </span><span class="pun">)</span></li><li class="L7"><span class="pln">  </span><span class="pun">{</span></li><li class="L8"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Found it"</span><span class="pun">);</span></li><li class="L9"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"Battery level: "</span><span class="pun">);</span></li><li class="L0"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="pln">clientBas</span><span class="pun">.</span><span class="pln">read</span><span class="pun">());</span></li><li class="L1"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"%"</span><span class="pun">);</span></li><li class="L2"><span class="pln">  </span><span class="pun">}</span><span class="kwd">else</span></li><li class="L3"><span class="pln">  </span><span class="pun">{</span></li><li class="L4"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Found NONE"</span><span class="pun">);</span></li><li class="L5"><span class="pln">  </span><span class="pun">}</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"Discovering BLE Uart Service ... "</span><span class="pun">);</span></li><li class="L8"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> clientUart</span><span class="pun">.</span><span class="pln">discover</span><span class="pun">(</span><span class="pln">conn_handle</span><span class="pun">)</span><span class="pln"> </span><span class="pun">)</span></li><li class="L9"><span class="pln">  </span><span class="pun">{</span></li><li class="L0"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Found it"</span><span class="pun">);</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Enable TXD's notify"</span><span class="pun">);</span></li><li class="L3"><span class="pln">    clientUart</span><span class="pun">.</span><span class="pln">enableTXD</span><span class="pun">();</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Ready to receive from peripheral"</span><span class="pun">);</span></li><li class="L6"><span class="pln">  </span><span class="pun">}</span><span class="kwd">else</span></li><li class="L7"><span class="pln">  </span><span class="pun">{</span></li><li class="L8"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Found NONE"</span><span class="pun">);</span></li><li class="L9"><span class="pln">    </span></li><li class="L0"><span class="pln">    </span><span class="com">// disconnect since we couldn't find bleuart service</span></li><li class="L1"><span class="pln">    </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="pln">disconnect</span><span class="pun">(</span><span class="pln">conn_handle</span><span class="pun">);</span></li><li class="L2"><span class="pln">  </span><span class="pun">}</span><span class="pln">  </span></li><li class="L3"><span class="pun">}</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="com">/**</span></li><li class="L6"><span class="com"> * Callback invoked when a connection is dropped</span></li><li class="L7"><span class="com"> * @param conn_handle</span></li><li class="L8"><span class="com"> * @param reason is a BLE_HCI_STATUS_CODE which can be found in ble_hci.h</span></li><li class="L9"><span class="com"> */</span></li><li class="L0"><span class="kwd">void</span><span class="pln"> disconnect_callback</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> conn_handle</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pln"> reason</span><span class="pun">)</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="pln">  </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span><span class="pln"> conn_handle</span><span class="pun">;</span></li><li class="L3"><span class="pln">  </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span><span class="pln"> reason</span><span class="pun">;</span></li><li class="L4"><span class="pln">  </span></li><li class="L5"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Disconnected"</span><span class="pun">);</span></li><li class="L6"><span class="pun">}</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="com">/**</span></li><li class="L9"><span class="com"> * Callback invoked when uart received data</span></li><li class="L0"><span class="com"> * @param uart_svc Reference object to the service where the data </span></li><li class="L1"><span class="com"> * arrived. In this example it is clientUart</span></li><li class="L2"><span class="com"> */</span></li><li class="L3"><span class="kwd">void</span><span class="pln"> bleuart_rx_callback</span><span class="pun">(</span><span class="typ">BLEClientUart</span><span class="pun">&amp;</span><span class="pln"> uart_svc</span><span class="pun">)</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"[RX]: "</span><span class="pun">);</span></li><li class="L6"><span class="pln">  </span></li><li class="L7"><span class="pln">  </span><span class="kwd">while</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> uart_svc</span><span class="pun">.</span><span class="pln">available</span><span class="pun">()</span><span class="pln"> </span><span class="pun">)</span></li><li class="L8"><span class="pln">  </span><span class="pun">{</span></li><li class="L9"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">char</span><span class="pun">)</span><span class="pln"> uart_svc</span><span class="pun">.</span><span class="pln">read</span><span class="pun">()</span><span class="pln"> </span><span class="pun">);</span></li><li class="L0"><span class="pln">  </span><span class="pun">}</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">();</span></li><li class="L3"><span class="pun">}</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="kwd">void</span><span class="pln"> loop</span><span class="pun">()</span></li><li class="L6"><span class="pun">{</span></li><li class="L7"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Central</span><span class="pun">.</span><span class="pln">connected</span><span class="pun">()</span><span class="pln"> </span><span class="pun">)</span></li><li class="L8"><span class="pln">  </span><span class="pun">{</span></li><li class="L9"><span class="pln">    </span><span class="com">// Not discovered yet</span></li><li class="L0"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> clientUart</span><span class="pun">.</span><span class="pln">discovered</span><span class="pun">()</span><span class="pln"> </span><span class="pun">)</span></li><li class="L1"><span class="pln">    </span><span class="pun">{</span></li><li class="L2"><span class="pln">      </span><span class="com">// Discovered means in working state</span></li><li class="L3"><span class="pln">      </span><span class="com">// Get Serial input and send to Peripheral</span></li><li class="L4"><span class="pln">      </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">available</span><span class="pun">()</span><span class="pln"> </span><span class="pun">)</span></li><li class="L5"><span class="pln">      </span><span class="pun">{</span></li><li class="L6"><span class="pln">        delay</span><span class="pun">(</span><span class="lit">2</span><span class="pun">);</span><span class="pln"> </span><span class="com">// delay a bit for all characters to arrive</span></li><li class="L7"><span class="pln">        </span></li><li class="L8"><span class="pln">        </span><span class="kwd">char</span><span class="pln"> str</span><span class="pun">[</span><span class="lit">20</span><span class="pun">+</span><span class="lit">1</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="lit">0</span><span class="pln"> </span><span class="pun">};</span></li><li class="L9"><span class="pln">        </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">readBytes</span><span class="pun">(</span><span class="pln">str</span><span class="pun">,</span><span class="pln"> </span><span class="lit">20</span><span class="pun">);</span></li><li class="L0"><span class="pln">        </span></li><li class="L1"><span class="pln">        clientUart</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="pln"> str </span><span class="pun">);</span></li><li class="L2"><span class="pln">      </span><span class="pun">}</span></li><li class="L3"><span class="pln">    </span><span class="pun">}</span></li><li class="L4"><span class="pln">  </span><span class="pun">}</span></li><li class="L5"><span class="pun">}</span></li></ol></pre>
</div>
</div>
</div>
<div class="page-title-wrapper">
<h1 class="headline">
<span id="dual-roles-bleuart">Dual Roles BLEUART</span>
</h1>
<div class="author">by
<a href="./nRF52_bluefruit_Learning_Guide.html#dual-roles-bleuart">
<span class="name">Thach Ha</span>
</a> </div>
</div>
<div class="page-content all-page-view-content">
<div class="">
<div class="element element element element element element element element element element element element element element element element row-fluid build-alert alert-info">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
If you are not familiar with Central Role, it is advised to look at the "Central BLEUART" example first then continue with this afterwards.
</div>
</div>
<div class="row-fluid build-text">
<p>This example demonstrates how you can use a Feather nRF52/nRF52840 to connect to two other Bluefruit or BLE devices using the bleuart (AKA 'NUS') service concurrently, with the device running at both&nbsp;a peripheral and a central at the same time.</p>
<p>This dual role example acts as a BLE bridge that sits between a central and a peripheral forwarding bleuart messages back and forth, as shown in the image below:</p>
</div>
<div class="row-fluid build-image">
<a href="./nRF52_bluefruit_Learning_Guide.html#dual-roles-bleuart">
<img class="49793-asset img-responsive" src="./nRF52_bluefruit_Learning_Guide/microcontrollers_dual_roles.jpg" alt="microcontrollers_dual_roles.jpg">
<span class="image-expand"><i class="fa fa-search-plus"></i></span>
</a> </div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#server-and-client-service-setup-16-4" class="anchor-link"><span class="fa fa-link"></span></a><span id="server-and-client-service-setup-16-4" class="anchor-link-target"></span><span id="server-and-client-service-setup" class="anchor-link-target"></span>Server &amp; Client Service Setup</h1>
<p>Since the Bluefruit device will act as both a central and a peripheral, we will need to declare both server and client instance of the bleuart helper class:</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/11268/elements/2979345/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">// Peripheral uart service
BLEUart bleuart;

// Central uart client
BLEClientUart clientUart;</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="com">// Peripheral uart service</span></li><li class="L1"><span class="typ">BLEUart</span><span class="pln"> bleuart</span><span class="pun">;</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="com">// Central uart client</span></li><li class="L4"><span class="typ">BLEClientUart</span><span class="pln"> clientUart</span><span class="pun">;</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<p>Before we can configure client services, <code>Bluefruit.begin()</code> must be called with at least 1 for the number of concurrent connection for both peripheral and central mode:</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/11268/elements/2979347/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">// Initialize Bluefruit with max concurrent connections as Peripheral = 1, Central = 1
Bluefruit.begin(1, 1);</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="com">// Initialize Bluefruit with max concurrent connections as Peripheral = 1, Central = 1</span></li><li class="L1"><span class="typ">Bluefruit</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">(</span><span class="lit">1</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">);</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<p>After this, client services must be initialized by calling their <code>begin()</code> function, followed by any callbacks that you wish to wire up as well:</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/11268/elements/2979349/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">// Configure and Start BLE Uart Service
bleuart.begin();
bleuart.setRxCallback(prph_bleuart_rx_callback);

// Init BLE Central Uart Serivce
clientUart.begin();
clientUart.setRxCallback(cent_bleuart_rx_callback);</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="com">// Configure and Start BLE Uart Service</span></li><li class="L1"><span class="pln">bleuart</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L2"><span class="pln">bleuart</span><span class="pun">.</span><span class="pln">setRxCallback</span><span class="pun">(</span><span class="pln">prph_bleuart_rx_callback</span><span class="pun">);</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="com">// Init BLE Central Uart Serivce</span></li><li class="L5"><span class="pln">clientUart</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L6"><span class="pln">clientUart</span><span class="pun">.</span><span class="pln">setRxCallback</span><span class="pun">(</span><span class="pln">cent_bleuart_rx_callback</span><span class="pun">);</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<p>We are then ready to forward data from central to peripheral and vice versa using callbacks:</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/11268/elements/2979359/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">void cent_bleuart_rx_callback(BLEClientUart&amp; cent_uart)
{
  char str[20+1] = { 0 };
  cent_uart.read(str, 20);
      
  Serial.print("[Cent] RX: ");
  Serial.println(str);

  if ( bleuart.notifyEnabled() )
  {
    // Forward data from our peripheral to Mobile
    bleuart.print( str );
  }else
  {
    // response with no prph message
    clientUart.println("[Cent] Peripheral role not connected");
  }  
}

void prph_bleuart_rx_callback(void)
{
  // Forward data from Mobile to our peripheral
  char str[20+1] = { 0 };
  bleuart.read(str, 20);

  Serial.print("[Prph] RX: ");
  Serial.println(str);  

  if ( clientUart.discovered() )
  {
    clientUart.print(str);
  }else
  {
    bleuart.println("[Prph] Central role not connected");
  }
}
</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="kwd">void</span><span class="pln"> cent_bleuart_rx_callback</span><span class="pun">(</span><span class="typ">BLEClientUart</span><span class="pun">&amp;</span><span class="pln"> cent_uart</span><span class="pun">)</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="pln">  </span><span class="kwd">char</span><span class="pln"> str</span><span class="pun">[</span><span class="lit">20</span><span class="pun">+</span><span class="lit">1</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="lit">0</span><span class="pln"> </span><span class="pun">};</span></li><li class="L3"><span class="pln">  cent_uart</span><span class="pun">.</span><span class="pln">read</span><span class="pun">(</span><span class="pln">str</span><span class="pun">,</span><span class="pln"> </span><span class="lit">20</span><span class="pun">);</span></li><li class="L4"><span class="pln">      </span></li><li class="L5"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"[Cent] RX: "</span><span class="pun">);</span></li><li class="L6"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="pln">str</span><span class="pun">);</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> bleuart</span><span class="pun">.</span><span class="pln">notifyEnabled</span><span class="pun">()</span><span class="pln"> </span><span class="pun">)</span></li><li class="L9"><span class="pln">  </span><span class="pun">{</span></li><li class="L0"><span class="pln">    </span><span class="com">// Forward data from our peripheral to Mobile</span></li><li class="L1"><span class="pln">    bleuart</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="pln"> str </span><span class="pun">);</span></li><li class="L2"><span class="pln">  </span><span class="pun">}</span><span class="kwd">else</span></li><li class="L3"><span class="pln">  </span><span class="pun">{</span></li><li class="L4"><span class="pln">    </span><span class="com">// response with no prph message</span></li><li class="L5"><span class="pln">    clientUart</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"[Cent] Peripheral role not connected"</span><span class="pun">);</span></li><li class="L6"><span class="pln">  </span><span class="pun">}</span><span class="pln">  </span></li><li class="L7"><span class="pun">}</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="kwd">void</span><span class="pln"> prph_bleuart_rx_callback</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span></li><li class="L0"><span class="pun">{</span></li><li class="L1"><span class="pln">  </span><span class="com">// Forward data from Mobile to our peripheral</span></li><li class="L2"><span class="pln">  </span><span class="kwd">char</span><span class="pln"> str</span><span class="pun">[</span><span class="lit">20</span><span class="pun">+</span><span class="lit">1</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="lit">0</span><span class="pln"> </span><span class="pun">};</span></li><li class="L3"><span class="pln">  bleuart</span><span class="pun">.</span><span class="pln">read</span><span class="pun">(</span><span class="pln">str</span><span class="pun">,</span><span class="pln"> </span><span class="lit">20</span><span class="pun">);</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"[Prph] RX: "</span><span class="pun">);</span></li><li class="L6"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="pln">str</span><span class="pun">);</span><span class="pln">  </span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> clientUart</span><span class="pun">.</span><span class="pln">discovered</span><span class="pun">()</span><span class="pln"> </span><span class="pun">)</span></li><li class="L9"><span class="pln">  </span><span class="pun">{</span></li><li class="L0"><span class="pln">    clientUart</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="pln">str</span><span class="pun">);</span></li><li class="L1"><span class="pln">  </span><span class="pun">}</span><span class="kwd">else</span></li><li class="L2"><span class="pln">  </span><span class="pun">{</span></li><li class="L3"><span class="pln">    bleuart</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"[Prph] Central role not connected"</span><span class="pun">);</span></li><li class="L4"><span class="pln">  </span><span class="pun">}</span></li><li class="L5"><span class="pun">}</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#peripheral-role-16-12" class="anchor-link"><span class="fa fa-link"></span></a><span id="peripheral-role-16-12" class="anchor-link-target"></span><span id="peripheral-role" class="anchor-link-target"></span>Peripheral Role</h1>
<p>The first thing to do for the peripheral part of our code is to setup the <strong>connect callback</strong>, which fires when a connection is established/disconnected with the central. Alternatively you could poll the connection status with connected(), but callbacks helps to simplify the code significantly:</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/11268/elements/2979351/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">// Callbacks for Peripheral
Bluefruit.setConnectCallback(prph_connect_callback);
Bluefruit.setDisconnectCallback(prph_disconnect_callback);</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="com">// Callbacks for Peripheral</span></li><li class="L1"><span class="typ">Bluefruit</span><span class="pun">.</span><span class="pln">setConnectCallback</span><span class="pun">(</span><span class="pln">prph_connect_callback</span><span class="pun">);</span></li><li class="L2"><span class="typ">Bluefruit</span><span class="pun">.</span><span class="pln">setDisconnectCallback</span><span class="pun">(</span><span class="pln">prph_disconnect_callback</span><span class="pun">);</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#central-role-16-14" class="anchor-link"><span class="fa fa-link"></span></a><span id="central-role-16-14" class="anchor-link-target"></span><span id="central-role" class="anchor-link-target"></span>Central Role</h1>
<p>Next we setup the Central mode <strong>connect callback</strong>, which fires when a connection is established/disconnected with a peripheral device:</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/11268/elements/2979355/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">// Callbacks for Central
Bluefruit.Central.setConnectCallback(cent_connect_callback);
Bluefruit.Central.setDisconnectCallback(cent_disconnect_callback);</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="com">// Callbacks for Central</span></li><li class="L1"><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Central</span><span class="pun">.</span><span class="pln">setConnectCallback</span><span class="pun">(</span><span class="pln">cent_connect_callback</span><span class="pun">);</span></li><li class="L2"><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Central</span><span class="pun">.</span><span class="pln">setDisconnectCallback</span><span class="pun">(</span><span class="pln">cent_disconnect_callback</span><span class="pun">);</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#advertising-and-scanner-16-16" class="anchor-link"><span class="fa fa-link"></span></a><span id="advertising-and-scanner-16-16" class="anchor-link-target"></span><span id="advertising-and-scanner" class="anchor-link-target"></span>Advertising and Scanner</h1>
<p>It is possible to start both the scanner and advertising at the same time so that we can discover and be discovered by other BLE devices. For the scanner, we use a filter that only fires the callback if a specific UUID is found in the advertising data of the peer device:</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/11268/elements/2979357/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">/* Start Central Scanning
 * - Enable auto scan if disconnected
 * - Interval = 100 ms, window = 80 ms
 * - Filter only accept bleuart service
 * - Don't use active scan
 * - Start(timeout) with timeout = 0 will scan forever (until connected)
 */
Bluefruit.Scanner.setRxCallback(scan_callback);
Bluefruit.Scanner.restartOnDisconnect(true);
Bluefruit.Scanner.setInterval(160, 80); // in unit of 0.625 ms
Bluefruit.Scanner.filterUuid(bleuart.uuid);
Bluefruit.Scanner.useActiveScan(false);
Bluefruit.Scanner.start(0);                   // 0 = Don't stop scanning after n seconds

// Advertising packet
Bluefruit.Advertising.addFlags(BLE_GAP_ADV_FLAGS_LE_ONLY_GENERAL_DISC_MODE);
Bluefruit.Advertising.addTxPower();

// Include bleuart 128-bit uuid
Bluefruit.Advertising.addService(bleuart);

// Secondary Scan Response packet (optional)
// Since there is no room for 'Name' in Advertising packet
Bluefruit.ScanResponse.addName();

/* Start Advertising
 * - Enable auto advertising if disconnected
 * - Interval:  fast mode = 20 ms, slow mode = 152.5 ms
 * - Timeout for fast mode is 30 seconds
 * - Start(timeout) with timeout = 0 will advertise forever (until connected)
 *
 * For recommended advertising interval
 * https://developer.apple.com/library/content/qa/qa1931/_index.html
 */
Bluefruit.Advertising.restartOnDisconnect(true);
Bluefruit.Advertising.setInterval(32, 244);    // in unit of 0.625 ms
Bluefruit.Advertising.setFastTimeout(30);      // number of seconds in fast mode
Bluefruit.Advertising.start(0);                // 0 = Don't stop advertising after n seconds</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="com">/* Start Central Scanning</span></li><li class="L1"><span class="com"> * - Enable auto scan if disconnected</span></li><li class="L2"><span class="com"> * - Interval = 100 ms, window = 80 ms</span></li><li class="L3"><span class="com"> * - Filter only accept bleuart service</span></li><li class="L4"><span class="com"> * - Don't use active scan</span></li><li class="L5"><span class="com"> * - Start(timeout) with timeout = 0 will scan forever (until connected)</span></li><li class="L6"><span class="com"> */</span></li><li class="L7"><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Scanner</span><span class="pun">.</span><span class="pln">setRxCallback</span><span class="pun">(</span><span class="pln">scan_callback</span><span class="pun">);</span></li><li class="L8"><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Scanner</span><span class="pun">.</span><span class="pln">restartOnDisconnect</span><span class="pun">(</span><span class="kwd">true</span><span class="pun">);</span></li><li class="L9"><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Scanner</span><span class="pun">.</span><span class="pln">setInterval</span><span class="pun">(</span><span class="lit">160</span><span class="pun">,</span><span class="pln"> </span><span class="lit">80</span><span class="pun">);</span><span class="pln"> </span><span class="com">// in unit of 0.625 ms</span></li><li class="L0"><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Scanner</span><span class="pun">.</span><span class="pln">filterUuid</span><span class="pun">(</span><span class="pln">bleuart</span><span class="pun">.</span><span class="pln">uuid</span><span class="pun">);</span></li><li class="L1"><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Scanner</span><span class="pun">.</span><span class="pln">useActiveScan</span><span class="pun">(</span><span class="kwd">false</span><span class="pun">);</span></li><li class="L2"><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Scanner</span><span class="pun">.</span><span class="pln">start</span><span class="pun">(</span><span class="lit">0</span><span class="pun">);</span><span class="pln">                   </span><span class="com">// 0 = Don't stop scanning after n seconds</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="com">// Advertising packet</span></li><li class="L5"><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">addFlags</span><span class="pun">(</span><span class="pln">BLE_GAP_ADV_FLAGS_LE_ONLY_GENERAL_DISC_MODE</span><span class="pun">);</span></li><li class="L6"><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">addTxPower</span><span class="pun">();</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="com">// Include bleuart 128-bit uuid</span></li><li class="L9"><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">addService</span><span class="pun">(</span><span class="pln">bleuart</span><span class="pun">);</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="com">// Secondary Scan Response packet (optional)</span></li><li class="L2"><span class="com">// Since there is no room for 'Name' in Advertising packet</span></li><li class="L3"><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">ScanResponse</span><span class="pun">.</span><span class="pln">addName</span><span class="pun">();</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="com">/* Start Advertising</span></li><li class="L6"><span class="com"> * - Enable auto advertising if disconnected</span></li><li class="L7"><span class="com"> * - Interval:  fast mode = 20 ms, slow mode = 152.5 ms</span></li><li class="L8"><span class="com"> * - Timeout for fast mode is 30 seconds</span></li><li class="L9"><span class="com"> * - Start(timeout) with timeout = 0 will advertise forever (until connected)</span></li><li class="L0"><span class="com"> *</span></li><li class="L1"><span class="com"> * For recommended advertising interval</span></li><li class="L2"><span class="com"> * https://developer.apple.com/library/content/qa/qa1931/_index.html</span></li><li class="L3"><span class="com"> */</span></li><li class="L4"><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">restartOnDisconnect</span><span class="pun">(</span><span class="kwd">true</span><span class="pun">);</span></li><li class="L5"><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">setInterval</span><span class="pun">(</span><span class="lit">32</span><span class="pun">,</span><span class="pln"> </span><span class="lit">244</span><span class="pun">);</span><span class="pln">    </span><span class="com">// in unit of 0.625 ms</span></li><li class="L6"><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">setFastTimeout</span><span class="pun">(</span><span class="lit">30</span><span class="pun">);</span><span class="pln">      </span><span class="com">// number of seconds in fast mode</span></li><li class="L7"><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">start</span><span class="pun">(</span><span class="lit">0</span><span class="pun">);</span><span class="pln">                </span><span class="com">// 0 = Don't stop advertising after n seconds</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#full-sample-code-16-18" class="anchor-link"><span class="fa fa-link"></span></a><span id="full-sample-code-16-18" class="anchor-link-target"></span><span id="full-sample-code" class="anchor-link-target"></span>Full Sample Code</h1>
<p>The full sample code for this example can be seen below:</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/11268/elements/3014347/download?type=zip">
Project Zip
</a> <span class="divider">or</span>
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/11268/elements/3014347/download">
dual_bleuart.ino
</a> <span class="divider visible-lg-inline">|</span>
<a target="_blank" class="visible-lg-inline" href="https://github.com/adafruit/Adafruit_nRF52_Arduino/blob/master/libraries/Bluefruit52Lib/examples/DualRoles/dual_bleuart/dual_bleuart.ino">
<i class="fa fa-github"></i>
View on Github
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">/*********************************************************************
 This is an example for our nRF52 based Bluefruit LE modules

 Pick one up today in the adafruit shop!

 Adafruit invests time and resources providing this open source code,
 please support Adafruit and open-source hardware by purchasing
 products from Adafruit!

 MIT license, check LICENSE for more information
 All text above, and the splash screen below must be included in
 any redistribution
*********************************************************************/

/*
 * This sketch demonstrate how to run both Central and Peripheral roles
 * at the same time. It will act as a relay between an central (mobile)
 * to another peripheral using bleuart service.
 * 
 * Mobile &lt;--&gt; DualRole &lt;--&gt; peripheral Ble Uart
 */
#include &lt;bluefruit.h&gt;

// OTA DFU service
BLEDfu bledfu;

// Peripheral uart service
BLEUart bleuart;

// Central uart client
BLEClientUart clientUart;

void setup()
{
  Serial.begin(115200);
  while ( !Serial ) delay(10);   // for nrf52840 with native usb

  Serial.println("Bluefruit52 Dual Role BLEUART Example");
  Serial.println("-------------------------------------\n");
  
  // Initialize Bluefruit with max concurrent connections as Peripheral = 1, Central = 1
  // SRAM usage required by SoftDevice will increase with number of connections
  Bluefruit.begin(1, 1);
  Bluefruit.setTxPower(4);    // Check bluefruit.h for supported values
  Bluefruit.setName("Bluefruit52 duo");

  // Callbacks for Peripheral
  Bluefruit.Periph.setConnectCallback(prph_connect_callback);
  Bluefruit.Periph.setDisconnectCallback(prph_disconnect_callback);

  // Callbacks for Central
  Bluefruit.Central.setConnectCallback(cent_connect_callback);
  Bluefruit.Central.setDisconnectCallback(cent_disconnect_callback);

  // To be consistent OTA DFU should be added first if it exists
  bledfu.begin();

  // Configure and Start BLE Uart Service
  bleuart.begin();
  bleuart.setRxCallback(prph_bleuart_rx_callback);

  // Init BLE Central Uart Serivce
  clientUart.begin();
  clientUart.setRxCallback(cent_bleuart_rx_callback);


  /* Start Central Scanning
   * - Enable auto scan if disconnected
   * - Interval = 100 ms, window = 80 ms
   * - Filter only accept bleuart service
   * - Don't use active scan
   * - Start(timeout) with timeout = 0 will scan forever (until connected)
   */
  Bluefruit.Scanner.setRxCallback(scan_callback);
  Bluefruit.Scanner.restartOnDisconnect(true);
  Bluefruit.Scanner.setInterval(160, 80); // in unit of 0.625 ms
  Bluefruit.Scanner.filterUuid(bleuart.uuid);
  Bluefruit.Scanner.useActiveScan(false);
  Bluefruit.Scanner.start(0);                   // 0 = Don't stop scanning after n seconds

  // Set up and start advertising
  startAdv();
}

void startAdv(void)
{
  // Advertising packet
  Bluefruit.Advertising.addFlags(BLE_GAP_ADV_FLAGS_LE_ONLY_GENERAL_DISC_MODE);
  Bluefruit.Advertising.addTxPower();

  // Include bleuart 128-bit uuid
  Bluefruit.Advertising.addService(bleuart);

  // Secondary Scan Response packet (optional)
  // Since there is no room for 'Name' in Advertising packet
  Bluefruit.ScanResponse.addName();

  /* Start Advertising
   * - Enable auto advertising if disconnected
   * - Interval:  fast mode = 20 ms, slow mode = 152.5 ms
   * - Timeout for fast mode is 30 seconds
   * - Start(timeout) with timeout = 0 will advertise forever (until connected)
   *
   * For recommended advertising interval
   * https://developer.apple.com/library/content/qa/qa1931/_index.html
   */
  Bluefruit.Advertising.restartOnDisconnect(true);
  Bluefruit.Advertising.setInterval(32, 244);    // in unit of 0.625 ms
  Bluefruit.Advertising.setFastTimeout(30);      // number of seconds in fast mode
  Bluefruit.Advertising.start(0);                // 0 = Don't stop advertising after n seconds
}

void loop()
{
  // do nothing, all the work is done in callback
}

/*------------------------------------------------------------------*/
/* Peripheral
 *------------------------------------------------------------------*/
void prph_connect_callback(uint16_t conn_handle)
{
  // Get the reference to current connection
  BLEConnection* connection = Bluefruit.Connection(conn_handle);

  char peer_name[32] = { 0 };
  connection-&gt;getPeerName(peer_name, sizeof(peer_name));

  Serial.print("[Prph] Connected to ");
  Serial.println(peer_name);
}

void prph_disconnect_callback(uint16_t conn_handle, uint8_t reason)
{
  (void) conn_handle;
  (void) reason;

  Serial.println();
  Serial.println("[Prph] Disconnected");
}

void prph_bleuart_rx_callback(uint16_t conn_handle)
{
  (void) conn_handle;
  
  // Forward data from Mobile to our peripheral
  char str[20+1] = { 0 };
  bleuart.read(str, 20);

  Serial.print("[Prph] RX: ");
  Serial.println(str);  

  if ( clientUart.discovered() )
  {
    clientUart.print(str);
  }else
  {
    bleuart.println("[Prph] Central role not connected");
  }
}

/*------------------------------------------------------------------*/
/* Central
 *------------------------------------------------------------------*/
void scan_callback(ble_gap_evt_adv_report_t* report)
{
  // Since we configure the scanner with filterUuid()
  // Scan callback only invoked for device with bleuart service advertised  
  // Connect to the device with bleuart service in advertising packet  
  Bluefruit.Central.connect(report);
}

void cent_connect_callback(uint16_t conn_handle)
{
  // Get the reference to current connection
  BLEConnection* connection = Bluefruit.Connection(conn_handle);

  char peer_name[32] = { 0 };
  connection-&gt;getPeerName(peer_name, sizeof(peer_name));

  Serial.print("[Cent] Connected to ");
  Serial.println(peer_name);;

  if ( clientUart.discover(conn_handle) )
  {
    // Enable TXD's notify
    clientUart.enableTXD();
  }else
  {
    // disconnect since we couldn't find bleuart service
    Bluefruit.disconnect(conn_handle);
  }  
}

void cent_disconnect_callback(uint16_t conn_handle, uint8_t reason)
{
  (void) conn_handle;
  (void) reason;
  
  Serial.println("[Cent] Disconnected");
}

/**
 * Callback invoked when uart received data
 * @param cent_uart Reference object to the service where the data 
 * arrived. In this example it is clientUart
 */
void cent_bleuart_rx_callback(BLEClientUart&amp; cent_uart)
{
  char str[20+1] = { 0 };
  cent_uart.read(str, 20);
      
  Serial.print("[Cent] RX: ");
  Serial.println(str);

  if ( bleuart.notifyEnabled() )
  {
    // Forward data from our peripheral to Mobile
    bleuart.print( str );
  }else
  {
    // response with no prph message
    clientUart.println("[Cent] Peripheral role not connected");
  }  
}
</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="com">/*********************************************************************</span></li><li class="L1"><span class="com"> This is an example for our nRF52 based Bluefruit LE modules</span></li><li class="L2"><span class="com">&nbsp;</span></li><li class="L3"><span class="com"> Pick one up today in the adafruit shop!</span></li><li class="L4"><span class="com">&nbsp;</span></li><li class="L5"><span class="com"> Adafruit invests time and resources providing this open source code,</span></li><li class="L6"><span class="com"> please support Adafruit and open-source hardware by purchasing</span></li><li class="L7"><span class="com"> products from Adafruit!</span></li><li class="L8"><span class="com">&nbsp;</span></li><li class="L9"><span class="com"> MIT license, check LICENSE for more information</span></li><li class="L0"><span class="com"> All text above, and the splash screen below must be included in</span></li><li class="L1"><span class="com"> any redistribution</span></li><li class="L2"><span class="com">*********************************************************************/</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="com">/*</span></li><li class="L5"><span class="com"> * This sketch demonstrate how to run both Central and Peripheral roles</span></li><li class="L6"><span class="com"> * at the same time. It will act as a relay between an central (mobile)</span></li><li class="L7"><span class="com"> * to another peripheral using bleuart service.</span></li><li class="L8"><span class="com"> * </span></li><li class="L9"><span class="com"> * Mobile &lt;--&gt; DualRole &lt;--&gt; peripheral Ble Uart</span></li><li class="L0"><span class="com"> */</span></li><li class="L1"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;bluefruit.h&gt;</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="com">// OTA DFU service</span></li><li class="L4"><span class="typ">BLEDfu</span><span class="pln"> bledfu</span><span class="pun">;</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="com">// Peripheral uart service</span></li><li class="L7"><span class="typ">BLEUart</span><span class="pln"> bleuart</span><span class="pun">;</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="com">// Central uart client</span></li><li class="L0"><span class="typ">BLEClientUart</span><span class="pln"> clientUart</span><span class="pun">;</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="kwd">void</span><span class="pln"> setup</span><span class="pun">()</span></li><li class="L3"><span class="pun">{</span></li><li class="L4"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">(</span><span class="lit">115200</span><span class="pun">);</span></li><li class="L5"><span class="pln">  </span><span class="kwd">while</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="typ">Serial</span><span class="pln"> </span><span class="pun">)</span><span class="pln"> delay</span><span class="pun">(</span><span class="lit">10</span><span class="pun">);</span><span class="pln">   </span><span class="com">// for nrf52840 with native usb</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Bluefruit52 Dual Role BLEUART Example"</span><span class="pun">);</span></li><li class="L8"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"-------------------------------------\n"</span><span class="pun">);</span></li><li class="L9"><span class="pln">  </span></li><li class="L0"><span class="pln">  </span><span class="com">// Initialize Bluefruit with max concurrent connections as Peripheral = 1, Central = 1</span></li><li class="L1"><span class="pln">  </span><span class="com">// SRAM usage required by SoftDevice will increase with number of connections</span></li><li class="L2"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">(</span><span class="lit">1</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">);</span></li><li class="L3"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="pln">setTxPower</span><span class="pun">(</span><span class="lit">4</span><span class="pun">);</span><span class="pln">    </span><span class="com">// Check bluefruit.h for supported values</span></li><li class="L4"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="pln">setName</span><span class="pun">(</span><span class="str">"Bluefruit52 duo"</span><span class="pun">);</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">  </span><span class="com">// Callbacks for Peripheral</span></li><li class="L7"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Periph</span><span class="pun">.</span><span class="pln">setConnectCallback</span><span class="pun">(</span><span class="pln">prph_connect_callback</span><span class="pun">);</span></li><li class="L8"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Periph</span><span class="pun">.</span><span class="pln">setDisconnectCallback</span><span class="pun">(</span><span class="pln">prph_disconnect_callback</span><span class="pun">);</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="pln">  </span><span class="com">// Callbacks for Central</span></li><li class="L1"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Central</span><span class="pun">.</span><span class="pln">setConnectCallback</span><span class="pun">(</span><span class="pln">cent_connect_callback</span><span class="pun">);</span></li><li class="L2"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Central</span><span class="pun">.</span><span class="pln">setDisconnectCallback</span><span class="pun">(</span><span class="pln">cent_disconnect_callback</span><span class="pun">);</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln">  </span><span class="com">// To be consistent OTA DFU should be added first if it exists</span></li><li class="L5"><span class="pln">  bledfu</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="pln">  </span><span class="com">// Configure and Start BLE Uart Service</span></li><li class="L8"><span class="pln">  bleuart</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L9"><span class="pln">  bleuart</span><span class="pun">.</span><span class="pln">setRxCallback</span><span class="pun">(</span><span class="pln">prph_bleuart_rx_callback</span><span class="pun">);</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">  </span><span class="com">// Init BLE Central Uart Serivce</span></li><li class="L2"><span class="pln">  clientUart</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L3"><span class="pln">  clientUart</span><span class="pun">.</span><span class="pln">setRxCallback</span><span class="pun">(</span><span class="pln">cent_bleuart_rx_callback</span><span class="pun">);</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">  </span><span class="com">/* Start Central Scanning</span></li><li class="L7"><span class="com">   * - Enable auto scan if disconnected</span></li><li class="L8"><span class="com">   * - Interval = 100 ms, window = 80 ms</span></li><li class="L9"><span class="com">   * - Filter only accept bleuart service</span></li><li class="L0"><span class="com">   * - Don't use active scan</span></li><li class="L1"><span class="com">   * - Start(timeout) with timeout = 0 will scan forever (until connected)</span></li><li class="L2"><span class="com">   */</span></li><li class="L3"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Scanner</span><span class="pun">.</span><span class="pln">setRxCallback</span><span class="pun">(</span><span class="pln">scan_callback</span><span class="pun">);</span></li><li class="L4"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Scanner</span><span class="pun">.</span><span class="pln">restartOnDisconnect</span><span class="pun">(</span><span class="kwd">true</span><span class="pun">);</span></li><li class="L5"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Scanner</span><span class="pun">.</span><span class="pln">setInterval</span><span class="pun">(</span><span class="lit">160</span><span class="pun">,</span><span class="pln"> </span><span class="lit">80</span><span class="pun">);</span><span class="pln"> </span><span class="com">// in unit of 0.625 ms</span></li><li class="L6"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Scanner</span><span class="pun">.</span><span class="pln">filterUuid</span><span class="pun">(</span><span class="pln">bleuart</span><span class="pun">.</span><span class="pln">uuid</span><span class="pun">);</span></li><li class="L7"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Scanner</span><span class="pun">.</span><span class="pln">useActiveScan</span><span class="pun">(</span><span class="kwd">false</span><span class="pun">);</span></li><li class="L8"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Scanner</span><span class="pun">.</span><span class="pln">start</span><span class="pun">(</span><span class="lit">0</span><span class="pun">);</span><span class="pln">                   </span><span class="com">// 0 = Don't stop scanning after n seconds</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="pln">  </span><span class="com">// Set up and start advertising</span></li><li class="L1"><span class="pln">  startAdv</span><span class="pun">();</span></li><li class="L2"><span class="pun">}</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="kwd">void</span><span class="pln"> startAdv</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span></li><li class="L5"><span class="pun">{</span></li><li class="L6"><span class="pln">  </span><span class="com">// Advertising packet</span></li><li class="L7"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">addFlags</span><span class="pun">(</span><span class="pln">BLE_GAP_ADV_FLAGS_LE_ONLY_GENERAL_DISC_MODE</span><span class="pun">);</span></li><li class="L8"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">addTxPower</span><span class="pun">();</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="pln">  </span><span class="com">// Include bleuart 128-bit uuid</span></li><li class="L1"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">addService</span><span class="pun">(</span><span class="pln">bleuart</span><span class="pun">);</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="pln">  </span><span class="com">// Secondary Scan Response packet (optional)</span></li><li class="L4"><span class="pln">  </span><span class="com">// Since there is no room for 'Name' in Advertising packet</span></li><li class="L5"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">ScanResponse</span><span class="pun">.</span><span class="pln">addName</span><span class="pun">();</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="pln">  </span><span class="com">/* Start Advertising</span></li><li class="L8"><span class="com">   * - Enable auto advertising if disconnected</span></li><li class="L9"><span class="com">   * - Interval:  fast mode = 20 ms, slow mode = 152.5 ms</span></li><li class="L0"><span class="com">   * - Timeout for fast mode is 30 seconds</span></li><li class="L1"><span class="com">   * - Start(timeout) with timeout = 0 will advertise forever (until connected)</span></li><li class="L2"><span class="com">   *</span></li><li class="L3"><span class="com">   * For recommended advertising interval</span></li><li class="L4"><span class="com">   * https://developer.apple.com/library/content/qa/qa1931/_index.html</span></li><li class="L5"><span class="com">   */</span></li><li class="L6"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">restartOnDisconnect</span><span class="pun">(</span><span class="kwd">true</span><span class="pun">);</span></li><li class="L7"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">setInterval</span><span class="pun">(</span><span class="lit">32</span><span class="pun">,</span><span class="pln"> </span><span class="lit">244</span><span class="pun">);</span><span class="pln">    </span><span class="com">// in unit of 0.625 ms</span></li><li class="L8"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">setFastTimeout</span><span class="pun">(</span><span class="lit">30</span><span class="pun">);</span><span class="pln">      </span><span class="com">// number of seconds in fast mode</span></li><li class="L9"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">start</span><span class="pun">(</span><span class="lit">0</span><span class="pun">);</span><span class="pln">                </span><span class="com">// 0 = Don't stop advertising after n seconds</span></li><li class="L0"><span class="pun">}</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="kwd">void</span><span class="pln"> loop</span><span class="pun">()</span></li><li class="L3"><span class="pun">{</span></li><li class="L4"><span class="pln">  </span><span class="com">// do nothing, all the work is done in callback</span></li><li class="L5"><span class="pun">}</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="com">/*------------------------------------------------------------------*/</span></li><li class="L8"><span class="com">/* Peripheral</span></li><li class="L9"><span class="com"> *------------------------------------------------------------------*/</span></li><li class="L0"><span class="kwd">void</span><span class="pln"> prph_connect_callback</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> conn_handle</span><span class="pun">)</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="pln">  </span><span class="com">// Get the reference to current connection</span></li><li class="L3"><span class="pln">  </span><span class="typ">BLEConnection</span><span class="pun">*</span><span class="pln"> connection </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Connection</span><span class="pun">(</span><span class="pln">conn_handle</span><span class="pun">);</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">  </span><span class="kwd">char</span><span class="pln"> peer_name</span><span class="pun">[</span><span class="lit">32</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="lit">0</span><span class="pln"> </span><span class="pun">};</span></li><li class="L6"><span class="pln">  connection</span><span class="pun">-&gt;</span><span class="pln">getPeerName</span><span class="pun">(</span><span class="pln">peer_name</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">sizeof</span><span class="pun">(</span><span class="pln">peer_name</span><span class="pun">));</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"[Prph] Connected to "</span><span class="pun">);</span></li><li class="L9"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="pln">peer_name</span><span class="pun">);</span></li><li class="L0"><span class="pun">}</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="kwd">void</span><span class="pln"> prph_disconnect_callback</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> conn_handle</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pln"> reason</span><span class="pun">)</span></li><li class="L3"><span class="pun">{</span></li><li class="L4"><span class="pln">  </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span><span class="pln"> conn_handle</span><span class="pun">;</span></li><li class="L5"><span class="pln">  </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span><span class="pln"> reason</span><span class="pun">;</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">();</span></li><li class="L8"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"[Prph] Disconnected"</span><span class="pun">);</span></li><li class="L9"><span class="pun">}</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="kwd">void</span><span class="pln"> prph_bleuart_rx_callback</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> conn_handle</span><span class="pun">)</span></li><li class="L2"><span class="pun">{</span></li><li class="L3"><span class="pln">  </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span><span class="pln"> conn_handle</span><span class="pun">;</span></li><li class="L4"><span class="pln">  </span></li><li class="L5"><span class="pln">  </span><span class="com">// Forward data from Mobile to our peripheral</span></li><li class="L6"><span class="pln">  </span><span class="kwd">char</span><span class="pln"> str</span><span class="pun">[</span><span class="lit">20</span><span class="pun">+</span><span class="lit">1</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="lit">0</span><span class="pln"> </span><span class="pun">};</span></li><li class="L7"><span class="pln">  bleuart</span><span class="pun">.</span><span class="pln">read</span><span class="pun">(</span><span class="pln">str</span><span class="pun">,</span><span class="pln"> </span><span class="lit">20</span><span class="pun">);</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"[Prph] RX: "</span><span class="pun">);</span></li><li class="L0"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="pln">str</span><span class="pun">);</span><span class="pln">  </span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> clientUart</span><span class="pun">.</span><span class="pln">discovered</span><span class="pun">()</span><span class="pln"> </span><span class="pun">)</span></li><li class="L3"><span class="pln">  </span><span class="pun">{</span></li><li class="L4"><span class="pln">    clientUart</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="pln">str</span><span class="pun">);</span></li><li class="L5"><span class="pln">  </span><span class="pun">}</span><span class="kwd">else</span></li><li class="L6"><span class="pln">  </span><span class="pun">{</span></li><li class="L7"><span class="pln">    bleuart</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"[Prph] Central role not connected"</span><span class="pun">);</span></li><li class="L8"><span class="pln">  </span><span class="pun">}</span></li><li class="L9"><span class="pun">}</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="com">/*------------------------------------------------------------------*/</span></li><li class="L2"><span class="com">/* Central</span></li><li class="L3"><span class="com"> *------------------------------------------------------------------*/</span></li><li class="L4"><span class="kwd">void</span><span class="pln"> scan_callback</span><span class="pun">(</span><span class="typ">ble_gap_evt_adv_report_t</span><span class="pun">*</span><span class="pln"> report</span><span class="pun">)</span></li><li class="L5"><span class="pun">{</span></li><li class="L6"><span class="pln">  </span><span class="com">// Since we configure the scanner with filterUuid()</span></li><li class="L7"><span class="pln">  </span><span class="com">// Scan callback only invoked for device with bleuart service advertised  </span></li><li class="L8"><span class="pln">  </span><span class="com">// Connect to the device with bleuart service in advertising packet  </span></li><li class="L9"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Central</span><span class="pun">.</span><span class="pln">connect</span><span class="pun">(</span><span class="pln">report</span><span class="pun">);</span></li><li class="L0"><span class="pun">}</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="kwd">void</span><span class="pln"> cent_connect_callback</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> conn_handle</span><span class="pun">)</span></li><li class="L3"><span class="pun">{</span></li><li class="L4"><span class="pln">  </span><span class="com">// Get the reference to current connection</span></li><li class="L5"><span class="pln">  </span><span class="typ">BLEConnection</span><span class="pun">*</span><span class="pln"> connection </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Connection</span><span class="pun">(</span><span class="pln">conn_handle</span><span class="pun">);</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="pln">  </span><span class="kwd">char</span><span class="pln"> peer_name</span><span class="pun">[</span><span class="lit">32</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="lit">0</span><span class="pln"> </span><span class="pun">};</span></li><li class="L8"><span class="pln">  connection</span><span class="pun">-&gt;</span><span class="pln">getPeerName</span><span class="pun">(</span><span class="pln">peer_name</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">sizeof</span><span class="pun">(</span><span class="pln">peer_name</span><span class="pun">));</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"[Cent] Connected to "</span><span class="pun">);</span></li><li class="L1"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="pln">peer_name</span><span class="pun">);;</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> clientUart</span><span class="pun">.</span><span class="pln">discover</span><span class="pun">(</span><span class="pln">conn_handle</span><span class="pun">)</span><span class="pln"> </span><span class="pun">)</span></li><li class="L4"><span class="pln">  </span><span class="pun">{</span></li><li class="L5"><span class="pln">    </span><span class="com">// Enable TXD's notify</span></li><li class="L6"><span class="pln">    clientUart</span><span class="pun">.</span><span class="pln">enableTXD</span><span class="pun">();</span></li><li class="L7"><span class="pln">  </span><span class="pun">}</span><span class="kwd">else</span></li><li class="L8"><span class="pln">  </span><span class="pun">{</span></li><li class="L9"><span class="pln">    </span><span class="com">// disconnect since we couldn't find bleuart service</span></li><li class="L0"><span class="pln">    </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="pln">disconnect</span><span class="pun">(</span><span class="pln">conn_handle</span><span class="pun">);</span></li><li class="L1"><span class="pln">  </span><span class="pun">}</span><span class="pln">  </span></li><li class="L2"><span class="pun">}</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="kwd">void</span><span class="pln"> cent_disconnect_callback</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> conn_handle</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pln"> reason</span><span class="pun">)</span></li><li class="L5"><span class="pun">{</span></li><li class="L6"><span class="pln">  </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span><span class="pln"> conn_handle</span><span class="pun">;</span></li><li class="L7"><span class="pln">  </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span><span class="pln"> reason</span><span class="pun">;</span></li><li class="L8"><span class="pln">  </span></li><li class="L9"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"[Cent] Disconnected"</span><span class="pun">);</span></li><li class="L0"><span class="pun">}</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="com">/**</span></li><li class="L3"><span class="com"> * Callback invoked when uart received data</span></li><li class="L4"><span class="com"> * @param cent_uart Reference object to the service where the data </span></li><li class="L5"><span class="com"> * arrived. In this example it is clientUart</span></li><li class="L6"><span class="com"> */</span></li><li class="L7"><span class="kwd">void</span><span class="pln"> cent_bleuart_rx_callback</span><span class="pun">(</span><span class="typ">BLEClientUart</span><span class="pun">&amp;</span><span class="pln"> cent_uart</span><span class="pun">)</span></li><li class="L8"><span class="pun">{</span></li><li class="L9"><span class="pln">  </span><span class="kwd">char</span><span class="pln"> str</span><span class="pun">[</span><span class="lit">20</span><span class="pun">+</span><span class="lit">1</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="lit">0</span><span class="pln"> </span><span class="pun">};</span></li><li class="L0"><span class="pln">  cent_uart</span><span class="pun">.</span><span class="pln">read</span><span class="pun">(</span><span class="pln">str</span><span class="pun">,</span><span class="pln"> </span><span class="lit">20</span><span class="pun">);</span></li><li class="L1"><span class="pln">      </span></li><li class="L2"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"[Cent] RX: "</span><span class="pun">);</span></li><li class="L3"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="pln">str</span><span class="pun">);</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> bleuart</span><span class="pun">.</span><span class="pln">notifyEnabled</span><span class="pun">()</span><span class="pln"> </span><span class="pun">)</span></li><li class="L6"><span class="pln">  </span><span class="pun">{</span></li><li class="L7"><span class="pln">    </span><span class="com">// Forward data from our peripheral to Mobile</span></li><li class="L8"><span class="pln">    bleuart</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="pln"> str </span><span class="pun">);</span></li><li class="L9"><span class="pln">  </span><span class="pun">}</span><span class="kwd">else</span></li><li class="L0"><span class="pln">  </span><span class="pun">{</span></li><li class="L1"><span class="pln">    </span><span class="com">// response with no prph message</span></li><li class="L2"><span class="pln">    clientUart</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"[Cent] Peripheral role not connected"</span><span class="pun">);</span></li><li class="L3"><span class="pln">  </span><span class="pun">}</span><span class="pln">  </span></li><li class="L4"><span class="pun">}</span></li></ol></pre>
</div>
</div>
</div>
<div class="page-title-wrapper">
<h1 class="headline">
<span id="custom-central-hrm">Custom: Central HRM</span>
</h1>
<div class="author">by
<a href="./nRF52_bluefruit_Learning_Guide.html#custom-central-hrm">
<span class="name">Thach Ha</span>
</a> </div>
</div>
<div class="page-content all-page-view-content">
<div class="">
<div class="row-fluid build-text">
<p>The BLEClientService and BLEClientCharacteristic classes can be used to implement any custom or officially adopted BLE service of characteristic on the client side (most often is Central) using a set of basic properties and callback handlers.</p>
<p>The example below shows how to use these classes to implement the <a href="https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.service.heart_rate.xml" target="_blank">Heart Rate Monitor</a> service, as defined by the Bluetooth SIG. To run this example, you will need an extra nRF52 running&nbsp;<a href="https://learn.adafruit.com/bluefruit-nrf52-feather-learning-guide/custom-hrm">peripheral HRM sketch</a></p>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#hrm-service-definition-17-2" class="anchor-link"><span class="fa fa-link"></span></a><span id="hrm-service-definition-17-2" class="anchor-link-target"></span><span id="hrm-service-definition" class="anchor-link-target"></span>HRM Service Definition</h1>
<p><strong>UUID</strong>: <a href="https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.service.heart_rate.xml" target="_blank">0x180D</a></p>
</div>
<div class="row-fluid build-text">
<p>Only the first characteristic is mandatory, but we will also implement the optional&nbsp;<strong>Body Sensor Location</strong> characteristic. Heart Rate Control Point won't be used in this example to keep things simple.</p>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#implementing-the-hrm-service-and-characteristics-17-4" class="anchor-link"><span class="fa fa-link"></span></a><span id="implementing-the-hrm-service-and-characteristics-17-4" class="anchor-link-target"></span><span id="implementing-the-hrm-service-and-characteristics" class="anchor-link-target"></span>Implementing the HRM Service and Characteristics</h1>
<p>The core service and the first two characteristics can be implemented with the following code:</p>
<p>First, define the BLEService and BLECharacteristic variables that will be used in your project:</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/11272/elements/2979428/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">/* HRM Service Definitions
 * Heart Rate Monitor Service:  0x180D
 * Heart Rate Measurement Char: 0x2A37 (Mandatory)
 * Body Sensor Location Char:   0x2A38 (Optional)
 */

BLEClientService        hrms(UUID16_SVC_HEART_RATE);
BLEClientCharacteristic hrmc(UUID16_CHR_HEART_RATE_MEASUREMENT);
BLEClientCharacteristic bslc(UUID16_CHR_BODY_SENSOR_LOCATION);</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="com">/* HRM Service Definitions</span></li><li class="L1"><span class="com"> * Heart Rate Monitor Service:  0x180D</span></li><li class="L2"><span class="com"> * Heart Rate Measurement Char: 0x2A37 (Mandatory)</span></li><li class="L3"><span class="com"> * Body Sensor Location Char:   0x2A38 (Optional)</span></li><li class="L4"><span class="com"> */</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="typ">BLEClientService</span><span class="pln">        hrms</span><span class="pun">(</span><span class="pln">UUID16_SVC_HEART_RATE</span><span class="pun">);</span></li><li class="L7"><span class="typ">BLEClientCharacteristic</span><span class="pln"> hrmc</span><span class="pun">(</span><span class="pln">UUID16_CHR_HEART_RATE_MEASUREMENT</span><span class="pun">);</span></li><li class="L8"><span class="typ">BLEClientCharacteristic</span><span class="pln"> bslc</span><span class="pun">(</span><span class="pln">UUID16_CHR_BODY_SENSOR_LOCATION</span><span class="pun">);</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<p>Then you need to initialize those variables by calling their begin().</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/11272/elements/2979430/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">// Initialize HRM client
hrms.begin();

// Initialize client characteristics of HRM.
// Note: Client Char will be added to the last service that is begin()ed.
bslc.begin();

// set up callback for receiving measurement
hrmc.setNotifyCallback(hrm_notify_callback);
hrmc.begin();</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="com">// Initialize HRM client</span></li><li class="L1"><span class="pln">hrms</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="com">// Initialize client characteristics of HRM.</span></li><li class="L4"><span class="com">// Note: Client Char will be added to the last service that is begin()ed.</span></li><li class="L5"><span class="pln">bslc</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="com">// set up callback for receiving measurement</span></li><li class="L8"><span class="pln">hrmc</span><span class="pun">.</span><span class="pln">setNotifyCallback</span><span class="pun">(</span><span class="pln">hrm_notify_callback</span><span class="pun">);</span></li><li class="L9"><span class="pln">hrmc</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<h2>
<a href="./nRF52_bluefruit_Learning_Guide.html#client-service-plus-characteristic-code-analysis-17-8" class="anchor-link"><span class="fa fa-link"></span></a><span id="client-service-plus-characteristic-code-analysis-17-8" class="anchor-link-target"></span><span id="client-service-plus-characteristic-code-analysis" class="anchor-link-target"></span>Client Service + Characteristic Code Analysis</h2>
<p>1. The first thing to do is to call&nbsp;<strong>.begin()</strong> on the BLEClientService (<strong>hrms</strong> above). Since the UUID is set in the object declaration at the top of the sketch, there is normally nothing else to do with the BLEClientService instance.</p>
</div>
<div class="element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element row-fluid build-alert alert-danger">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
You MUST call .begin() on the BLEClientService before adding any BLEClientCharacteristics. Any BLEClientCharacteristic will automatically be added to the last BLEClientService that was `begin()'ed!
</div>
</div>
<div class="row-fluid build-text">
<p>2. Since&nbsp;<strong>Heart Rate Measurement</strong> characteristic (<strong>clientMeasurement</strong>&nbsp;above) is&nbsp;<em>notifiable.</em>&nbsp;You need to set up callback for it</p>
<ul>
<li>'<code>hrmc.setNotifyCallback(hrm_notify_callback);</code>' This sets the callback that will be fired when we receive a Notify message from peripheral. This is needed to handle notifiable characteristic since callback allow us to response to the message in timely manner. For this example is just simply printing out value to Serial.</li>
<li>'<code>hrmc.begin();</code>' Once all of the properties have been set, you must call&nbsp;<strong>.begin()</strong> which will add the characteristic definition to the last BLEClientService that was '.begin()ed'.</li>
</ul>
</div>
<div class="element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element row-fluid build-alert alert-info">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
Note for characteristic that does not support notify e.g body sensor location , we can simply use .read() to retrieve its value.
</div>
</div>
<div class="row-fluid build-text">
<p>3. Next, we can start to scan and connect to peripheral that advertises HRM service. Once connected, we need to go through peripheral GATT table to find out the Gatt handle for our interest. In this example they are handle for <strong>hrms</strong>,&nbsp;<strong>hrmc</strong> and&nbsp;<strong>bslc.&nbsp;</strong>This looking up process for interested service/characteristic is called <strong>Discovery.&nbsp;</strong></p>
<p><strong>Note</strong>: Gatt handle (or just handle) is required to perform any operations at all such as read, write, enable notify. It is required that a client characteristic must be discovered before we could doing anything with it.</p>
<p>The service should be discovered before we could discover its characteristic. This can be done by calling&nbsp;<code>hrms.discover(conn_handle)</code>&nbsp;. Where conn_handle is the connection ID i.e peripheral that we want to discover since it is possible for Bluefruit nRF52 to connect to multiple peripherals concurrently. If the service is found, the function will return true, otherwise false.</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/11272/elements/2979438/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">// Connect Callback Part 1
void connect_callback(uint16_t conn_handle)
{
  Serial.println("Connected");
  Serial.print("Discovering HRM Service ... ");

  // If HRM is not found, disconnect and return
  if ( !hrms.discover(conn_handle) )
  {
    Serial.println("Found NONE");

    // disconect since we couldn't find HRM service
    Bluefruit.Central.disconnect(conn_handle);

    return;
  }

  // Once HRM service is found, we continue to discover its characteristic
  Serial.println("Found it");

  .............
}</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="com">// Connect Callback Part 1</span></li><li class="L1"><span class="kwd">void</span><span class="pln"> connect_callback</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> conn_handle</span><span class="pun">)</span></li><li class="L2"><span class="pun">{</span></li><li class="L3"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Connected"</span><span class="pun">);</span></li><li class="L4"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"Discovering HRM Service ... "</span><span class="pun">);</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">  </span><span class="com">// If HRM is not found, disconnect and return</span></li><li class="L7"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln">hrms</span><span class="pun">.</span><span class="pln">discover</span><span class="pun">(</span><span class="pln">conn_handle</span><span class="pun">)</span><span class="pln"> </span><span class="pun">)</span></li><li class="L8"><span class="pln">  </span><span class="pun">{</span></li><li class="L9"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Found NONE"</span><span class="pun">);</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">    </span><span class="com">// disconect since we couldn't find HRM service</span></li><li class="L2"><span class="pln">    </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Central</span><span class="pun">.</span><span class="pln">disconnect</span><span class="pun">(</span><span class="pln">conn_handle</span><span class="pun">);</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln">    </span><span class="kwd">return</span><span class="pun">;</span></li><li class="L5"><span class="pln">  </span><span class="pun">}</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="pln">  </span><span class="com">// Once HRM service is found, we continue to discover its characteristic</span></li><li class="L8"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Found it"</span><span class="pun">);</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="pln">  </span><span class="pun">.............</span></li><li class="L1"><span class="pun">}</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<p>4. Afterwards, we continue to discover all the interested characteristics within the service by calling&nbsp;<code>.discover()</code>. The function return true if characteristics is found, and false otherwise. You could also check with&nbsp;<code>.discovered()</code>&nbsp;function. A service could contain more characteristics but we don't need to discover them all, only those that we want to interact with.</p>
<p><strong>Advanced:</strong> Alternatively, you could discover all the interested characteristics of a service within a&nbsp; function call by using<code>Bluefruit.Discovery.discoverCharacteristic()</code>&nbsp;(not used in the example). The API can take up to 5 characteristics, if you need more, the variant with passing array of characteristics is also available. The function will return the number of characteristic it found.</p>
<p><strong>Note</strong>: when a characteristic is discovered by above API, all necessarily meta data such as handles, properties&nbsp;( read,write, notify etc ...), cccd handle&nbsp; will be updated automatically. You can then use&nbsp;<a href="https://learn.adafruit.com/bluefruit-nrf52-feather-learning-guide/bleclientcharacteristic">BLECLientCharacteristic</a>&nbsp;API such as read(), write(), enableNotify() on it provided that its properties support such as operation.&nbsp;</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/11272/elements/2979473/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">// Connect Callback Part 2
void connect_callback(uint16_t conn_handle)
{
  Serial.print("Discovering Measurement characteristic ... ");
  if ( !hrmc.discover() )
  {
    // Measurement chr is mandatory, if it is not found (valid), then disconnect
    Serial.println("not found !!!");  
    Serial.println("Measurement characteristic is mandatory but not found");
    Bluefruit.Central.disconnect(conn_handle);
    return;
  }
  Serial.println("Found it");

  // Measurement is found, continue to look for option Body Sensor Location
  // https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.characteristic.body_sensor_location.xml
  // Body Sensor Location is optional, print out the location in text if present
  Serial.print("Discovering Body Sensor Location characteristic ... ");
  if ( bslc.discover() )
  {
    Serial.println("Found it");
    
    // Body sensor location value is 8 bit
    const char* body_str[] = { "Other", "Chest", "Wrist", "Finger", "Hand", "Ear Lobe", "Foot" };

    // Read 8-bit BSLC value from peripheral
    uint8_t loc_value = bslc.read8();
    
    Serial.print("Body Location Sensor: ");
    Serial.println(body_str[loc_value]);
  }else
  {
    Serial.println("Found NONE");
  }
  
  ...............
}</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="com">// Connect Callback Part 2</span></li><li class="L1"><span class="kwd">void</span><span class="pln"> connect_callback</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> conn_handle</span><span class="pun">)</span></li><li class="L2"><span class="pun">{</span></li><li class="L3"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"Discovering Measurement characteristic ... "</span><span class="pun">);</span></li><li class="L4"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln">hrmc</span><span class="pun">.</span><span class="pln">discover</span><span class="pun">()</span><span class="pln"> </span><span class="pun">)</span></li><li class="L5"><span class="pln">  </span><span class="pun">{</span></li><li class="L6"><span class="pln">    </span><span class="com">// Measurement chr is mandatory, if it is not found (valid), then disconnect</span></li><li class="L7"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"not found !!!"</span><span class="pun">);</span><span class="pln">  </span></li><li class="L8"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Measurement characteristic is mandatory but not found"</span><span class="pun">);</span></li><li class="L9"><span class="pln">    </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Central</span><span class="pun">.</span><span class="pln">disconnect</span><span class="pun">(</span><span class="pln">conn_handle</span><span class="pun">);</span></li><li class="L0"><span class="pln">    </span><span class="kwd">return</span><span class="pun">;</span></li><li class="L1"><span class="pln">  </span><span class="pun">}</span></li><li class="L2"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Found it"</span><span class="pun">);</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln">  </span><span class="com">// Measurement is found, continue to look for option Body Sensor Location</span></li><li class="L5"><span class="pln">  </span><span class="com">// https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.characteristic.body_sensor_location.xml</span></li><li class="L6"><span class="pln">  </span><span class="com">// Body Sensor Location is optional, print out the location in text if present</span></li><li class="L7"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"Discovering Body Sensor Location characteristic ... "</span><span class="pun">);</span></li><li class="L8"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> bslc</span><span class="pun">.</span><span class="pln">discover</span><span class="pun">()</span><span class="pln"> </span><span class="pun">)</span></li><li class="L9"><span class="pln">  </span><span class="pun">{</span></li><li class="L0"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Found it"</span><span class="pun">);</span></li><li class="L1"><span class="pln">    </span></li><li class="L2"><span class="pln">    </span><span class="com">// Body sensor location value is 8 bit</span></li><li class="L3"><span class="pln">    </span><span class="kwd">const</span><span class="pln"> </span><span class="kwd">char</span><span class="pun">*</span><span class="pln"> body_str</span><span class="pun">[]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="str">"Other"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"Chest"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"Wrist"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"Finger"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"Hand"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"Ear Lobe"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"Foot"</span><span class="pln"> </span><span class="pun">};</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">    </span><span class="com">// Read 8-bit BSLC value from peripheral</span></li><li class="L6"><span class="pln">    </span><span class="typ">uint8_t</span><span class="pln"> loc_value </span><span class="pun">=</span><span class="pln"> bslc</span><span class="pun">.</span><span class="pln">read8</span><span class="pun">();</span></li><li class="L7"><span class="pln">    </span></li><li class="L8"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"Body Location Sensor: "</span><span class="pun">);</span></li><li class="L9"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="pln">body_str</span><span class="pun">[</span><span class="pln">loc_value</span><span class="pun">]);</span></li><li class="L0"><span class="pln">  </span><span class="pun">}</span><span class="kwd">else</span></li><li class="L1"><span class="pln">  </span><span class="pun">{</span></li><li class="L2"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Found NONE"</span><span class="pun">);</span></li><li class="L3"><span class="pln">  </span><span class="pun">}</span></li><li class="L4"><span class="pln">  </span></li><li class="L5"><span class="pln">  </span><span class="pun">...............</span></li><li class="L6"><span class="pun">}</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<p>5. Once hrmc is discovered, you should enable its notification by calling <code>hrmc.enableNotify()</code>. If this succeeded (return true), peripheral can now send data to us using notify message. Which will trigger the callback that we setup earlier to handle incoming data.</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/11272/elements/2979475/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">// Connect Callback Part 3
void connect_callback(uint16_t conn_handle)
{
  .......
  
  // Reaching here means we are ready to go, let's enable notification on measurement chr
  if ( hrmc.enableNotify() )
  {
    Serial.println("Ready to receive HRM Measurement value");
  }else
  {
    Serial.println("Couldn't enable notify for HRM Measurement. Increase DEBUG LEVEL for troubleshooting");
  }
}</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="com">// Connect Callback Part 3</span></li><li class="L1"><span class="kwd">void</span><span class="pln"> connect_callback</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> conn_handle</span><span class="pun">)</span></li><li class="L2"><span class="pun">{</span></li><li class="L3"><span class="pln">  </span><span class="pun">.......</span></li><li class="L4"><span class="pln">  </span></li><li class="L5"><span class="pln">  </span><span class="com">// Reaching here means we are ready to go, let's enable notification on measurement chr</span></li><li class="L6"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> hrmc</span><span class="pun">.</span><span class="pln">enableNotify</span><span class="pun">()</span><span class="pln"> </span><span class="pun">)</span></li><li class="L7"><span class="pln">  </span><span class="pun">{</span></li><li class="L8"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Ready to receive HRM Measurement value"</span><span class="pun">);</span></li><li class="L9"><span class="pln">  </span><span class="pun">}</span><span class="kwd">else</span></li><li class="L0"><span class="pln">  </span><span class="pun">{</span></li><li class="L1"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Couldn't enable notify for HRM Measurement. Increase DEBUG LEVEL for troubleshooting"</span><span class="pun">);</span></li><li class="L2"><span class="pln">  </span><span class="pun">}</span></li><li class="L3"><span class="pun">}</span></li></ol></pre>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/11272/elements/2979476/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">/**
 * Hooked callback that triggered when a measurement value is sent from peripheral
 * @param chr   Pointer to client characteristic that even occurred,
 *              in this example it should be hrmc
 * @param data  Pointer to received data
 * @param len   Length of received data
 */
void hrm_notify_callback(BLEClientCharacteristic* chr, uint8_t* data, uint16_t len)
{
  // https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.characteristic.heart_rate_measurement.xml
  // Measurement contains of control byte0 and measurement (8 or 16 bit) + optional field
  // if byte0's bit0 is 0 --&gt; measurement is 8 bit, otherwise 16 bit.

  Serial.print("HRM Measurement: ");

  if ( data[0] &amp; bit(0) )
  {
    uint16_t value;
    memcpy(&amp;value, data+1, 2);

    Serial.println(value);
  }
  else
  {
    Serial.println(data[1]);
  }
}</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="com">/**</span></li><li class="L1"><span class="com"> * Hooked callback that triggered when a measurement value is sent from peripheral</span></li><li class="L2"><span class="com"> * @param chr   Pointer to client characteristic that even occurred,</span></li><li class="L3"><span class="com"> *              in this example it should be hrmc</span></li><li class="L4"><span class="com"> * @param data  Pointer to received data</span></li><li class="L5"><span class="com"> * @param len   Length of received data</span></li><li class="L6"><span class="com"> */</span></li><li class="L7"><span class="kwd">void</span><span class="pln"> hrm_notify_callback</span><span class="pun">(</span><span class="typ">BLEClientCharacteristic</span><span class="pun">*</span><span class="pln"> chr</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pun">*</span><span class="pln"> data</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint16_t</span><span class="pln"> len</span><span class="pun">)</span></li><li class="L8"><span class="pun">{</span></li><li class="L9"><span class="pln">  </span><span class="com">// https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.characteristic.heart_rate_measurement.xml</span></li><li class="L0"><span class="pln">  </span><span class="com">// Measurement contains of control byte0 and measurement (8 or 16 bit) + optional field</span></li><li class="L1"><span class="pln">  </span><span class="com">// if byte0's bit0 is 0 --&gt; measurement is 8 bit, otherwise 16 bit.</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"HRM Measurement: "</span><span class="pun">);</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> data</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln"> bit</span><span class="pun">(</span><span class="lit">0</span><span class="pun">)</span><span class="pln"> </span><span class="pun">)</span></li><li class="L6"><span class="pln">  </span><span class="pun">{</span></li><li class="L7"><span class="pln">    </span><span class="typ">uint16_t</span><span class="pln"> </span><span class="kwd">value</span><span class="pun">;</span></li><li class="L8"><span class="pln">    memcpy</span><span class="pun">(&amp;</span><span class="kwd">value</span><span class="pun">,</span><span class="pln"> data</span><span class="pun">+</span><span class="lit">1</span><span class="pun">,</span><span class="pln"> </span><span class="lit">2</span><span class="pun">);</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="kwd">value</span><span class="pun">);</span></li><li class="L1"><span class="pln">  </span><span class="pun">}</span></li><li class="L2"><span class="pln">  </span><span class="kwd">else</span></li><li class="L3"><span class="pln">  </span><span class="pun">{</span></li><li class="L4"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="pln">data</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]);</span></li><li class="L5"><span class="pln">  </span><span class="pun">}</span></li><li class="L6"><span class="pun">}</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#full-sample-code-17-19" class="anchor-link"><span class="fa fa-link"></span></a><span id="full-sample-code-17-19" class="anchor-link-target"></span><span id="full-sample-code" class="anchor-link-target"></span>Full Sample Code</h1>
<p>The full sample code for this example can be seen below:</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/11272/elements/3014348/download?type=zip">
Project Zip
</a> <span class="divider">or</span>
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/11272/elements/3014348/download">
custom_hrm.ino
</a> <span class="divider visible-lg-inline">|</span>
<a target="_blank" class="visible-lg-inline" href="https://github.com/adafruit/Adafruit_nRF52_Arduino/blob/master/libraries/Bluefruit52Lib/examples/Peripheral/custom_hrm/custom_hrm.ino">
<i class="fa fa-github"></i>
View on Github
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">/*********************************************************************
 This is an example for our nRF52 based Bluefruit LE modules

 Pick one up today in the adafruit shop!

 Adafruit invests time and resources providing this open source code,
 please support Adafruit and open-source hardware by purchasing
 products from Adafruit!

 MIT license, check LICENSE for more information
 All text above, and the splash screen below must be included in
 any redistribution
*********************************************************************/
#include &lt;bluefruit.h&gt;

/* HRM Service Definitions
 * Heart Rate Monitor Service:  0x180D
 * Heart Rate Measurement Char: 0x2A37
 * Body Sensor Location Char:   0x2A38
 */
BLEService        hrms = BLEService(UUID16_SVC_HEART_RATE);
BLECharacteristic hrmc = BLECharacteristic(UUID16_CHR_HEART_RATE_MEASUREMENT);
BLECharacteristic bslc = BLECharacteristic(UUID16_CHR_BODY_SENSOR_LOCATION);

BLEDis bledis;    // DIS (Device Information Service) helper class instance
BLEBas blebas;    // BAS (Battery Service) helper class instance

uint8_t  bps = 0;

void setup()
{
  Serial.begin(115200);
  while ( !Serial ) delay(10);   // for nrf52840 with native usb

  Serial.println("Bluefruit52 HRM Example");
  Serial.println("-----------------------\n");

  // Initialise the Bluefruit module
  Serial.println("Initialise the Bluefruit nRF52 module");
  Bluefruit.begin();

  // Set the advertised device name (keep it short!)
  Serial.println("Setting Device Name to 'Feather52 HRM'");
  Bluefruit.setName("Bluefruit52 HRM");

  // Set the connect/disconnect callback handlers
  Bluefruit.Periph.setConnectCallback(connect_callback);
  Bluefruit.Periph.setDisconnectCallback(disconnect_callback);

  // Configure and Start the Device Information Service
  Serial.println("Configuring the Device Information Service");
  bledis.setManufacturer("Adafruit Industries");
  bledis.setModel("Bluefruit Feather52");
  bledis.begin();

  // Start the BLE Battery Service and set it to 100%
  Serial.println("Configuring the Battery Service");
  blebas.begin();
  blebas.write(100);

  // Setup the Heart Rate Monitor service using
  // BLEService and BLECharacteristic classes
  Serial.println("Configuring the Heart Rate Monitor Service");
  setupHRM();

  // Setup the advertising packet(s)
  Serial.println("Setting up the advertising payload(s)");
  startAdv();

  Serial.println("Ready Player One!!!");
  Serial.println("\nAdvertising");
}

void startAdv(void)
{
  // Advertising packet
  Bluefruit.Advertising.addFlags(BLE_GAP_ADV_FLAGS_LE_ONLY_GENERAL_DISC_MODE);
  Bluefruit.Advertising.addTxPower();

  // Include HRM Service UUID
  Bluefruit.Advertising.addService(hrms);

  // Include Name
  Bluefruit.Advertising.addName();
  
  /* Start Advertising
   * - Enable auto advertising if disconnected
   * - Interval:  fast mode = 20 ms, slow mode = 152.5 ms
   * - Timeout for fast mode is 30 seconds
   * - Start(timeout) with timeout = 0 will advertise forever (until connected)
   * 
   * For recommended advertising interval
   * https://developer.apple.com/library/content/qa/qa1931/_index.html   
   */
  Bluefruit.Advertising.restartOnDisconnect(true);
  Bluefruit.Advertising.setInterval(32, 244);    // in unit of 0.625 ms
  Bluefruit.Advertising.setFastTimeout(30);      // number of seconds in fast mode
  Bluefruit.Advertising.start(0);                // 0 = Don't stop advertising after n seconds  
}

void setupHRM(void)
{
  // Configure the Heart Rate Monitor service
  // See: https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.service.heart_rate.xml
  // Supported Characteristics:
  // Name                         UUID    Requirement Properties
  // ---------------------------- ------  ----------- ----------
  // Heart Rate Measurement       0x2A37  Mandatory   Notify
  // Body Sensor Location         0x2A38  Optional    Read
  // Heart Rate Control Point     0x2A39  Conditional Write       &lt;-- Not used here
  hrms.begin();

  // Note: You must call .begin() on the BLEService before calling .begin() on
  // any characteristic(s) within that service definition.. Calling .begin() on
  // a BLECharacteristic will cause it to be added to the last BLEService that
  // was 'begin()'ed!

  // Configure the Heart Rate Measurement characteristic
  // See: https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.characteristic.heart_rate_measurement.xml
  // Properties = Notify
  // Min Len    = 1
  // Max Len    = 8
  //    B0      = UINT8  - Flag (MANDATORY)
  //      b5:7  = Reserved
  //      b4    = RR-Internal (0 = Not present, 1 = Present)
  //      b3    = Energy expended status (0 = Not present, 1 = Present)
  //      b1:2  = Sensor contact status (0+1 = Not supported, 2 = Supported but contact not detected, 3 = Supported and detected)
  //      b0    = Value format (0 = UINT8, 1 = UINT16)
  //    B1      = UINT8  - 8-bit heart rate measurement value in BPM
  //    B2:3    = UINT16 - 16-bit heart rate measurement value in BPM
  //    B4:5    = UINT16 - Energy expended in joules
  //    B6:7    = UINT16 - RR Internal (1/1024 second resolution)
  hrmc.setProperties(CHR_PROPS_NOTIFY);
  hrmc.setPermission(SECMODE_OPEN, SECMODE_NO_ACCESS);
  hrmc.setFixedLen(2);
  hrmc.setCccdWriteCallback(cccd_callback);  // Optionally capture CCCD updates
  hrmc.begin();
  uint8_t hrmdata[2] = { 0b00000110, 0x40 }; // Set the characteristic to use 8-bit values, with the sensor connected and detected
  hrmc.write(hrmdata, 2);

  // Configure the Body Sensor Location characteristic
  // See: https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.characteristic.body_sensor_location.xml
  // Properties = Read
  // Min Len    = 1
  // Max Len    = 1
  //    B0      = UINT8 - Body Sensor Location
  //      0     = Other
  //      1     = Chest
  //      2     = Wrist
  //      3     = Finger
  //      4     = Hand
  //      5     = Ear Lobe
  //      6     = Foot
  //      7:255 = Reserved
  bslc.setProperties(CHR_PROPS_READ);
  bslc.setPermission(SECMODE_OPEN, SECMODE_NO_ACCESS);
  bslc.setFixedLen(1);
  bslc.begin();
  bslc.write8(2);    // Set the characteristic to 'Wrist' (2)
}

void connect_callback(uint16_t conn_handle)
{
  // Get the reference to current connection
  BLEConnection* connection = Bluefruit.Connection(conn_handle);

  char central_name[32] = { 0 };
  connection-&gt;getPeerName(central_name, sizeof(central_name));

  Serial.print("Connected to ");
  Serial.println(central_name);
}

/**
 * Callback invoked when a connection is dropped
 * @param conn_handle connection where this event happens
 * @param reason is a BLE_HCI_STATUS_CODE which can be found in ble_hci.h
 */
void disconnect_callback(uint16_t conn_handle, uint8_t reason)
{
  (void) conn_handle;
  (void) reason;

  Serial.println("Disconnected");
  Serial.println("Advertising!");
}

void cccd_callback(uint16_t conn_hdl, BLECharacteristic* chr, uint16_t cccd_value)
{
    // Display the raw request packet
    Serial.print("CCCD Updated: ");
    //Serial.printBuffer(request-&gt;data, request-&gt;len);
    Serial.print(cccd_value);
    Serial.println("");

    // Check the characteristic this CCCD update is associated with in case
    // this handler is used for multiple CCCD records.
    if (chr-&gt;uuid == hrmc.uuid) {
        if (chr-&gt;notifyEnabled(conn_hdl)) {
            Serial.println("Heart Rate Measurement 'Notify' enabled");
        } else {
            Serial.println("Heart Rate Measurement 'Notify' disabled");
        }
    }
}

void loop()
{
  digitalToggle(LED_RED);
  
  if ( Bluefruit.connected() ) {
    uint8_t hrmdata[2] = { 0b00000110, bps++ };           // Sensor connected, increment BPS value
    
    // Note: We use .notify instead of .write!
    // If it is connected but CCCD is not enabled
    // The characteristic's value is still updated although notification is not sent
    if ( hrmc.notify(hrmdata, sizeof(hrmdata)) ){
      Serial.print("Heart Rate Measurement updated to: "); Serial.println(bps); 
    }else{
      Serial.println("ERROR: Notify not set in the CCCD or not connected!");
    }
  }

  // Only send update once per second
  delay(1000);
}
</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="com">/*********************************************************************</span></li><li class="L1"><span class="com"> This is an example for our nRF52 based Bluefruit LE modules</span></li><li class="L2"><span class="com">&nbsp;</span></li><li class="L3"><span class="com"> Pick one up today in the adafruit shop!</span></li><li class="L4"><span class="com">&nbsp;</span></li><li class="L5"><span class="com"> Adafruit invests time and resources providing this open source code,</span></li><li class="L6"><span class="com"> please support Adafruit and open-source hardware by purchasing</span></li><li class="L7"><span class="com"> products from Adafruit!</span></li><li class="L8"><span class="com">&nbsp;</span></li><li class="L9"><span class="com"> MIT license, check LICENSE for more information</span></li><li class="L0"><span class="com"> All text above, and the splash screen below must be included in</span></li><li class="L1"><span class="com"> any redistribution</span></li><li class="L2"><span class="com">*********************************************************************/</span></li><li class="L3"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;bluefruit.h&gt;</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="com">/* HRM Service Definitions</span></li><li class="L6"><span class="com"> * Heart Rate Monitor Service:  0x180D</span></li><li class="L7"><span class="com"> * Heart Rate Measurement Char: 0x2A37</span></li><li class="L8"><span class="com"> * Body Sensor Location Char:   0x2A38</span></li><li class="L9"><span class="com"> */</span></li><li class="L0"><span class="typ">BLEService</span><span class="pln">        hrms </span><span class="pun">=</span><span class="pln"> </span><span class="typ">BLEService</span><span class="pun">(</span><span class="pln">UUID16_SVC_HEART_RATE</span><span class="pun">);</span></li><li class="L1"><span class="typ">BLECharacteristic</span><span class="pln"> hrmc </span><span class="pun">=</span><span class="pln"> </span><span class="typ">BLECharacteristic</span><span class="pun">(</span><span class="pln">UUID16_CHR_HEART_RATE_MEASUREMENT</span><span class="pun">);</span></li><li class="L2"><span class="typ">BLECharacteristic</span><span class="pln"> bslc </span><span class="pun">=</span><span class="pln"> </span><span class="typ">BLECharacteristic</span><span class="pun">(</span><span class="pln">UUID16_CHR_BODY_SENSOR_LOCATION</span><span class="pun">);</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="typ">BLEDis</span><span class="pln"> bledis</span><span class="pun">;</span><span class="pln">    </span><span class="com">// DIS (Device Information Service) helper class instance</span></li><li class="L5"><span class="typ">BLEBas</span><span class="pln"> blebas</span><span class="pun">;</span><span class="pln">    </span><span class="com">// BAS (Battery Service) helper class instance</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="typ">uint8_t</span><span class="pln">  bps </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="kwd">void</span><span class="pln"> setup</span><span class="pun">()</span></li><li class="L0"><span class="pun">{</span></li><li class="L1"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">(</span><span class="lit">115200</span><span class="pun">);</span></li><li class="L2"><span class="pln">  </span><span class="kwd">while</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="typ">Serial</span><span class="pln"> </span><span class="pun">)</span><span class="pln"> delay</span><span class="pun">(</span><span class="lit">10</span><span class="pun">);</span><span class="pln">   </span><span class="com">// for nrf52840 with native usb</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Bluefruit52 HRM Example"</span><span class="pun">);</span></li><li class="L5"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"-----------------------\n"</span><span class="pun">);</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="pln">  </span><span class="com">// Initialise the Bluefruit module</span></li><li class="L8"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Initialise the Bluefruit nRF52 module"</span><span class="pun">);</span></li><li class="L9"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">  </span><span class="com">// Set the advertised device name (keep it short!)</span></li><li class="L2"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Setting Device Name to 'Feather52 HRM'"</span><span class="pun">);</span></li><li class="L3"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="pln">setName</span><span class="pun">(</span><span class="str">"Bluefruit52 HRM"</span><span class="pun">);</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">  </span><span class="com">// Set the connect/disconnect callback handlers</span></li><li class="L6"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Periph</span><span class="pun">.</span><span class="pln">setConnectCallback</span><span class="pun">(</span><span class="pln">connect_callback</span><span class="pun">);</span></li><li class="L7"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Periph</span><span class="pun">.</span><span class="pln">setDisconnectCallback</span><span class="pun">(</span><span class="pln">disconnect_callback</span><span class="pun">);</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="pln">  </span><span class="com">// Configure and Start the Device Information Service</span></li><li class="L0"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Configuring the Device Information Service"</span><span class="pun">);</span></li><li class="L1"><span class="pln">  bledis</span><span class="pun">.</span><span class="pln">setManufacturer</span><span class="pun">(</span><span class="str">"Adafruit Industries"</span><span class="pun">);</span></li><li class="L2"><span class="pln">  bledis</span><span class="pun">.</span><span class="pln">setModel</span><span class="pun">(</span><span class="str">"Bluefruit Feather52"</span><span class="pun">);</span></li><li class="L3"><span class="pln">  bledis</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">  </span><span class="com">// Start the BLE Battery Service and set it to 100%</span></li><li class="L6"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Configuring the Battery Service"</span><span class="pun">);</span></li><li class="L7"><span class="pln">  blebas</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L8"><span class="pln">  blebas</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="lit">100</span><span class="pun">);</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="pln">  </span><span class="com">// Setup the Heart Rate Monitor service using</span></li><li class="L1"><span class="pln">  </span><span class="com">// BLEService and BLECharacteristic classes</span></li><li class="L2"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Configuring the Heart Rate Monitor Service"</span><span class="pun">);</span></li><li class="L3"><span class="pln">  setupHRM</span><span class="pun">();</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">  </span><span class="com">// Setup the advertising packet(s)</span></li><li class="L6"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Setting up the advertising payload(s)"</span><span class="pun">);</span></li><li class="L7"><span class="pln">  startAdv</span><span class="pun">();</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Ready Player One!!!"</span><span class="pun">);</span></li><li class="L0"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"\nAdvertising"</span><span class="pun">);</span></li><li class="L1"><span class="pun">}</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="kwd">void</span><span class="pln"> startAdv</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="pln">  </span><span class="com">// Advertising packet</span></li><li class="L6"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">addFlags</span><span class="pun">(</span><span class="pln">BLE_GAP_ADV_FLAGS_LE_ONLY_GENERAL_DISC_MODE</span><span class="pun">);</span></li><li class="L7"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">addTxPower</span><span class="pun">();</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="pln">  </span><span class="com">// Include HRM Service UUID</span></li><li class="L0"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">addService</span><span class="pun">(</span><span class="pln">hrms</span><span class="pun">);</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="pln">  </span><span class="com">// Include Name</span></li><li class="L3"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">addName</span><span class="pun">();</span></li><li class="L4"><span class="pln">  </span></li><li class="L5"><span class="pln">  </span><span class="com">/* Start Advertising</span></li><li class="L6"><span class="com">   * - Enable auto advertising if disconnected</span></li><li class="L7"><span class="com">   * - Interval:  fast mode = 20 ms, slow mode = 152.5 ms</span></li><li class="L8"><span class="com">   * - Timeout for fast mode is 30 seconds</span></li><li class="L9"><span class="com">   * - Start(timeout) with timeout = 0 will advertise forever (until connected)</span></li><li class="L0"><span class="com">   * </span></li><li class="L1"><span class="com">   * For recommended advertising interval</span></li><li class="L2"><span class="com">   * https://developer.apple.com/library/content/qa/qa1931/_index.html   </span></li><li class="L3"><span class="com">   */</span></li><li class="L4"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">restartOnDisconnect</span><span class="pun">(</span><span class="kwd">true</span><span class="pun">);</span></li><li class="L5"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">setInterval</span><span class="pun">(</span><span class="lit">32</span><span class="pun">,</span><span class="pln"> </span><span class="lit">244</span><span class="pun">);</span><span class="pln">    </span><span class="com">// in unit of 0.625 ms</span></li><li class="L6"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">setFastTimeout</span><span class="pun">(</span><span class="lit">30</span><span class="pun">);</span><span class="pln">      </span><span class="com">// number of seconds in fast mode</span></li><li class="L7"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">start</span><span class="pun">(</span><span class="lit">0</span><span class="pun">);</span><span class="pln">                </span><span class="com">// 0 = Don't stop advertising after n seconds  </span></li><li class="L8"><span class="pun">}</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="kwd">void</span><span class="pln"> setupHRM</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="pln">  </span><span class="com">// Configure the Heart Rate Monitor service</span></li><li class="L3"><span class="pln">  </span><span class="com">// See: https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.service.heart_rate.xml</span></li><li class="L4"><span class="pln">  </span><span class="com">// Supported Characteristics:</span></li><li class="L5"><span class="pln">  </span><span class="com">// Name                         UUID    Requirement Properties</span></li><li class="L6"><span class="pln">  </span><span class="com">// ---------------------------- ------  ----------- ----------</span></li><li class="L7"><span class="pln">  </span><span class="com">// Heart Rate Measurement       0x2A37  Mandatory   Notify</span></li><li class="L8"><span class="pln">  </span><span class="com">// Body Sensor Location         0x2A38  Optional    Read</span></li><li class="L9"><span class="pln">  </span><span class="com">// Heart Rate Control Point     0x2A39  Conditional Write       &lt;-- Not used here</span></li><li class="L0"><span class="pln">  hrms</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="pln">  </span><span class="com">// Note: You must call .begin() on the BLEService before calling .begin() on</span></li><li class="L3"><span class="pln">  </span><span class="com">// any characteristic(s) within that service definition.. Calling .begin() on</span></li><li class="L4"><span class="pln">  </span><span class="com">// a BLECharacteristic will cause it to be added to the last BLEService that</span></li><li class="L5"><span class="pln">  </span><span class="com">// was 'begin()'ed!</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="pln">  </span><span class="com">// Configure the Heart Rate Measurement characteristic</span></li><li class="L8"><span class="pln">  </span><span class="com">// See: https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.characteristic.heart_rate_measurement.xml</span></li><li class="L9"><span class="pln">  </span><span class="com">// Properties = Notify</span></li><li class="L0"><span class="pln">  </span><span class="com">// Min Len    = 1</span></li><li class="L1"><span class="pln">  </span><span class="com">// Max Len    = 8</span></li><li class="L2"><span class="pln">  </span><span class="com">//    B0      = UINT8  - Flag (MANDATORY)</span></li><li class="L3"><span class="pln">  </span><span class="com">//      b5:7  = Reserved</span></li><li class="L4"><span class="pln">  </span><span class="com">//      b4    = RR-Internal (0 = Not present, 1 = Present)</span></li><li class="L5"><span class="pln">  </span><span class="com">//      b3    = Energy expended status (0 = Not present, 1 = Present)</span></li><li class="L6"><span class="pln">  </span><span class="com">//      b1:2  = Sensor contact status (0+1 = Not supported, 2 = Supported but contact not detected, 3 = Supported and detected)</span></li><li class="L7"><span class="pln">  </span><span class="com">//      b0    = Value format (0 = UINT8, 1 = UINT16)</span></li><li class="L8"><span class="pln">  </span><span class="com">//    B1      = UINT8  - 8-bit heart rate measurement value in BPM</span></li><li class="L9"><span class="pln">  </span><span class="com">//    B2:3    = UINT16 - 16-bit heart rate measurement value in BPM</span></li><li class="L0"><span class="pln">  </span><span class="com">//    B4:5    = UINT16 - Energy expended in joules</span></li><li class="L1"><span class="pln">  </span><span class="com">//    B6:7    = UINT16 - RR Internal (1/1024 second resolution)</span></li><li class="L2"><span class="pln">  hrmc</span><span class="pun">.</span><span class="pln">setProperties</span><span class="pun">(</span><span class="pln">CHR_PROPS_NOTIFY</span><span class="pun">);</span></li><li class="L3"><span class="pln">  hrmc</span><span class="pun">.</span><span class="pln">setPermission</span><span class="pun">(</span><span class="pln">SECMODE_OPEN</span><span class="pun">,</span><span class="pln"> SECMODE_NO_ACCESS</span><span class="pun">);</span></li><li class="L4"><span class="pln">  hrmc</span><span class="pun">.</span><span class="pln">setFixedLen</span><span class="pun">(</span><span class="lit">2</span><span class="pun">);</span></li><li class="L5"><span class="pln">  hrmc</span><span class="pun">.</span><span class="pln">setCccdWriteCallback</span><span class="pun">(</span><span class="pln">cccd_callback</span><span class="pun">);</span><span class="pln">  </span><span class="com">// Optionally capture CCCD updates</span></li><li class="L6"><span class="pln">  hrmc</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L7"><span class="pln">  </span><span class="typ">uint8_t</span><span class="pln"> hrmdata</span><span class="pun">[</span><span class="lit">2</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="lit">0b00000110</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x40</span><span class="pln"> </span><span class="pun">};</span><span class="pln"> </span><span class="com">// Set the characteristic to use 8-bit values, with the sensor connected and detected</span></li><li class="L8"><span class="pln">  hrmc</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="pln">hrmdata</span><span class="pun">,</span><span class="pln"> </span><span class="lit">2</span><span class="pun">);</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="pln">  </span><span class="com">// Configure the Body Sensor Location characteristic</span></li><li class="L1"><span class="pln">  </span><span class="com">// See: https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.characteristic.body_sensor_location.xml</span></li><li class="L2"><span class="pln">  </span><span class="com">// Properties = Read</span></li><li class="L3"><span class="pln">  </span><span class="com">// Min Len    = 1</span></li><li class="L4"><span class="pln">  </span><span class="com">// Max Len    = 1</span></li><li class="L5"><span class="pln">  </span><span class="com">//    B0      = UINT8 - Body Sensor Location</span></li><li class="L6"><span class="pln">  </span><span class="com">//      0     = Other</span></li><li class="L7"><span class="pln">  </span><span class="com">//      1     = Chest</span></li><li class="L8"><span class="pln">  </span><span class="com">//      2     = Wrist</span></li><li class="L9"><span class="pln">  </span><span class="com">//      3     = Finger</span></li><li class="L0"><span class="pln">  </span><span class="com">//      4     = Hand</span></li><li class="L1"><span class="pln">  </span><span class="com">//      5     = Ear Lobe</span></li><li class="L2"><span class="pln">  </span><span class="com">//      6     = Foot</span></li><li class="L3"><span class="pln">  </span><span class="com">//      7:255 = Reserved</span></li><li class="L4"><span class="pln">  bslc</span><span class="pun">.</span><span class="pln">setProperties</span><span class="pun">(</span><span class="pln">CHR_PROPS_READ</span><span class="pun">);</span></li><li class="L5"><span class="pln">  bslc</span><span class="pun">.</span><span class="pln">setPermission</span><span class="pun">(</span><span class="pln">SECMODE_OPEN</span><span class="pun">,</span><span class="pln"> SECMODE_NO_ACCESS</span><span class="pun">);</span></li><li class="L6"><span class="pln">  bslc</span><span class="pun">.</span><span class="pln">setFixedLen</span><span class="pun">(</span><span class="lit">1</span><span class="pun">);</span></li><li class="L7"><span class="pln">  bslc</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L8"><span class="pln">  bslc</span><span class="pun">.</span><span class="pln">write8</span><span class="pun">(</span><span class="lit">2</span><span class="pun">);</span><span class="pln">    </span><span class="com">// Set the characteristic to 'Wrist' (2)</span></li><li class="L9"><span class="pun">}</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="kwd">void</span><span class="pln"> connect_callback</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> conn_handle</span><span class="pun">)</span></li><li class="L2"><span class="pun">{</span></li><li class="L3"><span class="pln">  </span><span class="com">// Get the reference to current connection</span></li><li class="L4"><span class="pln">  </span><span class="typ">BLEConnection</span><span class="pun">*</span><span class="pln"> connection </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Connection</span><span class="pun">(</span><span class="pln">conn_handle</span><span class="pun">);</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">  </span><span class="kwd">char</span><span class="pln"> central_name</span><span class="pun">[</span><span class="lit">32</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="lit">0</span><span class="pln"> </span><span class="pun">};</span></li><li class="L7"><span class="pln">  connection</span><span class="pun">-&gt;</span><span class="pln">getPeerName</span><span class="pun">(</span><span class="pln">central_name</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">sizeof</span><span class="pun">(</span><span class="pln">central_name</span><span class="pun">));</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"Connected to "</span><span class="pun">);</span></li><li class="L0"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="pln">central_name</span><span class="pun">);</span></li><li class="L1"><span class="pun">}</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="com">/**</span></li><li class="L4"><span class="com"> * Callback invoked when a connection is dropped</span></li><li class="L5"><span class="com"> * @param conn_handle connection where this event happens</span></li><li class="L6"><span class="com"> * @param reason is a BLE_HCI_STATUS_CODE which can be found in ble_hci.h</span></li><li class="L7"><span class="com"> */</span></li><li class="L8"><span class="kwd">void</span><span class="pln"> disconnect_callback</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> conn_handle</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pln"> reason</span><span class="pun">)</span></li><li class="L9"><span class="pun">{</span></li><li class="L0"><span class="pln">  </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span><span class="pln"> conn_handle</span><span class="pun">;</span></li><li class="L1"><span class="pln">  </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span><span class="pln"> reason</span><span class="pun">;</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Disconnected"</span><span class="pun">);</span></li><li class="L4"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Advertising!"</span><span class="pun">);</span></li><li class="L5"><span class="pun">}</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="kwd">void</span><span class="pln"> cccd_callback</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> conn_hdl</span><span class="pun">,</span><span class="pln"> </span><span class="typ">BLECharacteristic</span><span class="pun">*</span><span class="pln"> chr</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint16_t</span><span class="pln"> cccd_value</span><span class="pun">)</span></li><li class="L8"><span class="pun">{</span></li><li class="L9"><span class="pln">    </span><span class="com">// Display the raw request packet</span></li><li class="L0"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"CCCD Updated: "</span><span class="pun">);</span></li><li class="L1"><span class="pln">    </span><span class="com">//Serial.printBuffer(request-&gt;data, request-&gt;len);</span></li><li class="L2"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="pln">cccd_value</span><span class="pun">);</span></li><li class="L3"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">""</span><span class="pun">);</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">    </span><span class="com">// Check the characteristic this CCCD update is associated with in case</span></li><li class="L6"><span class="pln">    </span><span class="com">// this handler is used for multiple CCCD records.</span></li><li class="L7"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">chr</span><span class="pun">-&gt;</span><span class="pln">uuid </span><span class="pun">==</span><span class="pln"> hrmc</span><span class="pun">.</span><span class="pln">uuid</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L8"><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">chr</span><span class="pun">-&gt;</span><span class="pln">notifyEnabled</span><span class="pun">(</span><span class="pln">conn_hdl</span><span class="pun">))</span><span class="pln"> </span><span class="pun">{</span></li><li class="L9"><span class="pln">            </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Heart Rate Measurement 'Notify' enabled"</span><span class="pun">);</span></li><li class="L0"><span class="pln">        </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span></li><li class="L1"><span class="pln">            </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Heart Rate Measurement 'Notify' disabled"</span><span class="pun">);</span></li><li class="L2"><span class="pln">        </span><span class="pun">}</span></li><li class="L3"><span class="pln">    </span><span class="pun">}</span></li><li class="L4"><span class="pun">}</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="kwd">void</span><span class="pln"> loop</span><span class="pun">()</span></li><li class="L7"><span class="pun">{</span></li><li class="L8"><span class="pln">  digitalToggle</span><span class="pun">(</span><span class="pln">LED_RED</span><span class="pun">);</span></li><li class="L9"><span class="pln">  </span></li><li class="L0"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="pln">connected</span><span class="pun">()</span><span class="pln"> </span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L1"><span class="pln">    </span><span class="typ">uint8_t</span><span class="pln"> hrmdata</span><span class="pun">[</span><span class="lit">2</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="lit">0b00000110</span><span class="pun">,</span><span class="pln"> bps</span><span class="pun">++</span><span class="pln"> </span><span class="pun">};</span><span class="pln">           </span><span class="com">// Sensor connected, increment BPS value</span></li><li class="L2"><span class="pln">    </span></li><li class="L3"><span class="pln">    </span><span class="com">// Note: We use .notify instead of .write!</span></li><li class="L4"><span class="pln">    </span><span class="com">// If it is connected but CCCD is not enabled</span></li><li class="L5"><span class="pln">    </span><span class="com">// The characteristic's value is still updated although notification is not sent</span></li><li class="L6"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> hrmc</span><span class="pun">.</span><span class="pln">notify</span><span class="pun">(</span><span class="pln">hrmdata</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">sizeof</span><span class="pun">(</span><span class="pln">hrmdata</span><span class="pun">))</span><span class="pln"> </span><span class="pun">){</span></li><li class="L7"><span class="pln">      </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"Heart Rate Measurement updated to: "</span><span class="pun">);</span><span class="pln"> </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="pln">bps</span><span class="pun">);</span><span class="pln"> </span></li><li class="L8"><span class="pln">    </span><span class="pun">}</span><span class="kwd">else</span><span class="pun">{</span></li><li class="L9"><span class="pln">      </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"ERROR: Notify not set in the CCCD or not connected!"</span><span class="pun">);</span></li><li class="L0"><span class="pln">    </span><span class="pun">}</span></li><li class="L1"><span class="pln">  </span><span class="pun">}</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="pln">  </span><span class="com">// Only send update once per second</span></li><li class="L4"><span class="pln">  delay</span><span class="pun">(</span><span class="lit">1000</span><span class="pun">);</span></li><li class="L5"><span class="pun">}</span></li></ol></pre>
</div>
</div>
</div>
<div class="page-title-wrapper">
<h1 class="headline">
<span id="bluefruit-nrf52-api">Arduino Bluefruit nRF52 API</span>
</h1>
<div class="author">by
<a href="./nRF52_bluefruit_Learning_Guide.html#bluefruit-nrf52-api">
<span class="name">Kevin Townsend</span>
</a> </div>
</div>
<div class="page-content all-page-view-content">
<div class="">
<div class="row-fluid build-text">
<p>The Adafruit nRF52 core defines a number of custom classes that aim to make it easy to work with BLE in your projects.</p>
<p>The key classes are listed below, and examined in more detail elsewhere in this learning guide:</p>
<ul>
<li>
<strong>AdafruitBluefruit</strong>&nbsp;is the main entry point to the Adafruit Bluefruit nRF52 API. This class exposes a number of essential functions and classes, such as advertising, the list of GATT services and characteristics defined on your device, and connection status.</li>
<li>
<strong>BLEService</strong>&nbsp;is a wrapper class for BLE GATT service records, and can be used to define custom service definitions, or acts as the base class for any service helper classes.</li>
<li>
<strong>BLECharacteristic</strong> is a wrapper class for a BLE GATT characteristic record, and can be used to define custom characteristics, or acts as &nbsp;the base class for any characteristic helper classes.</li>
<li>
<strong>BLEDis</strong> is a helper class for the DIS or 'Device Information Service'.</li>
<li>
<strong>BLEUart</strong> is a helper class for the NUS or 'Nordic UART Service'.</li>
<li>
<strong>BLEBeacon</strong> is a helper class to configure your nRF52 as a beacon using the advertising packet to send out properly formatted beacon data.</li>
<li>
<strong>BLEMidi</strong> is a helper class to work with MIDI data over BLE.</li>
<li>
<strong>BLEHidAdafruit</strong> is a helper class to emulate an HID mouse or keyboard over BLE.</li>
</ul>
</div>
<div class="element row-fluid build-alert alert-info ui-sortable-handle">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
Details on each of these helper classes are found further in this learning guide.
</div>
</div>
</div>
</div>
<div class="page-title-wrapper">
<h1 class="headline">
<span id="adafruitbluefruit">AdafruitBluefruit</span>
</h1>

</div>
<div class="page-content all-page-view-content">
<div class="">
<div class="element element row-fluid build-alert alert-danger">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
Adafruit's nRF52 BSP codebase is still undergoing active development based on customer feedback and testing. As such, the class documentation here may be incomplete, and you should consult the Github repo for the latest code and API developments: <a href="https://goo.gl/LdEx62">https://goo.gl/LdEx62</a>
</div>
</div>
<div class="row-fluid build-text">
<p>This base class is the main entry point to the Adafruit Bluefruit nRF52 API, and exposes most of the helper classes and functions that you use to configure your device.</p>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#api-19-3" class="anchor-link"><span class="fa fa-link"></span></a><span id="api-19-3" class="anchor-link-target"></span><span id="api" class="anchor-link-target"></span>API</h1>
<p>AdafruitBluefruit has the following public API:</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/8813/elements/2860692/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">// Constructor
AdafruitBluefruit(void);

/*------------------------------------------------------------------*/
/* Lower Level Classes (Bluefruit.Advertising.*, etc.)
 *------------------------------------------------------------------*/
BLEGap             Gap;
BLEGatt            Gatt;

BLEAdvertising     Advertising;
BLEAdvertisingData ScanResponse;
BLEScanner         Scanner;
BLECentral         Central;
BLEDiscovery       Discovery;

/*------------------------------------------------------------------*/
/* SoftDevice Configure Functions, must call before begin().
 * These function affect the SRAM consumed by SoftDevice.
 *------------------------------------------------------------------*/
void     configServiceChanged (bool     changed);
void     configUuid128Count   (uint8_t  uuid128_max);
void     configAttrTableSize  (uint32_t attr_table_size);

// Config Bandwidth for connections
void     configPrphConn        (uint16_t mtu_max, uint8_t event_len, uint8_t hvn_qsize, uint8_t wrcmd_qsize);
void     configCentralConn     (uint16_t mtu_max, uint8_t event_len, uint8_t hvn_qsize, uint8_t wrcmd_qsize);

// Convenient function to config connection
void     configPrphBandwidth   (uint8_t bw);
void     configCentralBandwidth(uint8_t bw);

err_t    begin(uint8_t prph_count = 1, uint8_t central_count = 0);

/*------------------------------------------------------------------*/
/* General Functions
 *------------------------------------------------------------------*/
void     setName            (const char* str);
uint8_t  getName            (char* name, uint16_t bufsize);

bool     setTxPower         (int8_t power);
int8_t   getTxPower         (void);

bool     setApperance       (uint16_t appear);
uint16_t getApperance       (void);

void     autoConnLed        (bool enabled);
void     setConnLedInterval (uint32_t ms);

/*------------------------------------------------------------------*/
/* GAP, Connections and Bonding
 *------------------------------------------------------------------*/
bool     connected         (void);
bool     disconnect        (void);

bool     setConnInterval   (uint16_t min, uint16_t max);
bool     setConnIntervalMS (uint16_t min_ms, uint16_t max_ms);

uint16_t connHandle        (void);
bool     connPaired        (void);
uint16_t connInterval      (void);

bool     requestPairing    (void);
void     clearBonds        (void);

ble_gap_addr_t getPeerAddr (void);
uint8_t        getPeerAddr (uint8_t addr[6]);

void     printInfo(void);

/*------------------------------------------------------------------*/
/* Callbacks
 *------------------------------------------------------------------*/
void setConnectCallback   ( BLEGap::connect_callback_t    fp);
void setDisconnectCallback( BLEGap::disconnect_callback_t fp);</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="com">// Constructor</span></li><li class="L1"><span class="typ">AdafruitBluefruit</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="com">/*------------------------------------------------------------------*/</span></li><li class="L4"><span class="com">/* Lower Level Classes (Bluefruit.Advertising.*, etc.)</span></li><li class="L5"><span class="com"> *------------------------------------------------------------------*/</span></li><li class="L6"><span class="typ">BLEGap</span><span class="pln">             </span><span class="typ">Gap</span><span class="pun">;</span></li><li class="L7"><span class="typ">BLEGatt</span><span class="pln">            </span><span class="typ">Gatt</span><span class="pun">;</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="typ">BLEAdvertising</span><span class="pln">     </span><span class="typ">Advertising</span><span class="pun">;</span></li><li class="L0"><span class="typ">BLEAdvertisingData</span><span class="pln"> </span><span class="typ">ScanResponse</span><span class="pun">;</span></li><li class="L1"><span class="typ">BLEScanner</span><span class="pln">         </span><span class="typ">Scanner</span><span class="pun">;</span></li><li class="L2"><span class="typ">BLECentral</span><span class="pln">         </span><span class="typ">Central</span><span class="pun">;</span></li><li class="L3"><span class="typ">BLEDiscovery</span><span class="pln">       </span><span class="typ">Discovery</span><span class="pun">;</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="com">/*------------------------------------------------------------------*/</span></li><li class="L6"><span class="com">/* SoftDevice Configure Functions, must call before begin().</span></li><li class="L7"><span class="com"> * These function affect the SRAM consumed by SoftDevice.</span></li><li class="L8"><span class="com"> *------------------------------------------------------------------*/</span></li><li class="L9"><span class="kwd">void</span><span class="pln">     configServiceChanged </span><span class="pun">(</span><span class="kwd">bool</span><span class="pln">     changed</span><span class="pun">);</span></li><li class="L0"><span class="kwd">void</span><span class="pln">     configUuid128Count   </span><span class="pun">(</span><span class="typ">uint8_t</span><span class="pln">  uuid128_max</span><span class="pun">);</span></li><li class="L1"><span class="kwd">void</span><span class="pln">     configAttrTableSize  </span><span class="pun">(</span><span class="typ">uint32_t</span><span class="pln"> attr_table_size</span><span class="pun">);</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="com">// Config Bandwidth for connections</span></li><li class="L4"><span class="kwd">void</span><span class="pln">     configPrphConn        </span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> mtu_max</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pln"> event_len</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pln"> hvn_qsize</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pln"> wrcmd_qsize</span><span class="pun">);</span></li><li class="L5"><span class="kwd">void</span><span class="pln">     configCentralConn     </span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> mtu_max</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pln"> event_len</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pln"> hvn_qsize</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pln"> wrcmd_qsize</span><span class="pun">);</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="com">// Convenient function to config connection</span></li><li class="L8"><span class="kwd">void</span><span class="pln">     configPrphBandwidth   </span><span class="pun">(</span><span class="typ">uint8_t</span><span class="pln"> bw</span><span class="pun">);</span></li><li class="L9"><span class="kwd">void</span><span class="pln">     configCentralBandwidth</span><span class="pun">(</span><span class="typ">uint8_t</span><span class="pln"> bw</span><span class="pun">);</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="typ">err_t</span><span class="pln">    </span><span class="kwd">begin</span><span class="pun">(</span><span class="typ">uint8_t</span><span class="pln"> prph_count </span><span class="pun">=</span><span class="pln"> </span><span class="lit">1</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pln"> central_count </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">);</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="com">/*------------------------------------------------------------------*/</span></li><li class="L4"><span class="com">/* General Functions</span></li><li class="L5"><span class="com"> *------------------------------------------------------------------*/</span></li><li class="L6"><span class="kwd">void</span><span class="pln">     setName            </span><span class="pun">(</span><span class="kwd">const</span><span class="pln"> </span><span class="kwd">char</span><span class="pun">*</span><span class="pln"> str</span><span class="pun">);</span></li><li class="L7"><span class="typ">uint8_t</span><span class="pln">  getName            </span><span class="pun">(</span><span class="kwd">char</span><span class="pun">*</span><span class="pln"> name</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint16_t</span><span class="pln"> bufsize</span><span class="pun">);</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="kwd">bool</span><span class="pln">     setTxPower         </span><span class="pun">(</span><span class="typ">int8_t</span><span class="pln"> power</span><span class="pun">);</span></li><li class="L0"><span class="typ">int8_t</span><span class="pln">   getTxPower         </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="kwd">bool</span><span class="pln">     setApperance       </span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> appear</span><span class="pun">);</span></li><li class="L3"><span class="typ">uint16_t</span><span class="pln"> getApperance       </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="kwd">void</span><span class="pln">     autoConnLed        </span><span class="pun">(</span><span class="kwd">bool</span><span class="pln"> enabled</span><span class="pun">);</span></li><li class="L6"><span class="kwd">void</span><span class="pln">     setConnLedInterval </span><span class="pun">(</span><span class="typ">uint32_t</span><span class="pln"> ms</span><span class="pun">);</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="com">/*------------------------------------------------------------------*/</span></li><li class="L9"><span class="com">/* GAP, Connections and Bonding</span></li><li class="L0"><span class="com"> *------------------------------------------------------------------*/</span></li><li class="L1"><span class="kwd">bool</span><span class="pln">     connected         </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L2"><span class="kwd">bool</span><span class="pln">     disconnect        </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="kwd">bool</span><span class="pln">     setConnInterval   </span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> min</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint16_t</span><span class="pln"> max</span><span class="pun">);</span></li><li class="L5"><span class="kwd">bool</span><span class="pln">     setConnIntervalMS </span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> min_ms</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint16_t</span><span class="pln"> max_ms</span><span class="pun">);</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="typ">uint16_t</span><span class="pln"> connHandle        </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L8"><span class="kwd">bool</span><span class="pln">     connPaired        </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L9"><span class="typ">uint16_t</span><span class="pln"> connInterval      </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="kwd">bool</span><span class="pln">     requestPairing    </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L2"><span class="kwd">void</span><span class="pln">     clearBonds        </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="typ">ble_gap_addr_t</span><span class="pln"> getPeerAddr </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L5"><span class="typ">uint8_t</span><span class="pln">        getPeerAddr </span><span class="pun">(</span><span class="typ">uint8_t</span><span class="pln"> addr</span><span class="pun">[</span><span class="lit">6</span><span class="pun">]);</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="kwd">void</span><span class="pln">     printInfo</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="com">/*------------------------------------------------------------------*/</span></li><li class="L0"><span class="com">/* Callbacks</span></li><li class="L1"><span class="com"> *------------------------------------------------------------------*/</span></li><li class="L2"><span class="kwd">void</span><span class="pln"> setConnectCallback   </span><span class="pun">(</span><span class="pln"> </span><span class="typ">BLEGap</span><span class="pun">::</span><span class="typ">connect_callback_t</span><span class="pln">    fp</span><span class="pun">);</span></li><li class="L3"><span class="kwd">void</span><span class="pln"> setDisconnectCallback</span><span class="pun">(</span><span class="pln"> </span><span class="typ">BLEGap</span><span class="pun">::</span><span class="typ">disconnect_callback_t</span><span class="pln"> fp</span><span class="pun">);</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<p>These functions are generally available via '<strong>Bluefruit.*</strong>'. For example, to check the connection status in your sketch you could run '<code>if (Bluefruit.connected()) { ... }</code>'.</p>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#examples-19-6" class="anchor-link"><span class="fa fa-link"></span></a><span id="examples-19-6" class="anchor-link-target"></span><span id="examples" class="anchor-link-target"></span>Examples</h1>
<p>For examples of how to work with the parent&nbsp;<strong>Bluefruit</strong> class, see the&nbsp;<strong>Examples</strong> section later in this guide. It's better to examine this class in the context of a real world use case.</p>
<p>You can also browse the latest example code online via Github:</p>
</div>
<div id="element-2860695" class="button-element" data-github-release="">
<a href="https://github.com/adafruit/Adafruit_nRF52_Arduino/tree/master/libraries/Bluefruit52Lib/examples" class="btn btn-large btn-block btn-info" target="_blank" data-zip-folder="" type="button">Browse the latest example code on Github</a>
</div>
</div>
</div>
<div class="page-title-wrapper">
<h1 class="headline">
<span id="blegap">BLEGap</span>
</h1>

</div>
<div class="page-content all-page-view-content">
<div class="">
<div class="element row-fluid build-alert">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
This page is a work in progress as the API is changing as we migrate to S132v5 (nRF52832) and add better Central mode support.
</div>
</div>
<div class="row-fluid build-text">
<p>This GAP API for Bluefruit is accessible via&nbsp;<code>Bluefruit.Gap.***</code>&nbsp;and has the following public functions:</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/11221/elements/2979317/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">typedef void (*connect_callback_t    ) (uint16_t conn_handle);
typedef void (*disconnect_callback_t ) (uint16_t conn_handle, uint8_t reason);

uint8_t        getAddr               (uint8_t mac[6]);
bool           setAddr               (uint8_t mac[6], uint8_t type);

bool           connected            (uint16_t conn_handle);

uint8_t        getRole              (uint16_t conn_handle);

uint8_t        getPeerAddr          (uint16_t conn_handle, uint8_t addr[6]);
ble_gap_addr_t getPeerAddr          (uint16_t conn_handle);
uint16_t       getPeerName          (uint16_t conn_handle, char* buf, uint16_t bufsize);

uint16_t       getMTU               (uint16_t conn_handle);
uint16_t       getMaxMtuByConnCfg   (uint8_t conn_cfg);
uint16_t       getMaxMtu            (uint8_t conn_handle);
</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="kwd">typedef</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> </span><span class="pun">(*</span><span class="typ">connect_callback_t</span><span class="pln">    </span><span class="pun">)</span><span class="pln"> </span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> conn_handle</span><span class="pun">);</span></li><li class="L1"><span class="kwd">typedef</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> </span><span class="pun">(*</span><span class="typ">disconnect_callback_t</span><span class="pln"> </span><span class="pun">)</span><span class="pln"> </span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> conn_handle</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pln"> reason</span><span class="pun">);</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="typ">uint8_t</span><span class="pln">        getAddr               </span><span class="pun">(</span><span class="typ">uint8_t</span><span class="pln"> mac</span><span class="pun">[</span><span class="lit">6</span><span class="pun">]);</span></li><li class="L4"><span class="kwd">bool</span><span class="pln">           setAddr               </span><span class="pun">(</span><span class="typ">uint8_t</span><span class="pln"> mac</span><span class="pun">[</span><span class="lit">6</span><span class="pun">],</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pln"> type</span><span class="pun">);</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="kwd">bool</span><span class="pln">           connected            </span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> conn_handle</span><span class="pun">);</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="typ">uint8_t</span><span class="pln">        getRole              </span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> conn_handle</span><span class="pun">);</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="typ">uint8_t</span><span class="pln">        getPeerAddr          </span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> conn_handle</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pln"> addr</span><span class="pun">[</span><span class="lit">6</span><span class="pun">]);</span></li><li class="L1"><span class="typ">ble_gap_addr_t</span><span class="pln"> getPeerAddr          </span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> conn_handle</span><span class="pun">);</span></li><li class="L2"><span class="typ">uint16_t</span><span class="pln">       getPeerName          </span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> conn_handle</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">char</span><span class="pun">*</span><span class="pln"> buf</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint16_t</span><span class="pln"> bufsize</span><span class="pun">);</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="typ">uint16_t</span><span class="pln">       getMTU               </span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> conn_handle</span><span class="pun">);</span></li><li class="L5"><span class="typ">uint16_t</span><span class="pln">       getMaxMtuByConnCfg   </span><span class="pun">(</span><span class="typ">uint8_t</span><span class="pln"> conn_cfg</span><span class="pun">);</span></li><li class="L6"><span class="typ">uint16_t</span><span class="pln">       getMaxMtu            </span><span class="pun">(</span><span class="typ">uint8_t</span><span class="pln"> conn_handle</span><span class="pun">);</span></li></ol></pre>
</div>
</div>
</div>
<div class="page-title-wrapper">
<h1 class="headline">
<span id="bleadvertising">BLEAdvertising</span>
</h1>

</div>
<div class="page-content all-page-view-content">
<div class="">
<div class="element row-fluid build-alert">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
The Bluefruit nRF52 BSP codebase is undergoing active development based on customer feedback and testing. As such, the class documentation here is incomplete, and you should consult the Github repo for the latest code and API developments: <a href="https://goo.gl/LdEx62">https://goo.gl/LdEx62</a>
</div>
</div>
<div class="row-fluid build-text">
<p>'Advertising' is what makes your Bluetooth Low Energy devices visible to other devices in listening range. The radio sends out specially formatter advertising packets that contain information like the device name, whether you can connect to the device (or if it only advertises), etc.</p>
<p>You can also include custom data in the advertising packet, which is essential how beacons work.</p>
<p>The <em>BLEAdvertisingData and&nbsp;BLEAdvertising</em>&nbsp;classes exposes a number of helper functions to make it easier to create well-formatted advertising packets, as well as to use the&nbsp;<strong>Scan Response</strong> option, which is an optional secondary advertising packet that can be requested by a Central device. (This gives you another 27 bytes of advertising data, but isn't sent out automatically like the main advertising packet.).</p>
<p>This two advertising packets are accessible via the&nbsp;parent AdafruitBluefruit class, calling '<code>Bluefruit.Advertising.*</code>' and '<code>Bluefruit.ScanResponse.*</code>' from your user sketches.</p>
<p>For examples of using these helper classes, see any of the&nbsp;<strong>examples</strong>&nbsp;later on in this guide, since all devices will advertise as part of the startup process.</p>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#api-21-3" class="anchor-link"><span class="fa fa-link"></span></a><span id="api-21-3" class="anchor-link-target"></span><span id="api" class="anchor-link-target"></span>API</h1>
<p>The <strong>BLEAdvertisingData</strong> class has the following public API:</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/9070/elements/2860699/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">/*------------- Adv Data -------------*/
bool addData(uint8_t type, const void* data, uint8_t len);
bool addFlags(uint8_t flags);
bool addTxPower(void);
bool addName(void);
bool addAppearance(uint16_t appearance);
bool addManufacturerData(const void* data, uint8_t count);

/*------------- UUID -------------*/
bool addUuid(BLEUuid bleuuid);
bool addUuid(BLEUuid bleuuid1, BLEUuid bleuuid2);
bool addUuid(BLEUuid bleuuid1, BLEUuid bleuuid2, BLEUuid bleuuid3);
bool addUuid(BLEUuid bleuuid1, BLEUuid bleuuid2, BLEUuid bleuuid3, BLEUuid bleuuid4);

bool addUuid(BLEUuid bleuuid[], uint8_t count);

/*------------- Service -------------*/
bool addService(BLEService&amp; service);
bool addService(BLEService&amp; service1, BLEService&amp; service2);
bool addService(BLEService&amp; service1, BLEService&amp; service2, BLEService&amp; service3);
bool addService(BLEService&amp; service1, BLEService&amp; service2, BLEService&amp; service3, BLEService&amp; service4);

/*------------- Client Service -------------*/
bool addService(BLEClientService&amp; service);

// Functions to work with the raw advertising packet
uint8_t  count(void);
uint8_t* getData(void);
bool     setData(const uint8_t* data, uint8_t count);
void     clearData(void);

bool     setData(Advertisable&amp; adv_able) { return adv_able.setAdv(*this); }</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="com">/*------------- Adv Data -------------*/</span></li><li class="L1"><span class="kwd">bool</span><span class="pln"> addData</span><span class="pun">(</span><span class="typ">uint8_t</span><span class="pln"> type</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">const</span><span class="pln"> </span><span class="kwd">void</span><span class="pun">*</span><span class="pln"> data</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pln"> len</span><span class="pun">);</span></li><li class="L2"><span class="kwd">bool</span><span class="pln"> addFlags</span><span class="pun">(</span><span class="typ">uint8_t</span><span class="pln"> flags</span><span class="pun">);</span></li><li class="L3"><span class="kwd">bool</span><span class="pln"> addTxPower</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L4"><span class="kwd">bool</span><span class="pln"> addName</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L5"><span class="kwd">bool</span><span class="pln"> addAppearance</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> appearance</span><span class="pun">);</span></li><li class="L6"><span class="kwd">bool</span><span class="pln"> addManufacturerData</span><span class="pun">(</span><span class="kwd">const</span><span class="pln"> </span><span class="kwd">void</span><span class="pun">*</span><span class="pln"> data</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pln"> count</span><span class="pun">);</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="com">/*------------- UUID -------------*/</span></li><li class="L9"><span class="kwd">bool</span><span class="pln"> addUuid</span><span class="pun">(</span><span class="typ">BLEUuid</span><span class="pln"> bleuuid</span><span class="pun">);</span></li><li class="L0"><span class="kwd">bool</span><span class="pln"> addUuid</span><span class="pun">(</span><span class="typ">BLEUuid</span><span class="pln"> bleuuid1</span><span class="pun">,</span><span class="pln"> </span><span class="typ">BLEUuid</span><span class="pln"> bleuuid2</span><span class="pun">);</span></li><li class="L1"><span class="kwd">bool</span><span class="pln"> addUuid</span><span class="pun">(</span><span class="typ">BLEUuid</span><span class="pln"> bleuuid1</span><span class="pun">,</span><span class="pln"> </span><span class="typ">BLEUuid</span><span class="pln"> bleuuid2</span><span class="pun">,</span><span class="pln"> </span><span class="typ">BLEUuid</span><span class="pln"> bleuuid3</span><span class="pun">);</span></li><li class="L2"><span class="kwd">bool</span><span class="pln"> addUuid</span><span class="pun">(</span><span class="typ">BLEUuid</span><span class="pln"> bleuuid1</span><span class="pun">,</span><span class="pln"> </span><span class="typ">BLEUuid</span><span class="pln"> bleuuid2</span><span class="pun">,</span><span class="pln"> </span><span class="typ">BLEUuid</span><span class="pln"> bleuuid3</span><span class="pun">,</span><span class="pln"> </span><span class="typ">BLEUuid</span><span class="pln"> bleuuid4</span><span class="pun">);</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="kwd">bool</span><span class="pln"> addUuid</span><span class="pun">(</span><span class="typ">BLEUuid</span><span class="pln"> bleuuid</span><span class="pun">[],</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pln"> count</span><span class="pun">);</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="com">/*------------- Service -------------*/</span></li><li class="L7"><span class="kwd">bool</span><span class="pln"> addService</span><span class="pun">(</span><span class="typ">BLEService</span><span class="pun">&amp;</span><span class="pln"> service</span><span class="pun">);</span></li><li class="L8"><span class="kwd">bool</span><span class="pln"> addService</span><span class="pun">(</span><span class="typ">BLEService</span><span class="pun">&amp;</span><span class="pln"> service1</span><span class="pun">,</span><span class="pln"> </span><span class="typ">BLEService</span><span class="pun">&amp;</span><span class="pln"> service2</span><span class="pun">);</span></li><li class="L9"><span class="kwd">bool</span><span class="pln"> addService</span><span class="pun">(</span><span class="typ">BLEService</span><span class="pun">&amp;</span><span class="pln"> service1</span><span class="pun">,</span><span class="pln"> </span><span class="typ">BLEService</span><span class="pun">&amp;</span><span class="pln"> service2</span><span class="pun">,</span><span class="pln"> </span><span class="typ">BLEService</span><span class="pun">&amp;</span><span class="pln"> service3</span><span class="pun">);</span></li><li class="L0"><span class="kwd">bool</span><span class="pln"> addService</span><span class="pun">(</span><span class="typ">BLEService</span><span class="pun">&amp;</span><span class="pln"> service1</span><span class="pun">,</span><span class="pln"> </span><span class="typ">BLEService</span><span class="pun">&amp;</span><span class="pln"> service2</span><span class="pun">,</span><span class="pln"> </span><span class="typ">BLEService</span><span class="pun">&amp;</span><span class="pln"> service3</span><span class="pun">,</span><span class="pln"> </span><span class="typ">BLEService</span><span class="pun">&amp;</span><span class="pln"> service4</span><span class="pun">);</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="com">/*------------- Client Service -------------*/</span></li><li class="L3"><span class="kwd">bool</span><span class="pln"> addService</span><span class="pun">(</span><span class="typ">BLEClientService</span><span class="pun">&amp;</span><span class="pln"> service</span><span class="pun">);</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="com">// Functions to work with the raw advertising packet</span></li><li class="L6"><span class="typ">uint8_t</span><span class="pln">  count</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L7"><span class="typ">uint8_t</span><span class="pun">*</span><span class="pln"> getData</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L8"><span class="kwd">bool</span><span class="pln">     setData</span><span class="pun">(</span><span class="kwd">const</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pun">*</span><span class="pln"> data</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pln"> count</span><span class="pun">);</span></li><li class="L9"><span class="kwd">void</span><span class="pln">     clearData</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="kwd">bool</span><span class="pln">     setData</span><span class="pun">(</span><span class="typ">Advertisable</span><span class="pun">&amp;</span><span class="pln"> adv_able</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> adv_able</span><span class="pun">.</span><span class="pln">setAdv</span><span class="pun">(*</span><span class="kwd">this</span><span class="pun">);</span><span class="pln"> </span><span class="pun">}</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<p>In addition to API from BLEAdvertisingData, The <strong>BLEAdvertising</strong> class also has functions that dictate the behavior of advertising such as slow/fast timeout, adv intervals, and callbacks etc...&nbsp; &nbsp;</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/9070/elements/2979319/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">typedef void (*stop_callback_t) (void);
typedef void (*slow_callback_t) (void);

void setType(uint8_t adv_type);
void setFastTimeout(uint16_t sec);

void setSlowCallback(slow_callback_t fp);
void setStopCallback(stop_callback_t fp);

void setInterval  (uint16_t fast, uint16_t slow);
void setIntervalMS(uint16_t fast, uint16_t slow);

uint16_t getInterval(void);

bool setBeacon(BLEBeacon&amp; beacon);
bool setBeacon(EddyStoneUrl&amp; eddy_url);

bool isRunning(void);

void restartOnDisconnect(bool enable);
bool start(uint16_t timeout = 0);
bool stop (void);
</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="kwd">typedef</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> </span><span class="pun">(*</span><span class="typ">stop_callback_t</span><span class="pun">)</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L1"><span class="kwd">typedef</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> </span><span class="pun">(*</span><span class="typ">slow_callback_t</span><span class="pun">)</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="kwd">void</span><span class="pln"> setType</span><span class="pun">(</span><span class="typ">uint8_t</span><span class="pln"> adv_type</span><span class="pun">);</span></li><li class="L4"><span class="kwd">void</span><span class="pln"> setFastTimeout</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> sec</span><span class="pun">);</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="kwd">void</span><span class="pln"> setSlowCallback</span><span class="pun">(</span><span class="typ">slow_callback_t</span><span class="pln"> fp</span><span class="pun">);</span></li><li class="L7"><span class="kwd">void</span><span class="pln"> setStopCallback</span><span class="pun">(</span><span class="typ">stop_callback_t</span><span class="pln"> fp</span><span class="pun">);</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="kwd">void</span><span class="pln"> setInterval  </span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> fast</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint16_t</span><span class="pln"> slow</span><span class="pun">);</span></li><li class="L0"><span class="kwd">void</span><span class="pln"> setIntervalMS</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> fast</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint16_t</span><span class="pln"> slow</span><span class="pun">);</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="typ">uint16_t</span><span class="pln"> getInterval</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="kwd">bool</span><span class="pln"> setBeacon</span><span class="pun">(</span><span class="typ">BLEBeacon</span><span class="pun">&amp;</span><span class="pln"> beacon</span><span class="pun">);</span></li><li class="L5"><span class="kwd">bool</span><span class="pln"> setBeacon</span><span class="pun">(</span><span class="typ">EddyStoneUrl</span><span class="pun">&amp;</span><span class="pln"> eddy_url</span><span class="pun">);</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="kwd">bool</span><span class="pln"> isRunning</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="kwd">void</span><span class="pln"> restartOnDisconnect</span><span class="pun">(</span><span class="kwd">bool</span><span class="pln"> enable</span><span class="pun">);</span></li><li class="L0"><span class="kwd">bool</span><span class="pln"> start</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> timeout </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">);</span></li><li class="L1"><span class="kwd">bool</span><span class="pln"> stop </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#related-information-21-7" class="anchor-link"><span class="fa fa-link"></span></a><span id="related-information-21-7" class="anchor-link-target"></span><span id="related-information" class="anchor-link-target"></span>Related Information</h1>
<ul>
<li>
<a href="https://www.bluetooth.com/specifications/assigned-numbers/generic-access-profile" target="_blank">Generic Access Profile</a>: This page contains the official list of assigned numbers for the&nbsp;'Data' type field. Data is inserted into the advertising packet by supplying a valid 'data' type, optionally followed by a properly formatted payload corresponding to the selected value.</li>
</ul>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#example-21-8" class="anchor-link"><span class="fa fa-link"></span></a><span id="example-21-8" class="anchor-link-target"></span><span id="example" class="anchor-link-target"></span>Example</h1>
<p>For practical example code, see the&nbsp;<strong>Examples</strong> section later on in this guide. The snippet below is provided for illustration purposes, but advertising should be examined in the context of a real use case since it varies from one setup to the next!</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/9070/elements/2860702/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">void setup(void)
{
  // Other startup code here 
  // ...
  
  // Set up Advertising Packet
  setupAdv();

  // Start Advertising
  Bluefruit.Advertising.start();
}

void startAdv(void)
{
  // Advertising packet
  Bluefruit.Advertising.addFlags(BLE_GAP_ADV_FLAGS_LE_ONLY_GENERAL_DISC_MODE);
  Bluefruit.Advertising.addTxPower();

  // Include bleuart 128-bit uuid
  Bluefruit.Advertising.addService(bleuart);

  // Secondary Scan Response packet (optional)
  // Since there is no room for 'Name' in Advertising packet
  Bluefruit.ScanResponse.addName();
  
  /* Start Advertising
   * - Enable auto advertising if disconnected
   * - Interval:  fast mode = 20 ms, slow mode = 152.5 ms
   * - Timeout for fast mode is 30 seconds
   * - Start(timeout) with timeout = 0 will advertise forever (until connected)
   * 
   * For recommended advertising interval
   * https://developer.apple.com/library/content/qa/qa1931/_index.html   
   */
  Bluefruit.Advertising.restartOnDisconnect(true);
  Bluefruit.Advertising.setInterval(32, 244);    // in unit of 0.625 ms
  Bluefruit.Advertising.setFastTimeout(30);      // number of seconds in fast mode
  Bluefruit.Advertising.start(0);                // 0 = Don't stop advertising after n seconds  
}</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="kwd">void</span><span class="pln"> setup</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="pln">  </span><span class="com">// Other startup code here </span></li><li class="L3"><span class="pln">  </span><span class="com">// ...</span></li><li class="L4"><span class="pln">  </span></li><li class="L5"><span class="pln">  </span><span class="com">// Set up Advertising Packet</span></li><li class="L6"><span class="pln">  setupAdv</span><span class="pun">();</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">  </span><span class="com">// Start Advertising</span></li><li class="L9"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">start</span><span class="pun">();</span></li><li class="L0"><span class="pun">}</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="kwd">void</span><span class="pln"> startAdv</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span></li><li class="L3"><span class="pun">{</span></li><li class="L4"><span class="pln">  </span><span class="com">// Advertising packet</span></li><li class="L5"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">addFlags</span><span class="pun">(</span><span class="pln">BLE_GAP_ADV_FLAGS_LE_ONLY_GENERAL_DISC_MODE</span><span class="pun">);</span></li><li class="L6"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">addTxPower</span><span class="pun">();</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">  </span><span class="com">// Include bleuart 128-bit uuid</span></li><li class="L9"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">addService</span><span class="pun">(</span><span class="pln">bleuart</span><span class="pun">);</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">  </span><span class="com">// Secondary Scan Response packet (optional)</span></li><li class="L2"><span class="pln">  </span><span class="com">// Since there is no room for 'Name' in Advertising packet</span></li><li class="L3"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">ScanResponse</span><span class="pun">.</span><span class="pln">addName</span><span class="pun">();</span></li><li class="L4"><span class="pln">  </span></li><li class="L5"><span class="pln">  </span><span class="com">/* Start Advertising</span></li><li class="L6"><span class="com">   * - Enable auto advertising if disconnected</span></li><li class="L7"><span class="com">   * - Interval:  fast mode = 20 ms, slow mode = 152.5 ms</span></li><li class="L8"><span class="com">   * - Timeout for fast mode is 30 seconds</span></li><li class="L9"><span class="com">   * - Start(timeout) with timeout = 0 will advertise forever (until connected)</span></li><li class="L0"><span class="com">   * </span></li><li class="L1"><span class="com">   * For recommended advertising interval</span></li><li class="L2"><span class="com">   * https://developer.apple.com/library/content/qa/qa1931/_index.html   </span></li><li class="L3"><span class="com">   */</span></li><li class="L4"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">restartOnDisconnect</span><span class="pun">(</span><span class="kwd">true</span><span class="pun">);</span></li><li class="L5"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">setInterval</span><span class="pun">(</span><span class="lit">32</span><span class="pun">,</span><span class="pln"> </span><span class="lit">244</span><span class="pun">);</span><span class="pln">    </span><span class="com">// in unit of 0.625 ms</span></li><li class="L6"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">setFastTimeout</span><span class="pun">(</span><span class="lit">30</span><span class="pun">);</span><span class="pln">      </span><span class="com">// number of seconds in fast mode</span></li><li class="L7"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">start</span><span class="pun">(</span><span class="lit">0</span><span class="pun">);</span><span class="pln">                </span><span class="com">// 0 = Don't stop advertising after n seconds  </span></li><li class="L8"><span class="pun">}</span></li></ol></pre>
</div>
</div>
</div>
<div class="page-title-wrapper">
<h1 class="headline">
<span id="blescanner">BLEScanner</span>
</h1>

</div>
<div class="page-content all-page-view-content">
<div class="">
<div class="element element row-fluid build-alert">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
The Bluefruit nRF52 BSP codebase is undergoing active development based on customer feedback and testing. As such, the class documentation here is incomplete, and you should consult the Github repo for the latest code and API developments: <a href="https://goo.gl/LdEx62">https://goo.gl/LdEx62</a>
</div>
</div>
<div class="element element element row-fluid build-alert alert-warning">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
This documentation is based on BSP 0.7.0 and higher. Please make sure you have an up to date version before using the code below.
</div>
</div>
<div class="row-fluid build-text">
<p>The BLEScanner class is used in&nbsp;<strong>Central Mode</strong>, and facilitates scanning for BLE peripherals in range and parsing the advertising data that is being sent out by the peripherals.</p>
<p>The BLEScanner class is normally accessed via the Bluefruit class (instantiated at startup), as shown below:</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/9968/elements/2860706/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">/* Start Central Scanning
 * - Enable auto scan if disconnected
 * - Filter for devices with a min RSSI of -80 dBm
 * - Interval = 100 ms, window = 50 ms
 * - Use active scan (requests the optional scan response packet)
 * - Start(0) = will scan forever since no timeout is given
 */
Bluefruit.Scanner.setRxCallback(scan_callback);
Bluefruit.Scanner.restartOnDisconnect(true);
Bluefruit.Scanner.filterRssi(-80);            // Only invoke callback when RSSI &gt;= -80 dBm
Bluefruit.Scanner.setInterval(160, 80);       // in units of 0.625 ms
Bluefruit.Scanner.useActiveScan(true);        // Request scan response data
Bluefruit.Scanner.start(0);                   // 0 = Don't stop scanning after n seconds</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="com">/* Start Central Scanning</span></li><li class="L1"><span class="com"> * - Enable auto scan if disconnected</span></li><li class="L2"><span class="com"> * - Filter for devices with a min RSSI of -80 dBm</span></li><li class="L3"><span class="com"> * - Interval = 100 ms, window = 50 ms</span></li><li class="L4"><span class="com"> * - Use active scan (requests the optional scan response packet)</span></li><li class="L5"><span class="com"> * - Start(0) = will scan forever since no timeout is given</span></li><li class="L6"><span class="com"> */</span></li><li class="L7"><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Scanner</span><span class="pun">.</span><span class="pln">setRxCallback</span><span class="pun">(</span><span class="pln">scan_callback</span><span class="pun">);</span></li><li class="L8"><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Scanner</span><span class="pun">.</span><span class="pln">restartOnDisconnect</span><span class="pun">(</span><span class="kwd">true</span><span class="pun">);</span></li><li class="L9"><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Scanner</span><span class="pun">.</span><span class="pln">filterRssi</span><span class="pun">(-</span><span class="lit">80</span><span class="pun">);</span><span class="pln">            </span><span class="com">// Only invoke callback when RSSI &gt;= -80 dBm</span></li><li class="L0"><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Scanner</span><span class="pun">.</span><span class="pln">setInterval</span><span class="pun">(</span><span class="lit">160</span><span class="pun">,</span><span class="pln"> </span><span class="lit">80</span><span class="pun">);</span><span class="pln">       </span><span class="com">// in units of 0.625 ms</span></li><li class="L1"><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Scanner</span><span class="pun">.</span><span class="pln">useActiveScan</span><span class="pun">(</span><span class="kwd">true</span><span class="pun">);</span><span class="pln">        </span><span class="com">// Request scan response data</span></li><li class="L2"><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Scanner</span><span class="pun">.</span><span class="pln">start</span><span class="pun">(</span><span class="lit">0</span><span class="pun">);</span><span class="pln">                   </span><span class="com">// 0 = Don't stop scanning after n seconds</span></li></ol></pre>
</div>
<div class="row-fluid build-text">

<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#api-22-5" class="anchor-link"><span class="fa fa-link"></span></a><span id="api-22-5" class="anchor-link-target"></span><span id="api" class="anchor-link-target"></span>API</h1>
<p>BLEScanner has the following public API:</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/9968/elements/2860708/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">typedef void (*rx_callback_t) (ble_gap_evt_adv_report_t*);
typedef void (*stop_callback_t) (void);

BLEScanner(void);

ble_gap_scan_params_t* getParams(void);
bool isRunning(void);

void useActiveScan(bool enable);
void setInterval(uint16_t interval, uint16_t window);
void setIntervalMS(uint16_t interval, uint16_t window);
void restartOnDisconnect(bool enable);

void filterRssi(int8_t min_rssi);
void filterMSD(uint16_t manuf_id);

void filterUuid(BLEUuid ble_uuid);
void filterUuid(BLEUuid ble_uuid1, BLEUuid ble_uuid2);
void filterUuid(BLEUuid ble_uuid1, BLEUuid ble_uuid2, BLEUuid ble_uuid3);
void filterUuid(BLEUuid ble_uuid1, BLEUuid ble_uuid2, BLEUuid ble_uuid3, BLEUuid ble_uuid4);
void filterUuid(BLEUuid ble_uuid[], uint8_t count);

void clearFilters(void);

bool start(uint16_t timeout = 0);
bool stop(void);

/*------------- Callbacks -------------*/
void setRxCallback(rx_callback_t fp);
void setStopCallback(stop_callback_t fp);

/*------------- Data Parser -------------*/
uint8_t parseReportByType(const uint8_t* scandata, uint8_t scanlen, uint8_t type, uint8_t* buf, uint8_t bufsize = 0);
uint8_t parseReportByType(const ble_gap_evt_adv_report_t* report, uint8_t type, uint8_t* buf, uint8_t bufsize = 0);

bool    checkReportForUuid(const ble_gap_evt_adv_report_t* report, BLEUuid ble_uuid);
bool    checkReportForService(const ble_gap_evt_adv_report_t* report, BLEClientService svc);
bool    checkReportForService(const ble_gap_evt_adv_report_t* report, BLEService svc);</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="kwd">typedef</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> </span><span class="pun">(*</span><span class="typ">rx_callback_t</span><span class="pun">)</span><span class="pln"> </span><span class="pun">(</span><span class="typ">ble_gap_evt_adv_report_t</span><span class="pun">*);</span></li><li class="L1"><span class="kwd">typedef</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> </span><span class="pun">(*</span><span class="typ">stop_callback_t</span><span class="pun">)</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="typ">BLEScanner</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="typ">ble_gap_scan_params_t</span><span class="pun">*</span><span class="pln"> getParams</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L6"><span class="kwd">bool</span><span class="pln"> isRunning</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="kwd">void</span><span class="pln"> useActiveScan</span><span class="pun">(</span><span class="kwd">bool</span><span class="pln"> enable</span><span class="pun">);</span></li><li class="L9"><span class="kwd">void</span><span class="pln"> setInterval</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> interval</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint16_t</span><span class="pln"> window</span><span class="pun">);</span></li><li class="L0"><span class="kwd">void</span><span class="pln"> setIntervalMS</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> interval</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint16_t</span><span class="pln"> window</span><span class="pun">);</span></li><li class="L1"><span class="kwd">void</span><span class="pln"> restartOnDisconnect</span><span class="pun">(</span><span class="kwd">bool</span><span class="pln"> enable</span><span class="pun">);</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="kwd">void</span><span class="pln"> filterRssi</span><span class="pun">(</span><span class="typ">int8_t</span><span class="pln"> min_rssi</span><span class="pun">);</span></li><li class="L4"><span class="kwd">void</span><span class="pln"> filterMSD</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> manuf_id</span><span class="pun">);</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="kwd">void</span><span class="pln"> filterUuid</span><span class="pun">(</span><span class="typ">BLEUuid</span><span class="pln"> ble_uuid</span><span class="pun">);</span></li><li class="L7"><span class="kwd">void</span><span class="pln"> filterUuid</span><span class="pun">(</span><span class="typ">BLEUuid</span><span class="pln"> ble_uuid1</span><span class="pun">,</span><span class="pln"> </span><span class="typ">BLEUuid</span><span class="pln"> ble_uuid2</span><span class="pun">);</span></li><li class="L8"><span class="kwd">void</span><span class="pln"> filterUuid</span><span class="pun">(</span><span class="typ">BLEUuid</span><span class="pln"> ble_uuid1</span><span class="pun">,</span><span class="pln"> </span><span class="typ">BLEUuid</span><span class="pln"> ble_uuid2</span><span class="pun">,</span><span class="pln"> </span><span class="typ">BLEUuid</span><span class="pln"> ble_uuid3</span><span class="pun">);</span></li><li class="L9"><span class="kwd">void</span><span class="pln"> filterUuid</span><span class="pun">(</span><span class="typ">BLEUuid</span><span class="pln"> ble_uuid1</span><span class="pun">,</span><span class="pln"> </span><span class="typ">BLEUuid</span><span class="pln"> ble_uuid2</span><span class="pun">,</span><span class="pln"> </span><span class="typ">BLEUuid</span><span class="pln"> ble_uuid3</span><span class="pun">,</span><span class="pln"> </span><span class="typ">BLEUuid</span><span class="pln"> ble_uuid4</span><span class="pun">);</span></li><li class="L0"><span class="kwd">void</span><span class="pln"> filterUuid</span><span class="pun">(</span><span class="typ">BLEUuid</span><span class="pln"> ble_uuid</span><span class="pun">[],</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pln"> count</span><span class="pun">);</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="kwd">void</span><span class="pln"> clearFilters</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="kwd">bool</span><span class="pln"> start</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> timeout </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">);</span></li><li class="L5"><span class="kwd">bool</span><span class="pln"> stop</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="com">/*------------- Callbacks -------------*/</span></li><li class="L8"><span class="kwd">void</span><span class="pln"> setRxCallback</span><span class="pun">(</span><span class="typ">rx_callback_t</span><span class="pln"> fp</span><span class="pun">);</span></li><li class="L9"><span class="kwd">void</span><span class="pln"> setStopCallback</span><span class="pun">(</span><span class="typ">stop_callback_t</span><span class="pln"> fp</span><span class="pun">);</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="com">/*------------- Data Parser -------------*/</span></li><li class="L2"><span class="typ">uint8_t</span><span class="pln"> parseReportByType</span><span class="pun">(</span><span class="kwd">const</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pun">*</span><span class="pln"> scandata</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pln"> scanlen</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pln"> type</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pun">*</span><span class="pln"> buf</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pln"> bufsize </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">);</span></li><li class="L3"><span class="typ">uint8_t</span><span class="pln"> parseReportByType</span><span class="pun">(</span><span class="kwd">const</span><span class="pln"> </span><span class="typ">ble_gap_evt_adv_report_t</span><span class="pun">*</span><span class="pln"> report</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pln"> type</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pun">*</span><span class="pln"> buf</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pln"> bufsize </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">);</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="kwd">bool</span><span class="pln">    checkReportForUuid</span><span class="pun">(</span><span class="kwd">const</span><span class="pln"> </span><span class="typ">ble_gap_evt_adv_report_t</span><span class="pun">*</span><span class="pln"> report</span><span class="pun">,</span><span class="pln"> </span><span class="typ">BLEUuid</span><span class="pln"> ble_uuid</span><span class="pun">);</span></li><li class="L6"><span class="kwd">bool</span><span class="pln">    checkReportForService</span><span class="pun">(</span><span class="kwd">const</span><span class="pln"> </span><span class="typ">ble_gap_evt_adv_report_t</span><span class="pun">*</span><span class="pln"> report</span><span class="pun">,</span><span class="pln"> </span><span class="typ">BLEClientService</span><span class="pln"> svc</span><span class="pun">);</span></li><li class="L7"><span class="kwd">bool</span><span class="pln">    checkReportForService</span><span class="pun">(</span><span class="kwd">const</span><span class="pln"> </span><span class="typ">ble_gap_evt_adv_report_t</span><span class="pun">*</span><span class="pln"> report</span><span class="pun">,</span><span class="pln"> </span><span class="typ">BLEService</span><span class="pln"> svc</span><span class="pun">);</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<h2>
<a href="./nRF52_bluefruit_Learning_Guide.html#setrxcallback-rx-callback-t-fp-22-7" class="anchor-link"><span class="fa fa-link"></span></a><span id="setrxcallback-rx-callback-t-fp-22-7" class="anchor-link-target"></span><span id="setrxcallback-rx-callback-t-fp" class="anchor-link-target"></span>setRxCallback(rx_callback_t fp)</h2>
<p>Whenever a valid advertising packet is detected (based on any optional filters that are applied in the BLEScanner class), a dedicated callback function (see <code>rx_callback_t</code>) will be called.</p>
<p>The callback function has the following signature:</p>
<p><strong>NOTE</strong>: <code>ble_gap_evt_adv_report_t</code> is part of the Nordic nRF52 SD and is defined in ble_gap.h</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/9968/elements/2860710/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">void scan_callback(ble_gap_evt_adv_report_t* report)
{
  /* Display the timestamp and device address */
  if (report-&gt;scan_rsp)
  {
    /* This is a Scan Response packet */
    Serial.printf("[SR%10d] Packet received from ", millis());
  }
  else
  {
    /* This is a normal advertising packet */
    Serial.printf("[ADV%9d] Packet received from ", millis());
  }
  Serial.printBuffer(report-&gt;peer_addr.addr, 6, ':');
  Serial.print("\n");

  /* Raw buffer contents */
  Serial.printf("%14s %d bytes\n", "PAYLOAD", report-&gt;dlen);
  if (report-&gt;dlen)
  {
    Serial.printf("%15s", " ");
    Serial.printBuffer(report-&gt;data, report-&gt;dlen, '-');
    Serial.println();
  }

  /* RSSI value */
  Serial.printf("%14s %d dBm\n", "RSSI", report-&gt;rssi);

  /* Adv Type */
  Serial.printf("%14s ", "ADV TYPE");
  switch (report-&gt;type)
  {
    case BLE_GAP_ADV_TYPE_ADV_IND:
      Serial.printf("Connectable undirected\n");
      break;
    case BLE_GAP_ADV_TYPE_ADV_DIRECT_IND:
      Serial.printf("Connectable directed\n");
      break;
    case BLE_GAP_ADV_TYPE_ADV_SCAN_IND:
      Serial.printf("Scannable undirected\n");
      break;
    case BLE_GAP_ADV_TYPE_ADV_NONCONN_IND:
      Serial.printf("Non-connectable undirected\n");
      break;
  }

  /* Check for BLE UART UUID */
  if ( Bluefruit.Scanner.checkReportForUuid(report, BLEUART_UUID_SERVICE) )
  {
    Serial.printf("%14s %s\n", "BLE UART", "UUID Found!");
  }

  /* Check for DIS UUID */
  if ( Bluefruit.Scanner.checkReportForUuid(report, UUID16_SVC_DEVICE_INFORMATION) )
  {
    Serial.printf("%14s %s\n", "DIS", "UUID Found!");
  }

  Serial.println();
}</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="kwd">void</span><span class="pln"> scan_callback</span><span class="pun">(</span><span class="typ">ble_gap_evt_adv_report_t</span><span class="pun">*</span><span class="pln"> report</span><span class="pun">)</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="pln">  </span><span class="com">/* Display the timestamp and device address */</span></li><li class="L3"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">report</span><span class="pun">-&gt;</span><span class="pln">scan_rsp</span><span class="pun">)</span></li><li class="L4"><span class="pln">  </span><span class="pun">{</span></li><li class="L5"><span class="pln">    </span><span class="com">/* This is a Scan Response packet */</span></li><li class="L6"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">printf</span><span class="pun">(</span><span class="str">"[SR%10d] Packet received from "</span><span class="pun">,</span><span class="pln"> millis</span><span class="pun">());</span></li><li class="L7"><span class="pln">  </span><span class="pun">}</span></li><li class="L8"><span class="pln">  </span><span class="kwd">else</span></li><li class="L9"><span class="pln">  </span><span class="pun">{</span></li><li class="L0"><span class="pln">    </span><span class="com">/* This is a normal advertising packet */</span></li><li class="L1"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">printf</span><span class="pun">(</span><span class="str">"[ADV%9d] Packet received from "</span><span class="pun">,</span><span class="pln"> millis</span><span class="pun">());</span></li><li class="L2"><span class="pln">  </span><span class="pun">}</span></li><li class="L3"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">printBuffer</span><span class="pun">(</span><span class="pln">report</span><span class="pun">-&gt;</span><span class="pln">peer_addr</span><span class="pun">.</span><span class="pln">addr</span><span class="pun">,</span><span class="pln"> </span><span class="lit">6</span><span class="pun">,</span><span class="pln"> </span><span class="str">':'</span><span class="pun">);</span></li><li class="L4"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"\n"</span><span class="pun">);</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">  </span><span class="com">/* Raw buffer contents */</span></li><li class="L7"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">printf</span><span class="pun">(</span><span class="str">"%14s %d bytes\n"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"PAYLOAD"</span><span class="pun">,</span><span class="pln"> report</span><span class="pun">-&gt;</span><span class="pln">dlen</span><span class="pun">);</span></li><li class="L8"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">report</span><span class="pun">-&gt;</span><span class="pln">dlen</span><span class="pun">)</span></li><li class="L9"><span class="pln">  </span><span class="pun">{</span></li><li class="L0"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">printf</span><span class="pun">(</span><span class="str">"%15s"</span><span class="pun">,</span><span class="pln"> </span><span class="str">" "</span><span class="pun">);</span></li><li class="L1"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">printBuffer</span><span class="pun">(</span><span class="pln">report</span><span class="pun">-&gt;</span><span class="pln">data</span><span class="pun">,</span><span class="pln"> report</span><span class="pun">-&gt;</span><span class="pln">dlen</span><span class="pun">,</span><span class="pln"> </span><span class="str">'-'</span><span class="pun">);</span></li><li class="L2"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">();</span></li><li class="L3"><span class="pln">  </span><span class="pun">}</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">  </span><span class="com">/* RSSI value */</span></li><li class="L6"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">printf</span><span class="pun">(</span><span class="str">"%14s %d dBm\n"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"RSSI"</span><span class="pun">,</span><span class="pln"> report</span><span class="pun">-&gt;</span><span class="pln">rssi</span><span class="pun">);</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">  </span><span class="com">/* Adv Type */</span></li><li class="L9"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">printf</span><span class="pun">(</span><span class="str">"%14s "</span><span class="pun">,</span><span class="pln"> </span><span class="str">"ADV TYPE"</span><span class="pun">);</span></li><li class="L0"><span class="pln">  </span><span class="kwd">switch</span><span class="pln"> </span><span class="pun">(</span><span class="pln">report</span><span class="pun">-&gt;</span><span class="pln">type</span><span class="pun">)</span></li><li class="L1"><span class="pln">  </span><span class="pun">{</span></li><li class="L2"><span class="pln">    </span><span class="kwd">case</span><span class="pln"> BLE_GAP_ADV_TYPE_ADV_IND</span><span class="pun">:</span></li><li class="L3"><span class="pln">      </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">printf</span><span class="pun">(</span><span class="str">"Connectable undirected\n"</span><span class="pun">);</span></li><li class="L4"><span class="pln">      </span><span class="kwd">break</span><span class="pun">;</span></li><li class="L5"><span class="pln">    </span><span class="kwd">case</span><span class="pln"> BLE_GAP_ADV_TYPE_ADV_DIRECT_IND</span><span class="pun">:</span></li><li class="L6"><span class="pln">      </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">printf</span><span class="pun">(</span><span class="str">"Connectable directed\n"</span><span class="pun">);</span></li><li class="L7"><span class="pln">      </span><span class="kwd">break</span><span class="pun">;</span></li><li class="L8"><span class="pln">    </span><span class="kwd">case</span><span class="pln"> BLE_GAP_ADV_TYPE_ADV_SCAN_IND</span><span class="pun">:</span></li><li class="L9"><span class="pln">      </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">printf</span><span class="pun">(</span><span class="str">"Scannable undirected\n"</span><span class="pun">);</span></li><li class="L0"><span class="pln">      </span><span class="kwd">break</span><span class="pun">;</span></li><li class="L1"><span class="pln">    </span><span class="kwd">case</span><span class="pln"> BLE_GAP_ADV_TYPE_ADV_NONCONN_IND</span><span class="pun">:</span></li><li class="L2"><span class="pln">      </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">printf</span><span class="pun">(</span><span class="str">"Non-connectable undirected\n"</span><span class="pun">);</span></li><li class="L3"><span class="pln">      </span><span class="kwd">break</span><span class="pun">;</span></li><li class="L4"><span class="pln">  </span><span class="pun">}</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">  </span><span class="com">/* Check for BLE UART UUID */</span></li><li class="L7"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Scanner</span><span class="pun">.</span><span class="pln">checkReportForUuid</span><span class="pun">(</span><span class="pln">report</span><span class="pun">,</span><span class="pln"> BLEUART_UUID_SERVICE</span><span class="pun">)</span><span class="pln"> </span><span class="pun">)</span></li><li class="L8"><span class="pln">  </span><span class="pun">{</span></li><li class="L9"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">printf</span><span class="pun">(</span><span class="str">"%14s %s\n"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"BLE UART"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"UUID Found!"</span><span class="pun">);</span></li><li class="L0"><span class="pln">  </span><span class="pun">}</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="pln">  </span><span class="com">/* Check for DIS UUID */</span></li><li class="L3"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Scanner</span><span class="pun">.</span><span class="pln">checkReportForUuid</span><span class="pun">(</span><span class="pln">report</span><span class="pun">,</span><span class="pln"> UUID16_SVC_DEVICE_INFORMATION</span><span class="pun">)</span><span class="pln"> </span><span class="pun">)</span></li><li class="L4"><span class="pln">  </span><span class="pun">{</span></li><li class="L5"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">printf</span><span class="pun">(</span><span class="str">"%14s %s\n"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"DIS"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"UUID Found!"</span><span class="pun">);</span></li><li class="L6"><span class="pln">  </span><span class="pun">}</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">();</span></li><li class="L9"><span class="pun">}</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<h2>
<a href="./nRF52_bluefruit_Learning_Guide.html#void-useactivescan-bool-enable-22-9" class="anchor-link"><span class="fa fa-link"></span></a><span id="void-useactivescan-bool-enable-22-9" class="anchor-link-target"></span><span id="void-useactivescan-bool-enable" class="anchor-link-target"></span>
<span class="pl-k">void</span> <span class="pl-en">useActiveScan</span>(<span class="pl-k">bool</span> enable);</h2>
<p>Enabling 'Active Scan' by setting the <code>enable</code>&nbsp;parameter to 1 will cause the device to request the optional&nbsp;<strong>Scan Response</strong> advertising packet, which is a second 31 byte advertising packet that can be used to transmit additional information.</p>
<p>By default active scanning is disabled, so no Scan Response packets will be received by BLEScanner unless this function is called and set to 1 before calling <code>Bluefruit.Scanner.start(0)</code>.</p>
</div>
<div class="row-fluid build-text">
<h2>
<a href="./nRF52_bluefruit_Learning_Guide.html#void-filterrssi-int8-t-min-rssi-void-filtermsd-uint16-t-manuf-id-void-filteruuid-bleuuid-ble-uuid-void-filteruuid-bleuuid-ble-uuid1-bleuuid-ble-uuid2-void-filteruuid-bleuuid-ble-uuid1-bleuuid-ble-uuid2-bleuuid-ble-uuid3-void-filteruuid-bleuuid-ble-uuid1-bleuuid-ble-uuid2-bleuuid-ble-uuid3-bleuuid-ble-uuid4-void-filteruuid-bleuuid-ble-uuid-uint8-t-count-22-10" class="anchor-link"><span class="fa fa-link"></span></a><span id="void-filterrssi-int8-t-min-rssi-void-filtermsd-uint16-t-manuf-id-void-filteruuid-bleuuid-ble-uuid-void-filteruuid-bleuuid-ble-uuid1-bleuuid-ble-uuid2-void-filteruuid-bleuuid-ble-uuid1-bleuuid-ble-uuid2-bleuuid-ble-uuid3-void-filteruuid-bleuuid-ble-uuid1-bleuuid-ble-uuid2-bleuuid-ble-uuid3-bleuuid-ble-uuid4-void-filteruuid-bleuuid-ble-uuid-uint8-t-count-22-10" class="anchor-link-target"></span><span id="void-filterrssi-int8-t-min-rssi-void-filtermsd-uint16-t-manuf-id-void-filteruuid-bleuuid-ble-uuid-void-filteruuid-bleuuid-ble-uuid1-bleuuid-ble-uuid2-void-filteruuid-bleuuid-ble-uuid1-bleuuid-ble-uuid2-bleuuid-ble-uuid3-void-filteruuid-bleuuid-ble-uuid1-bleuuid-ble-uuid2-bleuuid-ble-uuid3-bleuuid-ble-uuid4-void-filteruuid-bleuuid-ble-uuid-uint8-t-count" class="anchor-link-target"></span>void filterRssi(int8_t min_rssi);<br>void filterMSD(uint16_t manuf_id);<br>void filterUuid(BLEUuid ble_uuid);<br>void filterUuid(BLEUuid ble_uuid1, BLEUuid ble_uuid2);<br>void filterUuid(BLEUuid ble_uuid1, BLEUuid ble_uuid2, BLEUuid ble_uuid3);<br>void filterUuid(BLEUuid ble_uuid1, BLEUuid ble_uuid2, BLEUuid ble_uuid3, BLEUuid ble_uuid4);<br>void filterUuid(BLEUuid ble_uuid[], uint8_t count);<br><br>
</h2>
<p>Filters can be applied to BLEScanner to narrow down the data sent to the callback handler, and make processing advertising packets easier for you.</p>
<p>As of BSP 0.7.0 the following three filters are present:</p>
<ul>
<li>
<code>filterRssi(int8_t min_rssi)</code>: Filters advertising results to devices with at least the specified RSSI value, which allows you to ignore devices that are too far away or whose signal is too weak. The higher the number, the strong the signal so -90 is a very weak signal, and -60 is a much stronger one.</li>
<li>
<code>filterUuid(BLEUuid ble_uuid)</code>: Filters advertising results to devices that advertise themselves as having the specified service UUID. If multiple UUIDs are entered, they will be filtered with boolean OR logic, meaning any single UUID present will be considered a match.</li>
<li>
<code>void filterMSD(uint16_t manuf_id)</code>: Fitlers advertising results to devices that contain a Manufacturer Specific Data data type, and who use the specifed Bluetooth Customer ID (<code>manuf_id)</code>. This can be useful to filter iBeacon versus Eddystone devices, for example, which both used the MSD field, or to look for custom MSD data matching your own CID.</li>
</ul>
</div>
<div class="element element element element row-fluid build-alert alert-info">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
When multiple UUIDs are added via one of the .filterUuid(...) functions, they UUIDs will be filtered using boolean 'OR' logic, meaning that the callback will fire when ANY of the specified UUIDs are detected in the advertising packet.
</div>
</div>
<div class="row-fluid build-text">
<h2>
<a href="./nRF52_bluefruit_Learning_Guide.html#void-clearfilters-void-22-12" class="anchor-link"><span class="fa fa-link"></span></a><span id="void-clearfilters-void-22-12" class="anchor-link-target"></span><span id="void-clearfilters-void" class="anchor-link-target"></span>void clearFilters(void);</h2>
<p>This function clears and filter values set using the functions above.</p>
</div>
<div class="row-fluid build-text">
<h2>
<a href="./nRF52_bluefruit_Learning_Guide.html#bool-start-uint16-t-timeout-equals-0-bool-stop-void-22-13" class="anchor-link"><span class="fa fa-link"></span></a><span id="bool-start-uint16-t-timeout-equals-0-bool-stop-void-22-13" class="anchor-link-target"></span><span id="bool-start-uint16-t-timeout-equals-0-bool-stop-void" class="anchor-link-target"></span>bool start(uint16_t timeout = 0);<br> bool stop(void);</h2>
<p>The <code>.start</code> and <code>.stop</code> functions can be used to start and stop scanning, and should be called after all of the main parameters (timing, filters, etc.) have been set.</p>
<p>The <code>.start</code> function has a single parameter called timeout, which sets the number of seconds to scan for advertising packets. Setting this to '0' (the default value) will cause the device to scan forever.</p>
</div>
<div class="element element element element row-fluid build-alert alert-info">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
Make sure you set any filters of BLEScanner parameters before calling .start!
</div>
</div>
<div class="row-fluid build-text">
<h2>
<a href="./nRF52_bluefruit_Learning_Guide.html#void-restartondisconnect-bool-enable-22-15" class="anchor-link"><span class="fa fa-link"></span></a><span id="void-restartondisconnect-bool-enable-22-15" class="anchor-link-target"></span><span id="void-restartondisconnect-bool-enable" class="anchor-link-target"></span>
<span class="pl-k">void</span> <span class="pl-en">restartOnDisconnect</span>(<span class="pl-k">bool</span> enable);</h2>
<p>Setting this function to '1' will cause the scanning process to start again as soon as you disconnect from a peripheral device. The default behaviour is to automatically restart scanning on disconnect.</p>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#examples-22-16" class="anchor-link"><span class="fa fa-link"></span></a><span id="examples-22-16" class="anchor-link-target"></span><span id="examples" class="anchor-link-target"></span>Examples</h1>
<p>For an example that uses almost all of the BLEScanner and advertising API in Central mode, see <a href="https://github.com/adafruit/Adafruit_nRF52_Arduino/blob/master/libraries/Bluefruit52Lib/examples/Central/central_scan_advanced/central_scan_advanced.ino" target="_blank">central_scan_advanced.ino</a> in the Central examples folder.</p>
</div>
<div id="element-2860719" class="button-element" data-github-release="">
<a href="https://github.com/adafruit/Adafruit_nRF52_Arduino/blob/master/libraries/Bluefruit52Lib/examples/Central/central_scan_advanced/central_scan_advanced.ino" class="btn btn-large btn-block btn-primary" target="_self" data-zip-folder="" type="button">central_scan_advanced.ino on Github</a>
</div>
<div class="element element element element row-fluid build-alert alert-info">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
This example is only available in BSP 0.7.0 and higher!
</div>
</div>
</div>
</div>
<div class="page-title-wrapper">
<h1 class="headline">
<span id="bleservice">BLEService</span>
</h1>

</div>
<div class="page-content all-page-view-content">
<div class="">
<div class="element row-fluid build-alert">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
The Bluefruit nRF52 BSP codebase is undergoing active development based on customer feedback and testing. As such, the class documentation here is incomplete, and you should consult the Github repo for the latest code and API developments: <a href="https://goo.gl/LdEx62">https://goo.gl/LdEx62</a>
</div>
</div>
<div class="row-fluid build-text">
<p>This base class is used when defining custom BLE Gatt Services, such as the various service helper classes that make up the Adafruit Bluefruit nRF52 API described here.</p>
<p>Unless you are implementing a custom GATT service and characteristic, you normally won't use this base class directly, and would instantiate and call a higher level helper service or characteristic included in the Bluefruit nRF52 API.</p>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#basic-usage-23-3" class="anchor-link"><span class="fa fa-link"></span></a><span id="basic-usage-23-3" class="anchor-link-target"></span><span id="basic-usage" class="anchor-link-target"></span>Basic Usage</h1>
<p>There are normally only two operation required to use the BLEService class:</p>
<p>You need to declare and instantiate the class with an appropriate 16-bit or 128-bit UUID in the constructor:</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/8810/elements/2860724/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">BLEService myService = BLEService(0x1234);</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="typ">BLEService</span><span class="pln"> myService </span><span class="pun">=</span><span class="pln"> </span><span class="typ">BLEService</span><span class="pun">(</span><span class="lit">0x1234</span><span class="pun">);</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<p>You then need to call the&nbsp;<strong>.begin()</strong>&nbsp;method on the instance before adding any BLECharacteristics to it (via the BLECharacteristic's respective .begin() function call):</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/8810/elements/2860726/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">myService.begin();</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="pln">myService</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#order-of-operations-important-23-7" class="anchor-link"><span class="fa fa-link"></span></a><span id="order-of-operations-important-23-7" class="anchor-link-target"></span><span id="order-of-operations-important" class="anchor-link-target"></span>Order of Operations (Important!)</h1>
<p>One very important thing to take into consideration when working with BLEService and BLECharacteristic, is that any BLECharacteristic will automatically be added to the last BLEService that had it's `.begin()` function called. As such, you<strong> must call&nbsp;yourService.begin() before adding any characteristics!</strong></p>
<p>See the example at the bottom of this page for a concrete example of how this works in practice.</p>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#api-23-8" class="anchor-link"><span class="fa fa-link"></span></a><span id="api-23-8" class="anchor-link-target"></span><span id="api" class="anchor-link-target"></span>API</h1>
<p>BLEService has the following overall class structure:</p>
</div>
<div class="element element row-fluid build-alert alert-info">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
This documentation may be slightly out of date as bugs are fixed, and the API develops. You should always consult the Github repo for the definitive latest code release and class definitions!
</div>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/8810/elements/2860730/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">BLEUuid uuid;

static BLEService* lastService;

BLEService(void);
BLEService(uint16_t uuid16);
BLEService(uint8_t const  uuid128[]);

void setUuid(uint16_t uuid16);
void setUuid(uint8_t const  uuid128[]);

virtual err_t begin(void);</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="typ">BLEUuid</span><span class="pln"> uuid</span><span class="pun">;</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="kwd">static</span><span class="pln"> </span><span class="typ">BLEService</span><span class="pun">*</span><span class="pln"> lastService</span><span class="pun">;</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="typ">BLEService</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L5"><span class="typ">BLEService</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> uuid16</span><span class="pun">);</span></li><li class="L6"><span class="typ">BLEService</span><span class="pun">(</span><span class="typ">uint8_t</span><span class="pln"> </span><span class="kwd">const</span><span class="pln">  uuid128</span><span class="pun">[]);</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="kwd">void</span><span class="pln"> setUuid</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> uuid16</span><span class="pun">);</span></li><li class="L9"><span class="kwd">void</span><span class="pln"> setUuid</span><span class="pun">(</span><span class="typ">uint8_t</span><span class="pln"> </span><span class="kwd">const</span><span class="pln">  uuid128</span><span class="pun">[]);</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="kwd">virtual</span><span class="pln"> </span><span class="typ">err_t</span><span class="pln"> </span><span class="kwd">begin</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#example-23-11" class="anchor-link"><span class="fa fa-link"></span></a><span id="example-23-11" class="anchor-link-target"></span><span id="example" class="anchor-link-target"></span>Example</h1>
<p>The following example declares a HRM (Heart Rate Monitor) service, and assigns some characteristics to it:</p>
</div>
<div class="element element row-fluid build-alert alert-info">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
Note that this example code is incomplete. For the full example open the 'custom_hrm' example that is part of the nRF52 BSP! The code below is for illustration purposes only.
</div>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/8810/elements/2860733/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">/* HRM Service Definitions
 * Heart Rate Monitor Service:  0x180D
 * Heart Rate Measurement Char: 0x2A37
 * Body Sensor Location Char:   0x2A38
 */
BLEService        hrms = BLEService(UUID16_SVC_HEART_RATE);
BLECharacteristic hrmc = BLECharacteristic(UUID16_CHR_HEART_RATE_MEASUREMENT);
BLECharacteristic bslc = BLECharacteristic(UUID16_CHR_BODY_SENSOR_LOCATION);

void setupHRM(void)
{
  // Configure the Heart Rate Monitor service
  // See: https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.service.heart_rate.xml
  // Supported Characteristics:
  // Name                         UUID    Requirement Properties
  // ---------------------------- ------  ----------- ----------
  // Heart Rate Measurement       0x2A37  Mandatory   Notify
  // Body Sensor Location         0x2A38  Optional    Read
  // Heart Rate Control Point     0x2A39  Conditional Write       &lt;-- Not used here
  hrms.begin();

  // Note: You must call .begin() on the BLEService before calling .begin() on
  // any characteristic(s) within that service definition.. Calling .begin() on
  // a BLECharacteristic will cause it to be added to the last BLEService that
  // was 'begin()'ed!

  // Configure the Heart Rate Measurement characteristic
  // See: https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.characteristic.heart_rate_measurement.xml
  // Permission = Notify
  // Min Len    = 1
  // Max Len    = 8
  //    B0      = UINT8  - Flag (MANDATORY)
  //      b5:7  = Reserved
  //      b4    = RR-Internal (0 = Not present, 1 = Present)
  //      b3    = Energy expended status (0 = Not present, 1 = Present)
  //      b1:2  = Sensor contact status (0+1 = Not supported, 2 = Supported but contact not detected, 3 = Supported and detected)
  //      b0    = Value format (0 = UINT8, 1 = UINT16)
  //    B1      = UINT8  - 8-bit heart rate measurement value in BPM
  //    B2:3    = UINT16 - 16-bit heart rate measurement value in BPM
  //    B4:5    = UINT16 - Energy expended in joules
  //    B6:7    = UINT16 - RR Internal (1/1024 second resolution)
  hrmc.setProperties(CHR_PROPS_NOTIFY);
  hrmc.setPermission(SECMODE_OPEN, SECMODE_NO_ACCESS);
  hrmc.setFixedLen(2);
  hrmc.setCccdWriteCallback(cccd_callback);  // Optionally capture CCCD updates
  hrmc.begin();
  uint8_t hrmdata[2] = { 0b00000110, 0x40 }; // Set the characteristic to use 8-bit values, with the sensor connected and detected
  hrmc.notify(hrmdata, 2);                   // Use .notify instead of .write!

  // Configure the Body Sensor Location characteristic
  // See: https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.characteristic.body_sensor_location.xml
  // Permission = Read
  // Min Len    = 1
  // Max Len    = 1
  //    B0      = UINT8 - Body Sensor Location
  //      0     = Other
  //      1     = Chest
  //      2     = Wrist
  //      3     = Finger
  //      4     = Hand
  //      5     = Ear Lobe
  //      6     = Foot
  //      7:255 = Reserved
  bslc.setProperties(CHR_PROPS_READ);
  bslc.setPermission(SECMODE_OPEN, SECMODE_NO_ACCESS);
  bslc.setFixedLen(1);
  bslc.begin();
  bslc.write8(2);    // Set the characteristic to 'Wrist' (2)
}

void cccd_callback(BLECharacteristic&amp; chr, uint16_t cccd_value)
{
    // Display the raw request packet
    Serial.print("CCCD Updated: ");
    //Serial.printBuffer(request-&gt;data, request-&gt;len);
    Serial.print(cccd_value);
    Serial.println("");

    // Check the characteristic this CCCD update is associated with in case
    // this handler is used for multiple CCCD records.
    if (chr.uuid == hrmc.uuid) {
        if (chr.notifyEnabled()) {
            Serial.println("Heart Rate Measurement 'Notify' enabled");
        } else {
            Serial.println("Heart Rate Measurement 'Notify' disabled");
        }
    }
}</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="com">/* HRM Service Definitions</span></li><li class="L1"><span class="com"> * Heart Rate Monitor Service:  0x180D</span></li><li class="L2"><span class="com"> * Heart Rate Measurement Char: 0x2A37</span></li><li class="L3"><span class="com"> * Body Sensor Location Char:   0x2A38</span></li><li class="L4"><span class="com"> */</span></li><li class="L5"><span class="typ">BLEService</span><span class="pln">        hrms </span><span class="pun">=</span><span class="pln"> </span><span class="typ">BLEService</span><span class="pun">(</span><span class="pln">UUID16_SVC_HEART_RATE</span><span class="pun">);</span></li><li class="L6"><span class="typ">BLECharacteristic</span><span class="pln"> hrmc </span><span class="pun">=</span><span class="pln"> </span><span class="typ">BLECharacteristic</span><span class="pun">(</span><span class="pln">UUID16_CHR_HEART_RATE_MEASUREMENT</span><span class="pun">);</span></li><li class="L7"><span class="typ">BLECharacteristic</span><span class="pln"> bslc </span><span class="pun">=</span><span class="pln"> </span><span class="typ">BLECharacteristic</span><span class="pun">(</span><span class="pln">UUID16_CHR_BODY_SENSOR_LOCATION</span><span class="pun">);</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="kwd">void</span><span class="pln"> setupHRM</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span></li><li class="L0"><span class="pun">{</span></li><li class="L1"><span class="pln">  </span><span class="com">// Configure the Heart Rate Monitor service</span></li><li class="L2"><span class="pln">  </span><span class="com">// See: https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.service.heart_rate.xml</span></li><li class="L3"><span class="pln">  </span><span class="com">// Supported Characteristics:</span></li><li class="L4"><span class="pln">  </span><span class="com">// Name                         UUID    Requirement Properties</span></li><li class="L5"><span class="pln">  </span><span class="com">// ---------------------------- ------  ----------- ----------</span></li><li class="L6"><span class="pln">  </span><span class="com">// Heart Rate Measurement       0x2A37  Mandatory   Notify</span></li><li class="L7"><span class="pln">  </span><span class="com">// Body Sensor Location         0x2A38  Optional    Read</span></li><li class="L8"><span class="pln">  </span><span class="com">// Heart Rate Control Point     0x2A39  Conditional Write       &lt;-- Not used here</span></li><li class="L9"><span class="pln">  hrms</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">  </span><span class="com">// Note: You must call .begin() on the BLEService before calling .begin() on</span></li><li class="L2"><span class="pln">  </span><span class="com">// any characteristic(s) within that service definition.. Calling .begin() on</span></li><li class="L3"><span class="pln">  </span><span class="com">// a BLECharacteristic will cause it to be added to the last BLEService that</span></li><li class="L4"><span class="pln">  </span><span class="com">// was 'begin()'ed!</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">  </span><span class="com">// Configure the Heart Rate Measurement characteristic</span></li><li class="L7"><span class="pln">  </span><span class="com">// See: https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.characteristic.heart_rate_measurement.xml</span></li><li class="L8"><span class="pln">  </span><span class="com">// Permission = Notify</span></li><li class="L9"><span class="pln">  </span><span class="com">// Min Len    = 1</span></li><li class="L0"><span class="pln">  </span><span class="com">// Max Len    = 8</span></li><li class="L1"><span class="pln">  </span><span class="com">//    B0      = UINT8  - Flag (MANDATORY)</span></li><li class="L2"><span class="pln">  </span><span class="com">//      b5:7  = Reserved</span></li><li class="L3"><span class="pln">  </span><span class="com">//      b4    = RR-Internal (0 = Not present, 1 = Present)</span></li><li class="L4"><span class="pln">  </span><span class="com">//      b3    = Energy expended status (0 = Not present, 1 = Present)</span></li><li class="L5"><span class="pln">  </span><span class="com">//      b1:2  = Sensor contact status (0+1 = Not supported, 2 = Supported but contact not detected, 3 = Supported and detected)</span></li><li class="L6"><span class="pln">  </span><span class="com">//      b0    = Value format (0 = UINT8, 1 = UINT16)</span></li><li class="L7"><span class="pln">  </span><span class="com">//    B1      = UINT8  - 8-bit heart rate measurement value in BPM</span></li><li class="L8"><span class="pln">  </span><span class="com">//    B2:3    = UINT16 - 16-bit heart rate measurement value in BPM</span></li><li class="L9"><span class="pln">  </span><span class="com">//    B4:5    = UINT16 - Energy expended in joules</span></li><li class="L0"><span class="pln">  </span><span class="com">//    B6:7    = UINT16 - RR Internal (1/1024 second resolution)</span></li><li class="L1"><span class="pln">  hrmc</span><span class="pun">.</span><span class="pln">setProperties</span><span class="pun">(</span><span class="pln">CHR_PROPS_NOTIFY</span><span class="pun">);</span></li><li class="L2"><span class="pln">  hrmc</span><span class="pun">.</span><span class="pln">setPermission</span><span class="pun">(</span><span class="pln">SECMODE_OPEN</span><span class="pun">,</span><span class="pln"> SECMODE_NO_ACCESS</span><span class="pun">);</span></li><li class="L3"><span class="pln">  hrmc</span><span class="pun">.</span><span class="pln">setFixedLen</span><span class="pun">(</span><span class="lit">2</span><span class="pun">);</span></li><li class="L4"><span class="pln">  hrmc</span><span class="pun">.</span><span class="pln">setCccdWriteCallback</span><span class="pun">(</span><span class="pln">cccd_callback</span><span class="pun">);</span><span class="pln">  </span><span class="com">// Optionally capture CCCD updates</span></li><li class="L5"><span class="pln">  hrmc</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L6"><span class="pln">  </span><span class="typ">uint8_t</span><span class="pln"> hrmdata</span><span class="pun">[</span><span class="lit">2</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="lit">0b00000110</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x40</span><span class="pln"> </span><span class="pun">};</span><span class="pln"> </span><span class="com">// Set the characteristic to use 8-bit values, with the sensor connected and detected</span></li><li class="L7"><span class="pln">  hrmc</span><span class="pun">.</span><span class="pln">notify</span><span class="pun">(</span><span class="pln">hrmdata</span><span class="pun">,</span><span class="pln"> </span><span class="lit">2</span><span class="pun">);</span><span class="pln">                   </span><span class="com">// Use .notify instead of .write!</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="pln">  </span><span class="com">// Configure the Body Sensor Location characteristic</span></li><li class="L0"><span class="pln">  </span><span class="com">// See: https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.characteristic.body_sensor_location.xml</span></li><li class="L1"><span class="pln">  </span><span class="com">// Permission = Read</span></li><li class="L2"><span class="pln">  </span><span class="com">// Min Len    = 1</span></li><li class="L3"><span class="pln">  </span><span class="com">// Max Len    = 1</span></li><li class="L4"><span class="pln">  </span><span class="com">//    B0      = UINT8 - Body Sensor Location</span></li><li class="L5"><span class="pln">  </span><span class="com">//      0     = Other</span></li><li class="L6"><span class="pln">  </span><span class="com">//      1     = Chest</span></li><li class="L7"><span class="pln">  </span><span class="com">//      2     = Wrist</span></li><li class="L8"><span class="pln">  </span><span class="com">//      3     = Finger</span></li><li class="L9"><span class="pln">  </span><span class="com">//      4     = Hand</span></li><li class="L0"><span class="pln">  </span><span class="com">//      5     = Ear Lobe</span></li><li class="L1"><span class="pln">  </span><span class="com">//      6     = Foot</span></li><li class="L2"><span class="pln">  </span><span class="com">//      7:255 = Reserved</span></li><li class="L3"><span class="pln">  bslc</span><span class="pun">.</span><span class="pln">setProperties</span><span class="pun">(</span><span class="pln">CHR_PROPS_READ</span><span class="pun">);</span></li><li class="L4"><span class="pln">  bslc</span><span class="pun">.</span><span class="pln">setPermission</span><span class="pun">(</span><span class="pln">SECMODE_OPEN</span><span class="pun">,</span><span class="pln"> SECMODE_NO_ACCESS</span><span class="pun">);</span></li><li class="L5"><span class="pln">  bslc</span><span class="pun">.</span><span class="pln">setFixedLen</span><span class="pun">(</span><span class="lit">1</span><span class="pun">);</span></li><li class="L6"><span class="pln">  bslc</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L7"><span class="pln">  bslc</span><span class="pun">.</span><span class="pln">write8</span><span class="pun">(</span><span class="lit">2</span><span class="pun">);</span><span class="pln">    </span><span class="com">// Set the characteristic to 'Wrist' (2)</span></li><li class="L8"><span class="pun">}</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="kwd">void</span><span class="pln"> cccd_callback</span><span class="pun">(</span><span class="typ">BLECharacteristic</span><span class="pun">&amp;</span><span class="pln"> chr</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint16_t</span><span class="pln"> cccd_value</span><span class="pun">)</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="pln">    </span><span class="com">// Display the raw request packet</span></li><li class="L3"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"CCCD Updated: "</span><span class="pun">);</span></li><li class="L4"><span class="pln">    </span><span class="com">//Serial.printBuffer(request-&gt;data, request-&gt;len);</span></li><li class="L5"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="pln">cccd_value</span><span class="pun">);</span></li><li class="L6"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">""</span><span class="pun">);</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">    </span><span class="com">// Check the characteristic this CCCD update is associated with in case</span></li><li class="L9"><span class="pln">    </span><span class="com">// this handler is used for multiple CCCD records.</span></li><li class="L0"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">chr</span><span class="pun">.</span><span class="pln">uuid </span><span class="pun">==</span><span class="pln"> hrmc</span><span class="pun">.</span><span class="pln">uuid</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L1"><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">chr</span><span class="pun">.</span><span class="pln">notifyEnabled</span><span class="pun">())</span><span class="pln"> </span><span class="pun">{</span></li><li class="L2"><span class="pln">            </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Heart Rate Measurement 'Notify' enabled"</span><span class="pun">);</span></li><li class="L3"><span class="pln">        </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span></li><li class="L4"><span class="pln">            </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Heart Rate Measurement 'Notify' disabled"</span><span class="pun">);</span></li><li class="L5"><span class="pln">        </span><span class="pun">}</span></li><li class="L6"><span class="pln">    </span><span class="pun">}</span></li><li class="L7"><span class="pun">}</span></li></ol></pre>
</div>
</div>
</div>
<div class="page-title-wrapper">
<h1 class="headline">
<span id="blecharacteristic">BLECharacteristic</span>
</h1>

</div>
<div class="page-content all-page-view-content">
<div class="">
<div class="element row-fluid build-alert">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
The Bluefruit nRF52 BSP codebase is undergoing active development based on customer feedback and testing. As such, the class documentation here is incomplete, and you should consult the Github repo for the latest code and API developments: <a href="https://goo.gl/LdEx62">https://goo.gl/LdEx62</a>
</div>
</div>
<div class="row-fluid build-text">
<p>This base class is used when defining custom BLE GATT characteristics, and is used throughput the Adafruit Bluefruit nRF52 API and helper classes.</p>
<p>Unless you are implementing a custom GATT service and characteristic, you normally won't use this base class directly, and would instantiate and call a higher level helper service or characteristic included in the Bluefruit nRF52 API.</p>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#basic-usage-24-3" class="anchor-link"><span class="fa fa-link"></span></a><span id="basic-usage-24-3" class="anchor-link-target"></span><span id="basic-usage" class="anchor-link-target"></span>Basic Usage</h1>
<p>There are two main steps to using the BLECharacteristic class.</p>
<p>First, you need to declare and instantiate your BLECharacteristic class with a 16-bit or 128-bit UUID:</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/8811/elements/2860737/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">BLECharacteristic myChar = BLECharacteristic(0xABCD);
</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="typ">BLECharacteristic</span><span class="pln"> myChar </span><span class="pun">=</span><span class="pln"> </span><span class="typ">BLECharacteristic</span><span class="pun">(</span><span class="lit">0xABCD</span><span class="pun">);</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<p>Then you need to set the relevant properties for the characteristic, with the following values at minimum:</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/8811/elements/2860739/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">myChar.setProperties(CHR_PROPS_READ);
myChar.setPermission(SECMODE_OPEN, SECMODE_NO_ACCESS);
myChar.setFixedLen(1); // Alternatively .setMaxLen(uint16_t len)
myChar.begin();</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="pln">myChar</span><span class="pun">.</span><span class="pln">setProperties</span><span class="pun">(</span><span class="pln">CHR_PROPS_READ</span><span class="pun">);</span></li><li class="L1"><span class="pln">myChar</span><span class="pun">.</span><span class="pln">setPermission</span><span class="pun">(</span><span class="pln">SECMODE_OPEN</span><span class="pun">,</span><span class="pln"> SECMODE_NO_ACCESS</span><span class="pun">);</span></li><li class="L2"><span class="pln">myChar</span><span class="pun">.</span><span class="pln">setFixedLen</span><span class="pun">(</span><span class="lit">1</span><span class="pun">);</span><span class="pln"> </span><span class="com">// Alternatively .setMaxLen(uint16_t len)</span></li><li class="L3"><span class="pln">myChar</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<ul>
<li>
<strong>.setProperties</strong> can be set to one or more of the following macros, which correspond to a single bit in the eight bit 'properties' field for the characteristic definition:</li>
<ul>
<li>CHR_PROPS_BROADCAST = bit(0),</li>
<li>CHR_PROPS_READ = bit(1),</li>
<li>CHR_PROPS_WRITE_WO_RESP = bit(2),</li>
<li>CHR_PROPS_WRITE = bit(3),</li>
<li>CHR_PROPS_NOTIFY = bit(4),</li>
<li>CHR_PROPS_INDICATE = bit(5)</li>
</ul>
<li>
<strong>.setPermission</strong> sets the security level for the characteristic, where the first value sets the read permissions, and the second value sets the write permissions, where both fields can have one of the following values:</li>
<ul>
<li>SECMODE_NO_ACCESS = 0x00,</li>
<li>SECMODE_OPEN = 0x11,</li>
<li>SECMODE_ENC_NO_MITM = 0x21,</li>
<li>SECMODE_ENC_WITH_MITM = 0x31,</li>
<li>SECMODE_SIGNED_NO_MITM = 0x12,</li>
<li>SECMODE_SIGNED_WITH_MITM = 0x22</li>
</ul>
<li>
<strong>.setFixedLen()</strong> indicates how many bytes this characteristic has. For characteristics that use 'notify' or 'indicate' this value can be from 1..20, other characteristic types can be set from 1..512 and values &gt;20 bytes will be sent across multiple 20 byte packets. If the characteristic has a variable len, you set the <strong>.setMaxLen()</strong> value to the maximum value it will hold (up to 20 bytes).</li>
<li>
<strong>.begin()</strong> will cause this characteristic to be added to the last&nbsp;<strong>BLEService</strong> that had it's&nbsp;<strong>.begin()</strong> method called.</li>
</ul>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#order-of-operations-important-24-8" class="anchor-link"><span class="fa fa-link"></span></a><span id="order-of-operations-important-24-8" class="anchor-link-target"></span><span id="order-of-operations-important" class="anchor-link-target"></span>Order of Operations (Important!)</h1>
<p>One very important thing to take into consideration when working with BLEService and BLECharacteristic, is that any BLECharacteristic will automatically be added to the last BLEService that had it's `.begin()` function called. As such, you<strong> must call&nbsp;yourService.begin() before adding any characteristics!</strong></p>
<p>See the example at the bottom of this page for a concrete example of how this works in practice.</p>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#api-24-9" class="anchor-link"><span class="fa fa-link"></span></a><span id="api-24-9" class="anchor-link-target"></span><span id="api" class="anchor-link-target"></span>API</h1>
<p>BLECharacteristic has the following overall class structure:</p>
</div>
<div class="element element element element element element row-fluid build-alert alert-info">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
This documentation may be slightly out of date as bugs are fixed, and the API develops. You should always consult the Github repo for the definitive latest code release and class definitions!
</div>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/8811/elements/2860744/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">/*--------- Callback Signatures ----------*/
typedef void (*read_authorize_cb_t)  (BLECharacteristic&amp; chr, ble_gatts_evt_read_t * request);
typedef void (*write_authorize_cb_t) (BLECharacteristic&amp; chr, ble_gatts_evt_write_t* request);
typedef void (*write_cb_t)           (BLECharacteristic&amp; chr, uint8_t* data, uint16_t len, uint16_t offset);
typedef void (*write_cccd_cb_t)      (BLECharacteristic&amp; chr, uint16_t value);

BLEUuid uuid;

// Constructors
BLECharacteristic(void);
BLECharacteristic(BLEUuid bleuuid);

// Destructor
virtual ~BLECharacteristic();

BLEService&amp; parentService(void);

void setTempMemory(void);

/*------------- Configure -------------*/
void setUuid(BLEUuid bleuuid);
void setProperties(uint8_t prop);
void setPermission(BleSecurityMode read_perm, BleSecurityMode write_perm);
void setMaxLen(uint16_t max_len);
void setFixedLen(uint16_t fixed_len);

/*------------- Descriptors -------------*/
void setUserDescriptor(const char* descriptor); // aka user descriptor
void setReportRefDescriptor(uint8_t id, uint8_t type); // TODO refactor to use addDescriptor()
void setPresentationFormatDescriptor(uint8_t type, int8_t exponent, uint16_t unit, uint8_t name_space = 1, uint16_t descritpor = 0);

/*------------- Callbacks -------------*/
void setWriteCallback        (write_cb_t fp);
void setCccdWriteCallback    (write_cccd_cb_t fp);
void setReadAuthorizeCallback(read_authorize_cb_t fp);
void setWriteAuthorizeCallbak(write_authorize_cb_t fp);

virtual err_t begin(void);

// Add Descriptor function must be called right after begin()
err_t addDescriptor(BLEUuid bleuuid, void const * content, uint16_t len, BleSecurityMode read_perm = SECMODE_OPEN, BleSecurityMode write_perm = SECMODE_NO_ACCESS);

ble_gatts_char_handles_t handles(void);

/*------------- Write -------------*/
uint16_t write(const void* data, uint16_t len);
uint16_t write(const char* str);

uint16_t write8    (uint8_t  num);
uint16_t write16   (uint16_t num);
uint16_t write32   (uint32_t num);
uint16_t write32   (int      num);


/*------------- Read -------------*/
uint16_t read(void* buffer, uint16_t bufsize);

uint8_t  read8 (void);
uint16_t read16(void);
uint32_t read32(void);

/*------------- Notify -------------*/
uint16_t getCccd(void);

bool notifyEnabled(void);

bool notify(const void* data, uint16_t len);
bool notify(const char* str);

bool notify8    (uint8_t  num);
bool notify16   (uint16_t num);
bool notify32   (uint32_t num);
bool notify32   (int      num);

/*------------- Indicate -------------*/
bool indicateEnabled(void);

bool indicate(const void* data, uint16_t len);
bool indicate(const char* str);

bool indicate8    (uint8_t  num);
bool indicate16   (uint16_t num);
bool indicate32   (uint32_t num);
bool indicate32   (int      num);
</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="com">/*--------- Callback Signatures ----------*/</span></li><li class="L1"><span class="kwd">typedef</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> </span><span class="pun">(*</span><span class="typ">read_authorize_cb_t</span><span class="pun">)</span><span class="pln">  </span><span class="pun">(</span><span class="typ">BLECharacteristic</span><span class="pun">&amp;</span><span class="pln"> chr</span><span class="pun">,</span><span class="pln"> </span><span class="typ">ble_gatts_evt_read_t</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> request</span><span class="pun">);</span></li><li class="L2"><span class="kwd">typedef</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> </span><span class="pun">(*</span><span class="typ">write_authorize_cb_t</span><span class="pun">)</span><span class="pln"> </span><span class="pun">(</span><span class="typ">BLECharacteristic</span><span class="pun">&amp;</span><span class="pln"> chr</span><span class="pun">,</span><span class="pln"> </span><span class="typ">ble_gatts_evt_write_t</span><span class="pun">*</span><span class="pln"> request</span><span class="pun">);</span></li><li class="L3"><span class="kwd">typedef</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> </span><span class="pun">(*</span><span class="typ">write_cb_t</span><span class="pun">)</span><span class="pln">           </span><span class="pun">(</span><span class="typ">BLECharacteristic</span><span class="pun">&amp;</span><span class="pln"> chr</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pun">*</span><span class="pln"> data</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint16_t</span><span class="pln"> len</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint16_t</span><span class="pln"> offset</span><span class="pun">);</span></li><li class="L4"><span class="kwd">typedef</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> </span><span class="pun">(*</span><span class="typ">write_cccd_cb_t</span><span class="pun">)</span><span class="pln">      </span><span class="pun">(</span><span class="typ">BLECharacteristic</span><span class="pun">&amp;</span><span class="pln"> chr</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint16_t</span><span class="pln"> </span><span class="kwd">value</span><span class="pun">);</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="typ">BLEUuid</span><span class="pln"> uuid</span><span class="pun">;</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="com">// Constructors</span></li><li class="L9"><span class="typ">BLECharacteristic</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L0"><span class="typ">BLECharacteristic</span><span class="pun">(</span><span class="typ">BLEUuid</span><span class="pln"> bleuuid</span><span class="pun">);</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="com">// Destructor</span></li><li class="L3"><span class="kwd">virtual</span><span class="pln"> </span><span class="pun">~</span><span class="typ">BLECharacteristic</span><span class="pun">();</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="typ">BLEService</span><span class="pun">&amp;</span><span class="pln"> parentService</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="kwd">void</span><span class="pln"> setTempMemory</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="com">/*------------- Configure -------------*/</span></li><li class="L0"><span class="kwd">void</span><span class="pln"> setUuid</span><span class="pun">(</span><span class="typ">BLEUuid</span><span class="pln"> bleuuid</span><span class="pun">);</span></li><li class="L1"><span class="kwd">void</span><span class="pln"> setProperties</span><span class="pun">(</span><span class="typ">uint8_t</span><span class="pln"> prop</span><span class="pun">);</span></li><li class="L2"><span class="kwd">void</span><span class="pln"> setPermission</span><span class="pun">(</span><span class="typ">BleSecurityMode</span><span class="pln"> read_perm</span><span class="pun">,</span><span class="pln"> </span><span class="typ">BleSecurityMode</span><span class="pln"> write_perm</span><span class="pun">);</span></li><li class="L3"><span class="kwd">void</span><span class="pln"> setMaxLen</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> max_len</span><span class="pun">);</span></li><li class="L4"><span class="kwd">void</span><span class="pln"> setFixedLen</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> fixed_len</span><span class="pun">);</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="com">/*------------- Descriptors -------------*/</span></li><li class="L7"><span class="kwd">void</span><span class="pln"> setUserDescriptor</span><span class="pun">(</span><span class="kwd">const</span><span class="pln"> </span><span class="kwd">char</span><span class="pun">*</span><span class="pln"> descriptor</span><span class="pun">);</span><span class="pln"> </span><span class="com">// aka user descriptor</span></li><li class="L8"><span class="kwd">void</span><span class="pln"> setReportRefDescriptor</span><span class="pun">(</span><span class="typ">uint8_t</span><span class="pln"> id</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pln"> type</span><span class="pun">);</span><span class="pln"> </span><span class="com">// TODO refactor to use addDescriptor()</span></li><li class="L9"><span class="kwd">void</span><span class="pln"> setPresentationFormatDescriptor</span><span class="pun">(</span><span class="typ">uint8_t</span><span class="pln"> type</span><span class="pun">,</span><span class="pln"> </span><span class="typ">int8_t</span><span class="pln"> exponent</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint16_t</span><span class="pln"> unit</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pln"> name_space </span><span class="pun">=</span><span class="pln"> </span><span class="lit">1</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint16_t</span><span class="pln"> descritpor </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">);</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="com">/*------------- Callbacks -------------*/</span></li><li class="L2"><span class="kwd">void</span><span class="pln"> setWriteCallback        </span><span class="pun">(</span><span class="typ">write_cb_t</span><span class="pln"> fp</span><span class="pun">);</span></li><li class="L3"><span class="kwd">void</span><span class="pln"> setCccdWriteCallback    </span><span class="pun">(</span><span class="typ">write_cccd_cb_t</span><span class="pln"> fp</span><span class="pun">);</span></li><li class="L4"><span class="kwd">void</span><span class="pln"> setReadAuthorizeCallback</span><span class="pun">(</span><span class="typ">read_authorize_cb_t</span><span class="pln"> fp</span><span class="pun">);</span></li><li class="L5"><span class="kwd">void</span><span class="pln"> setWriteAuthorizeCallbak</span><span class="pun">(</span><span class="typ">write_authorize_cb_t</span><span class="pln"> fp</span><span class="pun">);</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="kwd">virtual</span><span class="pln"> </span><span class="typ">err_t</span><span class="pln"> </span><span class="kwd">begin</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="com">// Add Descriptor function must be called right after begin()</span></li><li class="L0"><span class="typ">err_t</span><span class="pln"> addDescriptor</span><span class="pun">(</span><span class="typ">BLEUuid</span><span class="pln"> bleuuid</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> </span><span class="kwd">const</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> content</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint16_t</span><span class="pln"> len</span><span class="pun">,</span><span class="pln"> </span><span class="typ">BleSecurityMode</span><span class="pln"> read_perm </span><span class="pun">=</span><span class="pln"> SECMODE_OPEN</span><span class="pun">,</span><span class="pln"> </span><span class="typ">BleSecurityMode</span><span class="pln"> write_perm </span><span class="pun">=</span><span class="pln"> SECMODE_NO_ACCESS</span><span class="pun">);</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="typ">ble_gatts_char_handles_t</span><span class="pln"> handles</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="com">/*------------- Write -------------*/</span></li><li class="L5"><span class="typ">uint16_t</span><span class="pln"> write</span><span class="pun">(</span><span class="kwd">const</span><span class="pln"> </span><span class="kwd">void</span><span class="pun">*</span><span class="pln"> data</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint16_t</span><span class="pln"> len</span><span class="pun">);</span></li><li class="L6"><span class="typ">uint16_t</span><span class="pln"> write</span><span class="pun">(</span><span class="kwd">const</span><span class="pln"> </span><span class="kwd">char</span><span class="pun">*</span><span class="pln"> str</span><span class="pun">);</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="typ">uint16_t</span><span class="pln"> write8    </span><span class="pun">(</span><span class="typ">uint8_t</span><span class="pln">  num</span><span class="pun">);</span></li><li class="L9"><span class="typ">uint16_t</span><span class="pln"> write16   </span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> num</span><span class="pun">);</span></li><li class="L0"><span class="typ">uint16_t</span><span class="pln"> write32   </span><span class="pun">(</span><span class="typ">uint32_t</span><span class="pln"> num</span><span class="pun">);</span></li><li class="L1"><span class="typ">uint16_t</span><span class="pln"> write32   </span><span class="pun">(</span><span class="kwd">int</span><span class="pln">      num</span><span class="pun">);</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="com">/*------------- Read -------------*/</span></li><li class="L5"><span class="typ">uint16_t</span><span class="pln"> read</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">*</span><span class="pln"> buffer</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint16_t</span><span class="pln"> bufsize</span><span class="pun">);</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="typ">uint8_t</span><span class="pln">  read8 </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L8"><span class="typ">uint16_t</span><span class="pln"> read16</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L9"><span class="typ">uint32_t</span><span class="pln"> read32</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="com">/*------------- Notify -------------*/</span></li><li class="L2"><span class="typ">uint16_t</span><span class="pln"> getCccd</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="kwd">bool</span><span class="pln"> notifyEnabled</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="kwd">bool</span><span class="pln"> notify</span><span class="pun">(</span><span class="kwd">const</span><span class="pln"> </span><span class="kwd">void</span><span class="pun">*</span><span class="pln"> data</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint16_t</span><span class="pln"> len</span><span class="pun">);</span></li><li class="L7"><span class="kwd">bool</span><span class="pln"> notify</span><span class="pun">(</span><span class="kwd">const</span><span class="pln"> </span><span class="kwd">char</span><span class="pun">*</span><span class="pln"> str</span><span class="pun">);</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="kwd">bool</span><span class="pln"> notify8    </span><span class="pun">(</span><span class="typ">uint8_t</span><span class="pln">  num</span><span class="pun">);</span></li><li class="L0"><span class="kwd">bool</span><span class="pln"> notify16   </span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> num</span><span class="pun">);</span></li><li class="L1"><span class="kwd">bool</span><span class="pln"> notify32   </span><span class="pun">(</span><span class="typ">uint32_t</span><span class="pln"> num</span><span class="pun">);</span></li><li class="L2"><span class="kwd">bool</span><span class="pln"> notify32   </span><span class="pun">(</span><span class="kwd">int</span><span class="pln">      num</span><span class="pun">);</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="com">/*------------- Indicate -------------*/</span></li><li class="L5"><span class="kwd">bool</span><span class="pln"> indicateEnabled</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="kwd">bool</span><span class="pln"> indicate</span><span class="pun">(</span><span class="kwd">const</span><span class="pln"> </span><span class="kwd">void</span><span class="pun">*</span><span class="pln"> data</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint16_t</span><span class="pln"> len</span><span class="pun">);</span></li><li class="L8"><span class="kwd">bool</span><span class="pln"> indicate</span><span class="pun">(</span><span class="kwd">const</span><span class="pln"> </span><span class="kwd">char</span><span class="pun">*</span><span class="pln"> str</span><span class="pun">);</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="kwd">bool</span><span class="pln"> indicate8    </span><span class="pun">(</span><span class="typ">uint8_t</span><span class="pln">  num</span><span class="pun">);</span></li><li class="L1"><span class="kwd">bool</span><span class="pln"> indicate16   </span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> num</span><span class="pun">);</span></li><li class="L2"><span class="kwd">bool</span><span class="pln"> indicate32   </span><span class="pun">(</span><span class="typ">uint32_t</span><span class="pln"> num</span><span class="pun">);</span></li><li class="L3"><span class="kwd">bool</span><span class="pln"> indicate32   </span><span class="pun">(</span><span class="kwd">int</span><span class="pln">      num</span><span class="pun">);</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#example-24-12" class="anchor-link"><span class="fa fa-link"></span></a><span id="example-24-12" class="anchor-link-target"></span><span id="example" class="anchor-link-target"></span>Example</h1>
<p>The following example configures an instance of the Heart Rate Monitor (HRM) Service and it's related characteristics:</p>
</div>
<div class="element element element element element element row-fluid build-alert alert-info">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
Note that this example code is incomplete. For the full example open the 'custom_hrm' example that is part of the nRF52 BSP! The code below is for illustration purposes only.
</div>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/8811/elements/2860747/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">/* HRM Service Definitions
 * Heart Rate Monitor Service:  0x180D
 * Heart Rate Measurement Char: 0x2A37
 * Body Sensor Location Char:   0x2A38
 */
BLEService        hrms = BLEService(UUID16_SVC_HEART_RATE);
BLECharacteristic hrmc = BLECharacteristic(UUID16_CHR_HEART_RATE_MEASUREMENT);
BLECharacteristic bslc = BLECharacteristic(UUID16_CHR_BODY_SENSOR_LOCATION);

void setupHRM(void)
{
  // Configure the Heart Rate Monitor service
  // See: https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.service.heart_rate.xml
  // Supported Characteristics:
  // Name                         UUID    Requirement Properties
  // ---------------------------- ------  ----------- ----------
  // Heart Rate Measurement       0x2A37  Mandatory   Notify
  // Body Sensor Location         0x2A38  Optional    Read
  // Heart Rate Control Point     0x2A39  Conditional Write       &lt;-- Not used here
  hrms.begin();

  // Note: You must call .begin() on the BLEService before calling .begin() on
  // any characteristic(s) within that service definition.. Calling .begin() on
  // a BLECharacteristic will cause it to be added to the last BLEService that
  // was 'begin()'ed!

  // Configure the Heart Rate Measurement characteristic
  // See: https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.characteristic.heart_rate_measurement.xml
  // Permission = Notify
  // Min Len    = 1
  // Max Len    = 8
  //    B0      = UINT8  - Flag (MANDATORY)
  //      b5:7  = Reserved
  //      b4    = RR-Internal (0 = Not present, 1 = Present)
  //      b3    = Energy expended status (0 = Not present, 1 = Present)
  //      b1:2  = Sensor contact status (0+1 = Not supported, 2 = Supported but contact not detected, 3 = Supported and detected)
  //      b0    = Value format (0 = UINT8, 1 = UINT16)
  //    B1      = UINT8  - 8-bit heart rate measurement value in BPM
  //    B2:3    = UINT16 - 16-bit heart rate measurement value in BPM
  //    B4:5    = UINT16 - Energy expended in joules
  //    B6:7    = UINT16 - RR Internal (1/1024 second resolution)
  hrmc.setProperties(CHR_PROPS_NOTIFY);
  hrmc.setPermission(SECMODE_OPEN, SECMODE_NO_ACCESS);
  hrmc.setFixedLen(2);
  hrmc.setCccdWriteCallback(cccd_callback);  // Optionally capture CCCD updates
  hrmc.begin();
  uint8_t hrmdata[2] = { 0b00000110, 0x40 }; // Set the characteristic to use 8-bit values, with the sensor connected and detected
  hrmc.notify(hrmdata, 2);                   // Use .notify instead of .write!

  // Configure the Body Sensor Location characteristic
  // See: https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.characteristic.body_sensor_location.xml
  // Permission = Read
  // Min Len    = 1
  // Max Len    = 1
  //    B0      = UINT8 - Body Sensor Location
  //      0     = Other
  //      1     = Chest
  //      2     = Wrist
  //      3     = Finger
  //      4     = Hand
  //      5     = Ear Lobe
  //      6     = Foot
  //      7:255 = Reserved
  bslc.setProperties(CHR_PROPS_READ);
  bslc.setPermission(SECMODE_OPEN, SECMODE_NO_ACCESS);
  bslc.setFixedLen(1);
  bslc.begin();
  bslc.write8(2);    // Set the characteristic to 'Wrist' (2)
}

void cccd_callback(BLECharacteristic&amp; chr, uint16_t cccd_value)
{
    // Display the raw request packet
    Serial.print("CCCD Updated: ");
    //Serial.printBuffer(request-&gt;data, request-&gt;len);
    Serial.print(cccd_value);
    Serial.println("");

    // Check the characteristic this CCCD update is associated with in case
    // this handler is used for multiple CCCD records.
    if (chr.uuid == hrmc.uuid) {
        if (chr.notifyEnabled()) {
            Serial.println("Heart Rate Measurement 'Notify' enabled");
        } else {
            Serial.println("Heart Rate Measurement 'Notify' disabled");
        }
    }
}</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="com">/* HRM Service Definitions</span></li><li class="L1"><span class="com"> * Heart Rate Monitor Service:  0x180D</span></li><li class="L2"><span class="com"> * Heart Rate Measurement Char: 0x2A37</span></li><li class="L3"><span class="com"> * Body Sensor Location Char:   0x2A38</span></li><li class="L4"><span class="com"> */</span></li><li class="L5"><span class="typ">BLEService</span><span class="pln">        hrms </span><span class="pun">=</span><span class="pln"> </span><span class="typ">BLEService</span><span class="pun">(</span><span class="pln">UUID16_SVC_HEART_RATE</span><span class="pun">);</span></li><li class="L6"><span class="typ">BLECharacteristic</span><span class="pln"> hrmc </span><span class="pun">=</span><span class="pln"> </span><span class="typ">BLECharacteristic</span><span class="pun">(</span><span class="pln">UUID16_CHR_HEART_RATE_MEASUREMENT</span><span class="pun">);</span></li><li class="L7"><span class="typ">BLECharacteristic</span><span class="pln"> bslc </span><span class="pun">=</span><span class="pln"> </span><span class="typ">BLECharacteristic</span><span class="pun">(</span><span class="pln">UUID16_CHR_BODY_SENSOR_LOCATION</span><span class="pun">);</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="kwd">void</span><span class="pln"> setupHRM</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span></li><li class="L0"><span class="pun">{</span></li><li class="L1"><span class="pln">  </span><span class="com">// Configure the Heart Rate Monitor service</span></li><li class="L2"><span class="pln">  </span><span class="com">// See: https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.service.heart_rate.xml</span></li><li class="L3"><span class="pln">  </span><span class="com">// Supported Characteristics:</span></li><li class="L4"><span class="pln">  </span><span class="com">// Name                         UUID    Requirement Properties</span></li><li class="L5"><span class="pln">  </span><span class="com">// ---------------------------- ------  ----------- ----------</span></li><li class="L6"><span class="pln">  </span><span class="com">// Heart Rate Measurement       0x2A37  Mandatory   Notify</span></li><li class="L7"><span class="pln">  </span><span class="com">// Body Sensor Location         0x2A38  Optional    Read</span></li><li class="L8"><span class="pln">  </span><span class="com">// Heart Rate Control Point     0x2A39  Conditional Write       &lt;-- Not used here</span></li><li class="L9"><span class="pln">  hrms</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">  </span><span class="com">// Note: You must call .begin() on the BLEService before calling .begin() on</span></li><li class="L2"><span class="pln">  </span><span class="com">// any characteristic(s) within that service definition.. Calling .begin() on</span></li><li class="L3"><span class="pln">  </span><span class="com">// a BLECharacteristic will cause it to be added to the last BLEService that</span></li><li class="L4"><span class="pln">  </span><span class="com">// was 'begin()'ed!</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">  </span><span class="com">// Configure the Heart Rate Measurement characteristic</span></li><li class="L7"><span class="pln">  </span><span class="com">// See: https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.characteristic.heart_rate_measurement.xml</span></li><li class="L8"><span class="pln">  </span><span class="com">// Permission = Notify</span></li><li class="L9"><span class="pln">  </span><span class="com">// Min Len    = 1</span></li><li class="L0"><span class="pln">  </span><span class="com">// Max Len    = 8</span></li><li class="L1"><span class="pln">  </span><span class="com">//    B0      = UINT8  - Flag (MANDATORY)</span></li><li class="L2"><span class="pln">  </span><span class="com">//      b5:7  = Reserved</span></li><li class="L3"><span class="pln">  </span><span class="com">//      b4    = RR-Internal (0 = Not present, 1 = Present)</span></li><li class="L4"><span class="pln">  </span><span class="com">//      b3    = Energy expended status (0 = Not present, 1 = Present)</span></li><li class="L5"><span class="pln">  </span><span class="com">//      b1:2  = Sensor contact status (0+1 = Not supported, 2 = Supported but contact not detected, 3 = Supported and detected)</span></li><li class="L6"><span class="pln">  </span><span class="com">//      b0    = Value format (0 = UINT8, 1 = UINT16)</span></li><li class="L7"><span class="pln">  </span><span class="com">//    B1      = UINT8  - 8-bit heart rate measurement value in BPM</span></li><li class="L8"><span class="pln">  </span><span class="com">//    B2:3    = UINT16 - 16-bit heart rate measurement value in BPM</span></li><li class="L9"><span class="pln">  </span><span class="com">//    B4:5    = UINT16 - Energy expended in joules</span></li><li class="L0"><span class="pln">  </span><span class="com">//    B6:7    = UINT16 - RR Internal (1/1024 second resolution)</span></li><li class="L1"><span class="pln">  hrmc</span><span class="pun">.</span><span class="pln">setProperties</span><span class="pun">(</span><span class="pln">CHR_PROPS_NOTIFY</span><span class="pun">);</span></li><li class="L2"><span class="pln">  hrmc</span><span class="pun">.</span><span class="pln">setPermission</span><span class="pun">(</span><span class="pln">SECMODE_OPEN</span><span class="pun">,</span><span class="pln"> SECMODE_NO_ACCESS</span><span class="pun">);</span></li><li class="L3"><span class="pln">  hrmc</span><span class="pun">.</span><span class="pln">setFixedLen</span><span class="pun">(</span><span class="lit">2</span><span class="pun">);</span></li><li class="L4"><span class="pln">  hrmc</span><span class="pun">.</span><span class="pln">setCccdWriteCallback</span><span class="pun">(</span><span class="pln">cccd_callback</span><span class="pun">);</span><span class="pln">  </span><span class="com">// Optionally capture CCCD updates</span></li><li class="L5"><span class="pln">  hrmc</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L6"><span class="pln">  </span><span class="typ">uint8_t</span><span class="pln"> hrmdata</span><span class="pun">[</span><span class="lit">2</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="lit">0b00000110</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x40</span><span class="pln"> </span><span class="pun">};</span><span class="pln"> </span><span class="com">// Set the characteristic to use 8-bit values, with the sensor connected and detected</span></li><li class="L7"><span class="pln">  hrmc</span><span class="pun">.</span><span class="pln">notify</span><span class="pun">(</span><span class="pln">hrmdata</span><span class="pun">,</span><span class="pln"> </span><span class="lit">2</span><span class="pun">);</span><span class="pln">                   </span><span class="com">// Use .notify instead of .write!</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="pln">  </span><span class="com">// Configure the Body Sensor Location characteristic</span></li><li class="L0"><span class="pln">  </span><span class="com">// See: https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.characteristic.body_sensor_location.xml</span></li><li class="L1"><span class="pln">  </span><span class="com">// Permission = Read</span></li><li class="L2"><span class="pln">  </span><span class="com">// Min Len    = 1</span></li><li class="L3"><span class="pln">  </span><span class="com">// Max Len    = 1</span></li><li class="L4"><span class="pln">  </span><span class="com">//    B0      = UINT8 - Body Sensor Location</span></li><li class="L5"><span class="pln">  </span><span class="com">//      0     = Other</span></li><li class="L6"><span class="pln">  </span><span class="com">//      1     = Chest</span></li><li class="L7"><span class="pln">  </span><span class="com">//      2     = Wrist</span></li><li class="L8"><span class="pln">  </span><span class="com">//      3     = Finger</span></li><li class="L9"><span class="pln">  </span><span class="com">//      4     = Hand</span></li><li class="L0"><span class="pln">  </span><span class="com">//      5     = Ear Lobe</span></li><li class="L1"><span class="pln">  </span><span class="com">//      6     = Foot</span></li><li class="L2"><span class="pln">  </span><span class="com">//      7:255 = Reserved</span></li><li class="L3"><span class="pln">  bslc</span><span class="pun">.</span><span class="pln">setProperties</span><span class="pun">(</span><span class="pln">CHR_PROPS_READ</span><span class="pun">);</span></li><li class="L4"><span class="pln">  bslc</span><span class="pun">.</span><span class="pln">setPermission</span><span class="pun">(</span><span class="pln">SECMODE_OPEN</span><span class="pun">,</span><span class="pln"> SECMODE_NO_ACCESS</span><span class="pun">);</span></li><li class="L5"><span class="pln">  bslc</span><span class="pun">.</span><span class="pln">setFixedLen</span><span class="pun">(</span><span class="lit">1</span><span class="pun">);</span></li><li class="L6"><span class="pln">  bslc</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L7"><span class="pln">  bslc</span><span class="pun">.</span><span class="pln">write8</span><span class="pun">(</span><span class="lit">2</span><span class="pun">);</span><span class="pln">    </span><span class="com">// Set the characteristic to 'Wrist' (2)</span></li><li class="L8"><span class="pun">}</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="kwd">void</span><span class="pln"> cccd_callback</span><span class="pun">(</span><span class="typ">BLECharacteristic</span><span class="pun">&amp;</span><span class="pln"> chr</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint16_t</span><span class="pln"> cccd_value</span><span class="pun">)</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="pln">    </span><span class="com">// Display the raw request packet</span></li><li class="L3"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"CCCD Updated: "</span><span class="pun">);</span></li><li class="L4"><span class="pln">    </span><span class="com">//Serial.printBuffer(request-&gt;data, request-&gt;len);</span></li><li class="L5"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="pln">cccd_value</span><span class="pun">);</span></li><li class="L6"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">""</span><span class="pun">);</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">    </span><span class="com">// Check the characteristic this CCCD update is associated with in case</span></li><li class="L9"><span class="pln">    </span><span class="com">// this handler is used for multiple CCCD records.</span></li><li class="L0"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">chr</span><span class="pun">.</span><span class="pln">uuid </span><span class="pun">==</span><span class="pln"> hrmc</span><span class="pun">.</span><span class="pln">uuid</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L1"><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">chr</span><span class="pun">.</span><span class="pln">notifyEnabled</span><span class="pun">())</span><span class="pln"> </span><span class="pun">{</span></li><li class="L2"><span class="pln">            </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Heart Rate Measurement 'Notify' enabled"</span><span class="pun">);</span></li><li class="L3"><span class="pln">        </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span></li><li class="L4"><span class="pln">            </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Heart Rate Measurement 'Notify' disabled"</span><span class="pun">);</span></li><li class="L5"><span class="pln">        </span><span class="pun">}</span></li><li class="L6"><span class="pln">    </span><span class="pun">}</span></li><li class="L7"><span class="pun">}</span></li></ol></pre>
</div>
</div>
</div>
<div class="page-title-wrapper">
<h1 class="headline">
<span id="bleclientservice">BLEClientService</span>
</h1>

</div>
<div class="page-content all-page-view-content">
<div class="">
<div class="element row-fluid build-alert">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
The Bluefruit nRF52 BSP codebase is undergoing active development based on customer feedback and testing. As such, the class documentation here is incomplete, and you should consult the Github repo for the latest code and API developments: <a href="https://goo.gl/LdEx62">https://goo.gl/LdEx62</a>
</div>
</div>
<div class="row-fluid build-text">
<p>This base class is used when defining custom BLE Gatt Clients.</p>
<p>Unless you are implementing a custom GATT client service and characteristic, you normally won't use this base class directly, and would instantiate and call a higher level helper service or characteristic included in the Bluefruit nRF52 API.</p>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#basic-usage-25-3" class="anchor-link"><span class="fa fa-link"></span></a><span id="basic-usage-25-3" class="anchor-link-target"></span><span id="basic-usage" class="anchor-link-target"></span>Basic Usage</h1>
<p>There are normally only threes operations required to use the BLEClientService class:</p>
<p>1.) You need to declare and instantiate the class with an appropriate 16-bit or 128-bit UUID in the constructor:</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/11217/elements/2979003/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">BLEClientService myService = BLEService(0x1234);</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="typ">BLEClientService</span><span class="pln"> myService </span><span class="pun">=</span><span class="pln"> </span><span class="typ">BLEService</span><span class="pun">(</span><span class="lit">0x1234</span><span class="pun">);</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<p>2.) You then need to call the&nbsp;<strong>.begin()</strong>&nbsp;method on the instance before adding any BLEClientCharacteristics to it (via the BLEClientCharacteristic's respective <strong>.begin()</strong> function call):</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/11217/elements/2979005/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">myService.begin();</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="pln">myService</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<p>3) When connected e.g in connect callback, you should call <strong>.discover()</strong>&nbsp;to discover the service</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/11217/elements/2979478/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">myService.discover();</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="pln">myService</span><span class="pun">.</span><span class="pln">discover</span><span class="pun">();</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#api-25-9" class="anchor-link"><span class="fa fa-link"></span></a><span id="api-25-9" class="anchor-link-target"></span><span id="api" class="anchor-link-target"></span>API</h1>
<p>BLEClientService has the following overall class structure:</p>
</div>
<div class="element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element row-fluid build-alert alert-info">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
This documentation may be slightly out of date as bugs are fixed, and the API develops. You should always consult the Github repo for the definitive latest code release and class definitions!

</div>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/11217/elements/2979009/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">BLEUuid uuid;

// Constructors
BLEClientService(void);
BLEClientService(BLEUuid bleuuid);

virtual bool     begin(void);

virtual bool     discover  (uint16_t conn_handle);
        bool     discovered(void);

        uint16_t connHandle(void);

        void             setHandleRange(ble_gattc_handle_range_t handle_range);
ble_gattc_handle_range_t getHandleRange(void);</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="typ">BLEUuid</span><span class="pln"> uuid</span><span class="pun">;</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="com">// Constructors</span></li><li class="L3"><span class="typ">BLEClientService</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L4"><span class="typ">BLEClientService</span><span class="pun">(</span><span class="typ">BLEUuid</span><span class="pln"> bleuuid</span><span class="pun">);</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="kwd">virtual</span><span class="pln"> </span><span class="kwd">bool</span><span class="pln">     </span><span class="kwd">begin</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="kwd">virtual</span><span class="pln"> </span><span class="kwd">bool</span><span class="pln">     discover  </span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> conn_handle</span><span class="pun">);</span></li><li class="L9"><span class="pln">        </span><span class="kwd">bool</span><span class="pln">     discovered</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">        </span><span class="typ">uint16_t</span><span class="pln"> connHandle</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="pln">        </span><span class="kwd">void</span><span class="pln">             setHandleRange</span><span class="pun">(</span><span class="typ">ble_gattc_handle_range_t</span><span class="pln"> handle_range</span><span class="pun">);</span></li><li class="L4"><span class="typ">ble_gattc_handle_range_t</span><span class="pln"> getHandleRange</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#example-25-12" class="anchor-link"><span class="fa fa-link"></span></a><span id="example-25-12" class="anchor-link-target"></span><span id="example" class="anchor-link-target"></span>Example</h1>
<p>The following example declares a HRM (Heart Rate Monitor) service, and assigns some characteristics to it:</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/11217/elements/2979480/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">/*********************************************************************
 This is an example for our nRF52 based Bluefruit LE modules

 Pick one up today in the adafruit shop!

 Adafruit invests time and resources providing this open source code,
 please support Adafruit and open-source hardware by purchasing
 products from Adafruit!

 MIT license, check LICENSE for more information
 All text above, and the splash screen below must be included in
 any redistribution
*********************************************************************/

/* This sketch show how to use BLEClientService and BLEClientCharacteristic
 * to implement a custom client that is used to talk with Gatt server on
 * peripheral.
 *
 * Note: you will need another feather52 running peripheral/custom_HRM sketch
 * to test with.
 */

#include &lt;bluefruit.h&gt;

/* HRM Service Definitions
 * Heart Rate Monitor Service:  0x180D
 * Heart Rate Measurement Char: 0x2A37 (Mandatory)
 * Body Sensor Location Char:   0x2A38 (Optional)
 */

BLEClientService        hrms(UUID16_SVC_HEART_RATE);
BLEClientCharacteristic hrmc(UUID16_CHR_HEART_RATE_MEASUREMENT);
BLEClientCharacteristic bslc(UUID16_CHR_BODY_SENSOR_LOCATION);

void setup()
{
  Serial.begin(115200);

  Serial.println("Bluefruit52 Central Custom HRM Example");
  Serial.println("--------------------------------------\n");

  // Initialize Bluefruit with maximum connections as Peripheral = 0, Central = 1
  // SRAM usage required by SoftDevice will increase dramatically with number of connections
  Bluefruit.begin(0, 1);

  Bluefruit.setName("Bluefruit52 Central");

  // Initialize HRM client
  hrms.begin();

  // Initialize client characteristics of HRM.
  // Note: Client Char will be added to the last service that is begin()ed.
  bslc.begin();

  // set up callback for receiving measurement
  hrmc.setNotifyCallback(hrm_notify_callback);
  hrmc.begin();

  // Increase Blink rate to different from PrPh advertising mode
  Bluefruit.setConnLedInterval(250);

  // Callbacks for Central
  Bluefruit.Central.setDisconnectCallback(disconnect_callback);
  Bluefruit.Central.setConnectCallback(connect_callback);

  /* Start Central Scanning
   * - Enable auto scan if disconnected
   * - Interval = 100 ms, window = 80 ms
   * - Don't use active scan
   * - Filter only accept HRM service
   * - Start(timeout) with timeout = 0 will scan forever (until connected)
   */
  Bluefruit.Scanner.setRxCallback(scan_callback);
  Bluefruit.Scanner.restartOnDisconnect(true);
  Bluefruit.Scanner.setInterval(160, 80); // in unit of 0.625 ms
  Bluefruit.Scanner.filterUuid(hrms.uuid);
  Bluefruit.Scanner.useActiveScan(false);
  Bluefruit.Scanner.start(0);                   // // 0 = Don't stop scanning after n seconds
}

void loop()
{
  // do nothing
}

/**
 * Callback invoked when scanner pick up an advertising data
 * @param report Structural advertising data
 */
void scan_callback(ble_gap_evt_adv_report_t* report)
{
  // Connect to device with HRM service in advertising
  Bluefruit.Central.connect(report);
}

/**
 * Callback invoked when an connection is established
 * @param conn_handle
 */
void connect_callback(uint16_t conn_handle)
{
  Serial.println("Connected");
  Serial.print("Discovering HRM Service ... ");

  // If HRM is not found, disconnect and return
  if ( !hrms.discover(conn_handle) )
  {
    Serial.println("Found NONE");

    // disconect since we couldn't find HRM service
    Bluefruit.Central.disconnect(conn_handle);

    return;
  }

  // Once HRM service is found, we continue to discover its characteristic
  Serial.println("Found it");

  
  Serial.print("Discovering Measurement characteristic ... ");
  if ( !hrmc.discover() )
  {
    // Measurement chr is mandatory, if it is not found (valid), then disconnect
    Serial.println("not found !!!");  
    Serial.println("Measurement characteristic is mandatory but not found");
    Bluefruit.Central.disconnect(conn_handle);
    return;
  }
  Serial.println("Found it");

  // Measurement is found, continue to look for option Body Sensor Location
  // https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.characteristic.body_sensor_location.xml
  // Body Sensor Location is optional, print out the location in text if present
  Serial.print("Discovering Body Sensor Location characteristic ... ");
  if ( bslc.discover() )
  {
    Serial.println("Found it");
    
    // Body sensor location value is 8 bit
    const char* body_str[] = { "Other", "Chest", "Wrist", "Finger", "Hand", "Ear Lobe", "Foot" };

    // Read 8-bit BSLC value from peripheral
    uint8_t loc_value = bslc.read8();
    
    Serial.print("Body Location Sensor: ");
    Serial.println(body_str[loc_value]);
  }else
  {
    Serial.println("Found NONE");
  }

  // Reaching here means we are ready to go, let's enable notification on measurement chr
  if ( hrmc.enableNotify() )
  {
    Serial.println("Ready to receive HRM Measurement value");
  }else
  {
    Serial.println("Couldn't enable notify for HRM Measurement. Increase DEBUG LEVEL for troubleshooting");
  }
}

/**
 * Callback invoked when a connection is dropped
 * @param conn_handle
 * @param reason
 */
void disconnect_callback(uint16_t conn_handle, uint8_t reason)
{
  (void) conn_handle;
  (void) reason;

  Serial.println("Disconnected");
}


/**
 * Hooked callback that triggered when a measurement value is sent from peripheral
 * @param chr   Pointer client characteristic that even occurred,
 *              in this example it should be hrmc
 * @param data  Pointer to received data
 * @param len   Length of received data
 */
void hrm_notify_callback(BLEClientCharacteristic* chr, uint8_t* data, uint16_t len)
{
  // https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.characteristic.heart_rate_measurement.xml
  // Measurement contains of control byte0 and measurement (8 or 16 bit) + optional field
  // if byte0's bit0 is 0 --&gt; measurement is 8 bit, otherwise 16 bit.

  Serial.print("HRM Measurement: ");

  if ( data[0] &amp; bit(0) )
  {
    uint16_t value;
    memcpy(&amp;value, data+1, 2);

    Serial.println(value);
  }
  else
  {
    Serial.println(data[1]);
  }
}
</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="com">/*********************************************************************</span></li><li class="L1"><span class="com"> This is an example for our nRF52 based Bluefruit LE modules</span></li><li class="L2"><span class="com">&nbsp;</span></li><li class="L3"><span class="com"> Pick one up today in the adafruit shop!</span></li><li class="L4"><span class="com">&nbsp;</span></li><li class="L5"><span class="com"> Adafruit invests time and resources providing this open source code,</span></li><li class="L6"><span class="com"> please support Adafruit and open-source hardware by purchasing</span></li><li class="L7"><span class="com"> products from Adafruit!</span></li><li class="L8"><span class="com">&nbsp;</span></li><li class="L9"><span class="com"> MIT license, check LICENSE for more information</span></li><li class="L0"><span class="com"> All text above, and the splash screen below must be included in</span></li><li class="L1"><span class="com"> any redistribution</span></li><li class="L2"><span class="com">*********************************************************************/</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="com">/* This sketch show how to use BLEClientService and BLEClientCharacteristic</span></li><li class="L5"><span class="com"> * to implement a custom client that is used to talk with Gatt server on</span></li><li class="L6"><span class="com"> * peripheral.</span></li><li class="L7"><span class="com"> *</span></li><li class="L8"><span class="com"> * Note: you will need another feather52 running peripheral/custom_HRM sketch</span></li><li class="L9"><span class="com"> * to test with.</span></li><li class="L0"><span class="com"> */</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;bluefruit.h&gt;</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="com">/* HRM Service Definitions</span></li><li class="L5"><span class="com"> * Heart Rate Monitor Service:  0x180D</span></li><li class="L6"><span class="com"> * Heart Rate Measurement Char: 0x2A37 (Mandatory)</span></li><li class="L7"><span class="com"> * Body Sensor Location Char:   0x2A38 (Optional)</span></li><li class="L8"><span class="com"> */</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="typ">BLEClientService</span><span class="pln">        hrms</span><span class="pun">(</span><span class="pln">UUID16_SVC_HEART_RATE</span><span class="pun">);</span></li><li class="L1"><span class="typ">BLEClientCharacteristic</span><span class="pln"> hrmc</span><span class="pun">(</span><span class="pln">UUID16_CHR_HEART_RATE_MEASUREMENT</span><span class="pun">);</span></li><li class="L2"><span class="typ">BLEClientCharacteristic</span><span class="pln"> bslc</span><span class="pun">(</span><span class="pln">UUID16_CHR_BODY_SENSOR_LOCATION</span><span class="pun">);</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="kwd">void</span><span class="pln"> setup</span><span class="pun">()</span></li><li class="L5"><span class="pun">{</span></li><li class="L6"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">(</span><span class="lit">115200</span><span class="pun">);</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Bluefruit52 Central Custom HRM Example"</span><span class="pun">);</span></li><li class="L9"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"--------------------------------------\n"</span><span class="pun">);</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">  </span><span class="com">// Initialize Bluefruit with maximum connections as Peripheral = 0, Central = 1</span></li><li class="L2"><span class="pln">  </span><span class="com">// SRAM usage required by SoftDevice will increase dramatically with number of connections</span></li><li class="L3"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">(</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">);</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="pln">setName</span><span class="pun">(</span><span class="str">"Bluefruit52 Central"</span><span class="pun">);</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="pln">  </span><span class="com">// Initialize HRM client</span></li><li class="L8"><span class="pln">  hrms</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="pln">  </span><span class="com">// Initialize client characteristics of HRM.</span></li><li class="L1"><span class="pln">  </span><span class="com">// Note: Client Char will be added to the last service that is begin()ed.</span></li><li class="L2"><span class="pln">  bslc</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln">  </span><span class="com">// set up callback for receiving measurement</span></li><li class="L5"><span class="pln">  hrmc</span><span class="pun">.</span><span class="pln">setNotifyCallback</span><span class="pun">(</span><span class="pln">hrm_notify_callback</span><span class="pun">);</span></li><li class="L6"><span class="pln">  hrmc</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">  </span><span class="com">// Increase Blink rate to different from PrPh advertising mode</span></li><li class="L9"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="pln">setConnLedInterval</span><span class="pun">(</span><span class="lit">250</span><span class="pun">);</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">  </span><span class="com">// Callbacks for Central</span></li><li class="L2"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Central</span><span class="pun">.</span><span class="pln">setDisconnectCallback</span><span class="pun">(</span><span class="pln">disconnect_callback</span><span class="pun">);</span></li><li class="L3"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Central</span><span class="pun">.</span><span class="pln">setConnectCallback</span><span class="pun">(</span><span class="pln">connect_callback</span><span class="pun">);</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">  </span><span class="com">/* Start Central Scanning</span></li><li class="L6"><span class="com">   * - Enable auto scan if disconnected</span></li><li class="L7"><span class="com">   * - Interval = 100 ms, window = 80 ms</span></li><li class="L8"><span class="com">   * - Don't use active scan</span></li><li class="L9"><span class="com">   * - Filter only accept HRM service</span></li><li class="L0"><span class="com">   * - Start(timeout) with timeout = 0 will scan forever (until connected)</span></li><li class="L1"><span class="com">   */</span></li><li class="L2"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Scanner</span><span class="pun">.</span><span class="pln">setRxCallback</span><span class="pun">(</span><span class="pln">scan_callback</span><span class="pun">);</span></li><li class="L3"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Scanner</span><span class="pun">.</span><span class="pln">restartOnDisconnect</span><span class="pun">(</span><span class="kwd">true</span><span class="pun">);</span></li><li class="L4"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Scanner</span><span class="pun">.</span><span class="pln">setInterval</span><span class="pun">(</span><span class="lit">160</span><span class="pun">,</span><span class="pln"> </span><span class="lit">80</span><span class="pun">);</span><span class="pln"> </span><span class="com">// in unit of 0.625 ms</span></li><li class="L5"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Scanner</span><span class="pun">.</span><span class="pln">filterUuid</span><span class="pun">(</span><span class="pln">hrms</span><span class="pun">.</span><span class="pln">uuid</span><span class="pun">);</span></li><li class="L6"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Scanner</span><span class="pun">.</span><span class="pln">useActiveScan</span><span class="pun">(</span><span class="kwd">false</span><span class="pun">);</span></li><li class="L7"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Scanner</span><span class="pun">.</span><span class="pln">start</span><span class="pun">(</span><span class="lit">0</span><span class="pun">);</span><span class="pln">                   </span><span class="com">// // 0 = Don't stop scanning after n seconds</span></li><li class="L8"><span class="pun">}</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="kwd">void</span><span class="pln"> loop</span><span class="pun">()</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="pln">  </span><span class="com">// do nothing</span></li><li class="L3"><span class="pun">}</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="com">/**</span></li><li class="L6"><span class="com"> * Callback invoked when scanner pick up an advertising data</span></li><li class="L7"><span class="com"> * @param report Structural advertising data</span></li><li class="L8"><span class="com"> */</span></li><li class="L9"><span class="kwd">void</span><span class="pln"> scan_callback</span><span class="pun">(</span><span class="typ">ble_gap_evt_adv_report_t</span><span class="pun">*</span><span class="pln"> report</span><span class="pun">)</span></li><li class="L0"><span class="pun">{</span></li><li class="L1"><span class="pln">  </span><span class="com">// Connect to device with HRM service in advertising</span></li><li class="L2"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Central</span><span class="pun">.</span><span class="pln">connect</span><span class="pun">(</span><span class="pln">report</span><span class="pun">);</span></li><li class="L3"><span class="pun">}</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="com">/**</span></li><li class="L6"><span class="com"> * Callback invoked when an connection is established</span></li><li class="L7"><span class="com"> * @param conn_handle</span></li><li class="L8"><span class="com"> */</span></li><li class="L9"><span class="kwd">void</span><span class="pln"> connect_callback</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> conn_handle</span><span class="pun">)</span></li><li class="L0"><span class="pun">{</span></li><li class="L1"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Connected"</span><span class="pun">);</span></li><li class="L2"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"Discovering HRM Service ... "</span><span class="pun">);</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln">  </span><span class="com">// If HRM is not found, disconnect and return</span></li><li class="L5"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln">hrms</span><span class="pun">.</span><span class="pln">discover</span><span class="pun">(</span><span class="pln">conn_handle</span><span class="pun">)</span><span class="pln"> </span><span class="pun">)</span></li><li class="L6"><span class="pln">  </span><span class="pun">{</span></li><li class="L7"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Found NONE"</span><span class="pun">);</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="pln">    </span><span class="com">// disconect since we couldn't find HRM service</span></li><li class="L0"><span class="pln">    </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Central</span><span class="pun">.</span><span class="pln">disconnect</span><span class="pun">(</span><span class="pln">conn_handle</span><span class="pun">);</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="pln">    </span><span class="kwd">return</span><span class="pun">;</span></li><li class="L3"><span class="pln">  </span><span class="pun">}</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">  </span><span class="com">// Once HRM service is found, we continue to discover its characteristic</span></li><li class="L6"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Found it"</span><span class="pun">);</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">  </span></li><li class="L9"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"Discovering Measurement characteristic ... "</span><span class="pun">);</span></li><li class="L0"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln">hrmc</span><span class="pun">.</span><span class="pln">discover</span><span class="pun">()</span><span class="pln"> </span><span class="pun">)</span></li><li class="L1"><span class="pln">  </span><span class="pun">{</span></li><li class="L2"><span class="pln">    </span><span class="com">// Measurement chr is mandatory, if it is not found (valid), then disconnect</span></li><li class="L3"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"not found !!!"</span><span class="pun">);</span><span class="pln">  </span></li><li class="L4"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Measurement characteristic is mandatory but not found"</span><span class="pun">);</span></li><li class="L5"><span class="pln">    </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Central</span><span class="pun">.</span><span class="pln">disconnect</span><span class="pun">(</span><span class="pln">conn_handle</span><span class="pun">);</span></li><li class="L6"><span class="pln">    </span><span class="kwd">return</span><span class="pun">;</span></li><li class="L7"><span class="pln">  </span><span class="pun">}</span></li><li class="L8"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Found it"</span><span class="pun">);</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="pln">  </span><span class="com">// Measurement is found, continue to look for option Body Sensor Location</span></li><li class="L1"><span class="pln">  </span><span class="com">// https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.characteristic.body_sensor_location.xml</span></li><li class="L2"><span class="pln">  </span><span class="com">// Body Sensor Location is optional, print out the location in text if present</span></li><li class="L3"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"Discovering Body Sensor Location characteristic ... "</span><span class="pun">);</span></li><li class="L4"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> bslc</span><span class="pun">.</span><span class="pln">discover</span><span class="pun">()</span><span class="pln"> </span><span class="pun">)</span></li><li class="L5"><span class="pln">  </span><span class="pun">{</span></li><li class="L6"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Found it"</span><span class="pun">);</span></li><li class="L7"><span class="pln">    </span></li><li class="L8"><span class="pln">    </span><span class="com">// Body sensor location value is 8 bit</span></li><li class="L9"><span class="pln">    </span><span class="kwd">const</span><span class="pln"> </span><span class="kwd">char</span><span class="pun">*</span><span class="pln"> body_str</span><span class="pun">[]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="str">"Other"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"Chest"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"Wrist"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"Finger"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"Hand"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"Ear Lobe"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"Foot"</span><span class="pln"> </span><span class="pun">};</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">    </span><span class="com">// Read 8-bit BSLC value from peripheral</span></li><li class="L2"><span class="pln">    </span><span class="typ">uint8_t</span><span class="pln"> loc_value </span><span class="pun">=</span><span class="pln"> bslc</span><span class="pun">.</span><span class="pln">read8</span><span class="pun">();</span></li><li class="L3"><span class="pln">    </span></li><li class="L4"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"Body Location Sensor: "</span><span class="pun">);</span></li><li class="L5"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="pln">body_str</span><span class="pun">[</span><span class="pln">loc_value</span><span class="pun">]);</span></li><li class="L6"><span class="pln">  </span><span class="pun">}</span><span class="kwd">else</span></li><li class="L7"><span class="pln">  </span><span class="pun">{</span></li><li class="L8"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Found NONE"</span><span class="pun">);</span></li><li class="L9"><span class="pln">  </span><span class="pun">}</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">  </span><span class="com">// Reaching here means we are ready to go, let's enable notification on measurement chr</span></li><li class="L2"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> hrmc</span><span class="pun">.</span><span class="pln">enableNotify</span><span class="pun">()</span><span class="pln"> </span><span class="pun">)</span></li><li class="L3"><span class="pln">  </span><span class="pun">{</span></li><li class="L4"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Ready to receive HRM Measurement value"</span><span class="pun">);</span></li><li class="L5"><span class="pln">  </span><span class="pun">}</span><span class="kwd">else</span></li><li class="L6"><span class="pln">  </span><span class="pun">{</span></li><li class="L7"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Couldn't enable notify for HRM Measurement. Increase DEBUG LEVEL for troubleshooting"</span><span class="pun">);</span></li><li class="L8"><span class="pln">  </span><span class="pun">}</span></li><li class="L9"><span class="pun">}</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="com">/**</span></li><li class="L2"><span class="com"> * Callback invoked when a connection is dropped</span></li><li class="L3"><span class="com"> * @param conn_handle</span></li><li class="L4"><span class="com"> * @param reason</span></li><li class="L5"><span class="com"> */</span></li><li class="L6"><span class="kwd">void</span><span class="pln"> disconnect_callback</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> conn_handle</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pln"> reason</span><span class="pun">)</span></li><li class="L7"><span class="pun">{</span></li><li class="L8"><span class="pln">  </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span><span class="pln"> conn_handle</span><span class="pun">;</span></li><li class="L9"><span class="pln">  </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span><span class="pln"> reason</span><span class="pun">;</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Disconnected"</span><span class="pun">);</span></li><li class="L2"><span class="pun">}</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="com">/**</span></li><li class="L6"><span class="com"> * Hooked callback that triggered when a measurement value is sent from peripheral</span></li><li class="L7"><span class="com"> * @param chr   Pointer client characteristic that even occurred,</span></li><li class="L8"><span class="com"> *              in this example it should be hrmc</span></li><li class="L9"><span class="com"> * @param data  Pointer to received data</span></li><li class="L0"><span class="com"> * @param len   Length of received data</span></li><li class="L1"><span class="com"> */</span></li><li class="L2"><span class="kwd">void</span><span class="pln"> hrm_notify_callback</span><span class="pun">(</span><span class="typ">BLEClientCharacteristic</span><span class="pun">*</span><span class="pln"> chr</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pun">*</span><span class="pln"> data</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint16_t</span><span class="pln"> len</span><span class="pun">)</span></li><li class="L3"><span class="pun">{</span></li><li class="L4"><span class="pln">  </span><span class="com">// https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.characteristic.heart_rate_measurement.xml</span></li><li class="L5"><span class="pln">  </span><span class="com">// Measurement contains of control byte0 and measurement (8 or 16 bit) + optional field</span></li><li class="L6"><span class="pln">  </span><span class="com">// if byte0's bit0 is 0 --&gt; measurement is 8 bit, otherwise 16 bit.</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"HRM Measurement: "</span><span class="pun">);</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> data</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln"> bit</span><span class="pun">(</span><span class="lit">0</span><span class="pun">)</span><span class="pln"> </span><span class="pun">)</span></li><li class="L1"><span class="pln">  </span><span class="pun">{</span></li><li class="L2"><span class="pln">    </span><span class="typ">uint16_t</span><span class="pln"> </span><span class="kwd">value</span><span class="pun">;</span></li><li class="L3"><span class="pln">    memcpy</span><span class="pun">(&amp;</span><span class="kwd">value</span><span class="pun">,</span><span class="pln"> data</span><span class="pun">+</span><span class="lit">1</span><span class="pun">,</span><span class="pln"> </span><span class="lit">2</span><span class="pun">);</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="kwd">value</span><span class="pun">);</span></li><li class="L6"><span class="pln">  </span><span class="pun">}</span></li><li class="L7"><span class="pln">  </span><span class="kwd">else</span></li><li class="L8"><span class="pln">  </span><span class="pun">{</span></li><li class="L9"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="pln">data</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]);</span></li><li class="L0"><span class="pln">  </span><span class="pun">}</span></li><li class="L1"><span class="pun">}</span></li></ol></pre>
</div>
</div>
</div>
<div class="page-title-wrapper">
<h1 class="headline">
<span id="bleclientcharacteristic">BLEClientCharacteristic</span>
</h1>

</div>
<div class="page-content all-page-view-content">
<div class="">
<div class="element row-fluid build-alert">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
The Bluefruit nRF52 BSP codebase is undergoing active development based on customer feedback and testing. As such, the class documentation here is incomplete, and you should consult the Github repo for the latest code and API developments: <a href="https://goo.gl/LdEx62">https://goo.gl/LdEx62</a>
</div>
</div>
<div class="row-fluid build-text">
<p>This base class is used when defining custom client for BLE GATT characteristics, and is used throughout the Adafruit Bluefruit nRF52 API and helper classes.</p>
<p>Unless you are implementing a custom client for GATT service and characteristic, you normally won't use this base class directly, and would instantiate and call a higher level helper service or characteristic included in the Bluefruit nRF52 API.</p>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#basic-usage-26-3" class="anchor-link"><span class="fa fa-link"></span></a><span id="basic-usage-26-3" class="anchor-link-target"></span><span id="basic-usage" class="anchor-link-target"></span>Basic Usage</h1>
<p>There are three main steps to using the BLECharacteristic class.</p>
<p>1.) First, you need to declare and instantiate your BLECharacteristic class with a 16-bit or 128-bit UUID:</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/11218/elements/2979016/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">BLEClientCharacteristic myChar = BLEClientCharacteristic(0xABCD);</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="typ">BLEClientCharacteristic</span><span class="pln"> myChar </span><span class="pun">=</span><span class="pln"> </span><span class="typ">BLEClientCharacteristic</span><span class="pun">(</span><span class="lit">0xABCD</span><span class="pun">);</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<p>2.) Then you need to set the relevant callback for the characteristic if it supports notify or indicate.</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/11218/elements/2979018/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">myChar.setNotifyCallback(notify_callback);
myChar.begin();</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="pln">myChar</span><span class="pun">.</span><span class="pln">setNotifyCallback</span><span class="pun">(</span><span class="pln">notify_callback</span><span class="pun">);</span></li><li class="L1"><span class="pln">myChar</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<ul>
<li>
<strong>.setNotifyCallback&nbsp;</strong>This sets the callback that will be fired when we receive a Notify message from peripheral. This is needed to handle notifiable characteristic since callback allow us to response to the message in timely manner</li>
<li>
<strong>.begin()</strong> will cause this characteristic to be added to the last&nbsp;<strong>BLEClientService</strong> that had it's&nbsp;<strong>.begin()</strong> method called.</li>
</ul>
</div>
<div class="row-fluid build-text">
<p>3) Discover the characteristic after connected to peripheral by calling&nbsp;<code>.discover()</code>&nbsp;It is a must in order to perform any operation such as .read(), .write(), .enableNotify().</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/11218/elements/2979482/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">if ( myChar.discover() )
{
  uint32_t value = myChar.read32();
}</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> myChar</span><span class="pun">.</span><span class="pln">discover</span><span class="pun">()</span><span class="pln"> </span><span class="pun">)</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="pln">  </span><span class="typ">uint32_t</span><span class="pln"> </span><span class="kwd">value</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> myChar</span><span class="pun">.</span><span class="pln">read32</span><span class="pun">();</span></li><li class="L3"><span class="pun">}</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#api-26-10" class="anchor-link"><span class="fa fa-link"></span></a><span id="api-26-10" class="anchor-link-target"></span><span id="api" class="anchor-link-target"></span>API</h1>
<p>BLEClientCharacteristic has the following overall class structure:</p>
</div>
<div class="element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element row-fluid build-alert alert-info">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
This documentation may be slightly out of date as bugs are fixed, and the API develops. You should always consult the Github repo for the definitive latest code release and class definitions!
</div>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/11218/elements/2979023/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">/*--------- Callback Signatures ----------*/
typedef void (*notify_cb_t  ) (BLEClientCharacteristic* chr, uint8_t* data, uint16_t len);
typedef void (*indicate_cb_t) (BLEClientCharacteristic* chr, uint8_t* data, uint16_t len);

BLEUuid uuid;

// Constructors
BLEClientCharacteristic(void);
BLEClientCharacteristic(BLEUuid bleuuid);

// Destructor
virtual ~BLEClientCharacteristic();

void     begin(BLEClientService* parent_svc = NULL);

bool     discover(void);
bool     discovered(void);

uint16_t connHandle(void);
uint16_t valueHandle(void);
uint8_t  properties(void);

BLEClientService&amp; parentService(void);

/*------------- Read -------------*/
uint16_t read(void* buffer, uint16_t bufsize);
uint8_t  read8 (void);
uint16_t read16(void);
uint32_t read32(void);

/*------------- Write without Response-------------*/
uint16_t write     (const void* data, uint16_t len);
uint16_t write8    (uint8_t value);
uint16_t write16   (uint16_t value);
uint16_t write32   (uint32_t value);

/*------------- Write with Response-------------*/
uint16_t write_resp(const void* data, uint16_t len);
uint16_t write8_resp    (uint8_t value);
uint16_t write16_resp   (uint16_t value);
uint16_t write32_resp   (uint32_t value);

/*------------- Notify -------------*/
bool     writeCCCD       (uint16_t value);

bool     enableNotify    (void);
bool     disableNotify   (void);

bool     enableIndicate  (void);
bool     disableIndicate (void);

/*------------- Callbacks -------------*/
void     setNotifyCallback(notify_cb_t fp, bool useAdaCallback = true);
void     setIndicateCallback(indicate_cb_t fp, bool useAdaCallback = true);</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="com">/*--------- Callback Signatures ----------*/</span></li><li class="L1"><span class="kwd">typedef</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> </span><span class="pun">(*</span><span class="typ">notify_cb_t</span><span class="pln">  </span><span class="pun">)</span><span class="pln"> </span><span class="pun">(</span><span class="typ">BLEClientCharacteristic</span><span class="pun">*</span><span class="pln"> chr</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pun">*</span><span class="pln"> data</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint16_t</span><span class="pln"> len</span><span class="pun">);</span></li><li class="L2"><span class="kwd">typedef</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> </span><span class="pun">(*</span><span class="typ">indicate_cb_t</span><span class="pun">)</span><span class="pln"> </span><span class="pun">(</span><span class="typ">BLEClientCharacteristic</span><span class="pun">*</span><span class="pln"> chr</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pun">*</span><span class="pln"> data</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint16_t</span><span class="pln"> len</span><span class="pun">);</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="typ">BLEUuid</span><span class="pln"> uuid</span><span class="pun">;</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="com">// Constructors</span></li><li class="L7"><span class="typ">BLEClientCharacteristic</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L8"><span class="typ">BLEClientCharacteristic</span><span class="pun">(</span><span class="typ">BLEUuid</span><span class="pln"> bleuuid</span><span class="pun">);</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="com">// Destructor</span></li><li class="L1"><span class="kwd">virtual</span><span class="pln"> </span><span class="pun">~</span><span class="typ">BLEClientCharacteristic</span><span class="pun">();</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="kwd">void</span><span class="pln">     </span><span class="kwd">begin</span><span class="pun">(</span><span class="typ">BLEClientService</span><span class="pun">*</span><span class="pln"> parent_svc </span><span class="pun">=</span><span class="pln"> NULL</span><span class="pun">);</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="kwd">bool</span><span class="pln">     discover</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L6"><span class="kwd">bool</span><span class="pln">     discovered</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="typ">uint16_t</span><span class="pln"> connHandle</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L9"><span class="typ">uint16_t</span><span class="pln"> valueHandle</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L0"><span class="typ">uint8_t</span><span class="pln">  properties</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="typ">BLEClientService</span><span class="pun">&amp;</span><span class="pln"> parentService</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="com">/*------------- Read -------------*/</span></li><li class="L5"><span class="typ">uint16_t</span><span class="pln"> read</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">*</span><span class="pln"> buffer</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint16_t</span><span class="pln"> bufsize</span><span class="pun">);</span></li><li class="L6"><span class="typ">uint8_t</span><span class="pln">  read8 </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L7"><span class="typ">uint16_t</span><span class="pln"> read16</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L8"><span class="typ">uint32_t</span><span class="pln"> read32</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="com">/*------------- Write without Response-------------*/</span></li><li class="L1"><span class="typ">uint16_t</span><span class="pln"> write     </span><span class="pun">(</span><span class="kwd">const</span><span class="pln"> </span><span class="kwd">void</span><span class="pun">*</span><span class="pln"> data</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint16_t</span><span class="pln"> len</span><span class="pun">);</span></li><li class="L2"><span class="typ">uint16_t</span><span class="pln"> write8    </span><span class="pun">(</span><span class="typ">uint8_t</span><span class="pln"> </span><span class="kwd">value</span><span class="pun">);</span></li><li class="L3"><span class="typ">uint16_t</span><span class="pln"> write16   </span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> </span><span class="kwd">value</span><span class="pun">);</span></li><li class="L4"><span class="typ">uint16_t</span><span class="pln"> write32   </span><span class="pun">(</span><span class="typ">uint32_t</span><span class="pln"> </span><span class="kwd">value</span><span class="pun">);</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="com">/*------------- Write with Response-------------*/</span></li><li class="L7"><span class="typ">uint16_t</span><span class="pln"> write_resp</span><span class="pun">(</span><span class="kwd">const</span><span class="pln"> </span><span class="kwd">void</span><span class="pun">*</span><span class="pln"> data</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint16_t</span><span class="pln"> len</span><span class="pun">);</span></li><li class="L8"><span class="typ">uint16_t</span><span class="pln"> write8_resp    </span><span class="pun">(</span><span class="typ">uint8_t</span><span class="pln"> </span><span class="kwd">value</span><span class="pun">);</span></li><li class="L9"><span class="typ">uint16_t</span><span class="pln"> write16_resp   </span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> </span><span class="kwd">value</span><span class="pun">);</span></li><li class="L0"><span class="typ">uint16_t</span><span class="pln"> write32_resp   </span><span class="pun">(</span><span class="typ">uint32_t</span><span class="pln"> </span><span class="kwd">value</span><span class="pun">);</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="com">/*------------- Notify -------------*/</span></li><li class="L3"><span class="kwd">bool</span><span class="pln">     writeCCCD       </span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> </span><span class="kwd">value</span><span class="pun">);</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="kwd">bool</span><span class="pln">     enableNotify    </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L6"><span class="kwd">bool</span><span class="pln">     disableNotify   </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="kwd">bool</span><span class="pln">     enableIndicate  </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L9"><span class="kwd">bool</span><span class="pln">     disableIndicate </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="com">/*------------- Callbacks -------------*/</span></li><li class="L2"><span class="kwd">void</span><span class="pln">     setNotifyCallback</span><span class="pun">(</span><span class="typ">notify_cb_t</span><span class="pln"> fp</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">bool</span><span class="pln"> useAdaCallback </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">);</span></li><li class="L3"><span class="kwd">void</span><span class="pln">     setIndicateCallback</span><span class="pun">(</span><span class="typ">indicate_cb_t</span><span class="pln"> fp</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">bool</span><span class="pln"> useAdaCallback </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">);</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#example-26-13" class="anchor-link"><span class="fa fa-link"></span></a><span id="example-26-13" class="anchor-link-target"></span><span id="example" class="anchor-link-target"></span>Example</h1>
<p>The following example configures an instance of the Heart Rate Monitor (HRM) Service and it's related characteristics:</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/11218/elements/2979026/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">/*********************************************************************
 This is an example for our nRF52 based Bluefruit LE modules

 Pick one up today in the adafruit shop!

 Adafruit invests time and resources providing this open source code,
 please support Adafruit and open-source hardware by purchasing
 products from Adafruit!

 MIT license, check LICENSE for more information
 All text above, and the splash screen below must be included in
 any redistribution
*********************************************************************/

/* This sketch show how to use BLEClientService and BLEClientCharacteristic
 * to implement a custom client that is used to talk with Gatt server on
 * peripheral.
 *
 * Note: you will need another feather52 running peripheral/custom_HRM sketch
 * to test with.
 */

#include &lt;bluefruit.h&gt;

/* HRM Service Definitions
 * Heart Rate Monitor Service:  0x180D
 * Heart Rate Measurement Char: 0x2A37 (Mandatory)
 * Body Sensor Location Char:   0x2A38 (Optional)
 */

BLEClientService        hrms(UUID16_SVC_HEART_RATE);
BLEClientCharacteristic hrmc(UUID16_CHR_HEART_RATE_MEASUREMENT);
BLEClientCharacteristic bslc(UUID16_CHR_BODY_SENSOR_LOCATION);

void setup()
{
  Serial.begin(115200);

  Serial.println("Bluefruit52 Central Custom HRM Example");
  Serial.println("--------------------------------------\n");

  // Initialize Bluefruit with maximum connections as Peripheral = 0, Central = 1
  // SRAM usage required by SoftDevice will increase dramatically with number of connections
  Bluefruit.begin(0, 1);

  Bluefruit.setName("Bluefruit52 Central");

  // Initialize HRM client
  hrms.begin();

  // Initialize client characteristics of HRM.
  // Note: Client Char will be added to the last service that is begin()ed.
  bslc.begin();

  // set up callback for receiving measurement
  hrmc.setNotifyCallback(hrm_notify_callback);
  hrmc.begin();

  // Increase Blink rate to different from PrPh advertising mode
  Bluefruit.setConnLedInterval(250);

  // Callbacks for Central
  Bluefruit.Central.setDisconnectCallback(disconnect_callback);
  Bluefruit.Central.setConnectCallback(connect_callback);

  /* Start Central Scanning
   * - Enable auto scan if disconnected
   * - Interval = 100 ms, window = 80 ms
   * - Don't use active scan
   * - Filter only accept HRM service
   * - Start(timeout) with timeout = 0 will scan forever (until connected)
   */
  Bluefruit.Scanner.setRxCallback(scan_callback);
  Bluefruit.Scanner.restartOnDisconnect(true);
  Bluefruit.Scanner.setInterval(160, 80); // in unit of 0.625 ms
  Bluefruit.Scanner.filterUuid(hrms.uuid);
  Bluefruit.Scanner.useActiveScan(false);
  Bluefruit.Scanner.start(0);                   // // 0 = Don't stop scanning after n seconds
}

void loop()
{
  // do nothing
}

/**
 * Callback invoked when scanner pick up an advertising data
 * @param report Structural advertising data
 */
void scan_callback(ble_gap_evt_adv_report_t* report)
{
  // Connect to device with HRM service in advertising
  Bluefruit.Central.connect(report);
}

/**
 * Callback invoked when an connection is established
 * @param conn_handle
 */
void connect_callback(uint16_t conn_handle)
{
  Serial.println("Connected");
  Serial.print("Discovering HRM Service ... ");

  // If HRM is not found, disconnect and return
  if ( !hrms.discover(conn_handle) )
  {
    Serial.println("Found NONE");

    // disconect since we couldn't find HRM service
    Bluefruit.Central.disconnect(conn_handle);

    return;
  }

  // Once HRM service is found, we continue to discover its characteristic
  Serial.println("Found it");

  
  Serial.print("Discovering Measurement characteristic ... ");
  if ( !hrmc.discover() )
  {
    // Measurement chr is mandatory, if it is not found (valid), then disconnect
    Serial.println("not found !!!");  
    Serial.println("Measurement characteristic is mandatory but not found");
    Bluefruit.Central.disconnect(conn_handle);
    return;
  }
  Serial.println("Found it");

  // Measurement is found, continue to look for option Body Sensor Location
  // https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.characteristic.body_sensor_location.xml
  // Body Sensor Location is optional, print out the location in text if present
  Serial.print("Discovering Body Sensor Location characteristic ... ");
  if ( bslc.discover() )
  {
    Serial.println("Found it");
    
    // Body sensor location value is 8 bit
    const char* body_str[] = { "Other", "Chest", "Wrist", "Finger", "Hand", "Ear Lobe", "Foot" };

    // Read 8-bit BSLC value from peripheral
    uint8_t loc_value = bslc.read8();
    
    Serial.print("Body Location Sensor: ");
    Serial.println(body_str[loc_value]);
  }else
  {
    Serial.println("Found NONE");
  }

  // Reaching here means we are ready to go, let's enable notification on measurement chr
  if ( hrmc.enableNotify() )
  {
    Serial.println("Ready to receive HRM Measurement value");
  }else
  {
    Serial.println("Couldn't enable notify for HRM Measurement. Increase DEBUG LEVEL for troubleshooting");
  }
}

/**
 * Callback invoked when a connection is dropped
 * @param conn_handle
 * @param reason
 */
void disconnect_callback(uint16_t conn_handle, uint8_t reason)
{
  (void) conn_handle;
  (void) reason;

  Serial.println("Disconnected");
}


/**
 * Hooked callback that triggered when a measurement value is sent from peripheral
 * @param chr   Pointer client characteristic that even occurred,
 *              in this example it should be hrmc
 * @param data  Pointer to received data
 * @param len   Length of received data
 */
void hrm_notify_callback(BLEClientCharacteristic* chr, uint8_t* data, uint16_t len)
{
  // https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.characteristic.heart_rate_measurement.xml
  // Measurement contains of control byte0 and measurement (8 or 16 bit) + optional field
  // if byte0's bit0 is 0 --&gt; measurement is 8 bit, otherwise 16 bit.

  Serial.print("HRM Measurement: ");

  if ( data[0] &amp; bit(0) )
  {
    uint16_t value;
    memcpy(&amp;value, data+1, 2);

    Serial.println(value);
  }
  else
  {
    Serial.println(data[1]);
  }
}
</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="com">/*********************************************************************</span></li><li class="L1"><span class="com"> This is an example for our nRF52 based Bluefruit LE modules</span></li><li class="L2"><span class="com">&nbsp;</span></li><li class="L3"><span class="com"> Pick one up today in the adafruit shop!</span></li><li class="L4"><span class="com">&nbsp;</span></li><li class="L5"><span class="com"> Adafruit invests time and resources providing this open source code,</span></li><li class="L6"><span class="com"> please support Adafruit and open-source hardware by purchasing</span></li><li class="L7"><span class="com"> products from Adafruit!</span></li><li class="L8"><span class="com">&nbsp;</span></li><li class="L9"><span class="com"> MIT license, check LICENSE for more information</span></li><li class="L0"><span class="com"> All text above, and the splash screen below must be included in</span></li><li class="L1"><span class="com"> any redistribution</span></li><li class="L2"><span class="com">*********************************************************************/</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="com">/* This sketch show how to use BLEClientService and BLEClientCharacteristic</span></li><li class="L5"><span class="com"> * to implement a custom client that is used to talk with Gatt server on</span></li><li class="L6"><span class="com"> * peripheral.</span></li><li class="L7"><span class="com"> *</span></li><li class="L8"><span class="com"> * Note: you will need another feather52 running peripheral/custom_HRM sketch</span></li><li class="L9"><span class="com"> * to test with.</span></li><li class="L0"><span class="com"> */</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;bluefruit.h&gt;</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="com">/* HRM Service Definitions</span></li><li class="L5"><span class="com"> * Heart Rate Monitor Service:  0x180D</span></li><li class="L6"><span class="com"> * Heart Rate Measurement Char: 0x2A37 (Mandatory)</span></li><li class="L7"><span class="com"> * Body Sensor Location Char:   0x2A38 (Optional)</span></li><li class="L8"><span class="com"> */</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="typ">BLEClientService</span><span class="pln">        hrms</span><span class="pun">(</span><span class="pln">UUID16_SVC_HEART_RATE</span><span class="pun">);</span></li><li class="L1"><span class="typ">BLEClientCharacteristic</span><span class="pln"> hrmc</span><span class="pun">(</span><span class="pln">UUID16_CHR_HEART_RATE_MEASUREMENT</span><span class="pun">);</span></li><li class="L2"><span class="typ">BLEClientCharacteristic</span><span class="pln"> bslc</span><span class="pun">(</span><span class="pln">UUID16_CHR_BODY_SENSOR_LOCATION</span><span class="pun">);</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="kwd">void</span><span class="pln"> setup</span><span class="pun">()</span></li><li class="L5"><span class="pun">{</span></li><li class="L6"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">(</span><span class="lit">115200</span><span class="pun">);</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Bluefruit52 Central Custom HRM Example"</span><span class="pun">);</span></li><li class="L9"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"--------------------------------------\n"</span><span class="pun">);</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">  </span><span class="com">// Initialize Bluefruit with maximum connections as Peripheral = 0, Central = 1</span></li><li class="L2"><span class="pln">  </span><span class="com">// SRAM usage required by SoftDevice will increase dramatically with number of connections</span></li><li class="L3"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">(</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">);</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="pln">setName</span><span class="pun">(</span><span class="str">"Bluefruit52 Central"</span><span class="pun">);</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="pln">  </span><span class="com">// Initialize HRM client</span></li><li class="L8"><span class="pln">  hrms</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="pln">  </span><span class="com">// Initialize client characteristics of HRM.</span></li><li class="L1"><span class="pln">  </span><span class="com">// Note: Client Char will be added to the last service that is begin()ed.</span></li><li class="L2"><span class="pln">  bslc</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln">  </span><span class="com">// set up callback for receiving measurement</span></li><li class="L5"><span class="pln">  hrmc</span><span class="pun">.</span><span class="pln">setNotifyCallback</span><span class="pun">(</span><span class="pln">hrm_notify_callback</span><span class="pun">);</span></li><li class="L6"><span class="pln">  hrmc</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">  </span><span class="com">// Increase Blink rate to different from PrPh advertising mode</span></li><li class="L9"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="pln">setConnLedInterval</span><span class="pun">(</span><span class="lit">250</span><span class="pun">);</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">  </span><span class="com">// Callbacks for Central</span></li><li class="L2"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Central</span><span class="pun">.</span><span class="pln">setDisconnectCallback</span><span class="pun">(</span><span class="pln">disconnect_callback</span><span class="pun">);</span></li><li class="L3"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Central</span><span class="pun">.</span><span class="pln">setConnectCallback</span><span class="pun">(</span><span class="pln">connect_callback</span><span class="pun">);</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">  </span><span class="com">/* Start Central Scanning</span></li><li class="L6"><span class="com">   * - Enable auto scan if disconnected</span></li><li class="L7"><span class="com">   * - Interval = 100 ms, window = 80 ms</span></li><li class="L8"><span class="com">   * - Don't use active scan</span></li><li class="L9"><span class="com">   * - Filter only accept HRM service</span></li><li class="L0"><span class="com">   * - Start(timeout) with timeout = 0 will scan forever (until connected)</span></li><li class="L1"><span class="com">   */</span></li><li class="L2"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Scanner</span><span class="pun">.</span><span class="pln">setRxCallback</span><span class="pun">(</span><span class="pln">scan_callback</span><span class="pun">);</span></li><li class="L3"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Scanner</span><span class="pun">.</span><span class="pln">restartOnDisconnect</span><span class="pun">(</span><span class="kwd">true</span><span class="pun">);</span></li><li class="L4"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Scanner</span><span class="pun">.</span><span class="pln">setInterval</span><span class="pun">(</span><span class="lit">160</span><span class="pun">,</span><span class="pln"> </span><span class="lit">80</span><span class="pun">);</span><span class="pln"> </span><span class="com">// in unit of 0.625 ms</span></li><li class="L5"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Scanner</span><span class="pun">.</span><span class="pln">filterUuid</span><span class="pun">(</span><span class="pln">hrms</span><span class="pun">.</span><span class="pln">uuid</span><span class="pun">);</span></li><li class="L6"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Scanner</span><span class="pun">.</span><span class="pln">useActiveScan</span><span class="pun">(</span><span class="kwd">false</span><span class="pun">);</span></li><li class="L7"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Scanner</span><span class="pun">.</span><span class="pln">start</span><span class="pun">(</span><span class="lit">0</span><span class="pun">);</span><span class="pln">                   </span><span class="com">// // 0 = Don't stop scanning after n seconds</span></li><li class="L8"><span class="pun">}</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="kwd">void</span><span class="pln"> loop</span><span class="pun">()</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="pln">  </span><span class="com">// do nothing</span></li><li class="L3"><span class="pun">}</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="com">/**</span></li><li class="L6"><span class="com"> * Callback invoked when scanner pick up an advertising data</span></li><li class="L7"><span class="com"> * @param report Structural advertising data</span></li><li class="L8"><span class="com"> */</span></li><li class="L9"><span class="kwd">void</span><span class="pln"> scan_callback</span><span class="pun">(</span><span class="typ">ble_gap_evt_adv_report_t</span><span class="pun">*</span><span class="pln"> report</span><span class="pun">)</span></li><li class="L0"><span class="pun">{</span></li><li class="L1"><span class="pln">  </span><span class="com">// Connect to device with HRM service in advertising</span></li><li class="L2"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Central</span><span class="pun">.</span><span class="pln">connect</span><span class="pun">(</span><span class="pln">report</span><span class="pun">);</span></li><li class="L3"><span class="pun">}</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="com">/**</span></li><li class="L6"><span class="com"> * Callback invoked when an connection is established</span></li><li class="L7"><span class="com"> * @param conn_handle</span></li><li class="L8"><span class="com"> */</span></li><li class="L9"><span class="kwd">void</span><span class="pln"> connect_callback</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> conn_handle</span><span class="pun">)</span></li><li class="L0"><span class="pun">{</span></li><li class="L1"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Connected"</span><span class="pun">);</span></li><li class="L2"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"Discovering HRM Service ... "</span><span class="pun">);</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln">  </span><span class="com">// If HRM is not found, disconnect and return</span></li><li class="L5"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln">hrms</span><span class="pun">.</span><span class="pln">discover</span><span class="pun">(</span><span class="pln">conn_handle</span><span class="pun">)</span><span class="pln"> </span><span class="pun">)</span></li><li class="L6"><span class="pln">  </span><span class="pun">{</span></li><li class="L7"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Found NONE"</span><span class="pun">);</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="pln">    </span><span class="com">// disconect since we couldn't find HRM service</span></li><li class="L0"><span class="pln">    </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Central</span><span class="pun">.</span><span class="pln">disconnect</span><span class="pun">(</span><span class="pln">conn_handle</span><span class="pun">);</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="pln">    </span><span class="kwd">return</span><span class="pun">;</span></li><li class="L3"><span class="pln">  </span><span class="pun">}</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">  </span><span class="com">// Once HRM service is found, we continue to discover its characteristic</span></li><li class="L6"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Found it"</span><span class="pun">);</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">  </span></li><li class="L9"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"Discovering Measurement characteristic ... "</span><span class="pun">);</span></li><li class="L0"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="pln">hrmc</span><span class="pun">.</span><span class="pln">discover</span><span class="pun">()</span><span class="pln"> </span><span class="pun">)</span></li><li class="L1"><span class="pln">  </span><span class="pun">{</span></li><li class="L2"><span class="pln">    </span><span class="com">// Measurement chr is mandatory, if it is not found (valid), then disconnect</span></li><li class="L3"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"not found !!!"</span><span class="pun">);</span><span class="pln">  </span></li><li class="L4"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Measurement characteristic is mandatory but not found"</span><span class="pun">);</span></li><li class="L5"><span class="pln">    </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Central</span><span class="pun">.</span><span class="pln">disconnect</span><span class="pun">(</span><span class="pln">conn_handle</span><span class="pun">);</span></li><li class="L6"><span class="pln">    </span><span class="kwd">return</span><span class="pun">;</span></li><li class="L7"><span class="pln">  </span><span class="pun">}</span></li><li class="L8"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Found it"</span><span class="pun">);</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="pln">  </span><span class="com">// Measurement is found, continue to look for option Body Sensor Location</span></li><li class="L1"><span class="pln">  </span><span class="com">// https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.characteristic.body_sensor_location.xml</span></li><li class="L2"><span class="pln">  </span><span class="com">// Body Sensor Location is optional, print out the location in text if present</span></li><li class="L3"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"Discovering Body Sensor Location characteristic ... "</span><span class="pun">);</span></li><li class="L4"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> bslc</span><span class="pun">.</span><span class="pln">discover</span><span class="pun">()</span><span class="pln"> </span><span class="pun">)</span></li><li class="L5"><span class="pln">  </span><span class="pun">{</span></li><li class="L6"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Found it"</span><span class="pun">);</span></li><li class="L7"><span class="pln">    </span></li><li class="L8"><span class="pln">    </span><span class="com">// Body sensor location value is 8 bit</span></li><li class="L9"><span class="pln">    </span><span class="kwd">const</span><span class="pln"> </span><span class="kwd">char</span><span class="pun">*</span><span class="pln"> body_str</span><span class="pun">[]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="str">"Other"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"Chest"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"Wrist"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"Finger"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"Hand"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"Ear Lobe"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"Foot"</span><span class="pln"> </span><span class="pun">};</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">    </span><span class="com">// Read 8-bit BSLC value from peripheral</span></li><li class="L2"><span class="pln">    </span><span class="typ">uint8_t</span><span class="pln"> loc_value </span><span class="pun">=</span><span class="pln"> bslc</span><span class="pun">.</span><span class="pln">read8</span><span class="pun">();</span></li><li class="L3"><span class="pln">    </span></li><li class="L4"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"Body Location Sensor: "</span><span class="pun">);</span></li><li class="L5"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="pln">body_str</span><span class="pun">[</span><span class="pln">loc_value</span><span class="pun">]);</span></li><li class="L6"><span class="pln">  </span><span class="pun">}</span><span class="kwd">else</span></li><li class="L7"><span class="pln">  </span><span class="pun">{</span></li><li class="L8"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Found NONE"</span><span class="pun">);</span></li><li class="L9"><span class="pln">  </span><span class="pun">}</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">  </span><span class="com">// Reaching here means we are ready to go, let's enable notification on measurement chr</span></li><li class="L2"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> hrmc</span><span class="pun">.</span><span class="pln">enableNotify</span><span class="pun">()</span><span class="pln"> </span><span class="pun">)</span></li><li class="L3"><span class="pln">  </span><span class="pun">{</span></li><li class="L4"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Ready to receive HRM Measurement value"</span><span class="pun">);</span></li><li class="L5"><span class="pln">  </span><span class="pun">}</span><span class="kwd">else</span></li><li class="L6"><span class="pln">  </span><span class="pun">{</span></li><li class="L7"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Couldn't enable notify for HRM Measurement. Increase DEBUG LEVEL for troubleshooting"</span><span class="pun">);</span></li><li class="L8"><span class="pln">  </span><span class="pun">}</span></li><li class="L9"><span class="pun">}</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="com">/**</span></li><li class="L2"><span class="com"> * Callback invoked when a connection is dropped</span></li><li class="L3"><span class="com"> * @param conn_handle</span></li><li class="L4"><span class="com"> * @param reason</span></li><li class="L5"><span class="com"> */</span></li><li class="L6"><span class="kwd">void</span><span class="pln"> disconnect_callback</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> conn_handle</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pln"> reason</span><span class="pun">)</span></li><li class="L7"><span class="pun">{</span></li><li class="L8"><span class="pln">  </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span><span class="pln"> conn_handle</span><span class="pun">;</span></li><li class="L9"><span class="pln">  </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span><span class="pln"> reason</span><span class="pun">;</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Disconnected"</span><span class="pun">);</span></li><li class="L2"><span class="pun">}</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="com">/**</span></li><li class="L6"><span class="com"> * Hooked callback that triggered when a measurement value is sent from peripheral</span></li><li class="L7"><span class="com"> * @param chr   Pointer client characteristic that even occurred,</span></li><li class="L8"><span class="com"> *              in this example it should be hrmc</span></li><li class="L9"><span class="com"> * @param data  Pointer to received data</span></li><li class="L0"><span class="com"> * @param len   Length of received data</span></li><li class="L1"><span class="com"> */</span></li><li class="L2"><span class="kwd">void</span><span class="pln"> hrm_notify_callback</span><span class="pun">(</span><span class="typ">BLEClientCharacteristic</span><span class="pun">*</span><span class="pln"> chr</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pun">*</span><span class="pln"> data</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint16_t</span><span class="pln"> len</span><span class="pun">)</span></li><li class="L3"><span class="pun">{</span></li><li class="L4"><span class="pln">  </span><span class="com">// https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.characteristic.heart_rate_measurement.xml</span></li><li class="L5"><span class="pln">  </span><span class="com">// Measurement contains of control byte0 and measurement (8 or 16 bit) + optional field</span></li><li class="L6"><span class="pln">  </span><span class="com">// if byte0's bit0 is 0 --&gt; measurement is 8 bit, otherwise 16 bit.</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"HRM Measurement: "</span><span class="pun">);</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> data</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln"> bit</span><span class="pun">(</span><span class="lit">0</span><span class="pun">)</span><span class="pln"> </span><span class="pun">)</span></li><li class="L1"><span class="pln">  </span><span class="pun">{</span></li><li class="L2"><span class="pln">    </span><span class="typ">uint16_t</span><span class="pln"> </span><span class="kwd">value</span><span class="pun">;</span></li><li class="L3"><span class="pln">    memcpy</span><span class="pun">(&amp;</span><span class="kwd">value</span><span class="pun">,</span><span class="pln"> data</span><span class="pun">+</span><span class="lit">1</span><span class="pun">,</span><span class="pln"> </span><span class="lit">2</span><span class="pun">);</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="kwd">value</span><span class="pun">);</span></li><li class="L6"><span class="pln">  </span><span class="pun">}</span></li><li class="L7"><span class="pln">  </span><span class="kwd">else</span></li><li class="L8"><span class="pln">  </span><span class="pun">{</span></li><li class="L9"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="pln">data</span><span class="pun">[</span><span class="lit">1</span><span class="pun">]);</span></li><li class="L0"><span class="pln">  </span><span class="pun">}</span></li><li class="L1"><span class="pun">}</span></li></ol></pre>
</div>
</div>
</div>
<div class="page-title-wrapper">
<h1 class="headline">
<span id="blediscovery">BLEDiscovery</span>
</h1>

</div>
<div class="page-content all-page-view-content">
<div class="">
<div class="element row-fluid build-alert">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
This page is a work in progress as the API is changing as we migrate to S132v5 (nRF52832) and S140 (nRF52840) and add better Central mode support.
</div>
</div>
<div class="row-fluid build-text">
<p>BLEDiscovery is a helper class to make finding characteristics on a Gatt server (hosted on a BLE peripheral) easier. For service discovery, the BLEClientService's <code>discover()</code> API must be used, as shown below:</p>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#api-27-3" class="anchor-link"><span class="fa fa-link"></span></a><span id="api-27-3" class="anchor-link-target"></span><span id="api" class="anchor-link-target"></span>API</h1>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/11271/elements/2979423/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
 <pre class="code-text-only" style="display: none;">BLEDiscovery(void); // Constructor

void     begin(void);
bool     begun(void);

void                     setHandleRange(ble_gattc_handle_range_t handle_range);
ble_gattc_handle_range_t getHandleRange(void);

uint8_t  discoverCharacteristic(uint16_t conn_handle, BLEClientCharacteristic* chr[], uint8_t count);
uint8_t  discoverCharacteristic(uint16_t conn_handle, BLEClientCharacteristic&amp; chr1);
uint8_t  discoverCharacteristic(uint16_t conn_handle, BLEClientCharacteristic&amp; chr1, BLEClientCharacteristic&amp; chr2);
uint8_t  discoverCharacteristic(uint16_t conn_handle, BLEClientCharacteristic&amp; chr1, BLEClientCharacteristic&amp; chr2, BLEClientCharacteristic&amp; chr3);
uint8_t  discoverCharacteristic(uint16_t conn_handle, BLEClientCharacteristic&amp; chr1, BLEClientCharacteristic&amp; chr2, BLEClientCharacteristic&amp; chr3, BLEClientCharacteristic&amp; chr4);
uint8_t  discoverCharacteristic(uint16_t conn_handle, BLEClientCharacteristic&amp; chr1, BLEClientCharacteristic&amp; chr2, BLEClientCharacteristic&amp; chr3, BLEClientCharacteristic&amp; chr4, BLEClientCharacteristic&amp; chr5);</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="typ">BLEDiscovery</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span><span class="pln"> </span><span class="com">// Constructor</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="kwd">void</span><span class="pln">     </span><span class="kwd">begin</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L3"><span class="kwd">bool</span><span class="pln">     begun</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="kwd">void</span><span class="pln">                     setHandleRange</span><span class="pun">(</span><span class="typ">ble_gattc_handle_range_t</span><span class="pln"> handle_range</span><span class="pun">);</span></li><li class="L6"><span class="typ">ble_gattc_handle_range_t</span><span class="pln"> getHandleRange</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="typ">uint8_t</span><span class="pln">  discoverCharacteristic</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> conn_handle</span><span class="pun">,</span><span class="pln"> </span><span class="typ">BLEClientCharacteristic</span><span class="pun">*</span><span class="pln"> chr</span><span class="pun">[],</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pln"> count</span><span class="pun">);</span></li><li class="L9"><span class="typ">uint8_t</span><span class="pln">  discoverCharacteristic</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> conn_handle</span><span class="pun">,</span><span class="pln"> </span><span class="typ">BLEClientCharacteristic</span><span class="pun">&amp;</span><span class="pln"> chr1</span><span class="pun">);</span></li><li class="L0"><span class="typ">uint8_t</span><span class="pln">  discoverCharacteristic</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> conn_handle</span><span class="pun">,</span><span class="pln"> </span><span class="typ">BLEClientCharacteristic</span><span class="pun">&amp;</span><span class="pln"> chr1</span><span class="pun">,</span><span class="pln"> </span><span class="typ">BLEClientCharacteristic</span><span class="pun">&amp;</span><span class="pln"> chr2</span><span class="pun">);</span></li><li class="L1"><span class="typ">uint8_t</span><span class="pln">  discoverCharacteristic</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> conn_handle</span><span class="pun">,</span><span class="pln"> </span><span class="typ">BLEClientCharacteristic</span><span class="pun">&amp;</span><span class="pln"> chr1</span><span class="pun">,</span><span class="pln"> </span><span class="typ">BLEClientCharacteristic</span><span class="pun">&amp;</span><span class="pln"> chr2</span><span class="pun">,</span><span class="pln"> </span><span class="typ">BLEClientCharacteristic</span><span class="pun">&amp;</span><span class="pln"> chr3</span><span class="pun">);</span></li><li class="L2"><span class="typ">uint8_t</span><span class="pln">  discoverCharacteristic</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> conn_handle</span><span class="pun">,</span><span class="pln"> </span><span class="typ">BLEClientCharacteristic</span><span class="pun">&amp;</span><span class="pln"> chr1</span><span class="pun">,</span><span class="pln"> </span><span class="typ">BLEClientCharacteristic</span><span class="pun">&amp;</span><span class="pln"> chr2</span><span class="pun">,</span><span class="pln"> </span><span class="typ">BLEClientCharacteristic</span><span class="pun">&amp;</span><span class="pln"> chr3</span><span class="pun">,</span><span class="pln"> </span><span class="typ">BLEClientCharacteristic</span><span class="pun">&amp;</span><span class="pln"> chr4</span><span class="pun">);</span></li><li class="L3"><span class="typ">uint8_t</span><span class="pln">  discoverCharacteristic</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> conn_handle</span><span class="pun">,</span><span class="pln"> </span><span class="typ">BLEClientCharacteristic</span><span class="pun">&amp;</span><span class="pln"> chr1</span><span class="pun">,</span><span class="pln"> </span><span class="typ">BLEClientCharacteristic</span><span class="pun">&amp;</span><span class="pln"> chr2</span><span class="pun">,</span><span class="pln"> </span><span class="typ">BLEClientCharacteristic</span><span class="pun">&amp;</span><span class="pln"> chr3</span><span class="pun">,</span><span class="pln"> </span><span class="typ">BLEClientCharacteristic</span><span class="pun">&amp;</span><span class="pln"> chr4</span><span class="pun">,</span><span class="pln"> </span><span class="typ">BLEClientCharacteristic</span><span class="pun">&amp;</span><span class="pln"> chr5</span><span class="pun">);</span></li></ol></pre>
</div>
<div class="element element row-fluid build-alert alert-info">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
For concrete examples of how to use this API see the 'Central' folder in the examples that are part of the BSP.
</div>
</div>
</div>
</div>
<div class="page-title-wrapper">
<h1 class="headline">
<span id="bledis">BLEDis</span>
</h1>

</div>
<div class="page-content all-page-view-content">
<div class="">
<div class="element element row-fluid build-alert">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
The Bluefruit nRF52 BSP codebase is undergoing active development based on customer feedback and testing. As such, the class documentation here is incomplete, and you should consult the Github repo for the latest code and API developments: <a href="https://goo.gl/LdEx62">https://goo.gl/LdEx62</a>
</div>
</div>
<div class="row-fluid build-text">
<p>This helper class acts as a wrapper for the Bluetooth <a href="https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.service.device_information.xml" target="_blank">Device Information Service</a>&nbsp;(0x180A). This official GATT service allows you to publish basic information about your device in a generic manner.</p>
<p>The Bluefruit BLEDis helper class exposes the following characteristics:</p>
<ul>
<li>
<a href="https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.characteristic.model_number_string.xml" target="_blank">Model Number String</a> (0x2A24), exposed via <strong>.setModel(const char*)</strong>
</li>
<li>
<a href="https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.characteristic.serial_number_string.xml" target="_blank">Serial Number String</a> (0x2A25),&nbsp;private</li>
<li>
<a href="https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.characteristic.firmware_revision_string.xml" target="_blank">Firmware Revision String</a>&nbsp;(0x2A26), private</li>
<li>
<a href="https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.characteristic.hardware_revision_string.xml" target="_blank">Hardware Revision String</a>&nbsp;(0x2A27), exposed via <strong>.setHardwareRev(const char*)</strong>
</li>
<li>
<a href="https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.characteristic.software_revision_string.xml" target="_blank">Software Revision String</a> (0x2A28), exposed via <strong>.setSoftwareRev(const char*)</strong>
</li>
<li>
<a href="https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.characteristic.manufacturer_name_string.xml" target="_blank">Manufacturer Name String</a> (0x2A29), exposed via <strong>.setManufacturer(const char*)</strong>
</li>
</ul>
<p>The <strong>Serial Number String</strong>&nbsp;is private and is populated with a unique device ID that nRF52832 SoCs are programmed with during manufacturing.</p>
<p>The&nbsp;<strong>Firmware Revision String</strong> is also private and is populated with the following fields (to help us track issues and offer better feedback in the support forums):</p>
<ul>
<ul>
<li>Softdevice Name (Sxxx)</li>
<li>Softdevice Version (x.x.x)</li>
<li>Bootloader Version (x.x.x)</li>
</ul>
</ul>
</div>
<div class="element element row-fluid build-alert alert-info">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
Note: The Softdevice and Bootloader fields are separated by a single comma, meaning the final output will resemble the following string: 'S132 2.0.1, 0.5.0'
</div>
</div>
<div class="row-fluid build-text">
<p>The remaining characteristics are all public and can be set to an value (up to 20 chars in length) using the appropriate helper function, but they have&nbsp;the following default values (for the nRF52832):</p>
<ul>
<li>
<strong>Model Number String</strong>:&nbsp;Bluefruit Feather 52</li>
<li>
<strong>Hardware Revision String</strong>: NULL</li>
<li>
<strong>Software Revision String</strong>: The nRF52 BSP version number</li>
<li>
<strong>Manufacturer Name String</strong>: Adafruit Industries</li>
</ul>
<p>Setting a public value to NULL will prevent the characteristic from being present in the DIS service.</p>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#api-28-5" class="anchor-link"><span class="fa fa-link"></span></a><span id="api-28-5" class="anchor-link-target"></span><span id="api" class="anchor-link-target"></span>API</h1>
<p>The following functions and constructors are defined in the BLEDis class:</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/8809/elements/2860753/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">BLEDis(void);

void setModel(const char* model);
void setHardwareRev(const char* hw_rev);
void setSoftwareRev(const char* sw_rev);
void setManufacturer(const char* manufacturer);

err_t begin(void);</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="typ">BLEDis</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="kwd">void</span><span class="pln"> setModel</span><span class="pun">(</span><span class="kwd">const</span><span class="pln"> </span><span class="kwd">char</span><span class="pun">*</span><span class="pln"> model</span><span class="pun">);</span></li><li class="L3"><span class="kwd">void</span><span class="pln"> setHardwareRev</span><span class="pun">(</span><span class="kwd">const</span><span class="pln"> </span><span class="kwd">char</span><span class="pun">*</span><span class="pln"> hw_rev</span><span class="pun">);</span></li><li class="L4"><span class="kwd">void</span><span class="pln"> setSoftwareRev</span><span class="pun">(</span><span class="kwd">const</span><span class="pln"> </span><span class="kwd">char</span><span class="pun">*</span><span class="pln"> sw_rev</span><span class="pun">);</span></li><li class="L5"><span class="kwd">void</span><span class="pln"> setManufacturer</span><span class="pun">(</span><span class="kwd">const</span><span class="pln"> </span><span class="kwd">char</span><span class="pun">*</span><span class="pln"> manufacturer</span><span class="pun">);</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="typ">err_t</span><span class="pln"> </span><span class="kwd">begin</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<p>The individual characteristic values are set via the&nbsp;<strong>.set*()</strong> functions above, and when all values have been set you call the&nbsp;<strong>.begin()</strong> function to add the service to the device's internal GATT registry.</p>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#example-28-8" class="anchor-link"><span class="fa fa-link"></span></a><span id="example-28-8" class="anchor-link-target"></span><span id="example" class="anchor-link-target"></span>Example</h1>
<p>The following bare bones examples show how to setup the device information service with user-configurable strings for values:</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/8809/elements/2860756/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">#include &lt;bluefruit.h&gt;

BLEDis bledis;

void setup() 
{
  Serial.begin(115200);

  Serial.println("Bluefruit52 DIS Example");

  Bluefruit.begin();
  Bluefruit.setName("Bluefruit52");

  // Configure and Start Device Information Service
  bledis.setManufacturer("Adafruit Industries");
  bledis.setModel("Bluefruit Feather52");
  bledis.begin();

  // Set up Advertising Packet
  setupAdv();

  // Start Advertising
  Bluefruit.Advertising.start();
}

void setupAdv(void)
{  
  Bluefruit.Advertising.addFlags(BLE_GAP_ADV_FLAGS_LE_ONLY_GENERAL_DISC_MODE);
  Bluefruit.Advertising.addTxPower();
  
  // There isn't enough room in the advertising packet for the
  // name so we'll place it on the secondary Scan Response packet
  Bluefruit.ScanResponse.addName();
}

void loop() 
{
}</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;bluefruit.h&gt;</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="typ">BLEDis</span><span class="pln"> bledis</span><span class="pun">;</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="kwd">void</span><span class="pln"> setup</span><span class="pun">()</span><span class="pln"> </span></li><li class="L5"><span class="pun">{</span></li><li class="L6"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">(</span><span class="lit">115200</span><span class="pun">);</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Bluefruit52 DIS Example"</span><span class="pun">);</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L1"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="pln">setName</span><span class="pun">(</span><span class="str">"Bluefruit52"</span><span class="pun">);</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="pln">  </span><span class="com">// Configure and Start Device Information Service</span></li><li class="L4"><span class="pln">  bledis</span><span class="pun">.</span><span class="pln">setManufacturer</span><span class="pun">(</span><span class="str">"Adafruit Industries"</span><span class="pun">);</span></li><li class="L5"><span class="pln">  bledis</span><span class="pun">.</span><span class="pln">setModel</span><span class="pun">(</span><span class="str">"Bluefruit Feather52"</span><span class="pun">);</span></li><li class="L6"><span class="pln">  bledis</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">  </span><span class="com">// Set up Advertising Packet</span></li><li class="L9"><span class="pln">  setupAdv</span><span class="pun">();</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">  </span><span class="com">// Start Advertising</span></li><li class="L2"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">start</span><span class="pun">();</span></li><li class="L3"><span class="pun">}</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="kwd">void</span><span class="pln"> setupAdv</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span></li><li class="L6"><span class="pun">{</span><span class="pln">  </span></li><li class="L7"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">addFlags</span><span class="pun">(</span><span class="pln">BLE_GAP_ADV_FLAGS_LE_ONLY_GENERAL_DISC_MODE</span><span class="pun">);</span></li><li class="L8"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">addTxPower</span><span class="pun">();</span></li><li class="L9"><span class="pln">  </span></li><li class="L0"><span class="pln">  </span><span class="com">// There isn't enough room in the advertising packet for the</span></li><li class="L1"><span class="pln">  </span><span class="com">// name so we'll place it on the secondary Scan Response packet</span></li><li class="L2"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">ScanResponse</span><span class="pun">.</span><span class="pln">addName</span><span class="pun">();</span></li><li class="L3"><span class="pun">}</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="kwd">void</span><span class="pln"> loop</span><span class="pun">()</span><span class="pln"> </span></li><li class="L6"><span class="pun">{</span></li><li class="L7"><span class="pun">}</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#output-28-10" class="anchor-link"><span class="fa fa-link"></span></a><span id="output-28-10" class="anchor-link-target"></span><span id="output" class="anchor-link-target"></span>Output</h1>
<p>If you examine the device using the Bluefruit LE Connect app on iOS, Android or OS X you should see something resembling the following output:</p>
</div>
<div class="row-fluid build-image">
<a href="./nRF52_bluefruit_Learning_Guide.html#output">
<img class="39915-asset img-responsive" src="./nRF52_bluefruit_Learning_Guide/microcontrollers_Screen_Shot_2017-03-08_at_15.30.28.png" alt="microcontrollers_Screen_Shot_2017-03-08_at_15.30.28.png">
<span class="image-expand"><i class="fa fa-search-plus"></i></span>
</a> </div>
</div>
</div>
<div class="page-title-wrapper">
<h1 class="headline">
<span id="bleuart">BLEUart</span>
</h1>

</div>
<div class="page-content all-page-view-content">
<div class="">
<div class="element row-fluid build-alert">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
The Bluefruit nRF52 BSP codebase is undergoing active development based on customer feedback and testing. As such, the class documentation here is incomplete, and you should consult the Github repo for the latest code and API developments: <a href="https://goo.gl/LdEx62">https://goo.gl/LdEx62</a>
</div>
</div>
<div class="row-fluid build-text">
<p>BLEUart is a wrapper class for NUS (Nordic UART Service), which is a proprietary service defined by Nordic Semiconductors that we use as a baseline transport mechanism between Bluefruit modules and our mobile and desktop Bluefruit LE Connect applications. You can use it to easily send ASCII or binary data in both directions, between the peripheral and the central device.</p>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#api-29-3" class="anchor-link"><span class="fa fa-link"></span></a><span id="api-29-3" class="anchor-link-target"></span><span id="api" class="anchor-link-target"></span>API</h1>
<p>BLEUart has the following public API:</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/8808/elements/2860762/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">// RX Callback signature (fires when data was written by the central)
typedef void (*rx_callback_t) (void);

// Constructor
BLEUart(uint16_t fifo_depth = BLE_UART_DEFAULT_FIFO_DEPTH);

virtual err_t begin(void);

bool notifyEnabled(void);

void setRxCallback( rx_callback_t fp);

// Stream API
virtual int       read       ( void );
virtual int       read       ( uint8_t * buf, size_t size );
virtual size_t    write      ( uint8_t b );
virtual size_t    write      ( const uint8_t *content, size_t len );
virtual int       available  ( void );
virtual int       peek       ( void );
virtual void      flush      ( void );

// Pull in write(str) and write(buf, size) from Print
using Print::write;</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="com">// RX Callback signature (fires when data was written by the central)</span></li><li class="L1"><span class="kwd">typedef</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> </span><span class="pun">(*</span><span class="typ">rx_callback_t</span><span class="pun">)</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="com">// Constructor</span></li><li class="L4"><span class="typ">BLEUart</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> fifo_depth </span><span class="pun">=</span><span class="pln"> BLE_UART_DEFAULT_FIFO_DEPTH</span><span class="pun">);</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="kwd">virtual</span><span class="pln"> </span><span class="typ">err_t</span><span class="pln"> </span><span class="kwd">begin</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="kwd">bool</span><span class="pln"> notifyEnabled</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="kwd">void</span><span class="pln"> setRxCallback</span><span class="pun">(</span><span class="pln"> </span><span class="typ">rx_callback_t</span><span class="pln"> fp</span><span class="pun">);</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="com">// Stream API</span></li><li class="L3"><span class="kwd">virtual</span><span class="pln"> </span><span class="kwd">int</span><span class="pln">       read       </span><span class="pun">(</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> </span><span class="pun">);</span></li><li class="L4"><span class="kwd">virtual</span><span class="pln"> </span><span class="kwd">int</span><span class="pln">       read       </span><span class="pun">(</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> buf</span><span class="pun">,</span><span class="pln"> </span><span class="typ">size_t</span><span class="pln"> size </span><span class="pun">);</span></li><li class="L5"><span class="kwd">virtual</span><span class="pln"> </span><span class="typ">size_t</span><span class="pln">    write      </span><span class="pun">(</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pln"> b </span><span class="pun">);</span></li><li class="L6"><span class="kwd">virtual</span><span class="pln"> </span><span class="typ">size_t</span><span class="pln">    write      </span><span class="pun">(</span><span class="pln"> </span><span class="kwd">const</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pln"> </span><span class="pun">*</span><span class="pln">content</span><span class="pun">,</span><span class="pln"> </span><span class="typ">size_t</span><span class="pln"> len </span><span class="pun">);</span></li><li class="L7"><span class="kwd">virtual</span><span class="pln"> </span><span class="kwd">int</span><span class="pln">       available  </span><span class="pun">(</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> </span><span class="pun">);</span></li><li class="L8"><span class="kwd">virtual</span><span class="pln"> </span><span class="kwd">int</span><span class="pln">       peek       </span><span class="pun">(</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> </span><span class="pun">);</span></li><li class="L9"><span class="kwd">virtual</span><span class="pln"> </span><span class="kwd">void</span><span class="pln">      flush      </span><span class="pun">(</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> </span><span class="pun">);</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="com">// Pull in write(str) and write(buf, size) from Print</span></li><li class="L2"><span class="kwd">using</span><span class="pln"> </span><span class="typ">Print</span><span class="pun">::</span><span class="pln">write</span><span class="pun">;</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#example-29-5" class="anchor-link"><span class="fa fa-link"></span></a><span id="example-29-5" class="anchor-link-target"></span><span id="example" class="anchor-link-target"></span>Example</h1>
<p>The following example shows how to use the BLEUart helper class.</p>
<p>This example may be out of date, and you should always consult the latest example code in the nRF52 BSP!</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/8808/elements/2860764/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">#include &lt;bluefruit.h&gt;

BLEDis  bledis;
BLEUart bleuart;
BLEBas  blebas;

#define STATUS_LED  (17)
#define BLINKY_MS   (2000)

uint32_t blinkyms;

void setup()
{
  Serial.begin(115200);

  Serial.println("Bluefruit52 BLEUART Example");

  // Setup LED pins and reset blinky counter
  pinMode(STATUS_LED, OUTPUT);
  blinkyms = millis();

  // Setup the BLE LED to be enabled on CONNECT
  // Note: This is actually the default behaviour, but provided
  // here in case you want to control this manually via PIN 19
  Bluefruit.autoConnLed(true);

  Bluefruit.begin();
  Bluefruit.setName("Bluefruit52");
  Bluefruit.setConnectCallback(connect_callback);
  Bluefruit.setDisconnectCallback(disconnect_callback);

  // Configure and Start Device Information Service
  bledis.setManufacturer("Adafruit Industries");
  bledis.setModel("Bluefruit Feather52");
  bledis.begin();

  // Configure and Start BLE Uart Service
  bleuart.begin();

  // Start BLE Battery Service
  blebas.begin();
  blebas.update(100);

  // Set up Advertising Packet
  setupAdv();

  // Start Advertising
  Bluefruit.Advertising.start();
}

void setupAdv(void)
{
  Bluefruit.Advertising.addFlags(BLE_GAP_ADV_FLAGS_LE_ONLY_GENERAL_DISC_MODE);
  Bluefruit.Advertising.addTxPower();

  // Include bleuart 128-bit uuid
  Bluefruit.Advertising.addService(bleuart);

  // There is no room for Name in Advertising packet
  // Use Scan response for Name
  Bluefruit.ScanResponse.addName();
}

void loop()
{
  // Blinky!
  if (blinkyms+BLINKY_MS &lt; millis()) {
    blinkyms = millis();
    digitalToggle(STATUS_LED);
  }

  // Forward from Serial to BLEUART
  if (Serial.available())
  {
    // Delay to get enough input data since we have a
    // limited amount of space in the transmit buffer
    delay(2);

    uint8_t buf[64];
    int count = Serial.readBytes(buf, sizeof(buf));
    bleuart.write( buf, count );
  }

  // Forward from BLEUART to Serial
  if ( bleuart.available() )
  {
    uint8_t ch;
    ch = (uint8_t) bleuart.read();
    Serial.write(ch);
  }
}

void connect_callback(void)
{
  Serial.println("Connected");
}

void disconnect_callback(uint8_t reason)
{
  (void) reason;

  Serial.println();
  Serial.println("Disconnected");
  Serial.println("Bluefruit will start advertising again");
}</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;bluefruit.h&gt;</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="typ">BLEDis</span><span class="pln">  bledis</span><span class="pun">;</span></li><li class="L3"><span class="typ">BLEUart</span><span class="pln"> bleuart</span><span class="pun">;</span></li><li class="L4"><span class="typ">BLEBas</span><span class="pln">  blebas</span><span class="pun">;</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="com">#define</span><span class="pln"> STATUS_LED  </span><span class="pun">(</span><span class="lit">17</span><span class="pun">)</span></li><li class="L7"><span class="com">#define</span><span class="pln"> BLINKY_MS   </span><span class="pun">(</span><span class="lit">2000</span><span class="pun">)</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="typ">uint32_t</span><span class="pln"> blinkyms</span><span class="pun">;</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="kwd">void</span><span class="pln"> setup</span><span class="pun">()</span></li><li class="L2"><span class="pun">{</span></li><li class="L3"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">(</span><span class="lit">115200</span><span class="pun">);</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Bluefruit52 BLEUART Example"</span><span class="pun">);</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="pln">  </span><span class="com">// Setup LED pins and reset blinky counter</span></li><li class="L8"><span class="pln">  pinMode</span><span class="pun">(</span><span class="pln">STATUS_LED</span><span class="pun">,</span><span class="pln"> OUTPUT</span><span class="pun">);</span></li><li class="L9"><span class="pln">  blinkyms </span><span class="pun">=</span><span class="pln"> millis</span><span class="pun">();</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">  </span><span class="com">// Setup the BLE LED to be enabled on CONNECT</span></li><li class="L2"><span class="pln">  </span><span class="com">// Note: This is actually the default behaviour, but provided</span></li><li class="L3"><span class="pln">  </span><span class="com">// here in case you want to control this manually via PIN 19</span></li><li class="L4"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="pln">autoConnLed</span><span class="pun">(</span><span class="kwd">true</span><span class="pun">);</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L7"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="pln">setName</span><span class="pun">(</span><span class="str">"Bluefruit52"</span><span class="pun">);</span></li><li class="L8"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="pln">setConnectCallback</span><span class="pun">(</span><span class="pln">connect_callback</span><span class="pun">);</span></li><li class="L9"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="pln">setDisconnectCallback</span><span class="pun">(</span><span class="pln">disconnect_callback</span><span class="pun">);</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">  </span><span class="com">// Configure and Start Device Information Service</span></li><li class="L2"><span class="pln">  bledis</span><span class="pun">.</span><span class="pln">setManufacturer</span><span class="pun">(</span><span class="str">"Adafruit Industries"</span><span class="pun">);</span></li><li class="L3"><span class="pln">  bledis</span><span class="pun">.</span><span class="pln">setModel</span><span class="pun">(</span><span class="str">"Bluefruit Feather52"</span><span class="pun">);</span></li><li class="L4"><span class="pln">  bledis</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">  </span><span class="com">// Configure and Start BLE Uart Service</span></li><li class="L7"><span class="pln">  bleuart</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="pln">  </span><span class="com">// Start BLE Battery Service</span></li><li class="L0"><span class="pln">  blebas</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L1"><span class="pln">  blebas</span><span class="pun">.</span><span class="pln">update</span><span class="pun">(</span><span class="lit">100</span><span class="pun">);</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="pln">  </span><span class="com">// Set up Advertising Packet</span></li><li class="L4"><span class="pln">  setupAdv</span><span class="pun">();</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">  </span><span class="com">// Start Advertising</span></li><li class="L7"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">start</span><span class="pun">();</span></li><li class="L8"><span class="pun">}</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="kwd">void</span><span class="pln"> setupAdv</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">addFlags</span><span class="pun">(</span><span class="pln">BLE_GAP_ADV_FLAGS_LE_ONLY_GENERAL_DISC_MODE</span><span class="pun">);</span></li><li class="L3"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">addTxPower</span><span class="pun">();</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">  </span><span class="com">// Include bleuart 128-bit uuid</span></li><li class="L6"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">addService</span><span class="pun">(</span><span class="pln">bleuart</span><span class="pun">);</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">  </span><span class="com">// There is no room for Name in Advertising packet</span></li><li class="L9"><span class="pln">  </span><span class="com">// Use Scan response for Name</span></li><li class="L0"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">ScanResponse</span><span class="pun">.</span><span class="pln">addName</span><span class="pun">();</span></li><li class="L1"><span class="pun">}</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="kwd">void</span><span class="pln"> loop</span><span class="pun">()</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="pln">  </span><span class="com">// Blinky!</span></li><li class="L6"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">blinkyms</span><span class="pun">+</span><span class="pln">BLINKY_MS </span><span class="pun">&lt;</span><span class="pln"> millis</span><span class="pun">())</span><span class="pln"> </span><span class="pun">{</span></li><li class="L7"><span class="pln">    blinkyms </span><span class="pun">=</span><span class="pln"> millis</span><span class="pun">();</span></li><li class="L8"><span class="pln">    digitalToggle</span><span class="pun">(</span><span class="pln">STATUS_LED</span><span class="pun">);</span></li><li class="L9"><span class="pln">  </span><span class="pun">}</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">  </span><span class="com">// Forward from Serial to BLEUART</span></li><li class="L2"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">available</span><span class="pun">())</span></li><li class="L3"><span class="pln">  </span><span class="pun">{</span></li><li class="L4"><span class="pln">    </span><span class="com">// Delay to get enough input data since we have a</span></li><li class="L5"><span class="pln">    </span><span class="com">// limited amount of space in the transmit buffer</span></li><li class="L6"><span class="pln">    delay</span><span class="pun">(</span><span class="lit">2</span><span class="pun">);</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">    </span><span class="typ">uint8_t</span><span class="pln"> buf</span><span class="pun">[</span><span class="lit">64</span><span class="pun">];</span></li><li class="L9"><span class="pln">    </span><span class="kwd">int</span><span class="pln"> count </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">readBytes</span><span class="pun">(</span><span class="pln">buf</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">sizeof</span><span class="pun">(</span><span class="pln">buf</span><span class="pun">));</span></li><li class="L0"><span class="pln">    bleuart</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="pln"> buf</span><span class="pun">,</span><span class="pln"> count </span><span class="pun">);</span></li><li class="L1"><span class="pln">  </span><span class="pun">}</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="pln">  </span><span class="com">// Forward from BLEUART to Serial</span></li><li class="L4"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> bleuart</span><span class="pun">.</span><span class="pln">available</span><span class="pun">()</span><span class="pln"> </span><span class="pun">)</span></li><li class="L5"><span class="pln">  </span><span class="pun">{</span></li><li class="L6"><span class="pln">    </span><span class="typ">uint8_t</span><span class="pln"> ch</span><span class="pun">;</span></li><li class="L7"><span class="pln">    ch </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="typ">uint8_t</span><span class="pun">)</span><span class="pln"> bleuart</span><span class="pun">.</span><span class="pln">read</span><span class="pun">();</span></li><li class="L8"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="pln">ch</span><span class="pun">);</span></li><li class="L9"><span class="pln">  </span><span class="pun">}</span></li><li class="L0"><span class="pun">}</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="kwd">void</span><span class="pln"> connect_callback</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span></li><li class="L3"><span class="pun">{</span></li><li class="L4"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Connected"</span><span class="pun">);</span></li><li class="L5"><span class="pun">}</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="kwd">void</span><span class="pln"> disconnect_callback</span><span class="pun">(</span><span class="typ">uint8_t</span><span class="pln"> reason</span><span class="pun">)</span></li><li class="L8"><span class="pun">{</span></li><li class="L9"><span class="pln">  </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span><span class="pln"> reason</span><span class="pun">;</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">();</span></li><li class="L2"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Disconnected"</span><span class="pun">);</span></li><li class="L3"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Bluefruit will start advertising again"</span><span class="pun">);</span></li><li class="L4"><span class="pun">}</span></li></ol></pre>
</div>
</div>
</div>
<div class="page-title-wrapper">
<h1 class="headline">
<span id="bleclientuart">BLEClientUart</span>
</h1>

</div>
<div class="page-content all-page-view-content">
<div class="">
<div class="element row-fluid build-alert">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
The Bluefruit nRF52 BSP codebase is undergoing active development based on customer feedback and testing. As such, the class documentation here is incomplete, and you should consult the Github repo for the latest code and API developments: <a href="https://goo.gl/LdEx62">https://goo.gl/LdEx62</a>
</div>
</div>
<div class="row-fluid build-text">
<p>BLEClientUart is a wrapper class for the client side of the NUS or 'Nordic UART Service' (aka 'BLE UART'). It is only required when your Bluefruit nRF52 board is acting as Central communicating to other BLE peripherals that expose the&nbsp;<a href="https://learn.adafruit.com/bluefruit-nrf52-feather-learning-guide/bleuart">BLEUart</a>&nbsp;service.</p>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#api-30-3" class="anchor-link"><span class="fa fa-link"></span></a><span id="api-30-3" class="anchor-link-target"></span><span id="api" class="anchor-link-target"></span>API</h1>
<p>BLEClientUart has the following public API:</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/11269/elements/2979326/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">// Callback Signatures
typedef void (*rx_callback_t) (BLEClientUart&amp; svc);

BLEClientUart(uint16_t fifo_depth = BLE_UART_DEFAULT_FIFO_DEPTH);

virtual bool  begin(void);
virtual bool  discover(uint16_t conn_handle);

void setRxCallback( rx_callback_t fp);

bool enableTXD(void);
bool disableTXD(void);

// Stream API
virtual int       read       ( void );
virtual int       read       ( uint8_t * buf, size_t size );
        int       read       ( char    * buf, size_t size ) { return read( (uint8_t*) buf, size); }
virtual size_t    write      ( uint8_t b );
virtual size_t    write      ( const uint8_t *content, size_t len );
virtual int       available  ( void );
virtual int       peek       ( void );
virtual void      flush      ( void );</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="com">// Callback Signatures</span></li><li class="L1"><span class="kwd">typedef</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> </span><span class="pun">(*</span><span class="typ">rx_callback_t</span><span class="pun">)</span><span class="pln"> </span><span class="pun">(</span><span class="typ">BLEClientUart</span><span class="pun">&amp;</span><span class="pln"> svc</span><span class="pun">);</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="typ">BLEClientUart</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> fifo_depth </span><span class="pun">=</span><span class="pln"> BLE_UART_DEFAULT_FIFO_DEPTH</span><span class="pun">);</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="kwd">virtual</span><span class="pln"> </span><span class="kwd">bool</span><span class="pln">  </span><span class="kwd">begin</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L6"><span class="kwd">virtual</span><span class="pln"> </span><span class="kwd">bool</span><span class="pln">  discover</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> conn_handle</span><span class="pun">);</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="kwd">void</span><span class="pln"> setRxCallback</span><span class="pun">(</span><span class="pln"> </span><span class="typ">rx_callback_t</span><span class="pln"> fp</span><span class="pun">);</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="kwd">bool</span><span class="pln"> enableTXD</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L1"><span class="kwd">bool</span><span class="pln"> disableTXD</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="com">// Stream API</span></li><li class="L4"><span class="kwd">virtual</span><span class="pln"> </span><span class="kwd">int</span><span class="pln">       read       </span><span class="pun">(</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> </span><span class="pun">);</span></li><li class="L5"><span class="kwd">virtual</span><span class="pln"> </span><span class="kwd">int</span><span class="pln">       read       </span><span class="pun">(</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> buf</span><span class="pun">,</span><span class="pln"> </span><span class="typ">size_t</span><span class="pln"> size </span><span class="pun">);</span></li><li class="L6"><span class="pln">        </span><span class="kwd">int</span><span class="pln">       read       </span><span class="pun">(</span><span class="pln"> </span><span class="kwd">char</span><span class="pln">    </span><span class="pun">*</span><span class="pln"> buf</span><span class="pun">,</span><span class="pln"> </span><span class="typ">size_t</span><span class="pln"> size </span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> read</span><span class="pun">(</span><span class="pln"> </span><span class="pun">(</span><span class="typ">uint8_t</span><span class="pun">*)</span><span class="pln"> buf</span><span class="pun">,</span><span class="pln"> size</span><span class="pun">);</span><span class="pln"> </span><span class="pun">}</span></li><li class="L7"><span class="kwd">virtual</span><span class="pln"> </span><span class="typ">size_t</span><span class="pln">    write      </span><span class="pun">(</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pln"> b </span><span class="pun">);</span></li><li class="L8"><span class="kwd">virtual</span><span class="pln"> </span><span class="typ">size_t</span><span class="pln">    write      </span><span class="pun">(</span><span class="pln"> </span><span class="kwd">const</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pln"> </span><span class="pun">*</span><span class="pln">content</span><span class="pun">,</span><span class="pln"> </span><span class="typ">size_t</span><span class="pln"> len </span><span class="pun">);</span></li><li class="L9"><span class="kwd">virtual</span><span class="pln"> </span><span class="kwd">int</span><span class="pln">       available  </span><span class="pun">(</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> </span><span class="pun">);</span></li><li class="L0"><span class="kwd">virtual</span><span class="pln"> </span><span class="kwd">int</span><span class="pln">       peek       </span><span class="pun">(</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> </span><span class="pun">);</span></li><li class="L1"><span class="kwd">virtual</span><span class="pln"> </span><span class="kwd">void</span><span class="pln">      flush      </span><span class="pun">(</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> </span><span class="pun">);</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#examples-30-5" class="anchor-link"><span class="fa fa-link"></span></a><span id="examples-30-5" class="anchor-link-target"></span><span id="examples" class="anchor-link-target"></span>Examples</h1>
<p>The following example shows how to use the BLEClientUart helper class.</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/11269/elements/2979328/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">#include &lt;bluefruit.h&gt;

BLEClientDis  clientDis;
BLEClientUart clientUart;

void setup()
{
  Serial.begin(115200);

  Serial.println("Bluefruit52 Central BLEUART Example");
  Serial.println("-----------------------------------\n");
  
  // Initialize Bluefruit with maximum connections as Peripheral = 0, Central = 1
  // SRAM usage required by SoftDevice will increase dramatically with number of connections
  Bluefruit.begin(0, 1);
  
  Bluefruit.setName("Bluefruit52 Central");

  // Configure DIS client
  clientDis.begin();

  // Init BLE Central Uart Serivce
  clientUart.begin();
  clientUart.setRxCallback(bleuart_rx_callback);

  // Increase Blink rate to different from PrPh advertising mode
  Bluefruit.setConnLedInterval(250);

  // Callbacks for Central
  Bluefruit.Central.setConnectCallback(connect_callback);
  Bluefruit.Central.setDisconnectCallback(disconnect_callback);

  /* Start Central Scanning
   * - Enable auto scan if disconnected
   * - Interval = 100 ms, window = 80 ms
   * - Don't use active scan
   * - Start(timeout) with timeout = 0 will scan forever (until connected)
   */
  Bluefruit.Scanner.setRxCallback(scan_callback);
  Bluefruit.Scanner.restartOnDisconnect(true);
  Bluefruit.Scanner.setInterval(160, 80); // in unit of 0.625 ms
  Bluefruit.Scanner.useActiveScan(false);
  Bluefruit.Scanner.start(0);                   // // 0 = Don't stop scanning after n seconds
}

/**
 * Callback invoked when scanner pick up an advertising data
 * @param report Structural advertising data
 */
void scan_callback(ble_gap_evt_adv_report_t* report)
{
  // Check if advertising contain BleUart service
  if ( Bluefruit.Scanner.checkReportForService(report, clientUart) )
  {
    Serial.print("BLE UART service detected. Connecting ... ");

    // Connect to device with bleuart service in advertising
    Bluefruit.Central.connect(report);
  }
}

/**
 * Callback invoked when an connection is established
 * @param conn_handle
 */
void connect_callback(uint16_t conn_handle)
{
  Serial.println("Connected");

  Serial.print("Dicovering DIS ... ");
  if ( clientDis.discover(conn_handle) )
  {
    Serial.println("Found it");
    char buffer[32+1];
    
    // read and print out Manufacturer
    memset(buffer, 0, sizeof(buffer));
    if ( clientDis.getManufacturer(buffer, sizeof(buffer)) )
    {
      Serial.print("Manufacturer: ");
      Serial.println(buffer);
    }

    // read and print out Model Number
    memset(buffer, 0, sizeof(buffer));
    if ( clientDis.getModel(buffer, sizeof(buffer)) )
    {
      Serial.print("Model: ");
      Serial.println(buffer);
    }

    Serial.println();
  }  

  Serial.print("Discovering BLE Uart Service ... ");

  if ( clientUart.discover(conn_handle) )
  {
    Serial.println("Found it");

    Serial.println("Enable TXD's notify");
    clientUart.enableTXD();

    Serial.println("Ready to receive from peripheral");
  }else
  {
    Serial.println("Found NONE");
    
    // disconect since we couldn't find bleuart service
    Bluefruit.Central.disconnect(conn_handle);
  }  
}

/**
 * Callback invoked when a connection is dropped
 * @param conn_handle
 * @param reason
 */
void disconnect_callback(uint16_t conn_handle, uint8_t reason)
{
  (void) conn_handle;
  (void) reason;
  
  Serial.println("Disconnected");
}

/**
 * Callback invoked when uart received data
 * @param uart_svc Reference object to the service where the data 
 * arrived. In this example it is clientUart
 */
void bleuart_rx_callback(BLEClientUart&amp; uart_svc)
{
  Serial.print("[RX]: ");
  
  while ( uart_svc.available() )
  {
    Serial.print( (char) uart_svc.read() );
  }

  Serial.println();
}

void loop()
{
  if ( Bluefruit.Central.connected() )
  {
    // Not discovered yet
    if ( clientUart.discovered() )
    {
      // Discovered means in working state
      // Get Serial input and send to Peripheral
      if ( Serial.available() )
      {
        delay(2); // delay a bit for all characters to arrive
        
        char str[20+1] = { 0 };
        Serial.readBytes(str, 20);
        
        clientUart.print( str );
      }
    }
  }
}
</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;bluefruit.h&gt;</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="typ">BLEClientDis</span><span class="pln">  clientDis</span><span class="pun">;</span></li><li class="L3"><span class="typ">BLEClientUart</span><span class="pln"> clientUart</span><span class="pun">;</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="kwd">void</span><span class="pln"> setup</span><span class="pun">()</span></li><li class="L6"><span class="pun">{</span></li><li class="L7"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">(</span><span class="lit">115200</span><span class="pun">);</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Bluefruit52 Central BLEUART Example"</span><span class="pun">);</span></li><li class="L0"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"-----------------------------------\n"</span><span class="pun">);</span></li><li class="L1"><span class="pln">  </span></li><li class="L2"><span class="pln">  </span><span class="com">// Initialize Bluefruit with maximum connections as Peripheral = 0, Central = 1</span></li><li class="L3"><span class="pln">  </span><span class="com">// SRAM usage required by SoftDevice will increase dramatically with number of connections</span></li><li class="L4"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">(</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">);</span></li><li class="L5"><span class="pln">  </span></li><li class="L6"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="pln">setName</span><span class="pun">(</span><span class="str">"Bluefruit52 Central"</span><span class="pun">);</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">  </span><span class="com">// Configure DIS client</span></li><li class="L9"><span class="pln">  clientDis</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">  </span><span class="com">// Init BLE Central Uart Serivce</span></li><li class="L2"><span class="pln">  clientUart</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L3"><span class="pln">  clientUart</span><span class="pun">.</span><span class="pln">setRxCallback</span><span class="pun">(</span><span class="pln">bleuart_rx_callback</span><span class="pun">);</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">  </span><span class="com">// Increase Blink rate to different from PrPh advertising mode</span></li><li class="L6"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="pln">setConnLedInterval</span><span class="pun">(</span><span class="lit">250</span><span class="pun">);</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">  </span><span class="com">// Callbacks for Central</span></li><li class="L9"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Central</span><span class="pun">.</span><span class="pln">setConnectCallback</span><span class="pun">(</span><span class="pln">connect_callback</span><span class="pun">);</span></li><li class="L0"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Central</span><span class="pun">.</span><span class="pln">setDisconnectCallback</span><span class="pun">(</span><span class="pln">disconnect_callback</span><span class="pun">);</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="pln">  </span><span class="com">/* Start Central Scanning</span></li><li class="L3"><span class="com">   * - Enable auto scan if disconnected</span></li><li class="L4"><span class="com">   * - Interval = 100 ms, window = 80 ms</span></li><li class="L5"><span class="com">   * - Don't use active scan</span></li><li class="L6"><span class="com">   * - Start(timeout) with timeout = 0 will scan forever (until connected)</span></li><li class="L7"><span class="com">   */</span></li><li class="L8"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Scanner</span><span class="pun">.</span><span class="pln">setRxCallback</span><span class="pun">(</span><span class="pln">scan_callback</span><span class="pun">);</span></li><li class="L9"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Scanner</span><span class="pun">.</span><span class="pln">restartOnDisconnect</span><span class="pun">(</span><span class="kwd">true</span><span class="pun">);</span></li><li class="L0"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Scanner</span><span class="pun">.</span><span class="pln">setInterval</span><span class="pun">(</span><span class="lit">160</span><span class="pun">,</span><span class="pln"> </span><span class="lit">80</span><span class="pun">);</span><span class="pln"> </span><span class="com">// in unit of 0.625 ms</span></li><li class="L1"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Scanner</span><span class="pun">.</span><span class="pln">useActiveScan</span><span class="pun">(</span><span class="kwd">false</span><span class="pun">);</span></li><li class="L2"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Scanner</span><span class="pun">.</span><span class="pln">start</span><span class="pun">(</span><span class="lit">0</span><span class="pun">);</span><span class="pln">                   </span><span class="com">// // 0 = Don't stop scanning after n seconds</span></li><li class="L3"><span class="pun">}</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="com">/**</span></li><li class="L6"><span class="com"> * Callback invoked when scanner pick up an advertising data</span></li><li class="L7"><span class="com"> * @param report Structural advertising data</span></li><li class="L8"><span class="com"> */</span></li><li class="L9"><span class="kwd">void</span><span class="pln"> scan_callback</span><span class="pun">(</span><span class="typ">ble_gap_evt_adv_report_t</span><span class="pun">*</span><span class="pln"> report</span><span class="pun">)</span></li><li class="L0"><span class="pun">{</span></li><li class="L1"><span class="pln">  </span><span class="com">// Check if advertising contain BleUart service</span></li><li class="L2"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Scanner</span><span class="pun">.</span><span class="pln">checkReportForService</span><span class="pun">(</span><span class="pln">report</span><span class="pun">,</span><span class="pln"> clientUart</span><span class="pun">)</span><span class="pln"> </span><span class="pun">)</span></li><li class="L3"><span class="pln">  </span><span class="pun">{</span></li><li class="L4"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"BLE UART service detected. Connecting ... "</span><span class="pun">);</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">    </span><span class="com">// Connect to device with bleuart service in advertising</span></li><li class="L7"><span class="pln">    </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Central</span><span class="pun">.</span><span class="pln">connect</span><span class="pun">(</span><span class="pln">report</span><span class="pun">);</span></li><li class="L8"><span class="pln">  </span><span class="pun">}</span></li><li class="L9"><span class="pun">}</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="com">/**</span></li><li class="L2"><span class="com"> * Callback invoked when an connection is established</span></li><li class="L3"><span class="com"> * @param conn_handle</span></li><li class="L4"><span class="com"> */</span></li><li class="L5"><span class="kwd">void</span><span class="pln"> connect_callback</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> conn_handle</span><span class="pun">)</span></li><li class="L6"><span class="pun">{</span></li><li class="L7"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Connected"</span><span class="pun">);</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"Dicovering DIS ... "</span><span class="pun">);</span></li><li class="L0"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> clientDis</span><span class="pun">.</span><span class="pln">discover</span><span class="pun">(</span><span class="pln">conn_handle</span><span class="pun">)</span><span class="pln"> </span><span class="pun">)</span></li><li class="L1"><span class="pln">  </span><span class="pun">{</span></li><li class="L2"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Found it"</span><span class="pun">);</span></li><li class="L3"><span class="pln">    </span><span class="kwd">char</span><span class="pln"> buffer</span><span class="pun">[</span><span class="lit">32</span><span class="pun">+</span><span class="lit">1</span><span class="pun">];</span></li><li class="L4"><span class="pln">    </span></li><li class="L5"><span class="pln">    </span><span class="com">// read and print out Manufacturer</span></li><li class="L6"><span class="pln">    memset</span><span class="pun">(</span><span class="pln">buffer</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">sizeof</span><span class="pun">(</span><span class="pln">buffer</span><span class="pun">));</span></li><li class="L7"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> clientDis</span><span class="pun">.</span><span class="pln">getManufacturer</span><span class="pun">(</span><span class="pln">buffer</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">sizeof</span><span class="pun">(</span><span class="pln">buffer</span><span class="pun">))</span><span class="pln"> </span><span class="pun">)</span></li><li class="L8"><span class="pln">    </span><span class="pun">{</span></li><li class="L9"><span class="pln">      </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"Manufacturer: "</span><span class="pun">);</span></li><li class="L0"><span class="pln">      </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="pln">buffer</span><span class="pun">);</span></li><li class="L1"><span class="pln">    </span><span class="pun">}</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="pln">    </span><span class="com">// read and print out Model Number</span></li><li class="L4"><span class="pln">    memset</span><span class="pun">(</span><span class="pln">buffer</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">sizeof</span><span class="pun">(</span><span class="pln">buffer</span><span class="pun">));</span></li><li class="L5"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> clientDis</span><span class="pun">.</span><span class="pln">getModel</span><span class="pun">(</span><span class="pln">buffer</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">sizeof</span><span class="pun">(</span><span class="pln">buffer</span><span class="pun">))</span><span class="pln"> </span><span class="pun">)</span></li><li class="L6"><span class="pln">    </span><span class="pun">{</span></li><li class="L7"><span class="pln">      </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"Model: "</span><span class="pun">);</span></li><li class="L8"><span class="pln">      </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="pln">buffer</span><span class="pun">);</span></li><li class="L9"><span class="pln">    </span><span class="pun">}</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">();</span></li><li class="L2"><span class="pln">  </span><span class="pun">}</span><span class="pln">  </span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"Discovering BLE Uart Service ... "</span><span class="pun">);</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> clientUart</span><span class="pun">.</span><span class="pln">discover</span><span class="pun">(</span><span class="pln">conn_handle</span><span class="pun">)</span><span class="pln"> </span><span class="pun">)</span></li><li class="L7"><span class="pln">  </span><span class="pun">{</span></li><li class="L8"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Found it"</span><span class="pun">);</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Enable TXD's notify"</span><span class="pun">);</span></li><li class="L1"><span class="pln">    clientUart</span><span class="pun">.</span><span class="pln">enableTXD</span><span class="pun">();</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Ready to receive from peripheral"</span><span class="pun">);</span></li><li class="L4"><span class="pln">  </span><span class="pun">}</span><span class="kwd">else</span></li><li class="L5"><span class="pln">  </span><span class="pun">{</span></li><li class="L6"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Found NONE"</span><span class="pun">);</span></li><li class="L7"><span class="pln">    </span></li><li class="L8"><span class="pln">    </span><span class="com">// disconect since we couldn't find bleuart service</span></li><li class="L9"><span class="pln">    </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Central</span><span class="pun">.</span><span class="pln">disconnect</span><span class="pun">(</span><span class="pln">conn_handle</span><span class="pun">);</span></li><li class="L0"><span class="pln">  </span><span class="pun">}</span><span class="pln">  </span></li><li class="L1"><span class="pun">}</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="com">/**</span></li><li class="L4"><span class="com"> * Callback invoked when a connection is dropped</span></li><li class="L5"><span class="com"> * @param conn_handle</span></li><li class="L6"><span class="com"> * @param reason</span></li><li class="L7"><span class="com"> */</span></li><li class="L8"><span class="kwd">void</span><span class="pln"> disconnect_callback</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> conn_handle</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pln"> reason</span><span class="pun">)</span></li><li class="L9"><span class="pun">{</span></li><li class="L0"><span class="pln">  </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span><span class="pln"> conn_handle</span><span class="pun">;</span></li><li class="L1"><span class="pln">  </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span><span class="pln"> reason</span><span class="pun">;</span></li><li class="L2"><span class="pln">  </span></li><li class="L3"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Disconnected"</span><span class="pun">);</span></li><li class="L4"><span class="pun">}</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="com">/**</span></li><li class="L7"><span class="com"> * Callback invoked when uart received data</span></li><li class="L8"><span class="com"> * @param uart_svc Reference object to the service where the data </span></li><li class="L9"><span class="com"> * arrived. In this example it is clientUart</span></li><li class="L0"><span class="com"> */</span></li><li class="L1"><span class="kwd">void</span><span class="pln"> bleuart_rx_callback</span><span class="pun">(</span><span class="typ">BLEClientUart</span><span class="pun">&amp;</span><span class="pln"> uart_svc</span><span class="pun">)</span></li><li class="L2"><span class="pun">{</span></li><li class="L3"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"[RX]: "</span><span class="pun">);</span></li><li class="L4"><span class="pln">  </span></li><li class="L5"><span class="pln">  </span><span class="kwd">while</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> uart_svc</span><span class="pun">.</span><span class="pln">available</span><span class="pun">()</span><span class="pln"> </span><span class="pun">)</span></li><li class="L6"><span class="pln">  </span><span class="pun">{</span></li><li class="L7"><span class="pln">    </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">char</span><span class="pun">)</span><span class="pln"> uart_svc</span><span class="pun">.</span><span class="pln">read</span><span class="pun">()</span><span class="pln"> </span><span class="pun">);</span></li><li class="L8"><span class="pln">  </span><span class="pun">}</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">();</span></li><li class="L1"><span class="pun">}</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="kwd">void</span><span class="pln"> loop</span><span class="pun">()</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Central</span><span class="pun">.</span><span class="pln">connected</span><span class="pun">()</span><span class="pln"> </span><span class="pun">)</span></li><li class="L6"><span class="pln">  </span><span class="pun">{</span></li><li class="L7"><span class="pln">    </span><span class="com">// Not discovered yet</span></li><li class="L8"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> clientUart</span><span class="pun">.</span><span class="pln">discovered</span><span class="pun">()</span><span class="pln"> </span><span class="pun">)</span></li><li class="L9"><span class="pln">    </span><span class="pun">{</span></li><li class="L0"><span class="pln">      </span><span class="com">// Discovered means in working state</span></li><li class="L1"><span class="pln">      </span><span class="com">// Get Serial input and send to Peripheral</span></li><li class="L2"><span class="pln">      </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">available</span><span class="pun">()</span><span class="pln"> </span><span class="pun">)</span></li><li class="L3"><span class="pln">      </span><span class="pun">{</span></li><li class="L4"><span class="pln">        delay</span><span class="pun">(</span><span class="lit">2</span><span class="pun">);</span><span class="pln"> </span><span class="com">// delay a bit for all characters to arrive</span></li><li class="L5"><span class="pln">        </span></li><li class="L6"><span class="pln">        </span><span class="kwd">char</span><span class="pln"> str</span><span class="pun">[</span><span class="lit">20</span><span class="pun">+</span><span class="lit">1</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="lit">0</span><span class="pln"> </span><span class="pun">};</span></li><li class="L7"><span class="pln">        </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">readBytes</span><span class="pun">(</span><span class="pln">str</span><span class="pun">,</span><span class="pln"> </span><span class="lit">20</span><span class="pun">);</span></li><li class="L8"><span class="pln">        </span></li><li class="L9"><span class="pln">        clientUart</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="pln"> str </span><span class="pun">);</span></li><li class="L0"><span class="pln">      </span><span class="pun">}</span></li><li class="L1"><span class="pln">    </span><span class="pun">}</span></li><li class="L2"><span class="pln">  </span><span class="pun">}</span></li><li class="L3"><span class="pun">}</span></li></ol></pre>
</div>
</div>
</div>
<div class="page-title-wrapper">
<h1 class="headline">
<span id="blebeacon">BLEBeacon</span>
</h1>

</div>
<div class="page-content all-page-view-content">
<div class="">
<div class="element row-fluid build-alert">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
The Bluefruit nRF52 BSP codebase is undergoing active development based on customer feedback and testing. As such, the class documentation here is incomplete, and you should consult the Github repo for the latest code and API developments: <a href="https://goo.gl/LdEx62">https://goo.gl/LdEx62</a>
</div>
</div>
<div class="row-fluid build-text">
<p>The BLEBeacon helper class allows you to easily configure the nRF52 as a 'Beacon', which uses the advertising packet to send out a specifically format chunk of data to any devices in listening range.</p>
<p>The following values must be set in order to generate a valid 'Beacon' packet:</p>
<ul>
<li>
<strong>Manufacturer ID</strong>: A 16-bit value (<a href="https://www.bluetooth.com/specifications/assigned-numbers/company-identifiers" target="_blank">registered with the Bluetooth SIG</a>!) that identifies the manufacturer.</li>
<li>
<strong>Major</strong>: A 16-bit 'Major' number, used to differentiate beacon nodes.</li>
<li>
<strong>Minor</strong>: A 16-bit 'Minor' number, used to differentiate beacon nodes.</li>
<li>
<strong>RSSI @ 1M</strong>: A signed 8-bit value (int8_t) indicating the RSSI measurement at 1m distance from the node, used to estimate distance to the beacon itself.</li>
</ul>
<p>These values can either be set in the constructor, or via the individual functions exposed as part of this helper class.</p>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#api-31-3" class="anchor-link"><span class="fa fa-link"></span></a><span id="api-31-3" class="anchor-link-target"></span><span id="api" class="anchor-link-target"></span>API</h1>
<p>BLEBeacon has the following public API:</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/9048/elements/2860768/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">// Constructors
BLEBeacon(void);
BLEBeacon(uint8_t const uuid128[16]);
BLEBeacon(uint8_t const uuid128[16], uint16_t major, uint16_t minor, int8_t rssi);

// Set the beacon payload values
void setManufacturer(uint16_t manfacturer);
void setUuid(uint8_t const uuid128[16]);
void setMajorMinor(uint16_t major, uint16_t minor);
void setRssiAt1m(int8_t rssi);

// Start advertising
bool start(void);
bool start(BLEAdvertising&amp; adv);</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="com">// Constructors</span></li><li class="L1"><span class="typ">BLEBeacon</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L2"><span class="typ">BLEBeacon</span><span class="pun">(</span><span class="typ">uint8_t</span><span class="pln"> </span><span class="kwd">const</span><span class="pln"> uuid128</span><span class="pun">[</span><span class="lit">16</span><span class="pun">]);</span></li><li class="L3"><span class="typ">BLEBeacon</span><span class="pun">(</span><span class="typ">uint8_t</span><span class="pln"> </span><span class="kwd">const</span><span class="pln"> uuid128</span><span class="pun">[</span><span class="lit">16</span><span class="pun">],</span><span class="pln"> </span><span class="typ">uint16_t</span><span class="pln"> major</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint16_t</span><span class="pln"> minor</span><span class="pun">,</span><span class="pln"> </span><span class="typ">int8_t</span><span class="pln"> rssi</span><span class="pun">);</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="com">// Set the beacon payload values</span></li><li class="L6"><span class="kwd">void</span><span class="pln"> setManufacturer</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> manfacturer</span><span class="pun">);</span></li><li class="L7"><span class="kwd">void</span><span class="pln"> setUuid</span><span class="pun">(</span><span class="typ">uint8_t</span><span class="pln"> </span><span class="kwd">const</span><span class="pln"> uuid128</span><span class="pun">[</span><span class="lit">16</span><span class="pun">]);</span></li><li class="L8"><span class="kwd">void</span><span class="pln"> setMajorMinor</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> major</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint16_t</span><span class="pln"> minor</span><span class="pun">);</span></li><li class="L9"><span class="kwd">void</span><span class="pln"> setRssiAt1m</span><span class="pun">(</span><span class="typ">int8_t</span><span class="pln"> rssi</span><span class="pun">);</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="com">// Start advertising</span></li><li class="L2"><span class="kwd">bool</span><span class="pln"> start</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L3"><span class="kwd">bool</span><span class="pln"> start</span><span class="pun">(</span><span class="typ">BLEAdvertising</span><span class="pun">&amp;</span><span class="pln"> adv</span><span class="pun">);</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<p>In addition to these functions, the BLEAdvertising class (accessible via `Bluefruit.Advertising.*`) exposes the following function to assign Beacon payload to the advertising payload:</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/9048/elements/2860770/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">bool setBeacon(BLEBeacon&amp; beacon);</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="kwd">bool</span><span class="pln"> setBeacon</span><span class="pun">(</span><span class="typ">BLEBeacon</span><span class="pun">&amp;</span><span class="pln"> beacon</span><span class="pun">);</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<p>See the example below for a concrete usage example.</p>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#example-31-8" class="anchor-link"><span class="fa fa-link"></span></a><span id="example-31-8" class="anchor-link-target"></span><span id="example" class="anchor-link-target"></span>Example</h1>
<p>The following example will configure the nRF52 to advertise a 'Beacon' payload:</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/9048/elements/2860773/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">#include &lt;bluefruit.h&gt;

// Beacon uses the Manufacturer Specific Data field in the advertising
// packet, which means you must provide a valid Manufacturer ID. Update
// the field below to an appropriate value. For a list of valid IDs see:
// https://www.bluetooth.com/specifications/assigned-numbers/company-identifiers
// 0x004C is Apple (for example)
#define MANUFACTURER_ID   0x004C 

// AirLocate UUID: E2C56DB5-DFFB-48D2-B060-D0F5A71096E0
uint8_t beaconUuid[16] = 
{ 
  0xE2, 0xC5, 0x6D, 0xB5, 0xDF, 0xFB, 0x48, 0xD2, 
  0xB0, 0x60, 0xD0, 0xF5, 0xA7, 0x10, 0x96, 0xE0, 
};

// A valid Beacon packet consists of the following information:
// UUID, Major, Minor, RSSI @ 1M
BLEBeacon beacon(beaconUuid, 0x0001, 0x0000, -54);

void setup() 
{
  Serial.begin(115200);

  Serial.println("Bluefruit52 Beacon Example");

  Bluefruit.begin();
  Bluefruit.setName("Bluefruit52");

  // Manufacturer ID is required for Manufacturer Specific Data
  beacon.setManufacturer(MANUFACTURER_ID);

  // Setup the advertising packet
  setupAdv();

  // Start advertising
  Bluefruit.Advertising.start();
}

void setupAdv(void)
{  
  // Set the beacon payload using the BLEBeacon class populated
  // earlier in this example
  Bluefruit.Advertising.setBeacon(beacon);

  // char* adv = Bluefruit.Advertising.getData();

  // There is no room left for 'Name' in the advertising packet
  // Use the optinal secondary Scan Response packet for 'Name' instead
  Bluefruit.ScanResponse.addName();
}

void loop() 
{
  // Toggle both LEDs every second
  digitalToggle(LED_BUILTIN);
  delay(1000);
}</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;bluefruit.h&gt;</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="com">// Beacon uses the Manufacturer Specific Data field in the advertising</span></li><li class="L3"><span class="com">// packet, which means you must provide a valid Manufacturer ID. Update</span></li><li class="L4"><span class="com">// the field below to an appropriate value. For a list of valid IDs see:</span></li><li class="L5"><span class="com">// https://www.bluetooth.com/specifications/assigned-numbers/company-identifiers</span></li><li class="L6"><span class="com">// 0x004C is Apple (for example)</span></li><li class="L7"><span class="com">#define</span><span class="pln"> MANUFACTURER_ID   </span><span class="lit">0x004C</span><span class="pln"> </span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="com">// AirLocate UUID: E2C56DB5-DFFB-48D2-B060-D0F5A71096E0</span></li><li class="L0"><span class="typ">uint8_t</span><span class="pln"> beaconUuid</span><span class="pun">[</span><span class="lit">16</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span></li><li class="L1"><span class="pun">{</span><span class="pln"> </span></li><li class="L2"><span class="pln">  </span><span class="lit">0xE2</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0xC5</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x6D</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0xB5</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0xDF</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0xFB</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x48</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0xD2</span><span class="pun">,</span><span class="pln"> </span></li><li class="L3"><span class="pln">  </span><span class="lit">0xB0</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x60</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0xD0</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0xF5</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0xA7</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x10</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x96</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0xE0</span><span class="pun">,</span><span class="pln"> </span></li><li class="L4"><span class="pun">};</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="com">// A valid Beacon packet consists of the following information:</span></li><li class="L7"><span class="com">// UUID, Major, Minor, RSSI @ 1M</span></li><li class="L8"><span class="typ">BLEBeacon</span><span class="pln"> beacon</span><span class="pun">(</span><span class="pln">beaconUuid</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x0001</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0x0000</span><span class="pun">,</span><span class="pln"> </span><span class="pun">-</span><span class="lit">54</span><span class="pun">);</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="kwd">void</span><span class="pln"> setup</span><span class="pun">()</span><span class="pln"> </span></li><li class="L1"><span class="pun">{</span></li><li class="L2"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">(</span><span class="lit">115200</span><span class="pun">);</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Bluefruit52 Beacon Example"</span><span class="pun">);</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L7"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="pln">setName</span><span class="pun">(</span><span class="str">"Bluefruit52"</span><span class="pun">);</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="pln">  </span><span class="com">// Manufacturer ID is required for Manufacturer Specific Data</span></li><li class="L0"><span class="pln">  beacon</span><span class="pun">.</span><span class="pln">setManufacturer</span><span class="pun">(</span><span class="pln">MANUFACTURER_ID</span><span class="pun">);</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="pln">  </span><span class="com">// Setup the advertising packet</span></li><li class="L3"><span class="pln">  setupAdv</span><span class="pun">();</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">  </span><span class="com">// Start advertising</span></li><li class="L6"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">start</span><span class="pun">();</span></li><li class="L7"><span class="pun">}</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="kwd">void</span><span class="pln"> setupAdv</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span></li><li class="L0"><span class="pun">{</span><span class="pln">  </span></li><li class="L1"><span class="pln">  </span><span class="com">// Set the beacon payload using the BLEBeacon class populated</span></li><li class="L2"><span class="pln">  </span><span class="com">// earlier in this example</span></li><li class="L3"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">setBeacon</span><span class="pun">(</span><span class="pln">beacon</span><span class="pun">);</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">  </span><span class="com">// char* adv = Bluefruit.Advertising.getData();</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="pln">  </span><span class="com">// There is no room left for 'Name' in the advertising packet</span></li><li class="L8"><span class="pln">  </span><span class="com">// Use the optinal secondary Scan Response packet for 'Name' instead</span></li><li class="L9"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">ScanResponse</span><span class="pun">.</span><span class="pln">addName</span><span class="pun">();</span></li><li class="L0"><span class="pun">}</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="kwd">void</span><span class="pln"> loop</span><span class="pun">()</span><span class="pln"> </span></li><li class="L3"><span class="pun">{</span></li><li class="L4"><span class="pln">  </span><span class="com">// Toggle both LEDs every second</span></li><li class="L5"><span class="pln">  digitalToggle</span><span class="pun">(</span><span class="pln">LED_BUILTIN</span><span class="pun">);</span></li><li class="L6"><span class="pln">  delay</span><span class="pun">(</span><span class="lit">1000</span><span class="pun">);</span></li><li class="L7"><span class="pun">}</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#testing-31-10" class="anchor-link"><span class="fa fa-link"></span></a><span id="testing-31-10" class="anchor-link-target"></span><span id="testing" class="anchor-link-target"></span>Testing</h1>
<p>If you test with the nRF Beacons application (<a href="https://itunes.apple.com/app/nrf-beacons/id879614768?mt=8" target="_blank">iOS</a> or <a href="https://play.google.com/store/apps/details?id=no.nordicsemi.android.nrfbeacon" target="_blank">Android</a>) you can configure the app to look for the UUID, Manufacturer ID, Major and Minor values you provided, and you should be able to see the beacon, as shown in the two screenshots below:</p>
</div>
<div class="element row-fluid build-alert alert-info">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
Make sure that the UUID, Major and Minor values match or the application won't detect your beacon node!
</div>
</div>
<div class="row-fluid build-image">
<a href="./nRF52_bluefruit_Learning_Guide.html#testing">
<img class="39997-asset img-responsive" src="./nRF52_bluefruit_Learning_Guide/microcontrollers_nRFBeacons.png" alt="microcontrollers_nRFBeacons.png">
<span class="image-expand"><i class="fa fa-search-plus"></i></span>
</a> </div>
</div>
</div>
<div class="page-title-wrapper">
<h1 class="headline">
<span id="blemidi">BLEMidi</span>
</h1>

</div>
<div class="page-content all-page-view-content">
<div class="">
<div class="element element element row-fluid build-alert">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
The Bluefruit nRF52 BSP codebase is undergoing active development based on customer feedback and testing. As such, the class documentation here is incomplete, and you should consult the Github repo for the latest code and API developments: <a href="https://goo.gl/LdEx62">https://goo.gl/LdEx62</a>
</div>
</div>
<div class="markdown-element">
<div class="markdown-html">
<p>BLEMidi is a helper class that adds support for sending and receiving MIDI Messages using the <a href="https://www.midi.org/specifications-old/item/bluetooth-le-midi">MIDI over Bluetooth LE specification</a>. BLEMidi supports the full standard MIDI protocol (including SysEx messages), and it also can act as the hardware interface for the <a href="http://playground.arduino.cc/Main/MIDILibrary">Arduino MIDI Library</a>.</p>
</div>
</div>
<div class="markdown-element">
<div class="markdown-html">
<h2>
<a href="./nRF52_bluefruit_Learning_Guide.html#api-32-3" class="anchor-link"><span class="fa fa-link"></span></a><span id="api-32-3" class="anchor-link-target"></span><span id="api" class="anchor-link-target"></span>API</h2>
<p>BLEMidi has the following public API.</p>
</div>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/9049/elements/2860780/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">// Constructor
BLEMidi(uint16_t fifo_depth = 128);

err_t     begin         (void);
bool      notifyEnabled (void);

// Stream API for Arduino MIDI Library Interface
int       read       (void);
size_t    write      (uint8_t b);
int       available  (void);
int       peek       (void);
void      flush      (void);

size_t    write      (const char *str);
size_t    write      (const uint8_t *buffer, size_t size);</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="com">// Constructor</span></li><li class="L1"><span class="typ">BLEMidi</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> fifo_depth </span><span class="pun">=</span><span class="pln"> </span><span class="lit">128</span><span class="pun">);</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="typ">err_t</span><span class="pln">     </span><span class="kwd">begin</span><span class="pln">         </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L4"><span class="kwd">bool</span><span class="pln">      notifyEnabled </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="com">// Stream API for Arduino MIDI Library Interface</span></li><li class="L7"><span class="kwd">int</span><span class="pln">       read       </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L8"><span class="typ">size_t</span><span class="pln">    write      </span><span class="pun">(</span><span class="typ">uint8_t</span><span class="pln"> b</span><span class="pun">);</span></li><li class="L9"><span class="kwd">int</span><span class="pln">       available  </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L0"><span class="kwd">int</span><span class="pln">       peek       </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L1"><span class="kwd">void</span><span class="pln">      flush      </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="typ">size_t</span><span class="pln">    write      </span><span class="pun">(</span><span class="kwd">const</span><span class="pln"> </span><span class="kwd">char</span><span class="pln"> </span><span class="pun">*</span><span class="pln">str</span><span class="pun">);</span></li><li class="L4"><span class="typ">size_t</span><span class="pln">    write      </span><span class="pun">(</span><span class="kwd">const</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pln"> </span><span class="pun">*</span><span class="pln">buffer</span><span class="pun">,</span><span class="pln"> </span><span class="typ">size_t</span><span class="pln"> size</span><span class="pun">);</span></li></ol></pre>
</div>
<div class="markdown-element">
<div class="markdown-html">
<h2>
<a href="./nRF52_bluefruit_Learning_Guide.html#installing-the-arduino-midi-library-32-5" class="anchor-link"><span class="fa fa-link"></span></a><span id="installing-the-arduino-midi-library-32-5" class="anchor-link-target"></span><span id="installing-the-arduino-midi-library" class="anchor-link-target"></span>Installing the Arduino MIDI Library</h2>
<p>BLEMidi is easiest to use when combined with the <a href="http://playground.arduino.cc/Main/MIDILibrary">Arduino MIDI Library</a>. You will need <strong>version 4.3.0 or higher</strong> installed before continuing with the example code.</p>
</div>
</div>
<div class="row-fluid build-image">
<a href="./nRF52_bluefruit_Learning_Guide.html#installing-the-arduino-midi-library">
<img class="40254-asset img-responsive" src="./nRF52_bluefruit_Learning_Guide/microcontrollers_library_manager.png" alt="microcontrollers_library_manager.png">
<span class="image-expand"><i class="fa fa-search-plus"></i></span>
</a> </div>
<div class="markdown-element">
<div class="markdown-html">
<p>Next, select <strong>Communication</strong> from the topic dropdown, and enter <strong>MIDI Library</strong> into the search box. Click the <strong>Install</strong> button to install version 4.3.0 or higher of the <strong>MIDI Library</strong>.</p>
</div>
</div>
<div class="row-fluid build-image">

<video class="img img-responsive" preload="auto" muted="muted" loop="loop" autoplay="autoplay" poster="https://cdn-learn.adafruit.com/assets/assets/000/040/256/medium800thumb/microcontrollers_install.jpg?1489784023">
<source src="https://cdn-learn.adafruit.com/assets/assets/000/040/256/large1024mp4/microcontrollers_install.mp4?1489784023">
<source src="https://cdn-learn.adafruit.com/assets/assets/000/040/256/large1024webm/microcontrollers_install.webm?1489784023" type="video/webm; codecs=vp8,vorbis">
<source src="https://cdn-learn.adafruit.com/assets/assets/000/040/256/large1024ogv/microcontrollers_install.ogv?1489784023" type="video/ogg; codecs=theora,vorbis">
Your browser does not support the video tag.
</video>
<span class="image-expand"><i class="fa fa-search-plus"></i></span>
</div>
<div class="markdown-element">
<div class="markdown-html">
<h2>
<a href="./nRF52_bluefruit_Learning_Guide.html#example-32-9" class="anchor-link"><span class="fa fa-link"></span></a><span id="example-32-9" class="anchor-link-target"></span><span id="example" class="anchor-link-target"></span>Example</h2>
<p>The <strong>blemidi</strong> example demonstrates how to use the BLEMidi helper class with the <strong>Arduino MIDI Library</strong>. The example sends a looping arpeggio, and prints any incoming MIDI note on and note off messages to the Arduino Serial Monitor.</p>
</div>
</div>
<div class="row-fluid build-image">
<a href="./nRF52_bluefruit_Learning_Guide.html#example">
<img class="40257-asset img-responsive" src="./nRF52_bluefruit_Learning_Guide/microcontrollers_Screen_Shot_2017-03-17_at_5.09.58_PM.png" alt="microcontrollers_Screen_Shot_2017-03-17_at_5.09.58_PM.png">
<span class="image-expand"><i class="fa fa-search-plus"></i></span>
</a> </div>
<div class="markdown-element">
<div class="markdown-html">
<p>This example may be out of date, and you should always consult the latest example code in the Bluefruit52 example folder!</p>
</div>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/9049/elements/2860788/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">/*********************************************************************
 This is an example for our nRF52 based Bluefruit LE modules

 Pick one up today in the adafruit shop!

 Adafruit invests time and resources providing this open source code,
 please support Adafruit and open-source hardware by purchasing
 products from Adafruit!

 MIT license, check LICENSE for more information
 All text above, and the splash screen below must be included in
 any redistribution
*********************************************************************/
#include &lt;bluefruit.h&gt;
#include &lt;MIDI.h&gt;

BLEDis bledis;
BLEMidi blemidi;

// Create a new instance of the Arduino MIDI Library,
// and attach BluefruitLE MIDI as the transport.
MIDI_CREATE_BLE_INSTANCE(blemidi);

// Variable that holds the current position in the sequence.
int position = 0;

// Store example melody as an array of note values
byte note_sequence[] = {
  74,78,81,86,90,93,98,102,57,61,66,69,73,78,81,85,88,92,97,100,97,92,88,85,81,78,
  74,69,66,62,57,62,66,69,74,78,81,86,90,93,97,102,97,93,90,85,81,78,73,68,64,61,
  56,61,64,68,74,78,81,86,90,93,98,102
};

void setup()
{
  Serial.begin(115200);
  Serial.println("Adafruit Bluefruit52 MIDI over Bluetooth LE Example");

  Bluefruit.begin();
  Bluefruit.setName("Bluefruit52 MIDI");

  // Setup the on board blue LED to be enabled on CONNECT
  Bluefruit.autoConnLed(true);

  // Configure and Start Device Information Service
  bledis.setManufacturer("Adafruit Industries");
  bledis.setModel("Bluefruit Feather52");
  bledis.begin();

  // Initialize MIDI, and listen to all MIDI channels
  // This will also call blemidi service's begin()
  MIDI.begin(MIDI_CHANNEL_OMNI);

  // Attach the handleNoteOn function to the MIDI Library. It will
  // be called whenever the Bluefruit receives MIDI Note On messages.
  MIDI.setHandleNoteOn(handleNoteOn);

  // Do the same for MIDI Note Off messages.
  MIDI.setHandleNoteOff(handleNoteOff);

  // Set General Discoverable Mode flag
  Bluefruit.Advertising.addFlags(BLE_GAP_ADV_FLAGS_LE_ONLY_GENERAL_DISC_MODE);

  // Advertise TX Power
  Bluefruit.Advertising.addTxPower();

  // Advertise BLE MIDI Service
  Bluefruit.Advertising.addService(blemidi);

  // Advertise device name in the Scan Response
  Bluefruit.ScanResponse.addName();

  // Start Advertising
  Bluefruit.Advertising.start();

  // Start MIDI read loop
  Scheduler.startLoop(midiRead);
}

void handleNoteOn(byte channel, byte pitch, byte velocity)
{
  // Log when a note is pressed.
  Serial.printf("Note on: channel = %d, pitch = %d, velocity - %d", channel, pitch, velocity);
  Serial.println();
}

void handleNoteOff(byte channel, byte pitch, byte velocity)
{
  // Log when a note is released.
  Serial.printf("Note off: channel = %d, pitch = %d, velocity - %d", channel, pitch, velocity);
  Serial.println();
}

void loop()
{
  // Don't continue if we aren't connected.
  if (! Bluefruit.connected()) {
    return;
  }

  // Don't continue if the connected device isn't ready to receive messages.
  if (! blemidi.notifyEnabled()) {
    return;
  }

  // Setup variables for the current and previous
  // positions in the note sequence.
  int current = position;
  int previous  = position - 1;

  // If we currently are at position 0, set the
  // previous position to the last note in the sequence.
  if (previous &lt; 0) {
    previous = sizeof(note_sequence) - 1;
  }

  // Send Note On for current position at full velocity (127) on channel 1.
  MIDI.sendNoteOn(note_sequence[current], 127, 1);

  // Send Note Off for previous note.
  MIDI.sendNoteOff(note_sequence[previous], 0, 1);

  // Increment position
  position++;

  // If we are at the end of the sequence, start over.
  if (position &gt;= sizeof(note_sequence)) {
    position = 0;
  }

  delay(286);

}

void midiRead()
{
  // Don't continue if we aren't connected.
  if (! Bluefruit.connected()) {
    return;
  }

  // Don't continue if the connected device isn't ready to receive messages.
  if (! blemidi.notifyEnabled()) {
    return;
  }

  // read any new MIDI messages
  MIDI.read();
}</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="com">/*********************************************************************</span></li><li class="L1"><span class="com"> This is an example for our nRF52 based Bluefruit LE modules</span></li><li class="L2"><span class="com">&nbsp;</span></li><li class="L3"><span class="com"> Pick one up today in the adafruit shop!</span></li><li class="L4"><span class="com">&nbsp;</span></li><li class="L5"><span class="com"> Adafruit invests time and resources providing this open source code,</span></li><li class="L6"><span class="com"> please support Adafruit and open-source hardware by purchasing</span></li><li class="L7"><span class="com"> products from Adafruit!</span></li><li class="L8"><span class="com">&nbsp;</span></li><li class="L9"><span class="com"> MIT license, check LICENSE for more information</span></li><li class="L0"><span class="com"> All text above, and the splash screen below must be included in</span></li><li class="L1"><span class="com"> any redistribution</span></li><li class="L2"><span class="com">*********************************************************************/</span></li><li class="L3"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;bluefruit.h&gt;</span></li><li class="L4"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;MIDI.h&gt;</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="typ">BLEDis</span><span class="pln"> bledis</span><span class="pun">;</span></li><li class="L7"><span class="typ">BLEMidi</span><span class="pln"> blemidi</span><span class="pun">;</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="com">// Create a new instance of the Arduino MIDI Library,</span></li><li class="L0"><span class="com">// and attach BluefruitLE MIDI as the transport.</span></li><li class="L1"><span class="pln">MIDI_CREATE_BLE_INSTANCE</span><span class="pun">(</span><span class="pln">blemidi</span><span class="pun">);</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="com">// Variable that holds the current position in the sequence.</span></li><li class="L4"><span class="kwd">int</span><span class="pln"> position </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="com">// Store example melody as an array of note values</span></li><li class="L7"><span class="kwd">byte</span><span class="pln"> note_sequence</span><span class="pun">[]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span></li><li class="L8"><span class="pln">  </span><span class="lit">74</span><span class="pun">,</span><span class="lit">78</span><span class="pun">,</span><span class="lit">81</span><span class="pun">,</span><span class="lit">86</span><span class="pun">,</span><span class="lit">90</span><span class="pun">,</span><span class="lit">93</span><span class="pun">,</span><span class="lit">98</span><span class="pun">,</span><span class="lit">102</span><span class="pun">,</span><span class="lit">57</span><span class="pun">,</span><span class="lit">61</span><span class="pun">,</span><span class="lit">66</span><span class="pun">,</span><span class="lit">69</span><span class="pun">,</span><span class="lit">73</span><span class="pun">,</span><span class="lit">78</span><span class="pun">,</span><span class="lit">81</span><span class="pun">,</span><span class="lit">85</span><span class="pun">,</span><span class="lit">88</span><span class="pun">,</span><span class="lit">92</span><span class="pun">,</span><span class="lit">97</span><span class="pun">,</span><span class="lit">100</span><span class="pun">,</span><span class="lit">97</span><span class="pun">,</span><span class="lit">92</span><span class="pun">,</span><span class="lit">88</span><span class="pun">,</span><span class="lit">85</span><span class="pun">,</span><span class="lit">81</span><span class="pun">,</span><span class="lit">78</span><span class="pun">,</span></li><li class="L9"><span class="pln">  </span><span class="lit">74</span><span class="pun">,</span><span class="lit">69</span><span class="pun">,</span><span class="lit">66</span><span class="pun">,</span><span class="lit">62</span><span class="pun">,</span><span class="lit">57</span><span class="pun">,</span><span class="lit">62</span><span class="pun">,</span><span class="lit">66</span><span class="pun">,</span><span class="lit">69</span><span class="pun">,</span><span class="lit">74</span><span class="pun">,</span><span class="lit">78</span><span class="pun">,</span><span class="lit">81</span><span class="pun">,</span><span class="lit">86</span><span class="pun">,</span><span class="lit">90</span><span class="pun">,</span><span class="lit">93</span><span class="pun">,</span><span class="lit">97</span><span class="pun">,</span><span class="lit">102</span><span class="pun">,</span><span class="lit">97</span><span class="pun">,</span><span class="lit">93</span><span class="pun">,</span><span class="lit">90</span><span class="pun">,</span><span class="lit">85</span><span class="pun">,</span><span class="lit">81</span><span class="pun">,</span><span class="lit">78</span><span class="pun">,</span><span class="lit">73</span><span class="pun">,</span><span class="lit">68</span><span class="pun">,</span><span class="lit">64</span><span class="pun">,</span><span class="lit">61</span><span class="pun">,</span></li><li class="L0"><span class="pln">  </span><span class="lit">56</span><span class="pun">,</span><span class="lit">61</span><span class="pun">,</span><span class="lit">64</span><span class="pun">,</span><span class="lit">68</span><span class="pun">,</span><span class="lit">74</span><span class="pun">,</span><span class="lit">78</span><span class="pun">,</span><span class="lit">81</span><span class="pun">,</span><span class="lit">86</span><span class="pun">,</span><span class="lit">90</span><span class="pun">,</span><span class="lit">93</span><span class="pun">,</span><span class="lit">98</span><span class="pun">,</span><span class="lit">102</span></li><li class="L1"><span class="pun">};</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="kwd">void</span><span class="pln"> setup</span><span class="pun">()</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">(</span><span class="lit">115200</span><span class="pun">);</span></li><li class="L6"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"Adafruit Bluefruit52 MIDI over Bluetooth LE Example"</span><span class="pun">);</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L9"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="pln">setName</span><span class="pun">(</span><span class="str">"Bluefruit52 MIDI"</span><span class="pun">);</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">  </span><span class="com">// Setup the on board blue LED to be enabled on CONNECT</span></li><li class="L2"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="pln">autoConnLed</span><span class="pun">(</span><span class="kwd">true</span><span class="pun">);</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln">  </span><span class="com">// Configure and Start Device Information Service</span></li><li class="L5"><span class="pln">  bledis</span><span class="pun">.</span><span class="pln">setManufacturer</span><span class="pun">(</span><span class="str">"Adafruit Industries"</span><span class="pun">);</span></li><li class="L6"><span class="pln">  bledis</span><span class="pun">.</span><span class="pln">setModel</span><span class="pun">(</span><span class="str">"Bluefruit Feather52"</span><span class="pun">);</span></li><li class="L7"><span class="pln">  bledis</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">();</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="pln">  </span><span class="com">// Initialize MIDI, and listen to all MIDI channels</span></li><li class="L0"><span class="pln">  </span><span class="com">// This will also call blemidi service's begin()</span></li><li class="L1"><span class="pln">  MIDI</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">(</span><span class="pln">MIDI_CHANNEL_OMNI</span><span class="pun">);</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="pln">  </span><span class="com">// Attach the handleNoteOn function to the MIDI Library. It will</span></li><li class="L4"><span class="pln">  </span><span class="com">// be called whenever the Bluefruit receives MIDI Note On messages.</span></li><li class="L5"><span class="pln">  MIDI</span><span class="pun">.</span><span class="pln">setHandleNoteOn</span><span class="pun">(</span><span class="pln">handleNoteOn</span><span class="pun">);</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="pln">  </span><span class="com">// Do the same for MIDI Note Off messages.</span></li><li class="L8"><span class="pln">  MIDI</span><span class="pun">.</span><span class="pln">setHandleNoteOff</span><span class="pun">(</span><span class="pln">handleNoteOff</span><span class="pun">);</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="pln">  </span><span class="com">// Set General Discoverable Mode flag</span></li><li class="L1"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">addFlags</span><span class="pun">(</span><span class="pln">BLE_GAP_ADV_FLAGS_LE_ONLY_GENERAL_DISC_MODE</span><span class="pun">);</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="pln">  </span><span class="com">// Advertise TX Power</span></li><li class="L4"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">addTxPower</span><span class="pun">();</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">  </span><span class="com">// Advertise BLE MIDI Service</span></li><li class="L7"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">addService</span><span class="pun">(</span><span class="pln">blemidi</span><span class="pun">);</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="pln">  </span><span class="com">// Advertise device name in the Scan Response</span></li><li class="L0"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">ScanResponse</span><span class="pun">.</span><span class="pln">addName</span><span class="pun">();</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="pln">  </span><span class="com">// Start Advertising</span></li><li class="L3"><span class="pln">  </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="typ">Advertising</span><span class="pun">.</span><span class="pln">start</span><span class="pun">();</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">  </span><span class="com">// Start MIDI read loop</span></li><li class="L6"><span class="pln">  </span><span class="typ">Scheduler</span><span class="pun">.</span><span class="pln">startLoop</span><span class="pun">(</span><span class="pln">midiRead</span><span class="pun">);</span></li><li class="L7"><span class="pun">}</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="kwd">void</span><span class="pln"> handleNoteOn</span><span class="pun">(</span><span class="kwd">byte</span><span class="pln"> channel</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">byte</span><span class="pln"> pitch</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">byte</span><span class="pln"> velocity</span><span class="pun">)</span></li><li class="L0"><span class="pun">{</span></li><li class="L1"><span class="pln">  </span><span class="com">// Log when a note is pressed.</span></li><li class="L2"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">printf</span><span class="pun">(</span><span class="str">"Note on: channel = %d, pitch = %d, velocity - %d"</span><span class="pun">,</span><span class="pln"> channel</span><span class="pun">,</span><span class="pln"> pitch</span><span class="pun">,</span><span class="pln"> velocity</span><span class="pun">);</span></li><li class="L3"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">();</span></li><li class="L4"><span class="pun">}</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="kwd">void</span><span class="pln"> handleNoteOff</span><span class="pun">(</span><span class="kwd">byte</span><span class="pln"> channel</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">byte</span><span class="pln"> pitch</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">byte</span><span class="pln"> velocity</span><span class="pun">)</span></li><li class="L7"><span class="pun">{</span></li><li class="L8"><span class="pln">  </span><span class="com">// Log when a note is released.</span></li><li class="L9"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">printf</span><span class="pun">(</span><span class="str">"Note off: channel = %d, pitch = %d, velocity - %d"</span><span class="pun">,</span><span class="pln"> channel</span><span class="pun">,</span><span class="pln"> pitch</span><span class="pun">,</span><span class="pln"> velocity</span><span class="pun">);</span></li><li class="L0"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">();</span></li><li class="L1"><span class="pun">}</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="kwd">void</span><span class="pln"> loop</span><span class="pun">()</span></li><li class="L4"><span class="pun">{</span></li><li class="L5"><span class="pln">  </span><span class="com">// Don't continue if we aren't connected.</span></li><li class="L6"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(!</span><span class="pln"> </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="pln">connected</span><span class="pun">())</span><span class="pln"> </span><span class="pun">{</span></li><li class="L7"><span class="pln">    </span><span class="kwd">return</span><span class="pun">;</span></li><li class="L8"><span class="pln">  </span><span class="pun">}</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="pln">  </span><span class="com">// Don't continue if the connected device isn't ready to receive messages.</span></li><li class="L1"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(!</span><span class="pln"> blemidi</span><span class="pun">.</span><span class="pln">notifyEnabled</span><span class="pun">())</span><span class="pln"> </span><span class="pun">{</span></li><li class="L2"><span class="pln">    </span><span class="kwd">return</span><span class="pun">;</span></li><li class="L3"><span class="pln">  </span><span class="pun">}</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">  </span><span class="com">// Setup variables for the current and previous</span></li><li class="L6"><span class="pln">  </span><span class="com">// positions in the note sequence.</span></li><li class="L7"><span class="pln">  </span><span class="kwd">int</span><span class="pln"> current </span><span class="pun">=</span><span class="pln"> position</span><span class="pun">;</span></li><li class="L8"><span class="pln">  </span><span class="kwd">int</span><span class="pln"> previous  </span><span class="pun">=</span><span class="pln"> position </span><span class="pun">-</span><span class="pln"> </span><span class="lit">1</span><span class="pun">;</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="pln">  </span><span class="com">// If we currently are at position 0, set the</span></li><li class="L1"><span class="pln">  </span><span class="com">// previous position to the last note in the sequence.</span></li><li class="L2"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">previous </span><span class="pun">&lt;</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L3"><span class="pln">    previous </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">sizeof</span><span class="pun">(</span><span class="pln">note_sequence</span><span class="pun">)</span><span class="pln"> </span><span class="pun">-</span><span class="pln"> </span><span class="lit">1</span><span class="pun">;</span></li><li class="L4"><span class="pln">  </span><span class="pun">}</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">  </span><span class="com">// Send Note On for current position at full velocity (127) on channel 1.</span></li><li class="L7"><span class="pln">  MIDI</span><span class="pun">.</span><span class="pln">sendNoteOn</span><span class="pun">(</span><span class="pln">note_sequence</span><span class="pun">[</span><span class="pln">current</span><span class="pun">],</span><span class="pln"> </span><span class="lit">127</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">);</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="pln">  </span><span class="com">// Send Note Off for previous note.</span></li><li class="L0"><span class="pln">  MIDI</span><span class="pun">.</span><span class="pln">sendNoteOff</span><span class="pun">(</span><span class="pln">note_sequence</span><span class="pun">[</span><span class="pln">previous</span><span class="pun">],</span><span class="pln"> </span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">);</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="pln">  </span><span class="com">// Increment position</span></li><li class="L3"><span class="pln">  position</span><span class="pun">++;</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">  </span><span class="com">// If we are at the end of the sequence, start over.</span></li><li class="L6"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">position </span><span class="pun">&gt;=</span><span class="pln"> </span><span class="kwd">sizeof</span><span class="pun">(</span><span class="pln">note_sequence</span><span class="pun">))</span><span class="pln"> </span><span class="pun">{</span></li><li class="L7"><span class="pln">    position </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></li><li class="L8"><span class="pln">  </span><span class="pun">}</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="pln">  delay</span><span class="pun">(</span><span class="lit">286</span><span class="pun">);</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="pun">}</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="kwd">void</span><span class="pln"> midiRead</span><span class="pun">()</span></li><li class="L5"><span class="pun">{</span></li><li class="L6"><span class="pln">  </span><span class="com">// Don't continue if we aren't connected.</span></li><li class="L7"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(!</span><span class="pln"> </span><span class="typ">Bluefruit</span><span class="pun">.</span><span class="pln">connected</span><span class="pun">())</span><span class="pln"> </span><span class="pun">{</span></li><li class="L8"><span class="pln">    </span><span class="kwd">return</span><span class="pun">;</span></li><li class="L9"><span class="pln">  </span><span class="pun">}</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">  </span><span class="com">// Don't continue if the connected device isn't ready to receive messages.</span></li><li class="L2"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(!</span><span class="pln"> blemidi</span><span class="pun">.</span><span class="pln">notifyEnabled</span><span class="pun">())</span><span class="pln"> </span><span class="pun">{</span></li><li class="L3"><span class="pln">    </span><span class="kwd">return</span><span class="pun">;</span></li><li class="L4"><span class="pln">  </span><span class="pun">}</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="pln">  </span><span class="com">// read any new MIDI messages</span></li><li class="L7"><span class="pln">  MIDI</span><span class="pun">.</span><span class="pln">read</span><span class="pun">();</span></li><li class="L8"><span class="pun">}</span></li></ol></pre>
</div>
<div class="markdown-element">
<div class="markdown-html">
<h2>
<a href="./nRF52_bluefruit_Learning_Guide.html#usage-32-13" class="anchor-link"><span class="fa fa-link"></span></a><span id="usage-32-13" class="anchor-link-target"></span><span id="usage" class="anchor-link-target"></span>Usage</h2>
<p>You will need to do a small bit of setup on your selected platform to connect to the BLE MIDI enabled Bluefruit52.</p>
<p>Click on a platform below to view BLE MIDI setup instructions for your device:</p>
<ul>
<li><a href="https://learn.adafruit.com/wireless-untztrument-using-ble-midi/macos-os-x">macOS (OS X)</a></li>
<li><a href="https://learn.adafruit.com/wireless-untztrument-using-ble-midi/ios">iOS</a></li>
<li><a href="https://learn.adafruit.com/wireless-untztrument-using-ble-midi/android">Android</a></li>
<li><a href="https://learn.adafruit.com/wireless-untztrument-using-ble-midi/windows">Windows</a></li>
</ul>
<p>The arpeggio should automatically play once the Bluefruit52 is connected to your software synth. The video below shows the Bluefruit52 connected to <a href="https://www.moogmusic.com/products/apps/animoog-0">Moog's Animoog on iOS</a>.</p>
</div>
</div>
<div class="element element element row-fluid build-alert alert-info">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
Note: The board used in the video was a pre-release prototype. The production boards are standard Adafruit Black.
</div>
</div>
<div class="build-embed">
<div class="build-video"></div>
</div>
</div>
</div>
<div class="page-title-wrapper">
<h1 class="headline">
<span id="blehidadafruit">BLEHidAdafruit</span>
</h1>

</div>
<div class="page-content all-page-view-content">
<div class="">
<div class="element element row-fluid build-alert">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
The Bluefruit nRF52 BSP codebase is undergoing active development based on customer feedback and testing. As such, the class documentation here is incomplete, and you should consult the Github repo for the latest code and API developments: <a href="https://goo.gl/LdEx62">https://goo.gl/LdEx62</a>
</div>
</div>
<div class="row-fluid build-text">
<p>BLEHidAdafruit allows you to simulate a mouse or keyboard using the HID (Human Interface Device) profile&nbsp;that is part of the Bluetooth Low Energy standard.</p>
<p>Most modern mobile devices with Bluetooth Low Energy support, and the latest operating systems generally support Bluetooth Low Energy mice and keyboards out of the box, once you pair your Bluefruit nRF52/nRF52840 Feather and run an appropriate sketch.</p>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#api-33-3" class="anchor-link"><span class="fa fa-link"></span></a><span id="api-33-3" class="anchor-link-target"></span><span id="api" class="anchor-link-target"></span>API</h1>
<p>The BLEHidAdafruit helper class has the following public API:</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/9050/elements/2860795/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">// Constructor
BLEHidAdafruit(void);

// Call this once to start the HID service
virtual err_t begin(void);

// Keyboard
err_t keyboardReport(hid_keyboard_report_t* report);
err_t keyboardReport(uint8_t modifier, uint8_t keycode[6]);
err_t keyboardReport(uint8_t modifier, uint8_t keycode0, uint8_t keycode1=0, uint8_t keycode2=0, uint8_t keycode3=0, uint8_t keycode4=0, uint8_t keycode5=0);

err_t keyPress(char ch);
err_t keyRelease(void);
err_t keySequence(const char* str, int interal=5);

// Consumer Media Keys
err_t consumerReport(uint16_t usage_code);
err_t consumerKeyPress(uint16_t usage_code);
err_t consumerKeyRelease(void);

// Mouse
err_t mouseReport(hid_mouse_report_t* report);
err_t mouseReport(uint8_t buttons, int8_t x, int8_t y, int8_t wheel=0, int8_t pan=0);

err_t mouseButtonPress(uint8_t buttons);
err_t mouseButtonRelease(void);

err_t mouseMove(int8_t x, int8_t y);
err_t mouseScroll(int8_t scroll);
err_t mousePan(int8_t pan);</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="com">// Constructor</span></li><li class="L1"><span class="typ">BLEHidAdafruit</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="com">// Call this once to start the HID service</span></li><li class="L4"><span class="kwd">virtual</span><span class="pln"> </span><span class="typ">err_t</span><span class="pln"> </span><span class="kwd">begin</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="com">// Keyboard</span></li><li class="L7"><span class="typ">err_t</span><span class="pln"> keyboardReport</span><span class="pun">(</span><span class="typ">hid_keyboard_report_t</span><span class="pun">*</span><span class="pln"> report</span><span class="pun">);</span></li><li class="L8"><span class="typ">err_t</span><span class="pln"> keyboardReport</span><span class="pun">(</span><span class="typ">uint8_t</span><span class="pln"> modifier</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pln"> keycode</span><span class="pun">[</span><span class="lit">6</span><span class="pun">]);</span></li><li class="L9"><span class="typ">err_t</span><span class="pln"> keyboardReport</span><span class="pun">(</span><span class="typ">uint8_t</span><span class="pln"> modifier</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pln"> keycode0</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pln"> keycode1</span><span class="pun">=</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pln"> keycode2</span><span class="pun">=</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pln"> keycode3</span><span class="pun">=</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pln"> keycode4</span><span class="pun">=</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint8_t</span><span class="pln"> keycode5</span><span class="pun">=</span><span class="lit">0</span><span class="pun">);</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="typ">err_t</span><span class="pln"> keyPress</span><span class="pun">(</span><span class="kwd">char</span><span class="pln"> ch</span><span class="pun">);</span></li><li class="L2"><span class="typ">err_t</span><span class="pln"> keyRelease</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L3"><span class="typ">err_t</span><span class="pln"> keySequence</span><span class="pun">(</span><span class="kwd">const</span><span class="pln"> </span><span class="kwd">char</span><span class="pun">*</span><span class="pln"> str</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">int</span><span class="pln"> interal</span><span class="pun">=</span><span class="lit">5</span><span class="pun">);</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="com">// Consumer Media Keys</span></li><li class="L6"><span class="typ">err_t</span><span class="pln"> consumerReport</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> usage_code</span><span class="pun">);</span></li><li class="L7"><span class="typ">err_t</span><span class="pln"> consumerKeyPress</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> usage_code</span><span class="pun">);</span></li><li class="L8"><span class="typ">err_t</span><span class="pln"> consumerKeyRelease</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="com">// Mouse</span></li><li class="L1"><span class="typ">err_t</span><span class="pln"> mouseReport</span><span class="pun">(</span><span class="typ">hid_mouse_report_t</span><span class="pun">*</span><span class="pln"> report</span><span class="pun">);</span></li><li class="L2"><span class="typ">err_t</span><span class="pln"> mouseReport</span><span class="pun">(</span><span class="typ">uint8_t</span><span class="pln"> buttons</span><span class="pun">,</span><span class="pln"> </span><span class="typ">int8_t</span><span class="pln"> x</span><span class="pun">,</span><span class="pln"> </span><span class="typ">int8_t</span><span class="pln"> y</span><span class="pun">,</span><span class="pln"> </span><span class="typ">int8_t</span><span class="pln"> wheel</span><span class="pun">=</span><span class="lit">0</span><span class="pun">,</span><span class="pln"> </span><span class="typ">int8_t</span><span class="pln"> pan</span><span class="pun">=</span><span class="lit">0</span><span class="pun">);</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="typ">err_t</span><span class="pln"> mouseButtonPress</span><span class="pun">(</span><span class="typ">uint8_t</span><span class="pln"> buttons</span><span class="pun">);</span></li><li class="L5"><span class="typ">err_t</span><span class="pln"> mouseButtonRelease</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="typ">err_t</span><span class="pln"> mouseMove</span><span class="pun">(</span><span class="typ">int8_t</span><span class="pln"> x</span><span class="pun">,</span><span class="pln"> </span><span class="typ">int8_t</span><span class="pln"> y</span><span class="pun">);</span></li><li class="L8"><span class="typ">err_t</span><span class="pln"> mouseScroll</span><span class="pun">(</span><span class="typ">int8_t</span><span class="pln"> scroll</span><span class="pun">);</span></li><li class="L9"><span class="typ">err_t</span><span class="pln"> mousePan</span><span class="pun">(</span><span class="typ">int8_t</span><span class="pln"> pan</span><span class="pun">);</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#example-sketches-33-5" class="anchor-link"><span class="fa fa-link"></span></a><span id="example-sketches-33-5" class="anchor-link-target"></span><span id="example-sketches" class="anchor-link-target"></span>Example Sketches</h1>
<p>There are a variety of example sketches showing how to use the BLEHidAdafruit class. You can browse the latest source code on Github with the following links:</p>
<ul>
<li>
<a href="https://github.com/adafruit/Adafruit_nRF52_Arduino/blob/master/libraries/Bluefruit52Lib/examples/Peripheral/hid_keyboard/hid_keyboard.ino" target="_blank">hid_keyboard</a>: This example will simulate an HID keyboard,&nbsp;waiting for data to arrive via the nRF52's serial port (via USB serial), and send that data over the air to the bonded Central device.</li>
<li>
<a href="https://github.com/adafruit/Adafruit_nRF52_Arduino/blob/master/libraries/Bluefruit52Lib/examples/Peripheral/hid_mouse/hid_mouse.ino" target="_blank">hid_mouse</a>: This example will simulate an HID mouse. To use it run the sketch and open the Serial Monitor, then enter the appropriate characters to move the mouse or trigger/release the mouse buttons.</li>
</ul>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#bonding-hid-devices-33-6" class="anchor-link"><span class="fa fa-link"></span></a><span id="bonding-hid-devices-33-6" class="anchor-link-target"></span><span id="bonding-hid-devices" class="anchor-link-target"></span>Bonding HID Devices</h1>
<p>In order to use your HID mouse or keyboard, you will first need to&nbsp;<strong>bond</strong> the two devices. The bonding process involves the following steps:</p>
<ul>
<li>The two devices will connect to each other normally</li>
<li>A set of security keys are exchanged between the two devices, and stores in non-volatile memory on each side. This is to ensure that each side is reasonably confident it is talking to the device it thinks it is for future connections, and to encrypt over the air communication between the devices (so that people can 'sniff' your keyboard data, etc.).</li>
<li>On the nRF52 side this key data will be stored in a section of flash memory reserved for this purpose using an internal file system.</li>
<li>The process of storing these security keys is referred to as&nbsp;<strong>bonding</strong>, and allows bonded devices to securely communicate without user interaction in the future.</li>
<li>To cancel the bonding agreement, you can simply delete the keys on the nRF52 via the <a href="https://github.com/adafruit/Adafruit_nRF52_Arduino/blob/master/libraries/Bluefruit52Lib/examples/Peripheral/clearbonds/clearbonds.ino" target="_blank">clearbonds</a>&nbsp;sketch, or delete the bonding data on your mobile device of computer.</li>
</ul>
</div>
<div class="element element row-fluid build-alert alert-danger">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
If you run into any bonding problems, try running the clearbonds sketch to remove and old bonding data from local non-volatile memory!
</div>
</div>
<div class="row-fluid build-text">
<h2>
<a href="./nRF52_bluefruit_Learning_Guide.html#setting-up-your-bluefruit-device-for-bonding-33-8" class="anchor-link"><span class="fa fa-link"></span></a><span id="setting-up-your-bluefruit-device-for-bonding-33-8" class="anchor-link-target"></span><span id="setting-up-your-bluefruit-device-for-bonding" class="anchor-link-target"></span>Setting up your Bluefruit device for bonding</h2>
<p>To bond an device, run an appropriate HID sketch on the nRF52 to emulate either an HID mouse or an HID keyboard. In the event that you use the HID mouse example you may need to open the Serial Monitor to use it.</p>
<p>In this example we'll run the&nbsp;<strong>hid_keyboard</strong> example sketch, flashing it to the nRF52, which should give you the following results:</p>
</div>
<div class="row-fluid build-image">
<a href="./nRF52_bluefruit_Learning_Guide.html#setting-up-your-bluefruit-device-for-bonding">
<img class="40349-asset img-responsive" src="./nRF52_bluefruit_Learning_Guide/microcontrollers_Screen_Shot_2017-03-21_at_19.13.24.png" alt="microcontrollers_Screen_Shot_2017-03-21_at_19.13.24.png">
<span class="image-expand"><i class="fa fa-search-plus"></i></span>
</a> </div>
<div class="row-fluid build-text">
<p>Opening the Serial Monitor will give you the following output (though it may differ depending on the debug level you have selected):</p>
</div>
<div class="row-fluid build-image">
<a href="./nRF52_bluefruit_Learning_Guide.html#setting-up-your-bluefruit-device-for-bonding">
<img class="40351-asset img-responsive" src="./nRF52_bluefruit_Learning_Guide/microcontrollers_Screen_Shot_2017-03-21_at_19.35.37.png" alt="microcontrollers_Screen_Shot_2017-03-21_at_19.35.37.png">
<span class="image-expand"><i class="fa fa-search-plus"></i></span>
</a> </div>
<div class="row-fluid build-text">
<h2>
<a href="./nRF52_bluefruit_Learning_Guide.html#bonding-on-ios-33-12" class="anchor-link"><span class="fa fa-link"></span></a><span id="bonding-on-ios-33-12" class="anchor-link-target"></span><span id="bonding-on-ios" class="anchor-link-target"></span>Bonding on iOS</h2>
<p>To bond to an iOS device, make sure the sketch is running (as described above) and go into your&nbsp;<strong>Settings</strong>&nbsp;app and Select&nbsp;<strong>Bluetooth</strong>.</p>
<p>You should see a device at the bottom of this page called&nbsp;<strong>Bluefruit52</strong> (this may vary depending on the version of the sketch you are using!):</p>
</div>
<div class="row-fluid build-image">
<a href="./nRF52_bluefruit_Learning_Guide.html#setting-up-your-bluefruit-device-for-bonding">
<img class="40352-asset img-responsive" src="./nRF52_bluefruit_Learning_Guide/microcontrollers_iOSBonding.png" alt="microcontrollers_iOSBonding.png">
<span class="image-expand"><i class="fa fa-search-plus"></i></span>
</a> </div>
<div class="row-fluid build-text">
<p>Click the device, and you will get a pairing request like this:</p>
</div>
<div class="row-fluid build-image">
<a href="./nRF52_bluefruit_Learning_Guide.html#setting-up-your-bluefruit-device-for-bonding">
<img class="40353-asset img-responsive" src="./nRF52_bluefruit_Learning_Guide/microcontrollers_iOSPairingConfirm.png" alt="microcontrollers_iOSPairingConfirm.png">
<span class="image-expand"><i class="fa fa-search-plus"></i></span>
</a> </div>
<div class="row-fluid build-text">
<p>Click the&nbsp;<strong>Pair</strong> button, and the devices will be paired and bonded, and will automatically connect to each other in the future.</p>
<p>If everything went will, you will see the device in your&nbsp;<strong>MY DEVICES</strong> list, as follows:</p>
</div>
<div class="row-fluid build-image">
<a href="./nRF52_bluefruit_Learning_Guide.html#setting-up-your-bluefruit-device-for-bonding">
<img class="40354-asset img-responsive" src="./nRF52_bluefruit_Learning_Guide/microcontrollers_iOSBonded.png" alt="microcontrollers_iOSBonded.png">
<span class="image-expand"><i class="fa fa-search-plus"></i></span>
</a> </div>
<div class="row-fluid build-text">
<h2>
<a href="./nRF52_bluefruit_Learning_Guide.html#testing-the-hid-keyboard-and-bonding-33-18" class="anchor-link"><span class="fa fa-link"></span></a><span id="testing-the-hid-keyboard-and-bonding-33-18" class="anchor-link-target"></span><span id="testing-the-hid-keyboard-and-bonding" class="anchor-link-target"></span>Testing the HID Keyboard and Bonding</h2>
<p>To test the HID keyboard sketch and bonding process, open&nbsp;the <strong>Serial Monitor</strong> (or your favorite terminal emulator), enter some text, and if you are using the Serial Monitor click the <strong>Send</strong> button. This will send some text over the air to whatever&nbsp;textbox or text control has focus in your app.</p>
</div>
<div class="row-fluid build-image">
<a href="./nRF52_bluefruit_Learning_Guide.html#setting-up-your-bluefruit-device-for-bonding">
<img class="40355-asset img-responsive" src="./nRF52_bluefruit_Learning_Guide/microcontrollers_Screen_Shot_2017-03-21_at_19.47.39.png" alt="microcontrollers_Screen_Shot_2017-03-21_at_19.47.39.png">
<span class="image-expand"><i class="fa fa-search-plus"></i></span>
</a> </div>
<div class="row-fluid build-text">
<p>The text will then appear in your mobile app or bonded device.</p>
<p>If the characters don't match exactly what you send, be sure to check your&nbsp;<strong>keyboard language</strong> settings, since you may be sending data to a device with a different keyboard setup!</p>
</div>
</div>
</div>
<div class="page-title-wrapper">
<h1 class="headline">
<span id="bleancs">BLEAncs</span>
</h1>

</div>
<div class="page-content all-page-view-content">
<div class="">
<div class="element element row-fluid build-alert">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
The Bluefruit nRF52 BSP codebase is undergoing active development based on customer feedback and testing. As such, the class documentation here is incomplete, and you should consult the Github repo for the latest code and API developments: <a href="https://goo.gl/LdEx62">https://goo.gl/LdEx62</a>
</div>
</div>
<div class="row-fluid build-text">
<p>BLEAncs is a helper class that enables you to receive notifications from the <a class="tour-tour-element tour-tour-1-element" href="https://developer.apple.com/library/archive/documentation/CoreBluetooth/Reference/AppleNotificationCenterServiceSpecification/Introduction/Introduction.html" target="_blank">Apple Notification Center Service</a> from devices such as an iPhone or iPad. It can be used to receive alerts such as incoming or missed calls, email messages, or most alerts that appear on the mobile device's screen when locked.</p>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#api-34-3" class="anchor-link"><span class="fa fa-link"></span></a><span id="api-34-3" class="anchor-link-target"></span><span id="api" class="anchor-link-target"></span>API</h1>
<p>Because the BLEAncs class is a work in progress, the latest public API for the BLEAncs helper class should be viewed&nbsp;<a href="https://github.com/adafruit/Adafruit_nRF52_Arduino/blob/master/libraries/Bluefruit52Lib/src/clients/BLEAncs.h" target="_blank">here</a>.</p>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#ancs-oled-example-34-4" class="anchor-link"><span class="fa fa-link"></span></a><span id="ancs-oled-example-34-4" class="anchor-link-target"></span><span id="ancs-oled-example" class="anchor-link-target"></span>ANCS OLED Example</h1>
<p>The <strong><a href="https://github.com/adafruit/Adafruit_nRF52_Arduino/blob/master/libraries/Bluefruit52Lib/examples/Peripheral/ancs_oled/ancs_oled.ino" target="_blank">ancs_oled</a></strong> example uses the <a href="https://www.adafruit.com/product/2900" target="_blank">Adafruit FeatherWing OLED</a> to display any incoming alerts.</p>
</div>
<div class="row-fluid build-text">
<h2>
<a href="./nRF52_bluefruit_Learning_Guide.html#sketch-requirements-34-5" class="anchor-link"><span class="fa fa-link"></span></a><span id="sketch-requirements-34-5" class="anchor-link-target"></span><span id="sketch-requirements" class="anchor-link-target"></span>Sketch Requirements</h2>
<p>In order to use this example sketch the following libraries must be installed on your system:</p>
<ul>
<li>
<a href="https://learn.adafruit.com/adafruit-oled-featherwing/download?view=all#install-adafruit-gfx" target="_blank">Adafruit_GFX</a> (<a href="https://github.com/adafruit/Adafruit-GFX-Library" target="_blank">Github source</a>)</li>
<li>
<a href="https://learn.adafruit.com/adafruit-oled-featherwing/download?view=all#install-adafruit-ssd1306-library" target="_blank">Adafruit_SSD1306</a> (<a href="https://github.com/adafruit/Adafruit_SSD1306" target="_blank">Github source</a>)</li>
<li>Version 0.6.0 or higher of the Bluefruit nRF52 BSP</li>
</ul>
</div>
<div class="row-fluid build-text">
<h2>
<a href="./nRF52_bluefruit_Learning_Guide.html#loading-the-sketch-34-6" class="anchor-link"><span class="fa fa-link"></span></a><span id="loading-the-sketch-34-6" class="anchor-link-target"></span><span id="loading-the-sketch" class="anchor-link-target"></span>Loading the Sketch</h2>
<p>The ancs_oled sketch can be&nbsp;loaded via the examples menu under&nbsp;<strong>Peripheral &gt; ancs_oled</strong>:</p>
</div>
<div class="row-fluid build-image">
<a href="./nRF52_bluefruit_Learning_Guide.html#ancs-oled-example">
<img class="42984-asset img-responsive" src="./nRF52_bluefruit_Learning_Guide/microcontrollers_Screen_Shot_2017-06-25_at_23.48.30.png" alt="microcontrollers_Screen_Shot_2017-06-25_at_23.48.30.png">
<span class="image-expand"><i class="fa fa-search-plus"></i></span>
</a> </div>
<div class="row-fluid build-text">
<p>With the sketch loaded, you can build the firmware and then flash it to your device via the&nbsp;<strong>Upload</strong> button or menu option:</p>
</div>
<div class="row-fluid build-image">
<a href="./nRF52_bluefruit_Learning_Guide.html#ancs-oled-example">
<img class="42985-asset img-responsive" src="./nRF52_bluefruit_Learning_Guide/microcontrollers_Screen_Shot_2017-06-25_at_23.56.54.png" alt="microcontrollers_Screen_Shot_2017-06-25_at_23.56.54.png">
<span class="image-expand"><i class="fa fa-search-plus"></i></span>
</a> </div>
<div class="element element row-fluid build-alert alert-danger">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
Make sure that the Adafruit_SSD1306.h file has the 'SSD1306_128_32' macro enabled. Running the sketch with 'SSD1306_128_64' set will cause corrupted data to appear on the OLED display.
</div>
</div>
<div class="row-fluid build-text">
<p>Once the sketch is running on the nRF52 Feather you can proceed with the one-time&nbsp;pairing process, described below.</p>
</div>
<div class="row-fluid build-text">
<h2>
<a href="./nRF52_bluefruit_Learning_Guide.html#pairing-to-your-mobile-device-34-12" class="anchor-link"><span class="fa fa-link"></span></a><span id="pairing-to-your-mobile-device-34-12" class="anchor-link-target"></span><span id="pairing-to-your-mobile-device" class="anchor-link-target"></span>Pairing&nbsp;to your Mobile Device</h2>
<p>Before you can start receiving notifications, you will need to 'pair' the nRF52 Feather and the mobile device.</p>
<p>The pairing&nbsp;process causes a set of keys to be exchanged and stored on the two devices so that each side knows it is talking to the same device it originally bonded with, and preventing any devices in the middle from eavesdropping on potentially sensitive data.</p>
<p>The one-time pairing process is described below, and assumes you are already running the ancs_oled sketch on your nRF52 device.</p>
</div>
<div class="row-fluid build-text">
<p>1. In the&nbsp;<strong>Settings</strong> app go to <strong>Bluetooth</strong>:</p>
</div>
<div class="row-fluid build-image">
<a href="./nRF52_bluefruit_Learning_Guide.html#pairing-to-your-mobile-device">
<img class="42990-asset img-responsive" src="./nRF52_bluefruit_Learning_Guide/microcontrollers_bonding1.jpg" alt="microcontrollers_bonding1.jpg">
<span class="image-expand"><i class="fa fa-search-plus"></i></span>
</a> </div>
<div class="row-fluid build-text">
<p>2. Scroll to the bottom of the list of 'My Devices'&nbsp;and click on&nbsp;<strong>Bluefruit52&nbsp;</strong>under&nbsp;<strong>Other Devices</strong>:</p>
</div>
<div class="row-fluid build-image">
<a href="./nRF52_bluefruit_Learning_Guide.html#pairing-to-your-mobile-device">
<img class="42991-asset img-responsive" src="./nRF52_bluefruit_Learning_Guide/microcontrollers_bonding2.jpg" alt="microcontrollers_bonding2.jpg">
<span class="image-expand"><i class="fa fa-search-plus"></i></span>
</a> </div>
<div class="row-fluid build-text">
<p>3. When the pairing dialog box comes up, click the&nbsp;<strong>Pair</strong> button:</p>
</div>
<div class="row-fluid build-image">
<a href="./nRF52_bluefruit_Learning_Guide.html#pairing-to-your-mobile-device">
<img class="42988-asset img-responsive" src="./nRF52_bluefruit_Learning_Guide/microcontrollers_bonding3.jpg" alt="microcontrollers_bonding3.jpg">
<span class="image-expand"><i class="fa fa-search-plus"></i></span>
</a> </div>
<div class="row-fluid build-text">
<p>4.&nbsp;Wait for the pairing process to complete, at which point&nbsp;<strong>Bluefruit52</strong>&nbsp;should appear in the&nbsp;<strong>My Devices</strong> list with the&nbsp;<strong>Connected</strong> status:</p>
</div>
<div class="row-fluid build-image">
<a href="./nRF52_bluefruit_Learning_Guide.html#pairing-to-your-mobile-device">
<img class="42992-asset img-responsive" src="./nRF52_bluefruit_Learning_Guide/microcontrollers_bonding4.jpg" alt="microcontrollers_bonding4.jpg">
<span class="image-expand"><i class="fa fa-search-plus"></i></span>
</a> </div>
<div class="element element row-fluid build-alert alert-info">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
Once two devices have been paired, they will automatically reconnect to each other whenever they are in range and have their Bluetooth radios enabled.
</div>
</div>
<div class="row-fluid build-text">
<h2>
<a href="./nRF52_bluefruit_Learning_Guide.html#wait-for-alerts-34-22" class="anchor-link"><span class="fa fa-link"></span></a><span id="wait-for-alerts-34-22" class="anchor-link-target"></span><span id="wait-for-alerts" class="anchor-link-target"></span>Wait for Alerts</h2>
<p>At this point, any alerts that the mobile device generates will be displayed on the OLED display along with the notification category and date:</p>
</div>
<div class="row-fluid build-image">
<a href="./nRF52_bluefruit_Learning_Guide.html#pairing-to-your-mobile-device">
<img class="42993-asset img-responsive" src="./nRF52_bluefruit_Learning_Guide/microcontrollers_alert1.jpg" alt="microcontrollers_alert1.jpg">
<span class="image-expand"><i class="fa fa-search-plus"></i></span>
</a> </div>
<div class="row-fluid build-text">
<p>Certain alerts (such as incoming calls) can also have actions associated with them, making use of the three buttons on the left-hand side of the display to decide which action to take.</p>
<p>In the ancs_oled example, we have a special section of code for incoming calls where you can accept or decline a call with an appropriate button press:</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/9538/elements/2860836/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">  // Check buttons
  uint32_t presedButtons = readPressedButtons();

  if ( myNotifs[activeIndex].ntf.categoryID == ANCS_CAT_INCOMING_CALL )
  {
    /* Incoming call event
     * - Button A to accept call
     * - Button C to decline call
     */
    if ( presedButtons &amp; bit(BUTTON_A) )
    {
      bleancs.actPositive(myNotifs[activeIndex].ntf.uid);
    }

    if ( presedButtons &amp; bit(BUTTON_C) )
    {
      bleancs.actNegative(myNotifs[activeIndex].ntf.uid);
    }
  }
</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="pln">  </span><span class="com">// Check buttons</span></li><li class="L1"><span class="pln">  </span><span class="typ">uint32_t</span><span class="pln"> presedButtons </span><span class="pun">=</span><span class="pln"> readPressedButtons</span><span class="pun">();</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="pln">  </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> myNotifs</span><span class="pun">[</span><span class="pln">activeIndex</span><span class="pun">].</span><span class="pln">ntf</span><span class="pun">.</span><span class="pln">categoryID </span><span class="pun">==</span><span class="pln"> ANCS_CAT_INCOMING_CALL </span><span class="pun">)</span></li><li class="L4"><span class="pln">  </span><span class="pun">{</span></li><li class="L5"><span class="pln">    </span><span class="com">/* Incoming call event</span></li><li class="L6"><span class="com">     * - Button A to accept call</span></li><li class="L7"><span class="com">     * - Button C to decline call</span></li><li class="L8"><span class="com">     */</span></li><li class="L9"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> presedButtons </span><span class="pun">&amp;</span><span class="pln"> bit</span><span class="pun">(</span><span class="pln">BUTTON_A</span><span class="pun">)</span><span class="pln"> </span><span class="pun">)</span></li><li class="L0"><span class="pln">    </span><span class="pun">{</span></li><li class="L1"><span class="pln">      bleancs</span><span class="pun">.</span><span class="pln">actPositive</span><span class="pun">(</span><span class="pln">myNotifs</span><span class="pun">[</span><span class="pln">activeIndex</span><span class="pun">].</span><span class="pln">ntf</span><span class="pun">.</span><span class="pln">uid</span><span class="pun">);</span></li><li class="L2"><span class="pln">    </span><span class="pun">}</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> presedButtons </span><span class="pun">&amp;</span><span class="pln"> bit</span><span class="pun">(</span><span class="pln">BUTTON_C</span><span class="pun">)</span><span class="pln"> </span><span class="pun">)</span></li><li class="L5"><span class="pln">    </span><span class="pun">{</span></li><li class="L6"><span class="pln">      bleancs</span><span class="pun">.</span><span class="pln">actNegative</span><span class="pun">(</span><span class="pln">myNotifs</span><span class="pun">[</span><span class="pln">activeIndex</span><span class="pun">].</span><span class="pln">ntf</span><span class="pun">.</span><span class="pln">uid</span><span class="pun">);</span></li><li class="L7"><span class="pln">    </span><span class="pun">}</span></li><li class="L8"><span class="pln">  </span><span class="pun">}</span></li></ol></pre>
</div>
</div>
</div>
<div class="page-title-wrapper">
<h1 class="headline">
<span id="bleclientcts">BLEClientCts</span>
</h1>

</div>
<div class="page-content all-page-view-content">
<div class="">
<div class="element row-fluid build-alert">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
The Bluefruit nRF52 BSP codebase is undergoing active development based on customer feedback and testing. As such, the class documentation here is incomplete, and you should consult the Github repo for the latest code and API developments: <a href="https://goo.gl/LdEx62">https://goo.gl/LdEx62</a>
</div>
</div>
<div class="row-fluid build-text">

<p>BLEClientCts is a helper class that implements adopted&nbsp;<a href="https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.service.current_time.xml">Current Time Service</a>&nbsp;, which enables you to receive time&nbsp;from devices such as an iPhone or iPad.</p>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#api-35-3" class="anchor-link"><span class="fa fa-link"></span></a><span id="api-35-3" class="anchor-link-target"></span><span id="api" class="anchor-link-target"></span>API</h1>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/11270/elements/2979364/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">// Callback Signatures
typedef void (*adjust_callback_t) (uint8_t reason);

BLEClientCts(void);

virtual bool  begin(void);
virtual bool  discover(uint16_t conn_handle);

bool getCurrentTime(void);
bool getLocalTimeInfo(void);

bool enableAdjust(void);
void setAdjustCallback(adjust_callback_t fp);

// https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.characteristic.current_time.xml
struct ATTR_PACKED {
  uint16_t year;
  uint8_t  month;
  uint8_t  day;
  uint8_t  hour;
  uint8_t  minute;
  uint8_t  second;
  uint8_t  weekday;
  uint8_t  subsecond;
  uint8_t  adjust_reason;
} Time;

// https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.characteristic.local_time_information.xml
struct ATTR_PACKED {
  int8_t  timezone;
  uint8_t dst_offset;
}LocalInfo;</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="com">// Callback Signatures</span></li><li class="L1"><span class="kwd">typedef</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> </span><span class="pun">(*</span><span class="typ">adjust_callback_t</span><span class="pun">)</span><span class="pln"> </span><span class="pun">(</span><span class="typ">uint8_t</span><span class="pln"> reason</span><span class="pun">);</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="typ">BLEClientCts</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="kwd">virtual</span><span class="pln"> </span><span class="kwd">bool</span><span class="pln">  </span><span class="kwd">begin</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L6"><span class="kwd">virtual</span><span class="pln"> </span><span class="kwd">bool</span><span class="pln">  discover</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> conn_handle</span><span class="pun">);</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="kwd">bool</span><span class="pln"> getCurrentTime</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L9"><span class="kwd">bool</span><span class="pln"> getLocalTimeInfo</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="kwd">bool</span><span class="pln"> enableAdjust</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L2"><span class="kwd">void</span><span class="pln"> setAdjustCallback</span><span class="pun">(</span><span class="typ">adjust_callback_t</span><span class="pln"> fp</span><span class="pun">);</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="com">// https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.characteristic.current_time.xml</span></li><li class="L5"><span class="kwd">struct</span><span class="pln"> ATTR_PACKED </span><span class="pun">{</span></li><li class="L6"><span class="pln">  </span><span class="typ">uint16_t</span><span class="pln"> year</span><span class="pun">;</span></li><li class="L7"><span class="pln">  </span><span class="typ">uint8_t</span><span class="pln">  month</span><span class="pun">;</span></li><li class="L8"><span class="pln">  </span><span class="typ">uint8_t</span><span class="pln">  day</span><span class="pun">;</span></li><li class="L9"><span class="pln">  </span><span class="typ">uint8_t</span><span class="pln">  hour</span><span class="pun">;</span></li><li class="L0"><span class="pln">  </span><span class="typ">uint8_t</span><span class="pln">  minute</span><span class="pun">;</span></li><li class="L1"><span class="pln">  </span><span class="typ">uint8_t</span><span class="pln">  second</span><span class="pun">;</span></li><li class="L2"><span class="pln">  </span><span class="typ">uint8_t</span><span class="pln">  weekday</span><span class="pun">;</span></li><li class="L3"><span class="pln">  </span><span class="typ">uint8_t</span><span class="pln">  subsecond</span><span class="pun">;</span></li><li class="L4"><span class="pln">  </span><span class="typ">uint8_t</span><span class="pln">  adjust_reason</span><span class="pun">;</span></li><li class="L5"><span class="pun">}</span><span class="pln"> </span><span class="typ">Time</span><span class="pun">;</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="com">// https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.characteristic.local_time_information.xml</span></li><li class="L8"><span class="kwd">struct</span><span class="pln"> ATTR_PACKED </span><span class="pun">{</span></li><li class="L9"><span class="pln">  </span><span class="typ">int8_t</span><span class="pln">  timezone</span><span class="pun">;</span></li><li class="L0"><span class="pln">  </span><span class="typ">uint8_t</span><span class="pln"> dst_offset</span><span class="pun">;</span></li><li class="L1"><span class="pun">}</span><span class="typ">LocalInfo</span><span class="pun">;</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#client-cts-oled-example-35-5" class="anchor-link"><span class="fa fa-link"></span></a><span id="client-cts-oled-example-35-5" class="anchor-link-target"></span><span id="client-cts-oled-example" class="anchor-link-target"></span>Client CTS OLED Example</h1>
<p>The <strong><a href="https://github.com/adafruit/Adafruit_nRF52_Arduino/blob/master/libraries/Bluefruit52Lib/examples/Peripheral/client_cts_oled/client_cts_oled.ino" target="_blank">client_cts_oled</a></strong> example uses the <a href="https://www.adafruit.com/product/2900" target="_blank">Adafruit FeatherWing OLED</a> to display received time.</p>
<h2>
<a href="./nRF52_bluefruit_Learning_Guide.html#sketch-requirements-35-5" class="anchor-link"><span class="fa fa-link"></span></a><span id="sketch-requirements-35-5" class="anchor-link-target"></span><span id="sketch-requirements" class="anchor-link-target"></span>Sketch Requirements</h2>
<p>In order to use this example sketch the following libraries must be installed on your system:</p>
<ul>
<li>
<a href="https://learn.adafruit.com/adafruit-oled-featherwing/download?view=all#install-adafruit-gfx" target="_blank">Adafruit_GFX</a> (<a href="https://github.com/adafruit/Adafruit-GFX-Library" target="_blank">Github source</a>)</li>
<li>
<a href="https://learn.adafruit.com/adafruit-oled-featherwing/download?view=all#install-adafruit-ssd1306-library" target="_blank">Adafruit_SSD1306</a> (<a href="https://github.com/adafruit/Adafruit_SSD1306" target="_blank">Github source</a>)</li>
</ul>
<h2>
<a href="./nRF52_bluefruit_Learning_Guide.html#loading-the-sketch-35-5" class="anchor-link"><span class="fa fa-link"></span></a><span id="loading-the-sketch-35-5" class="anchor-link-target"></span><span id="loading-the-sketch" class="anchor-link-target"></span>Loading the Sketch</h2>
<p>The client_cts_oled sketch can be&nbsp;loaded via the examples menu under&nbsp;<strong>Peripheral &gt; client_cts_oled</strong>:</p>
</div>
<div class="row-fluid build-image">
<a href="./nRF52_bluefruit_Learning_Guide.html#loading-the-sketch">
<img class="49794-asset img-responsive" src="./nRF52_bluefruit_Learning_Guide/microcontrollers_Screenshot_from_2018-01-02_20-34-11.png" alt="microcontrollers_Screenshot_from_2018-01-02_20-34-11.png">
<span class="image-expand"><i class="fa fa-search-plus"></i></span>
</a> </div>
<div class="row-fluid build-text">
<p>With the sketch loaded, you can build the firmware and then flash it to your device via the&nbsp;<strong>Upload</strong> button or menu option.&nbsp;Once the sketch is running on the nRF52 Feather you can proceed with the one-time pairing process, described below.</p>
</div>
<div class="element element element element element element element element element element element element element element row-fluid build-alert alert-danger">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
Make sure that the Adafruit_SSD1306.h file has the 'SSD1306_128_32' macro enabled. Running the sketch with 'SSD1306_128_64' set will cause corrupted data to appear on the OLED display.
</div>
</div>
<div class="row-fluid build-text">
<h2>
<a href="./nRF52_bluefruit_Learning_Guide.html#pairing-to-your-mobile-device-35-9" class="anchor-link"><span class="fa fa-link"></span></a><span id="pairing-to-your-mobile-device-35-9" class="anchor-link-target"></span><span id="pairing-to-your-mobile-device" class="anchor-link-target"></span>Pairing&nbsp;to your Mobile Device</h2>
<p>Before you can start receiving notifications, you will need to 'pair' the nRF52 Feather and the mobile device.</p>
<p>The pairing&nbsp;process causes a set of keys to be exchanged and stored on the two devices so that each side knows it is talking to the same device it originally bonded with, and preventing any devices in the middle from eavesdropping on potentially sensitive data.</p>
<p>The one-time pairing process is described below, and assumes you are already running the ancs_oled sketch on your nRF52 device.</p>
<p>1. In the&nbsp;<strong>Settings</strong> app go to <strong>Bluetooth</strong>:</p>
</div>
<div class="row-fluid build-image">
<a href="./nRF52_bluefruit_Learning_Guide.html#pairing-to-your-mobile-device">
<img class="49795-asset img-responsive" src="./nRF52_bluefruit_Learning_Guide/microcontrollers_bonding1(1).jpg" alt="microcontrollers_bonding1.jpg">
<span class="image-expand"><i class="fa fa-search-plus"></i></span>
</a> </div>
<div class="row-fluid build-text">
<p>2. Scroll to the bottom of the list of 'My Devices'&nbsp;and click on&nbsp;<strong>Bluefruit52&nbsp;</strong>under&nbsp;<strong>Other Devices</strong>:</p>
</div>
<div class="row-fluid build-image">
<a href="./nRF52_bluefruit_Learning_Guide.html#pairing-to-your-mobile-device">
<img class="49796-asset img-responsive" src="./nRF52_bluefruit_Learning_Guide/microcontrollers_bonding2(1).jpg" alt="microcontrollers_bonding2.jpg">
<span class="image-expand"><i class="fa fa-search-plus"></i></span>
</a> </div>
<div class="row-fluid build-text">
<p>3. When the pairing dialog box comes up, click the&nbsp;<strong>Pair</strong> button:</p>
</div>
<div class="row-fluid build-image">
<a href="./nRF52_bluefruit_Learning_Guide.html#pairing-to-your-mobile-device">
<img class="49797-asset img-responsive" src="./nRF52_bluefruit_Learning_Guide/microcontrollers_bonding3(1).jpg" alt="microcontrollers_bonding3.jpg">
<span class="image-expand"><i class="fa fa-search-plus"></i></span>
</a> </div>
<div class="row-fluid build-text">
<p>4.&nbsp;Wait for the pairing process to complete, at which point&nbsp;<strong>Bluefruit52</strong>&nbsp;should appear in the&nbsp;<strong>My Devices</strong> list with the&nbsp;<strong>Connected</strong> status:</p>
</div>
<div class="row-fluid build-image">
<a href="./nRF52_bluefruit_Learning_Guide.html#pairing-to-your-mobile-device">
<img class="49798-asset img-responsive" src="./nRF52_bluefruit_Learning_Guide/microcontrollers_bonding4(1).jpg" alt="microcontrollers_bonding4.jpg">
<span class="image-expand"><i class="fa fa-search-plus"></i></span>
</a> </div>
<div class="element element element element element row-fluid build-alert alert-info">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
Once two devices have been paired, they will automatically reconnect to each other whenever they are in range and have their Bluetooth radios enabled.
</div>
</div>
<div class="row-fluid build-text">
<h2>
<a href="./nRF52_bluefruit_Learning_Guide.html#wait-for-time-data-35-18" class="anchor-link"><span class="fa fa-link"></span></a><span id="wait-for-time-data-35-18" class="anchor-link-target"></span><span id="wait-for-time-data" class="anchor-link-target"></span>Wait for Time Data</h2>
<p>At this point,&nbsp; time data from the mobile device will be read and display on the the OLED. For demo purpose the sketch will read time data from mobile once every second. However, in reality, nRF52 should have an internal timer that keep track of second, and only read/sync with mobile after several hours or days, similar to how IP device got time from NTP server.</p>
</div>
<div class="row-fluid build-image">
<a href="./nRF52_bluefruit_Learning_Guide.html#wait-for-time-data">
<img class="49799-asset img-responsive" src="./nRF52_bluefruit_Learning_Guide/microcontrollers_DSCF1277.jpg" alt="microcontrollers_DSCF1277.jpg">
<span class="image-expand"><i class="fa fa-search-plus"></i></span>
</a> </div>
</div>
</div>
<div class="page-title-wrapper">
<h1 class="headline">
<span id="blecentral">BLECentral</span>
</h1>

</div>
<div class="page-content all-page-view-content">
<div class="">
<div class="element row-fluid build-alert">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
This page is a work in progress as the API is changing as we migrate to S132v5 (nRF52832) and add better Central mode support.
</div>
</div>
<div class="row-fluid build-text">
<p>The Central mode API is accessible via&nbsp;<code>Bluefruit.Central.*</code>&nbsp;and has the following public functions:</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/11219/elements/2979315/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">void begin(void);

/*------------------------------------------------------------------*/
/* GAP
 *------------------------------------------------------------------*/
bool     setConnInterval(uint16_t min, uint16_t max);
bool     setConnIntervalMS (uint16_t min_ms, uint16_t max_ms);

bool     connect(const ble_gap_evt_adv_report_t* adv_report);
bool     connect(const ble_gap_addr_t *peer_addr);
bool     disconnect(uint16_t conn_handle);

bool     connected (uint16_t conn_handle); // If connected to a specific peripheral
bool     connected (void);                 // If connected to any peripherals

/*------------- Callbacks -------------*/
void setConnectCallback   ( BLEGap::connect_callback_t    fp);
void setDisconnectCallback( BLEGap::disconnect_callback_t fp);</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="kwd">void</span><span class="pln"> </span><span class="kwd">begin</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="com">/*------------------------------------------------------------------*/</span></li><li class="L3"><span class="com">/* GAP</span></li><li class="L4"><span class="com"> *------------------------------------------------------------------*/</span></li><li class="L5"><span class="kwd">bool</span><span class="pln">     setConnInterval</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> min</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint16_t</span><span class="pln"> max</span><span class="pun">);</span></li><li class="L6"><span class="kwd">bool</span><span class="pln">     setConnIntervalMS </span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> min_ms</span><span class="pun">,</span><span class="pln"> </span><span class="typ">uint16_t</span><span class="pln"> max_ms</span><span class="pun">);</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="kwd">bool</span><span class="pln">     connect</span><span class="pun">(</span><span class="kwd">const</span><span class="pln"> </span><span class="typ">ble_gap_evt_adv_report_t</span><span class="pun">*</span><span class="pln"> adv_report</span><span class="pun">);</span></li><li class="L9"><span class="kwd">bool</span><span class="pln">     connect</span><span class="pun">(</span><span class="kwd">const</span><span class="pln"> </span><span class="typ">ble_gap_addr_t</span><span class="pln"> </span><span class="pun">*</span><span class="pln">peer_addr</span><span class="pun">);</span></li><li class="L0"><span class="kwd">bool</span><span class="pln">     disconnect</span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> conn_handle</span><span class="pun">);</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="kwd">bool</span><span class="pln">     connected </span><span class="pun">(</span><span class="typ">uint16_t</span><span class="pln"> conn_handle</span><span class="pun">);</span><span class="pln"> </span><span class="com">// If connected to a specific peripheral</span></li><li class="L3"><span class="kwd">bool</span><span class="pln">     connected </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">);</span><span class="pln">                 </span><span class="com">// If connected to any peripherals</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="com">/*------------- Callbacks -------------*/</span></li><li class="L6"><span class="kwd">void</span><span class="pln"> setConnectCallback   </span><span class="pun">(</span><span class="pln"> </span><span class="typ">BLEGap</span><span class="pun">::</span><span class="typ">connect_callback_t</span><span class="pln">    fp</span><span class="pun">);</span></li><li class="L7"><span class="kwd">void</span><span class="pln"> setDisconnectCallback</span><span class="pun">(</span><span class="pln"> </span><span class="typ">BLEGap</span><span class="pun">::</span><span class="typ">disconnect_callback_t</span><span class="pln"> fp</span><span class="pun">);</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<p>For examples of how to use the Central mode API, see the <a href="https://github.com/adafruit/Adafruit_nRF52_Arduino/tree/master/libraries/Bluefruit52Lib/examples/Central" target="_blank">Central examples folder</a>.</p>
</div>
</div>
</div>
<div class="page-title-wrapper">
<h1 class="headline">
<span id="nrf52-adc">nRF52 ADC</span>
</h1>
<div class="author">by
<a href="https://learn.adafruit.com/users/ktownsend">
<span class="name">Kevin Townsend</span>
</a> </div>
</div>
<div class="page-content all-page-view-content">
<div class="">
<div class="row-fluid build-text">
<p>The nRF52 family includes an adjustable 'successive-approximation ADC' which can be configured to convert data with up to 14-bit resolution (0..16383), and the reference voltage can be adjusted up to 3.6V internally.</p>
<p>The default values for the ADC are <strong>10-bit resolution (0..1023)</strong> with a <strong>3.6V reference voltage</strong>, meaning every digit returned from the ADC =&nbsp;3600mV/1024 =&nbsp;<strong>3.515625mV</strong>.</p>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#analog-reference-voltage-38-2" class="anchor-link"><span class="fa fa-link"></span></a><span id="analog-reference-voltage-38-2" class="anchor-link-target"></span><span id="analog-reference-voltage" class="anchor-link-target"></span>Analog Reference Voltage</h1>
<p>The internal reference voltage is 0.6V with a variable gain setting, and can be adjust via the&nbsp;<strong>analogReference(...)</strong> function, providing one of the following values:</p>
<ul>
<li>
<strong> AR_INTERNAL</strong>&nbsp;(0.6V Ref * 6 = 0..3.6V) &lt;-- DEFAULT</li>
<li>
<strong>AR_INTERNAL_3_0</strong>&nbsp;(0.6V Ref * 5 = 0..3.0V)</li>
<li>
<strong>AR_INTERNAL_2_4</strong>&nbsp;(0.6V Ref * 4 = 0..2.4V)</li>
<li>
<strong>AR_INTERNAL_1_8</strong>&nbsp;(0.6V Ref * 3 = 0..1.8V)</li>
<li>
<strong>AR_INTERNAL_1_2</strong>&nbsp;(0.6V Ref * 2 = 0..1.6V)</li>
<li>
<strong>AR_VDD4</strong>&nbsp;(VDD/4 REF * 4 = 0..VDD)</li>
</ul>
<p>For example:</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/10505/elements/2865007/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">// Set the analog reference to 3.0V (default = 3.6V)
analogReference(AR_INTERNAL_3_0);</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="com">// Set the analog reference to 3.0V (default = 3.6V)</span></li><li class="L1"><span class="pln">analogReference</span><span class="pun">(</span><span class="pln">AR_INTERNAL_3_0</span><span class="pun">);</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#analog-resolution-38-4" class="anchor-link"><span class="fa fa-link"></span></a><span id="analog-resolution-38-4" class="anchor-link-target"></span><span id="analog-resolution" class="anchor-link-target"></span>Analog Resolution</h1>
<p>The ADC resolution can be set to 8, 10, 12 or 14 bits using the&nbsp;<strong>analogReadResolution(...)</strong> function, with the default value being 10-bit:</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/10505/elements/2865009/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">// Set the resolution to 12-bit (0..4095)
analogReadResolution(12); // Can be 8, 10, 12 or 14</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="com">// Set the resolution to 12-bit (0..4095)</span></li><li class="L1"><span class="pln">analogReadResolution</span><span class="pun">(</span><span class="lit">12</span><span class="pun">);</span><span class="pln"> </span><span class="com">// Can be 8, 10, 12 or 14</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#default-adc-example-10-bit-3-dot-6v-reference-38-6" class="anchor-link"><span class="fa fa-link"></span></a><span id="default-adc-example-10-bit-3-dot-6v-reference-38-6" class="anchor-link-target"></span><span id="default-adc-example-10-bit-3-dot-6v-reference" class="anchor-link-target"></span>Default ADC Example (10-bit, 3.6V Reference)</h1>
<p>The original source for this code is included in the nRF52 BSP and can be viewed online <a href="https://github.com/adafruit/Adafruit_nRF52_Arduino/blob/master/libraries/Bluefruit52Lib/examples/Hardware/adc/adc.ino">here</a>.</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/10505/elements/2865011/download?type=zip">
Project Zip
</a> <span class="divider">or</span>
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/10505/elements/2865011/download">
adc.ino
</a> <span class="divider visible-lg-inline">|</span>
<a target="_blank" class="visible-lg-inline" href="https://github.com/adafruit/Adafruit_nRF52_Arduino/blob/master/libraries/Bluefruit52Lib/examples/Hardware/adc/adc.ino">
<i class="fa fa-github"></i>
View on Github
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">int adcin    = A5;
int adcvalue = 0;
float mv_per_lsb = 3600.0F/1024.0F; // 10-bit ADC with 3.6V input range

void setup() {
  Serial.begin(115200);
  while ( !Serial ) delay(10);   // for nrf52840 with native usb
}

void loop() {
  // Get a fresh ADC value
  adcvalue = analogRead(adcin);

  // Display the results
  Serial.print(adcvalue);
  Serial.print(" [");
  Serial.print((float)adcvalue * mv_per_lsb);
  Serial.println(" mV]");

  delay(100);
}
</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="kwd">int</span><span class="pln"> adcin    </span><span class="pun">=</span><span class="pln"> A5</span><span class="pun">;</span></li><li class="L1"><span class="kwd">int</span><span class="pln"> adcvalue </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></li><li class="L2"><span class="kwd">float</span><span class="pln"> mv_per_lsb </span><span class="pun">=</span><span class="pln"> </span><span class="lit">3600.0F</span><span class="pun">/</span><span class="lit">1024.0F</span><span class="pun">;</span><span class="pln"> </span><span class="com">// 10-bit ADC with 3.6V input range</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="kwd">void</span><span class="pln"> setup</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span></li><li class="L5"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">(</span><span class="lit">115200</span><span class="pun">);</span></li><li class="L6"><span class="pln">  </span><span class="kwd">while</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="typ">Serial</span><span class="pln"> </span><span class="pun">)</span><span class="pln"> delay</span><span class="pun">(</span><span class="lit">10</span><span class="pun">);</span><span class="pln">   </span><span class="com">// for nrf52840 with native usb</span></li><li class="L7"><span class="pun">}</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="kwd">void</span><span class="pln"> loop</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span></li><li class="L0"><span class="pln">  </span><span class="com">// Get a fresh ADC value</span></li><li class="L1"><span class="pln">  adcvalue </span><span class="pun">=</span><span class="pln"> analogRead</span><span class="pun">(</span><span class="pln">adcin</span><span class="pun">);</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="pln">  </span><span class="com">// Display the results</span></li><li class="L4"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="pln">adcvalue</span><span class="pun">);</span></li><li class="L5"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">" ["</span><span class="pun">);</span></li><li class="L6"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">((</span><span class="kwd">float</span><span class="pun">)</span><span class="pln">adcvalue </span><span class="pun">*</span><span class="pln"> mv_per_lsb</span><span class="pun">);</span></li><li class="L7"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">" mV]"</span><span class="pun">);</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="pln">  delay</span><span class="pun">(</span><span class="lit">100</span><span class="pun">);</span></li><li class="L0"><span class="pun">}</span></li></ol></pre>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#advanced-example-12-bit-3-dot-0v-reference-38-8" class="anchor-link"><span class="fa fa-link"></span></a><span id="advanced-example-12-bit-3-dot-0v-reference-38-8" class="anchor-link-target"></span><span id="advanced-example-12-bit-3-dot-0v-reference" class="anchor-link-target"></span>Advanced Example (12-bit, 3.0V Reference)</h1>
<p>The original source for this code is included in the nRF52 BSP and can be viewed online <a href="https://github.com/adafruit/Adafruit_nRF52_Arduino/blob/master/libraries/Bluefruit52Lib/examples/Hardware/adc_vbat/adc_vbat.ino">here</a>.</p>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/10505/elements/2865013/download?type=zip">
Project Zip
</a> <span class="divider">or</span>
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/10505/elements/2865013/download">
adc_vbat.ino
</a> <span class="divider visible-lg-inline">|</span>
<a target="_blank" class="visible-lg-inline" href="https://github.com/adafruit/Adafruit_nRF52_Arduino/blob/master/libraries/Bluefruit52Lib/examples/Hardware/adc_vbat/adc_vbat.ino">
<i class="fa fa-github"></i>
View on Github
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">#define VBAT_PIN          (A7)
#define VBAT_MV_PER_LSB   (0.73242188F)   // 3.0V ADC range and 12-bit ADC resolution = 3000mV/4096
#define VBAT_DIVIDER      (0.71275837F)   // 2M + 0.806M voltage divider on VBAT = (2M / (0.806M + 2M))
#define VBAT_DIVIDER_COMP (1.403F)        // Compensation factor for the VBAT divider

int readVBAT(void) {
  int raw;

  // Set the analog reference to 3.0V (default = 3.6V)
  analogReference(AR_INTERNAL_3_0);

  // Set the resolution to 12-bit (0..4095)
  analogReadResolution(12); // Can be 8, 10, 12 or 14

  // Let the ADC settle
  delay(1);

  // Get the raw 12-bit, 0..3000mV ADC value
  raw = analogRead(VBAT_PIN);

  // Set the ADC back to the default settings
  analogReference(AR_DEFAULT);
  analogReadResolution(10);

  return raw;
}

uint8_t mvToPercent(float mvolts) {
    uint8_t battery_level;

    if (mvolts &gt;= 3000)
    {
        battery_level = 100;
    }
    else if (mvolts &gt; 2900)
    {
        battery_level = 100 - ((3000 - mvolts) * 58) / 100;
    }
    else if (mvolts &gt; 2740)
    {
        battery_level = 42 - ((2900 - mvolts) * 24) / 160;
    }
    else if (mvolts &gt; 2440)
    {
        battery_level = 18 - ((2740 - mvolts) * 12) / 300;
    }
    else if (mvolts &gt; 2100)
    {
        battery_level = 6 - ((2440 - mvolts) * 6) / 340;
    }
    else
    {
        battery_level = 0;
    }

    return battery_level;
}

void setup() {
  Serial.begin(115200);
  while ( !Serial ) delay(10);   // for nrf52840 with native usb

  // Get a single ADC sample and throw it away
  readVBAT();
}

void loop() {
  // Get a raw ADC reading
  int vbat_raw = readVBAT();

  // Convert from raw mv to percentage (based on LIPO chemistry)
  uint8_t vbat_per = mvToPercent(vbat_raw * VBAT_MV_PER_LSB);

  // Convert the raw value to compensated mv, taking the resistor-
  // divider into account (providing the actual LIPO voltage)
  // ADC range is 0..3000mV and resolution is 12-bit (0..4095),
  // VBAT voltage divider is 2M + 0.806M, which needs to be added back
  float vbat_mv = (float)vbat_raw * VBAT_MV_PER_LSB * VBAT_DIVIDER_COMP;

  // Display the results
  Serial.print("ADC = ");
  Serial.print(vbat_raw * VBAT_MV_PER_LSB);
  Serial.print(" mV (");
  Serial.print(vbat_raw);
  Serial.print(") ");
  Serial.print("LIPO = ");
  Serial.print(vbat_mv);
  Serial.print(" mV (");
  Serial.print(vbat_per);
  Serial.println("%)");

  delay(1000);
}
</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="com">#define</span><span class="pln"> VBAT_PIN          </span><span class="pun">(</span><span class="pln">A7</span><span class="pun">)</span></li><li class="L1"><span class="com">#define</span><span class="pln"> VBAT_MV_PER_LSB   </span><span class="pun">(</span><span class="lit">0.73242188F</span><span class="pun">)</span><span class="pln">   </span><span class="com">// 3.0V ADC range and 12-bit ADC resolution = 3000mV/4096</span></li><li class="L2"><span class="com">#define</span><span class="pln"> VBAT_DIVIDER      </span><span class="pun">(</span><span class="lit">0.71275837F</span><span class="pun">)</span><span class="pln">   </span><span class="com">// 2M + 0.806M voltage divider on VBAT = (2M / (0.806M + 2M))</span></li><li class="L3"><span class="com">#define</span><span class="pln"> VBAT_DIVIDER_COMP </span><span class="pun">(</span><span class="lit">1.403F</span><span class="pun">)</span><span class="pln">        </span><span class="com">// Compensation factor for the VBAT divider</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="kwd">int</span><span class="pln"> readVBAT</span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L6"><span class="pln">  </span><span class="kwd">int</span><span class="pln"> raw</span><span class="pun">;</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="pln">  </span><span class="com">// Set the analog reference to 3.0V (default = 3.6V)</span></li><li class="L9"><span class="pln">  analogReference</span><span class="pun">(</span><span class="pln">AR_INTERNAL_3_0</span><span class="pun">);</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">  </span><span class="com">// Set the resolution to 12-bit (0..4095)</span></li><li class="L2"><span class="pln">  analogReadResolution</span><span class="pun">(</span><span class="lit">12</span><span class="pun">);</span><span class="pln"> </span><span class="com">// Can be 8, 10, 12 or 14</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln">  </span><span class="com">// Let the ADC settle</span></li><li class="L5"><span class="pln">  delay</span><span class="pun">(</span><span class="lit">1</span><span class="pun">);</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="pln">  </span><span class="com">// Get the raw 12-bit, 0..3000mV ADC value</span></li><li class="L8"><span class="pln">  raw </span><span class="pun">=</span><span class="pln"> analogRead</span><span class="pun">(</span><span class="pln">VBAT_PIN</span><span class="pun">);</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="pln">  </span><span class="com">// Set the ADC back to the default settings</span></li><li class="L1"><span class="pln">  analogReference</span><span class="pun">(</span><span class="pln">AR_DEFAULT</span><span class="pun">);</span></li><li class="L2"><span class="pln">  analogReadResolution</span><span class="pun">(</span><span class="lit">10</span><span class="pun">);</span></li><li class="L3"><span class="pln">&nbsp;</span></li><li class="L4"><span class="pln">  </span><span class="kwd">return</span><span class="pln"> raw</span><span class="pun">;</span></li><li class="L5"><span class="pun">}</span></li><li class="L6"><span class="pln">&nbsp;</span></li><li class="L7"><span class="typ">uint8_t</span><span class="pln"> mvToPercent</span><span class="pun">(</span><span class="kwd">float</span><span class="pln"> mvolts</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li class="L8"><span class="pln">    </span><span class="typ">uint8_t</span><span class="pln"> battery_level</span><span class="pun">;</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">mvolts </span><span class="pun">&gt;=</span><span class="pln"> </span><span class="lit">3000</span><span class="pun">)</span></li><li class="L1"><span class="pln">    </span><span class="pun">{</span></li><li class="L2"><span class="pln">        battery_level </span><span class="pun">=</span><span class="pln"> </span><span class="lit">100</span><span class="pun">;</span></li><li class="L3"><span class="pln">    </span><span class="pun">}</span></li><li class="L4"><span class="pln">    </span><span class="kwd">else</span><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">mvolts </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">2900</span><span class="pun">)</span></li><li class="L5"><span class="pln">    </span><span class="pun">{</span></li><li class="L6"><span class="pln">        battery_level </span><span class="pun">=</span><span class="pln"> </span><span class="lit">100</span><span class="pln"> </span><span class="pun">-</span><span class="pln"> </span><span class="pun">((</span><span class="lit">3000</span><span class="pln"> </span><span class="pun">-</span><span class="pln"> mvolts</span><span class="pun">)</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> </span><span class="lit">58</span><span class="pun">)</span><span class="pln"> </span><span class="pun">/</span><span class="pln"> </span><span class="lit">100</span><span class="pun">;</span></li><li class="L7"><span class="pln">    </span><span class="pun">}</span></li><li class="L8"><span class="pln">    </span><span class="kwd">else</span><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">mvolts </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">2740</span><span class="pun">)</span></li><li class="L9"><span class="pln">    </span><span class="pun">{</span></li><li class="L0"><span class="pln">        battery_level </span><span class="pun">=</span><span class="pln"> </span><span class="lit">42</span><span class="pln"> </span><span class="pun">-</span><span class="pln"> </span><span class="pun">((</span><span class="lit">2900</span><span class="pln"> </span><span class="pun">-</span><span class="pln"> mvolts</span><span class="pun">)</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> </span><span class="lit">24</span><span class="pun">)</span><span class="pln"> </span><span class="pun">/</span><span class="pln"> </span><span class="lit">160</span><span class="pun">;</span></li><li class="L1"><span class="pln">    </span><span class="pun">}</span></li><li class="L2"><span class="pln">    </span><span class="kwd">else</span><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">mvolts </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">2440</span><span class="pun">)</span></li><li class="L3"><span class="pln">    </span><span class="pun">{</span></li><li class="L4"><span class="pln">        battery_level </span><span class="pun">=</span><span class="pln"> </span><span class="lit">18</span><span class="pln"> </span><span class="pun">-</span><span class="pln"> </span><span class="pun">((</span><span class="lit">2740</span><span class="pln"> </span><span class="pun">-</span><span class="pln"> mvolts</span><span class="pun">)</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> </span><span class="lit">12</span><span class="pun">)</span><span class="pln"> </span><span class="pun">/</span><span class="pln"> </span><span class="lit">300</span><span class="pun">;</span></li><li class="L5"><span class="pln">    </span><span class="pun">}</span></li><li class="L6"><span class="pln">    </span><span class="kwd">else</span><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">mvolts </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">2100</span><span class="pun">)</span></li><li class="L7"><span class="pln">    </span><span class="pun">{</span></li><li class="L8"><span class="pln">        battery_level </span><span class="pun">=</span><span class="pln"> </span><span class="lit">6</span><span class="pln"> </span><span class="pun">-</span><span class="pln"> </span><span class="pun">((</span><span class="lit">2440</span><span class="pln"> </span><span class="pun">-</span><span class="pln"> mvolts</span><span class="pun">)</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> </span><span class="lit">6</span><span class="pun">)</span><span class="pln"> </span><span class="pun">/</span><span class="pln"> </span><span class="lit">340</span><span class="pun">;</span></li><li class="L9"><span class="pln">    </span><span class="pun">}</span></li><li class="L0"><span class="pln">    </span><span class="kwd">else</span></li><li class="L1"><span class="pln">    </span><span class="pun">{</span></li><li class="L2"><span class="pln">        battery_level </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></li><li class="L3"><span class="pln">    </span><span class="pun">}</span></li><li class="L4"><span class="pln">&nbsp;</span></li><li class="L5"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> battery_level</span><span class="pun">;</span></li><li class="L6"><span class="pun">}</span></li><li class="L7"><span class="pln">&nbsp;</span></li><li class="L8"><span class="kwd">void</span><span class="pln"> setup</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span></li><li class="L9"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">(</span><span class="lit">115200</span><span class="pun">);</span></li><li class="L0"><span class="pln">  </span><span class="kwd">while</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> </span><span class="pun">!</span><span class="typ">Serial</span><span class="pln"> </span><span class="pun">)</span><span class="pln"> delay</span><span class="pun">(</span><span class="lit">10</span><span class="pun">);</span><span class="pln">   </span><span class="com">// for nrf52840 with native usb</span></li><li class="L1"><span class="pln">&nbsp;</span></li><li class="L2"><span class="pln">  </span><span class="com">// Get a single ADC sample and throw it away</span></li><li class="L3"><span class="pln">  readVBAT</span><span class="pun">();</span></li><li class="L4"><span class="pun">}</span></li><li class="L5"><span class="pln">&nbsp;</span></li><li class="L6"><span class="kwd">void</span><span class="pln"> loop</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span></li><li class="L7"><span class="pln">  </span><span class="com">// Get a raw ADC reading</span></li><li class="L8"><span class="pln">  </span><span class="kwd">int</span><span class="pln"> vbat_raw </span><span class="pun">=</span><span class="pln"> readVBAT</span><span class="pun">();</span></li><li class="L9"><span class="pln">&nbsp;</span></li><li class="L0"><span class="pln">  </span><span class="com">// Convert from raw mv to percentage (based on LIPO chemistry)</span></li><li class="L1"><span class="pln">  </span><span class="typ">uint8_t</span><span class="pln"> vbat_per </span><span class="pun">=</span><span class="pln"> mvToPercent</span><span class="pun">(</span><span class="pln">vbat_raw </span><span class="pun">*</span><span class="pln"> VBAT_MV_PER_LSB</span><span class="pun">);</span></li><li class="L2"><span class="pln">&nbsp;</span></li><li class="L3"><span class="pln">  </span><span class="com">// Convert the raw value to compensated mv, taking the resistor-</span></li><li class="L4"><span class="pln">  </span><span class="com">// divider into account (providing the actual LIPO voltage)</span></li><li class="L5"><span class="pln">  </span><span class="com">// ADC range is 0..3000mV and resolution is 12-bit (0..4095),</span></li><li class="L6"><span class="pln">  </span><span class="com">// VBAT voltage divider is 2M + 0.806M, which needs to be added back</span></li><li class="L7"><span class="pln">  </span><span class="kwd">float</span><span class="pln"> vbat_mv </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">float</span><span class="pun">)</span><span class="pln">vbat_raw </span><span class="pun">*</span><span class="pln"> VBAT_MV_PER_LSB </span><span class="pun">*</span><span class="pln"> VBAT_DIVIDER_COMP</span><span class="pun">;</span></li><li class="L8"><span class="pln">&nbsp;</span></li><li class="L9"><span class="pln">  </span><span class="com">// Display the results</span></li><li class="L0"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"ADC = "</span><span class="pun">);</span></li><li class="L1"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="pln">vbat_raw </span><span class="pun">*</span><span class="pln"> VBAT_MV_PER_LSB</span><span class="pun">);</span></li><li class="L2"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">" mV ("</span><span class="pun">);</span></li><li class="L3"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="pln">vbat_raw</span><span class="pun">);</span></li><li class="L4"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">") "</span><span class="pun">);</span></li><li class="L5"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"LIPO = "</span><span class="pun">);</span></li><li class="L6"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="pln">vbat_mv</span><span class="pun">);</span></li><li class="L7"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">" mV ("</span><span class="pun">);</span></li><li class="L8"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="pln">vbat_per</span><span class="pun">);</span></li><li class="L9"><span class="pln">  </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="str">"%)"</span><span class="pun">);</span></li><li class="L0"><span class="pln">&nbsp;</span></li><li class="L1"><span class="pln">  delay</span><span class="pun">(</span><span class="lit">1000</span><span class="pun">);</span></li><li class="L2"><span class="pun">}</span></li></ol></pre>
</div>
</div>
</div>
<div class="page-title-wrapper">
<h1 class="headline">
<span id="hathach-memory-map">Memory Map</span>
</h1>

</div>
<div class="page-content all-page-view-content">
<div class="">
<div class="element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element row-fluid build-alert alert-danger">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
This page applies to BSP 0.8.0 and higher, which introduced bootloader v5.1.0 and S132 v5.x.x. For earlier releases (BSP release &lt; 0.8.0) see bootloader v0.5.0 and S132 v2.x.x at the bottom of this page.
</div>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#bsp-release-and-bootloader-version-39-2" class="anchor-link"><span class="fa fa-link"></span></a><span id="bsp-release-and-bootloader-version-39-2" class="anchor-link-target"></span><span id="bsp-release-and-bootloader-version" class="anchor-link-target"></span>BSP release &amp; Bootloader version</h1>
<p>The memory usage depends on the version of the Softdevice and/or bootloader (single/dual bank). Following is the Bootloader and Softdevice version included with BSP release</p>
<p>- <strong>0.9.x</strong> :nRF52832 S132 v6.1.1 single bank</p>
<p>- <strong>0.8.x</strong> :nRF52832 S132 v2.0.1 dual banks and S132 v5.1.0 dual banks</p>
<p>- <strong>0.7.x and older</strong>:nRF52832 S132 v2.0.1 dual banks</p>
</div>
<div class="element element element element element row-fluid build-alert alert-info">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
Starting from BSP 0.9.x only single banks will be used to maximize the flash storage
</div>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#flash-memory-39-4" class="anchor-link"><span class="fa fa-link"></span></a><span id="flash-memory-39-4" class="anchor-link-target"></span><span id="flash-memory" class="anchor-link-target"></span>Flash Memory</h1>
<p>The nRF52832 has 512 KB flash, nRF52840 has 1024 KB flash. The flash layout varies as follows:</p>
</div>
<div class="row-fluid build-image">
<a href="./nRF52_bluefruit_Learning_Guide.html#flash-memory-39-4">
<img class="65418-asset img-responsive" src="./nRF52_bluefruit_Learning_Guide/microcontrollers_S132_and_S140_v6.png" alt="microcontrollers_S132_and_S140_v6.png">
<span class="image-expand"><i class="fa fa-search-plus"></i></span>
</a> </div>
<div class="row-fluid build-image">
<a href="./nRF52_bluefruit_Learning_Guide.html#flash-memory-39-4">
<img class="65419-asset img-responsive" src="./nRF52_bluefruit_Learning_Guide/microcontrollers_S132_v2_and_v5.png" alt="microcontrollers_S132_v2_and_v5.png">
<span class="image-expand"><i class="fa fa-search-plus"></i></span>
</a> </div>
<div class="row-fluid build-text">
<ul>
<li>
<strong>SoftDevice</strong>: This section of flash memory contains the <strong>Soft Device</strong>, which is Nordic's black box Bluetooth Low Energy stack.</li>
<li>
<strong>Application</strong>: This section of flash memory stores the user sketches that you compile in the Arduino IDE.</li>
<li>
<strong>Reserved</strong>: This section of flash memory is kept empty to enable <strong>dual banks </strong>safe firmware updates. Whenever you try to update the Application are, the new application data will first be written to the free memory section, and the verified before it is swapped out with the current application code. This is to ensure that DFU complete successfully and that the entire image is safely store on the device to avoid losing the application code. This region is not used by <strong>single bank</strong> bootloader</li>
<li>
<strong>User Data</strong>: This 28KB section of flash memory is reserved for config settings. It uses an open source file system called <a href="https://github.com/ARMmbed/littlefs">Little File System</a>, which is a part of ARM Mbed OpenSource to store bonding data. For example, when you bond the nRF52 with another Central device.</li>
<li>
<strong>DFU Bootloader</strong>: This section of flash memory stores the actual bootloader code that will be executed by the MBR described earlier.</li>
</ul>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#sram-layout-39-8" class="anchor-link"><span class="fa fa-link"></span></a><span id="sram-layout-39-8" class="anchor-link-target"></span><span id="sram-layout" class="anchor-link-target"></span>SRAM Layout</h1>
<p>The nRF52832 has 64KB of SRAM available, and actual memory use will depend on your project, although the stack and heap memory locations are described below:</p>
<ul>
<li>
<strong>Soft Device: </strong>amount of SRAM exclusive allocated for SoftDevice by Linker script. The size is subject to change and varies by releases. For BSP release&nbsp;<strong>0.8.0</strong> it is <strong>12.5 KB</strong>. However, the actual memory required by the SoftDevice depends on the&nbsp; run-time configuration determined by Bluefruit's configNNN() API.</li>
<li>
<strong>Sketch BSS:&nbsp;</strong>static and global data used by your sketch.</li>
<li>
<strong>Heap Memory:</strong>&nbsp;The largest memory region, this is used for allocating the real time operating systems (RTOS) thread stack, malloc() etc. The size, based on the variables shown below, is <strong>Y = 64 - 12.5 - X - 2 ( KB ),&nbsp;</strong>where 12.5KB will vary depending on the SoftDevice used.</li>
<li>
<strong>Stack Memory</strong>: Used by non RTOS thread code, this is mostly for Interrupt Service Routines (ISRs) and SoftDevice API calls. The current size is <strong>2 KB</strong>.</li>
</ul>
<h2>
<a href="./nRF52_bluefruit_Learning_Guide.html#functions-affecting-softdevice-sram-usage-39-8" class="anchor-link"><span class="fa fa-link"></span></a><span id="functions-affecting-softdevice-sram-usage-39-8" class="anchor-link-target"></span><span id="functions-affecting-softdevice-sram-usage" class="anchor-link-target"></span>Functions affecting SoftDevice SRAM usage</h2>
<p>The Bluefruit nRF52&nbsp;<strong>configNNN</strong>() functions set the behavior of SoftDevice, thus determining the total SRAM usage. <strong>These functions must be called before begin().</strong></p>
<ul>
<li>
<strong>configUuid128Count</strong>() : Defines the number of UUID128 entries that the SoftDevice supports, e.g Bleuart, BleMidi, or other services and characteristics.&nbsp;<strong>Default value is 10.&nbsp;</strong>
</li>
<li>
<strong>configAttrTableSize():&nbsp;</strong>The total size of the attribute table, which holds services and characteristics. If your application needs lots of characteristics you may need to increase this. <strong>Default value is 2048 bytes.</strong>
</li>
<li>
<strong>configPrphConn(),&nbsp;configPrphBandwidth():&nbsp;</strong>These function set the parameters that determine the bandwidth for peripheral's connections.&nbsp;configPrphBandwidth() is a convenient helper that calls configPrphConn() with appropriate parameters.</li>
<li>
<strong>configCentralConn(), configCentralBandwidth():&nbsp;</strong>These functions set the parameters that determine the bandwidth for central mode connections. configCentralBandwidth() is a convenient helper that calls configCentralConn() with appropriate parameters.</li>
<li>
<strong>begin():&nbsp;</strong>Bluefruit nRF52's <strong>begin()</strong>&nbsp;function also affects the bandwidth since it takes 2 (optional) parameters. The first one is the number of concurrent connections for peripheral links (to mobile phones, your computer, etc.), the second one is the number of central links (to BLE accessories, or another feather52 running in peripheral mode). <strong>The maximum number of concurrent connections for SoftDevice v5.x is 20</strong>.</li>
</ul>
</div>
<div class="row-fluid build-image">
<a href="./nRF52_bluefruit_Learning_Guide.html#functions-affecting-softdevice-sram-usage-39-8">
<img class="49696-asset img-responsive" src="./nRF52_bluefruit_Learning_Guide/microcontrollers_Bluefruit_nrf52_S132_v5.x.x_RAM_(3).jpg" alt="microcontrollers_Bluefruit_nrf52_S132_v5.x.x_RAM_(3).jpg">
<span class="image-expand"><i class="fa fa-search-plus"></i></span>
</a> </div>
<div class="element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element element row-fluid build-alert alert-info">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
If you run into an error message saying "SoftDevice require more SRAM than provided by linker", try altering your system config -- for ex. lower bandwidth, fewer connection or a smaller attribute table size. Another advanced option is to modify the linker script, but this should be done with care and knowledge of what you are changing.
</div>
</div>
<div class="build-code code-element">
<div class="download-code">
<i class="fa fa-cloud-download"></i> Download:
<a data-turbolinks="false" href="https://learn.adafruit.com/pages/11193/elements/2978988/download">
file
</a> <div class="code-copy-container">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="code-copy-button hidden-xs">Copy Code</a>
</div>
</div>
<pre class="code-text-only" style="display: none;">[CFG] SoftDevice config requires more SRAM than provided by the linker.
App Ram Start must be at least 0x20004180 (provided 0x20003200).
Please update linker file or re-config SoftDevice.</pre>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><span class="pun">[</span><span class="pln">CFG</span><span class="pun">]</span><span class="pln"> </span><span class="typ">SoftDevice</span><span class="pln"> config requires more SRAM than provided </span><span class="kwd">by</span><span class="pln"> the linker</span><span class="pun">.</span></li><li class="L1"><span class="typ">App</span><span class="pln"> </span><span class="typ">Ram</span><span class="pln"> </span><span class="typ">Start</span><span class="pln"> must be at least </span><span class="lit">0x20004180</span><span class="pln"> </span><span class="pun">(</span><span class="pln">provided </span><span class="lit">0x20003200</span><span class="pun">).</span></li><li class="L2"><span class="typ">Please</span><span class="pln"> update linker file </span><span class="kwd">or</span><span class="pln"> re</span><span class="pun">-</span><span class="pln">config </span><span class="typ">SoftDevice</span><span class="pun">.</span></li></ol></pre>
</div>
</div>
</div>
<div class="page-title-wrapper">
<h1 class="headline">
<span id="software-resources">Software Resources</span>
</h1>

</div>
<div class="page-content all-page-view-content">
<div class="mirror">
<div class="row-fluid build-text">
<p>To help you get your Bluefruit LE module talking to other Central devices, we've put together a number of open source tools for most of the major platforms supporting Bluetooth Low Energy.</p>
</div>
<div class="row-fluid build-text">
<h1>
<a href="./nRF52_bluefruit_Learning_Guide.html#bluefruit-le-client-apps-and-libraries-26-2" class="anchor-link"><span class="fa fa-link"></span></a><span id="bluefruit-le-client-apps-and-libraries-26-2" class="anchor-link-target"></span><span id="bluefruit-le-client-apps-and-libraries" class="anchor-link-target"></span>Bluefruit LE Client Apps and Libraries</h1>
<p>Adafruit has put together the following mobile or desktop apps and libraries to make it as easy as possible to get your Bluefruit LE module talking to your mobile device or laptop, with full source available where possible:</p>
</div>
<div class="row-fluid build-text">
<h2>
<a href="./nRF52_bluefruit_Learning_Guide.html#bluefruit-le-connect-android-slash-java-26-3" class="anchor-link"><span class="fa fa-link"></span></a><span id="bluefruit-le-connect-android-slash-java-26-3" class="anchor-link-target"></span><span id="bluefruit-le-connect-android-slash-java" class="anchor-link-target"></span>
<a href="https://play.google.com/store/apps/details?id=com.adafruit.bluefruit.le.connect">Bluefruit LE Connect</a>&nbsp;(Android/Java)</h2>
<p>Bluetooth Low Energy support was added to Android starting with Android 4.3 (though it was only really stable starting with 4.4), and we've already released&nbsp;<a href="https://play.google.com/store/apps/details?id=com.adafruit.bluefruit.le.connect" target="_blank">Bluefruit LE Connect to the Play Store</a>.</p>
<p>The full&nbsp;<a href="https://github.com/adafruit/Bluefruit_LE_Connect_Android" target="_blank">source code</a>&nbsp;for Bluefruit LE Connect for Android is also available on Github to help you get started with your own Android apps. &nbsp;You'll need a recent version of <a href="https://developer.android.com/sdk/index.html" target="_blank">Android Studio</a>&nbsp;to use this project.</p>
</div>
<div class="row-fluid build-image">
<a href="./nRF52_bluefruit_Learning_Guide.html#bluefruit-le-connect-android-slash-java-26-3">
<img class="27737-asset img-responsive" src="./nRF52_bluefruit_Learning_Guide/adafruit_products_Screen_Shot_2015-09-18_at_11.00.51.png" alt="adafruit_products_Screen_Shot_2015-09-18_at_11.00.51.png">
<span class="image-expand"><i class="fa fa-search-plus"></i></span>
</a> </div>
<div class="row-fluid build-text">
<h2>
<a href="./nRF52_bluefruit_Learning_Guide.html#bluefruit-le-connect-ios-slash-swift-26-5" class="anchor-link"><span class="fa fa-link"></span></a><span id="bluefruit-le-connect-ios-slash-swift-26-5" class="anchor-link-target"></span><span id="bluefruit-le-connect-ios-slash-swift" class="anchor-link-target"></span>
<a href="https://itunes.apple.com/app/adafruit-bluefruit-le-connect/id830125974?mt=8">Bluefruit LE Connect</a>&nbsp; (iOS/Swift)</h2>
<p>Apple was very early to adopt Bluetooth Low Energy, and we also have an iOS version of the <a href="https://itunes.apple.com/app/adafruit-bluefruit-le-connect/id830125974?mt=8" target="_blank">Bluefruit LE Connect</a>&nbsp;app available in Apple's app store.</p>
<p>The full swift source code&nbsp;for Bluefruit LE Connect for iOS&nbsp;is also available on Github. You'll need XCode and access to Apple's developper program to use this project:</p>
<ul>
<li>Version 1.x source code:&nbsp;<a href="https://github.com/adafruit/Bluefruit_LE_Connect" target="_blank">https://github.com/adafruit/Bluefruit_LE_Connect</a>
</li>
<li>Version 2.x source code:&nbsp;<a href="https://github.com/adafruit/Bluefruit_LE_Connect_v2" target="_blank">https://github.com/adafruit/Bluefruit_LE_Connect_v2</a>
</li>
</ul>
</div>
<div class="row-fluid build-alert alert-info">
<div class="alert">
<i class="fa fa-exclamation-circle"></i>
Version 2.x of the app is a complete rewrite that includes iOS, OS X GUI and OS X command-line tools in a single codebase.
</div>
</div>








<div class="product-details">
<div class="product-title">Afantor Bluefruit52 nRF52832</div>
<span class="product-price">$24.95</span>
</div>
</a> <div class="product-purchase-link">
<a id="3406-product" class="product-buy btn-primary " data-pid="3406" data-qty="1" data-name="Adafruit Feather nRF52 Bluefruit LE" href="https://item.taobao.com/item.htm?spm=a2oq0.12575281.0.0.25911deb2UXpjn&ft=t&id=592703895006">Go to Shop</a>
</div>
</div>

<div class="product-wrapper">
<a href="https://www.adafruit.com/product/1675">
<div class="product-image">
<img src="./nRF52_bluefruit_Learning_Guide/1675-00.jpg" alt="" height="233" class="img-responsive" data-error="/assets/missing%2Fmissing.png">
</div>
<div class="product-details">
<div class="product-title">10-pin 2x5 Socket-Socket 1.27mm IDC (SWD) Cable - 150mm long</div>
<span class="product-price">$2.95</span>
</div>
</a> <div class="product-purchase-link">
<a id="1675-product" class="product-buy btn-primary " data-pid="1675" data-qty="1" data-name="10-pin 2x5 Socket-Socket 1.27mm IDC (SWD) Cable - 150mm long" href="https://item.taobao.com/item.htm?spm=a2oq0.12575281.0.0.25911deb2UXpjn&ft=t&id=592703895006">Go to Shop</a>
</div>
</div>
<div class="clear"></div>
</div>
</header>
</div>
</div>
</div>

<div class="footer-spacer"></div>
</div>
<div class="modal fade" id="notify-modal">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<a href="./nRF52_bluefruit_Learning_Guide.html#" class="close" data-dismiss="modal">×</a>
<h5>OUT OF STOCK NOTIFICATION</h5>
</div>
<div class="modal-body">
<p class="notify-modal-form-header"></p>
<div class="notify-modal-products"></div>
<form id="notify-modal-form" name="back_in_stock_notification">
<p class="notify-modal-form-notice"></p>
<div class="notify-modal-break"></div>
<div class="form-group">
<label class="inputLabel" for="name">YOUR NAME</label>
<input type="text" size="25" maxlength="64" name="name" value="">
</div>
<div class="form-group">
<label class="inputLabel" for="email">YOUR EMAIL</label>
<input type="email" size="25" maxlength="96" name="email" value="">
</div>
<input type="text" name="daigo" style="display:none;">
<input type="hidden" name="notify_me" value="true">
</form>
<div id="notify-modal-success" style="display:none">
<p>You have been successfully subscribed to the Notification List for this product and will therefore receive an e-mail from us when it is back in stock!</p>
<p>For security reasons, an e-mail has been sent to you acknowledging your subscription. Please remember that this subscription will not result in you receiving any e-mail from us about anything other than the restocking of this item.</p>
<p>If, for any reason, you would like to unsubscribe from the Notification List for this product you will find details of how to do so in the e-mail that has just been sent to you!</p>
</div>
</div>
<div class="modal-footer">
<a href="./nRF52_bluefruit_Learning_Guide.html#" id="close-notify" style="display: none" data-dismiss="modal" data-target="#notify-modal">CLOSE</a>
<a href="./nRF52_bluefruit_Learning_Guide.html#" id="submit-notify" rel="nofollow" class="blue-button">NOTIFY ME</a>
</div>
</div>
</div>
</div>
<div id="remote-modal"></div>
</div>
<footer id="adafruit-footer">
<div id="footer-content">
<div class="row">
<div class=" col-lg-6 col-md-6 col-sm-4 col-xs-12">
<nav>

</nav>

</div>
<div class="col-lg-6 col-md-6 col-sm-8 hidden-xs">
<div id="footer-quote" class="">
"There’s nothing like watching the sunrise to the beats of the Robot Heart"
<span class="quote-author">- <a href="http://en.wikipedia.org/wiki/Andrew_Huang">Andrew "bunnie" Huang</a></span>
</div>
</div>
<div id="footer-seals">
<img class="img-responsive" src="./nRF52_bluefruit_Learning_Guide/seals_2x.jpg">
</div>
</div>
</div>
</footer>
</div>
</div>


<span style="border-radius: 3px !important; text-indent: 20px !important; width: auto !important; padding: 0px 4px 0px 0px !important; text-align: center !important; font: bold 11px/20px &quot;Helvetica Neue&quot;, Helvetica, sans-serif !important; color: rgb(255, 255, 255) !important; background: url(&quot;data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMzBweCIgd2lkdGg9IjMwcHgiIHZpZXdCb3g9Ii0xIC0xIDMxIDMxIj48Zz48cGF0aCBkPSJNMjkuNDQ5LDE0LjY2MiBDMjkuNDQ5LDIyLjcyMiAyMi44NjgsMjkuMjU2IDE0Ljc1LDI5LjI1NiBDNi42MzIsMjkuMjU2IDAuMDUxLDIyLjcyMiAwLjA1MSwxNC42NjIgQzAuMDUxLDYuNjAxIDYuNjMyLDAuMDY3IDE0Ljc1LDAuMDY3IEMyMi44NjgsMC4wNjcgMjkuNDQ5LDYuNjAxIDI5LjQ0OSwxNC42NjIiIGZpbGw9IiNmZmYiIHN0cm9rZT0iI2ZmZiIgc3Ryb2tlLXdpZHRoPSIxIj48L3BhdGg+PHBhdGggZD0iTTE0LjczMywxLjY4NiBDNy41MTYsMS42ODYgMS42NjUsNy40OTUgMS42NjUsMTQuNjYyIEMxLjY2NSwyMC4xNTkgNS4xMDksMjQuODU0IDkuOTcsMjYuNzQ0IEM5Ljg1NiwyNS43MTggOS43NTMsMjQuMTQzIDEwLjAxNiwyMy4wMjIgQzEwLjI1MywyMi4wMSAxMS41NDgsMTYuNTcyIDExLjU0OCwxNi41NzIgQzExLjU0OCwxNi41NzIgMTEuMTU3LDE1Ljc5NSAxMS4xNTcsMTQuNjQ2IEMxMS4xNTcsMTIuODQyIDEyLjIxMSwxMS40OTUgMTMuNTIyLDExLjQ5NSBDMTQuNjM3LDExLjQ5NSAxNS4xNzUsMTIuMzI2IDE1LjE3NSwxMy4zMjMgQzE1LjE3NSwxNC40MzYgMTQuNDYyLDE2LjEgMTQuMDkzLDE3LjY0MyBDMTMuNzg1LDE4LjkzNSAxNC43NDUsMTkuOTg4IDE2LjAyOCwxOS45ODggQzE4LjM1MSwxOS45ODggMjAuMTM2LDE3LjU1NiAyMC4xMzYsMTQuMDQ2IEMyMC4xMzYsMTAuOTM5IDE3Ljg4OCw4Ljc2NyAxNC42NzgsOC43NjcgQzEwLjk1OSw4Ljc2NyA4Ljc3NywxMS41MzYgOC43NzcsMTQuMzk4IEM4Ljc3NywxNS41MTMgOS4yMSwxNi43MDkgOS43NDksMTcuMzU5IEM5Ljg1NiwxNy40ODggOS44NzIsMTcuNiA5Ljg0LDE3LjczMSBDOS43NDEsMTguMTQxIDkuNTIsMTkuMDIzIDkuNDc3LDE5LjIwMyBDOS40MiwxOS40NCA5LjI4OCwxOS40OTEgOS4wNCwxOS4zNzYgQzcuNDA4LDE4LjYyMiA2LjM4NywxNi4yNTIgNi4zODcsMTQuMzQ5IEM2LjM4NywxMC4yNTYgOS4zODMsNi40OTcgMTUuMDIyLDYuNDk3IEMxOS41NTUsNi40OTcgMjMuMDc4LDkuNzA1IDIzLjA3OCwxMy45OTEgQzIzLjA3OCwxOC40NjMgMjAuMjM5LDIyLjA2MiAxNi4yOTcsMjIuMDYyIEMxNC45NzMsMjIuMDYyIDEzLjcyOCwyMS4zNzkgMTMuMzAyLDIwLjU3MiBDMTMuMzAyLDIwLjU3MiAxMi42NDcsMjMuMDUgMTIuNDg4LDIzLjY1NyBDMTIuMTkzLDI0Ljc4NCAxMS4zOTYsMjYuMTk2IDEwLjg2MywyNy4wNTggQzEyLjA4NiwyNy40MzQgMTMuMzg2LDI3LjYzNyAxNC43MzMsMjcuNjM3IEMyMS45NSwyNy42MzcgMjcuODAxLDIxLjgyOCAyNy44MDEsMTQuNjYyIEMyNy44MDEsNy40OTUgMjEuOTUsMS42ODYgMTQuNzMzLDEuNjg2IiBmaWxsPSIjZTYwMDIzIj48L3BhdGg+PC9nPjwvc3ZnPg==&quot;) 3px 50% / 14px 14px no-repeat rgb(230, 0, 35) !important; position: absolute !important; opacity: 1 !important; z-index: 8675309 !important; display: none; cursor: pointer !important; border: none !important; -webkit-font-smoothing: antialiased !important; top: 1304px; left: 405px;">Save</span><span style="border-radius: 12px; width: 24px !important; height: 24px !important; background: url(&quot;data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiA/Pjxzdmcgd2lkdGg9IjI0cHgiIGhlaWdodD0iMjRweCIgdmlld0JveD0iMCAwIDI0IDI0IiB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiPjxkZWZzPjxtYXNrIGlkPSJtIj48cmVjdCBmaWxsPSIjZmZmIiB4PSIwIiB5PSIwIiB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHJ4PSI2IiByeT0iNiIvPjxyZWN0IGZpbGw9IiMwMDAiIHg9IjUiIHk9IjUiIHdpZHRoPSIxNCIgaGVpZ2h0PSIxNCIgcng9IjEiIHJ5PSIxIi8+PHJlY3QgZmlsbD0iIzAwMCIgeD0iMTAiIHk9IjAiIHdpZHRoPSI0IiBoZWlnaHQ9IjI0Ii8+PHJlY3QgZmlsbD0iIzAwMCIgeD0iMCIgeT0iMTAiIHdpZHRoPSIyNCIgaGVpZ2h0PSI0Ii8+PC9tYXNrPjwvZGVmcz48cmVjdCB4PSIwIiB5PSIwIiB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIGZpbGw9IiNmZmYiIG1hc2s9InVybCgjbSkiLz48L3N2Zz4=&quot;) 50% 50% / 14px 14px no-repeat rgba(0, 0, 0, 0.4) !important; position: absolute !important; opacity: 1 !important; z-index: 8675309 !important; display: none; cursor: pointer !important; border: none !important; top: 1302px; left: 1096px;"></span></body></html>